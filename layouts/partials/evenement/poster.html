{{- $first := true -}}
{{ $allergenesLgList := slice "Poisson" "Oeuf" "Soja" "Sésame" "Moutarde" "Fruit à coque" "Céleri" "Crustacé" "Arachide" "Mollusque" "Alcool"}}
{{ $recetteCat := .recetteCat }}
{{ $recetteCatFormat := .recetteCatFormat }}

{{/* Charger l'index global des ingrédients */}}
{{ $ingredientsIndex := partialCached "functions/ingredients-index.html" "ingredients-index" }}
{{ $byUUID := $ingredientsIndex.byUUID }}


{{ $dateService := .dateService | time.Format "2006-01-02" }}
{{ $dateService = replace $dateService "-" "" }}
{{ $horaire := .horaire }}


{{ range .recettes_du_repas }}

{{/*  Réccupérer le nom lisible de la recette  */}}
{{- $recetteName := "" -}}
{{- $recette := .recette -}}
{{- $recetteData := dict -}}
{{- $url:= print .recette | urlize -}}

{{- with site.GetPage $url -}}
  {{- $recetteName = .Params.title -}}

  {{/* Calcul complet des données ingrédients et régimes - DANS le contexte de la page */}}
  {{- if .Params.ingredients -}}
    {{- $builderContext := dict
        "items" .Params.ingredients
        "byUUID" $byUUID
        "mode" "recette"
        "splitLegumes" false
    -}}
    {{- $recetteData = partial "functions/ingredients-group-builder.html" $builderContext  -}}
  {{- end -}}
{{- end -}}

{{/* Extraire les ingrédients et régimes/allergènes à partir des données structurées */}}
{{- $ingredientsRecette := slice -}}
{{- $allergenesByType := dict
    "gluten" slice
    "lait" slice
    "porc" slice
    "autres" slice
    "animaux" slice
-}}

{{- if $recetteData.ingredients -}}
  {{- range $type, $ingredients := $recetteData.ingredients -}}
    {{- if ne $type "absent" -}}
      {{- range $ingredient := $ingredients -}}
        {{- $ingredientsRecette = $ingredientsRecette | append $ingredient.ingredient -}}
        {{- range $allergene := $ingredient.allergenes -}}
          {{- if eq $allergene "Gluten" -}}
            {{- $allergenesByType = merge $allergenesByType (dict "gluten" ($allergenesByType.gluten | append $ingredient.ingredient)) -}}
          {{- else if or (eq $allergene "Produit laitier") (eq $allergene "Lactose") -}}
            {{- $allergenesByType = merge $allergenesByType (dict "lait" ($allergenesByType.lait | append $ingredient.ingredient)) -}}
          {{- else if eq $allergene "Porc" -}}
            {{- $allergenesByType = merge $allergenesByType (dict "porc" ($allergenesByType.porc | append $ingredient.ingredient)) -}}
          {{- else if in $allergenesLgList $allergene -}}
            {{- $allergenesByType = merge $allergenesByType (dict "autres" ($allergenesByType.autres | append $ingredient.ingredient)) -}}
          {{- end -}}
        {{- end -}}
        {{- if eq $ingredient.type "animaux" -}}
          {{- $allergenesByType = merge $allergenesByType (dict "animaux" ($allergenesByType.animaux | append $ingredient.ingredient)) -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}


{{ if eq .type_plat $recetteCat }}
{{ if (and $first .recette)}}
  <p v-show="fontCat !== 'noDisplay'" class="text-center pt-5" :class="[[fontCat]]" style="font-size: 1.8em"  :style="fontSizeCat" >·•· {{$recetteCatFormat}} ·•·</p>
  {{- end -}}



   <!-- Placeholder pour recette masquée -->
   <div v-show="!recipeVisibility['{{$dateService}}{{$horaire}}_{{.recette}}']" class="recipe-hidden-placeholder mb-3 no-print">
     <button @click="toggleRecipeVisibility('{{$dateService}}{{$horaire}}_{{.recette}}')" 
             class="btn btn-outline-primary btn-sm">
       <i class="fas fa-eye"></i> Afficher [[ getRecipeName('{{$dateService}}{{$horaire}}_{{.recette}}', {{$recetteName | default .recette | jsonify}}) ]]
     </button>
   </div>

   <!-- Contenu de la recette -->
   <div v-show="recipeVisibility['{{$dateService}}{{$horaire}}_{{.recette}}']" class="mb-3 recipe-container">
      <div class="recipe-actions no-print">
        <button @click="startEditingRecipe('{{$dateService}}{{$horaire}}_{{.recette}}')" 
                class="btn btn-sm btn-outline-info me-1" 
                title="Modifier le nom">
          <i class="fas fa-edit"></i>
        </button>
        <button @click="toggleRecipeVisibility('{{$dateService}}{{$horaire}}_{{.recette}}')" 
                class="btn btn-sm btn-outline-secondary" 
                title="Masquer la recette">
          <i class="fas fa-eye-slash"></i>
        </button>
      </div>

      <p class="text-center fw-bold mb-1 text-lowercase" style="font-size: 2em" :class=" [[fontRecettes]] " :style="fontSizeRecettes">
        <span v-if="editingRecipe !== '{{$dateService}}{{$horaire}}_{{.recette}}'">
          [[ getRecipeName('{{$dateService}}{{$horaire}}_{{.recette}}', {{$recetteName | default .recette | jsonify}}) ]]
        </span>
        <input v-if="editingRecipe === '{{$dateService}}{{$horaire}}_{{.recette}}'"
               type="text"
               class="recipe-name-edit"
               id="recipe-edit-{{$dateService}}{{$horaire}}_{{.recette}}"
               :value="getRecipeName('{{$dateService}}{{$horaire}}_{{.recette}}', {{$recetteName | default .recette | jsonify}})"
               @input="updateRecipeName('{{$dateService}}{{$horaire}}_{{.recette}}', $event.target.value)"
               @blur="finishEditingRecipe()"
               @keydown.enter="finishEditingRecipe()"
               @keydown.escape="finishEditingRecipe()">
      </p>
    {{- $first = false -}}
    <p v-show="fontDesc !== 'noDisplay'" class="card-text" :class="[[fontDesc]]" :style="[[fontSizeDesc]]">{{.description}}</p>

    {{- $url := print .recette | urlize -}}
    {{- with site.GetPage $url -}}


    <p v-show="fontRegimes !== 'noDisplay'" class="mb-1 text-center" :class="[[fontRegimes]]" :style=" fontSizeRegimes">
      {{- if $recetteData.regimes -}}
      {{- if and $recetteData.regimes.vegetarien (not $recetteData.regimes.vegan) -}}<span class="mx-2">Végétarien</span> {{- end -}}
      {{- if $recetteData.regimes.vegan -}}<span class="mx-2">Vegan</span> {{- end -}}
      {{- if $recetteData.regimes.sans_gluten -}}<span class="mx-2">Sans-gluten</span> {{- end -}}

       {{- end -}}

    </p>



    {{/* Affichage des alertes allergènes */}}
    {{- with or $allergenesByType.gluten $allergenesByType.porc $allergenesByType.lait $allergenesByType.autres }}
      <p class="m-0 text-center" v-show="fontAlert !== 'noDisplay'">•••</p>
    {{- end }}

    <div v-show="fontAlert !== 'noDisplay'">
      {{- with $allergenesByType.autres -}}
      <p class="text-center mb-0" :class="[[fontAlert]]" :style="fontSizeAlert"><span class="fw-bold">Alergènes : </span>{{ delimit $allergenesByType.autres ", "}}</p>
      {{- end -}}
      {{- with $allergenesByType.gluten -}}
      <p class="text-center mb-0" :class="[[fontAlert]]" :style="fontSizeAlert"><span class="fw-bold">Contient du gluten : </span>{{ delimit $allergenesByType.gluten ", "}}</p>
      {{- end -}}
      {{- with $allergenesByType.porc -}}
      <p class="text-center mb-0" :class="[[fontAlert]]" :style="fontSizeAlert"><span class="fw-bold">Contient du porc</span></p>
      {{- end -}}
      {{- with $allergenesByType.lait -}}
      <p class="text-center mb-0" :class="[[fontAlert]]" :style="fontSizeAlert"><span class="fw-bold">Contient des produits laitiers : </span>{{ delimit $allergenesByType.lait ", "}}</p>
      {{- end -}}
      {{- with $allergenesByType.animaux -}}
      <p class="text-center mb-0" :class="[[fontAlert]]" :style="fontSizeAlert"><span class="fw-bold">N'est pas végétarien : </span>{{ delimit $allergenesByType.animaux ", "}}</p>
      {{- end -}}
    </div>

      <div v-show="fontIng !== 'noDisplay'">
        <p class="text-center m-0">•••</p>
        <p class="text-center" :class="[[fontIng]]" :style="fontSizeIng"><span class="fw-bold">Ingrédients : </span>{{ delimit $ingredientsRecette ", "}}</p>
      </div>
      {{- end  }}
    </div>
      {{- end }}

      {{- end }}
