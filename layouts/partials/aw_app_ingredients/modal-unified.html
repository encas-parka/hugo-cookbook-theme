<!-- Modal unifié pour la gestion des ingrédients -->
<div
  class="modal"
  v-if="modalState.isOpen && modalState.editingIngredient"
  @click.self="closeUnifiedModal"
  style="display: block; background-color: rgba(0, 0, 0, 0.5)"
  tabindex="-1"
  role="dialog"
  aria-modal="true"
  :aria-labelledby="`modal-title-${modalState.editingIngredient.$id}`"
  :aria-describedby="`modal-desc-${modalState.editingIngredient.$id}`"
>
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <!-- Header compact avec informations essentielles -->
      <div class="modal-header">
        <div class="d-flex align-items-center justify-content-between w-100">
          <div>
            <h2 class="modal-title my-1" :id="`modal-title-${modalState.editingIngredient.$id}`">
              [[ modalState.editingIngredient?.ingredientName ]]
            </h2>
            <div class="d-flex gap-3 align-items-center" :id="`modal-desc-${modalState.editingIngredient.$id}`">
              <span class="badge text-bg-secondary"
                >[[ formatTypeShort(modalState.editingIngredient?.ingType) ]]</span
              >

              <span
                v-if="modalState.editingIngredient?.status === 'sufficient'"
                class="badge bg-success"
              >
                <i class="fa-regular fa-circle-check"></i> Complet
              </span>
              <span v-else class="badge bg-warning">
                <i class="fas fa-hourglass-half"></i> En cours
              </span>
              <small class="opacity-75"
                >Besoin:
                <strong
                  >[[ modalState.editingIngredient?.totalNeedDisplay ]]</strong
                ></small
              >
              <small class="opacity-75"
                >Balance:
                <strong :class="modalState.editingIngredient?.balanceClass"
                >[[ modalState.editingIngredient?.balanceDisplay ]]</strong
                ></small
              >
            </div>
          </div>
          <button
            type="button"
            class="btn-close"
            @click="closeUnifiedModal"
            aria-label="Close"
          ></button>
        </div>
      </div>

      <div class="modal-body p-0 mt-2">
        <!-- Navigation par onglets -->
        <ul class="nav nav-tabs nav-fill" id="unifiedTabs" role="tablist" aria-label="Gestion de l'ingrédient">
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              :class="{ 'active fw-bold': modalState.currentTab === 'recettes' }"
              id="recipes-tab"
              type="button"
              role="tab"
              aria-controls="recipes"
              tabindex="-1"
              @click="modalState.currentTab = 'recettes'"
            >
              <i class="fas me-1 fa-utensils" aria-hidden="true"></i>
              <span>Recettes</span>
              <span class="badge text-bg-secondary ms-1"
                aria-label="[[ modalState.editingIngredient?.recipeOccurrences?.length || 0 ]] recettes"
                >[[ modalState.editingIngredient?.recipeOccurrences?.length || 0 ]]</span
              >
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              :class="{ 'active fw-bold bg-light': modalState.currentTab === 'purchases' }"
              id="purchases-tab"
              type="button"
              role="tab"
              aria-controls="purchases"
              tabindex="-1"
              @click="modalState.currentTab = 'purchases'"
            >
              <i class="fas me-1 fa-shopping-cart" aria-hidden="true"></i>
              <span>Achats</span>
              <span class="badge text-bg-secondary ms-1"
                aria-label="[[ modalState.editingIngredient?.purchases?.length || 0 ]] achats"
                >[[ modalState.editingIngredient?.purchases?.length || 0 ]]</span
              >
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              :class="{ 'active fw-bold bg-light': modalState.currentTab === 'stock' }"
              id="stock-tab"
              type="button"
              role="tab"
              aria-controls="stock"
              tabindex="-1"
              @click="modalState.currentTab = 'stock'"
            >
              <i class="fas me-1 fa-box" aria-hidden="true"></i>
              <span>Stock</span>
              <span class="badge text-bg-secondary ms-1"
                aria-label="[[ editingStockEntries?.length || 0 ]] entrées de stock"
                >[[ editingStockEntries?.length || 0 ]]</span
              >
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              :class="{ 'active fw-bold bg-light': modalState.currentTab === 'volunteers' }"
              id="volunteers-tab"
              type="button"
              role="tab"
              aria-controls="volunteers"
              tabindex="-1"
              @click="modalState.currentTab = 'volunteers'"
            >
              <i class="fas me-1 fa-users" aria-hidden="true"></i>
              <span>Volontaires</span>
              <span class="badge text-bg-secondary ms-1"
                aria-label="[[ modalState.editingIngredient?.who?.length || 0 ]] volontaires"
                >[[ modalState.editingIngredient?.who?.length || 0 ]]</span
              >
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button
              class="nav-link"
              :class="{ 'active fw-bold bg-light': modalState.currentTab === 'stores' }"
              id="stores-tab"
              type="button"
              role="tab"
              aria-controls="stores"
              tabindex="-1"
              @click="modalState.currentTab = 'stores'"
            >
              <i class="fas me-1 fa-store" aria-hidden="true"></i>
              <span>Magasins</span>
              <span class="badge text-bg-secondary ms-1"
                aria-label="[[ modalState.editingIngredient?.store ? 1 : 0 ]] magasin assigné"
                >[[ modalState.editingIngredient?.store ? 1 : 0 ]]</span
              >
            </button>
          </li>
        </ul>

        <div class="tab-content p-3" id="unifiedTabsContent">
          <!-- Onglet Recettes -->
          <div class="tab-pane fade"
               :class="{ 'show active': modalState.currentTab === 'recettes' }"
               id="recipes" role="tabpanel">
            <div class="table-responsive">
              <table class="table table-striped table-sm">
                <thead>
                  <tr>
                    <th>Recette</th>
                    <th>Quantité</th>
                    <th>Date service</th>
                    <th>Horaire</th>
                    <th>Type plat</th>
                    <th>Assiettes</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    v-if="!modalState.editingIngredient?.recipeOccurrences?.length"
                  >
                    <td colspan="6" class="text-muted text-center">
                      Aucune recette trouvée
                    </td>
                  </tr>
                  <tr
                    v-for="recipe in modalState.editingIngredient?.recipeOccurrences"
                    :key="recipe.recipeName + recipe.dateTimeService"
                  >
                    <td><strong>[[ recipe.recipeName ]]</strong></td>
                    <td>[[ recipe.quantity ]] [[ recipe.unit ]]</td>
                    <td>[[ formatDate(recipe.dateTimeService) ]]</td>
                    <td>[[ recipe.horaire || '-' ]]</td>
                    <td>[[ recipe.typePlat || '-' ]]</td>
                    <td>[[ recipe.assiettes || '-' ]]</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Onglet Achats -->
          <div class="tab-pane fade"
               :class="{ 'show active': modalState.currentTab === 'purchases' }"
               id="purchases" role="tabpanel">



            <!-- Datalists pour les suggestions d'achats -->
            <datalist id="purchase-store-suggestions">
              <option
                v-for="store in availableStoresSuggestions"
                :key="store"
                :value="store"
              >
                [[ store ]]
              </option>
            </datalist>
            <datalist id="purchase-volunteer-suggestions">
              <option
                v-for="volunteer in availableVolunteersSuggestions"
                :key="volunteer"
                :value="volunteer"
              >
                [[ volunteer ]]
              </option>
            </datalist>

            <!-- Formulaire d'ajout d'achat -->
            <div class="card mb-3">
              <div class="card-header">
                <div class="card-title mb-0">
                  <i class="fas fa-shopping-cart"></i> Ajouter un achat
                </div>
              </div>
              <div class="card-body">
                <div class="row g-2">
                  <div class="col-md-3">
                    <label for="purchase-quantity" class="form-label visually-hidden">Quantité</label>
                    <input
                      id="purchase-quantity"
                      type="number"
                      class="form-control form-control-sm"
                      v-model.number="newPurchase.quantity"
                      step="0.01"
                      min="0"
                      placeholder="Quantité"
                      aria-required="true"
                      aria-describedby="purchase-quantity-help"
                    />
                    <div id="purchase-quantity-help" class="form-text visually-hidden">
                      Entrez une quantité positive
                    </div>
                  </div>
                  <div class="col-md-2">
                    <label for="purchase-unit" class="form-label visually-hidden">Unité</label>
                    <select
                      id="purchase-unit"
                      class="form-select form-select-sm"
                      v-model="newPurchase.unit"
                      aria-required="true"
                      aria-describedby="purchase-unit-help"
                    >
                      <option value="">Unité</option>
                      <option
                        v-for="unit in suggestedUnits"
                        :key="unit"
                        :value="unit"
                      >
                        [[ unit ]]
                      </option>
                    </select>
                    <div id="purchase-unit-help" class="form-text visually-hidden">
                      Sélectionnez une unité de mesure
                    </div>
                  </div>
                  <div class="col-md-2">
                    <label for="purchase-store" class="form-label visually-hidden">Magasin</label>
                    <input
                      id="purchase-store"
                      type="text"
                      class="form-control form-control-sm"
                      v-model="newPurchase.store"
                      placeholder="Magasin"
                      list="purchase-store-suggestions"
                      aria-describedby="purchase-store-help"
                    />
                    <div id="purchase-store-help" class="form-text visually-hidden">
                      Nom du magasin (optionnel)
                    </div>
                  </div>
                  <div class="col-md-2">
                    <label for="purchase-who" class="form-label visually-hidden">Personne</label>
                    <input
                      id="purchase-who"
                      type="text"
                      class="form-control form-control-sm"
                      v-model="newPurchase.who"
                      placeholder="Qui"
                      list="purchase-volunteer-suggestions"
                      aria-describedby="purchase-who-help"
                    />
                    <div id="purchase-who-help" class="form-text visually-hidden">
                      Personne ayant fait l'achat (optionnel)
                    </div>
                  </div>
                  <div class="col-md-1">
                    <label for="purchase-price" class="form-label visually-hidden">Prix</label>
                    <input
                      id="purchase-price"
                      type="number"
                      class="form-control form-control-sm"
                      v-model.number="newPurchase.price"
                      step="0.01"
                      min="0"
                      placeholder="Prix €"
                      aria-describedby="purchase-price-help"
                    />
                    <div id="purchase-price-help" class="form-text visually-hidden">
                      Prix en euros (optionnel)
                    </div>
                  </div>
                  <div class="col-md-2">
                    <button
                      class="btn btn-success btn-sm w-100"
                      @click="addPurchase"
                      :disabled="!isPurchaseFormValid"
                      :aria-label="!isPurchaseFormValid ? 'Veuillez remplir les champs obligatoires pour ajouter un achat' : 'Ajouter cet achat'"
                    >
                      <i class="fas fa-plus" aria-hidden="true"></i>
                      <span>Ajouter</span>
                    </button>
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-12">
                    <label for="purchase-notes" class="form-label visually-hidden">Notes</label>
                    <input
                      id="purchase-notes"
                      type="text"
                      class="form-control form-control-sm"
                      v-model="newPurchase.notes"
                      placeholder="Notes (optionnel)"
                      aria-describedby="purchase-notes-help"
                    />
                    <div id="purchase-notes-help" class="form-text visually-hidden">
                      Notes supplémentaires sur l'achat (optionnel)
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tableau des achats -->
            <div class="table-responsive">
              <table class="table table-striped table-sm">
                <thead>
                  <tr>
                    <th>Quantité</th>
                    <th>Magasin</th>
                    <th>Qui</th>
                    <th>Date</th>
                    <th>Prix</th>
                    <th>Notes</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-if="!editingPurchases.length">
                    <td colspan="7" class="text-muted text-center">
                      Aucun achat enregistré
                    </td>
                  </tr>
                  <tr
                    v-for="(purchase, index) in editingPurchases"
                    :key="purchase.$id || 'new-' + index"
                  >
                    <td v-if="purchase.isEditing">
                      <input
                        type="number"
                        class="form-control form-control-sm"
                        v-model.number="purchase.quantity"
                        step="0.01"
                        min="0"
                      />
                    </td>
                    <td v-else>
                      <strong
                        >[[ purchase.quantity ]] [[ purchase.unit ]]</strong
                      >
                    </td>

                    <td v-if="purchase.isEditing">
                      <input
                        type="text"
                        class="form-control form-control-sm"
                        v-model="purchase.store"
                        list="purchase-store-suggestions"
                      />
                    </td>
                    <td v-else>[[ purchase.store || '-' ]]</td>

                    <td v-if="purchase.isEditing">
                      <input
                        type="text"
                        class="form-control form-control-sm"
                        v-model="purchase.who"
                        list="purchase-volunteer-suggestions"
                      />
                    </td>
                    <td v-else>[[ purchase.who || '-' ]]</td>

                    <td>[[ formatDate(purchase.$createdAt) ]]</td>

                    <td v-if="purchase.isEditing">
                      <input
                        type="number"
                        class="form-control form-control-sm"
                        v-model.number="purchase.price"
                        step="0.01"
                        min="0"
                      />
                    </td>
                    <td v-else>
                      [[ purchase.price ? purchase.price + ' €' : '-' ]]
                    </td>

                    <td v-if="purchase.isEditing">
                      <input
                        type="text"
                        class="form-control form-control-sm"
                        v-model="purchase.notes"
                      />
                    </td>
                    <td v-else>[[ purchase.notes || '-' ]]</td>

                    <td>
                      <div class="btn-group btn-group-sm">
                        <button
                          v-if="purchase.isEditing"
                          class="btn btn-outline-success"
                          @click="savePurchaseEdit(purchase)"
                          title="Enregistrer"
                        >
                          <i class="fas fa-save"></i>
                        </button>
                        <button
                          v-else
                          class="btn btn-outline-primary"
                          @click="editPurchase(purchase)"
                          title="Modifier"
                        >
                          <i class="fas fa-edit"></i>
                        </button>
                        <button
                          class="btn btn-outline-danger"
                          @click="deletePurchase(purchase)"
                          title="Supprimer"
                        >
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Onglet Stock -->
          <div class="tab-pane fade"
               :class="{ 'show active': modalState.currentTab === 'stock' }"
               id="stock" role="tabpanel">
            <!-- Formulaire d'ajout de stock -->
            <div class="card mb-3">
              <div class="card-header">
                <div class="card-title mb-0">
                  <i class="fas fa-box"></i> Créer un relévé du stock réel
                </div>
              </div>
              <div class="card-body">
                <div class="row g-2">
                  <div class="col-md-3">
                    <input
                      type="number"
                      class="form-control form-control-sm"
                      v-model.number="newStock.quantity"
                      step="0.01"
                      min="0"
                      placeholder="Quantité"
                    />
                  </div>
                  <div class="col-md-2">
                    <select
                      class="form-select form-select-sm"
                      v-model="newStock.unit"
                    >
                      <option value="">Unité</option>
                      <option
                        v-for="unit in suggestedUnits"
                        :key="unit"
                        :value="unit"
                      >
                        [[ unit ]]
                      </option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <input
                      type="datetime-local"
                      class="form-control form-control-sm"
                      v-model="newStock.dateTime"
                    />
                  </div>
                  <div class="col-md-4">
                    <button
                      class="btn btn-primary btn-sm w-100"
                      @click="addStock"
                      :disabled="!isStockFormValid"
                    >
                      <i class="fas fa-plus"></i> Ajouter
                    </button>
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-12">
                    <input
                      type="text"
                      class="form-control form-control-sm"
                      v-model="newStock.notes"
                      placeholder="Notes (optionnel)"
                    />
                  </div>
                </div>
              </div>
            </div>

            <!-- Tableau du stock -->
            <div class="table-responsive">
              <table class="table table-striped table-sm">
                <thead>
                  <tr>
                    <th>Quantité</th>
                    <th>Date</th>
                    <th>Notes</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-if="!editingStockEntries.length">
                    <td colspan="4" class="text-muted text-center">
                      Aucun stock enregistré
                    </td>
                  </tr>
                  <tr
                    v-for="(stock, index) in editingStockEntries"
                    :key="stock.$id || 'new-' + index"
                  >
                    <td v-if="stock.isEditing">
                      <div class="d-flex gap-1">
                        <input
                          type="number"
                          class="form-control form-control-sm"
                          v-model.number="stock.quantity"
                          step="0.01"
                          min="0"
                        />
                        <select
                          class="form-select form-select-sm"
                          v-model="stock.unit"
                        >
                          <option
                            v-for="unit in suggestedUnits"
                            :key="unit"
                            :value="unit"
                          >
                            [[ unit ]]
                          </option>
                        </select>
                      </div>
                    </td>
                    <td v-else>
                      <strong>[[ stock.quantity ]] [[ stock.unit ]]</strong>
                    </td>

                    <td v-if="stock.isEditing">
                      <input
                        type="datetime-local"
                        class="form-control form-control-sm"
                        v-model="stock.dateTime"
                      />
                    </td>
                    <td v-else>[[ formatDateTime(stock.dateTime) ]]</td>

                    <td v-if="stock.isEditing">
                      <input
                        type="text"
                        class="form-control form-control-sm"
                        v-model="stock.notes"
                      />
                    </td>
                    <td v-else>[[ stock.notes || '-' ]]</td>

                    <td>
                      <div class="btn-group btn-group-sm">
                        <button
                          v-if="stock.isEditing"
                          class="btn btn-outline-success"
                          @click="saveStockEdit(stock)"
                          title="Enregistrer"
                        >
                          <i class="fas fa-save"></i>
                        </button>
                        <button
                          v-else
                          class="btn btn-outline-primary"
                          @click="editStock(stock)"
                          title="Modifier"
                        >
                          <i class="fas fa-edit"></i>
                        </button>
                        <button
                          class="btn btn-outline-danger"
                          @click="deleteStock(stock)"
                          title="Supprimer"
                        >
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Onglet Volontaires -->
          <div class="tab-pane fade"
               :class="{ 'show active': modalState.currentTab === 'volunteers' }"
               id="volunteers" role="tabpanel">
            <div class="card">
              <div class="card-header">
                <div class="card-title mb-0">
                  <i class="fas fa-users"></i> Gestion des volontaires
                </div>
              </div>
              <div class="card-body">
                <!-- Liste des volontaires existants -->
                <div
                  v-if="allVolunteers && allVolunteers.length > 0"
                  class="mb-3 d-flex flex-wrap gap-2"
                >
                  <label class="form-label">Mandatés :</label>
                    <span
                      v-for="(volunteer, index) in allVolunteers"
                      :key="index"
                      class="badge d-flex align-items-center gap-1 cursor-pointer"

                      :class="[
                        isVolunteerDeleted(volunteer) ? 'bg-danger' :
                        isNewVolunteer(volunteer) ? 'bg-warning text-dark' : 'bg-success'
                      ]"
                      @click="toggleVolunteer(volunteer)"
                    >
                       <i class="fas fa-user me-1"></i>
                      <span>[[ volunteer ]]</span>
                      <span class="ms-1">
                        <i
                          class="fas"
                          :class="[
                            isVolunteerDeleted(volunteer) ? 'fa-times' :
                            isNewVolunteer(volunteer) ? 'fa-plus' : 'fa-check'
                          ]"
                        ></i>
                      </span>
                    </span>
                </div>

                <!-- Ajout d'un volontaire -->
                <div class="mb-3">
                  <label for="new-volunteer" class="form-label"
                    >Ajouter un volontaire :</label
                  >
                  <div class="input-group">
                    <input
                      type="text"
                      class="form-control"
                      id="new-volunteer"
                      v-model="newVolunteer"
                      placeholder="Entrez le nom du volontaire"
                      list="volunteer-suggestions"
                      @keyup.enter="addVolunteer"
                    />
                    <datalist id="volunteer-suggestions">
                      <option
                        v-for="volunteer in availableVolunteersSuggestions"
                        :key="volunteer"
                        :value="volunteer"
                      >
                        [[ volunteer ]]
                      </option>
                    </datalist>
                    <button
                      class="btn btn-primary"
                      @click="addVolunteer"
                      :disabled="!newVolunteer.trim()"
                    >
                      <i class="fas fa-plus"></i> Ajouter
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Onglet Magasins -->
          <div class="tab-pane fade"
               :class="{ 'show active': modalState.currentTab === 'stores' }"
               id="stores" role="tabpanel">
            <div class="card">
              <div class="card-header">
                <div class="card-title mb-0">
                  <i class="fas fa-store"></i> Gestion du magasin
                </div>
              </div>
              <div class="card-body">
                <!-- Magasin actuel -->
                <div class="mb-3 d-flex flex-wrap gap-2">
                  <label class="form-label">Magasin :</label>
                  <div class="">
                    <span
                      v-if="modalState.editingIngredient?.store && modalState.editingIngredient.store.trim()"
                      class="badge  bg-primary"
                    > <i class="fas fa-store me-1"></i>
                      [[ modalState.editingIngredient.store ]]
                    </span>
                    <span
                      v-else
                      class="text-muted"
                    >
                      <i class="fas fa-info-circle me-1"></i>
                      Aucun magasin assigné
                    </span>
                  </div>
                </div>

                <!-- Remplacement du magasin -->
                <div class="mb-3">
                  <label for="store-replacement" class="form-label">
                    <span v-if="modalState.editingIngredient?.store && modalState.editingIngredient.store.trim()">
                      <i class="fas fa-exchange-alt me-1"></i>
                      Remplacer le magasin :
                    </span>
                    <span v-else>
                      <i class="fas fa-plus me-1"></i>
                      Assigner un magasin :
                    </span>
                  </label>
                  <div class="input-group">
                    <input
                      type="text"
                      class="form-control"
                      id="store-replacement"
                      v-model="editingStore"
                      :placeholder="modalState.editingIngredient?.store && modalState.editingIngredient.store.trim() ? 'Entrez le nouveau nom du magasin...' : 'Entrez le nom du magasin...'"
                      list="store-suggestions"
                      @keyup.enter="replaceStore"
                    />
                    <datalist id="store-suggestions">
                      <option
                        v-for="store in availableStoresSuggestions"
                        :key="store"
                        :value="store"
                      >
                        [[ store ]]
                      </option>
                    </datalist>
                    <button
                      class="btn"
                      :class="modalState.editingIngredient?.store && modalState.editingIngredient.store.trim() ? 'btn-warning' : 'btn-primary'"
                      @click="replaceStore"
                      :disabled="!editingStore.trim()"
                    >
                      <span v-if="modalState.editingIngredient?.store && modalState.editingIngredient.store.trim()">
                        <i class="fas fa-exchange-alt me-1"></i>
                        Remplacer
                      </span>
                      <span v-else>
                        <i class="fas fa-plus me-1"></i>
                        Assigner
                      </span>
                    </button>
                  </div>
                  <div class="form-text text-muted">
                    <small>
                      <span v-if="modalState.editingIngredient?.store && modalState.editingIngredient.store.trim()">
                        <i class="fas fa-info-circle me-1"></i>
                        Le magasin actuel sera remplacé par le nouveau
                      </span>
                      <span v-else>
                        <i class="fas fa-info-circle me-1"></i>
                        Assignez un magasin à cet ingrédient
                      </span>
                    </small>
                  </div>
                </div>


              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer avec bouton d'enregistrement global -->
      <div class="modal-footer">
        <div class="d-flex justify-content-between w-100">
          <div class="text-muted small">
            <span v-if="modalState.hasUnsavedChanges" class="text-warning">
              <i class="fas fa-exclamation-triangle"></i> Des modifications non
              enregistrées
            </span>
            <span v-else>
              <i class="fas fa-check-circle"></i> Toutes les modifications sont
              enregistrées
            </span>
          </div>
          <div class="d-flex gap-2">
            <button
              type="button"
              class="btn btn-secondary"
              @click="closeUnifiedModal"
            >
              Annuler
            </button>
            <button
              type="button"
              class="btn btn-primary"
              @click="saveAllChanges"
              :disabled="!modalState.hasUnsavedChanges || modalState.isSaving"
            >
              <span
                v-if="modalState.isSaving"
                class="spinner-border spinner-border-sm me-2"
              ></span>
              <i class="fas fa-save"></i> Enregistrer toutes les modifications
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast de confirmation de suppression -->
<div
  class="toast-container position-fixed bottom-0 end-0 p-3"
  style="z-index: 1060"
>
  <div
    class="toast show"
    :class="{ 'bg-danger text-white': deleteConfirmation.show }"
    role="alert"
    v-if="deleteConfirmation.show"
  >
    <div class="toast-header bg-danger text-white">
      <i class="fas fa-exclamation-triangle me-2"></i>
      <strong class="me-auto">Confirmation de suppression</strong>
      <button
        type="button"
        class="btn-close btn-close-white"
        @click="cancelDelete"
      ></button>
    </div>
    <div class="toast-body">
      <p>[[ deleteConfirmation.message ]]</p>
      <div class="btn-group w-100">
        <button class="btn btn-light" @click="cancelDelete">Annuler</button>
        <button class="btn btn-danger" @click="confirmDelete">Supprimer</button>
      </div>
      <div class="progress mt-2" style="height: 4px">
        <div
          class="progress-bar bg-warning"
          :style="{ width: deleteConfirmation.progress + '%' }"
        ></div>
      </div>
    </div>
  </div>
</div>
