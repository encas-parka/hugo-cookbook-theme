
{{/*
  ingredients-grouped-list.html

  Partial d’affichage d’une liste d’ingrédients groupée par type.
  Il délègue désormais toute la logique de résolution/typage/scaling/groupement
  au partial DRY "functions/ingredients-group-builder.html" et se concentre
  uniquement sur le rendu HTML.

  Entrée (dict):
    - items:             (list)  .Params.ingredients d’une page (ingrédients)
    - byUUID:            (map, optionnel) index des ingrédients par UUID
    - mode:              (string) "recette" | "evenement"
    - assiettes:         (int/float, optionnel) nb de couverts événement
    - assiettesRecettes: (int/float, optionnel) nb de couverts de la recette
    - showAllergenIcon:  (bool, optionnel, défaut: true)
    - showComment:       (bool, optionnel, défaut: true)

  Comportement de fallback:
    - Si byUUID n’est pas fourni (ou vide), le partial charge automatiquement
      l’index global des ingrédients via un cache côté thème, puis initialise byUUID.
    - Si byUUID est fourni par l’appelant, il est utilisé tel quel (pas de chargement).
*/}}

{{/* ---- Helpers: paramètres et valeurs par défaut ---- */}}
{{- $items := .items | default (slice) -}}
{{- $byUUID := .byUUID -}}
{{- $mode := .mode | default "recette" -}}
{{- $assiettes := .assiettes -}}
{{- $assiettesRecettes := .assiettesRecettes -}}
{{- $showAllergenIcon := cond (ne .showAllergenIcon nil) .showAllergenIcon true -}}
{{- $showComment := cond (ne .showComment nil) .showComment true -}}

{{/* ---- Construction via builder DRY ---- */}}
{{/* Auto-fallback: charger l'index si byUUID non fourni */}}
{{- if or (not $byUUID) (eq (len $byUUID) 0) -}}
  {{- $ingredientsIndex := partialCached "functions/ingredients-index.html" . -}}
  {{- $byUUID = $ingredientsIndex.byUUID -}}
{{- end -}}

{{- $ingredientsByType := partial "functions/ingredients-group-builder" (dict
  "items" $items
  "byUUID" $byUUID
  "mode" $mode
  "assiettes" $assiettes
  "assiettesRecettes" $assiettesRecettes
) -}}

{{/* ---- Rendu: par type, en-tête icône + libellé renommé, puis items triés ---- */}}
{{- range $type, $list := $ingredientsByType -}}
  <div class="card my-2 p-2" outlined>
    <div>
      <span class="fw-bold mb-2 me-1">
        {{- partial "components/icon-svg" (dict "name" $type "size" "1.3em" "class" "me-1") -}}
        {{- partial "functions/ingredients-types-rename-short" (dict "ingType" ($type | strings.FirstUpper)) -}}
      </span>
      {{- if eq $type "epices" -}}
        <span class="small text-muted">(goûtez, ajustez !)</span>
      {{- end -}}
    </div>

    {{/* Tri alphabétique robuste: utilise title si présent, sinon slug fallback */}}
    {{- $sorted := slice -}}
    {{- range $list -}}
      {{- $titleKey := cond (ne (printf "%v" .title) "") .title (or .slug "") -}}
      {{- $sorted = $sorted | append (dict "item" . "key" ($titleKey | lower)) -}}
    {{- end -}}
    {{- $sorted = sort $sorted "key" -}}

    {{- range $sorted -}}
      {{- $it := .item -}}
      {{- $title := $it.title -}}
      {{- $allergenes := $it.allergenes | default (slice) -}}
      {{- $q := $it.quantite | default 0 -}}
      {{- $u := $it.unit | default "" -}}
      {{- $c := $it.commentaire -}}

      <div class="small ps-2 print-fs-smaller mt-1">
        <span class="fw-bold">• {{- $title -}}</span>
        {{- if and $showAllergenIcon (gt (len $allergenes) 0) -}}
          <span class="ms-1 align-middle">
            {{- partial "components/icon-svg" (dict "name" "exclamation-triangle" "size" ".8rem" "class" "mb-1") -}}
          </span>
        {{- end -}}

        {{- if $q -}}
          : <span class="amount me-1">{{- $q -}}</span>
          {{- $unitShort := $u -}}
          {{- if eq $u "grammes" -}}
            {{- $unitShort = "gr." -}}
          {{- else if eq $u "litre" -}}
            {{- $unitShort = "l." -}}
          {{- else if and (eq $u "unité") (gt $q 1) -}}
            {{- $unitShort = "unités" -}}
          {{- end -}}
          {{- if $unitShort -}}
            <span class="unit"> {{- $unitShort -}}</span>
          {{- end -}}
          {{- if or (eq $u "unité") (eq $u "c. à café") (eq $u "c. à soupe") -}}
            <span class="ms-1 text-muted">
              {{- partial "functions/quantite-converter" ( dict "unit" $u "ingredient" $title "quantite" $q "fetchQU" true ) -}}
            </span>
          {{- end -}}
        {{- end -}}

        {{- if and $showComment $c -}}
          <span class="small text-muted ms-2">({{- $c -}})</span>
        {{- end -}}
      </div>
    {{- end -}}
  </div>
{{- end -}}

{{/* Note:
   - Ce partial ne gère pas l’affichage global des alertes allergènes
     (cartes d’alertes). Il pose simplement l’icône au niveau item.
   - Pour un comportement strictement identique entre recettes et événements,
     appeler ce partial avec:
       • mode: "recette" pour les pages recettes
       • mode: "evenement", assiettes, assiettesRecettes pour les pages événements.
*/}}
