{{/*
  ingredients-display-pre-grouped.html

  Displays a pre-grouped list of ingredients. This partial is purely for presentation
  and performs no calculations. It relies on the data structure provided by
  `ingredients-group-builder.html`.

  Input (dict):
    - ingredientsByType: (map) The pre-calculated data structure { type -> [entries] }.
                         Each entry must contain `hasConversion`, `quantiteEq`, `unitEq`, etc.
    - showAllergenIcon:  (bool) Whether to display the allergen icon.
    - showComment:       (bool) Whether to display the comment.
    - eventMode:         (bool) If true, uses `quantiteFormatted` for display.
*/}}

{{- $ingredientsByType := .ingredientsByType | default (dict) -}}
{{- $showAllergenIcon := cond (ne .showAllergenIcon nil) .showAllergenIcon true -}}
{{- $showComment := cond (ne .showComment nil) .showComment true -}}
{{- $eventMode := .eventMode | default false -}}

{{- range $type, $list := $ingredientsByType -}}
<div class="card my-2 p-2" outlined>
  <div>
    <span class="fw-bold mb-2 me-1">
      {{- partialCached "components/icon-svg.html" (dict "name" $type "size" "1.3em" "class" "me-1") $type "1.3em" -}}
      {{- partialCached "functions/ingredients-types-rename-short.html" (dict "ingType" ($type | strings.FirstUpper)) ($type | strings.FirstUpper) -}}
    </span>
    {{- if eq $type "epices" -}}<span class="small text-muted">(go√ªtez, ajustez !)</span>{{- end -}}
  </div>

  {{- $sorted := sort $list "ingredient" "asc" -}}
  {{- range $sorted -}}
    {{- $it := . -}}
    <div class="small ps-2 print-fs-smaller mt-1">
      <span class="fw-bold">{{- $it.ingredient -}}</span>
      {{- if and $showAllergenIcon (gt (len ($it.allergenes | default slice)) 0) -}}
        <span class="ms-1 align-middle">
          {{- partialCached "components/icon-svg.html" (dict "name" "exclamation-triangle" "size" ".8rem" "class" "mb-1") "exclamation-triangle" ".8rem" -}}
        </span>
      {{- end -}}

      {{- if $it.quantite -}}
        :
        {{- if $eventMode -}}
          {{- /* In event mode, use the pre-formatted quantity string */ -}}
          <span class="amount ms-1">{{- $it.quantiteFormatted -}}</span>
        {{- else -}}
          {{- /* In recipe mode, display the raw quantity and unit */ -}}
          <span class="amount ms-1">{{- $it.quantite -}}</span>
          <span class="unit">{{- $it.unit -}}</span>
        {{- end -}}

        {{- /* NEW: Display the equivalence if a conversion was possible */ -}}
        {{- if $it.hasConversion -}}
          <span class="ms-1 text-muted">
            {{- $displayEq := partial "functions/format-qty.html" (dict "qty" $it.quantiteEq "unit" $it.unitEq) -}}
            (~ {{ $displayEq }})
          </span>
        {{- end -}}

        {{- if and $showComment $it.commentaire -}}
          <span class="small text-muted ms-2">({{- $it.commentaire -}})</span>
        {{- end -}}
      {{- end -}}
    </div>
  {{- end -}}
</div>
{{- end -}}
