{{ if .Site.Params.alert -}}
{{ partial "header/alert.html" . }}
{{ end -}}

<header>
  {{/*  ::: import svg icon  */}}
  {{/*  TODO : importer sprite svg comme ressource externe pour mise en cache  */}}
  {{ $sprite := resources.Get "fonticons/sprite-icons.svg" }}
  {{ if $sprite }}
    <div style="height: 0; overflow: hidden;">{{ $sprite.Content | safeHTML }}</div>
  {{ end }}
  <div>

    <nav class="navbar navbar-dark navbar-expand bg-dark no-print py-1 fixed-top" id="main-navbar">
      <div class="container-fluid" >
        <a class="navbar-brand monospace" href="{{ .Site.BaseURL }}">
          <img src="/favicon-96x96.png" alt="logo" height="32" class="d-inline-block align-text-center">
        </a>


          <ul class="navbar-nav text-secondary me-auto">
            <li class="nav-item">

            </li>
            <li class="nav-item">
              <a class="nav-link px-3" href="/recettes">Recettes</a>
            </li>
            <li class="nav-item">
              <a href="" class="nav-link" data-bs-toggle="modal" data-bs-target="#search-events-modal" role="button">
                Evenements
                </a>
            </li>
          </ul>

          <ul class="navbar-nav text-secondary ms-auto">
            <!-- État pour les utilisateurs déconnectés -->
            <li class="nav-item " id="header-logged-out">
              <a href="/login" class="btn btn-outline-primary btn-sm d-flex align-items-center" aria-label="Se connecter">
                {{ partial "inline-svg" (dict "src" "fonticons/person-circle.svg"  "fs" 6) }}

              </a>
            </li>
            <!-- État pour les utilisateurs connectés (masqué par défaut) -->
            <li class="nav-item dropdown" id="header-logged-in" style="display: none;">
              <button class="btn btn-primary btn-sm dropdown-toggle d-flex align-items-center"
                      id="navbarUserDropdown"
                      type="button"
                      data-bs-toggle="dropdown"
                      aria-expanded="false"
                      aria-label="Menu utilisateur">
                {{ partial "inline-svg" (dict "src" "fonticons/person-circle.svg"  "fs" 4) }}
              </button>

              <ul class="dropdown-menu dropdown-menu-end " aria-labelledby="navbarUserDropdown">
                <li><div class="dropdown-header small text-muted " id="header-user-email-display">Utilisateur</div></li>
                <li><a class="dropdown-item d-flex align-items-center" href="/sveltia/">
                  {{ partial "inline-svg" (dict "src" "fonticons/pencil.svg" "fs" 4 "class" "me-2") }}
                  Administration
                </a></li>
                <li><a class="dropdown-item d-flex align-items-center" href="/invitation/">
                  {{ partial "inline-svg" (dict "src" "fonticons/user-round-plus.svg" "fs" 4 "class" "me-2") }}
                  Inviter
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><button class="dropdown-item d-flex align-items-center" id="header-logout-button">
                  {{ partial "inline-svg" (dict "src" "fonticons/log-out.svg" "fs" 4 "class" "me-2") }}
                  Se déconnecter
                </button></li>
              </ul>
            </li>

          </ul>
        </div>

      </div>
    </nav>
  </div>

</header>

<!-- CSS pour l'animation de scroll -->
<style>
/* Animation fluide pour le comportement de scroll de la navbar */
#main-navbar {
  transition: transform 0.3s ease-in-out;
}

.navbar-hidden {
  transform: translateY(-100%);
}

/* Amélioration visuelle des boutons du header */
.navbar .btn {
  border-radius: 6px;
  min-width: 38px;
  min-height: 38px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.navbar .btn svg {
  width: 16px;
  height: 16px;
}

/* Style pour le dropdown menu */
.dropdown-menu-dark .dropdown-item {
  transition: background-color 0.15s ease-in-out;
}

.dropdown-menu-dark .dropdown-item:hover {
  background-color: rgba(255, 255, 255, 0.15);
}

/* Espacement pour les icônes dans le menu */
.dropdown-item svg {
  width: 14px;
  height: 14px;
  opacity: 0.8;
}
</style>

{{/* Modal des modules de recherche vuejs */}}
<!-- <div class="modal fade" id="search-recipes-modal" data-toggle="modal" tabindex="0" aria-labelledby="Search Recipes"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content ">
      <div class="modal-header py-2">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {{/* partialCached "components/search-module-recipes" . "search-recipes" */}}
      </div>
    </div>
  </div>
</div> -->

<div class="modal fade" id="search-events-modal" data-toggle="modal" tabindex="0" aria-labelledby="Search Events"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content ">
      <div class="modal-header py-2">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        {{ partialCached "components/search-module-events" . "search-events" }}
      </div>
    </div>
  </div>
</div>

<script>
// Gestion du comportement de scroll de la navbar en JavaScript vanilla
(function() {
  const navbar = document.getElementById('main-navbar');
  if (!navbar) return;

  // --- 1. Calculer et exposer la hauteur de la navbar ---
  const updateNavbarHeight = () => {
    const navbarHeight = navbar.offsetHeight;
    document.documentElement.style.setProperty('--main-navbar-height', `${navbarHeight}px`);

    // Appliquer la classe visible immédiatement
    const eventNavbar = document.getElementById('navbarEvent');
    if (eventNavbar) {
      eventNavbar.classList.add('visible');
    }
  };

  // Exécuter AU CHARGEMENT (pas après)
  document.addEventListener('DOMContentLoaded', updateNavbarHeight);

  // Mettre à jour en cas de redimensionnement
  window.addEventListener('resize', updateNavbarHeight);

  // Écouter l'ouverture/fermeture du menu burger
  const navbarCollapse = document.getElementById('navbarHeader');
  if (navbarCollapse) {
    navbarCollapse.addEventListener('shown.bs.collapse', updateNavbarHeight);
    navbarCollapse.addEventListener('hidden.bs.collapse', updateNavbarHeight);
  }


  // --- 2. Gérer le masquage de la navbar au scroll ---
  let lastScrollTop = 0;
  function handleScroll() {
    const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
    const eventNavbar = document.getElementById('navbarEvent');
    if (currentScroll <= 0) {
       navbar.classList.remove('navbar-hidden');
       if (eventNavbar) {
         eventNavbar.style.top = 'var(--main-navbar-height)';
       }
     } else if (currentScroll < lastScrollTop) {
       navbar.classList.remove('navbar-hidden');
       if (eventNavbar) {
         eventNavbar.style.top = 'var(--main-navbar-height)';
       }
     } else if (currentScroll > lastScrollTop && currentScroll > navbar.offsetHeight) {
       navbar.classList.add('navbar-hidden');
       if (eventNavbar) {
         eventNavbar.style.top = '0';
       }
     }
     lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
   }

    // Observer pour détecter quand la navbar principale est masquée/affichée
    const navbarObserver = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'class') {
          const eventNavbar = document.getElementById('navbarEvent');
          if (eventNavbar && navbar.classList.contains('navbar-hidden')) {
            eventNavbar.style.top = '0';
          }
        }
      });
    });

    // Observer la navbar principale
    navbarObserver.observe(navbar, {
      attributes: true,
      attributeFilter: ['class']
    });

  // Optimisation de l'événement scroll
  let ticking = false;
  function requestTick() {
    if (!ticking) {
      requestAnimationFrame(() => {
        handleScroll();
        ticking = false;
      });
      ticking = true;
    }
  }

  window.addEventListener('scroll', requestTick, { passive: true });
})();
</script>
