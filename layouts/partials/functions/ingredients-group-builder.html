{{/*
  ingredients-group-builder.html

  DRY core builder for grouped ingredients by type. This partial is the central
  point for processing ingredient data for both single recipes and events.

  Purpose:
    - Resolve each ingredient from the global index (byUUID).
    - Group ingredients by their `type` metadata.
    - Scale quantities for events based on servings (`assiettes`).
    - **NEW**: Normalize and convert quantities into standard base units (gr, ml)
      by calling `functions/quantite-converter.html`.
    - Optionally split legumes into "frais" and "non-frais" groups.
    - Analyze dietary regimes based on ingredient types and allergens.

  Input (dict):
    - items:              (list) List of recipe ingredients { ingredient, quantite, unit, ... }.
    - byUUID:             (map) Global ingredients index by UUID.
    - mode:               (string) "recette" | "evenement".
    - assiettes:          (int/float, optional) Event servings.
    - assiettesRecettes:  (int/float, optional) Recipe base servings.
    - splitLegumes:       (bool, optional) Whether to split legumes by `pFrais`.

  Output:
    - dict {
        "ingredients": { type -> [ entries ] },
        "regimes": { ... }
      }
      where each entry is an enriched ingredient map containing:
        - ingredient, type, allergenes, commentaire, pFrais, pSurgel, uuid
        - quantite: The scaled quantity (for events).
        - unit: The original unit.
        - quantiteFormatted: A display-ready formatted quantity string.
        - quantiteEq: (float) The quantity normalized to a base unit (gr/ml).
        - unitEq: (string) The base unit ("gr." or "ml").
        - hasConversion: (bool) True if a conversion was possible.
        - conversionRule: (string) The conversion rule for the ingredient.
*/}}

{{- $items := .items | default (slice) -}}
{{- $byUUID := .byUUID | default (dict) -}}
{{- $mode := .mode | default "recette" -}}
{{- $assiettes := .assiettes -}}
{{- $assiettesRecettes := .assiettesRecettes -}}
{{- $splitLegumes := .splitLegumes | default false -}}

{{- $grouped := dict -}}

{{- /* Initialize regime detection variables */}}
{{- $hasAnimalType := false -}}
{{- $hasDairyAllergen := false -}}
{{- $hasEggAllergen := false -}}
{{- $hasGlutenAllergen := false -}}
{{- $hasNonVeganAllergen := false -}}

{{- range $items -}}
  {{- $ingId := .ingredient | default "" -}}
  {{- $q := .quantite | default 0 -}}
  {{- $u := .unit | default "" -}}
  {{- $c := .commentaire -}}

  {{- $meta := dict -}}
  {{- if $ingId -}}
    {{- $uuid := partialCached "functions/extract-uuid-from-slug.html" $ingId $ingId -}}
    {{- if $uuid -}}
      {{- with (index $byUUID $uuid) -}}
        {{- $meta = . -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{- if and $meta (gt (len $meta) 0) -}}
    {{- $type := ($meta.type | default "autres") -}}
    {{- $title := $meta.title -}}
    {{- $allergenes := ($meta.allergenes | default (slice)) -}}
    {{- $uuid := $meta.uuid -}}
    {{- $pFrais := $meta.pFrais | default false -}}
    {{- $pSurgel := $meta.pSurgel | default false -}}

    {{- $groupType := $type -}}
    {{- if and (eq $type "legumes") $splitLegumes -}}
      {{- if $pFrais -}}
        {{- $groupType = "legumesFrais" -}}
      {{- else -}}
        {{- $groupType = "legumesNonFrais" -}}
      {{- end -}}
    {{- end -}}

    {{- $scaledQty := (float $q) -}}
    {{- if and (eq $mode "evenement") (ne (printf "%v%v" $assiettes $assiettesRecettes) "") -}}
      {{- $den := (cond (gt (float $assiettesRecettes) 0) (float $assiettesRecettes) 1.0) -}}
      {{- $scaledQty = (div (mul (float $q) (float $assiettes)) $den) -}}
    {{- end -}}

    {{- $formattedQty := $scaledQty -}}
    {{- if eq $mode "evenement" -}}
      {{- $formattedQty = partial "functions/format-qty.html" (dict "qty" $scaledQty "unit" $u) -}}
    {{- end -}}

    {{/*
    {{- if eq $mode "ingredientsJson" -}}
      {{- if eq "Kg" $u) -}}
        {{- $scaledQty = mul $qFloat 1000 -}}
        {{- $u = "gr." -}}
      {{- else if eq "l." $u) -}}
        {{- $scaledQty = mul $qFloat 1000 -}}
        {{- $u = "ml" -}}
      {{- end -}}
    {{- end -}}
    */}}


    {{- /* Call the converter to get standardized quantities */ -}}
    {{- $conversionResult := partial "functions/quantite-converter.html" (dict
        "quantite" $scaledQty
        "unit" $u
        "ingredient" $title
        "fetch" "dict"
      )
    -}}

    {{- $entryType := cond $splitLegumes $groupType $type -}}
    {{- $entry := dict
        "ingredient" $title
        "type" $entryType
        "allergenes" $allergenes
        "quantite" $scaledQty
        "quantiteFormatted" $formattedQty
        "unit" $u
        "commentaire" $c
        "uuid" $uuid
        "pFrais" $pFrais
        "pSurgel" $pSurgel
      | merge $conversionResult -}} {{/* Merge the conversion results here */}}

    {{- $current := (index $grouped $groupType) | default (slice) -}}
    {{- $grouped = merge $grouped (dict $groupType ( $current | append $entry )) -}}

    {{- /* Update regime detection flags */}}
    {{- if eq $type "animaux" -}}
      {{- $hasAnimalType = true -}}
    {{- end -}}
    {{- range $allergenes -}}
      {{- if or ( eq . "Produit laitier") (eq . "Lactose") -}}
        {{- $hasDairyAllergen = true -}}
      {{- else if eq . "Oeuf" -}}
        {{- $hasEggAllergen = true -}}
      {{- else if eq . "Non-Vegan" -}}
        {{- $hasNonVeganAllergen = true -}}
      {{- else if eq . "Gluten" -}}
        {{- $hasGlutenAllergen = true -}}
      {{- end -}}
    {{- end -}}
  {{- else -}}
    {{/* Unresolved ingredient (grouped under "absent") */}}
    {{- $fallback := cond (ne $ingId "") $ingId "inconnu" -}}
    {{- $entry := dict
        "slug" $ingId
        "ingredient" $fallback
        "quantite" $q
        "unit" $u
        "commentaire" $c
        "hasConversion" false
      -}}
    {{- $current := (index $grouped "absent") | default (slice) -}}
    {{- $grouped = merge $grouped (dict "absent" ( $current | append $entry )) -}}
  {{- end -}}
{{- end -}}

{{- /* Calculate regimes based on detected flags */}}
{{- $isVegetarien := not $hasAnimalType -}}
{{- $isVegan := and $isVegetarien (not $hasDairyAllergen) (not $hasEggAllergen) (not $hasNonVeganAllergen) -}}
{{- $isSansGluten := not $hasGlutenAllergen -}}
{{- $isSansLactose := not $hasDairyAllergen -}}

{{- $regimes := dict
  "vegetarien" $isVegetarien
  "vegan" $isVegan
  "sans_gluten" $isSansGluten
  "sans_lactose" $isSansLactose
-}}

{{- return (dict "ingredients" $grouped "regimes" $regimes) -}}
