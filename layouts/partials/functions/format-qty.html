{{/* format-qty.html
     Partial utilitaire pour formater une quantité + unité.

     Entrée (dict):
       - qty  (number|string) : quantité (peut être string convertible en nombre)
       - unit (string)        : unité d’entrée ("gr.", "Kg", "ml", "l.", "unité", etc.)

     Règles:
       - Pluriel "unité" -> "unités" si qty > 1
       - Conversions:
           • gr. <-> Kg (seuil ≈ 1000)
           • ml  <-> l. (seuil ≈ 1000)
       - Arrondis lisibles:
           • Petites valeurs: 2 décimales (trim des zéros)
           • Valeurs en gr./ml >= 1 et < 1000: arrondi entier
           • Valeurs en Kg/l. >= 1: 2 décimales (trim des zéros)

     Sortie:
       - Chaîne formatée "valeur unité"
*/}}

{{- $qty := .qty -}}
{{- $unit := .unit | default "" -}}

{{/* Normalisation du type de qty (string -> float) */}}
{{- $q := (float (cond (eq (printf "%T" $qty) "string") ($qty | float) $qty)) -}}
{{- $u := $unit -}}

{{/* Normalisation unités  pluriels */}}

{{- if and (eq $u "unité") (gt $q 1) -}}
  {{- $u = "unités" -}}
{{- end -}}

{{/* Conversions g↔kg et ml↔l, avec seuils et arrondis */}}
{{- if or (eq $u "Kg") (eq $u "l.") -}}
  {{- if lt $q 1 -}}
    {{- if eq $u "l." -}}
      {{- printf "%s %s" ( (mul $q 1000) | math.Round | printf "%.0f" ) "ml" -}}
    {{- else -}}
      {{- printf "%s %s" ( (mul $q 1000) | math.Round | printf "%.0f" ) "gr." -}}
    {{- end -}}
  {{- else -}}
    {{- printf "%s %s" ( (printf "%.2f" $q) | strings.TrimRight "0" | strings.TrimRight "." | strings.TrimRight "," ) $u -}}
  {{- end -}}
{{- else if or (eq $u "gr.") (eq $u "ml") -}}
  {{- if gt (math.Ceil $q) 999 -}}
    {{- $qKgL := div $q 1000 -}}
    {{- if eq $u "ml" -}}
      {{- printf "%s %s" ( (printf "%.2f" $qKgL) | strings.TrimRight "0" | strings.TrimRight "." | strings.TrimRight "," ) "l." -}}
    {{- else -}}
      {{- printf "%s %s" ( (printf "%.2f" $qKgL) | strings.TrimRight "0" | strings.TrimRight "." | strings.TrimRight "," ) "Kg" -}}
    {{- end -}}
  {{- else if lt $q 1 -}}
    {{- printf "%s %s" ( (printf "%.2f" $q) | strings.TrimRight "0" | strings.TrimRight "." | strings.TrimRight "," ) $u -}}
  {{- else -}}
    {{- printf "%s %s" ( (printf "%.0f" (math.Round $q)) ) $u -}}
  {{- end -}}
{{- else -}}
  {{- printf "%s %s" ( (printf "%.2f" $q) | strings.TrimRight "0" | strings.TrimRight "." | strings.TrimRight "," ) $u -}}
{{- end -}}
