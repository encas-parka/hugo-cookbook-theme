{{- /*
  event-data-processor.html

  Partial centralisé pour traiter toutes les données d'un événement.
  Il parcourt les repas et les recettes UNE SEULE FOIS, et construit
  toutes les structures de données nécessaires pour les différents formats de sortie JSON.

  Input:
    - Contexte de la page (.)

  Output: (dict)
    - ingredient_totals: Map pour single.ingredients_aw.json
    - ingredient_occurrences: Map pour single.ingredients_aw.json
    - ingByTypeList: Slice pour single.ingredientsjson.json
    - datesRepas, datesTimeRepas, startDate, endDate
    - types: Slice des types d'ingrédients
    - recettesLength, nbDate, uniqueIngCount
    - missingRecipes
*/}}

{{- $pageContext := . -}}

{{- /* Index globaux */}}
{{- $recettesIndex := partialCached "functions/recettes-index.html" "recettes-index-global" -}}
{{- $byUUIDRecette := cond (and $recettesIndex (isset $recettesIndex "byUUIDRecette")) $recettesIndex.byUUIDRecette (dict) -}}
{{- $ingredientsIndex := partialCached "functions/ingredients-index.html" "ingredients-index" -}}
{{- $byUUIDIng := cond (and $ingredientsIndex (isset $ingredientsIndex "byUUID")) $ingredientsIndex.byUUID (dict) -}}

{{- /* --- Initialisation de TOUTES les structures de données --- */}}

{{- /* Pour ingredients_aw.json */}}
{{- $ingredient_totals := dict -}}
{{- $ingredient_occurrences := dict -}}

{{- /* Pour ingredientsjson.json */}}
{{- $IngTypeListGrouped := dict -}}
{{- $typesSet := dict -}}
{{- $uniqueIngSet := dict -}}
{{- $datesRepas := slice -}}
{{- $datesTimeRepas := slice -}}
{{- $recettesLength := 0 -}}
{{- $nbDate := 0 -}}
{{- $missingRecipes := slice -}}

{{- /* --- Boucle de traitement unique --- */}}
{{- range $pageContext.Param "repas" -}}
  {{- $dateService := .date_service -}}
  {{- $dateTimeService := .date_service -}}
  {{- $nbDate = add $nbDate 1 -}}
  {{- $horaire := .horaire -}}
  {{- $repasBaseAssiettes := (int .assiettes) -}}

  {{- /* Normalisation du datetime */}}
  {{- if not (findRE "T" $dateService) }}{{ $dateTimeService = printf "%sT12:00:00" $dateService }}{{ end -}}
  {{- if eq $horaire "matin" }}{{ $dateTimeService = $dateService | replaceRE "T\\d{2}:\\d{2}:\\d{2}" "T08:00:00" }}
  {{- else if eq $horaire "midi" }}{{ $dateTimeService = $dateService | replaceRE "T\\d{2}:\\d{2}:\\d{2}" "T12:00:00" }}
  {{- else if eq $horaire "soir" }}{{ $dateTimeService = $dateService | replaceRE "T\\d{2}:\\d{2}:\\d{2}" "T20:00:00" }}{{ end -}}

  {{- $datesRepas = $datesRepas | append $dateService -}}
  {{- $datesTimeRepas = $datesTimeRepas | append $dateTimeService -}}

  {{- range .recettes_du_repas -}}
    {{- $recettesLength = add $recettesLength 1 -}}
    {{- $assiettesPourCalcul := $repasBaseAssiettes -}}
    {{- $typePlat := .type_plat -}}
    {{- if .altAssiettes }}{{ $assiettesPourCalcul = (int .altAssiettes) }}{{ end -}}

    {{- $uuid := partialCached "functions/extract-uuid-from-slug.html" .recette .recette -}}
    {{- $recetteMeta := cond (and $uuid (ne $uuid "")) (index $byUUIDRecette $uuid) nil -}}

    {{- if not $recetteMeta -}}
      {{- $missingInfo := dict "recetteSlug" .recette "dateService" $dateService "horaire" $horaire "reason" "Recette non trouvée" -}}
      {{- $missingRecipes = $missingRecipes | append $missingInfo -}}
    {{- else -}}
      {{- $recetteName := $recetteMeta.title -}}
      {{- $assiettesRecettes := $recetteMeta.plate -}}
      {{- $ingredients := $recetteMeta.ingredients -}}
      {{- $recetteID := $recetteMeta.File.UniqueID -}}

      {{- $builderContext := (dict
        "items" $ingredients
        "byUUID" $byUUIDIng
        "mode" "evenement"
        "assiettes" $assiettesPourCalcul
        "assiettesRecettes" $assiettesRecettes
        "splitLegumes" true
      ) -}}
      {{- $groupedForRecette := (partial "functions/ingredients-group-builder" $builderContext).ingredients -}}

      {{- if and $groupedForRecette (reflect.IsMap $groupedForRecette) -}}
        {{- range $type, $list := $groupedForRecette -}}
          {{- if and $type (reflect.IsSlice $list) -}}
            {{- $typesSet = merge $typesSet (dict $type true) -}}

            {{- /* --- Agrégation pour ingredientsjson.json --- */}}
            {{- $currentList := index $IngTypeListGrouped $type | default (slice) -}}
            {{- $enrichedList := slice -}}
            {{- range $item := $list -}}
              {{- if and $item (reflect.IsMap $item) -}}
                {{- if .uuid }}{{ $uniqueIngSet = merge $uniqueIngSet (dict .uuid true) }}{{ end -}}
                {{- $enrichedItem := merge $item (dict "recette" $recetteName "dateService" $dateService "dateTimeService" $dateTimeService "horaire" $horaire "typePlat" $typePlat "assiettesRecettes" $assiettesRecettes "assiettes" $assiettesPourCalcul) -}}
                {{- $enrichedList = $enrichedList | append $enrichedItem -}}
              {{- end -}}
            {{- end -}}
            {{- $IngTypeListGrouped = merge $IngTypeListGrouped (dict $type ($currentList | append $enrichedList)) -}}


            {{- /* --- Agrégation pour ingredients_aw.json --- */}}
            {{- range $item := $list -}}
              {{- if and $item (reflect.IsMap $item) -}}
                {{- $name := $item.ingredient | default "" -}}
                {{- $uuid_ing := $item.uuid | default "" -}}

                {{- if ne $name "" -}}
                  {{- /* Initialisation de la structure si nécessaire */}}
                  {{- if not (index $ingredient_totals $name) -}}
                    {{- $ingMeta := index $byUUIDIng $uuid_ing -}}
                    {{- $pFrais := cond $ingMeta $ingMeta.pFrais false -}}
                    {{- $pSurgel := cond $ingMeta $ingMeta.pSurgel false -}}
                    {{- $ingredient_totals = merge $ingredient_totals (dict $name (dict "uuid" $uuid_ing "name" $name "type" $item.iType "pFrais" $pFrais "pSurgel" $pSurgel "category_weight" 0.0 "category_volume" 0.0 "category_other" (dict) "consolidated_weight" 0.0 "consolidated_volume" 0.0 "consolidated_other" (dict) "has_conversion" false "conversion_rules" (slice))) -}}
                    {{- $ingredient_occurrences = merge $ingredient_occurrences (dict $name (slice)) -}}
                  {{- end -}}

                  {{- $current := index $ingredient_totals $name -}}
                  {{- $quantite := $item.quantite | default 0.0 -}}
                  {{- $unit := $item.unit | default "" -}}
                  {{- $quantiteEq := $item.quantiteEq | default $quantite -}}
                  {{- $unitEq := $item.unitEq | default $unit -}}
                  {{- $hasEquivalence := $item.hasConversion | default false -}}
                  {{- $conversionRule := $item.conversionRule | default "" -}}

                  {{- /* Ajout de l'occurrence */}}
                  {{- $occurrence := dict "recipe_name" $recetteName "recipe_id" $recetteID "dateTimeService" $dateTimeService "horaire" $horaire "typePlat" $typePlat "assiettes" $assiettesPourCalcul "quantite" $quantite "unit" $unit -}}
                  {{- $ingredient_occurrences = merge $ingredient_occurrences (dict $name ((index $ingredient_occurrences $name) | append $occurrence)) -}}

                  {{- /* Mise à jour des flags et règles de conversion */}}
                  {{- if $hasEquivalence -}}
                    {{- $current = merge $current (dict "has_equivalence" true) -}}
                    {{- if and (ne $conversionRule "") (not (in $current.conversion_rules $conversionRule)) -}}
                      {{- $current = merge $current (dict "conversion_rules" ($current.conversion_rules | append $conversionRule)) -}}
                    {{- end -}}
                  {{- end -}}

                  {{- /* Consolidation par catégorie (brute) */}}
                  {{- $unitLower := $unit | lower -}}
                  {{- if or (eq $unitLower "kg") (eq $unitLower "gr.") (eq $unitLower "g") -}}
                    {{- $weightVal := cond (eq $unitLower "kg") (mul $quantite 1000) $quantite -}}
                    {{- $current = merge $current (dict "category_weight" (add $current.category_weight $weightVal)) -}}
                  {{- else if or (eq $unitLower "l.") (eq $unitLower "ml") -}}
                    {{- $volumeVal := cond (eq $unitLower "l.") (mul $quantite 1000) $quantite -}}
                    {{- $current = merge $current (dict "category_volume" (add $current.category_volume $volumeVal)) -}}
                  {{- else -}}
                    {{- $other_dict := $current.category_other -}}
                    {{- $other_dict = merge $other_dict (dict $unit (add (index $other_dict $unit | default 0.0) $quantite)) -}}
                    {{- $current = merge $current (dict "category_other" $other_dict) -}}
                  {{- end -}}

                  {{- /* Consolidation complète (convertie) */}}
                  {{- if eq $unitEq "gr." }}{{ $current = merge $current (dict "consolidated_weight" (add $current.consolidated_weight $quantiteEq)) }}
                  {{- else if eq $unitEq "ml" }}{{ $current = merge $current (dict "consolidated_volume" (add $current.consolidated_volume $quantiteEq)) }}
                  {{- else -}}
                    {{- $other_dict := $current.consolidated_other -}}
                    {{- $other_dict = merge $other_dict (dict $unitEq (add (index $other_dict $unitEq | default 0.0) $quantiteEq)) -}}
                    {{- $current = merge $current (dict "consolidated_other" $other_dict) -}}
                  {{- end -}}

                  {{- $ingredient_totals = merge $ingredient_totals (dict $name $current) -}}
                {{- end -}}
              {{- end -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* --- Finalisation des données (tris, etc.) --- */}}
{{- $datesTimeRepas = sort $datesTimeRepas | uniq -}}
{{- $datesRepas = sort $datesRepas | uniq -}}
{{- $types := slice -}}
{{- range $key, $value := $typesSet -}}
  {{- $types = $types | append $key -}}
{{- end -}}
{{- $types = sort $types "value" "desc" -}}

{{- $ingByTypeList := slice -}}
{{- range $t := $types -}}
  {{- $items := sort (index $IngTypeListGrouped $t | default (slice)) "ingredient" "asc" -}}
  {{- $ingByTypeList = $ingByTypeList | append (dict "type" $t "items" $items) -}}
{{- end -}}

{{- /* --- Retourner le dictionnaire complet --- */}}
{{- return (dict
  "ingredient_totals" $ingredient_totals
  "ingredient_occurrences" $ingredient_occurrences
  "ingByTypeList" $ingByTypeList
  "datesRepas" $datesRepas
  "datesTimeRepas" $datesTimeRepas
  "startDate" (cond (gt (len $datesRepas) 0) (index $datesRepas 0) "")
  "endDate" (cond (gt (len $datesRepas) 0) (index $datesRepas (sub (len $datesRepas) 1)) "")
  "types" $types
  "recettesLength" $recettesLength
  "nbDate" $nbDate
  "uniqueIngCount" (len $uniqueIngSet)
  "missingRecipes" $missingRecipes
) -}}