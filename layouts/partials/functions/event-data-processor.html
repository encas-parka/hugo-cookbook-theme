{{- /*
  event-data-processor.html

  Partial centralisé pour traiter toutes les données d'un événement.
  Il parcourt les repas et les recettes UNE SEULE FOIS, et construit
  toutes les structures de données nécessaires pour les différents formats de sortie JSON.

  Input:
    - Contexte de la page (.)

  Output: (dict)
    - ingredient_totals: Map pour single.ingredients_aw.json
    - ingredient_occurrences: Map pour single.ingredients_aw.json
    - ingByTypeList: Slice pour single.ingredientsjson.json
    - datesRepas, datesTimeRepas, startDate, endDate
    - types: Slice des types d'ingrédients
    - recettesLength, nbDate, uniqueIngCount
    - missingRecipes
*/}}

{{- $pageContext := . -}}

{{- /* Index globaux */}}
{{- $recettesIndex := partialCached "functions/recettes-index.html" "recettes-index-global" -}}
{{- $byUUIDRecette := cond (and $recettesIndex (isset $recettesIndex "byUUIDRecette")) $recettesIndex.byUUIDRecette (dict) -}}
{{- $ingredientsIndex := partialCached "functions/ingredients-index.html" "ingredients-index" -}}
{{- $byUUIDIng := cond (and $ingredientsIndex (isset $ingredientsIndex "byUUID")) $ingredientsIndex.byUUID (dict) -}}

{{- /* --- Initialisation de TOUTES les structures de données --- */}}

{{- /* Pour ingredients_aw.json */}}
{{- $ingredient_totals := dict -}}
{{- $ingredient_occurrences := dict -}}

{{- /* Nouveaux: suivi des totaux par ingrédient */}}
{{- $totalAssiettesByIngredient := dict -}}
{{- $recipesByIngredient := dict -}}

{{- /* Pour recipe_occurrences.json */}}
{{- $recipe_occurrences_by_ingredient := dict -}}

{{- /* Pour ingredientsjson.json */}}
{{- $IngTypeListGrouped := dict -}}
{{- $typesSet := dict -}}
{{- $uniqueIngSet := dict -}}
{{- $datesRepas := slice -}}
{{- $datesTimeRepas := slice -}}
{{- $recettesLength := 0 -}}
{{- $nbDate := 0 -}}
{{- $missingRecipes := slice -}}

{{- /* Pour neededConsolidatedByDate - optimisation en deux phases */}}
{{- $ingredient_date_counts := dict -}}
{{- $multi_date_ingredients := dict -}}
{{- $ingredient_by_date := dict -}}

{{- /* --- PHASE 1: Comptage ultra-léger des occurrences par date --- */}}
{{- range $pageContext.Param "repas" -}}
  {{- $dateService := .date_service -}}
  {{- $dateTimeService := .date_service -}}
  {{- $horaire := .horaire -}}
  {{- $repasBaseAssiettes := (int .assiettes) -}}

  {{- /* Normalisation du datetime */}}
  {{- if not (findRE "T" $dateService) }}{{ $dateTimeService = printf "%sT12:00:00" $dateService }}{{ end -}}
  {{- if eq $horaire "matin" }}{{ $dateTimeService = $dateTimeService | replaceRE "T\\d{2}:\\d{2}:\\d{2}" "T08:00:00" }}
  {{- else if eq $horaire "midi" }}{{ $dateTimeService = $dateTimeService | replaceRE "T\\d{2}:\\d{2}:\\d{2}" "T12:00:00" }}
  {{- else if eq $horaire "soir" }}{{ $dateTimeService = $dateTimeService | replaceRE "T\\d{2}:\\d{2}:\\d{2}" "T20:00:00" }}{{ end -}}

  {{- range .recettes_du_repas -}}
    {{- $assiettesPourCalcul := $repasBaseAssiettes -}}
    {{- if .altAssiettes }}{{ $assiettesPourCalcul = (int .altAssiettes) }}{{ end -}}

    {{- $uuid := partialCached "functions/extract-uuid-from-slug.html" .recette .recette -}}
    {{- $recetteMeta := cond (and $uuid (ne $uuid "")) (index $byUUIDRecette $uuid) nil -}}

    {{- if $recetteMeta -}}
      {{- $ingredients := $recetteMeta.ingredients -}}

      {{- $builderContext := (dict
        "items" $ingredients
        "byUUID" $byUUIDIng
        "mode" "evenement"
        "assiettes" $assiettesPourCalcul
        "assiettesRecettes" $recetteMeta.plate
        "splitLegumes" true
      ) -}}
      {{- $groupedForRecette := (partial "functions/ingredients-group-builder" $builderContext).ingredients -}}

      {{- if and $groupedForRecette (reflect.IsMap $groupedForRecette) -}}
        {{- range $type, $list := $groupedForRecette -}}
          {{- if and $type (reflect.IsSlice $list) -}}
            {{- range $item := $list -}}
              {{- if and $item (reflect.IsMap $item) -}}
                {{- $name := $item.ingredient | default "" -}}
                {{- if ne $name "" -}}
                  {{- /* Comptage ultra-léger : juste une hashmap de hashmaps */}}
                  {{- if not (isset $ingredient_date_counts $name) -}}
                    {{- $ingredient_date_counts = merge $ingredient_date_counts (dict $name (dict)) -}}
                  {{- end -}}
                  {{- $dateCount := index $ingredient_date_counts $name -}}
                  {{- if not (isset $dateCount $dateTimeService) -}}
                    {{- $dateCount = merge $dateCount (dict $dateTimeService true) -}}
                    {{- $ingredient_date_counts = merge $ingredient_date_counts (dict $name $dateCount) -}}
                  {{- end -}}
                {{- end -}}
              {{- end -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* --- PHASE 1.5: Identifier les ingrédients qui nécessitent un traitement byDate complet --- */}}
{{- range $name, $dates := $ingredient_date_counts -}}
  {{- if gt (len $dates) 1 -}}
    {{- $multi_date_ingredients = merge $multi_date_ingredients (dict $name true) -}}
  {{- end -}}
{{- end -}}

{{- /* --- Boucle de traitement principal --- */}}
{{- range $pageContext.Param "repas" -}}
  {{- $dateService := .date_service -}}
  {{- $dateTimeService := .date_service -}}
  {{- $nbDate = add $nbDate 1 -}}
  {{- $horaire := .horaire -}}
  {{- $repasBaseAssiettes := (int .assiettes) -}}

  {{- /* Normalisation du datetime */}}
  {{- if not (findRE "T" $dateService) }}{{ $dateTimeService = printf "%sT12:00:00" $dateService }}{{ end -}}
  {{- if eq $horaire "matin" }}{{ $dateTimeService = $dateTimeService | replaceRE "T\\d{2}:\\d{2}:\\d{2}" "T08:00:00" }}
  {{- else if eq $horaire "midi" }}{{ $dateTimeService = $dateTimeService | replaceRE "T\\d{2}:\\d{2}:\\d{2}" "T12:00:00" }}
  {{- else if eq $horaire "soir" }}{{ $dateTimeService = $dateTimeService | replaceRE "T\\d{2}:\\d{2}:\\d{2}" "T20:00:00" }}{{ end -}}

  {{- $datesRepas = $datesRepas | append $dateService -}}
  {{- $datesTimeRepas = $datesTimeRepas | append $dateTimeService -}}

  {{- range .recettes_du_repas -}}
    {{- $recettesLength = add $recettesLength 1 -}}
    {{- $assiettesPourCalcul := $repasBaseAssiettes -}}
    {{- $typePlat := .type_plat -}}
    {{- if .altAssiettes }}{{ $assiettesPourCalcul = (int .altAssiettes) }}{{ end -}}

    {{- $uuid := partialCached "functions/extract-uuid-from-slug.html" .recette .recette -}}
    {{- $recetteMeta := cond (and $uuid (ne $uuid "")) (index $byUUIDRecette $uuid) nil -}}

    {{- if not $recetteMeta -}}
      {{- $missingInfo := dict "recetteSlug" .recette "dateService" $dateService "horaire" $horaire "reason" "Recette non trouvée" -}}
      {{- $missingRecipes = $missingRecipes | append $missingInfo -}}
    {{- else -}}
      {{- $recetteName := $recetteMeta.title -}}
      {{- $assiettesRecettes := $recetteMeta.plate -}}
      {{- $ingredients := $recetteMeta.ingredients -}}
      {{- $recetteID := $recetteMeta.File.UniqueID -}}

      {{- $builderContext := (dict
        "items" $ingredients
        "byUUID" $byUUIDIng
        "mode" "evenement"
        "assiettes" $assiettesPourCalcul
        "assiettesRecettes" $assiettesRecettes
        "splitLegumes" true
      ) -}}
      {{- $groupedForRecette := (partial "functions/ingredients-group-builder" $builderContext).ingredients -}}

      {{- if and $groupedForRecette (reflect.IsMap $groupedForRecette) -}}
        {{- range $type, $list := $groupedForRecette -}}
          {{- if and $type (reflect.IsSlice $list) -}}
            {{- $typesSet = merge $typesSet (dict $type true) -}}

            {{- /* --- Agrégation pour ingredientsjson.json --- */}}
            {{- $currentList := index $IngTypeListGrouped $type | default (slice) -}}
            {{- $enrichedList := slice -}}
            {{- range $item := $list -}}
              {{- if and $item (reflect.IsMap $item) -}}
                {{- if .uuid }}{{ $uniqueIngSet = merge $uniqueIngSet (dict .uuid true) }}{{ end -}}
                {{- $enrichedItem := merge $item (dict "recette" $recetteName "dateService" $dateService "dateTimeService" $dateTimeService "horaire" $horaire "typePlat" $typePlat "assiettesRecettes" $assiettesRecettes "assiettes" $assiettesPourCalcul) -}}
                {{- $enrichedList = $enrichedList | append $enrichedItem -}}
              {{- end -}}
            {{- end -}}
            {{- $IngTypeListGrouped = merge $IngTypeListGrouped (dict $type ($currentList | append $enrichedList)) -}}


            {{- /* --- Agrégation pour ingredients_aw.json --- */}}
            {{- range $item := $list -}}
              {{- if and $item (reflect.IsMap $item) -}}
                {{- $name := $item.ingredient | default "" -}}
                {{- $uuid_ing := $item.uuid | default "" -}}

                {{- if ne $name "" -}}
                  {{- /* Initialisation de la structure si nécessaire */}}
                  {{- if not (index $ingredient_totals $name) -}}
                    {{- $ingMeta := index $byUUIDIng $uuid_ing -}}
                    {{- $pFrais := cond $ingMeta $ingMeta.pFrais false -}}
                    {{- $pSurgel := cond $ingMeta $ingMeta.pSurgel false -}}
                    {{- $ingredient_totals = merge $ingredient_totals (dict $name (dict "uuid" $uuid_ing "name" $name "type" $item.iType "pFrais" $pFrais "pSurgel" $pSurgel "category_weight" 0.0 "category_volume" 0.0 "category_other" (dict) "consolidated_weight" 0.0 "consolidated_volume" 0.0 "consolidated_other" (dict) "has_conversion" false "conversion_rules" (slice))) -}}
                    {{- $ingredient_occurrences = merge $ingredient_occurrences (dict $name (slice)) -}}
                    {{- $totalAssiettesByIngredient = merge $totalAssiettesByIngredient (dict $name 0) -}}
                    {{- $recipesByIngredient = merge $recipesByIngredient (dict $name (dict)) -}}
                  {{- end -}}

                  {{- $current := index $ingredient_totals $name -}}
                  {{- $quantite := $item.quantite | default 0.0 -}}
                  {{- $unit := $item.unit | default "" -}}
                  {{- $quantiteEq := $item.quantiteEq | default $quantite -}}
                  {{- $unitEq := $item.unitEq | default $unit -}}
                  {{- $hasEquivalence := $item.hasConversion | default false -}}
                  {{- $conversionRule := $item.conversionRule | default "" -}}

                  {{- /* Traitement spécial pour les ingrédients sans quantité : quantité = 1, unit = "recette·s" */}}
                  {{- if or (eq $quantite 0.0) (eq $quantite nil) (eq $unit "") -}}
                    {{- $quantite = 1 -}}
                    {{- $unit = "recette·s" -}}
                    {{- $quantiteEq = 1 -}}
                    {{- $unitEq = "recette·s" -}}
                  {{- end -}}

                  {{- /* Ajout de l'occurrence */}}
                  {{- $occurrence := dict "recipe_name" $recetteName "recipe_id" $recetteID "dateTimeService" $dateTimeService "horaire" $horaire "typePlat" $typePlat "assiettes" $assiettesPourCalcul "quantite" $quantite "unit" $unit -}}
                  {{- $ingredient_occurrences = merge $ingredient_occurrences (dict $name ((index $ingredient_occurrences $name) | append $occurrence)) -}}

                  {{- /* Mise à jour des totaux par ingrédient */}}
                  {{- $totalAssiettesByIngredient = merge $totalAssiettesByIngredient (dict $name (add (index $totalAssiettesByIngredient $name) $assiettesPourCalcul)) -}}
                  {{- $ingredientRecipes := index $recipesByIngredient $name -}}
                  {{- $recipeKey := $recetteID | default $recetteName -}}
                  {{- $ingredientRecipes = merge $ingredientRecipes (dict $recipeKey true) -}}
                  {{- $recipesByIngredient = merge $recipesByIngredient (dict $name $ingredientRecipes) -}}

                  {{- /* Ajout de l'occurrence pour recipe_occurrences_by_ingredient */}}
                  {{- $ingredient_uuid := $uuid_ing -}}
                  {{- if not (isset $recipe_occurrences_by_ingredient $ingredient_uuid) -}}
                    {{- $recipe_occurrences_by_ingredient = merge $recipe_occurrences_by_ingredient (dict $ingredient_uuid (dict "ingredientUuid" $ingredient_uuid "ingredientName" $name "occurrences" (slice))) -}}
                  {{- end -}}
                  {{- $current_ingredient_occurrences := index $recipe_occurrences_by_ingredient $ingredient_uuid -}}
                  {{- $current_ingredient_occurrences = merge $current_ingredient_occurrences (dict "occurrences" ($current_ingredient_occurrences.occurrences | append $occurrence)) -}}
                  {{- $recipe_occurrences_by_ingredient = merge $recipe_occurrences_by_ingredient (dict $ingredient_uuid $current_ingredient_occurrences) -}}

                  {{- /* Optimisation: pré-calcul des conversions et regroupement des mises à jour */}}
                  {{- $unitLower := $unit | lower -}}
                  {{- $weightVal := 0.0 -}}
                  {{- $volumeVal := 0.0 -}}
                  {{- $isWeight := false -}}
                  {{- $isVolume := false -}}

                  {{- /* Calcul des valeurs brutes */}}
                  {{- if or (eq $unitLower "kg") (eq $unitLower "gr.") (eq $unitLower "g") -}}
                    {{- $weightVal = cond (eq $unitLower "kg") (mul $quantite 1000) $quantite -}}
                    {{- $isWeight = true -}}
                  {{- else if or (eq $unitLower "l.") (eq $unitLower "ml") -}}
                    {{- $volumeVal = cond (eq $unitLower "l.") (mul $quantite 1000) $quantite -}}
                    {{- $isVolume = true -}}
                  {{- end -}}

                  {{- /* Mise à jour groupée des consolidations brutes */}}
                  {{- $newCategoryWeight := $current.category_weight -}}
                  {{- $newCategoryVolume := $current.category_volume -}}
                  {{- $newCategoryOther := $current.category_other -}}
                  {{- $newConsolidatedWeight := $current.consolidated_weight -}}
                  {{- $newConsolidatedVolume := $current.consolidated_volume -}}
                  {{- $newConsolidatedOther := $current.consolidated_other -}}
                  {{- $newConversionRules := $current.conversion_rules -}}
                  {{- $hasEquivalenceNew := $current.has_equivalence -}}

                  {{- if $isWeight -}}
                    {{- $newCategoryWeight = add $newCategoryWeight $weightVal -}}
                  {{- else if $isVolume -}}
                    {{- $newCategoryVolume = add $newCategoryVolume $volumeVal -}}
                  {{- else -}}
                    {{- $newCategoryOther = merge $newCategoryOther (dict $unit (add (index $newCategoryOther $unit | default 0.0) $quantite)) -}}
                  {{- end -}}

                  {{- /* Consolidation complète (convertie) */}}
                  {{- if eq $unitEq "gr." -}}
                    {{- $newConsolidatedWeight = add $newConsolidatedWeight $quantiteEq -}}
                  {{- else if eq $unitEq "ml" -}}
                    {{- $newConsolidatedVolume = add $newConsolidatedVolume $quantiteEq -}}
                  {{- else -}}
                    {{- $newConsolidatedOther = merge $newConsolidatedOther (dict $unitEq (add (index $newConsolidatedOther $unitEq | default 0.0) $quantiteEq)) -}}
                  {{- end -}}

                  {{- /* Mise à jour des flags et règles de conversion */}}
                  {{- if $hasEquivalence -}}
                    {{- $hasEquivalenceNew = true -}}
                    {{- if and (ne $conversionRule "") (not (in $newConversionRules $conversionRule)) -}}
                      {{- $newConversionRules = $newConversionRules | append $conversionRule -}}
                    {{- end -}}
                  {{- end -}}

                  {{- /* Merge unique à la fin */}}
                  {{- $current = merge $current (dict
                    "category_weight" $newCategoryWeight
                    "category_volume" $newCategoryVolume
                    "category_other" $newCategoryOther
                    "consolidated_weight" $newConsolidatedWeight
                    "consolidated_volume" $newConsolidatedVolume
                    "consolidated_other" $newConsolidatedOther
                    "has_equivalence" $hasEquivalenceNew
                    "conversion_rules" $newConversionRules
                  ) -}}

                  {{- /* --- Calculs byDate pour TOUS les ingrédients --- */}}
                    {{- $dateKey := $dateTimeService -}}
                    {{- if not (isset $ingredient_by_date $dateKey) -}}
                      {{- $ingredient_by_date = merge $ingredient_by_date (dict $dateKey (dict)) -}}
                    {{- end -}}
                    {{- $dateData := index $ingredient_by_date $dateKey -}}

                    {{- if not (isset $dateData $name) -}}
                      {{- $dateData = merge $dateData (dict $name (dict "weight" 0.0 "volume" 0.0 "other" (dict) "recipeNames" (slice) "totalAssiettes" 0 "raw_weight" 0.0 "raw_volume" 0.0 "raw_other" (dict) "has_equivalence" false "conversion_rules" (slice))) -}}
                    {{- end -}}
                    {{- $ingByDate := index $dateData $name -}}

                    {{- /* Optimisation: mise à jour groupée en utilisant les valeurs déjà calculées */}}
                    {{- $newWeight := $ingByDate.weight -}}
                    {{- $newVolume := $ingByDate.volume -}}
                    {{- $newOther := $ingByDate.other -}}
                    {{- $newRawWeight := $ingByDate.raw_weight -}}
                    {{- $newRawVolume := $ingByDate.raw_volume -}}
                    {{- $newRawOther := $ingByDate.raw_other -}}
                    {{- $newRecipeNames := $ingByDate.recipeNames -}}
                    {{- $newTotalAssiettes := $ingByDate.totalAssiettes -}}
                    {{- $newHasEquivalence := $ingByDate.has_equivalence -}}
                    {{- $newConversionRules := $ingByDate.conversion_rules -}}

                    {{- /* Utiliser les valeurs déjà calculées */}}
                    {{- if $isWeight -}}
                      {{- $newRawWeight = add $newRawWeight $weightVal -}}
                      {{- if eq $unitEq "gr." -}}
                        {{- $newWeight = add $newWeight $quantiteEq -}}
                      {{- end -}}
                    {{- else if $isVolume -}}
                      {{- $newRawVolume = add $newRawVolume $volumeVal -}}
                      {{- if eq $unitEq "ml" -}}
                        {{- $newVolume = add $newVolume $quantiteEq -}}
                      {{- end -}}
                    {{- else -}}
                      {{- $newRawOther = merge $newRawOther (dict $unit (add (index $newRawOther $unit | default 0.0) $quantite)) -}}
                      {{- if not (eq $unitEq $unit) -}}
                        {{- $newOther = merge $newOther (dict $unitEq (add (index $newOther $unitEq | default 0.0) $quantiteEq)) -}}
                      {{- end -}}
                    {{- end -}}

                    {{- /* Mise à jour des flags et règles de conversion */}}
                    {{- if $hasEquivalence -}}
                      {{- $newHasEquivalence = true -}}
                      {{- if and (ne $conversionRule "") (not (in $newConversionRules $conversionRule)) -}}
                        {{- $newConversionRules = $newConversionRules | append $conversionRule -}}
                      {{- end -}}
                    {{- end -}}

                    {{- /* Ajout des recettes et assiettes */}}
                    {{- if not (in $newRecipeNames $recetteName) -}}
                      {{- $newRecipeNames = $newRecipeNames | append $recetteName -}}
                    {{- end -}}
                    {{- $newTotalAssiettes = add $newTotalAssiettes $assiettesPourCalcul -}}

                    {{- /* Merge unique pour toutes les mises à jour */}}
                    {{- $ingByDate = merge $ingByDate (dict
                      "weight" $newWeight
                      "volume" $newVolume
                      "other" $newOther
                      "raw_weight" $newRawWeight
                      "raw_volume" $newRawVolume
                      "raw_other" $newRawOther
                      "recipeNames" $newRecipeNames
                      "totalAssiettes" $newTotalAssiettes
                      "has_equivalence" $newHasEquivalence
                      "conversion_rules" $newConversionRules
                    ) -}}

                    {{- $dateData = merge $dateData (dict $name $ingByDate) -}}
                    {{- $ingredient_by_date = merge $ingredient_by_date (dict $dateKey $dateData) -}}

                  {{- $ingredient_totals = merge $ingredient_totals (dict $name $current) -}}
                {{- end -}}
              {{- end -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* --- Finalisation des données (tris, etc.) --- */}}
{{- $datesTimeRepas = sort $datesTimeRepas | uniq -}}
{{- $datesRepas = sort $datesRepas | uniq -}}
{{- $types := slice -}}
{{- range $key, $value := $typesSet -}}
  {{- $types = $types | append $key -}}
{{- end -}}
{{- $types = sort $types "value" "desc" -}}

{{- $ingByTypeList := slice -}}
{{- range $t := $types -}}
  {{- $items := sort (index $IngTypeListGrouped $t | default (slice)) "ingredient" "asc" -}}
  {{- $ingByTypeList = $ingByTypeList | append (dict "type" $t "items" $items) -}}
{{- end -}}

{{- /* --- Retourner le dictionnaire complet --- */}}
{{- return (dict
  "ingredient_totals" $ingredient_totals
  "ingredient_occurrences" $ingredient_occurrences
  "recipe_occurrences_by_ingredient" $recipe_occurrences_by_ingredient
  "totalAssiettesByIngredient" $totalAssiettesByIngredient
  "recipesByIngredient" $recipesByIngredient
  "ingByTypeList" $ingByTypeList
  "datesRepas" $datesRepas
  "datesTimeRepas" $datesTimeRepas
  "startDate" (cond (gt (len $datesRepas) 0) (index $datesRepas 0) "")
  "endDate" (cond (gt (len $datesRepas) 0) (index $datesRepas (sub (len $datesRepas) 1)) "")
  "types" $types
  "recettesLength" $recettesLength
  "nbDate" $nbDate
  "uniqueIngCount" (len $uniqueIngSet)
  "missingRecipes" $missingRecipes
  "ingredient_by_date" $ingredient_by_date
  "ingredient_date_counts" $ingredient_date_counts
  "multi_date_ingredients" $multi_date_ingredients
) -}}
