{{- /*
  single.ingredients_optimized.json
  Version optimisée qui compresse les données pour éviter la limite de 5000 caractères
  Principes :
  - Élimination neededConsolidatedByDate (reconstruit côté client)
  - Élimination totalNeededConsolidated (reconstruit côté client)
  - Compression de recipesOccurrences en format court "occ"
  - Réduction ~88% de taille par ingrédient
*/ -}}

{{- $eventData := partialCached "functions/event-data-processor.html" . .File.UniqueID -}}
{{- $ingredient_totals := $eventData.ingredient_totals -}}
{{- $totalAssiettesByIngredient := $eventData.totalAssiettesByIngredient -}}
{{- $totalRecipesByIngredient := $eventData.totalRecipesByIngredient -}}
{{- $recipesByIngredient := $eventData.recipesByIngredient -}}


{{- /* Générer une chaîne stable pour le hash basée UNIQUEMENT sur les données byDate */ -}}
{{- $hashInput := "" -}}
{{- $hashInput = printf "%s|%s" $hashInput (.Title | string) -}}
{{- $hashInput = printf "%s|%s" $hashInput ($eventData.allDates | jsonify) -}}

{{- /* Parcourir tous les ingrédients dans un ordre stable (trié) */ -}}
{{- range $name, $data := sort $ingredient_totals "name" -}}
  {{- $hashInput = printf "%s|%s|%s" $hashInput $data.uuid $data.name -}}

  {{- /* Inclure UNIQUEMENT les données par date (qui contiennent tout) */ -}}
  {{- $ingByDate := index $eventData.ingredient_by_date $data.name | default (dict) -}}
  {{- range $dateTime, $dateData := $ingByDate -}}
    {{- $hashInput = printf "%s|%s" $hashInput $dateTime -}}

    {{- /* totalConsolidated */ -}}
    {{- if gt $dateData.totalConsolidatedWeight 0 -}}
      {{- $hashInput = printf "%s|%.0f|gr." $hashInput $dateData.totalConsolidatedWeight -}}
    {{- end -}}
    {{- if gt $dateData.totalConsolidatedVolume 0 -}}
      {{- $hashInput = printf "%s|%.0f|ml" $hashInput $dateData.totalConsolidatedVolume -}}
    {{- end -}}
    {{- range $unit, $qty := $dateData.totalConsolidatedOther -}}
      {{- $hashInput = printf "%s|%.1f|%s" $hashInput $qty $unit -}}
    {{- end -}}

    {{- /* recipes (contient toutes les infos q, u, qEq, uEq, a) */ -}}
    {{- range $recipe := $dateData.recipes -}}
      {{- $hashInput = printf "%s|%s|%.1f|%s|%.1f|%s|%d" $hashInput $recipe.r $recipe.q $recipe.u $recipe.qEq $recipe.uEq $recipe.a -}}
    {{- end -}}

    {{- $hashInput = printf "%s|%d|%d" $hashInput $dateData.totalAssiettes $dateData.recipeCount -}}
  {{- end -}}
{{- end -}}

{{- /* Calculer le hash MD5 de la chaîne */ -}}
{{- $contentHash := md5 $hashInput -}}

{
  "mainGroup_id": "{{ .File.ContentBaseName | default .File.UniqueID }}",
  "hugoContentHash": {{ $contentHash | jsonify }},
  "name": {{ .Title | jsonify }},
  "allDates": {{ $eventData.allDates | jsonify }},
  "ingredients": [
    {{- $first := true -}}
    {{- range $name, $data := sort $ingredient_totals "name" -}}
      {{- if not $first }},{{ end }}{{- $first = false -}}
      {
        "ingredientHugoUuid": {{ $data.uuid | jsonify }},
        "ingredientName": {{ $data.name | jsonify }},
        "productSemanticKey": {{ printf "%s_%s" ($data.name | urlize | lower | replaceRE "%20" "-") $data.uuid | jsonify }},
        "ingType": {{ $data.type | jsonify }},
        "totalAssiettes": {{ (int (index $totalAssiettesByIngredient $data.name | default 0)) | jsonify }},
        "nbRecipes": {{ (int (index $totalRecipesByIngredient $data.name | default 0)) | jsonify }},
        {{- if $data.pFrais }}"pFrais": true,{{ end -}}
        {{- if $data.pSurgel }}"pSurgel": true,{{ end -}}
        {{- if and $data.has_equivalence (gt (len $data.conversion_rules) 0) }}
          "conversionRules": {{ $data.conversion_rules | jsonify }},
        {{- end -}}
        {{- if $data.has_equivalence  }}
        "totalNeededRaw": [
          {{- $firstCategory := true -}}
          {{- if gt $data.category_weight 0 -}}{{- if not $firstCategory }},{{ end }}{{- $firstCategory = false -}}{ "q": {{- printf "%.0f" $data.category_weight | float | jsonify -}}, "u": "gr." }{{- end -}}
          {{- if gt $data.category_volume 0 -}}{{- if not $firstCategory }},{{ end }}{{- $firstCategory = false -}}{ "q": {{- printf "%.0f" $data.category_volume | float | jsonify -}}, "u": "ml" }{{- end -}}
          {{- range $unit, $quantity := $data.category_other -}}{{- if not $firstCategory }},{{ end }}{{- $firstCategory = false -}}{ "q": {{- if eq $unit "recette·s" }}{{ printf "%.0f" $quantity | float | jsonify }}{{ else }}{{- printf "%.1f" $quantity | float | jsonify }}{{ end -}}, "u": {{ $unit | jsonify }} }{{- end -}}
        ],
        {{- end }}
        "byDate": {
          {{- $ingByDate := index $eventData.ingredient_by_date $data.name | default (dict) -}}
          {{- $firstDate := true -}}
          {{- range $dateTime, $dateData := $ingByDate -}}
            {{- if not $firstDate }},{{ end }}{{- $firstDate = false -}}
            {{ $dateTime | jsonify }}: {
          "totalConsolidated": [
            {{- $firstConsolidated := true -}}
            {{- if gt $dateData.totalConsolidatedWeight 0 -}}
              {{- if not $firstConsolidated }},{{ end }}{{- $firstConsolidated = false -}}
              {"q": {{ printf "%.0f" $dateData.totalConsolidatedWeight |  float | jsonify }}, "u": "gr."}
            {{- end -}}
            {{- if gt $dateData.totalConsolidatedVolume 0 -}}
              {{- if not $firstConsolidated }},{{ end }}{{- $firstConsolidated = false -}}
              {"q": {{ printf "%.0f" $dateData.totalConsolidatedVolume |  float | jsonify }}, "u": "ml"}
            {{- end -}}
            {{- range $unit, $qty := $dateData.totalConsolidatedOther -}}
              {{- if not $firstConsolidated }},{{ end }}{{- $firstConsolidated = false -}}
              {"q": {{ printf "%.1f" $qty |  float | jsonify }}, "u": {{ $unit | jsonify }}}
            {{- end -}}
          ],
          "recipes": [
            {{- $firstRecipe := true -}}
            {{- range $recipe := $dateData.recipes -}}
              {{- if not $firstRecipe }},{{ end }}{{- $firstRecipe = false -}}
              {
                "r": {{ $recipe.r | jsonify }},
                {{- $showQ := not (and (eq $recipe.q $recipe.qEq) (eq $recipe.u $recipe.uEq)) -}}
                {{- if $showQ }}
                "q": {{- if or (eq ($recipe.u | lower) "gr.") (eq ($recipe.u | lower) "ml") (eq ($recipe.u | lower) "recette·s") }}{{- math.Round $recipe.q  }}{{ else }}{{ printf "%.1f" $recipe.q  }}{{ end -}},
                "u": {{ $recipe.u | jsonify }},
                {{- end -}}
                "qEq": {{- if eq ($recipe.uEq | lower) "recette·s" }}{{ printf "%.0f" $recipe.qEq | float | jsonify }}{{ else if or (eq ($recipe.uEq | lower) "gr.") (eq ($recipe.uEq | lower) "ml") }}{{ printf "%.0f" $recipe.qEq | float | jsonify }}{{ else }}{{ printf "%.1f" $recipe.qEq | float | jsonify }}{{ end -}},
                "uEq": {{ $recipe.uEq | jsonify }},
                "a": {{ $recipe.a }}
              }
            {{- end -}}
          ],
          "totalAssiettes": {{ $dateData.totalAssiettes }},
          "recipeCount": {{ $dateData.recipeCount }}
        }
          {{- end -}}
        }
      }
    {{- end -}}
  ]
}
