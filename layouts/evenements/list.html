{{ define "main" }}
  <div class="container">
    <div class="row">
      <div class="col-lg-8 offset-lg-2">
        <h1 class="mb-4 text-center">{{ .Title }}</h1>

        {{/* Préparation des données pour la recherche d'événements */}}
        {{- $eventsData := slice -}}
        {{- range (where .Site.RegularPages "Section" "evenements")  -}}
            {{- $eventDate := "" -}}
            {{- if .Params.repas -}}
                {{- if reflect.IsSlice .Params.repas -}}
                    {{- if gt (len .Params.repas) 0 -}}
                        {{- $firstRepas := index .Params.repas 0 -}}
                        {{- if $firstRepas.date_service -}}
                            {{- $dateObj := time $firstRepas.date_service -}}
                            {{- $eventDate = $dateObj.Format "2006-01-02" -}}
                        {{- end -}}
                    {{- end -}}
                {{- end -}}
            {{- end -}}
            {{- $eventsData = $eventsData | append (dict
                "title" .Title
                "url" (printf "%smenus" .RelPermalink)
                "slug" .File.ContentBaseName
                "date" $eventDate
            ) -}}
        {{- end -}}
        {{- $eventsJSON := $eventsData | jsonify -}}



        <div id="app-search-events" data-events='{{ $eventsJSON }}'>
          <!-- Bouton créer un événement (visible seulement si authentifié) -->
          <div class="mb-3 text-end" v-show="isAuthenticated">
            <a href="/sveltia/#/collections/evenements/new" target="_blank" rel="noopener noreferrer" class="btn btn-primary">
              <i class="fas fa-plus me-1"></i>Créer un événement
            </a>
          </div>

          <div class="mb-3">
            <input
                type="text"
                v-model="searchEventsInput"
                @keydown.esc="closeSearch"
                @keydown.down.prevent="selectNext"
                @keydown.up.prevent="selectPrevious"
                @keydown.enter.prevent="navigateToSelected"
                placeholder="Rechercher un évenement..."
                class="form-control form-control-lg"
                id="qsearch-events"
                autofocus
                ref="searchEventsInput"
              />

            <small v-if="!isAuthenticated" class="form-text text-muted">Saisissez au moins 4 caractères pour lancer la recherche.</small>
          </div>

          <!-- Conteneur de résultats : s'affiche s'il y a des événements à montrer -->
          <div v-if="filteredEvents.length > 0"
               class="shadow-sm mt-3"
               ref="resultsContainer">
            <div v-for="(event, index) in filteredEvents"
               :key="event.url"
               :class="{ 'mb-2': true, 'bg-dark-subtle': index === selectedIndex }"
               class="rounded"
               @mouseover="selectedIndex = index"
               @mouseleave="selectedIndex = -1">
                <div class="d-flex justify-content-between align-items-center">
                    <a :href="event.url"
                       class="text-decoration-none text-dark flex-grow-1 p-2"
                       ref="resultLinks">
                        <span class="card-title fs-5">[[ event.title ]]</span>
                    </a>
                    <!-- Bouton modifier (visible seulement si authentifié) -->
                    <a v-if="isAuthenticated"
                       :href="'/sveltia/#/collections/evenements/entries/' + event.slug + '/index'"
                       target="_blank"
                       rel="noopener noreferrer"
                       class="btn btn-outline-primary btn-sm me-2"
                       title="Modifier l'événement"
                       @click.stop>
                        <i class="fas fa-edit"></i>
                    </a>
                </div>
            </div>
          </div>

          <!-- Message "aucun résultat" : s'affiche seulement après une recherche infructueuse -->
          <div v-if="searchEventsInput.length >= 4 && filteredEvents.length === 0" class="alert alert-info mt-3">
            Aucun événement trouvé correspondant à votre recherche.
          </div>
        </div>
      </div>
    </div>
  </div>
{{ $searchModuleScript := resources.Get "js/components/search-modules.js" | minify | fingerprint }}
{{ if $searchModuleScript }}
  <script src="{{ $searchModuleScript.RelPermalink }}"></script>

{{ else }}
  {{ warnf "Le script js/components/search-modules.js n'a pas été trouvé." }}
{{ end }}

{{ end }}
