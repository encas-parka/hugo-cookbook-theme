
{{ define "main" }}
<!--
  Layout de la listes fig√© des ingr√©dients d'un √©v√©nement
  - Template vuejs, li√© √† l'app asset/js/event/app_ingredients_list.js
  - Data recup√©r√© du JSON g√©n√©r√© par le layout hugo single.ingredientsjson.json

  - Permet d'acceder / de cr√©er un tableau collaboratif appwrite : createCollaborativeList (assets/js/appwrite-client.js)
  - Permet les export : `copyOrExport`
-->

<meta
  name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"
/>

<div id="app" data-json-src="index.json">

  <div class="no-print" id="TotalIngredients"></div>
  <div
    class=""
    :class="{'no-print':!toPrint.ingredients}"
    v-show="!isLoading"
  >
    <div class="fs-2 fw-bold no-print mt-4">{{ .Page.Title }}</div>
    <div class="fs-4 fw-bold no-print mb-5">
      Listes des [[uniqueIngCount]] ingr√©dients pr√©sents dans les
      [[recettesLength]] recettes des {{ .Params.repas | len }} menus
    </div>

    <!-- Alertes pour les recettes manquantes -->
    <div
      class="no-print mb-4"
      v-if="missingRecipes && missingRecipes.length > 0"
    >
      <div class="alert alert-warning">
        <p class="mb-2">
          Les recettes suivantes n'ont pas pu √™tre trouv√©es et ne sont pas
          incluses dans les calculs :
        </p>
        <ul class="mb-0">
          <li v-for="missing in missingRecipes" :key="missing.recetteSlug">
            <strong>[[missing.recetteSlug]]</strong>
            (Date: [[missing.dateService]], Horaire: [[missing.horaire]], Type:
            [[missing.typePlat]], Assiettes: [[missing.assiettes]])
            <span class="badge bg-warning text-dark ms-2"
              >[[missing.reason]]</span
            >
          </li>
        </ul>
      </div>
    </div>
    <div class="d-flex justify-content-center">
      {{/* ::: La sidebar offcanvas responsive ::: */}}
      <div class="col-xl-4 d-print-none  justify-content-center ">
        <div
          class="offcanvas-xl offcanvas-start sticky-xl-top p-xl-5 pt-xl-4 overflow-auto"

          tabindex="-1"
          id="sidebarOffcanvas"
          aria-labelledby="sidebarOffcanvasLabel"
        >
          <div class="offcanvas-header">
            <h5 class="mt-2 offcanvas-title" id="sidebarOffcanvasLabel">
              Filtres & Options
            </h5>
            <!-- Ce bouton de fermeture ne sera visible que sur les petits √©crans (quand c'est un offcanvas) -->
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="offcanvas"
              data-bs-target="#sidebarOffcanvas"
              aria-label="Close"
            ></button>
          </div>

          <div class="offcanvas-body mt-xl-5">
            <div class="mx-auto" style="max-width: 350px;">
              <div class="mb-6 w-100">
                <div class="d-xl-inline d-none pb-6">
                  <div class="input-group input-group-lg">
                    <span class="input-group-text" id="visible-addon">üîç</span>
                    <input
                      type="text"
                      v-model="searchInput"
                      class="form-control"
                      placeholder="Rechercher un ingr√©dient"
                    />
                  </div>
                </div>

                <div class="my-3" v-show="activeTab === 'normal'">
                  <span class="">üìÖ S√©lectionner une p√©riode</span>
                  <input
                    id="daterange"
                    class="flatpickr form-control d-none"
                    type="text"
                    readonly="readonly"
                    placeholder="S√©lectionner une p√©riode"
                    v-model="dateRangeSelected"
                  />
                </div>

                <div class="mb-4" v-show="activeTab === 'normal'">
                  <button
                    class="btn btn-primary btn-sm shadow-sm text-white"
                    @click="datesReset"
                    type="button"
                    id="btn-allDate"
                  >
                    Toutes les dates
                  </button>
                </div>

                <!-- Input pour les jours par range (onglet byRange seulement) -->
                <div v-show="activeTab === 'byRange'" class="my-4">
                  <label for="daysPerRangeInput" class="form-label">Jours par p√©riode :</label>
                  <div class="input-group">
                    <input
                      type="number"
                      v-model="daysPerRange"
                      class="form-control"
                      min="1"
                      max="9"
                      id="daysPerRangeInput"
                    />
                    <span class="input-group-text">jours</span>
                  </div>
                </div>
              </div>

              <div class="form-check form-switch mb-4">
                <input
                  class="form-check-input"
                  type="checkbox"
                  v-model="showAllColIngredients"
                  id="checkRecipeDetail"
                />
                <label for="checkRecipeDetail"
                  >Afficher les recettes pour chaque ingr√©dient</label
                >
              </div>
              <!-- DROPDOWN EXPORT/COPY -->
              <div class="dropdown mb-4">
                <button
                  class="btn btn-outline-primary dropdown-toggle w-100"
                  type="button"
                  id="exportMenuButton"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  {{ partialCached "components/icon-svg" (dict "name" "download"
                  "size" "1.1rem") "download-icon" "1.1rem" }} Exporter / Copier
                </button>
                <ul
                  class="dropdown-menu w-100"
                  aria-labelledby="exportMenuButton"
                >
                  <li>
                    <div class="dropdown-header fst-italic">
                      Copier dans le presse-papier
                    </div>
                  </li>
                  <li>
                    <button
                      class="dropdown-item"
                      type="button"
                      onclick="copyOrExport('text')"
                    >
                      Texte simple
                    </button>
                  </li>
                  <li><hr class="dropdown-divider" /></li>
                  <li>
                    <div class="dropdown-header fst-italic">T√©l√©charger le fichier</div>
                  </li>
                  <li>
                    <button
                      class="dropdown-item"
                      type="button"
                      onclick="copyOrExport('csv')"
                    >
                      CSV (pour tableur)
                    </button>
                  </li>
                  <li>
                    <button
                      class="dropdown-item"
                      type="button"
                      onclick="copyOrExport('md')"
                    >
                      Tableau Markdown
                    </button>
                  </li>
                </ul>
              </div>

              <!-- Bouton pour cr√©er une liste collaborative -->
              <div class="mb-4" v-if="isAuthenticated">
                <div v-if="existingListExists">
                  <button
                    class="btn btn-info w-100"
                    type="button"
                    id="viewExistingListBtn"
                    @click="viewExistingCollaborativeList"
                  >
                    {{ partialCached "components/icon-svg" (dict "name" "eye" "size" "1.1rem") "eye-icon" "1.1rem" }}
                    Voir la liste existante
                  </button>
                  <small class="form-text text-muted mt-1">
                    Une liste collaborative existe d√©j√† pour cet √©v√©nement
                  </small>
                </div>
                <div v-else>
                  <button
                    class="btn btn-success w-100 mb-2"
                    type="button"
                    id="createCollaborativeListBtn"
                    @click="createCollaborativeList"
                    :disabled="isCreatingList"
                  >
                    <span v-if="isCreatingList" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <i class="fas fa-plus me-2" style="font-size: 1.1rem;"></i>
                    <span v-if="!isCreatingList">Cr√©er une liste modifiable</span>
                    <span v-else>Cr√©ation en cours...</span>
                  </button>

                </div>
                <button
                  class="btn btn-primary w-100 mb-2"
                  type="button"
                  id="createCollaborativeProductsListBtn"
                  @click="createCollaborativeProductsList"
                  :disabled="isCreatingProductsList"
                  v-if="!existingMainGroupExists"
                >
                  <span v-if="isCreatingProductsList" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                  <i class="fas fa-box me-2" style="font-size: 1.1rem;"></i>
                  <span v-if="!isCreatingProductsList">Cr√©er une liste produits collaborative</span>
                  <span v-else>Cr√©ation en cours...</span>
                </button>
                <button
                  class="btn btn-info w-100 mb-2"
                  type="button"
                  id="viewExistingProductsListBtn"
                  @click="viewExistingProductsList"
                  v-else
                >
                  <i class="fas fa-box me-2" style="font-size: 1.1rem;"></i>
                  Voir la liste produits existante
                </button>
                <small class="form-text text-muted mt-1">
                  Transformez cette liste en tableau collaboratif pour g√©rer vos achats en √©quipe
                </small>
              </div>

              <!-- Liens de navigation -->
              <div>
                <template v-if="activeTab === 'byRange'" v-for="rangeLink in computedRangeLinksForNavigation">
                  <a :href="'#' + rangeLink.id" class="btn btn-sm btn-outline-primary mx-1 mb-1"> [[ rangeLink.label ]] </a>
                </template>

                <template v-if="activeTab === 'normal'" v-for="type in computedTypesForNavigation">
                  <a :href="'#IngListID' + type" class="btn btn-sm btn-outline-primary mx-1 mb-1">
                    [[ formatTypeShort(type) ]]
                  </a>
                </template>
              </div>
            </div>
          </div>
        </div>
      </div>

      {{/* ::: Total INGREDIENTS - Contenu principal ::: */}}
      <div class="col-xl-8 print-col-12 col-12">

        <!-- Syst√®me d'onglets -->
        <div class="no-print mb-4">
          <ul class="nav nav-tabs" id="ingredientsTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                :class="{'active': activeTab === 'normal'}"
                @click="switchToTab('normal')"
                id="normal-tab"
                type="button"
                role="tab"
                aria-controls="normal"
                :aria-selected="activeTab === 'normal'"
              >
                Tous les ingr√©dients
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                :class="{'active': activeTab === 'byRange'}"
                @click="switchToTab('byRange')"
                id="byRange-tab"
                type="button"
                role="tab"
                aria-controls="byRange"
                :aria-selected="activeTab === 'byRange'"
              >
                Produits frais par p√©riodes
              </button>
            </li>
          </ul>
        </div>

        <div class="d-xl-none d-flex d-print-none no-print">
          <div class="input-group input-group-lg mb-3">
            <span class="input-group-text">üîç</span>
            <input
              type="text"
              v-model="searchInput"
              class="form-control"
              placeholder="Rechercher un ingr√©dient"
            />
          </div>
        </div>


        <!-- Contenu de l'onglet byRange -->
        <div v-if="activeTab === 'byRange'" class="tab-pane fade show active" id="byRange" role="tabpanel" aria-labelledby="byRange-tab">
          {{/* :::_FraisByDayRange */}}
          <div v-if="rangesDates.length > 0">
          <!-- L√©gumes frais -->
          <div class="avoid-break-inside">
            <template v-for="(range, index) in rangesDates" :key="range[0]">
              <div
                v-if="totalRange('legumesFrais', range[0], range[range.length - 1]).length > 0"
                class="card my-2 mb-lg-6 border-danger border-1 mb-3 print-nocard"
                :class="{'no-print':!toPrint.ingredients}"
                :id="`legumesFraisByRange-${new Date(range[0]).getDate()}${new Date(range[range.length - 1]).getDate()}`"
              >
                <div class="card-body">
                  <div class="no-print">
                    <span class="fs-5 toCopy"
                      >Fruits et L√©gumes frais du
                      <strong>
                        [[ new Date(range[0]).toLocaleDateString("fr-FR",
                        {weekday: 'short', month: 'short', day: 'numeric'})
                        ]]</strong
                      >
                      au
                      <strong
                        >[[ new Date(range[range.length -
                        1]).toLocaleDateString("fr-FR", {weekday: 'short',
                        month: 'short', day: 'numeric'}) ]]</strong
                      ></span
                    >
                    <div class="my-2 float-end no-print">
                      <a
                        class="btn btn-outline-secondary btn-sm text-muted"
                        role="button"
                        @click="printThis('ingredients', 'ingredients')"
                        >{{ partialCached "components/icon-svg" (dict "name"
                        "printer" "size" "1.5rem") "printer" "1.5rem" }}</a
                      >
                    </div>
                  </div>

                  <table
                    class="table table-responsive toCopy caption-top mb-4"
                    :class="{'table-striped': !showAllColIngredients, 'table-bordered' : showAllColIngredients}"
                  >
                    <caption
                      class="fs-5 text-center text-color-black printonly"
                    >
                      Fruits L√©gumes frais du
                      <strong>
                        [[ new Date(range[0]).toLocaleDateString("fr-FR",
                        {weekday: 'short', month: 'short', day: 'numeric'})
                        ]]</strong
                      >
                      au
                      <strong
                        >[[ new Date(range[range.length -
                        1]).toLocaleDateString("fr-FR", {weekday: 'short',
                        month: 'short', day: 'numeric'}) ]]</strong
                      >
                    </caption>
                    <thead>
                      <tr>
                        <th>Ingr√©dients - l√©gumes frais</th>
                        <th class="text-center">Recettes</th>
                        <th class="text-end">Total</th>
                        <th class="no-print text-end" v-show="!showAllColIngredients">
                          D√©tail
                        </th>
                        <th
                          class="printonly"
                          v-show="printAddCol === '1' || printAddCol === '2'"
                        ></th>
                        <th class="printonly" v-show="printAddCol === '2'"></th>
                      </tr>
                    </thead>
                    <tbody>
                      <template
                        v-for="item in totalRange('legumesFrais', range[0], range[range.length - 1])"
                        :key="item.ingredient"
                      >
                        <tr :class="{'table-secondary': showAllColIngredients}">
                          <td class="toCopyTd">[[item.ingredient]]</td>
                          <td class="small">
                            [[item.totalAssiettes]] c. - [[item.totalRecettes]]
                            recettes
                          </td>
                          <td class="text-end toCopyTd">
                            <!-- Total "Standardis√©" -->
                            <div v-if="getCachedStandardizedIngredientForRange(item.ingredient, 'legumesFrais', range[0], range[range.length - 1])"
                                :class="{'fw-semibold': showAllColIngredients}">
                              <template v-for="(quantiteEntry, qIndex) in getCachedStandardizedIngredientForRange(item.ingredient, 'legumesFrais', range[0], range[range.length - 1]).qTotalX">
                                [[round2Decimals(quantiteEntry.qTotal, quantiteEntry.unit)]]
                                [[quantiteEntry.unit]]
                                <span v-if="qIndex < getCachedStandardizedIngredientForRange(item.ingredient, 'legumesFrais', range[0], range[range.length - 1]).qTotalX.length - 1" class="mx-1">+</span>
                              </template>
                            </div>
                            <!-- Total "Transparent" -->
                            <div v-if="doesTransparentTotalDivergeForRange(item.ingredient, 'legumesFrais', range[0], range[range.length - 1])" class="small text-muted fst-italic">
                              (
                              <template v-for="(quantiteEntry, qIndex) in item.qTotalXOriginal">
                                <span v-if="quantiteEntry.qTotal !== null && quantiteEntry.unitTotal !== null">
                                  [[round2Decimals(quantiteEntry.qTotal, quantiteEntry.unitTotal)]]
                                  [[quantiteEntry.unitTotal]]
                                  <span v-if="qIndex < item.qTotalXOriginal.length - 1" class="mx-1">+</span>
                                </span>
                              </template>
                              )
                            </div>
                          </td>
                          <td class="no-print text-end" v-show="!showAllColIngredients">
                            <button
                              type="button"
                              class="btn btn-sm btn-outline-primary"
                              @click="openIngredientModalRange(item.ingredient, 'legumesFrais', range[0], range[range.length - 1])"
                              data-bs-toggle="modal"
                              data-bs-target="#ingredientDetailModal"
                            >
                              d√©tail
                            </button>
                          </td>
                          <td
                            v-show="printAddCol === '1' || printAddCol === '2'"
                            class="printonly print-td-15"
                          ></td>
                          <td
                            v-show="printAddCol === '2'"
                            class="printonly print-td-15"
                          ></td>
                        </tr>
                        <!-- D√©tails individuels -->
                        <template v-if="showAllColIngredients">
                          <tr
                            v-for="detail in getIngredientIndividualDetails(item.ingredient, 'legumesFrais', range[0], range[range.length - 1])"
                            :key="detail.recette + detail.dateService"
                            class="small text-muted"
                          >
                            <td>&nbsp;&nbsp;&nbsp;&nbsp;[[detail.recette]]</td>
                            <td>
                              le [[new
                              Date(detail.dateService).toLocaleDateString("fr-FR",
                              {weekday: 'short', month: 'short', day:
                              'numeric'})]] / [[detail.horaire]] <br />
                              pour [[detail.assiettes]] couverts
                            </td>
                            <td class="text-end">
                             [[formatDetailQuantity(detail)]]
                            </td>
                            <td
                              v-show="printAddCol === '1' || printAddCol === '2'"
                              class="printonly print-td-15"
                            ></td>
                            <td
                              v-show="printAddCol === '2'"
                              class="printonly print-td-15"
                            ></td>
                          </tr>
                        </template>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>
            </template>
          </div>

          <!-- Autres produits frais -->
          <div class="avoid-break-inside">
            <template v-for="(range, index) in rangesDates" :key="range[0]">
              <div
                v-if="totalRange('frais', range[0], (range[range.length - 1])).length > 0"
                class="card my-2 mb-lg-6 border-danger border-1 mb-3 print-nocard"
                :class="{'no-print':!toPrint.ingredients}"
                :id="`fraisByRange-${new Date(range[0]).getDate()}${new Date(range[range.length - 1]).getDate()}`"
              >
                <div class="card-body">
                  <div class="no-print">
                    <span class="fs-5 toCopy"
                      >Autres produits frais du
                      <strong>
                        [[ new Date(range[0]).toLocaleDateString("fr-FR",
                        {weekday: 'short', month: 'short', day: 'numeric'})
                        ]]</strong
                      >
                      au
                      <strong
                        >[[ new Date(range[range.length -
                        1]).toLocaleDateString("fr-FR", {weekday: 'short',
                        month: 'short', day: 'numeric'}) ]]</strong
                      ></span
                    >
                    <div class="my-2 float-end no-print">
                      <a
                        class="btn btn-outline-secondary btn-sm text-muted"
                        role="button"
                        @click="printThis('ingredients', 'ingredients')"
                        >{{ partialCached "components/icon-svg" (dict "name"
                        "printer" "size" "1.5rem") "printer" "1.5rem" }}</a
                      >
                    </div>
                  </div>

                  <table
                    class="table table-responsive toCopy caption-top mb-4"
                    :class="{'table-striped': !showAllColIngredients, 'table-bordered' : showAllColIngredients}"
                  >
                    <caption
                      class="fs-5 text-center text-color-black printonly"
                    >
                      Autres produits frais du
                      <strong>
                        [[ new Date(range[0]).toLocaleDateString("fr-FR",
                        {weekday: 'short', month: 'short', day: 'numeric'})
                        ]]</strong
                      >
                      au
                      <strong
                        >[[ new Date(range[range.length -
                        1]).toLocaleDateString("fr-FR", {weekday: 'short',
                        month: 'short', day: 'numeric'}) ]]</strong
                      >
                    </caption>
                    <thead>
                      <tr>
                        <th>Ingr√©dients - p. frais</th>
                        <th class="text-center">Recettes</th>
                        <th class="text-end">Total</th>
                        <th class="no-print" v-show="!showAllColIngredients">
                          D√©tail
                        </th>
                        <th
                          class="printonly"
                          v-show="printAddCol === '1' || printAddCol === '2'"
                        ></th>
                        <th class="printonly" v-show="printAddCol === '2'"></th>
                      </tr>
                    </thead>
                    <tbody>
                      <template
                        v-for="item in totalRange('frais', range[0], range[range.length - 1])"
                        :key="item.ingredient"
                      >
                        <tr :class="{'table-secondary': showAllColIngredients}">
                          <td class="toCopyTd">[[item.ingredient]]</td>
                          <td class="small">
                            [[item.totalAssiettes]] c. - [[item.totalRecettes]]
                            recettes
                          </td>
                          <td class="text-end toCopyTd">
                            <!-- Total "Standardis√©" -->
                            <div v-if="getCachedStandardizedIngredientForRange(item.ingredient, 'frais', range[0], range[range.length - 1])"
                                :class="{'fw-semibold': showAllColIngredients}">
                              <template v-for="(quantiteEntry, qIndex) in getCachedStandardizedIngredientForRange(item.ingredient, 'frais', range[0], range[range.length - 1]).qTotalX">
                                [[round2Decimals(quantiteEntry.qTotal, quantiteEntry.unit)]]
                                [[quantiteEntry.unit]]
                                <span v-if="qIndex < getCachedStandardizedIngredientForRange(item.ingredient, 'frais', range[0], range[range.length - 1]).qTotalX.length - 1" class="mx-1">+</span>
                              </template>
                            </div>
                            <!-- Total "Transparent" -->
                            <div v-if="doesTransparentTotalDivergeForRange(item.ingredient, 'frais', range[0], range[range.length - 1])" class="small text-muted fst-italic">
                              (
                              <template v-for="(quantiteEntry, qIndex) in item.qTotalXOriginal">
                                <span v-if="quantiteEntry.qTotal !== null && quantiteEntry.unitTotal !== null">
                                  [[round2Decimals(quantiteEntry.qTotal, quantiteEntry.unitTotal)]]
                                  [[quantiteEntry.unitTotal]]
                                  <span v-if="qIndex < item.qTotalXOriginal.length - 1" class="mx-1">+</span>
                                </span>
                              </template>
                              )
                            </div>
                          </td>
                          <td class="no-print" v-show="!showAllColIngredients">
                            <button
                              type="button"
                              class="btn btn-sm btn-outline-primary"
                              @click="openIngredientModalRange(item.ingredient, 'frais', range[0], range[range.length - 1])"
                              data-bs-toggle="modal"
                              data-bs-target="#ingredientDetailModal"
                            >
                              d√©tail
                            </button>
                          </td>
                          <td
                            v-show="printAddCol === '1' || printAddCol === '2'"
                            class="printonly print-td-15"
                          ></td>
                          <td
                            v-show="printAddCol === '2'"
                            class="printonly print-td-15"
                          ></td>
                        </tr>
                        <!-- D√©tails individuels -->
                        <template v-if="showAllColIngredients">
                          <tr
                            v-for="detail in getIngredientIndividualDetails(item.ingredient, 'frais', range[0], range[range.length - 1])"
                            :key="detail.recette + detail.dateService"
                            class="small text-muted"
                          >
                            <td>&nbsp;&nbsp;&nbsp;&nbsp;[[detail.recette]]</td>
                            <td>
                              le [[new
                              Date(detail.dateService).toLocaleDateString("fr-FR",
                              {weekday: 'short', month: 'short', day:
                              'numeric'})]] / [[detail.horaire]] <br />
                              pour [[detail.assiettes]] couverts
                            </td>
                            <td class="text-end">
                             [[formatDetailQuantity(detail)]]
                            </td>
                            <td
                              v-show="printAddCol === '1' || printAddCol === '2'"
                              class="printonly print-td-15"
                            ></td>
                            <td
                              v-show="printAddCol === '2'"
                              class="printonly print-td-15"
                            ></td>
                          </tr>
                        </template>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>
            </template>
          </div>

          <!-- Viandes et poissons -->
          <div class="avoid-break-inside">
            <template v-for="(range, index) in rangesDates" :key="range[0]">
              <div
                v-if="totalRange('animaux', range[0], (range[range.length - 1])).length > 0"
                class="card my-2 mb-lg-6 border-danger border-1 mb-3 print-nocard"
                :class="{'no-print':!toPrint.ingredients}"
                :id="`animauxByRange-${new Date(range[0]).getDate()}${new Date(range[range.length - 1]).getDate()}`"
              >
                <div class="card-body">
                  <div class="no-print">
                    <span class="fs-5 toCopy"
                      >Viandes/Poissons du
                      <strong>
                        [[ new Date(range[0]).toLocaleDateString("fr-FR",
                        {weekday: 'short', month: 'short', day: 'numeric'})
                        ]]</strong
                      >
                      au
                      <strong
                        >[[ new Date(range[range.length -
                        1]).toLocaleDateString("fr-FR", {weekday: 'short',
                        month: 'short', day: 'numeric'}) ]]</strong
                      ></span
                    >
                    <div class="my-2 float-end no-print">
                      <a
                        class="btn btn-outline-secondary btn-sm text-muted"
                        role="button"
                        @click="printThis('ingredients', 'ingredients')"
                        >{{ partialCached "components/icon-svg" (dict "name"
                        "printer" "size" "1.5rem") "printer" "1.5rem" }}</a
                      >
                    </div>
                  </div>

                  <table
                    class="table table-responsive toCopy caption-top mb-4"
                    :class="{'table-striped': !showAllColIngredients, 'table-bordered' : showAllColIngredients}"
                  >
                    <caption
                      class="fs-5 text-center text-color-black printonly"
                    >
                      Viandes/Poissons du
                      <strong>
                        [[ new Date(range[0]).toLocaleDateString("fr-FR",
                        {weekday: 'short', month: 'short', day: 'numeric'})
                        ]]</strong
                      >
                      au
                      <strong
                        >[[ new Date(range[range.length -
                        1]).toLocaleDateString("fr-FR", {weekday: 'short',
                        month: 'short', day: 'numeric'}) ]]</strong
                      >
                    </caption>
                    <thead>
                      <tr>
                        <th>Ingr√©dients - viandes/poissons</th>
                        <th class="text-center">Recettes</th>
                        <th class="text-end">Total</th>
                        <th class="no-print" v-show="!showAllColIngredients">
                          D√©tail
                        </th>
                        <th
                          class="printonly"
                          v-show="printAddCol === '1' || printAddCol === '2'"
                        ></th>
                        <th class="printonly" v-show="printAddCol === '2'"></th>
                      </tr>
                    </thead>
                    <tbody>
                      <template
                        v-for="item in totalRange('animaux', range[0], range[range.length - 1])"
                        :key="item.ingredient"
                      >
                        <tr :class="{'table-secondary': showAllColIngredients}">
                          <td class="toCopyTd">[[item.ingredient]]</td>
                          <td class="small">
                            [[item.totalAssiettes]] c. - [[item.totalRecettes]]
                            recettes
                          </td>
                          <td class="text-end toCopyTd">
                            <!-- Total "Standardis√©" -->
                            <div v-if="getCachedStandardizedIngredientForRange(item.ingredient, 'animaux', range[0], range[range.length - 1])"
                                :class="{'fw-semibold': showAllColIngredients}">
                              <template v-for="(quantiteEntry, qIndex) in getCachedStandardizedIngredientForRange(item.ingredient, 'animaux', range[0], range[range.length - 1]).qTotalX">
                                [[round2Decimals(quantiteEntry.qTotal, quantiteEntry.unit)]]
                                [[quantiteEntry.unit]]
                                <span v-if="qIndex < getCachedStandardizedIngredientForRange(item.ingredient, 'animaux', range[0], range[range.length - 1]).qTotalX.length - 1" class="mx-1">+</span>
                              </template>
                            </div>
                            <!-- Total "Transparent" -->
                            <div v-if="doesTransparentTotalDivergeForRange(item.ingredient, 'animaux', range[0], range[range.length - 1])" class="small text-muted fst-italic">
                              (
                              <template v-for="(quantiteEntry, qIndex) in item.qTotalXOriginal">
                                <span v-if="quantiteEntry.qTotal !== null && quantiteEntry.unitTotal !== null">
                                  [[round2Decimals(quantiteEntry.qTotal, quantiteEntry.unitTotal)]]
                                  [[quantiteEntry.unitTotal]]
                                  <span v-if="qIndex < item.qTotalXOriginal.length - 1" class="mx-1">+</span>
                                </span>
                              </template>
                              )
                            </div>
                          </td>
                          <td class="no-print" v-show="!showAllColIngredients">
                            <button
                              type="button"
                              class="btn btn-sm btn-outline-primary"
                              @click="openIngredientModalRange(item.ingredient, 'animaux', range[0], range[range.length - 1])"
                              data-bs-toggle="modal"
                              data-bs-target="#ingredientDetailModal"
                            >
                              d√©tail
                            </button>
                          </td>
                          <td
                            v-show="printAddCol === '1' || printAddCol === '2'"
                            class="printonly print-td-15"
                          ></td>
                          <td
                            v-show="printAddCol === '2'"
                            class="printonly print-td-15"
                          ></td>
                        </tr>
                        <!-- D√©tails individuels -->
                        <template v-if="showAllColIngredients">
                          <tr
                            v-for="detail in getIngredientIndividualDetails(item.ingredient, 'animaux', range[0], range[range.length - 1])"
                            :key="detail.recette + detail.dateService"
                            class="small text-muted"
                          >
                            <td>&nbsp;&nbsp;&nbsp;&nbsp;[[detail.recette]]</td>
                            <td>
                              le [[new
                              Date(detail.dateService).toLocaleDateString("fr-FR",
                              {weekday: 'short', month: 'short', day:
                              'numeric'})]] / [[detail.horaire]] <br />
                              pour [[detail.assiettes]] couverts
                            </td>
                            <td class="text-end">
                             [[formatDetailQuantity(detail)]]
                            </td>
                            <td
                              v-show="printAddCol === '1' || printAddCol === '2'"
                              class="printonly print-td-15"
                            ></td>
                            <td
                              v-show="printAddCol === '2'"
                              class="printonly print-td-15"
                            ></td>
                          </tr>
                        </template>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>
            </template>
          </div>
          </div>
        </div>

        <!-- Contenu de l'onglet normal -->
        <div v-if="activeTab === 'normal'" class="tab-pane fade show active" id="normal" role="tabpanel" aria-labelledby="normal-tab">
          <div id="tableIng" class="p-1" v-cloak>
          {{- $types := slice "sucres" "sec" "lof" "legumesFrais"
          "legumesNonFrais" "frais" "epices" "autres" "animaux" "absent" -}} {{-
          range $types -}} {{- $iTypeName := partial
          "functions/ingredients-types-rename-short" (dict "ingType" (. |
          strings.FirstUpper)) -}}

          {{/* ::: _ Card des tableau ingredients petit et grand, range par type */}}
          <div
            v-show="totalQuantitesDP['{{ . }}'] && Object.keys(totalQuantitesDP['{{ . }}']).length > 0"
            class="card my-lg-2 mb-lg-6 mb-3 print-nocard"
            :class="{'no-print':!toPrint.{{ . }} }"
            id="IngListID{{ . }}"
          >
            <div class="card-body">
              <div class="no-print">
                <span class="float-start me-2"
                  >{{ partial "components/icon-svg" (dict "name" . "size"
                  "2rem") }}</span
                >
                <span class="fs-4 toCopy"> {{ $iTypeName }} </span>
                <div class="my-2 float-end no-print">
                  <a
                    class="btn btn-outline-secondary btn-sm text-muted"
                    role="button"
                    @click="printThis('{{ . }}', 'ingredients')"
                    >{{ partial "components/icon-svg" (dict "name" "printer"
                    "size" "1.7rem") }}</a
                  >
                </div>
              </div>
              <div
                v-show="startDate !== startDateSelected || endDate !== endDateSelected"
                class="fs-5 p-2 text-center fw-semibold toCopyDate no-print"
              >
                Du [[new Date (startDateSelected).toLocaleDateString("fr-FR",
                {weekday: 'long', month: 'long', day: 'numeric'})]] au [[new
                Date (endDateSelected).toLocaleDateString("fr-FR", {weekday:
                'long', month: 'long', day: 'numeric'})]]
              </div>
              {{/* ::: __Table ingr√©dients */}}
              <table
                class="table table-responsive toCopy caption-top"
                :class="{'table-striped': !showAllColIngredients, 'table-bordered' : showAllColIngredients}"
                id="table-{{ . }}"
              >
                <caption class="fs-5 printonly">
                  {{ $iTypeName }} du [[new Date
                  (startDateSelected).toLocaleDateString("fr-FR", {weekday:
                  'long', month: 'long', day: 'numeric'})]] au [[new Date
                  (endDateSelected).toLocaleDateString("fr-FR", {weekday:
                  'long', month: 'long', day: 'numeric'})]]
                </caption>
                <thead>
                  <tr>
                    <th>Ingredients</th>
                    <th>Recettes</th>
                    <th class="text-end">Total</th>
                    <th class="no-print text-end" v-show="!showAllColIngredients">
                      D√©tail
                    </th>
                    <th
                      class="printonly"
                      v-show="printAddCol === '1' || printAddCol ===  '2' "
                    ></th>
                    <th class="printonly" v-show="printAddCol === '2' "></th>
                  </tr>
                </thead>
                <tbody>
                  <template
                    v-for="(item, ingredient) in totalQuantitesDP['{{ . }}']"
                    :key="item.ingredient"
                  >
                    <tr
                      v-if="item.qTotalX && item.qTotalX.length > 0"
                      :class="{'table-secondary': showAllColIngredients}"
                    >
                      <td class="toCopyTd">[[item.ingredient]]</td>
                      <td class="small">
                        [[item.totalAssiettes]] c. - [[item.totalRecettes]]
                        recettes
                      </td>



                        <td class="text-end toCopyTd">

                          <!-- Total "Standardis√©" -->

                          <div v-if="totalQuantitesStandardDP['{{ . }}'] && totalQuantitesStandardDP['{{ . }}'][ingredient]"

                              :class="{'fw-semibold': showAllColIngredients}">
                            <template v-for="(quantiteEntry, qIndex) in totalQuantitesStandardDP['{{ . }}'][ingredient].qTotalX">
                              [[round2Decimals(quantiteEntry.qTotal, quantiteEntry.unit)]]
                              [[quantiteEntry.unit]]
                              <span v-if="qIndex < totalQuantitesStandardDP['{{ . }}'][ingredient].qTotalX.length - 1" class="mx-1">+</span>
                            </template>
                          </div>
                          <!-- Total "Transparent" -->
                          <div v-if="doesTransparentTotalDiverge(item)" class="small text-muted fst-italic">
                                (
                            <template v-for="(quantiteEntry, qIndex) in item.qTotalXOriginal" >
                              <span v-if="quantiteEntry.qTotal !== null && quantiteEntry.unitTotal !== null"
                                >
                                [[round2Decimals(quantiteEntry.qTotal, quantiteEntry.unitTotal)]]
                                [[quantiteEntry.unitTotal]]
                              <span v-if="qIndex < item.qTotalXOriginal.length - 1" class="mx-1">+</span>
                              </span>
                            </template>
                              )
                          </div>
                        </td>


                      <td class="no-print text-end" v-show="!showAllColIngredients">
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-primary"
                          @click="openIngredientModal(item.ingredient, '{{ . }}')"
                          data-bs-toggle="modal"
                          data-bs-target="#ingredientDetailModal"
                        >
                          <span class="d-md-none">+</span>
                          <span class="d-md-block d-none">d√©tail</span>
                        </button>
                      </td>

                      <td
                        v-show="printAddCol === '1' || printAddCol ===  '2' "
                        class="printonly print-td-15"
                      ></td>
                      <td
                        v-show=" printAddCol ===  '2' || printAddCol ===  '3' "
                        class="printonly print-td-15"
                      ></td>
                    </tr>
                    <!--  BLOC pour les d√©tails individuels -->
                    <template v-if="showAllColIngredients">
                      <tr
                        v-for="detail in getIngredientIndividualDetails(item.ingredient, '{{ . }}')"
                        :key="detail.recette + detail.dateService"
                        class="small text-muted"
                      >
                        <td>&nbsp;&nbsp;&nbsp;&nbsp;[[detail.recette]]</td>
                        <td>
                          le [[new
                          Date(detail.dateService).toLocaleDateString("fr-FR",
                          {weekday: 'short', month: 'short', day: 'numeric'})]]
                          / [[detail.horaire]] <br />
                          pour [[detail.assiettes]] couverts
                        </td>
                        <td class="text-end">
                         [[formatDetailQuantity(detail)]]
                        </td>
                        <td
                          v-show="printAddCol === '1' || printAddCol ===  '2' "
                          class="printonly print-td-15"
                        ></td>
                        <td
                          v-show=" printAddCol ===  '2' || printAddCol ===  '3' "
                          class="printonly print-td-15"
                        ></td>
                      </tr>
                    </template>
                  </template>
                </tbody>
              </table>
            </div>
          </div>
          {{ end }}
          </div>
        </div>
      </div>
    </div>


    {{/*- :::  Impression - MODAL -*/}}
   <div
     class="modal modal-xl fade d-print-none"
     tabindex="-1"
     id="modalImpression"
     aria-labelledby="modalImpressionLabel"
     aria-hidden="true"
   >
     <div class="modal-dialog modal-dialog-scrollable">
       <div class="modal-content">
         <div class="modal-header">
           <h5 class="modal-title mt-0" id="modalImpressionLabel">
             Imprimer / exporter en PDF
           </h5>
           <button
             type="button"
             class="btn-close"
             data-bs-dismiss="modal"
             aria-label="Close"
           ></button>
         </div>
         <div class="modal-body">
           <div class="row">
             <div class="col-md-6">
               <div class="form-check">
                 <input
                   class="form-check-input"
                   type="checkbox"
                   v-model="toPrint.ingredients"
                   :value="true"
                   name="cb-ing"
                   id="cb-printIngredient"
                 />
                 <label class="form-check-label" for="cb-printIngredient"
                   >Imprimer les listes des ingr√©dients</label
                 >
               </div>

               <div v-show="toPrint.ingredients" class="ms-4">
                 <div class="form-check form-switch my-2">
                   <input
                     class="form-check-input"
                     type="checkbox"
                     v-model="showAllColIngredients"
                     id="checkRecipeDetail"
                   />
                   <label for="checkRecipeDetail"
                     >Afficher les recettes pour chaque ingr√©dient</label
                   >
                 </div>
                 <div class="input-group">
                   <span class="input-group-text" id="addColSelect"
                     >+ colonnes :
                   </span>
                   <select
                     v-model="printAddCol"
                     class="form-select"
                     aria-describedby="addColSelect"
                     aria-label="Ajouter des colonnes"
                   >
                     <option value="0">0</option>
                     <option value="1">1</option>
                     <option value="2">2</option>
                   </select>
                 </div>
                 <div class="text-muted fs-7 text-end">
                   Ajouter des colonnes aux tableaux afin de pouvoir rajouter des
                   informations manuscrites
                 </div>
               </div>
               {{/*
               <div class="form-check">
                 <input
                   class="form-check-input"
                   type="checkbox"
                   v-model="toPrint.affichesSection"
                   :value="false"
                   name="cb-affiche"
                   id="cb-printAffiches"
                 />
                 <label class="form-check-label" for="cb-printAffiches"
                   >Imprimer les Affiches (imprimez √† part, sinon bug)</label
                 >
               </div>
               */}}
             </div>
             <div class="col-md-6">
               <div class="callout small">
                 <p>
                   Pour exporter en PDF, dans les options d'impression,
                   s√©lectionnez : destination > "enregistrer au format Pdf" comme
                   imprimante. Pensez aussi √† personnaliser les marges
                   d'impression ou l'√©chelle afin de redimensionner le contenu
                   selon ce qui vous convient.
                 </p>
                 <p class="fw-bolder">
                   ‚ö† L'impression des listes d'ingredients pr√©sente
                   r√©guli√®rement des bug avec Firefox (superposition des listes).
                   Si c'est le cas, utilisez un navigateur bas√© sur chrome (par
                   exemple, "brave"), ou imprimer les listes une √† une grace aux
                   boutons d√©di√©s.
                 </p>
               </div>
             </div>
           </div>

           <hr />
           <div class="text-end">
             <a
               class="btn btn-primary"
               @click="print"
               role="button"
               data-bs-dismiss="modal"
               >Imprimer !</a
             >
           </div>
         </div>
       </div>
     </div>
   </div>
    <!-- Modal pour les d√©tails d'ingr√©dients -->
    <div
      class="modal fade"
      id="ingredientDetailModal"
      tabindex="-1"
      aria-labelledby="ingredientDetailModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <div
              class="modal-title fs-5 fw-semibold"
              id="ingredientDetailModalLabel"
            >
              D√©tail : [[selectedIngredient]]
              <!-- afficher range des dates prise en comptes -->
              <span v-if="modalDateStart && modalDateEnd" class="text-muted">
                <br /><small
                  >P√©riode : [[ formatDateRange(modalDateStart, modalDateEnd)
                  ]]</small
                >
              </span>
            </div>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Recette</th>
                  <th>Date / Horaire / Couverts</th>
                  <th class="text-end">Quantit√©</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  v-for="detail in ingredientDetails"
                  :key="detail.recette + detail.dateService"
                >
                  <td class="fw-medium lh-1">[[detail.recette]]</td>
                  <td>
                    [[new Date(detail.dateService).toLocaleDateString("fr-FR",
                    {weekday: 'short', month: 'short', day: 'numeric'})]] -
                    [[detail.horaire]] /
                    <span class="fw-medium text-nowrap">
                      [[detail.assiettes]] c.
                    </span>
                  </td>
                  <td class="text-end">
                   [[formatDetailQuantity(detail)]]
                  </td>
                </tr>
              </tbody>
              <tfoot v-if="ingredientTotalQuantityStandard && ingredientTotalQuantityStandard.length > 0">
                <tr class="table-secondary">
                  <td colspan="1"><strong>Total</strong></td>
                  <td colspan="2" class="text-end">
                    <!-- Total Standardis√© -->
                    <div v-if="ingredientTotalQuantityStandard && ingredientTotalQuantityStandard.length > 0">
                      <template v-for="(total, index) in ingredientTotalQuantityStandard">
                        <strong>[[round2Decimals(total.qTotal, total.unit)]] [[total.unit]]</strong>
                        <span v-if="index < ingredientTotalQuantityStandard.length - 1" class="mx-1">+</span>
                      </template>
                    </div>

                    <!-- Total Transparent (conditionnel) -->
                    <div v-if="doesTransparentTotalDiverge(ingredientDetails)"
                         class="small text-muted fst-italic">
                      (
                      <template v-for="(total, index) in ingredientTotalQuantityTransparent">
                        [[total.qTotal]] [[total.unit]]
                        <span v-if="index < ingredientTotalQuantityTransparent.length - 1" class="mx-1">+</span>
                      </template>
                      )
                    </div>
                  </td>

                </tr>
              </tfoot>
            </table>
            <div v-if="ingredientConversionRules && ingredientConversionRules.length > 0" class="mt-3 small text-muted border-top pt-2">
                      <p class="mb-1 fw-semibold">√âquivalence(s) utilis√©e(s) pour le calcul :</p>
                      <ul class="list-unstyled mb-0">
                        <li v-for="rule in ingredientConversionRules" :key="rule">
                          - [[ rule ]]
                        </li>
                      </ul>
                    </div>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Fermer
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <a href="#" class="scroll-to-top" title="Scroll to top"></a>
</div>

<!-- bouton pour ouvrir l'offcanvas sur les petits √©crans -->
  <button
    class="no-print d-xl-none fab-openCanvas"
    type="button"
    data-bs-toggle="offcanvas"
    data-bs-target="#sidebarOffcanvas"
    aria-controls="sidebarOffcanvas"
  >
  </button>

{{ partialCached "components/print-button.html" . "print-btn " }}


<!-- pour le hash permettant de v√©rifi√© si la liste d'ingredients a √©t√© modifi√© dans le cms. Permet la comparaison avec les donn√©e appwrite. Utile ici ou bien ? -->
{{- $eventData := partialCached "functions/event-data-processor.html" . .File.UniqueID -}}
{{- $contentHash := $eventData | jsonify | md5 -}}
<script>
    window.__HUGO_PARAMS__ = window.__HUGO_PARAMS__ || {};
    window.__HUGO_PARAMS__.listContentHash = {{ $contentHash | jsonify | safeJS }};
</script>

{{ $fp := resources.Get "flatpickr/flatpickr.min.js" | fingerprint }} {{ $fp_fr :=
resources.Get "flatpickr/l10n/fr.js" | fingerprint }}

<script
  src="{{ $fp.RelPermalink }}"
  integrity="{{ $fp.Data.Integrity }}"
></script>
<script
  src="{{ $fp_fr.RelPermalink }}"
  integrity="{{ $fp_fr.Data.Integrity }}"
></script>

{{ $eventJS := resources.Get "js/event/bootstrap.js" | js.Build (dict
"targetPath" "assets-bundled/event-utils.js" "minify" true) | fingerprint }}
<script
  src="{{ $eventJS.RelPermalink }}"
  integrity="{{ $eventJS.Data.Integrity }}"
  defer
></script>
<script>
  flatpickr.localize(flatpickr.l10ns.fr);
</script>
{{ end }}
