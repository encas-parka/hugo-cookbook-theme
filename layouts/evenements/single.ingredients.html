

{{ define "main" }}

  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"
  />



{{/*  lien vers le CMS de la page  */}}
{{/*  FIXIT : lien vers url slug uuid  */}}
{{- $linkCMSPage := (path.Join "/admin/#/collections/evenement/entries/" (.Title | urlize)) -}}
{{/*  FIXIT : Recheck pour généraliser theme  */}}
{{- $enkaDevCms := "" -}}
{{ if eq .Site.BaseURL "enka-cookbook.pages.dev"}}
{{$enkaDevCms = "https://enka-cookbook.netlify.app/"}}
{{ end }}
  {{/*  <span class="text-end no-print p-2"><a target="_blank" rel="noopener noreferrer" href="{{- $enkaDevCms -}}{{- $linkCMSPage -}}/index">Modifier</a></span>  */}}

  <div id="app" data-json-src="index.json">

{{ $here := "ingredients"}}

{{/* ::: navbar page */}}
{{/* Nettoyage du permalink pour retirer la partie output format */}}
{{ $basePermalink := .RelPermalink | replaceRE "/(ingredients|poster)/?.*$" "" }}
{{ $basePermalink = $basePermalink | replaceRE "/$" "" }}

{{ $inglink := printf "%s/ingredients" $basePermalink }}
{{ $recettelink := printf "%s" $basePermalink }}
{{ $posterlink := printf "%s/poster" $basePermalink }}
  {{ if eq $here "ingredients" }}
    {{ $inglink = "#"}}
  {{ else if eq $here "recettes" }}
    {{ $recettelink = "#"}}
  {{ else if eq $here "poster" }}
    {{ $posterlink = "#"}}
  {{ end }}


{{ partial  "components/event-top-nav" ( dict "inglink" $inglink "recettelink" $recettelink "posterlink" $posterlink "here" $here) }}

{{/*  ::: Impression - MODAL  */}}
<div class="modal modal-xl fade d-print-none" tabindex="-1" id="modalImpression" aria-labelledby="modalImpressionLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable ">
    <div class=" modal-content">
      <div class="modal-header">
        <h5 class="modal-title mt-0" id="modalImpressionLabel">Imprimer / exporter en PDF</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <div class="row">
          <div class="col-md-6">

            <div class="form-check">
              <input class="form-check-input" type="checkbox" v-model="toPrint.ingredients" :value="true" name="cb-ing"
                id="cb-printIngredient">
              <label class="form-check-label" for="cb-printIngredient">Imprimer les listes des ingrédients</label>
            </div>


                <div v-show="toPrint.ingredients" class="ms-4">
                  <div class="form-check form-switch my-2">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      v-model="showAllColIngredients"
                      id="checkRecipeDetail"
                    />
                    <label for="checkRecipeDetail"
                      >Afficher les recettes pour chaque ingrédient</label
                    >
                  </div>
                  <div class="input-group">
                    <span class="input-group-text" id="addColSelect"
                      >+ colonnes :
                    </span>
                    <select
                      v-model="printAddCol"
                      class="form-select"
                      aria-describedby="addColSelect"
                      aria-label="Ajouter des colonnes"
                    >
                      <option value="0">0</option>
                      <option value="1">1</option>
                      <option value="2">2</option>
                    </select>
                  </div>
                  <div class="text-muted fs-7 text-end">
                    Ajouter des colonnes aux tableaux afin de pouvoir rajouter
                    des informations manuscrites
                  </div>
                </div>
                {{/* <div class="form-check">
                  <input class="form-check-input" type="checkbox" v-model="toPrint.affichesSection" :value="false" name="cb-affiche"
                  id="cb-printAffiches">
                  <label class="form-check-label" for="cb-printAffiches">Imprimer les Affiches (imprimez à part, sinon bug)</label>
                  </div>
                */}}
              </div>
              <div class="col-md-6">
                <div class="callout small">
                  <p>
                    Pour exporter en PDF, dans les options d'impression,
                    sélectionnez : destination > "enregistrer au format Pdf"
                    comme imprimante. Pensez aussi à personnaliser les marges
                    d'impression ou l'échelle afin de redimensionner le contenu
                    selon ce qui vous convient.
                  </p>
                  <p class="fw-bolder">
                    ⚠ L'impression des listes d'ingredients présente
                    régulièrement des bug avec Firefox (superposition des
                    listes). Si c'est le cas, utilisez un navigateur basé sur
                    chrome (par exemple, "brave"), ou imprimer les listes une à
                    une grace aux boutons dédiés.
                  </p>
                </div>
              </div>
            </div>

            <hr />
            <div class="text-end">
              <a
                class="btn btn-primary"
                @click="print"
                role="button"
                data-bs-dismiss="modal"
                >Imprimer !</a
              >
            </div>
          </div>
        </div>
      </div>
    </div>


    <a href="#" class="scroll-to-top" title="Scroll to top"></a>

    <div class="no-print" id="TotalIngredients"></div>
    <div class="container-fluid " :class="{'no-print':!toPrint.ingredients}">
      <h3 class="no-print">
        Listes des [[uniqueIngCount]] ingrédients présents dans les
         [[recettesLength]] recettes des {{ .Params.repas | len }} menus
      </h3>

      <!-- Alertes pour les recettes manquantes -->
      <div class="no-print mb-4" v-if="missingRecipes && missingRecipes.length > 0">
        <div class="alert alert-warning">
          <p class="mb-2">Les recettes suivantes n'ont pas pu être trouvées et ne sont pas incluses dans les calculs :</p>
          <ul class="mb-0">
            <li v-for="missing in missingRecipes" :key="missing.recetteSlug">
              <strong>[[missing.recetteSlug]]</strong>
              (Date: [[missing.dateService]], Horaire: [[missing.horaire]], Type: [[missing.typePlat]], Assiettes: [[missing.assiettes]])
              <span class="badge bg-warning text-dark ms-2">[[missing.reason]]</span>
            </li>
          </ul>
        </div>
      </div>
      <div class="row justify-content-evenly">
        {{/* ::: _Sidebar Total ingredients */}}
        <nav
          class="flex-column col-md-4 col-lg-3 d-md-block bg-light  mt-7 d-print-none "
        >
          <div
            class="sticky-top overflow-y-auto"
            style="top: 70px; height: 612px"
          >
            <div class="my-5 small">
              <div class="mb-3">
                <label class="mb-2"
                  >Selectionner la période que vous souhaitez prendre en
                  compte</label
                >
                <div class="mb-3">
                  <input
                    id="datepickerStart"
                    class="flatpickr flatpickr-input form-control"
                    type="text"
                    readonly="readonly"
                    placeholder="Date de début"
                    v-model="startDateSelected"
                  />
                </div>
                <div class="mb-3">
                  <input
                    id="datepickerEnd"
                    class="flatpickr flatpickr-input form-control"
                    type="text"
                    readonly="readonly"
                    placeholder="Date de fin"
                    v-model="endDateSelected"
                  />
                </div>
                <div class="mb-3 text-end">
                  <button
                    class="btn btn-primary btn-sm shadow-sm text-white"
                    @click="datesReset"
                    type="button"
                    id="btn-allDate"
                  >
                    Toutes les dates
                  </button>
                </div>
              </div>
              <hr />
              <div class="mb-3">
                Afficher les quantités des produits frais par périodes
              </div>
              <div class="mb-1 form-check form-switch">
                <input
                  type="checkbox"
                  class="form-check-input"
                  v-model="legumesByRanges"
                  name="cb-legumesByRanges"
                  id="cb-legumesByRanges"
                />
                <label for="cb-legumesByRanges"
                  >... fruits et legumes frais
                </label>
              </div>
              <div class="mb-1 form-check form-switch">
                <input
                  type="checkbox"
                  class="form-check-input"
                  v-model="fraisByRanges"
                  name="cb-fraisByRanges"
                  id="cb-fraisByRanges"
                />
                <label for="cb-fraisByRanges">... autres produit frais</label>
              </div>
              <div class="mb-1 form-check form-switch">
                <input
                  type="checkbox"
                  class="form-check-input"
                  v-model="animauxByRanges"
                  name="cb-animauxByRanges"
                  id="cb-animauxByRanges"
                />
                <label for="cb-animauxByRanges">... viandes et poissons </label>
              </div>
              <div class="input-group mb-3">
                <input
                  type="number"
                  v-model="daysPerRange"
                  class="form-control"
                  min="1"
                  max="9"
                  :disabled="!animauxByRanges && !fraisByRanges && !legumesByRanges "
                />
                <span class="input-group-text" id="basic-addon2">jours</span>
              </div>

              <hr />
              <div class="form-check form-switch mb-3">
                <input
                  class="form-check-input"
                  type="checkbox"
                  v-model="showAllColIngredients"
                  id="checkRecipeDetail"
                />
                <label for="checkRecipeDetail"
                  >Afficher les recettes pour chaque ingrédient</label
                >
              </div>
              <hr />

              <template v-for="type in types">
                <a :href="'#IngListID' + type"> [[ type ]] - </a>
              </template>
            </div>
          </div>
        </nav>

        {{/* ::: Total INGREDIENTS */}}
        <div class="col  print-col-12 ms-md-3">
          <span
            class="btn-group no-print my-2 me-2"
            role="group"
            aria-label="Exporter / Copier"
          >
            <button class="btn btn-outline-secondary" disabled>
              Copier les tableaux dans le presse-papier :
            </button>
            <button
              type="button"
              class="btn btn-outline-primary"
              onclick="copyOrExport('text')"
            >
              Texte simple
            </button>
            {{/* <button type="button" class="btn btn-outline-primary" onclick="copyOrExport('html')">html</button> */}}
            {{/* TODO : modal explicatif */}}
          </span>

          <span
            class="btn-group no-print my-2"
            role="group"
            aria-label="Exporter CSV"
          >
            <button class="btn btn-outline-secondary" disabled>
              Télécharger :
            </button>
            <button
              type="button"
              class="btn btn-outline-primary"
              onclick="copyOrExport('csv')"
            >
              csv (tableur)
            </button>
            <button
              type="button"
              class="btn btn-outline-primary"
              onclick="copyOrExport('md')"
            >
              Tableau Markdown
            </button>
          </span>

          <div
            class="border rounded border-transparent bg-dark container-fluid p-2 no-print"
            style="--bs-bg-opacity: .3;"
          >
            <input
              type="text"
              v-model="searchInput"
              class="form-control"
              placeholder="Rechercher un ingrédient"
            />
          </div>

          {{/* :::_FraisByDayRange */}}
          {{ $fraisByRanges := slice | append  (dict "idR" "LegumesRanges" "titleR" "Fruits Legumes Frais" "iType" "Legumesfrais" "thisRange" "legumesByRanges") (dict "idR" "AnimauxRanges" "titleR" "Viandes/Poissons Frais" "iType" "Animaux" "thisRange" "animauxByRanges") (dict "idR" "FraisRanges" "titleR" "Autres produits Frais" "iType" "Frais" "thisRange" "fraisByRanges") }}

          {{ range $fraisByRanges }}
            {{ $indexTable := 1 }}
            <div id="{{ .idR }}" class="avoid-break-inside">
              <template v-for="(range, index) in rangesDates">
                {{/* ::: ___table Frais */}}


                <div
                  v-show="{{ .thisRange }} && totalRangeWithDetail('{{ .iType }}', range[0], range[range.length - 1]).size > 0"
                  class="card my-2 mb-lg-6 border-danger border-1 mb-3  print-nocard"
                  :class="{'no-print':!toPrint.{{ .idR }} }"
                  :id="range[0]"
                >
                  <div class="card-body">
                    <div class="no-print">
                      <span class="fs-5 toCopy">
                        {{ .titleR }} du [[ range[0] ]] au [[range[range.length
                        - 1] ]]
                      </span>
                      <div class="my-2 float-end no-print">
                        <a
                          class="btn btn-outline-secondary btn-sm text-muted "
                          role="button"
                          @click="printThis('{{ .idR }}', 'ingredients')"
                          >{{ partialCached "components/icon-svg" (dict "name" "printer" "size" "1.5rem") "printer" "1.5rem" }}</a
                        >
                      </div>
                    </div>

                    <table
                      id="tableFrais"
                      class="table table-responsive toCopy caption-top mb-4"
                      :class="{'table-striped': !showAllColIngredients, 'table-bordered' : showAllColIngredients}"
                    >
                      <caption
                        class="fs-5 text-center text-color-black printonly"
                      >
                        {{ .titleR }} du [[ range[0] ]] au [[range[range.length
                        - 1] ]]
                      </caption>
                      <thead>
                        <tr>
                          <th>Ingredients {{ .iType }}</th>
                          <th class="text-center">Recettes</th>
                          <th class="text-end">Total</th>
                          <th class="no-print" v-show="!showAllColIngredients">Détail</th>
                          <th
                            class="printonly"
                            v-show="printAddCol === '1' || printAddCol ===  '2' "
                          ></th>
                          <th
                            class="printonly"
                            v-show="printAddCol === '2' "
                          ></th>
                        </tr>
                      </thead>

                      <tbody>
                        <template
                          v-for="item in totalRangeWithDetail('{{ .iType }}', range[0], range[range.length - 1])"
                        >
                          <tr
                            v-show="showAllColIngredients && !item.qTotal"
                            :class="{'table-secondary fw-bold': item.qTotal}"
                          >
                            <td :class="{'small text-muted': !item.qTotal}">
                              [[item.ingredient]]
                            </td>
                            <td v-if="item.recette" class="small">
                              <span class="fw-bold">[[item.recette]]</span> le
                              [[new Date
                              (item.dateService).toISOString().substr(0, 10)]] /
                              [[item.horaire]] <br />
                              pour [[item.assiettes]] couverts
                              <span class="float-end">
                                <span
                                  class="fw-bold "
                                  v-if="item.quantiteOrig && item.unitOrig"
                                  >[[round2Decimals(item.quantiteOrig)]]
                                  [[item.unitOrig]] ~=
                                </span>
                                <span
                                  class="fw-bold"
                                  v-if="item.quantite && item.unit"
                                  >[[round2Decimals(item.quantite)]]
                                  [[item.unit]]</span
                                >
                              </span>
                            </td>
                          </tr>

                          <tr
                            v-if="item.qTotal"
                            :class="{'table-secondary': showAllColIngredients}"
                          >
                            <td class="toCopyTd">[[item.ingredient]]</td>
                            <td class="small">[[item.totalAssiettes]] c.</td>
                            <td class="text-end toCopyTd">
                              <span>[[item.qTotal]] [[item.unitTotal]]</span>
                            </td>
                            <td class="no-print" v-show="!showAllColIngredients">
                              <button
                                type="button"
                                class="btn btn-sm btn-outline-primary"
                                @click="openIngredientModalRange(item.ingredient, '{{ .iType }}', range[0], range[range.length - 1])"
                                data-bs-toggle="modal"
                                data-bs-target="#ingredientDetailModal">
                                détail
                              </button>
                            </td>
                            <td
                              v-show="printAddCol === '1' || printAddCol ===  '2' "
                              class="printonly print-td-15"
                            ></td>
                            <td
                              v-show=" printAddCol ===  '2' || printAddCol ===  '3' "
                              class="printonly print-td-15"
                            ></td>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </div>
                </div>
              </template>
            </div>
          {{ end }}


          {{/* Renommage des iType */}}
          <div id="tableIng" v-cloak>
            {{- $types := slice "sucres" "sec" "lof" "legumes" "frais" "epices" "autres" "animaux" "absent" -}}
            {{- range $types -}}
              {{- $iTypeName := partial "functions/ingredients-types-rename-short" (dict "ingType" (. | strings.FirstUpper)) -}}
              {{/* ::: _ Card des tableau ingredients petit et grand */}}
              <div
                v-show="totalQuantitesDP['{{ . }}'] && Object.keys(totalQuantitesDP['{{ . }}']).length > 0"
                class="card my-2 mb-lg-6  mb-3 print-nocard"
                :class="{'no-print':!toPrint.{{ . }} }"
                id="IngListID{{ . }}"
              >
                <div class="card-body">
                  <div class="no-print">
                    <span class="float-start me-2"
                      >{{ partial "components/icon-svg" (dict "name" . "size" "2rem") }}</span
                    >
                    <span class="fs-4 toCopy"> {{ $iTypeName }} </span>
                    <div class="my-2 float-end no-print">
                      <a
                        class="btn btn-outline-secondary btn-sm text-muted "
                        role="button"
                        @click="printThis('{{ . }}', 'ingredients')"
                        >{{ partial "components/icon-svg" (dict "name" "printer" "size" "1.7rem") }}</a
                      >
                    </div>
                  </div>
                  <div
                    v-show="startDate !== startDateSelected || endDate !== endDateSelected"
                    class="fs-5 p-2 text-center fw-semibold toCopyDate no-print"
                  >
                    Du [[new Date
                    (startDateSelected).toLocaleDateString("fr-FR", {weekday:
                    'long', month: 'long', day: 'numeric'})]] au [[new Date
                    (endDateSelected).toLocaleDateString("fr-FR", {weekday:
                    'long', month: 'long', day: 'numeric'})]]
                  </div>
                  {{/* ::: __Table ingrédients */}}
                  <table
                    class="table table-responsive toCopy caption-top"
                    :class="{'table-striped': !showAllColIngredients, 'table-bordered' : showAllColIngredients}"
                    id="table-{{ . }}"
                  >
                    <caption class="fs-5 printonly">
                      {{ $iTypeName }} du [[new Date
                      (startDateSelected).toLocaleDateString("fr-FR", {weekday:
                      'long', month: 'long', day: 'numeric'})]] au [[new Date
                      (endDateSelected).toLocaleDateString("fr-FR", {weekday:
                      'long', month: 'long', day: 'numeric'})]]
                    </caption>
                    <thead>
                      <tr>
                        <th>Ingredients</th>
                        <th>Recettes</th>
                        <th class="text-end">Total</th>
                        <th class="no-print" v-show="!showAllColIngredients">Détail</th>
                        <th
                          class="printonly"
                          v-show="printAddCol === '1' || printAddCol ===  '2' "
                        ></th>
                        <th
                          class="printonly"
                          v-show="printAddCol === '2' "
                        ></th>
                      </tr>
                    </thead>
                    <tbody>
                      <template
                        v-for="(item, ingredient) in totalQuantitesDP['{{ . }}']"
                      >
                        <tr v-show="showAllColIngredients && !item.qTotalX">
                          <td :class="{'small text-muted': !item.qTotalX}">
                            [[item.ingredient]]
                          </td>
                          <td v-if="item.recette " class="small">
                            <span class="fw-bold">[[item.recette]]</span> le
                            [[new Date
                            (item.dateService).toISOString().substr(0, 10)]] /
                            [[item.horaire]] <br />
                            pour [[item.assiettes]] couverts
                            <span class="float-end">
                              <span
                                class="fw-bold "
                                v-if="item.quantiteOrig && item.unitOrig"
                                >[[round2Decimals(item.quantiteOrig)]]
                                [[item.unitOrig]] ~=
                              </span>
                              <span
                                class="fw-bold"
                                v-if="item.quantite && item.unit"
                                >[[round2Decimals(item.quantite)]]
                                [[item.unit]]</span
                              >
                            </span>
                          </td>
                        </tr>

                        <tr
                          v-if="item.qTotalX"
                          :class="{'table-secondary': showAllColIngredients}"
                        >
                          <td class="toCopyTd">[[item.ingredient]]</td>
                          <td class="small">
                            [[item.totalAssiettes]] c. - [[item.totalRecettes]]
                            recettes
                          </td>

                          <td class="text-end toCopyTd">
                            <template v-for="(quantite, index) in item.qTotalX">
                              <span v-if="quantite.unit !== ''">
                                [[round2Decimals(quantite.qTotal)]]
                                [[quantite.unit]]
                              </span>

                              <span v-else class="small"> non précisé </span>
                              <span
                                v-if="index < item.qTotalX.length - 1"
                                class="mx-1"
                                >+</span
                              >
                            </template>
                          </td>

                          <td class="no-print" v-show="!showAllColIngredients">
                            <button
                              type="button"
                              class="btn btn-sm btn-outline-primary"
                              @click="openIngredientModal(item.ingredient, '{{ . }}')"
                              data-bs-toggle="modal"
                              data-bs-target="#ingredientDetailModal">
                              détail
                            </button>
                          </td>

                          <td
                            v-show="printAddCol === '1' || printAddCol ===  '2' "
                            class="printonly print-td-15"
                          ></td>
                          <td
                            v-show=" printAddCol ===  '2' || printAddCol ===  '3' "
                            class="printonly print-td-15"
                          ></td>
                        </tr>
                      </template>
                    </tbody>
                  </table>
                </div>
              </div>
            {{ end }}
          </div>
        </div>
      </div>
    </div>
  <!-- Modal pour les détails d'ingrédients -->
  <div class="modal fade" id="ingredientDetailModal" tabindex="-1" aria-labelledby="ingredientDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title fs-5 fw-semibold" id="ingredientDetailModalLabel">Détail : [[selectedIngredient]]
<!-- afficher range des dates prise en comptes -->
            <span v-if="modalDateStart && modalDateEnd" class="text-muted">
              <br><small>Période : [[ formatDateRange(modalDateStart, modalDateEnd) ]]</small>
            </span>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Recette</th>
                <th>Date / Horaire / Couverts</th>
                <th class="text-end">Quantité</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="detail in ingredientDetails" :key="detail.recette + detail.dateService">
                <td class="fw-medium lh-1">[[detail.recette]]</td>
                <td>
                  [[new Date(detail.dateService).toLocaleDateString("fr-FR", {weekday: 'short', month: 'short', day: 'numeric'})]] - [[detail.horaire]] /
                 <span class="fw-medium text-nowrap"> [[detail.assiettes]] c. </span>
                </td>
                <td class="text-end">
                  <span v-if="detail.quantiteOrig && detail.unitOrig" class="text-muted small">
                    [[round2Decimals(detail.quantiteOrig)]] [[detail.unitOrig]] ~=
                  </span>
                  <strong>[[round2Decimals(detail.quantite)]] [[detail.unit]]</strong>
                </td>
              </tr>
            </tbody>
            <tfoot v-if="ingredientTotalQuantity">
              <tr class="table-secondary">
                <td colspan="2"><strong>Total</strong></td>
                <td class="text-end">
                  <template v-for="(total, index) in ingredientTotalQuantity">
                    <strong>[[round2Decimals(total.qTotal)]] [[total.unit]]</strong>
                    <span v-if="index < ingredientTotalQuantity.length - 1" class="mx-1">+</span>
                  </template>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  </div>


{{ $eventJS := resources.Get "js/event/bootstrap.js" | js.Build (dict "targetPath" "assets-bundled/event-utils.js" "minify" true) | fingerprint }}
<script src="{{ $eventJS.RelPermalink }}" integrity="{{ $eventJS.Data.Integrity }}" defer></script>
<script>
  flatpickr.localize(flatpickr.l10ns.fr);
</script>
{{ end }}
