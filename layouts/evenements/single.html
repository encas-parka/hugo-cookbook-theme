{{ define "main" }}

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

<!--::: Liste qui contiendra tous les ingrédients avec leurs données associés (quantité, recette, date, assietes...). Sert aux tableaux des quantités.  -->
{{- $IngredientList := slice -}}

<!-- Liste qui contiendra qui contient les listes de recettes pour chaque date -->
{{ $.Scratch.Set "recettesList" slice }}

{{- $.Scratch.Set "IngredientsTypesList" (slice) -}}

{{- $alertQuantite := false -}}
{{- $checkYes := false -}}
{{- $.Scratch.Set "checkYes" false -}}

{{/* Charger l'index global des ingrédients (conservé) */}}
{{ $ingredientsIndex := partialCached "functions/ingredients-index.html" "ingredients-index" }}
{{ $byUUIDIng := $ingredientsIndex.byUUID }}

{{/* Charger l'index global des recettes pour résoudre les métadonnées */}}
{{- $recettesIndex := partialCached "functions/recettes-index" "recettes-index-global" -}}
{{- $byUUIDRecette := $recettesIndex.byUUIDRecette -}}
{{- $ingredientsIndex := partialCached "functions/ingredients-index.html" "ingredients-index" -}}
{{- $byUUIDIng := $ingredientsIndex.byUUID -}}

{{/* Récupérer les ingrédients frais depuis l'index */}}
{{/* WARN : les legume frais sont à la fois de type "legumes" et pFrais. Créer un fonction dédiée et partialCached ? */}}


{{/* Structures de données pour notre page */}}
{{- $recettesList := slice -}}
{{- $groupedIngredientsByRecetteKey := dict -}}
{{- $recetteKey := 0 -}}



  {{- range .Param "repas" -}}
      {{- $dateService := .date_service -}}
      {{- $dateTimeService := .date_service -}}
      {{- $horaire := .horaire -}}

      {{/* Logique de normalisation de la date (inchangée) */}}
      {{- if eq $horaire "matin" -}}
          {{- $dateTimeService = $dateTimeService | replaceRE "T\\d{2}:\\d{2}:\\d{2}" "T08:00:00" -}}
      {{- else if eq $horaire "midi" -}}
          {{- $dateTimeService = $dateTimeService | replaceRE "T\\d{2}:\\d{2}:\\d{2}" "T12:00:00" -}}
      {{- else if eq $horaire "soir" -}}
          {{- $dateTimeService = $dateTimeService | replaceRE "T\\d{2}:\\d{2}:\\d{2}" "T20:00:00" -}}
      {{- end -}}

      {{- $repasBaseAssiettes := (int .assiettes) -}}

      {{- range .recettes_du_repas -}}
          {{/* 1. On donne un ID unique à cette recette DANS CET ÉVÉNEMENT */}}
          {{- $recetteKey = add $recetteKey 1 -}}

          {{- $assiettesPourCalcul := $repasBaseAssiettes -}}
          {{- if .altAssiettes -}}{{- $assiettesPourCalcul = (int .altAssiettes) -}}{{- end -}}


          {{/* 2. On résout la recette UNE SEULE FOIS via son UUID */}}
          {{- $uuid := partialCached "functions/extract-uuid-from-slug.html" .recette .recette -}}
          {{- $recetteMeta := index $byUUIDRecette $uuid -}}

          {{/*
            3. On DÉLÈGUE le calcul des quantités et le groupement au partial optimisé.
               Ce partial remplace votre calcul manuel et la construction de $IngredientList.
          */}}
          {{- $groupedData := dict -}}
          {{- $autoRegimes := dict -}}
          {{- if $recetteMeta -}}
              {{- $builderContext := dict
                  "items"             $recetteMeta.ingredients
                  "byUUID"            $byUUIDIng
                  "mode"              "evenement"
                  "assiettes"         $assiettesPourCalcul
                  "assiettesRecettes" $recetteMeta.plate
              -}}
              {{- $fullIngredientsData := partialCached "functions/ingredients-group-builder.html" $builderContext $uuid $assiettesPourCalcul -}}
              {{- $groupedData = $fullIngredientsData.ingredients -}}
              {{- $autoRegimes = $fullIngredientsData.regimes -}}
          {{- end -}}

          {{/* 4. On stocke les résultats dans nos deux structures de données principales */}}

          {{/* a) Les ingrédients calculés et groupés, associés à la clé unique */}}
          {{- $groupedIngredientsByRecetteKey = merge $groupedIngredientsByRecetteKey (dict (string $recetteKey) $groupedData) -}}

          {{/* b) Les métadonnées de la recette pour l'affichage (sommaire, titres des cartes, etc.) */}}
          {{- $recettesList = $recettesList | append (dict
              "recetteKey"        $recetteKey
              "recette"           .recette
              "recetteMeta"       $recetteMeta
              "recetteName"       (cond $recetteMeta $recetteMeta.title .recette)
              "dateService"       $dateService
              "dateTimeService"   $dateTimeService
              "horaire"           $horaire
              "typePlat"          .type_plat
              "assiettes"         $assiettesPourCalcul
              "repasBaseAssiettes" $repasBaseAssiettes
              "chef"              .chef
              "commentaire"       .commentaire
              "partof"            .partof
              "checkfor"          $recetteMeta.Params.checkfor
              "check"             $recetteMeta.Params.check
              "categories"        $recetteMeta.categories
              "permalink"         $recetteMeta.permalink
              "autoRegimes"       $autoRegimes
              )
          -}}
      {{- end -}} {{/* fin range .recettes_du_repas */}}
  {{- end -}} {{/* fin range .Param "repas" */}}

{{/*  Dédoublage des listes  */}}
{{- $.Scratch.Set "IngredientsTypesList" (($.Scratch.Get "IngredientsTypesList") | uniq) -}}



<!-- USELESS ? -->
{{- $allergenesData := (partialCached "functions/allergenesIng.html" . "allergenesIng")  -}}

{{- $allergenesLgList := slice "Poisson" "Oeuf" "Soja" "Sésame" "Moutarde" "Fruit à coque" "Céleri" "Crustacé" "Arachide" "Mollusque" -}}

{{- $allergenesList := slice -}}
{{- range $allergenesLgList -}} {{/* replace $allergenesTypeList */}}
  {{- $allergenesList = append  ($allergenesData.Get .) $allergenesList -}}
{{- end -}}



<div id="app">

{{/* ::: navbar page */}}
{{ $here := "recettes"}}

{{ $eventBaseUrl := .RelPermalink }} {{/* Sur la page de l'événement, .RelPermalink est déjà l'URL de base */}}
{{ $recettelink := $eventBaseUrl }}
{{ $inglink := printf "%singredients/" $eventBaseUrl }}
{{ $posterlink := printf "%sposter/" $eventBaseUrl }}
  {{ if eq $here "ingredients" }}
    {{ $inglink = "#"}}
  {{ else if eq $here "recettes" }}
    {{ $recettelink = "#"}}
  {{ else if eq $here "poster" }}
    {{ $posterlink = "#"}}
  {{ end }}
{{ $eventTitle := .Title }} {{/* Le titre de la page actuelle est le titre de l'événement */}}
{{ partial  "components/event-top-nav" ( dict "inglink" $inglink "recettelink" $recettelink "posterlink" $posterlink "here" $here "Title" $eventTitle)}}


{{/*  ::: Warning : missing recipes  */}}
{{- range $.Param "repas" -}}
{{- range .recettes_du_repas -}}
{{- $recetteSlug := .recette -}}
{{- $recetteFound := false -}}
{{- $uuid := "" -}}
{{- if in $recetteSlug "_" -}}
  {{- $parts := split $recetteSlug "_" -}}
  {{- $uuid = index $parts (sub (len $parts) 1) -}}
{{- end -}}
{{- with (index $byUUIDRecette $uuid) -}}
  {{- $recetteFound = true -}}
{{- end -}}
{{- if not $recetteFound -}}
  <div class="card border-danger border-3 my-3 p-2 no-print">
    <div class="card-body text-danger">
      <h5 class="card-title mt-1">Une des recettes de l'évenement n'existe plus !</h5>
      <p class="card-text">La recette <span class="fw-bolder">" {{ $recetteSlug -}}"</span> présente dans les menus de l'événement n'existe plus sur le site. </p>
      <p>La recette à peut être été supprimée. Pour résoudre le problème, il faut modifier la page de l'événement pour remplacer la recette disparue</p>
    </div>
  </div>
{{- end -}}
{{- end -}}
{{- end -}}


<a href="#" class="scroll-to-top" title="Scroll to top"></a>


{{/* ::: _LES RECETTES   */}}
<div id="recettesSection" :class="{'no-print' : !toPrint.recettesSection}">
  <h3 id="Recettes" class="no-print">Les {{ len $recettesList }} recettes prévues pour l'événement "{{ .Page.Title }}"</h3>

  {{/* ::: Génération du sommaire */}}
  <div id="sommaire"class="no-print">
    {{/* Variable permettant de vérifier si les recettes sont de la meme date et du meme horaire ou pas; pour gérer leur affichage / l'organisation des recettes */}}
    {{ $dateServiceSommaire := "none"}}
    {{ $currentHoraireSommaire := "none" }}
    <div class="card p-4 m-2">
      <span class="fs-4">Sommaire</span>

      {{- range sort $recettesList ".dateTimeService" -}}
          {{- $recetteKey := .recetteKey -}}
          {{- $recetteMeta := .recetteMeta -}} {{- /* Contient les métadonnées complètes de la recette (titre, ingrédients, préparation, catégories, etc.) */ -}}
          {{- $recetteData := . -}} {{- /* Contient les données spécifiques à cette instance de recette dans l'événement (date, horaire, assiettes calculées, chef, commentaire, etc.) */ -}}

          {{- with $recetteMeta -}}

      <div>
        {{ if and (ne (($recetteData.dateService | time) | time.Format "Monday 2 January ") $dateServiceSommaire) }}
          <div class="mt-4">
            <a href="#{{ ($recetteData.dateService | time) | time.Format "Monday 2 January" | urlize}}" class="fw-bolder text-uppercase">
              <slot name='{{ ($recetteData.dateService | time) | time.Format "Monday 2 January" | urlize}}'>{{ ($recetteData.dateService | time) | time.Format "Monday 2 January"}}</slot>
            </a>
          </div>
        {{ end }}

        {{ if ne $recetteData.horaire $currentHoraireSommaire }}
          <div class="ms-3 fw-semibold mt-1">{{ $recetteData.horaire }} ({{ $recetteData.repasBaseAssiettes }} couverts)</div>
        {{ end }}

        <div class="ms-5">
          <a href="#recetteID{{ $recetteData.recetteKey }}">
            <slot name="{{ .recetteKey }}"></slot>{{ if $recetteData.recetteName }}{{ $recetteData.recetteName }}{{ else }}[Recette introuvable: {{ .recette }}]{{ end }} →
          </a>
          <span class="small"> ({{$recetteData.typePlat}} |
            <span class="{{ if ne .assiettes .repasBaseAssiettes }} fw-semibold {{end}}" >{{$recetteData.assiettes}} c. </span>)</span>
        </div>
      </div>

      {{- end -}}


      {{/*  Actualiser la date et l'horaire apres le range  */}}
      {{ $dateServiceSommaire = (($recetteData.dateService | time) | time.Format "Monday 2 January ")}}
      {{ $currentHoraireSommaire = $recetteData.horaire }}

      {{- end -}} {{/* fin de range recettesList */}}
    </div>
  </div>

  <div id="check_alergene" class="form-check my-4 no-print">
    <input class="form-check-input" type="checkbox" value="" id="print_alert" name="print_alert" v-model="print_alert">
    <label class="form-check-label" for="print_alert">
      Afficher les alertes d'allergènes et quantité
    </label>
  </div>
</div>

<!-- zone de Contenu enlevé à réinsérer plus tard -->
{{/*  ::: __Les intertitres jours  */}}
{{ $dateService := "none"}}
{{ $horaire := "none" }}
{{- range sort $recettesList ".dateTimeService" -}}
    {{/* On récupère nos données pré-calculées pour cette recette */}}
    {{- $recetteKey := .recetteKey -}}
    {{- $recetteMeta := .recetteMeta -}}
    {{- $recetteData := . -}} {{/* Contient .assiettes, .horaire, etc. */}}

    {{- with $recetteMeta -}}
    {{/* Logique d'affichage des intertitres de date/horaire (votre code est bon) */}}
  <div id="recette_Card-intertitre" class="no-print">
      {{ if and ( ne (($recetteData.dateService | time) | time.Format "Monday 2 January ") $dateService )}}
          <div class="h3 text-center card py-4 mx-6 bg-primary bg-opacity-10 fw-bolder" id="{{ ($recetteData.dateService | time) | time.Format "Monday 2 January" |urlize}}">{{ ($recetteData.dateService | time) | time.Format "Monday 2 January"}}</div>
      {{- end -}}

      {{ if ne $recetteData.horaire $horaire }}
          <div class="h4 text-center card py-3 mx-6 bg-light">{{ $recetteData.horaire}} </div>
      {{ end }}
      {{ $dateService = (($recetteData.dateService | time) | time.Format "Monday 2 January ")}}
      {{ $horaire = $recetteData.horaire }}
  </div>

  {{/* ::: __LA CARTE RECETTE */}}
<div
  class="card break-after avoid-break-inside my-5 p-2 bg-light bg-opacity-25 print-nocard"
  id="recetteID{{$recetteKey}}"
  :class="{ 'no-print': !toPrint.recetteID{{$recetteKey}} }"
  >
  <div class="card-body py-1">
    <a class="btn btn-sm btn-outline-primary float-end no-print mx-1"
    @click="printThis('recetteID{{$recetteKey}}', 'recettesSection')"
    >{{ partialCached "components/icon-svg" (dict "name" "printer" "size" "24px") nil "printer" }}
  </a>
    <a class="btn btn-sm btn-outline-primary float-end no-print mx-1"
    href="{{$recetteData.permalink}}"
    > {{ partialCached "components/icon-svg" (dict "name" "box-arrow-in-right" "size" "24px") nil "box-arrow-in-right" }} </a>
    <div id="titreRecette" class="py-1h2 my-2">
      <div class="my-2 h2"><span class="me-2">{{ partialCached "components/icon-recette" $recetteMeta.categories $recetteMeta.categories  }}</span> {{ $recetteMeta.title }}
        {{ if $recetteData.partof }}
        <span class="ms-3 fs-5">(pour : {{ $recetteData.partof }})</span>
        {{ end }}
      </div>
    </div>

    <div id="topRecette" class="row">
      <div class="col">
        <div class="fw-semibold fs-5 print-fs-4"> {{($recetteData.dateService | time)| time.Format "Monday 2 January "}} - {{ $recetteData.horaire }} - {{
          $recetteData.typePlat }}</div>
        <div class="print-bold">{{ $recetteData.assiettes }} couverts</div>
        <div class="">

          {{ if $recetteData.chef }}
          <div>Référent•es: {{ $recetteData.chef }} - </div>
          {{ end }}
        </div>
        <div>
            {{ if $recetteMeta.Params.spécialité }}
            <div class="small">Spécialité : {{ $recetteMeta.Params.spécialité }}</div>
            {{ end }}
        </div>

      </div>

      <div class="col text-end">

            <div class="d-flex justify-content-end flex-wrap gap-2">
              {{/* Afficher les régimes automatiques pour cette recette (pré-calculés) */}}
             <div class="me-1">
               {{- with $recetteData.autoRegimes -}}
               {{- if .vegan -}}
                 <span class="badge bg-green float-end me-1">vegan</span>
               {{- else if .vegetarien -}}
                 <span class="badge bg-green float-end me-1">végétarien</span>
               {{- end -}}
               {{- if .sans_gluten -}}
                 <span class="badge bg-green float-end me-1">sans-gluten</span>
               {{- end -}}
               {{- if .sans_lactose -}}
                 <span class="badge bg-green float-end me-1">sans-lactose</span>
               {{- end -}}
             {{- end -}}
</div>
              {{ if $recetteMeta.materiel }}
              <div class="">
              {{ range $recetteMeta.materiel }}
              <span class="badge bg-grey float-end me-1">{{ . }}</span>
              {{ end }}
              </div>
              {{ end }}
            </div>
      </div>


     {{/*  ::: ___Alertes */}}
      {{- $assiettesInit := $recetteMeta.repasBaseAssiettes -}}
      {{- $isCheck := false -}} {{- $checkfor := 0 -}} {{- $checkYes := false -}}
      {{- $compareQuantite := slice -}}
      {{- $alertQuantite := false -}}

      {{/* On récupère les valeurs depuis $recetteData */}}
      {{- $checkfor = $recetteData.checkfor | default 0 -}}
      {{- if eq $recetteData.check "Oui" -}}
          {{- $isCheck = true -}}
      {{- end -}}
      {{- if eq $recetteData.checkAlwaysOk true -}}
          {{- $checkYes = true -}}
      {{- end -}}

      {{/*  checkAlwaysOk : si true, pas d'alerte de quantité  */}}
      {{ if eq $checkYes false }}
        {{ if and $checkfor (gt $checkfor 0) }}
          {{ if and
            (or (gt (div $recetteData.assiettes 2) $checkfor ) (lt (mul $recetteData.assiettes 2) $checkfor) )
            (or (gt (div $recetteData.assiettes 2) $assiettesInit ) (lt (mul $recetteData.assiettes 2) $assiettesInit) )
            -}}
            {{- $alertQuantite = true -}} {{- $compareQuantite = slice $checkfor $assiettesInit -}}
          {{end}}
        {{ else if $assiettesInit }}
          {{ if or (gt (div $recetteData.assiettes 2) $assiettesInit ) (lt (mul $recetteData.assiettes 2) $assiettesInit) }}
            {{- $alertQuantite = true -}} {{- $compareQuantite = $assiettesInit -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}

      {{/* Calcul des alertes allergènes via le partial function dédié */}}
      {{- $alertsContext := dict "Params" (dict "ingredients" $recetteMeta.ingredients) -}}
      {{- $recetteUuid := partialCached "functions/extract-uuid-from-slug.html" $recetteData.recette $recetteData.recette -}}
      {{- $alerts := partialCached "functions/recette-alerts.html" $alertsContext $recetteUuid -}}

      {{/* Rendu via le composant dédié, conditionné par v-show print_alert */}}
      <div class="row justify-content-start mt-2" v-show="print_alert">
        {{- if $alertQuantite -}}
        <div class="col-12 col-md-6 col-lg-6 col-xl-6 print-col-2 my-3">
          <div class="card border-danger shadow small px-4 card-body print-nocard">
            {{- if not $checkYes }}
            <div>
              <span class="me-1">{{ partialCached "components/icon-svg" (dict "name" "exclamation-triangle" "size" "1rem") "exclamation-triangle" }}</span>
              Le nombre de couverts prévu est significativement différent de celui qui a été déclaré comme testé
              ({{ if $compareQuantite }}{{ $compareQuantite }}{{ else }}inconnu{{ end }}): les proportions sont peut-être à adapter pour certains ingrédients.
            </div>
            {{- end -}}
          </div>
        </div>
        {{- end -}}

        {{- with $alerts -}}
        <div class="col-12 col-md-6 col-lg-6 col-xl-6 print-col-2 my-3">
          {{- partialCached "components/recette-alerts.html" (dict "alerts" . "iconSize" "1.2rem" "card" true ) . -}}
        </div>
        {{- end -}}
      </div>

      {{ with $recetteMeta.quantite_desc }}
      <div class="my-2">
        <span class="fw-semibold">Service/Quantité : </span>  {{.}}
      </div>
      {{ end }}
    </div>




    {{/* :::  ___LES INGREDIENTS  */}}
    <div id="IngredientsEtPreparation-recette" class="row justify-content-evenly border-top border-1 pt-2">
      <div id="Ingredients-recette" class="col-md-4 print-col-30-100">
        <h4>
        <span class="me-2">{{ partialCached "components/icon-svg" (dict "name" "ingredients" "size" "2rem") "ingredients"  }}</span>
        Ingredients </h4>

        {{- $preCalculatedIngredients := index $groupedIngredientsByRecetteKey (string $recetteKey) -}}
            {{- partial "components/ingredients-display-pre-grouped.html" (dict
                "ingredientsByType" $preCalculatedIngredients
                "showAllergenIcon" true
                "showComment" true
              )
            -}}
      </div>

      {{/* ::: ___PREPARATION  */}}
    <div class="col-md-8 print-col-70-100">
      <h4><span class="me-2">{{ partial "components/icon-svg" (dict "name" "preparation" "size" "2.5rem") }}</span> Préparation</h4>
      {{ if .commentaire }}
      <div class="card mb-3">
        <div class="card-body print-nocard">
           <span class="text-muted">{{ partial "components/icon-svg" (dict "name" "exclamation-circle" "size" "1.5rem") }} info </span>
           <br>
           <span class="small">{{ .commentaire }}</span>
        </div>
      </div>
      {{ end }}
        <div class=" card card-body print-nocard">
        {{ if .preparation24h }}
         <div class="card border border-danger mb-4 p-3 " >
           <p class="fs-5 fw-bold text-center" >A prévoir à l'avance !</p>
           <div class="">{{ .preparation24h | markdownify }}</div>
        </div>
        {{ end }}
          <div class="">{{ .preparation | markdownify }}</div>
        </div>

      {{ range .astuces }}
          <div class="card card-body m-3 small ">
            <span class="fw-bolder">Astuce: </span> <span>{{ .astuce }} </span>
          </div>
      {{ end }}
      </div>
    </div> {{/* #IngredientsEtPreparation-recette */}}
  </div> {{/* .card-body */}}
</div> {{/* .card */}}

{{- end -}} {{/* with $recetteMeta */}}
{{- end -}} {{/* range $recettesList */}}

<!-- Fin Contenu réinséré -->

{{/*  ::: Impression - MODAL  */}}
<div class="modal modal-xl fade d-print-none" tabindex="-1" id="modalImpression" aria-labelledby="modalImpressionLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable ">
    <div class=" modal-content">
      <div class="modal-header">
        <h5 class="modal-title mt-0" id="modalImpressionLabel">Imprimer / exporter en PDF</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <div class="row">
          <div class="col-md-6">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" v-model="toPrint.recettesSection" name="cbPrintRecettes"
                id="cb-printRecettes">
              <label class="form-check-label" for="cb-printRecettes">Imprimer les Recettes</label>
            </div>
            <hr>

            <div class="form-check">
              <input class="form-check-input" type="checkbox" v-model="print_alert" :value="true" name="cb-alert"
                id="cb-printAlert">
              <label class="form-check-label" for="cb-printAlert">Imprimer les alertes (alergenes...)</label>
            </div>


          </div>
          <div class="col-md-6">
            <div class="callout small">
              <p>
                Pour exporter en PDF, dans les options d'impression, sélectionnez : destination > "enregistrer au format
                Pdf" comme imprimante. Pensez aussi à personnaliser les marges d'impression ou l'échelle afin de
                redimensionner le contenu selon ce qui vous convient.
              </p>
            </div>
          </div>
        </div>

        <hr>
        <div class="text-end">
          <a class="btn btn-primary" @click="print" role="button" data-bs-dismiss="modal">Imprimer !</a>
        </div>
      </div>
    </div>
  </div>
</div>

</div>



<script>
  const app = Vue.createApp({
    delimiters: ['[[', ']]'],
    el: '#app',
    data() {
      return {
        toPrint: {
          recettesSection: true,
        },
        print_alert: true,
      }
    },
    methods: {
      printThis(el, section) {
        this.$nextTick(() => {
          const printThat = [el, section];
          Object.keys(this.toPrint).forEach((param) => {
            this.toPrint[param] = printThat.includes(param);
          });
          this.$nextTick(() => {
            window.print();
          });
        });
      },
      printAlert() {
        this.print_alert = !this.print_alert;
      },
      printGlobal() {
        Object.keys(this.toPrint).forEach((param) => {
          this.toPrint[param] = true;
        });
      },
      print() {
        setTimeout(() => {
          window.print();
        }, 500);
        this.$nextTick(() => {
          if (this.print_alert === false) {
            this.print_alert = true;
          }
        });
      },
    },
    mounted() {
      // Activer toutes les cartes recettes présentes dans le DOM pour l'impression
      const cards = document.querySelectorAll('[id^="recetteID"]');
      cards.forEach(card => {
        const id = card.id;
        if (!(id in this.toPrint)) {
          this.toPrint[id] = true;
        }
      });
    },
  });

  app.mount('#app');
</script>


{{ end }}
