{{- /*
  single.ingredients_optimized.json
  Version optimisée qui compresse les données pour éviter la limite de 5000 caractères
  Principes :
  - Élimination neededConsolidatedByDate (reconstruit côté client)
  - Élimination totalNeededConsolidated (reconstruit côté client)
  - Compression de recipesOccurrences en format court "occ"
  - Réduction ~88% de taille par ingrédient
*/ -}}

{{- $eventData := partialCached "functions/event-data-processor.html" . .File.UniqueID -}}
{{- $ingredient_totals := $eventData.ingredient_totals -}}
{{- $totalAssiettesByIngredient := $eventData.totalAssiettesByIngredient -}}
{{- $recipesByIngredient := $eventData.recipesByIngredient -}}

{
  "mainGroup_id": "{{ .File.ContentBaseName | default .File.UniqueID }}",
  "name": {{ .Title | jsonify }},
  "allDates": {{ $eventData.allDates | jsonify }},
  "ingredients": [
    {{- $first := true -}}
    {{- range $name, $data := sort $ingredient_totals "name" -}}
      {{- if not $first }},{{ end }}{{- $first = false -}}
      {
        "ingredientHugoUuid": {{ $data.uuid | jsonify }},
        "ingredientName": {{ $data.name | jsonify }},
        "ingType": {{ $data.type | jsonify }},
        "totalAssiettes": {{ (int (index $totalAssiettesByIngredient $data.name | default 0)) | jsonify }},
        "nbRecipes": {{ (len (index $recipesByIngredient $data.name | default dict)) | jsonify }},
        {{- if $data.pFrais }}"pFrais": true,{{ end -}}
        {{- if $data.pSurgel }}"pSurgel": true,{{ end -}}
        {{- if and $data.has_equivalence (gt (len $data.conversion_rules) 0) -}}
          "conversionRules": {{ $data.conversion_rules | jsonify }},
        {{- end -}}
        {{- if $data.has_equivalence  -}}
        "totalNeededRaw": [
          {{- $firstCategory := true -}}
          {{- if gt $data.category_weight 0 -}}{{- if not $firstCategory }},{{ end }}{{- $firstCategory = false -}}{ "value": {{- printf "%.0f" $data.category_weight | jsonify -}}, "unit": "gr." }{{- end -}}
          {{- if gt $data.category_volume 0 -}}{{- if not $firstCategory }},{{ end }}{{- $firstCategory = false -}}{ "value": {{- printf "%.0f" $data.category_volume | jsonify -}}, "unit": "ml" }{{- end -}}
          {{- range $unit, $quantity := $data.category_other -}}{{- if not $firstCategory }},{{ end }}{{- $firstCategory = false -}}{ "value": {{- if eq $unit "recette·s" }}{{ printf "%.0f" $quantity | jsonify }}{{ else }}{{- printf "%.1f" $quantity | jsonify }}{{ end -}}, "unit": {{ $unit | jsonify }} }{{- end -}}
        ],
        {{- end -}}
        "occ": [
          {{- $ingredientOccurrences := index $eventData.ingredient_occurrences $data.name | default (slice) -}}
          {{- $firstOcc := true -}}
          {{- range $occurrence := $ingredientOccurrences -}}
            {{- if not $firstOcc }},{{ end }}{{- $firstOcc = false -}}
            {
              "r": {{ $occurrence.recipe_name | jsonify }},
              "d": {{ $occurrence.dateTimeService | jsonify }},
              "q": {{- $unitLower := $occurrence.unit | lower -}}{{- $convertedQty := float $occurrence.quantite -}}{{- if eq $unitLower "kg" }}{{- $convertedQty = mul $convertedQty 1000 -}}{{- else if eq $unitLower "l." }}{{- $convertedQty = mul $convertedQty 1000 -}}{{- end -}}{{- if or (eq $unitLower "kg") (eq $unitLower "gr.") (eq $unitLower "l.") (eq $unitLower "ml") }}{{ printf "%.0f" $convertedQty | jsonify }}{{- else if eq $unitLower "recette·s" }}{{ printf "%.0f" $convertedQty | jsonify }}{{- else }}{{- printf "%.1f" $convertedQty | jsonify }}{{- end -}},
              "u": {{- if eq $unitLower "kg" }}"gr."{{- else if eq $unitLower "l." }}"ml"{{- else }}{{ $occurrence.unit | jsonify }}{{- end -}},
              "a": {{ $occurrence.assiettes }}
            }
          {{- end -}}
        ]
      }
    {{- end -}}
  ]
}
