{{- /*
  quantite-converter.html

  Partial to convert and normalize ingredient quantities.
  Uses a structured data approach for better maintainability.

  Input (dict):
  - quantite:       (number) The quantity.
  - unit:           (string) The unit (e.g., "c. à soupe", "kg", "gr.").
  - ingredient:     (string, optional) The ingredient name, for context-sensitive conversions.

  Output:
  - A dict: {
  "quantiteEq":    (float) The converted quantity in the base unit (gr. or ml).
  "unitEq":        (string) The base unit ("gr." or "ml").
  "hasConversion": (bool) True if a conversion was successfully performed.
  "conversionRule": (string) The conversion rule for the ingredient.
  }
*/}}
{{- $quantite := .quantite | default 0.0 -}}
{{- $unit := .unit | default "" -}}
{{- $ingredient := .ingredient | default "" -}}

{{- $qFloat := float $quantite -}}
{{- $quantiteEq := $qFloat -}}
{{- $unitLower := $unit | lower -}}
{{- $ingLower := $ingredient | lower -}}

{{- /* ✅ PRÉ-CALCUL : Identifier le type d'ingrédient UNE SEULE FOIS */}}
{{- $isSucre := strings.Contains $ingLower "sucre" -}}
{{- $isSel := eq $ingLower "sel" -}}
{{- $isFarine := eq $ingLower "farine" -}}
{{- $isCremeEpaisse := strings.Contains $ingLower "crème épaisse" -}}
{{- $isAil := eq $ingLower "ail" -}}
{{- $isOignon := strings.Contains $ingLower "oignon" -}}
{{- $isTomate := eq $ingLower "tomate" -}}
{{- $isPoireau := eq $ingLower "poireau" -}}
{{- $isAubergine := strings.Contains $ingLower "aubergine" -}}
{{- $isCourgette := eq $ingLower "courgette" -}}
{{- $isEchalote := eq $ingLower "échalote" -}}
{{- $isOrange := and (eq $ingLower "orange") (not (strings.Contains $ingLower "jus")) -}}
{{- $isCitron := and (strings.Contains $ingLower "citron") (not (strings.Contains $ingLower "jus")) -}}
{{- $isConcombre := eq $ingLower "concombre" -}}
{{- $isLevureChimique := eq $ingLower "levure chimique" -}}
{{- $isCarotte := eq $ingLower "carotte" -}}
{{- $isBetteraveRouge := eq $ingLower "betterave rouge" -}}

{{- /* ✅ PRÉ-CALCUL : Identifier le type d'unité UNE SEULE FOIS */}}
{{- $isCafe := strings.Contains $unitLower "caf" -}}
{{- $isSoupe := strings.Contains $unitLower "soupe" -}}
{{- $isPincee := strings.Contains $unitLower "pinc" -}}
{{- $isGousse := strings.Contains $unitLower "gousse" -}}
{{- $isTete := strings.Contains $unitLower "tête" -}}
{{- $isUnite := strings.Contains $unitLower "unit" -}}


{{- /* Structure de données pour les conversions - plus maintenable ! */}}
{{- $conversionRules := dict
  "cafe_sucre" 5
  "cafe_sel" 5
  "cafe_farine" 3
  "cafe_semoule" 4
  "cafe_poivre" 2.5
  "cafe_cacao" 2.5
  "cafe_sucre_glace" 3
  "cafe_maizena" 3
  "cafe_bicarbonate" 5
  "cafe_curcuma" 2
  "cafe_cumin" 2
  "cafe_curry" 2
  "cafe_muscade" 2
  "cafe_paprika" 2
  "cafe_miel" 10
  "cafe_creme_epaisse" 5
  "cafe_default" 5


  "soupe_sucre" 15
  "soupe_sel" 15
  "soupe_farine" 10
  "soupe_semoule" 12
  "soupe_poivre" 8
  "soupe_cacao" 8
  "soupe_sucre_glace" 9
  "soupe_maizena" 10
  "soupe_creme_epaisse" 15
  "soupe_bicarbonate" 15
  "soupe_curcuma" 6
  "soupe_cumin" 6
  "soupe_curry" 6
  "soupe_muscade" 7
  "soupe_paprika" 6
  "soupe_miel" 30
  "soupe_default" 15


  "pincee" 0.4
  "gousse_ail" 6.5
  "tete_ail" 80

  "unite_oignon" 120
  "unite_ail" 6.5
  "unite_tomate" 120
  "unite_poireau" 150
  "unite_aubergine" 250
  "unite_courgette" 200
  "unite_eshalote" 30
  "unite_orange" 200
  "unite_citron" 100
  "unite_concombre" 200
  "unite_levure_chimique" 11
  "unite_carotte" 125
  "unite_betterave_rouge" 250
-}}

{{- /* Initialize result variables */}}
{{- $unitEq := $unit -}}
{{- $hasConversion := false -}}
{{- $conversionRule := "" -}}
{{- $baseUnit := "" -}}

{{- /* --- Logique de conversion --- */}}

{{- if $isCafe -}}
  {{- $hasConversion = true -}}
  {{- if $isSucre -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "cafe_sucre") -}}
    {{- $baseUnit = "gr." -}}
    {{- $conversionRule = "1 c. à café = 5 gr." -}}
  {{- else if $isSel -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "cafe_sel") -}}
    {{- $baseUnit = "gr." -}}
    {{- $conversionRule = "1 c. à café de sel = 5 gr." -}}
  {{- else if $isFarine -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "cafe_farine") -}}
    {{- $baseUnit = "gr." -}}
    {{- $conversionRule = "1 c. à café de farine = 3 gr." -}}
  {{- else if $isCremeEpaisse -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "cafe_creme_epaisse") -}}
    {{- $baseUnit = "ml" -}}
    {{- $conversionRule = "1 c. à café de crème épaisse = 5 ml." -}}
  {{- else -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "cafe_default") -}}
    {{- $baseUnit = "ml" -}}
    {{- $conversionRule = "1 c. à café = 5 ml." -}}
  {{- end -}}

{{- else if $isSoupe -}}
  {{- $hasConversion = true -}}
  {{- if $isSucre -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "soupe_sucre") -}}
    {{- $baseUnit = "gr." -}}
    {{- $conversionRule = "1 c. à soupe de sucre = 15 gr." -}}
  {{- else if $isSel -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "soupe_sel") -}}
    {{- $baseUnit = "gr." -}}
    {{- $conversionRule = "1 c. à soupe de sel = 15 gr." -}}
  {{- else if $isFarine -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "soupe_farine") -}}
    {{- $baseUnit = "gr." -}}
    {{- $conversionRule = "1 c. à soupe de farine = 10 gr." -}}
  {{- else if $isCremeEpaisse -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "soupe_creme_epaisse") -}}
    {{- $baseUnit = "ml" -}}
    {{- $conversionRule = "1 c. à soupe de crème épaisse = 15 ml." -}}
  {{- else -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "soupe_default") -}}
    {{- $baseUnit = "ml" -}}
    {{- $conversionRule = "1 c. à soupe = 15 ml." -}}
  {{- end -}}

{{- else if $isPincee -}}
  {{- $hasConversion = true -}}
  {{- $baseUnit = "gr." -}}
  {{- $quantiteEq = mul $qFloat (index $conversionRules "pincee") -}}
  {{- $conversionRule = "1 pincée = 0,4 gr." -}}

{{- else if and $isGousse $isAil -}}
  {{- $hasConversion = true -}}
  {{- $baseUnit = "gr." -}}
  {{- $quantiteEq = mul $qFloat (index $conversionRules "gousse_ail") -}}
  {{- $conversionRule = "1 gousse = 6.5 gr." -}}

{{- else if and $isTete $isAil -}}
  {{- $hasConversion = true -}}
  {{- $baseUnit = "gr." -}}
  {{- $quantiteEq = mul $qFloat (index $conversionRules "tete_ail") -}}
  {{- $conversionRule = "1 tête = 80 gr." -}}

{{- else if $isUnite -}}
  {{- $baseUnit = "gr." -}}
  {{- $hasConversion = true -}}
  {{- if $isOignon -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "unite_oignon") -}}
    {{- $conversionRule = "un oignon = 120 gr." -}}
  {{- else if $isAil -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "unite_ail") -}}
    {{- $conversionRule = "un ail = 6.5 gr." -}}
  {{- else if $isTomate -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "unite_tomate") -}}
    {{- $conversionRule = "une tomate = 120 gr." -}}
  {{- else if $isPoireau -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "unite_poireau") -}}
    {{- $conversionRule = "un poireau = 150 gr." -}}
  {{- else if $isAubergine -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "unite_aubergine") -}}
    {{- $conversionRule = "une aubergine = 250 gr." -}}
  {{- else if $isCourgette -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "unite_courgette") -}}
    {{- $conversionRule = "une courgette = 200 gr." -}}
  {{- else if $isEchalote -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "unite_eshalote") -}}
    {{- $conversionRule = "une échalote = 30 gr." -}}
  {{- else if $isOrange -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "unite_orange") -}}
    {{- $conversionRule = "une orange = 200 gr." -}}
  {{- else if $isCitron -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "unite_citron") -}}
    {{- $conversionRule = "un citron = 100 gr." -}}
  {{- else if $isConcombre -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "unite_concombre") -}}
    {{- $conversionRule = "un concombre = 200 gr." -}}
  {{- else if $isLevureChimique -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "unite_levure_chimique") -}}
    {{- $conversionRule = "une levure chimique = 11 gr." -}}
  {{- else if $isCarotte -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "unite_carotte") -}}
    {{- $conversionRule = "une carotte = 125 gr." -}}
  {{- else if $isBetteraveRouge -}}
    {{- $quantiteEq = mul $qFloat (index $conversionRules "unite_betterave_rouge") -}}
    {{- $conversionRule = "une betterave rouge = 250 gr." -}}
  {{- else -}}
    {{- $hasConversion = false -}}
  {{- end -}}
{{- end -}}

{{- /* --- Normalisation des unités standard --- */}}
{{- if not $hasConversion -}}
  {{- if eq $unitLower "kg" -}}
    {{- $quantiteEq = mul $qFloat 1000 -}}
    {{- $unitEq = "gr." -}}
  {{- else if eq $unitLower "l." -}}
    {{- $quantiteEq = mul $qFloat 1000 -}}
    {{- $unitEq = "ml" -}}
  {{- else if eq $unitLower "gr." -}}
    {{- $quantiteEq = $qFloat -}}
    {{- $unitEq = "gr." -}}
  {{- else if eq $unitLower "ml" -}}
    {{- $quantiteEq = $qFloat -}}
    {{- $unitEq = "ml" -}}
  {{- end -}}
{{- else -}}
  {{- $unitEq = $baseUnit -}}
{{- end -}}

{{- return (dict
  "quantiteEq" $quantiteEq
  "unitEq" $unitEq
  "hasConversion" $hasConversion
  "conversionRule" $conversionRule
) -}}
