
{{ define "main" }}


{{- if not hugo.IsProduction -}}
<span class="no-print text-muted">{{ hugo.Environment }} |  Layout : layouts/_default/recettes.html </span>
{{- end -}}


{{- $currentSlug := .File.ContentBaseName -}}
{{- $currentUUID := partialCached "functions/extract-uuid-from-slug.html" $currentSlug $currentSlug -}}
{{ $alerts := partialCached "functions/recette-alerts.html" . $currentUUID }}

{{- /* Calculate ingredients data and auto-regimes early for use in multiple places */}}
{{- $ingredientsIndex := partialCached "functions/ingredients-index.html" "ingredients-index" -}}
{{- $byUUID := $ingredientsIndex.byUUID -}}
{{- $ingredientsData := partial "functions/ingredients-group-builder.html" (dict
  "items" .Params.ingredients
  "byUUID" $byUUID
  "mode" "recette"
) -}}
{{- $groupedIngredients := $ingredientsData.ingredients -}}
{{- $autoRegimes := $ingredientsData.regimes -}}

{{ $linkCMSPage := (path.Join "/sveltia/#/collections/recettes/entries/" (.Type) (.File.ContentBaseName)) }}


<div class="float-start  me-2"></div>
<div class="h1">
  <span class="print-recette-title ">{{ partialCached "components/icon-recette" .Params.categories .Params.categories  }} {{.Title}}</span>
</div>




<div class="row">
  <div class="col-md-6 ">
    {{- if .Params.auteur -}}
    <span class="text-muted fs-5 no-print">une recette de {{ .Params.auteur }}</span>
    {{- end -}}
  </div>



  <div class="">
    <div class="m-2 p-2 fs-5 text-end print-fs-small">
      <span class="me-2">{{ partialCached "content/badge-temperature.html" .Params.temperature .Params.temperature }}
      {{ partialCached "content/badge-cuisson.html" .Params.cuisson .Params.cuisson }}</span>

      {{- if $autoRegimes -}}

        {{- if $autoRegimes.vegan -}}
        <span class="me-2">
          <span >{{ partialCached "content/badge-regime.html" (slice "vegan") "vegan" }}</span>
        {{- else if $autoRegimes.vegetarien -}}
          <span >{{ partialCached "content/badge-regime.html" (slice "vegetarien") "vegetarien" }}</span>
        {{- end -}}
        {{- if $autoRegimes.sans_gluten -}}
          <span >{{ partialCached "content/badge-regime.html" (slice "sans-gluten") "sans-gluten" }}</span>
        {{- end -}}
        {{- if $autoRegimes.sans_lactose -}}
          <span >{{ partialCached "content/badge-regime.html" (slice "sans-lactose") "sans-lactose" }}</span>
        {{- end -}}
      {{- end -}}
        </span>
      {{- if .Params.materiel -}}
        {{ partialCached "content/badge-materiel.html" .Params.materiel (slice .Params.materiel | jsonify) }}
      {{- end -}}
    </div>
  </div>

  {{ with .Params.img }}
  <div class="recipe-banner-parallax no-print">
      <div class="recipe-banner-image-wrapper">
          <img src="{{ . }}" alt="Bannière de la recette " class="img-fluid">
      </div>
  </div>
  {{ end }}

  <div class="printonly my-4">
    <div class=" text-center mb-1">
      <span class="fs-6 fw-bolder">
        Quantité pour <span id="quantityDefined"> {{.Params.plate}}</span> couverts
        {{ with .Params.quantite_desc }}
      </span>
      <span class="text-center printonly ms-2">
        {{.}}
      </span>
      {{ end }}
    </div>
  </div>
</div>

<div class="row mt-3 no-print">
  <div class="col-12 col-md-6 col-lg-6 col-xl-6 no-print">
    {{- if eq .Params.check "Oui" -}}
      <span class="no-print">Cette recette a été testée pour {{.Params.plate}} couverts </span>
      {{- if (.Params.checkfor) -}}
        <span class="no-print">et pour {{.Params.checkfor}} couverts</span>
      {{- end -}}
    {{- else -}}
      <div class="card border-danger shadow mb-3">
        <div class="card-body small">

          <span class="card-text">Les auteur•ices de la recette ne l'ont <strong>pas testé</strong> pour le nombre de couverts indiqué par défaut ({{.Params.plate}}).<span class="no-print"> Merci de <a href="{{$linkCMSPage}}/index">modifier</a> la recette pour indiquer si vous l'avez testé avec succès, ou pour corriger les quantités d'ingrédients indiquées.</span></span>
        </div>
      </div>
    {{- end -}}

    <div class="no-print">
      <span id="quantityInit" style="display:none">{{.Params.plate}}</span>
      <form>
        <div class="input-group my-2">
          <span class="input-group-text" for="amount">Nombre de couverts à servir : </span>
          <input type="number" class="form-control form-control-lg " id="quantityInput" name="quantityInput" value="{{.Params.plate}}" style="flex: 0 1 120px">
        </div>
      </form>
    </div>
  </div>

  {{- with $alerts -}}
   <div class="col-12 col-md-6 col-lg-6 col-xl-6 print-col-2 my-3">
     {{- partialCached "components/recette-alerts.html" (dict "alerts" . "iconSize" "1.2rem" "card" true ) . -}}
   </div>
   {{- end -}}
</div>

  {{ with .Params.description }}
  <div class="row justify-content-center m-3">

    <div class="col-md-8">
      <p class="text-center fst-italic">{{.}}</p>
    </div>
  </div>
  {{ end }}

  {{ with .Params.quantite_desc }}
  <div class="my-2 no-print">
      {{.}}
  </div>
  {{ end }}

{{/* :::INGREDIENTS  */}}

<div class="row mt-4">
  <div class="col-md-4 print-col-30-100">
    <h4><span class="me-2">{{ partialCached "components/icon-svg" (dict "name" "ingredients" "size" "2rem") "ingredients" }}</span> Ingredients </h4>


    {{ partial "components/ingredients-display-pre-grouped.html" (dict
      "ingredientsByType" $groupedIngredients
      "showAllergenIcon" true
      "showComment" true
    )  }}

    <div class="text-muted small">
      {{ partialCached "components/icon-svg" (dict "name" "exclamation-triangle" "size" "1rem") "exclamation-triangle" }} → Allergènes
    </div>
  </div>


{{/* ::: PREPARATION  */}}
    <div class="col-md-8 print-col-70-100">


      <h4><span class="me-2">{{ partialCached "components/icon-svg" (dict "name" "preparation" "size" "2.3rem") "preparation"  }}</span> Préparation</h4>
      <div class="avoid-break-inside">
          <div class="m-auto">
            {{- if .Params.preparation24h -}}
            <div class="border border-danger mb-4">
              <div class="p-3">
                <div class="h5 mt-0 print-fs-medium">A prévoir à l'avance !</div>
                <div>{{ .Params.preparation24h | markdownify }}</div>
              </div>
            </div>
            {{- end -}}
            {{.Params.preparation | markdownify}}
          </div>
      </div>

    {{- if .Params.astuces -}}
    {{- range .Params.astuces -}}
    <div class="card my-2  bg-light">
      <div class="card-body small">
        <div class="fw-bold">Astuce: </div>
        <div>{{ .astuce }}</div>
      </div>
    </div>
    {{- end -}}
    {{- end -}}


  {{/*  Réccupération des backlink : recettes citant celle-ci comme recette alternative  */}}
  {{- $recettesIndex := partialCached "functions/recettes-index.html" "recettes-index-global" -}}
  {{- $byUUIDRecette := $recettesIndex.byUUIDRecette -}}
  {{- /* currentSlug et currentUUID déjà définis plus haut pour le cache */}}
  {{- $backlinks := dict -}}
  {{/*  tableau des recettes alternatives signalées pour eviter les doublons avec les backlinks  */}}
  {{- $recetteAlt := slice -}}

  {{- range $uuid, $meta := $byUUIDRecette -}}
    {{- range $meta.prepAlt -}}
      {{- $altUUID := partialCached "functions/extract-uuid-from-slug.html" .recetteAlt .recetteAlt -}}
      {{- if eq $altUUID $currentUUID -}}
        {{- $backlinks = merge $backlinks (dict $meta.permalink $meta.title) -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

    {{- if  (or .Params.prepAlt $backlinks) -}}
    <div class="card my-5  bg-light no-print">
      <div class="card-body small">
        <div class="card-title fw-bold">Préparation(s) alternative(s): </div>
      {{- range .Params.prepAlt -}}
      {{ $recetteAlt = $recetteAlt | append .recetteAlt }}
        <div>
          {{- $uuidFromSlug := partialCached "functions/extract-uuid-from-slug.html" .recetteAlt .recetteAlt  -}}
          {{- with (index $byUUIDRecette $uuidFromSlug) -}}
          <a id="toBacklink{{.permalink}}"href="{{ .permalink }}">{{.title}}</a>
          {{- end -}}
        </div>
      {{- end -}}
      {{- end -}}

      {{ with $backlinks }}
      <div>
        {{ range $url, $title := . }}
          <div><a href="{{ $url }}">{{ $title }}</a></div>
        {{ end }}
      </div>
      {{ end }}

      </div>
    </div>

    <div class=" no-print mt-4">

      <div class="text-end no-print mb-2" id="edit-recipe-button" style="display: none;">
        <a target="_blank" rel="noopener noreferrer" href="{{- $linkCMSPage -}}/index" class="btn btn-outline-secondary btn-sm">
          <i class="fas fa-edit me-1"></i>Modifier
        </a>
      </div>

    <div class="text-muted small text-end ">
      <span class="me-4">Publié le : {{ .PublishDate.Format "02/01/2006" }}</span>
      <span>Dernière modification : {{ .Lastmod.Format "02/01/2006" }}</span>
    </div>
    </div>

  </div>

{{ with .Params.img }}
<style>
.recipe-banner-parallax {
    position: relative;
    height: 450px;
    overflow: hidden;
    margin-bottom: 2rem;
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.recipe-banner-image-wrapper {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 200%; /* Augmente la hauteur pour permettre le défilement */
    transform: translateZ(0);
    will-change: transform;



    img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }
}

/* Effet parallaxe au scroll */
.recipe-banner-parallax {
    transform: translateZ(0);
    will-change: transform;
}

/* Pour le scroll sur mobile */
@media (max-width: 768px) {
    .recipe-banner-parallax {
        height: 200px;
    }
    .recipe-banner-image-wrapper {
        height: 110%;
    }
}

</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const parallaxElements = document.querySelectorAll('.recipe-banner-parallax');

    if (parallaxElements.length === 0) return;

    // Création d'un IntersectionObserver pour détecter quand l'élément est dans le viewport
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                // L'élément est visible, on active le parallaxe
                entry.target.dataset.active = 'true';

                // Listener pour le scroll
                window.addEventListener('scroll', handleParallax);
                handleParallax(); // Initialisation
            } else {
                // L'élément n'est plus visible, on désactive le parallaxe
                entry.target.dataset.active = 'false';
                window.removeEventListener('scroll', handleParallax);
            }
        });
    }, {
        rootMargin: '0px',
        threshold: 0.1
    });

    parallaxElements.forEach(el => {
        observer.observe(el);
    });

    function handleParallax() {
        parallaxElements.forEach(el => {
            if (el.dataset.active !== 'true') return;

            const scrolled = window.pageYOffset;
            const rate = scrolled * -0.5; // Vitesse de défilement (ajustable)

            const imageWrapper = el.querySelector('.recipe-banner-image-wrapper');
            if (imageWrapper) {
                imageWrapper.style.transform = `translateY(${rate}px)`;
            }
        });
    }

    // Nettoyage à la décharge
    window.addEventListener('beforeunload', () => {
        parallaxElements.forEach(el => {
            if (el.dataset.active === 'true') {
                window.removeEventListener('scroll', handleParallax);
            }
        });
    });
});
</script>

{{ end }}

{{ partialCached "footer/esbuild" (dict "src" "js/quantite.js" "load" "async" "transpile" false) "quantite.js" -}}

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Attendre que les modules soient chargés
  setTimeout(function() {
    if (window.AppwriteClient && window.AppwriteClient.isAuthenticated()) {
      const editButton = document.getElementById('edit-recipe-button');
      if (editButton) {
        editButton.style.display = 'block';
      }
    }
  }, 100);
});
</script>

{{- end -}}
