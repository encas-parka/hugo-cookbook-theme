{{ define "main" }}

{{ if not hugo.IsProduction }}
<span class="no-print text-muted">{{ hugo.Environment }}  | Layout : layouts/recettes/list-optimized.html </span>
{{ end }}

<!-- Charger les données optimisées avec cache -->
{{ partialCached "recettes/filter-options.html" . "filter-options" }}
{{ partialCached "recettes/js-data.html" . "js-data" }}

<div id="app">
  <a href="#" class="scroll-to-top" title="Scroll to top"></a>

  <div class="container">
    <div class="row">
      <div class="col-lg-4 col-md-4 mt-5" :class="{ opacify: disableFilters }">
        <div class="btn btn-warning my-2" @click="resetFilters">Effacer tous les filtres</div>
        
        <div class="filters box">
          <div class="row">
            <div class="col-12">
              <div class="mb-4">
                <select id="MsCategories">
                  <!-- Les options seront générées par JavaScript -->
                </select>
              </div>
            </div>
            
            <div class="col-12">
              <h4>Régimes</h4>
              <div v-for="regime in filterOptions.regimes" :key="regime">
                <label>
                  <input type="checkbox" v-model="filters['regimes']" :value="regime" />
                  <span>[[regime]]</span>
                </label>
              </div>
            </div>
          </div>
        </div>
        
        <div class="filters box">
          <div class="row">
            <div class="col-md-6 mb-3">
              <h4>Testé</h4>
              <div v-for="check in filterOptions.check" :key="check">
                <label v-show="(check === 'Oui')">
                  <input type="checkbox" v-model="filters['check']" :value="check"/>
                  <span>[[check]]</span>
                </label>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <h4>Service</h4>
              <div v-for="temperature in filterOptions.temperature" :key="temperature">
                <label>
                  <input type="checkbox" v-model="filters['temperature']" :value="temperature" />
                  <span>[[temperature]]</span>
                </label>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <h4>Cuisson</h4>
              <div v-for="cuisson in filterOptions.cuisson" :key="cuisson">
                <label>
                  <input type="checkbox" v-model="filters['cuisson']" :value="cuisson" />
                  <span>[[cuisson]]</span>
                </label>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <h4>Saisons</h4>
              <div v-for="saison in filterOptions.saison" :key="saison">
                <label>
                  <input</label> type="checkbox" v-model="filters['saison']" :value="saison" />
                  <span>[[saison]]</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- MultiSelect ingredients -->
        <div class="filters box">
          <div class="row">
            <div class="my-2" v-if="filterOptions.isec && filterOptions.isec.length">
              <select id="MsSec">
                <option v-for="item in filterOptions.isec" :value="item">[[item]]</option>
              </select>
            </div>
            <div class="my-2" v-if="filterOptions.ilof && filterOptions.ilof.length">
              <select id="MsLof">
                <option v-for="item in filterOptions.ilof" :value="item">[[item]]</option>
              </select>
            </div>
            <div class="my-2" v-if="filterOptions.ilegumes && filterOptions.ilegumes.length">
              <select id="MsLegume">
                <option v-for="item in filterOptions.ilegumes" :value="item">[[item]]</option>
              </select>
            </div>
            <div class="my-2" v-if="filterOptions.ianimaux && filterOptions.ianimaux.length">
              <select id="MsAnimaux">
                <option v-for="item in filterOptions.ianimaux" :value="item">[[item]]</option>
              </select>
            </div>
            <div class="my-2" v-if="filterOptions.isucre && filterOptions.isucre.length">
              <select id="MsSucre">
                <option v-for="item in filterOptions.isucre" :value="item">[[item]]</option>
              </select>
            </div>
            <div class="my-2" v-if="filterOptions.ifrais && filterOptions.ifrais.length">
              <select id="MsFrais">
                <option v-for="item in filterOptions.ifrais" :value="item">[[item]]</option>
              </select>
            </div>
            <div class="my-2" v-if="filterOptions.iautres && filterOptions.iautres.length">
              <select id="MsAutres">
                <option v-for="item in filterOptions.iautres" :value="item">[[item]]</option>
              </select>
            </div>
            <div class="my-2" v-if="filterOptions.iepices && filterOptions.iepices.length">
              <select id="MsEpices">
                <option v-for="item in filterOptions.iepices" :value="item">[[item]]</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-8 col-md-8">
        <nav class="nav nav-underline nav-fill my-4">
          {{ if eq .Title "Recettes" }}
            <a class="nav-link active fw-bold" aria-current="page" href="#">Toutes les recettes</a>
          {{else}}
            <a class="nav-link fw-bold" href="/recettes">Toutes les recettes</a>
          {{ end }}

          {{ $thispage := .Title }}
          {{ range  (.Site.GetPage "section" "recettes").Pages }}
            {{ if eq .Title $thispage }}
              <a class="nav-link active fw-bold" aria-current="page" href="#">{{.Title}}</a>
            {{ else }}
               <a class="nav-link fw-bold" href="{{.RelPermalink}}">{{.Title}}</a>
            {{ end }}
          {{ end }}
        </nav>

        <div class="row">
          <div class="input-group my-4">
            <input
              class="form-control"
              type="text"
              v-model="searchQuery"
              placeholder="Rechercher...  (parmis les titres, auteur·ices, spécialités. Désactive les filtres sélectionnés)"
            />
            <button class="btn btn-outline-secondary" type="button" @click="resetSearch">X</button>
          </div>

          <div class="card card-body mb-2 ms-3" v-show="filteredRecipes.length != recipes.length">
            <div class="py-1">
              <span v-show="filteredRecipes.length > 1">
                [[filteredRecipes.length]] recettes correspondent aux critères de recherche:
              </span>
              <span v-show="filteredRecipes.length === 1">
                [[filteredRecipes.length]] reccette correspond aux critères de recherche:
              </span>
              <div v-show="filteredRecipes.length === 0">
                Aucune recette ne correspond aux critères de recherche...
              </div>
            </div>
            <div v-if="searchQuery.length >= 2" class="d-inline">
              <span class="fw-italic text-muted">contient (dans son titre/auteur·ice...): </span> 
              <span class="fw-bold">[[searchQuery]]</span>
            </div>
            <div v-show="searchQuery.length < 2">
              <!-- Affichage des filtres actifs -->
              <template v-for="(filterValues, filterType) in activeFilters">
                <span v-for="(item, index) in filterValues" :key="item" class="d-inline">
                  <span :class="getFilterBadgeClass(filterType)" class="badge mx-1">[[item]]</span>
                  <span class="small" v-show="index+1 != filterValues.length"> ou </span>
                </span>
                <span class="fw-bold" v-show="index+1 != filterValues.length"> et </span>
              </template>
            </div>
            <div class="btn btn-warning my-2 btn-sm" @click="resetFilters">Effacer tous les filtres</div>
          </div>

          <!-- Recettes CARDS -->
          <div
            class="fhide card card-recette my-3 ms-md-3 p-3"
            v-for="(recipe, key) in recipes"
            :key="key"
            :class="{fshow: filteredRecipes.includes(recipe)}"
          >
            <a :href="[[recipe.url]]" class="stretched-link"></a>

            <span class="h4">
              <a :href="[[recipe.url]]"> [[recipe.title]]</a>
            </span>
            <span class="float-end mt-1">
              <span class="badge bg-red">[[recipe.type]]</span>
              <span class="badge bg-green me-1" v-for="categorie in recipe.categories" :key="categorie">[[categorie]]</span>
              <span class="badge bg-pink me-1" v-for="saison in recipe.saison" :key="saison">[[saison]]</span>
              <span class="text-muted small">[[recipe.specialite]]</span>
            </span>
            <div class="small text-muted">
              <span v-if="recipe.auteur">par [[recipe.auteur]] - </span>
              <span v-if="recipe.check === 'Oui'"> testées pour [[recipe.plate]]  
                <span v-if="recipe.checkfor"> à [[recipe.checkfor]]</span> couverts
              </span>
              <span v-else> théoriquement pour [[recipe.plate]] couverts 
                <span class="fw-bold"> (non testé !)</span>
              </span>
            </div>
            <div class="my-3">
              <span v-if="recipe.temperature === 'Chaud'" class="badge bg-orange">Servir Chaud</span>
              <span v-else class="badge bg-blue">Servir Froid</span>
              <span v-if="recipe.cuisson === 'Oui'" class="badge bg-orange">Avec Cuisson</span>
              <span v-else class="badge bg-blue">Sans Cuisson</span>
              <span class="float-end badge bg-grey mx-1" v-for="regime in recipe.regimes" :key="regime">
                [[regime]]
              </span>
            </div>
            <div class="p-2">
              <span class="fw-bold">Ingrédients :</span>
              <span 
                v-for="legumes in recipe.ilegumes" 
                :key="legumes"
                class="small"
                :class="{'fw-bold text-decoration-underline': filters.ilegumes.includes(legumes)}"
              >[[legumes]] - </span>
              <span 
                v-for="sec in recipe.isec" 
                :key="sec" 
                class="small"
                :class="{'fw-bold text-decoration-underline': filters.isec.includes(sec)}"
              >[[sec]] - </span>
              <span 
                v-for="animaux in recipe.ianimaux" 
                :key="animaux"
                class="small"
                :class="{'fw-bold text-decoration-underline': filters.ianimaux.includes(animaux)}"
              >[[animaux]] - </span>
              <span 
                v-for="lof in recipe.ilof" 
                :key="lof" 
                class="small"
                :class="{'fw-bold text-decoration-underline': filters.ilof.includes(lof)}"
              >[[lof]] - </span>
              <span 
                v-for="sucre in recipe.isucre" 
                :key="sucre"
                class="small"
                :class="{'fw-bold text-decoration-underline': filters.isucre.includes(sucre)}"
              >[[sucre]] - </span>
              <span>...</span>
              <div v-if="recipe.materiel && recipe.materiel.length" class="my-1">
                <span class="fw-bold">Matériel :</span>
                <span v-for="materiel in recipe.materiel" :key="materiel" class="small">[[materiel]] - </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{{ $multiselectCss := resources.Get "multiselect/multi-select.css" }}
<link rel="stylesheet" href="{{ $multiselectCss.Permalink }}">

<script>
const app = Vue.createApp({
  delimiters: ['[[', ']]'],
  el: '#app',
  data() {
    return {
      recipes: window.recipesData || [],
      filterOptions: window.filterOptions || {},
      filters: {
        types: [],
        categories: [],
        regimes: [],
        ilegumes: [],
        ianimaux: [],
        isec: [],
        ilof: [],
        isucre: [],
        ifrais: [],
        iepices: [],
        iautres: [],
        cuisson: [],
        temperature: [],
        saison: [],
        check: [],
      },
      searchQuery: '',
      disableFilters: false,
      msInstances: {}
    }
  },

  mounted() {
    this.initializeMultiSelects();
  },

  computed: {
    filteredRecipes() {
      if (this.searchQuery.length > 2) {
        this.disableFilters = true;
        return this.recipes.filter((recipe) => {
          return this.searchQuery.toLowerCase()
            .normalize('NFD')
            .replace(/\p{Diacritic}/gu, '')
            .split(' ')
            .every(term => 
              recipe.title.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').includes(term) ||
              (recipe.auteur && recipe.auteur.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').includes(term)) ||
              (recipe.specialite && recipe.specialite.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').includes(term))
            );
        });
      } else {
        this.disableFilters = false;
        return this.recipes.filter(recipe => {
          return (!this.filters.categories.length || this.hasIntersection(this.filters.categories, recipe.categories)) &&
                 (!this.filters.regimes.length || this.hasIntersection(this.filters.regimes, recipe.regimes)) &&
                 (!this.filters.ilegumes.length || this.hasIntersection(this.filters.ilegumes, recipe.ilegumes)) &&
                 (!this.filters.isec.length || this.hasIntersection(this.filters.isec, recipe.isec)) &&
                 (!this.filters.ianimaux.length || this.hasIntersection(this.filters.ianimaux, recipe.ianimaux)) &&
                 (!this.filters.ilof.length || this.hasIntersection(this.filters.ilof, recipe.ilof)) &&
                 (!this.filters.isucre.length || this.hasIntersection(this.filters.isucre, recipe.isucre)) &&
                 (!this.filters.ifrais.length || this.hasIntersection(this.filters.ifrais, recipe.ifrais)) &&
                 (!this.filters.iepices.length || this.hasIntersection(this.filters.iepices, recipe.iepices)) &&
                 (!this.filters.iautres.length || this.hasIntersection(this.filters.iautres, recipe.iautres)) &&
                 (!this.filters.cuisson.length || this.hasIntersection(this.filters.cuisson, [recipe.cuisson])) &&
                 (!this.filters.temperature.length || this.hasIntersection(this.filters.temperature, [recipe.temperature])) &&
                 (!this.filters.saison.length || this.hasIntersection(this.filters.saison, recipe.saison)) &&
                 (!this.filters.check.length || this.hasIntersection(this.filters.check, [recipe.check]));
        });
      }
    },

    activeFilters() {
      const active = {};
      for (const [key, values] of Object.entries(this.filters)) {
        if (values.length > 0) {
          active[key] = values;
        }
      }
      return active;
    }
  },

  methods: {
    hasIntersection(arr1, arr2) {
      if (!arr2) return false;
      return arr1.some(val => arr2.includes(val));
    },

    initializeMultiSelects() {
      const multiSelectConfigs = [
        { id: 'MsCategories', type: 'categories', placeholder: 'Catégories' },
        { id: 'MsSec', type: 'isec', placeholder: 'Ingrédients Sec (céréales, légumineuses)' },
        { id: 'MsLegume', type: 'ilegumes', placeholder: 'Fruits et Légumes' },
        { id: 'MsAnimaux', type: 'ianimaux', placeholder: 'Viandes et poissons' },
        { id: 'MsLof', type: 'ilof', placeholder: '(LOF) Lait, oeuf, farine, gras' },
        { id: 'MsSucre', type: 'isucre', placeholder: 'Ingrédients sucrés' },
        { id: 'MsFrais', type: 'ifrais', placeholder: 'Frais' },
        { id: 'MsAutres', type: 'iautres', placeholder: 'Autres' },
        { id: 'MsEpices', type: 'iepices', placeholder: 'Épices' }
      ];

      multiSelectConfigs.forEach(config => {
        const select = document.getElementById(config.id);
        if (select && select.options.length > 0) {
          this.msInstances[config.id] = new IconicMultiSelect({
            select: `#${config.id}`,
            placeholder: config.placeholder,
            noResults: `Aucun élément trouvé...`
          });
          
          this.msInstances[config.id].init();
          this.msInstances[config.id].subscribe((e) => {
            this.handleFilterChange(e.action, config.type, e.value);
          });
        }
      });
    },

    handleFilterChange(action, filterType, value) {
      const index = this.filters[filterType].indexOf(value);
      if (action === "ADD_OPTION") {
        if (index === -1) {
          this.filters[filterType].push(value);
        }
      } else if (action === "REMOVE_OPTION") {
        if (index !== -1) {
          this.filters[filterType].splice(index, 1);
        }
      } else if (action === "CLEAR_ALL_OPTIONS") {
        this.filters[filterType] = [];
      }
    },

    getFilterBadgeClass(filterType) {
      const badgeClasses = {
        categories: 'bg-green',
        regimes: 'bg-grey',
        ilegumes: 'bg-green',
        ianimaux: 'bg-grey',
        isec: 'bg-grey',
        ilof: 'bg-grey',
        isucre: 'bg-grey',
        ifrais: 'bg-blue',
        iepices: 'bg-orange',
        iautres: 'bg-purple',
        cuisson: 'bg-orange',
        temperature: 'bg-blue',
        saison: 'bg-pink'
      };
      return badgeClasses[filterType] || 'bg-secondary';
    },

    resetFilters() {
      Object.keys(this.filters).forEach(key => {
        this.filters[key] = [];
      });
      
      Object.values(this.msInstances).forEach(ms => {
        if (ms && ms._clearSelection) {
          ms._clearSelection();
        }
      });
    },

    resetSearch() {
      this.searchQuery = '';
    }
  }
});

app.mount('#app');
</script>

{{ end }}