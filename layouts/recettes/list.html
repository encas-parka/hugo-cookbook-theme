{{ define "main" }}


{{ if not hugo.IsProduction }}
<span class="no-print text-muted">{{ hugo.Environment }}  | Layout : layouts/recettes/list.html </span>
{{ end }}

{{/* Charger l'index global des ingrédients */}}
{{ $ingredientsIndex := partialCached "functions/ingredients-index.html" "ingredients-index" }}
{{ $byUUID := $ingredientsIndex.byUUID }}
{{ $byAllergen := $ingredientsIndex.byAllergen }}

{{- $allRegimesData := dict -}}
{{- $iCategories := slice -}}

  {{- $allIngredientsData := slice -}}

  {{- range $recipe := .RegularPagesRecursive -}}
    {{- if .Title -}}
    {{- $pageKey := .File.UniqueID -}}
    {{- $ingredientsData := partialCached "functions/ingredients-group-builder.html" (dict
      "items" .Params.ingredients
      "byUUID" $byUUID
      "mode" "recette"
    ) .Params.ingredients -}}

    {{- $allIngredientsData = merge $allIngredientsData (dict $pageKey $ingredientsData.ingredients) -}}
    {{- $allRegimesData = merge $allRegimesData (dict $pageKey $ingredientsData.regimes) -}}


    {{- range .Params.categories -}}
      {{- $iCategories = $iCategories | append . -}}
    {{- end -}}
    {{- end -}}


  {{- $iCategories = $iCategories | uniq -}}
  {{- end -}}


<div id="app" v-cloak>
  <div v-if="!isLoaded" class="d-flex justify-content-center align-items-center" style="min-height: 80vh;">
     <div class="spinner-border text-primary" role="status">
       <span class="visually-hidden">Chargement des recettes...</span>
     </div>
   </div>

  <div v-else>
  <a href="#" class="scroll-to-top z-3" title="Scroll to top"></a>

  <div class="">
    <div class="row mx-0 px-0">





      {{/* Filtres - Desktop (colonne gauche) */}}
      <div class="col-lg-4 d-none d-lg-block" :class="{ opacify: disableFilters }">
        <div class="filters-container">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Filtres</h4>
          </div>

          <div class="filters-content">
            {{/* Catégories */}}
            <div class="mb-4">
              <label class="form-label fw-bold">Catégories</label>
              <select id="MsCategories">
                {{- range $iCategories -}}
                <option>{{ . }}</option>
                {{ end }}
              </select>
            </div>

            {{/* Régimes */}}
            <div class="mb-4">
              <label class="form-label fw-bold">Régimes</label>
              <select id="MsRegimes" multiple>
                <option value="vegan">Vegan</option>
                <option value="vegetarien">Végétarien</option>
                <option value="sans-gluten">Sans gluten</option>
                <option value="sans-lactose">Sans lactose</option>
              </select>
            </div>

            {{/* Ingrédients */}}
            <div class="mb-4">
              <label class="form-label fw-bold">Ingrédients</label>
              <select id="MsIngredients" multiple placeholder="Rechercher un ingrédient...">
                <option v-for="(ingredient, index) in allIngredients" :key="`ing-${index}`">[[ ingredient ]]</option>
              </select>
            </div>

            {{/* Testé */}}
            <div class="mb-4">
              <label class="form-label fw-bold d-block">Recettes testées uniquement</label>
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="testedSwitch"
                  v-model="filters.onlyTested"
                />
                <label class="form-check-label" for="testedSwitch">
                  Afficher uniquement les recettes testées
                </label>
              </div>
            </div>

            {{/* Service (Température) */}}
            <div class="mb-4">
              <label for="serviceSelect" class="form-label fw-bold">Service</label>
              <select id="serviceSelect" class="form-select" v-model="filters.temperature">
                <option value="">Indifférent</option>
                <option value="Chaud">Servir chaud</option>
                <option value="Froid">Servir froid</option>
              </select>
            </div>

            {{/* Cuisson */}}
            <div class="mb-4">
              <label for="cuissonSelect" class="form-label fw-bold">Cuisson</label>
              <select id="cuissonSelect" class="form-select" v-model="filters.cuisson">
                <option value="">Indifférent</option>
                <option value="Oui">Avec cuisson</option>
                <option value="Non">Sans cuisson</option>
              </select>
            </div>

            {{/* Saison */}}
            <div class="mb-4">
              <label for="saisonSelect" class="form-label fw-bold">Saison</label>
              <select id="saisonSelect" class="form-select" v-model="filters.saison">
                <option value="">Indifférent</option>
                <option value="Printemps">Printemps</option>
                <option value="Été">Été</option>
                <option value="Automne">Automne</option>
                <option value="Hiver">Hiver</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      {{/* Filtres - Mobile (Offcanvas) */}}
      <div class="offcanvas offcanvas-start d-lg-none" tabindex="-1" id="filtersOffcanvas" aria-labelledby="filtersOffcanvasLabel">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title" id="filtersOffcanvasLabel">
            <i class="fas fa-filter me-2"></i>Filtres
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
          <div class="d-flex justify-content-end mb-3">
            <button class="btn btn-outline-warning btn-sm" @click="resetFilters">
              <i class="fas fa-eraser me-1"></i>Effacer tout
            </button>
          </div>

          {{/* Contenu identique aux filtres desktop */}}
          <div class="filters-content">
            {{/* Catégories Mobile */}}
            <div class="mb-4">
              <label class="form-label fw-bold">Catégories</label>
              <select id="MsCategoriesMobile">
                {{- range $iCategories -}}
                <option>{{ . }}</option>
                {{ end }}
              </select>
            </div>

            {{/* Régimes Mobile */}}
            <div class="mb-4">
              <label class="form-label fw-bold">Régimes</label>
              <select id="MsRegimesMobile" multiple>
                <option value="vegan">Vegan</option>
                <option value="vegetarien">Végétarien</option>
                <option value="sans-gluten">Sans gluten</option>
                <option value="sans-lactose">Sans lactose</option>
              </select>
            </div>

            {{/* Ingrédients Mobile */}}
            <div class="mb-4">
              <label class="form-label fw-bold">Ingrédients</label>
              <select id="MsIngredientsMobile" multiple placeholder="Rechercher un ingrédient...">
                <option v-for="(ingredient, index) in allIngredients" :key="`ingMobile-${index}`">[[ ingredient ]]</option>
              </select>
            </div>

            {{/* Testé Mobile */}}
            <div class="mb-4">
              <label class="form-label fw-bold d-block">Recettes testées uniquement</label>
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="testedSwitchMobile"
                  v-model="filters.onlyTested"
                />
                <label class="form-check-label" for="testedSwitchMobile">
                  Afficher uniquement les recettes testées
                </label>
              </div>
            </div>

            {{/* Service Mobile */}}
            <div class="mb-4">
              <label for="serviceSelectMobile" class="form-label fw-bold">Service</label>
              <select id="serviceSelectMobile" class="form-select" v-model="filters.temperature">
                <option value="">Indifférent</option>
                <option value="Chaud">Servir chaud</option>
                <option value="Froid">Servir froid</option>
              </select>
            </div>

            {{/* Cuisson Mobile */}}
            <div class="mb-4">
              <label for="cuissonSelectMobile" class="form-label fw-bold">Cuisson</label>
              <select id="cuissonSelectMobile" class="form-select" v-model="filters.cuisson">
                <option value="">Indifférent</option>
                <option value="Oui">Avec cuisson</option>
                <option value="Non">Sans cuisson</option>
              </select>
            </div>

            {{/* Saison Mobile */}}
            <div class="mb-4">
              <label for="saisonSelectMobile" class="form-label fw-bold">Saison</label>
              <select id="saisonSelectMobile" class="form-select" v-model="filters.saison">
                <option value="">Indifférent</option>
                <option value="Printemps">Printemps</option>
                <option value="Été">Été</option>
                <option value="Automne">Automne</option>
                <option value="Hiver">Hiver</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      {{/* Contenu principal */}}
      <div class="col-lg-8 mx-0 px-0 ps-2">
        {{/* Navigation des types de recettes */}}
          <nav class="nav nav-underline nav-fill my-4">
            {{ if eq .Title "Recettes" }}
              <a class="nav-link active fw-bold" aria-current="page" href="#">Toutes les recettes</a>
            {{else}}
              <a class="nav-link fw-bold" href="/recettes">Toutes les recettes</a>
            {{ end }}

            {{ $thispage := .Title }}

            {{ range  (.Site.GetPage "section" "recettes").Pages }}
              {{ if eq .Title $thispage }}
                <a class="nav-link active fw-bold" aria-current="page" href="#">{{.Title}}</a>
              {{ else }}
                 <a class="nav-link fw-bold" href="{{.RelPermalink}}">{{.Title}}</a>

              {{ end }}

            {{ end }}

          </nav>
      {{/* Zone de recherche et bouton filtres */}}
        <div class="px-4 mb-4">
          <div class="input-group my-4">
            <input
              id="searchInput"
              class="form-control form-control-lg"
              type="text"
              v-model="searchQuery"
              placeholder="Rechercher... (parmi les titres, auteur·ices, spécialités. Désactive les filtres sélectionnés)"
            />
            <button class="btn btn-outline-secondary" type="button" @click="resetSearch">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-x-icon lucide-square-x"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
            </button>
          </div>

          {{/* Bouton pour afficher les filtres sur mobile */}}
          <div class="d-lg-none mb-3">
            <button
              class="btn btn-outline-primary"
              type="button"
              data-bs-toggle="offcanvas"
              data-bs-target="#filtersOffcanvas"
              aria-controls="filtersOffcanvas"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sliders-horizontal-icon lucide-sliders-horizontal"><line x1="21" x2="14" y1="4" y2="4"/><line x1="10" x2="3" y1="4" y2="4"/><line x1="21" x2="12" y1="12" y2="12"/><line x1="8" x2="3" y1="12" y2="12"/><line x1="21" x2="16" y1="20" y2="20"/><line x1="12" x2="3" y1="20" y2="20"/><line x1="14" x2="14" y1="2" y2="6"/><line x1="8" x2="8" y1="10" y2="14"/><line x1="16" x2="16" y1="18" y2="22"/></svg> <span class="ms-3">Afficher les Filtres</span>
              <span v-show="hasActiveFilters" class="badge bg-danger ms-2">!</span>
            </button>
          </div>

        {{/* Résumé des filtres actifs */}}
        <div class="card card-body mb-3" v-show="filteredRecipes.length != recettes.length">
          <div class="py-1">
             <span v-show="filteredRecipes.length > 1">
              [[filteredRecipes.length]] recettes correspondent aux critères de recherche
            </span>
            <span v-show="filteredRecipes.length === 1">
              [[filteredRecipes.length]] recette correspond aux critères de recherche
            </span>
            <div v-show="filteredRecipes.length === 0">
              Aucune recette ne correspond aux critères de recherche...
            </div>
          </div>

          <div v-if="searchQuery.length >= 2" class="d-inline">
            <span class="fw-italic text-muted">contient (dans son titre/auteur·ice...) : </span>
            <span class="fw-bold">[[searchQuery]]</span>
          </div>

          <div v-show="searchQuery.length < 2">
            <div v-show="filters.categories.length > 0" class="d-inline">
              <span v-for="(item, index) in filters.categories" :key="item" class="d-inline">
                <span class="badge mx-1 bg-success">[[item]]</span>
                <span class="small" v-show="index+1 != filters.categories.length"> ou </span>
              </span>
            </div>

            <div v-show="filters.regimes.length > 0" class="d-inline">
              <span v-for="(item, index) in filters.regimes" :key="item" class="d-inline">
                <span class="badge mx-1 bg-secondary">[[item]]</span>
                <span class="small" v-show="index+1 != filters.regimes.length"> ou </span>
              </span>
            </div>

            <div v-show="filters.temperature !== ''" class="d-inline">
              <span v-if="filters.temperature === 'Chaud'" class="badge mx-1 bg-warning text-dark">Servir Chaud</span>
              <span v-if="filters.temperature === 'Froid'" class="badge mx-1 bg-info">Servir Froid</span>
            </div>

            <div v-if="filters.cuisson !== ''" class="d-inline">
              <span v-if="filters.cuisson === 'Oui'" class="badge mx-1 bg-warning text-dark">Avec Cuisson</span>
              <span v-if="filters.cuisson === 'Non'" class="badge mx-1 bg-info">Sans Cuisson</span>
            </div>

            <div v-if="filters.saison" class="d-inline">
              <span class="badge mx-1 bg-secondary">[[filters.saison]]</span>
            </div>

            <div v-if="filters.ingredients.length > 0" class="d-inline">
              <span v-for="item in filters.ingredients" :key="item" class="d-inline">
                <span class="badge mx-1 bg-success">[[item]]</span>
              </span>
            </div>

            <div v-if="filters.onlyTested === true" class="d-inline">
              <span class="badge mx-1 bg-primary">Recettes testées uniquement</span>
            </div>

            <div class="mt-2 text-end">
              <button class="btn btn-warning btn-sm" @click="resetFilters">
               Effacer tous les filtres <span class="ms-2" ><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-x-icon lucide-square-x"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg></span>
              </button>
            </div>
          </div>
        </div>
        </div>

        {{/* Cards des recettes */}}
        <div
              class="card card-recette my-3 ms-md-3 p-3"
              v-for="(recipe, key) in paginatedRecipes"
              :key="recipe.url"
            >
              <a :href="[[recipe.url]]" class="stretched-link"></a>
              <div class="d-flex justify-content-between align-items-baseline" id="card-header">
                <div id="card-header-left" class="me-3">
                  <span class="h4 my-1">
                    <a :href="[[recipe.url]]"> [[recipe.title]]</a>
                  </span>
                  <div class="small text-muted">
                    <span v-if="recipe.auteur">de [[recipe.auteur]] - </span>
                    <span v-if="recipe.check === 'Oui'"> testée pour [[recipe.plate]]  <span v-if="recipe.checkfor"> à [[recipe.checkfor]]</span> couverts</span>
                    <span v-else> théoriquement pour [[recipe.plate]] couverts <span class="fw-bold"> (non testée !)</span></span>
                  </div>
                </div>
                <div id="card-header-right" class="d-flex-inline align-items-center justify-content-end text-end">
                  <span class="badge bg-purple me-1" v-for="(categorie, index) in recipe.categories" :key="`cat-${key}-${index}`">[[categorie]]</span>
                  <span class="badge bg-teal me-1" v-for="(saison, index) in recipe.saison" :key="`saison-${key}-${index}`">[[saison]]</span>
                  <span class="text-muted small" v-for="(specialite, index) in recipe.specialite" :key="`spec-${key}-${index}`">[[specialite]]</span>
                </div>
              </div>

              <div class="mb-2 mt-1">
                <span v-if="recipe.temperature === 'Chaud'" class="badge bg-red text-light me-1">Servir Chaud</span>
                <span v-else class="badge bg-blue text-dark me-1">Servir Froid</span>
                <span v-if="recipe.cuisson === 'Oui'" class="badge bg-warning text-dark">Avec Cuisson</span>
                <span v-else class="badge bg-info">Sans Cuisson</span>
                <span class="float-end badge bg-green ms-1" v-for="(regime, index) in recipe.regimes" :key="`regime-${key}-${index}`">
                  [[regime]]
                </span>
              </div>

              <div class="p-2">
                <div>
                  <span class="fw-bold me-2">Ingrédients :</span>
                  <span v-for="(ingredient, index) in recipe.ingredients" :key="`ing-${key}-${index}`" class="small" :class="{'fw-bolder text-decoration-underline': filters.ingredients.includes(ingredient)}">
                    [[ingredient]]<span v-if="index < recipe.ingredients.length - 1">, </span>
                  </span>
                </div>
                <div v-if="recipe.materiel && recipe.materiel.length > 0">
                  <span class="fw-bold me-2">Matériel :</span>
                  <span v-for="(item, index) in recipe.materiel" :key="`mat-${key}-${index}`" class="small">
                    [[item]]<span v-if="index < recipe.materiel.length - 1">, </span>
                  </span>
                </div>
              </div>
            </div>

            <!-- Sentinelle pour le lazy loading -->
            <div ref="sentinel" style="height: 50px;"></div>
    </div>
  </div>
</div>
</div>
</div>

<style>
  .opacify {
    opacity: 0.33;
  }

  .filters-container {
    position: sticky;
    top: 20px;
  }

  .form-control-lg {
    font-size: 1.1rem;
  }

  .card-recette:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transition: box-shadow 0.2s ease-in-out;
  }
</style>

{{ $multiselectCss := resources.Get "multiselect/multi-select.css" }}
<link rel="stylesheet" href="{{ $multiselectCss.Permalink }}">

  {{ $fp := resources.Get "flatpickr/flatpickr.min.js" }}
  {{ $fp_fr := resources.Get "flatpickr/l10n/fr.js" }}
  {{ $multiselect := resources.Get "multiselect/multiselectmin.js" }}

  {{ $bundlejs := slice $fp $fp_fr $multiselect | resources.Concat "js/bundle.js" | fingerprint }}

    {{ if or (hugo.IsProduction) (eq (hugo.Environment) "demo") }}
      <script src="{{- $bundlejs.Permalink -}}" integrity="{{ $bundlejs.Data.Integrity }}"></script>

    {{ else }}

      <script src="{{- $fp.Permalink -}}"></script>
      <script src="{{- $fp_fr.Permalink -}}"></script>
      <script src="{{- $multiselect.Permalink -}}"></script>
    {{end}}

{{/*  :::SCRIPT VUE  */}}

<script>
const app = Vue.createApp({
  el: '#app',
  delimiters: ['[[', ']]'],
  data() {
    return {
      // Données générées par Hugo
      allRecettes: [], // Sera peuplé dans mounted() avec la liste complète

      // Données pour la vue et l'interaction
      recettes: [], // Contient uniquement les recettes actuellement affichées
      isLoaded: false,

      // Lazy loading
      pageSize: 20, // Nombre de recettes à charger à chaque fois
      pageNumber: 1, // Page actuelle

      filters: {
        categories: [],
        regimes: [],
        ingredients: [],
        cuisson: '',
        temperature: '',
        saison: '',
        onlyTested: false
      },

      searchQuery: '',
      disableFilters: false,
    }
  },

  watch: {
    // Quand les filtres ou la recherche changent, la liste des recettes filtrées est recalculée.
    // Nous devons réinitialiser la pagination pour afficher les résultats depuis le début.
    filteredRecipes() {
      this.pageNumber = 1; // Reset la pagination
      this.recettes = this.paginatedRecipes; // Met à jour les recettes affichées
    }
  },

  mounted() {
    // On peuple la liste complète des recettes.
    // Cette liste n'est pas réactive pour ne pas surcharger Vue.
    this.allRecettes = [
      {{- range sort .RegularPagesRecursive ".Title" -}}
      {{- if .Title -}}
      {
        title: "{{ .Title }}",
        url: "{{ .RelPermalink }}",
        type: "{{ .Params.type }}",
        auteur: "{{- if .Params.auteur -}} {{ .Params.auteur }} {{- end -}}",
        specialite: "{{- if .Params.specialite -}} {{.Params.specialite}} {{- end -}}",
        plate: "{{.Params.plate}}",
        check: "{{.Params.check}}",
        checkfor: "{{- if .Params.checkfor -}} {{ .Params.checkfor }} {{- end -}}",
        checkrange: ["{{.Params.plate}}", "{{.Params.checkfor}}"],
        saison: [ {{- if .Params.saison -}} {{- range .Params.saison -}} "{{ . }}", {{- end -}} {{- end -}}],
        categories: [ {{- if .Params.categories -}} {{- range sort .Params.categories -}} "{{ . }}",{{- end -}} {{- end -}} ],
        {{- $pageKey := .File.UniqueID -}}
        {{- $regimesData := index $allRegimesData $pageKey -}}
        regimes: [
          {{- with $regimesData -}}
            {{- if .vegan -}} "vegan", {{- end -}}
            {{- if and (not .vegan) .vegetarien -}} "vegetarien", {{- end -}}
            {{- if .sans_gluten -}} "sans-gluten", {{- end -}}
            {{- if .sans_lactose -}} "sans-lactose", {{- end -}}
          {{- end -}}
        ],
        {{- $ingredientsData := index $allIngredientsData $pageKey | default (dict) -}}
        {{- $recipeIngredients := slice -}}
        {{- range $type, $ingredients := $ingredientsData -}}
          {{- range $ingredients -}}
            {{- $recipeIngredients = $recipeIngredients | append .ingredient -}}
          {{- end -}}
        {{- end -}}
        ingredients: [{{- range $i, $ing := $recipeIngredients -}}{{ if $i }}, {{ end }}{{ printf "%q" . | safeJS }}{{- end -}}],
        temperature: "{{ .Params.temperature }}",
        cuisson: "{{ .Params.cuisson }}",
        materiel: [ {{- range .Params.materiel -}}  "{{ . }}", {{- end -}} ]
      },
      {{- end -}}
      {{- end -}}
    ];

    this.recettes = this.paginatedRecipes; // Charge le premier lot de recettes
    this.isLoaded = true; // Affiche l'application
    // On attend que Vue ait fini de mettre à jour le DOM pour exécuter le reste du code.
    this.$nextTick(() => {
      this.setupIntersectionObserver();
      this.initAllMultiselects();
      document.getElementById('searchInput').focus();
    });
  },

  computed: {
    // 1. Applique les filtres sur la totalité des recettes
    filteredRecipes() {
      if(this.searchQuery.length > 2){
        this.disableFilters = true;
         return this.allRecettes.filter((i) => {
          return this.searchQuery.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').split(' ').every(
          v => i.title.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').includes(v) ||
          i.auteur.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').includes(v) ||
          i.specialite.toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').includes(v)
          );
        })
      } else {
        this.disableFilters = false;
        return this.allRecettes.filter(p => {
          const categoryMatch = !this.filters.categories.length || this.arraysHaveCommonItem(this.filters.categories, p.categories);
          const regimeMatch = !this.filters.regimes.length || this.arraysHaveCommonItem(this.filters.regimes, p.regimes);
          const saisonMatch = !this.filters.saison || p.saison.includes(this.filters.saison);
          const ingredientMatch = !this.filters.ingredients.length || this.filters.ingredients.every(ing => p.ingredients.includes(ing));
          const cuissonMatch = !this.filters.cuisson || this.filters.cuisson === p.cuisson;
          const temperatureMatch = !this.filters.temperature || this.filters.temperature === p.temperature;
          const checkMatch = !this.filters.onlyTested || p.check === 'Oui';
          return categoryMatch && regimeMatch && saisonMatch && ingredientMatch && cuissonMatch && temperatureMatch && checkMatch;
        });
      }
    },

    // 2. Prend la liste filtrée et n'en retourne qu'une partie pour l'affichage
    paginatedRecipes() {
      const end = this.pageNumber * this.pageSize;
      return this.filteredRecipes.slice(0, end);
    },

    allIngredients() {
      // Doit maintenant être calculé sur la liste complète
      const allValues = this.allRecettes.flatMap(item => item['ingredients'] || []);
      return [...new Set(allValues)].filter(Boolean);
    },

    hasActiveFilters() {
      return this.filters.categories.length > 0 ||
             this.filters.regimes.length > 0 ||
             this.filters.ingredients.length > 0 ||
             this.filters.cuisson ||
             this.filters.temperature ||
             this.filters.saison ||
             this.filters.onlyTested;
    },
  },

  methods: {
    loadMoreRecipes() {
      // S'il y a encore des recettes à charger
      if (this.paginatedRecipes.length < this.filteredRecipes.length) {
        this.pageNumber++;
        // On ne remplace pas, on ajoute les nouvelles recettes à la suite
        this.recettes = this.paginatedRecipes;
      }
    },

    setupIntersectionObserver() {
      const options = {
        root: null, // par rapport au viewport
        rootMargin: '0px',
        threshold: 0.1 // se déclenche quand 10% de l'élément est visible
      };
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            // L'élément sentinelle est visible, on charge plus de recettes
            this.loadMoreRecipes();
          }
        });
      }, options);

      // On observe l'élément sentinelle défini dans le template via ref="sentinel"
      observer.observe(this.$refs.sentinel);
    },

    setupMultiselect(config) {
      if (document.getElementById(config.id)) {
        const instance = new IconicMultiSelect({
          select: `#${config.id}`,
          placeholder: config.placeholder,
          noResults: config.noResults
        });
        instance.init();
        instance.subscribe((e) => {
          this.selectedIng(e.action, config.filterKey, e.value);
        });
        return instance;
      }
      return null;
    },

    initAllMultiselects() {
      this.msCategories = this.setupMultiselect({ id: 'MsCategories', filterKey: 'categories', placeholder: 'Sélectionner des catégories', noResults: 'Aucune catégorie trouvée...' });
      this.msRegimes = this.setupMultiselect({ id: 'MsRegimes', filterKey: 'regimes', placeholder: 'Sélectionner des régimes', noResults: 'Aucun régime trouvé...' });
      this.msIngredients = this.setupMultiselect({ id: 'MsIngredients', filterKey: 'ingredients', placeholder: 'Filtrer par ingrédients (ET)', noResults: 'Aucun ingrédient trouvé...' });

      this.msCategoriesMobile = this.setupMultiselect({ id: 'MsCategoriesMobile', filterKey: 'categories', placeholder: 'Sélectionner des catégories', noResults: 'Aucune catégorie trouvée...' });
      this.msRegimesMobile = this.setupMultiselect({ id: 'MsRegimesMobile', filterKey: 'regimes', placeholder: 'Sélectionner des régimes', noResults: 'Aucun régime trouvé...' });
      this.msIngredientsMobile = this.setupMultiselect({ id: 'MsIngredientsMobile', filterKey: 'ingredients', placeholder: 'Filtrer par ingrédients (ET)', noResults: 'Aucun ingrédient trouvé...' });
    },

    arraysHaveCommonItem(arr1, arr2) {
      return arr1.some(item => arr2.includes(item));
    },

    resetFilters: function () {
      this.filters.regimes = [];
      this.filters.categories = [];
      this.filters.cuisson = '';
      this.filters.temperature = '';
      this.filters.saison = '';
      this.filters.onlyTested = false;
      this.filters.ingredients = [];

      // Reset multiselects
      if (this.msIngredients) this.msIngredients._clearSelection();
      if (this.msCategories) this.msCategories._clearSelection();
      if (this.msRegimes) this.msRegimes._clearSelection();
      if (this.msIngredientsMobile) this.msIngredientsMobile._clearSelection();
      if (this.msCategoriesMobile) this.msCategoriesMobile._clearSelection();
      if (this.msRegimesMobile) this.msRegimesMobile._clearSelection();
    },

    resetSearch: function () {
      this.searchQuery = '';
    },

    selectedIng: function (action, itype, value) {
      const index = this.filters[itype].indexOf(value);
      if (action === "ADD_OPTION" && index === -1) {
        this.filters[itype].push(value);
      } else if (action === "REMOVE_OPTION" && index > -1) {
        this.filters[itype].splice(index, 1);
      } else if (action === "CLEAR_ALL_OPTIONS") {
        this.filters[itype] = [];
      }
    }
  }
});

  app.mount('#app')

</script>

{{ end }}
