{{- $parentDir := path.Base .File.Dir -}}
{{- $uuid := replaceRE "^.*_([a-z0-9]+)$" "$1" $parentDir -}}
{{- $ingredientsIndex := partialCached "functions/ingredients-index.html" "ingredients-index" -}}
{{- $byUUID := $ingredientsIndex.byUUID -}}

{{/* Construction manuelle du JSON pour Ã©viter l'aplatissement des tableaux par Hugo */}}
{
  "uuid": {{ $uuid | jsonify }},
  "title": {{ .Title | jsonify }},
  "plate": {{ .Params.plate }},
  "ingredients": [
    {{- $first := true -}}
    {{- range .Params.ingredients -}}
      {{- if not $first -}},{{ end -}}
      {{- $first = false -}}
      {{- $ingPath := .ingredient -}}
      {{- $ingUUID := replaceRE "^.*_([a-z0-9]+)$" "$1" $ingPath -}}
      {{- $ingData := index $byUUID $ingUUID -}}
      {{- $ingName := "" -}}
      {{- if $ingData -}}
        {{- $ingName = $ingData.title -}}
      {{- end -}}
      {{- $conversion := partial "functions/quantite-converter.html" (dict 
        "quantite" .quantite 
        "unit" .unit 
        "ingredient" $ingName
      ) -}}
      {{- $allergenes := slice -}}
      {{- $ingType := "" -}}
      {{- if $ingData -}}
        {{- $allergenes = $ingData.allergenes | default (slice) -}}
        {{- $ingType = $ingData.type | default "" -}}
      {{- end -}}
      {{- $comment := "" -}}
      {{- if .commentaire -}}
        {{- $comment = .commentaire -}}
      {{- end -}}
[{{ $ingUUID | jsonify }}, {{ .quantite }}, {{ .unit | jsonify }}, {{ $conversion.quantiteEq }}, {{ $conversion.unitEq | jsonify }}, {{ $comment | jsonify }}, {{ $allergenes | jsonify }}, {{ $ingType | jsonify }}]
    {{- end -}}
  ],
  "preparation": {{ .Params.preparation | jsonify }}
}

