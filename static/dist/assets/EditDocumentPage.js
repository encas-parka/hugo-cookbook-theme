import{aK as Re,as as $e,b as et,t as tt,P as at,e as rt}from"./icons.js";import{d as Ie,p as st,V as m,g as a,h as l,W as N,_ as Ee,b as o,c as Be,Z as Ce,q as b,Y as nt,ag as ot,ah as Le,a1 as ge,k as z,a2 as w,y as x,C as q,a0 as pe,m as e,u as y,v as r,A as it,X as ee,j as Pe,a9 as Te,e as lt,i as dt}from"./appwrite.js";import{t as I,n as Se}from"./index.js";import{M as ct}from"./MarkdownEditorAdvanced.js";import{B as ut}from"./BtnGroupCheck.js";import{U as vt}from"./UnsavedChangesGuard.js";import{S as mt}from"./SvelteMarkdown.js";import"./tiptap-markdown.es.js";import"./CheckboxBadge.js";var ft=(L,d)=>d("edit"),gt=(L,d)=>d("preview"),pt=m('<div class="rounded-box bg-secondary/10 px-4 py-1"><div class="tabs tabs-border justify-center"><button><!> Édition</button> <button><!> Aperçu</button></div></div>');function _t(L,d){Ie(d,!0);let H=st(d,"disabled",3,!1);function J(k){H()||d.onModeChange(k)}var B=pt(),c=a(B),i=a(c);let g;i.__click=[ft,J];var h=a(i);Re(h,{class:"h-4 w-4"});var n=l(i,2);let P;n.__click=[gt,J];var C=a(n);$e(C,{class:"h-4 w-4"}),N((k,T)=>{g=Ee(i,1,"tab gap-2 font-semibold",null,g,k),i.disabled=H(),P=Ee(n,1,"tab gap-2 font-semibold",null,P,T)},[()=>({"tab-active":d.mode==="edit"}),()=>({"tab-active":d.mode==="preview"})]),o(L,B),Be()}Ce(["click"]);function bt(L,d){L.key==="Enter"&&(L.preventDefault(),d())}var yt=m('<span class="loading loading-spinner loading-sm"></span>'),ht=m('<button class="btn btn-primary"><!> Enregistrer</button>'),wt=m('<div class="flex items-center gap-2"><!></div>'),xt=m('<div class="alert alert-warning max-md:alert-vertical mb-4"><!> <div><h4 class="font-bold">Document verrouillé</h4> <p class="text-sm">Ce document est actuellement édité par <span class="font-bold"> </span> . Vous ne pouvez pas le modifier pour le moment.</p></div></div>'),kt=m('<div class="flex justify-center py-20"><div class="loading loading-spinner loading-lg"></div></div>'),Dt=m("<div><!></div>"),Et=m('<fieldset class="fieldset flex"><label class="input input-lg w-full"><span class="label">Nom</span> <input type="text" placeholder="Titre du document" maxlength="50" required/></label></fieldset> <fieldset class="fieldset"><!></fieldset> <fieldset class="fieldset"><legend class="fieldset-legend">Tags</legend> <div class="flex flex-wrap items-center gap-x-6 gap-y-2"><!> <label class="input w-80"><input type="text" placeholder="Nouveau tag..." maxlength="30"/> <button class="btn btn-primary btn-sm"><!> Ajouter</button></label></div></fieldset>',1),Lt=m('<div class="flex items-center gap-2"><!> <span>Chargement...</span></div>'),Pt=m('<span class="badge badge-secondary badge-soft"> </span>'),Tt=m('<div class="flex flex-wrap items-center justify-between gap-x-4 gap-y-2"><h1 class="text-2xl font-bold"> </h1> <p class="text-sm opacity-70">Équipe : <span class="font-medium"> </span></p></div> <div class="flex flex-wrap gap-2"></div>',1),St=m('<p class="text-sm opacity-70">Aucun contenu</p>'),It=m('<div class="mb-6 flex items-center justify-between"><div class="flex-1"><!></div></div> <div class="prose bg-base-100 border-grey-400 max-w-none rounded-lg border p-6"><!></div>',1),Bt=m('<div class="space-y-4"><!></div>'),Ct=m('<div class="mx-auto max-w-5xl p-4" role="region" tabindex="-1"><!> <!></div> <!>',1);function Ut(L,d){Ie(d,!0);const H=t=>{var s=wt(),p=a(s);{var j=D=>{var E=ht();E.__click=se;var K=a(E);{var ie=f=>{var A=yt();o(f,A)},le=f=>{tt(f,{class:"h-4 w-4"})};w(K,f=>{e(T)?f(ie):f(le,!1)})}N(()=>E.disabled=!e(Y)||!e(ye)||e(T)),o(D,E)};w(p,D=>{e(V)==="edit"&&D(j)})}o(t,s)},J=t=>{_t(t,{get mode(){return e(V)},get disabled(){return e(X)},onModeChange:s=>r(V,s,!0)})};let B=y(()=>d.params.teamId),c=y(()=>d.params.docId),i=b(null),g=b(""),h=b(""),n=b(nt([])),P=b(""),C=b(!1),k=b(!0),T=b(!1),S=b(null),G=b(""),W=null,te=b(""),V=b("preview"),ae=y(()=>it.myTeams.find(t=>t.$id===e(B))),_e=y(()=>{const t=I.getTeamTags(e(B)),s=new Set([...t,...e(n)]);return Array.from(s).map(p=>({id:p,label:p,selected:e(n).includes(p)}))});const be=y(()=>JSON.stringify({title:e(g),content:e(h),tags:e(n),isPublic:e(C)})!==e(te)),X=y(()=>!!e(S)&&e(S)!==x.userId),re=y(()=>!!e(S)&&e(S)===x.userId),Y=y(()=>!e(X)&&!e(k)&&!e(T)),ye=y(()=>e(g).trim().length>0&&e(ae)!==void 0);async function Ae(){if(!e(c)||!x.userId||!e(i))return!1;try{const t=e(i).lockedBy,s=e(i).$updatedAt?new Date(e(i).$updatedAt):null,p=s&&Date.now()-s.getTime()>3e5;if(t&&t!==x.userId)if(p)console.log("[EditDocumentPage] Verrou précédent expiré, reprise de contrôle...");else return r(S,t,!0),console.warn("[EditDocumentPage] Document déjà verrouillé"),!1;return await I.updateDocumentLock(e(c),x.userId),r(S,x.userId,!0),r(G,x.userName||"",!0),Me(),console.log(`[EditDocumentPage] Lock acquis pour ${e(c)}`),!0}catch(t){return console.error("[EditDocumentPage] Erreur acquisition lock:",t),q.error("Impossible de verrouiller le document"),!1}}function Me(){he(),W=setInterval(async()=>{if(e(S)===x.userId&&e(c))try{await I.updateDocumentLock(e(c),x.userId),console.log(`[EditDocumentPage] Heartbeat envoyé pour ${e(c)}`)}catch(t){console.error("[EditDocumentPage] Erreur heartbeat:",t)}},12e4)}function he(){W&&(clearInterval(W),W=null)}async function qe(){if(e(c)&&(he(),e(re)))try{await I.updateDocumentLock(e(c),null),r(S,null),r(G,""),console.log(`[EditDocumentPage] Lock libéré pour ${e(c)}`)}catch(t){console.error("[EditDocumentPage] Erreur libération lock:",t)}}ot(async()=>{if(!x.userId){q.error("Vous devez être connecté"),pe("/");return}if(!e(ae)){q.error("Équipe introuvable"),pe("/");return}I.isInitialized||await I.initialize(),r(k,!0);try{const t=I.getDocumentById(e(c));if(!t){q.error("Document introuvable"),pe(`/teams/${e(B)}`);return}r(i,t,!0),r(g,t.title||"",!0),r(h,t.content||"",!0),r(n,t.tags||[],!0),r(C,t.isPublic||!1,!0),r(te,JSON.stringify({title:e(g),content:e(h),tags:e(n),isPublic:e(C)}),!0),await Ae()}catch(t){console.error("[EditDocumentPage] Erreur chargement document:",t),q.error("Erreur lors du chargement du document")}finally{r(k,!1)}}),Le(async()=>{await qe()}),ge(()=>{const t=s=>{e(be)&&e(re)&&(s.preventDefault(),s.returnValue="")};return window.addEventListener("beforeunload",t),()=>window.removeEventListener("beforeunload",t)});function we(){const t=e(P).trim().toLowerCase();t&&!e(n).includes(t)&&(r(n,[...e(n),t],!0),r(P,""))}function ze(t){e(n).includes(t)?r(n,e(n).filter(s=>s!==t),!0):r(n,[...e(n),t],!0)}async function se(){if(!(!e(ye)||e(T)||!e(i))){r(T,!0);try{await I.updateDocument(e(c),{title:e(g).trim(),content:e(h),tags:e(n).length>0?e(n):null,isPublic:e(C)}),r(te,JSON.stringify({title:e(g),content:e(h),tags:e(n),isPublic:e(C)}),!0),q.success("Document enregistré avec succès")}catch(t){console.error("[EditDocumentPage] Erreur sauvegarde:",t),q.error("Erreur lors de la sauvegarde du document")}finally{r(T,!1)}}}function ne(t){(t.ctrlKey||t.metaKey)&&t.key==="s"&&(t.preventDefault(),se())}const Ne=y(()=>e(i)?`Document: ${e(i).title}`:"Modifier le document"),Ve=y(()=>e(V)==="edit"?0:1);ge(()=>{Se.setConfig({title:e(Ne),actions:H,tabs:J,eventId:e(c),activeTab:e(Ve),isLockedByOthers:e(X),lockedByUserName:e(G)})}),Le(()=>{Se.reset()}),ge(()=>(window.addEventListener("keydown",ne),()=>window.removeEventListener("keydown",ne)));var xe=Ct(),oe=z(xe);oe.__keydown=ne;var ke=a(oe);{var je=t=>{var s=xt(),p=a(s);et(p,{class:"h-5 w-5"});var j=l(p,2),D=l(a(j),2),E=l(a(D)),K=a(E);N(()=>ee(K,e(G)||"un autre utilisateur")),o(t,s)};w(ke,t=>{e(X)&&t(je)})}var Ke=l(ke,2);{var Oe=t=>{var s=kt();o(t,s)},Ue=t=>{var s=Pe(),p=z(s);{var j=D=>{var E=Bt(),K=a(E);{var ie=f=>{var A=Et(),O=z(A),de=a(O),Z=l(a(de),2),F=l(O,2),ce=a(F);ct(ce,{placeholder:"Commencez à rédiger votre document...",get value(){return e(h)},set value(v){r(h,v,!0)}});var ue=l(F,2),ve=l(a(ue),2),Q=a(ve);{var me=v=>{var U=Dt(),R=a(U);ut(R,{get items(){return e(_e)},onToggleItem:$=>ze($),size:"md",showStats:!1}),o(v,U)};w(Q,v=>{e(_e).length>0&&v(me)})}var u=l(Q,2),_=a(u);_.__keydown=[bt,we];var M=l(_,2);M.__click=we;var fe=a(M);at(fe,{class:"h-4 w-4"}),N(v=>{Z.disabled=!e(Y),_.disabled=!e(Y),M.disabled=v},[()=>!e(Y)||!e(P).trim()]),Te(Z,()=>e(g),v=>r(g,v)),Te(_,()=>e(P),v=>r(P,v)),o(f,A)},le=f=>{var A=It(),O=z(A),de=a(O),Z=a(de);{var F=u=>{var _=Lt(),M=a(_);rt(M,{class:"h-5 w-5 animate-spin"}),o(u,_)},ce=u=>{var _=Pe(),M=z(_);{var fe=v=>{var U=Tt(),R=z(U),$=a(R),Je=a($),Ge=l($,2),We=l(a(Ge)),Xe=a(We),Ye=l(R,2);lt(Ye,21,()=>e(n),dt,(Ze,Fe)=>{var De=Pt(),Qe=a(De);N(()=>ee(Qe,`#${e(Fe)??""}`)),o(Ze,De)}),N(()=>{ee(Je,e(g)),ee(Xe,e(ae)?.name)}),o(v,U)};w(M,v=>{e(i)&&v(fe)},!0)}o(u,_)};w(Z,u=>{e(k)?u(F):u(ce,!1)})}var ue=l(O,2),ve=a(ue);{var Q=u=>{mt(u,{get source(){return e(h)}})},me=u=>{var _=St();o(u,_)};w(ve,u=>{e(h)?u(Q):u(me,!1)})}o(f,A)};w(K,f=>{e(V)==="edit"?f(ie):f(le,!1)})}o(D,E)};w(p,D=>{e(i)&&D(j)},!0)}o(t,s)};w(Ke,t=>{e(k)?t(Oe):t(Ue,!1)})}var He=l(oe,2);{let t=y(()=>`editdocument/${e(B)}/${e(c)}`);vt(He,{get routeKey(){return e(t)},shouldProtect:()=>e(be)&&e(re),onLeaveWithoutSave:()=>{},onSaveAndLeave:async()=>(await se(),!0),message:"Vous avez des modifications non sauvegardées. Voulez-vous quitter sans enregistrer ?"})}o(L,xe),Be()}Ce(["click","keydown"]);export{Ut as default};
