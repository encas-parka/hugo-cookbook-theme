import{x as Se,j as Re,W as m,A as a,B as l,X as j,_ as Ee,v as o,w as Be,Z as Ae,s as b,p as $e,a9 as et,aa as Le,b as ge,E as N,$ as w,g as e,u as y,a as r,Y as ee,D as Pe,a1 as Te,au as tt,o as at,z as rt}from"./vendor.js";import{t as S,n as Ie}from"./index.js";import{a as x,t as M,y as pe,n as st}from"./appwrite.js";import{M as nt}from"./MarkdownEditorAdvanced.js";import{B as ot}from"./BtnGroupCheck.js";import{U as it}from"./UnsavedChangesGuard.js";import{aK as lt,as as dt,b as ct,r as ut,P as vt,e as mt}from"./icons.js";import"./editor.js";import"./markdown.js";import"./CheckboxBadge.js";var ft=(L,d)=>d("edit"),gt=(L,d)=>d("preview"),pt=m('<div class="rounded-box bg-secondary/10 px-4 py-1"><div class="tabs tabs-border justify-center"><button><!> Édition</button> <button><!> Aperçu</button></div></div>');function _t(L,d){Se(d,!0);let H=Re(d,"disabled",3,!1);function J(k){H()||d.onModeChange(k)}var B=pt(),c=a(B),i=a(c);let g;i.__click=[ft,J];var h=a(i);lt(h,{class:"h-4 w-4"});var n=l(i,2);let P;n.__click=[gt,J];var A=a(n);dt(A,{class:"h-4 w-4"}),j((k,T)=>{g=Ee(i,1,"tab gap-2 font-semibold",null,g,k),i.disabled=H(),P=Ee(n,1,"tab gap-2 font-semibold",null,P,T)},[()=>({"tab-active":d.mode==="edit"}),()=>({"tab-active":d.mode==="preview"})]),o(L,B),Be()}Ae(["click"]);function bt(L,d){L.key==="Enter"&&(L.preventDefault(),d())}var yt=m('<span class="loading loading-spinner loading-sm"></span>'),ht=m('<button class="btn btn-primary"><!> Enregistrer</button>'),wt=m('<div class="flex items-center gap-2"><!></div>'),xt=m('<div class="alert alert-warning mb-4"><!> <div><h4 class="font-bold">Document verrouillé</h4> <p class="text-sm">Ce document est actuellement édité par <span class="font-bold"> </span> . Vous ne pouvez pas le modifier pour le moment.</p></div></div>'),kt=m('<div class="flex justify-center py-20"><div class="loading loading-spinner loading-lg"></div></div>'),Dt=m("<div><!></div>"),Et=m('<fieldset class="fieldset flex"><label class="input input-lg w-full"><span class="label">Nom</span> <input type="text" placeholder="Titre du document" maxlength="50" required/></label></fieldset> <fieldset class="fieldset"><!></fieldset> <fieldset class="fieldset"><legend class="fieldset-legend">Tags</legend> <div class="flex flex-wrap items-center gap-x-6 gap-y-2"><!> <label class="input w-80"><input type="text" placeholder="Nouveau tag..." maxlength="30"/> <button class="btn btn-primary btn-sm"><!> Ajouter</button></label></div></fieldset>',1),Lt=m('<div class="flex items-center gap-2"><!> <span>Chargement...</span></div>'),Pt=m('<span class="badge badge-secondary badge-soft"> </span>'),Tt=m('<div class="flex flex-wrap items-center justify-between gap-x-4 gap-y-2"><h1 class="text-2xl font-bold"> </h1> <p class="text-sm opacity-70">Équipe : <span class="font-medium"> </span></p></div> <div class="flex flex-wrap gap-2"></div>',1),It=m('<p class="text-sm opacity-70">Aucun contenu</p>'),St=m('<div class="mb-6 flex items-center justify-between"><div class="flex-1"><!></div></div> <div class="prose bg-base-100 border-grey-400 max-w-none rounded-lg border p-6"><!></div>',1),Bt=m('<div class="space-y-4"><!></div>'),At=m('<div class="mx-auto max-w-5xl p-4" role="region" tabindex="-1"><!> <!></div> <!>',1);function Ht(L,d){Se(d,!0);const H=t=>{var s=wt(),p=a(s);{var V=D=>{var E=ht();E.__click=se;var K=a(E);{var ie=f=>{var C=yt();o(f,C)},le=f=>{ut(f,{class:"h-4 w-4"})};w(K,f=>{e(T)?f(ie):f(le,!1)})}j(()=>E.disabled=!e(Y)||!e(ye)||e(T)),o(D,E)};w(p,D=>{e(q)==="edit"&&D(V)})}o(t,s)},J=t=>{_t(t,{get mode(){return e(q)},get disabled(){return e(X)},onModeChange:s=>r(q,s,!0)})};let B=y(()=>d.params.teamId),c=y(()=>d.params.docId),i=b(null),g=b(""),h=b(""),n=b($e([])),P=b(""),A=b(!1),k=b(!0),T=b(!1),I=b(null),G=b(""),W=null,te=b(""),q=b("preview"),ae=y(()=>st.myTeams.find(t=>t.$id===e(B))),_e=y(()=>{const t=S.getTeamTags(e(B)),s=new Set([...t,...e(n)]);return Array.from(s).map(p=>({id:p,label:p,selected:e(n).includes(p)}))});const be=y(()=>JSON.stringify({title:e(g),content:e(h),tags:e(n),isPublic:e(A)})!==e(te)),X=y(()=>!!e(I)&&e(I)!==x.userId),re=y(()=>!!e(I)&&e(I)===x.userId),Y=y(()=>!e(X)&&!e(k)&&!e(T)),ye=y(()=>e(g).trim().length>0&&e(ae)!==void 0);async function Ce(){if(!e(c)||!x.userId||!e(i))return!1;try{const t=e(i).lockedBy,s=e(i).$updatedAt?new Date(e(i).$updatedAt):null,p=s&&Date.now()-s.getTime()>3e5;if(t&&t!==x.userId)if(p)console.log("[EditDocumentPage] Verrou précédent expiré, reprise de contrôle...");else return r(I,t,!0),console.warn("[EditDocumentPage] Document déjà verrouillé"),!1;return await S.updateDocumentLock(e(c),x.userId),r(I,x.userId,!0),r(G,x.userName||"",!0),ze(),console.log(`[EditDocumentPage] Lock acquis pour ${e(c)}`),!0}catch(t){return console.error("[EditDocumentPage] Erreur acquisition lock:",t),M.error("Impossible de verrouiller le document"),!1}}function ze(){he(),W=setInterval(async()=>{if(e(I)===x.userId&&e(c))try{await S.updateDocumentLock(e(c),x.userId),console.log(`[EditDocumentPage] Heartbeat envoyé pour ${e(c)}`)}catch(t){console.error("[EditDocumentPage] Erreur heartbeat:",t)}},12e4)}function he(){W&&(clearInterval(W),W=null)}async function Me(){if(e(c)&&(he(),e(re)))try{await S.updateDocumentLock(e(c),null),r(I,null),r(G,""),console.log(`[EditDocumentPage] Lock libéré pour ${e(c)}`)}catch(t){console.error("[EditDocumentPage] Erreur libération lock:",t)}}et(async()=>{if(!x.userId){M.error("Vous devez être connecté"),pe("/");return}if(!e(ae)){M.error("Équipe introuvable"),pe("/");return}S.isInitialized||await S.initialize(),r(k,!0);try{const t=S.getDocumentById(e(c));if(!t){M.error("Document introuvable"),pe(`/teams/${e(B)}`);return}r(i,t,!0),r(g,t.title||"",!0),r(h,t.content||"",!0),r(n,t.tags||[],!0),r(A,t.isPublic||!1,!0),r(te,JSON.stringify({title:e(g),content:e(h),tags:e(n),isPublic:e(A)}),!0),await Ce()}catch(t){console.error("[EditDocumentPage] Erreur chargement document:",t),M.error("Erreur lors du chargement du document")}finally{r(k,!1)}}),Le(async()=>{await Me()}),ge(()=>{const t=s=>{e(be)&&e(re)&&(s.preventDefault(),s.returnValue="")};return window.addEventListener("beforeunload",t),()=>window.removeEventListener("beforeunload",t)});function we(){const t=e(P).trim().toLowerCase();t&&!e(n).includes(t)&&(r(n,[...e(n),t],!0),r(P,""))}function Ne(t){e(n).includes(t)?r(n,e(n).filter(s=>s!==t),!0):r(n,[...e(n),t],!0)}async function se(){if(!(!e(ye)||e(T)||!e(i))){r(T,!0);try{await S.updateDocument(e(c),{title:e(g).trim(),content:e(h),tags:e(n).length>0?e(n):null,isPublic:e(A)}),r(te,JSON.stringify({title:e(g),content:e(h),tags:e(n),isPublic:e(A)}),!0),M.success("Document enregistré avec succès")}catch(t){console.error("[EditDocumentPage] Erreur sauvegarde:",t),M.error("Erreur lors de la sauvegarde du document")}finally{r(T,!1)}}}function ne(t){(t.ctrlKey||t.metaKey)&&t.key==="s"&&(t.preventDefault(),se())}const je=y(()=>e(i)?`Document: ${e(i).title}`:"Modifier le document"),qe=y(()=>e(q)==="edit"?0:1);ge(()=>{Ie.setConfig({title:e(je),actions:H,tabs:J,eventId:e(c),activeTab:e(qe),isLockedByOthers:e(X),lockedByUserName:e(G)})}),Le(()=>{Ie.reset()}),ge(()=>(window.addEventListener("keydown",ne),()=>window.removeEventListener("keydown",ne)));var xe=At(),oe=N(xe);oe.__keydown=ne;var ke=a(oe);{var Ve=t=>{var s=xt(),p=a(s);ct(p,{class:"h-5 w-5"});var V=l(p,2),D=l(a(V),2),E=l(a(D)),K=a(E);j(()=>ee(K,e(G)||"un autre utilisateur")),o(t,s)};w(ke,t=>{e(X)&&t(Ve)})}var Ke=l(ke,2);{var Oe=t=>{var s=kt();o(t,s)},Ue=t=>{var s=Pe(),p=N(s);{var V=D=>{var E=Bt(),K=a(E);{var ie=f=>{var C=Et(),O=N(C),de=a(O),Z=l(a(de),2),F=l(O,2),ce=a(F);nt(ce,{placeholder:"Commencez à rédiger votre document...",get value(){return e(h)},set value(v){r(h,v,!0)}});var ue=l(F,2),ve=l(a(ue),2),Q=a(ve);{var me=v=>{var U=Dt(),R=a(U);ot(R,{get items(){return e(_e)},onToggleItem:$=>Ne($),size:"md",showStats:!1}),o(v,U)};w(Q,v=>{e(_e).length>0&&v(me)})}var u=l(Q,2),_=a(u);_.__keydown=[bt,we];var z=l(_,2);z.__click=we;var fe=a(z);vt(fe,{class:"h-4 w-4"}),j(v=>{Z.disabled=!e(Y),_.disabled=!e(Y),z.disabled=v},[()=>!e(Y)||!e(P).trim()]),Te(Z,()=>e(g),v=>r(g,v)),Te(_,()=>e(P),v=>r(P,v)),o(f,C)},le=f=>{var C=St(),O=N(C),de=a(O),Z=a(de);{var F=u=>{var _=Lt(),z=a(_);mt(z,{class:"h-5 w-5 animate-spin"}),o(u,_)},ce=u=>{var _=Pe(),z=N(_);{var fe=v=>{var U=Tt(),R=N(U),$=a(R),Je=a($),Ge=l($,2),We=l(a(Ge)),Xe=a(We),Ye=l(R,2);at(Ye,21,()=>e(n),rt,(Ze,Fe)=>{var De=Pt(),Qe=a(De);j(()=>ee(Qe,`#${e(Fe)??""}`)),o(Ze,De)}),j(()=>{ee(Je,e(g)),ee(Xe,e(ae)?.name)}),o(v,U)};w(z,v=>{e(i)&&v(fe)},!0)}o(u,_)};w(Z,u=>{e(k)?u(F):u(ce,!1)})}var ue=l(O,2),ve=a(ue);{var Q=u=>{tt(u,{get source(){return e(h)}})},me=u=>{var _=It();o(u,_)};w(ve,u=>{e(h)?u(Q):u(me,!1)})}o(f,C)};w(K,f=>{e(q)==="edit"?f(ie):f(le,!1)})}o(D,E)};w(p,D=>{e(i)&&D(V)},!0)}o(t,s)};w(Ke,t=>{e(k)?t(Oe):t(Ue,!1)})}var He=l(oe,2);{let t=y(()=>`editdocument/${e(B)}/${e(c)}`);it(He,{get routeKey(){return e(t)},shouldProtect:()=>e(be)&&e(re),onLeaveWithoutSave:()=>{},onSaveAndLeave:async()=>(await se(),!0),message:"Vous avez des modifications non sauvegardées. Voulez-vous quitter sans enregistrer ?"})}o(L,xe),Be()}Ae(["click","keydown"]);export{Ht as default};
