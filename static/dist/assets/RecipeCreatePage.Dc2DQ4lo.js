import{p as Y,b as m,aa as Z,W as w,E as W,$ as C,v as y,w as J,x as O,g as e,s as _,u as f,a as i,B as S,A as b,X as Q,Z as ee,Y as re,D as te}from"./vendor.B7h_mkEd.js";import{C as ae,a as u,t as p,y as A,z as G,D as se,E as ie,F as oe,G as ne,H as ce}from"./appwrite.5W8SCupm.js";import{r as $}from"./RecipeDataStore.svelte.z7daM122.js";import{n as F}from"./index.BUL8Pmq2.js";import{t as ue,c as de,a as U,v as le,n as pe,p as ve,R as me,b as fe,d as ge}from"./RecipeEditPage.Wbcvcfhd.js";import{U as ye}from"./UnsavedChangesGuard.BRtQ8R1q.js";import{r as _e}from"./icons.DKN5kzXq.js";import"./editor.L4rklAfR.js";import"./markdown.BkFahWn2.js";import"./products-display.CZc2PMhO.js";import"./Fieldset.Dv39p1Lh.js";import"./BtnGroupCheck.CHrcq3x2.js";import"./CheckboxBadge.CBrhHJkp.js";var he=w('<div class="flex items-center gap-2"><button class="btn btn-primary"><!> </button></div>'),Re=w('<div class="flex items-center justify-center py-20"><div class="loading loading-spinner loading-lg"></div></div>'),Se=w('<div class="space-y-6"><!> <!> <!></div>'),be=w('<div class="max-w-9xl container mx-auto px-4 py-8"><!></div> <!>',1);function Ce(H,I){O(I,!0);const L=t=>{var a=he(),o=b(a);o.__click=V;var c=b(o);_e(c,{class:"h-4 w-4"});var s=S(c);Q(()=>{o.disabled=e(n)||!e(B),re(s,` ${e(n)?"Sauvegarde...":"Créer la recette"}`)}),y(t,a)},d=f(()=>I.params?.uuid);let r=_(null),l=_(!1),n=_(!1),h=_(null),D=_(!1),x=Y({value:{}});const B=f(()=>!e(r)||!e(h)?!1:U(e(r))!==e(h));m(()=>{e(r)&&e(r).check!==!0&&(e(r).draft=!0)});const E=f(()=>!0),N=f(()=>({materiel:$.materiel,categories:$.categories,regimes:$.regimes}));m(()=>{ae()}),m(()=>{if(!u.userId){p.error("Vous devez être connecté"),A("/");return}}),m(()=>{if(!(e(l)||!u.userId)){if(e(d)&&!e(l)&&!e(n)){i(n,!0),G.getRecipeByUuid(e(d)).then(async t=>{if(t){const a=u.userName||"utilisateur",o=t.rootRecipeId||t.$id,v=`v${(await G.getVariantGroup(e(d))).variants.length+1} - ${a}`;i(r,ue(t,{title:t.title,$id:"new-recipe",$createdAt:void 0,$updatedAt:void 0,lockedBy:null,createdBy:u.userId||"",permissionWrite:[u.userId||""],check:null,draft:!0,rootRecipeId:o,versionLabel:v}),!0),i(l,!0)}else p.error("Recette source introuvable"),A("/recipe")}).catch(t=>{console.error("Erreur chargement:",t),p.error("Erreur lors du chargement"),A("/recipe")}).finally(()=>{i(n,!1)});return}if(!e(d)&&!e(l)){i(r,{...de(),$id:"new-recipe"},!0),i(l,!0);return}}}),m(()=>{e(r)&&e(l)&&!e(h)&&i(h,U(e(r)),!0)});const P=f(()=>e(d)?"Nouvelle version de recette":"Nouvelle recette");m(()=>{F.setConfig({title:e(P),actions:L})}),Z(()=>{F.reset()});async function V(){if(!e(r)||e(n)||!u.userId||!le(e(r),x))return;i(n,!0);const a=p.loading("Sauvegarde en cours...");try{e(r).$id=se(e(r).title,e(r).versionLabel||void 0);const c={...pe(e(r)),ingredients:oe(e(r).ingredients),astuces:ie(e(r).astuces),prepAlt:e(r).prepAlt},s=await ne(c,u.userId);p.update(a,{state:"success",message:"Recette créée avec succès !"});const v=ve(e(r),c,{id:s.$id,createdAt:s.$createdAt,updatedAt:s.$updatedAt,createdBy:s.createdBy});ce("save_recipe",s.$id,u.userId,v,!0).catch(R=>{console.error("Sync vers GitHub échouée:",R)}),i(D,!0),setTimeout(()=>{A(`/recipe/${s.$id}`)},1500)}catch(o){console.error("Erreur sauvegarde:",o),p.update(a,{state:"error",message:"Erreur lors de la création"})}finally{i(n,!1),setTimeout(()=>p.dismiss(a),3e3)}}var k=be(),z=W(k),M=b(z);{var j=t=>{var a=Re();y(t,a)},q=t=>{var a=te(),o=W(a);{var c=s=>{var v=Se(),R=b(v);me(R,{get recipeInfo(){return e(N)},get validationErrors(){return x.value},canEdit:e(E),get recipe(){return e(r)},set recipe(g){i(r,g,!0)}});var T=S(R,2);fe(T,{get validationErrors(){return x.value},canEdit:e(E),get recipe(){return e(r)},set recipe(g){i(r,g,!0)}});var X=S(T,2);ge(X,{get createdBy(){return e(r).createdBy},canEdit:e(E),get permissionWrite(){return e(r).permissionWrite},set permissionWrite(g){e(r).permissionWrite=g}}),y(s,v)};C(o,s=>{e(r)&&s(c)},!0)}y(t,a)};C(M,t=>{e(l)?t(q,!1):t(j)})}var K=S(z,2);{let t=f(()=>e(d)?`/recipe/${e(d)}/duplicate`:"/recipe/new");ye(K,{get routeKey(){return e(t)},shouldProtect:()=>e(B)&&!e(D),onLeaveWithoutSave:()=>{},onSaveAndLeave:async()=>{await V()},message:"Vous avez des modifications non sauvegardées. Voulez-vous vraiment quitter ?"})}y(H,k),J()}ee(["click"]);export{Ce as default};
