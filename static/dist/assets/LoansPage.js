import{Z as Me,x as je,j as Ua,s as O,p as ca,b as Ve,a as g,W as m,B as s,A as a,o as xe,v as b,ac as He,g as e,u as S,X as j,Y as Q,_ as ge,w as Te,G as Va,$ as L,a3 as Ze,al as Za,a1 as Le,ah as ya,E as ke,z as da,aj as Ga,D as Ue,ai as la,aa as Wa}from"./vendor.js";import{m as J,n as wa}from"./index.js";import{a as Se,t as fe,y as ia,n as Xa}from"./appwrite.js";import{A as Ha}from"./AutocompleteInput.js";import{B as Ya}from"./BtnGroupCheck.js";import{X as me,aQ as Ge,aR as va,l as ua,u as ba,g as _a,aS as We,aT as pa,aw as ka,n as Xe,au as Ta,aV as Ia,Q as Ca,aU as Ka,t as Ne,aW as Qa,aj as La,Z as oa,aI as Ja,az as $a,aX as et,aY as at,T as tt,D as Sa,U as qa,P as st}from"./icons.js";import{g as Aa}from"./date-helpers.js";import"./editor.js";import"./markdown.js";import"./keyboardNavigation.svelte.js";import"./CheckboxBadge.js";function nt(y,t,c){t.onAdd(Array.from(e(c))),t.onClose()}function Da(y,t,c,u){g(t,new Set(c()),!0),u.onClose()}var rt=m('<div class="mb-6"><h4 class="mb-3 flex items-center gap-2 text-base font-semibold"><div class="bg-primary/10 rounded-lg p-1.5"><!></div> <span class="badge badge-ghost badge-sm ml-auto"> </span></h4> <!></div>'),lt=m('<div class="text-center py-12 opacity-50"><!> <p class="text-lg font-medium">Aucun matériel disponible</p> <p class="text-sm mt-2">Tous les matériels sont actuellement empruntés ou non disponibles</p></div>'),it=m(`<div><div class="modal-box fixed top-0 flex h-lvh w-lvw flex-col overflow-auto md:top-10 md:h-full md:max-h-11/12 md:w-full md:max-w-4xl"><div class="flex items-center justify-between border-b p-4 pt-0"><h3 class="text-lg font-bold">Sélection rapide du matériel</h3> <button class="btn btn-circle btn-ghost btn-sm absolute top-2 right-2" aria-label="Fermer"><!></button></div> <div class="flex-1 space-y-6 overflow-y-auto p-4"><div class="alert alert-info alert-soft text-base">Les nombres indiquent les quantités disponibles de chaque matériel, vous
        indiquerez après la quantité que vous souhaitez réserver.</div> <!></div> <div class="border-base-300 flex-none border-t px-4 py-3"><div class="flex flex-wrap items-center justify-between gap-2"><div class="text-sm opacity-70"> </div> <div class="flex gap-2"><button class="btn btn-ghost">Annuler</button> <button class="btn btn-primary">Ajouter la sélection</button></div></div></div></div></div>`);function ot(y,t){je(t,!0);let c=Ua(t,"selectedIds",19,()=>new Set);const u=S(()=>({electronic:"Électronique",manual:"Ustensiles",cooking:"Matériel de cuisine",dish:"Vaisselle",gaz:"Gaz",hygiene:"Hygiène",other:"Autre"})),p=S(()=>({electronic:pa,manual:We,cooking:_a,dish:ba,gaz:ua,hygiene:va,other:Ge})),D=S(()=>{const q={};return t.materiels.forEach(E=>{const U=E.type||"other";q[U]||(q[U]=[]),q[U].push(E)}),q});let r=O(ca(new Set));Ve(()=>{g(r,new Set(c()),!0)});function x(q){e(r).has(q)?e(r).delete(q):e(r).add(q),g(r,new Set(e(r)),!0)}var z=it(),k=a(z),T=a(k),G=s(a(T),2);G.__click=[Da,r,c,t];var W=a(G);me(W,{class:"h-4 w-4"});var B=s(T,2),N=s(a(B),2);xe(N,17,()=>Object.entries(e(D)),([q,E])=>q,(q,E,U,ce)=>{var R=S(()=>Va(e(E),2));let re=()=>e(R)[0],V=()=>e(R)[1];const ie=S(()=>e(p)[re()]);var o=rt(),f=a(o),d=a(f),i=a(d);He(i,()=>e(ie),(h,I)=>{I(h,{class:"text-primary h-4 w-4"})});var P=s(d),n=s(P),v=a(n),_=s(f,2);{let h=S(()=>V().map(I=>({id:I.$id,label:I.name,badge:String(I.availableQuantity),selected:e(r).has(I.$id),title:`${I.availableQuantity}/${I.quantity} disponibles`})));Ya(_,{get items(){return e(h)},onToggleItem:x,size:"md",color:"primary"})}j(h=>{Q(P,` ${e(u)[re()]??""} `),Q(v,`${h??""}/${V().length??""}`)},[()=>V().filter(h=>e(r).has(h.$id)).length]),b(q,o)},q=>{var E=lt(),U=a(E);Ge(U,{class:"h-16 w-16 mx-auto mb-4"}),b(q,E)});var $=s(B,2),ae=a($),ee=a(ae),X=a(ee),te=s(ee,2),se=a(te);se.__click=[Da,r,c,t];var ne=s(se,2);ne.__click=[nt,t,r],j(()=>{ge(z,1,`modal ${(t.isOpen&&"modal-open")??""}`),Q(X,`${e(r).size??""} matériel${e(r).size>1?"s":""}
          sélectionné${e(r).size>1?"s":""}`),ne.disabled=e(r).size===0}),b(y,z),Te()}Me(["click"]);async function dt(y,t,c,u,p,D,r,x,z,k){if(e(t)){g(c,!0);try{const T=e(u).map(B=>({materielId:B.materielId,materielName:B.materielName,quantity:B.quantity})),G=Se.userId||"",W=Se.userName||"Inconnu";await J.createLoan({startDate:e(p),endDate:e(D),responsibleId:G,responsibleName:W,ownerId:r.ownerId,ownerName:r.ownerName,materiels:T,notes:e(x).trim()||void 0,status:e(z)}),k(),r.onClose(),r.onSuccess?.()}catch(T){console.error("Erreur création emprunt:",T),fe.error("Erreur lors de la création de l'emprunt")}finally{g(c,!1)}}}function Na(y,t,c){t(),c.onClose()}var ct=m(`<div class="alert alert-info"><!> <span>Veuillez sélectionner une <strong>date de début</strong> et une <strong>date de fin</strong> pour voir le matériel disponible sur cette
              période.</span></div>`),vt=(y,t)=>g(t,!0),ut=m('<div class="alert alert-warning"><!> <span>Aucun matériel disponible pour la période sélectionnée.</span></div>'),bt=m('<div class="flex flex-wrap gap-6"><div class="flex-1"><!></div> <button class="btn btn-secondary btn-md flex-1 gap-2"><!> Ajout rapide</button></div> <!>',1),_t=(y,t,c)=>{const u=y.target;t(e(c).materielId,parseInt(u.value))},pt=m("<option></option>"),mt=(y,t,c)=>t(e(c).materielId),ft=m('<div class="bg-base-200 rounded-lg p-2"><div class="flex items-center gap-2"><div class="bg-base-300 rounded p-1"><!></div> <div class="min-w-0 flex-1"><div class="truncate font-medium"> </div> <div class="text-xs opacity-70">Disponible : <span class="font-semibold"> </span></div></div> <div class="flex items-center gap-1"><span class="text-sm opacity-70"><!></span> <label class="select join"><select class="join-item select-sm select-bordered w-20"></select></label></div> <button class="btn btn-ghost btn-xs btn-circle" aria-label="Supprimer"><!></button></div></div>'),gt=m('<div class="space-y-2"><p class="text-sm font-semibold opacity-70">Matériels sélectionnés</p> <!></div>'),xt=m(`<div class="py-8 text-center opacity-50"><!> <p class="text-sm">Aucun matériel sélectionné</p> <p class="text-xs">Utilisez la recherche ou l'ajout rapide pour ajouter du matériel</p></div>`),ht=m('<span class="loading loading-spinner loading-sm"></span>'),yt=m(`<div><div class="modal-box fixed top-0 flex h-lvh w-lvw flex-col overflow-auto md:top-10 md:h-full md:max-h-11/12 md:w-full md:max-w-4xl"><div class="flex items-center justify-between border-b p-4 pt-0"><h3 class="flex items-center gap-2 text-lg font-bold"><!> </h3> <button class="btn btn-circle btn-ghost btn-sm absolute top-2 right-2" aria-label="Fermer"><!></button></div> <div class="flex-1 space-y-6 overflow-y-auto p-4"><div class="space-y-4"><div class="flex flex-wrap gap-4"><label class="input min-w-[200px] flex-1"><span class="label"><!> Date début *</span> <input type="date" class="grow"/></label> <label class="input min-w-[200px] flex-1"><span class="label"><!> Date fin *</span> <input type="date" class="grow"/></label></div> <label class="input w-full"><span class="label"><!> Responsable</span> <input type="text" class="grow" disabled/></label> <fieldset class="fieldset bg-base-100"><legend class="fieldset-legend">Notes (optionnel)</legend> <textarea class="textarea textarea-bordered w-full" rows="2" placeholder="Informations complémentaires sur l'emprunt..." maxlength="500"></textarea></fieldset> <fieldset class="fieldset bg-base-100"><legend class="fieldset-legend">Statut de la réservation</legend> <div class="flex flex-wrap gap-4"><label class="label justify-gap-3 cursor-pointer gap-3"><input type="radio" class="radio radio-primary"/> <span class="label-text"><strong class="block">Demande de réservation</strong> <span class="text-xs opacity-70">Si vous souhaitez attendre la validation du reste de l'équipe</span></span></label> <label class="label justify-gap-3 cursor-pointer gap-3"><input type="radio" class="radio radio-primary"/> <span class="label-text"><strong class="block">Réservation confirmée</strong> <span class="text-xs opacity-70">L'emprunt est automatiquement validé</span></span></label></div></fieldset></div> <div class="space-y-4"><h4 class="flex items-center gap-2 text-sm font-semibold uppercase opacity-70"><!> </h4> <!> <!></div></div> <div class="border-base-300 flex-none border-t px-4 py-3"><div class="flex flex-wrap items-center justify-end gap-2"><button class="btn btn-ghost"><!> Annuler</button> <button class="btn btn-primary"><!> Créer l'emprunt</button></div></div></div> <!></div>`);function wt(y,t){je(t,!0);const c=[];let u=O(""),p=O(""),D=O(""),r=O(ca([])),x=O("asked"),z=O(!1),k=O(!1);const T=S(()=>!e(u)||!e(p)?J.getAvailableMaterielsByOwner(t.ownerId):J.getAvailableMaterielsForPeriod(t.ownerId,e(u),e(p))),G=S(()=>e(u)!==""&&e(p)!==""&&e(u)<e(p)&&e(r).length>0&&e(r).every(l=>l.quantity>=1)&&Se.userId!==null&&Se.userId!==void 0&&!e(k));function W(l){const C=l.availableForPeriod??l.availableQuantity,A=e(r).find(oe=>oe.materielId===l.$id);if(A){A.quantity<C&&A.quantity++;return}g(r,[...e(r),{materielId:l.$id,materielName:l.name,quantity:1,type:l.type||"",maxQuantity:C}],!0)}function B(l){g(r,e(r).filter(C=>C.materielId!==l),!0)}function N(l,C){g(r,e(r).map(A=>A.materielId===l?{...A,quantity:Math.max(1,Math.min(C,A.maxQuantity))}:A),!0)}function $(l){l.forEach(C=>{const A=e(T).find(oe=>oe.$id===C);A&&W(A)}),g(z,!1)}function ae(){g(u,""),g(p,""),g(D,""),g(r,[],!0),g(x,"asked")}var ee=yt(),X=a(ee),te=a(X),se=a(te),ne=a(se);ka(ne,{class:"h-5 w-5"});var q=s(ne),E=s(se,2);E.__click=[Na,ae,t];var U=a(E);me(U,{class:"h-4 w-4"});var ce=s(te,2),R=a(ce),re=a(R),V=a(re),ie=a(V),o=a(ie);Xe(o,{class:"h-4 w-4"});var f=s(ie,2),d=s(V,2),i=a(d),P=a(i);Xe(P,{class:"h-4 w-4"});var n=s(i,2),v=s(re,2),_=a(v),h=a(_);Ta(h,{class:"h-4 w-4"});var I=s(_,2),w=s(v,2),F=s(a(w),2),ve=s(w,2),he=s(a(ve),2),H=a(he),M=a(H);M.value=M.__value="asked";var Y=s(H,2),K=a(Y);K.value=K.__value="accepted";var ue=s(R,2),ye=a(ue),be=a(ye);Ia(be,{class:"h-4 w-4"});var we=s(be),Ie=s(ye,2);{var Ye=l=>{var C=ct(),A=a(C);Ca(A,{class:"h-5 w-5"}),b(l,C)},Ke=l=>{var C=bt(),A=ke(C),oe=a(A),Z=a(oe);Ha(Z,{get items(){return e(T)},itemToString:de=>de.name,onSelect:de=>W(de),placeholder:"Rechercher du matériel...",get disabled(){return e(k)}});var ze=s(oe,2);ze.__click=[vt,z];var sa=a(ze);Ia(sa,{class:"h-4 w-4"});var Re=s(A,2);{var na=de=>{var Pe=ut(),Fe=a(Pe);Ca(Fe,{class:"h-5 w-5"}),b(de,Pe)};L(Re,de=>{e(T).length===0&&de(na)})}j(()=>ze.disabled=e(k)||e(T).length===0),b(l,C)};L(Ie,l=>{!e(u)||!e(p)?l(Ye):l(Ke,!1)})}var Je=s(Ie,2);{var $e=l=>{var C=gt(),A=s(a(C),2);xe(A,17,()=>e(r),oe=>oe.materielId,(oe,Z,ze)=>{const sa=S(()=>e(Z).type==="electronic"?pa:e(Z).type==="manual"?We:e(Z).type==="cooking"?_a:e(Z).type==="dish"?ba:e(Z).type==="gaz"?ua:e(Z).type==="hygiene"?va:Ge);var Re=ft(),na=a(Re),de=a(na),Pe=a(de);He(Pe,()=>e(sa),(De,xa)=>{xa(De,{class:"h-4 w-4 opacity-70"})});var Fe=s(de,2),ma=a(Fe),Ea=a(ma),za=s(ma,2),Ra=s(a(za)),Pa=a(Ra),fa=s(Fe,2),ga=a(fa),Fa=a(ga);Ka(Fa,{class:"inline h-3 w-3"});var Oa=s(ga,2),Oe=a(Oa);Oe.__change=[_t,N,Z],xe(Oe,21,()=>Array(e(Z).maxQuantity),da,(De,xa,ha)=>{var Be=pt();Be.textContent=ha+1,Be.value=Be.__value=ha+1,b(De,Be)});var ra=s(fa,2);ra.__click=[mt,B,Z];var Ba=a(ra);me(Ba,{class:"h-3 w-3"}),j(()=>{Q(Ea,e(Z).materielName),Q(Pa,e(Z).maxQuantity),Oe.disabled=e(k),ra.disabled=e(k)}),Ga(Oe,()=>e(Z).quantity,De=>e(Z).quantity=De),b(oe,Re)}),b(l,C)},Ee=l=>{var C=xt(),A=a(C);ka(A,{class:"mx-auto mb-2 h-12 w-12"}),b(l,C)};L(Je,l=>{e(r).length>0?l($e):l(Ee,!1)})}var Ce=s(ce,2),ea=a(Ce),Qe=a(ea);Qe.__click=[Na,ae,t];var aa=a(Qe);me(aa,{class:"h-5 w-5"});var qe=s(Qe,2);qe.__click=[dt,G,k,r,u,p,t,D,x,ae];var ta=a(qe);{var le=l=>{var C=ht();b(l,C)},_e=l=>{Ne(l,{class:"h-5 w-5"})};L(ta,l=>{e(k)?l(le):l(_e,!1)})}var Ae=s(X,2);{var pe=l=>{{let C=S(()=>new Set(e(r).map(A=>A.materielId)));ot(l,{get isOpen(){return e(z)},onClose:()=>g(z,!1),onAdd:$,get selectedIds(){return e(C)},get materiels(){return e(T)}})}};L(Ae,l=>{e(z)&&l(pe)})}j(()=>{ge(ee,1,`modal ${(t.isOpen&&"modal-open")??""}`),Q(q,` Nouvel réservation - ${t.ownerName??""}`),f.disabled=e(k),n.disabled=e(k),Ze(n,"min",e(u)),Za(I,Se.userName||"Utilisateur actuel"),F.disabled=e(k),M.disabled=e(k),K.disabled=e(k),Q(we,` Matériel à emprunter (${e(r).length??""})`),Qe.disabled=e(k),qe.disabled=!e(G)}),Le(f,()=>e(u),l=>g(u,l)),Le(n,()=>e(p),l=>g(p,l)),Le(F,()=>e(D),l=>g(D,l)),ya(c,[],M,()=>e(x),l=>g(x,l)),ya(c,[],K,()=>e(x),l=>g(x,l)),b(y,ee),Te()}Me(["click","change"]);var kt=m('<div class="text-base-content/60 text-xs italic"> </div>'),It=m('<span><span class="font-semibold"> </span> </span>'),Ct=m('<div class="text-warning bg-warning/10 rounded p-2 text-xs"><strong>Retour :</strong> </div>'),Qt=(y,t,c)=>t(e(c).action),Lt=m("<button><!> <span> </span></button>"),St=(y,t)=>t.onEdit(t.loan.$id),qt=m('<button class="btn btn-ghost btn-sm" title="Modifier"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125"></path></svg></button>'),At=m('<div class="card bg-base-100 border-base-200 border text-left shadow-sm"><div class="card-body py-3"><div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between"><div class="flex min-w-0 flex-1 flex-col gap-4"><div class=" flex flex-wrap items-center gap-x-4 gap-y-1 text-base"><div class="flex items-center gap-1"><!> <span> </span></div> <div><!> <span> </span></div> <span> </span></div> <!> <div class="flex flex-wrap gap-2"></div> <!></div> <div class="flex flex-col gap-4 not-sm:mt-4"><!> <!></div></div></div></div>');function Dt(y,t){je(t,!0);const c=S(()=>t.loan.materielItems),u=S(()=>{const n=new Date,v=new Date(t.loan.startDate),_=new Date(t.loan.endDate);return n<v?"future":n>=v&&n<=_?"current":"past"}),p=S(()=>{switch(e(u)){case"future":return{icon:La,class:"text-info",label:"À venir"};case"current":return{icon:Qa,class:"text-accent",label:"En cours"};case"past":default:return{icon:Xe,class:"",label:""}}});function D(n){if(t.loan.status!=="completed")return"";const v=n.lostQuantity||0,_=n.brokenQuantity||0,h=v+_;return n.quantity-h===0?"badge-error":h>0?"badge-warning":"badge-success"}const r=S(()=>!t.loan||!t.loan.status?{label:"Chargement...",badgeClass:"badge-neutral",icon:oa}:{asked:{label:"En attente",badgeClass:"badge-warning",icon:oa},accepted:{label:"confirmé",badgeClass:"badge-info",icon:Ne},refused:{label:"Refusé",badgeClass:"badge-error",icon:me},canceled:{label:"Annulé",badgeClass:"badge-neutral",icon:me},completed:{label:"Retour effectué",badgeClass:"badge-success",icon:Ne},archived:{label:"Archivé",badgeClass:"badge-neutral",icon:$a},returned:{label:"Retourné",badgeClass:"badge-success",icon:Ja}}[t.loan.status]||{label:"Statut inconnu",badgeClass:"badge-neutral",icon:oa}),x=S(()=>()=>{switch(t.loan.status){case"asked":return[{label:"Confirmer",icon:Ne,action:t.onAccept,class:"btn-success"},{label:"Annuler",icon:tt,action:t.onCancel,class:"btn-error btn-outline"}];case"accepted":return[{label:"Compléter Fiche retour",icon:at,action:t.onReturn,class:"btn-warning"}];case"completed":return[{label:"Fiche retour",icon:et,action:t.onReturn,class:""}];case"refused":case"canceled":return[{label:"Supprimer",icon:me,action:t.onDelete,class:"btn-error btn-sm"}];default:return[]}});function z(n){n?.(t.loan.$id)}var k=At(),T=a(k),G=a(T),W=a(G),B=a(W),N=a(B),$=a(N);Ta($,{class:"h-4 w-4"});var ae=s($,2),ee=a(ae),X=s(N,2),te=a(X);{var se=n=>{La(n,{class:"h-4 w-4"})},ne=n=>{var v=Ue(),_=ke(v);{var h=w=>{Qa(w,{class:"h-4 w-4"})},I=w=>{Xe(w,{class:"h-4 w-4"})};L(_,w=>{e(u)==="current"?w(h):w(I,!1)},!0)}b(n,v)};L(te,n=>{e(u)==="future"?n(se):n(ne,!1)})}var q=s(te,2),E=a(q),U=s(X,2),ce=a(U),R=s(B,2);{var re=n=>{var v=kt(),_=a(v);j(()=>Q(_,`"${t.loan.notes??""}"`)),b(n,v)};L(R,n=>{t.loan.notes&&n(re)})}var V=s(R,2);xe(V,21,()=>e(c),da,(n,v)=>{var _=It(),h=a(_),I=a(h),w=s(h);j(F=>{ge(_,1,`badge badge-sm badge-soft ${F??""}`),Q(I,e(v).materielName),Q(w,` × ${e(v).quantity??""}`)},[()=>D(e(v))]),b(n,_)});var ie=s(V,2);{var o=n=>{var v=Ct(),_=s(a(v));j(()=>Q(_,` ${t.loan.returnNotes??""}`)),b(n,v)};L(ie,n=>{t.loan.returnNotes&&n(o)})}var f=s(W,2),d=a(f);xe(d,17,()=>e(x)(),da,(n,v)=>{var _=Lt();_.__click=[Qt,z,v];var h=a(_);He(h,()=>e(v).icon,(F,ve)=>{ve(F,{class:"h-4 w-4"})});var I=s(h,2),w=a(I);j(()=>{ge(_,1,`btn btn-sm ${e(v).class??""}`),Ze(_,"title",e(v).label),Q(w,e(v).label)}),b(n,_)});var i=s(d,2);{var P=n=>{var v=qt();v.__click=[St,t],b(n,v)};L(i,n=>{t.onEdit&&t.loan.status==="asked"&&n(P)})}j((n,v)=>{Q(ee,t.loan.responsibleName),ge(X,1,`flex items-center gap-1 ${e(p).class??""} font-bold`),Q(E,`${n??""} - ${v??""}`),ge(U,1,`badge ${e(r).badgeClass??""} badge-sm gap-1`),Q(ce,e(r).label)},[()=>Aa(t.loan.startDate),()=>Aa(t.loan.endDate)]),b(y,k),Te()}Me(["click"]);async function Nt(y,t,c,u,p,D){if(e(t)){g(c,!0);try{const r=e(u).map(x=>({materielId:x.materielId,materielName:x.materielName,quantity:x.quantity,lostQuantity:x.lostQuantity>0?x.lostQuantity:void 0,brokenQuantity:x.brokenQuantity>0?x.brokenQuantity:void 0}));await J.updateLoan(p.loan.$id,{materiels:r,status:"returned",returnedAt:new Date().toISOString(),returnNotes:e(D).trim()||void 0}),p.onClose()}catch(r){console.error("Erreur retour emprunt:",r)}finally{g(c,!1)}}}function Ma(y,t,c){g(t,""),c.onClose()}var Mt=(y,t)=>{y.target.checked&&(e(t).lostQuantity=0,e(t).brokenQuantity=0)},jt=(y,t)=>{const c=y.target;e(t).lostQuantity=c.checked?1:0},Tt=m('<div class="ml-8"><label class="input input-sm w-32"><span class="label text-xs">Qté perdue:</span> <input type="number" class="grow" min="0"/></label></div>'),Et=(y,t)=>{const c=y.target;e(t).brokenQuantity=c.checked?1:0},zt=m('<div class="ml-8"><label class="input input-sm w-32"><span class="label text-xs">Qté cassée:</span> <input type="number" class="grow" min="0"/></label></div>'),Rt=m('<div class="border-base-300 bg-base-100 rounded-lg border p-4"><div class="mb-3 flex items-start gap-3"><div class="bg-primary/10 rounded-lg p-2"><!></div> <div class="flex-1"><div class="font-semibold"> </div> <div class="text-sm opacity-70"> </div></div></div> <div class="ml-10 space-y-3"><label class="flex cursor-pointer items-start gap-3"><input type="checkbox" class="checkbox checkbox-success checkbox-sm mt-1"/> <div class="text-sm"><div class="font-medium">Tout est OK</div> <div class="opacity-60">Aucune perte ni casse</div></div></label> <div class="space-y-2"><label class="flex cursor-pointer items-start gap-3"><input type="checkbox" class="checkbox checkbox-error checkbox-sm mt-1"/> <div class="flex-1 text-sm"><div class="flex items-center gap-2 font-medium"><!> Des pièces sont perdues</div></div></label> <!></div> <div class="space-y-2"><label class="flex cursor-pointer items-start gap-3"><input type="checkbox" class="checkbox checkbox-warning checkbox-sm mt-1"/> <div class="flex-1 text-sm"><div class="flex items-center gap-2 font-medium"><!> Des pièces sont cassées</div> <div class="text-xs opacity-60">À réparer (status: torepair)</div></div></label> <!></div></div></div>'),Pt=m('<div class="text-error"> </div>'),Ft=m('<div class="text-warning"> </div>'),Ot=m('<div class="alert alert-warning"><!> <div><h4 class="font-bold"> </h4> <div class="text-sm"><!> <!></div></div></div> )',1),Bt=m('<span class="loading loading-spinner loading-sm"></span>'),Ut=m(`<div><div class="modal-box fixed top-0 flex h-lvh w-lvw flex-col overflow-auto md:top-10 md:h-full md:max-h-11/12 md:w-full md:max-w-3xl"><div class="flex items-center justify-between border-b p-4 pt-0"><div><h3 class="text-lg font-bold">Retour d'emprunt</h3> <p class="text-sm opacity-70"> </p></div> <button class="btn btn-circle btn-ghost btn-sm absolute top-2 right-2" aria-label="Fermer"><!></button></div> <div class="flex-1 space-y-6 overflow-y-auto p-4"><div class="space-y-4"><h4 class="text-sm font-semibold uppercase opacity-70">Matériel à retourner</h4> <!></div> <!> <fieldset class="fieldset bg-base-100"><legend class="fieldset-legend">Notes de retour (optionnel)</legend> <textarea class="textarea textarea-bordered w-full" rows="3" placeholder="Précisez l'état du matériel, les raisons des pertes/casses, etc." maxlength="1000"></textarea></fieldset></div> <div class="border-base-300 flex-none border-t px-4 py-3"><div class="flex flex-wrap items-center justify-end gap-2"><button class="btn btn-ghost"><!> Annuler</button> <button class="btn btn-warning"><!> Valider le retour</button></div></div></div></div>`);function Vt(y,t){je(t,!0);let c=O(ca([])),u=O(""),p=O(!1);Ve(()=>{if(!t.loan)return;const d=t.loan.materielItems;g(c,d.map(i=>({materielId:i.materielId,materielName:i.materielName,quantity:i.quantity,type:"",lostQuantity:0,brokenQuantity:0})),!0),d.forEach(i=>{const P=J.materiels.find(n=>n.$id===i.materielId);if(P){const n=e(c).find(v=>v.materielId===i.materielId);n&&(n.type=P.type||"")}})});const D=S(()=>e(c).every(d=>d.lostQuantity>=0&&d.brokenQuantity>=0&&d.lostQuantity+d.brokenQuantity<=d.quantity)&&!e(p)),r=S(()=>e(c).reduce((d,i)=>d+i.lostQuantity,0)),x=S(()=>e(c).reduce((d,i)=>d+i.brokenQuantity,0));function z(d){switch(d){case"electronic":return pa;case"manual":return We;case"cooking":return _a;case"dish":return ba;case"gaz":return ua;case"hygiene":return va;default:return Ge}}var k=Ut(),T=a(k),G=a(T),W=a(G),B=s(a(W),2),N=a(B),$=s(W,2);$.__click=[Ma,u,t];var ae=a($);me(ae,{class:"h-4 w-4"});var ee=s(G,2),X=a(ee),te=s(a(X),2);xe(te,17,()=>e(c),d=>d.materielId,(d,i,P)=>{const n=S(()=>z(e(i).type));var v=Rt(),_=a(v),h=a(_),I=a(h);He(I,()=>e(n),(le,_e)=>{_e(le,{class:"text-primary h-5 w-5"})});var w=s(h,2),F=a(w),ve=a(F),he=s(F,2),H=a(he),M=s(_,2),Y=a(M),K=a(Y);K.__change=[Mt,i];var ue=s(Y,2),ye=a(ue),be=a(ye);be.__change=[jt,i];var we=s(be,2),Ie=a(we),Ye=a(Ie);Sa(Ye,{class:"h-3 w-3"});var Ke=s(ye,2);{var Je=le=>{var _e=Tt(),Ae=a(_e),pe=s(a(Ae),2);j(()=>{Ze(pe,"max",e(i).quantity-e(i).brokenQuantity),pe.disabled=e(p)}),Le(pe,()=>e(i).lostQuantity,l=>e(i).lostQuantity=l),b(le,_e)};L(Ke,le=>{e(i).lostQuantity>0&&le(Je)})}var $e=s(ue,2),Ee=a($e),Ce=a(Ee);Ce.__change=[Et,i];var ea=s(Ce,2),Qe=a(ea),aa=a(Qe);We(aa,{class:"h-3 w-3"});var qe=s(Ee,2);{var ta=le=>{var _e=zt(),Ae=a(_e),pe=s(a(Ae),2);j(()=>{Ze(pe,"max",e(i).quantity-e(i).lostQuantity),pe.disabled=e(p)}),Le(pe,()=>e(i).brokenQuantity,l=>e(i).brokenQuantity=l),b(le,_e)};L(qe,le=>{e(i).brokenQuantity>0&&le(ta)})}j(()=>{Q(ve,e(i).materielName),Q(H,`Quantité empruntée : ${e(i).quantity??""}`),la(K,e(i).lostQuantity===0&&e(i).brokenQuantity===0),K.disabled=e(p),la(be,e(i).lostQuantity>0),be.disabled=e(p),la(Ce,e(i).brokenQuantity>0),Ce.disabled=e(p)}),b(d,v)});var se=s(X,2);{var ne=d=>{var i=Ot(),P=ke(i),n=a(P);Sa(n,{class:"h-5 w-5"});var v=s(n,2),_=a(v),h=a(_),I=s(_,2),w=a(I);{var F=H=>{var M=Pt(),Y=a(M);j(()=>Q(Y,`• ${e(r)??""} perdue${e(r)>1?"s":""} (déduit du stock)`)),b(H,M)};L(w,H=>{e(r)>0&&H(F)})}var ve=s(w,2);{var he=H=>{var M=Ft(),Y=a(M);j(()=>Q(Y,`• ${e(x)??""} cassée${e(x)>1?"s":""} (à réparer)`)),b(H,M)};L(ve,H=>{e(x)>0&&H(he)})}j(()=>Q(h,`Attention : ${e(r)+e(x)} unité${e(r)+e(x)>1?"s":""} problématique${e(r)+e(x)>1?"s":""}`)),b(d,i)};L(se,d=>{(e(r)>0||e(x)>0)&&d(ne)})}var q=s(se,2),E=s(a(q),2),U=s(ee,2),ce=a(U),R=a(ce);R.__click=[Ma,u,t];var re=a(R);me(re,{class:"h-5 w-5"});var V=s(R,2);V.__click=[Nt,D,p,c,t,u];var ie=a(V);{var o=d=>{var i=Bt();b(d,i)},f=d=>{Ne(d,{class:"h-5 w-5"})};L(ie,d=>{e(p)?d(o):d(f,!1)})}j((d,i)=>{ge(k,1,`modal ${(t.isOpen&&"modal-open")??""}`),Q(N,`Du ${d??""} au ${i??""}`),E.disabled=e(p),R.disabled=e(p),V.disabled=!e(D)},[()=>new Date(t.loan.startDate).toLocaleDateString("fr-FR"),()=>new Date(t.loan.endDate).toLocaleDateString("fr-FR")]),Le(E,()=>e(u),d=>g(u,d)),b(y,k),Te()}Me(["click","change"]);function ja(y,t,c,u){if(!e(t))return;if(!e(c).find(D=>D.$id===e(t))){fe.error("Équipe introuvable");return}g(u,!0)}var Zt=(y,t,c)=>t(e(c).$id),Gt=m('<button><!> <span class="badge badge-sm badge-neutral ml-2"> </span></button>'),Wt=m('<div class="tabs tabs-border bg-base-200 tabs-lg mb-6 font-medium"></div>'),Xt=m('<div class="alert alert-warning"><span>Vous devez être connecté pour voir les emprunts.</span></div>'),Ht=m('<div class="alert alert-error shadow-lg"><span> </span></div>'),Yt=m('<div class="alert alert-info"><span>Sélectionnez une équipe pour voir ses emprunts.</span></div>'),Kt=m(`<div class="bg-base-200 rounded-box border-base-200 border-2 border-dashed py-20 text-center"><!> <h3 class="mb-2 text-lg font-bold">Aucune réservation</h3> <p class="text-base-content/60 mb-6">Cette équipe n'a pas encore d'emprunt.</p> <button class="btn btn-primary btn-sm">Créer une réservation</button></div>`),Jt=m('<div class="space-y-4"><div class="mb-6 flex justify-end"><button class="btn btn-primary btn-wide flex gap-2"><!> Ajouter une reservation</button></div> <!></div>'),$t=m('<div class="container mx-auto p-4"><div class="mx-auto max-w-7xl px-4 py-8"><!> <!></div></div> <!> <!>',1);function vs(y,t){je(t,!0);let c=O(!1),u=O(null),p=O(!1),D=O(null),r=O(!1);function x(){g(c,!1)}function z(){console.log("[LoansPage] Emprunt créé avec succès"),x()}function k(o){ia(`/dashboard/loans/return/${o}`)}function T(){g(p,!1),g(D,null)}async function G(o){try{await J.acceptLoan(o),fe.success("Emprunt accepté avec succès")}catch(f){console.error("[LoansPage] Erreur acceptation emprunt:",f),fe.error("Erreur lors de l'acceptation de l'emprunt")}}async function W(o){try{await J.cancelLoan(o),fe.success("Emprunt annulé avec succès")}catch(f){console.error("[LoansPage] Erreur annulation emprunt:",f),fe.error("Erreur lors de l'annulation de l'emprunt")}}async function B(o){try{await J.deleteLoan(o),fe.success("Emprunt supprimé avec succès")}catch(f){console.error("[LoansPage] Erreur suppression emprunt:",f),fe.error("Erreur lors de la suppression de l'emprunt")}}const N=S(()=>Xa.myTeams),$=S(()=>e(u)?e(N).find(o=>o.$id===e(u)):null),ae=S(()=>{if(!e(u))return console.log("[LoansPage] teamLoans: pas d'activeTeamId"),[];const o=J.loans.filter(f=>f.ownerId===e(u));return console.log("[LoansPage] teamLoans filtrés:",{activeTeamId:e(u),totalLoans:J.loans.length,filteredCount:o.length,allLoans:J.loans.map(f=>({id:f.$id,ownerId:f.ownerId}))}),o});function ee(o){ia(`/dashboard/loans/${o}`)}Ve(()=>{const o=t.params?.teamId;if(o&&o!==e(u)){console.log("[LoansPage] teamIdFromParams:",o);const f=e(N).find(d=>d.$id===o);console.log("[LoansPage] équipe trouvée:",f),f&&(console.log("[LoansPage] Mise à jour activeTeamId:",o),g(u,o,!0))}else!o&&!e(u)&&!e(r)&&e(N).length>0&&(console.log("[LoansPage] Redirection vers première équipe:",e(N)[0].$id),g(r,!0),ia(`/dashboard/loans/${e(N)[0].$id}`))}),Ve(()=>{const f=(e(u)?e(N).find(d=>d.$id===e(u)):null)?.name||"Emprunts";wa.setConfig({title:f,materielContext:"loans",teamId:e(u)||void 0})}),Wa(()=>{wa.reset()});var X=$t(),te=ke(X),se=a(te),ne=a(se);{var q=o=>{var f=Wt();xe(f,21,()=>e(N),d=>d.$id,(d,i)=>{const P=S(()=>J.loans.filter(w=>w.ownerId===e(i).$id).length);var n=Gt();n.__click=[Zt,ee,i];var v=a(n);qa(v,{class:"mr-2 h-4 w-4"});var _=s(v),h=s(_),I=a(h);j(()=>{ge(n,1,`tab ${e(u)===e(i).$id?"tab-active":""}`),Q(_,` ${e(i).name??""} `),Q(I,e(P))}),b(d,n)}),b(o,f)};L(ne,o=>{e(N).length>1&&o(q)})}var E=s(ne,2);{var U=o=>{var f=Xt();b(o,f)},ce=o=>{var f=Ue(),d=ke(f);{var i=n=>{var v=Ht(),_=a(v),h=a(_);j(()=>Q(h,J.error)),b(n,v)},P=n=>{var v=Ue(),_=ke(v);{var h=w=>{var F=Yt();b(w,F)},I=w=>{var F=Ue(),ve=ke(F);{var he=M=>{var Y=Kt(),K=a(Y);qa(K,{class:"mx-auto mb-4 h-12 w-12  text-center opacity-50"});var ue=s(K,6);ue.__click=[ja,u,N,c],b(M,Y)},H=M=>{var Y=Jt(),K=a(Y),ue=a(K);ue.__click=[ja,u,N,c];var ye=a(ue);st(ye,{size:16});var be=s(K,2);xe(be,17,()=>e(ae),we=>we.$id,(we,Ie)=>{Dt(we,{get loan(){return e(Ie)},onReturn:k,onAccept:G,onCancel:W,onDelete:B})}),b(M,Y)};L(ve,M=>{e(ae).length===0?M(he):M(H,!1)})}b(w,F)};L(_,w=>{e(u)?w(I,!1):w(h)},!0)}b(n,v)};L(d,n=>{J.error?n(i):n(P,!1)},!0)}b(o,f)};L(E,o=>{Se.isAuthenticated?o(ce,!1):o(U)})}var R=s(te,2);{var re=o=>{wt(o,{get isOpen(){return e(c)},onClose:x,onSuccess:z,get ownerId(){return e($).$id},get ownerName(){return e($).name}})};L(R,o=>{e($)&&o(re)})}var V=s(R,2);{var ie=o=>{Vt(o,{get loan(){return e(D)},get isOpen(){return e(p)},onClose:T})};L(V,o=>{e(p)&&e(D)&&o(ie)})}b(y,X),Te()}Me(["click"]);export{vs as default};
