import{X as me,aQ as Ve,aR as ca,n as va,w as ua,i as ba,aS as We,aT as _a,aw as ya,p as He,au as za,aV as wa,W as ka,aU as Ua,v as Ne,aW as Ia,ak as Ca,$ as la,aI as Va,az as Wa,aX as Ha,aY as Xa,T as Ga,a0 as Ya,H as Qa,U as Sa,P as Za}from"./icons.js";import{Z as Me,d as Te,p as Ka,q as O,Y as pa,a1 as Xe,v as g,V as m,h as s,g as a,e as xe,b as _,ak as Ye,m as e,u as L,W as T,X as Q,_ as ge,c as ze,t as Ja,a2 as S,a4 as Ge,aC as $a,y as Se,a9 as Le,ax as La,k as ke,i as da,aA as et,C as fe,j as Ue,az as ia,ah as at,a0 as oa,A as tt}from"./appwrite.js";import{m as J,n as qa}from"./index.js";import{A as st}from"./AutocompleteInput.js";import{B as nt}from"./BtnGroupCheck.js";import{g as Aa}from"./date-helpers.js";import"./keyboardNavigation.svelte.js";import"./CheckboxBadge.js";function rt(y,t,c){t.onAdd(Array.from(e(c))),t.onClose()}function Da(y,t,c,u){g(t,new Set(c()),!0),u.onClose()}var lt=m('<div class="mb-6"><h4 class="mb-3 flex items-center gap-2 text-base font-semibold"><div class="bg-primary/10 rounded-lg p-1.5"><!></div> <span class="badge badge-ghost badge-sm ml-auto"> </span></h4> <!></div>'),it=m('<div class="text-center py-12 opacity-50"><!> <p class="text-lg font-medium">Aucun matériel disponible</p> <p class="text-sm mt-2">Tous les matériels sont actuellement empruntés ou non disponibles</p></div>'),ot=m(`<div><div class="modal-box fixed top-0 flex h-lvh w-lvw flex-col overflow-auto md:top-10 md:h-full md:max-h-11/12 md:w-full md:max-w-4xl"><div class="flex items-center justify-between border-b p-4 pt-0"><h3 class="text-lg font-bold">Sélection rapide du matériel</h3> <button class="btn btn-circle btn-ghost btn-sm absolute top-2 right-2" aria-label="Fermer"><!></button></div> <div class="flex-1 space-y-6 overflow-y-auto p-4"><div class="alert alert-info alert-soft text-base">Les nombres indiquent les quantités disponibles de chaque matériel, vous
        indiquerez après la quantité que vous souhaitez réserver.</div> <!></div> <div class="border-base-300 flex-none border-t px-4 py-3"><div class="flex flex-wrap items-center justify-between gap-2"><div class="text-sm opacity-70"> </div> <div class="flex gap-2"><button class="btn btn-ghost">Annuler</button> <button class="btn btn-primary">Ajouter la sélection</button></div></div></div></div></div>`);function dt(y,t){Te(t,!0);let c=Ka(t,"selectedIds",19,()=>new Set);const u=L(()=>({electronic:"Électronique",manual:"Ustensiles",cooking:"Matériel de cuisine",dish:"Vaisselle",gaz:"Gaz",hygiene:"Hygiène",other:"Autre"})),p=L(()=>({electronic:_a,manual:We,cooking:ba,dish:ua,gaz:va,hygiene:ca,other:Ve})),D=L(()=>{const q={};return t.materiels.forEach(E=>{const U=E.type||"other";q[U]||(q[U]=[]),q[U].push(E)}),q});let r=O(pa(new Set));Xe(()=>{g(r,new Set(c()),!0)});function x(q){e(r).has(q)?e(r).delete(q):e(r).add(q),g(r,new Set(e(r)),!0)}var R=ot(),k=a(R),z=a(k),H=s(a(z),2);H.__click=[Da,r,c,t];var X=a(H);me(X,{class:"h-4 w-4"});var B=s(z,2),N=s(a(B),2);xe(N,17,()=>Object.entries(e(D)),([q,E])=>q,(q,E,U,ce)=>{var j=L(()=>Ja(e(E),2));let re=()=>e(j)[0],V=()=>e(j)[1];const ie=L(()=>e(p)[re()]);var o=lt(),f=a(o),d=a(f),i=a(d);Ye(i,()=>e(ie),(h,I)=>{I(h,{class:"text-primary h-4 w-4"})});var P=s(d),n=s(P),v=a(n),b=s(f,2);{let h=L(()=>V().map(I=>({id:I.$id,label:I.name,badge:String(I.availableQuantity),selected:e(r).has(I.$id),title:`${I.availableQuantity}/${I.quantity} disponibles`})));nt(b,{get items(){return e(h)},onToggleItem:x,size:"md",color:"primary"})}T(h=>{Q(P,` ${e(u)[re()]??""} `),Q(v,`${h??""}/${V().length??""}`)},[()=>V().filter(h=>e(r).has(h.$id)).length]),_(q,o)},q=>{var E=it(),U=a(E);Ve(U,{class:"h-16 w-16 mx-auto mb-4"}),_(q,E)});var $=s(B,2),ae=a($),ee=a(ae),G=a(ee),te=s(ee,2),se=a(te);se.__click=[Da,r,c,t];var ne=s(se,2);ne.__click=[rt,t,r],T(()=>{ge(R,1,`modal ${(t.isOpen&&"modal-open")??""}`),Q(G,`${e(r).size??""} matériel${e(r).size>1?"s":""}
          sélectionné${e(r).size>1?"s":""}`),ne.disabled=e(r).size===0}),_(y,R),ze()}Me(["click"]);async function ct(y,t,c,u,p,D,r,x,R,k){if(e(t)){g(c,!0);try{const z=e(u).map(B=>({materielId:B.materielId,materielName:B.materielName,quantity:B.quantity})),H=Se.userId||"",X=Se.userName||"Inconnu";await J.createLoan({startDate:e(p),endDate:e(D),responsibleId:H,responsibleName:X,ownerId:r.ownerId,ownerName:r.ownerName,materiels:z,notes:e(x).trim()||void 0,status:e(R)}),k(),r.onClose(),r.onSuccess?.()}catch(z){console.error("Erreur création emprunt:",z),fe.error("Erreur lors de la création de l'emprunt")}finally{g(c,!1)}}}function Na(y,t,c){t(),c.onClose()}var vt=m(`<div class="alert alert-info max-md:alert-vertical"><!> <span>Veuillez sélectionner une <strong>date de début</strong> et une <strong>date de fin</strong> pour voir le matériel disponible sur cette
              période.</span></div>`),ut=(y,t)=>g(t,!0),bt=m('<div class="alert alert-warning"><!> <span>Aucun matériel disponible pour la période sélectionnée.</span></div>'),_t=m('<div class="flex flex-wrap gap-6"><div class="flex-1"><!></div> <button class="btn btn-secondary btn-md flex-1 gap-2"><!> Ajout rapide</button></div> <!>',1),pt=(y,t,c)=>{const u=y.target;t(e(c).materielId,parseInt(u.value))},mt=m("<option></option>"),ft=(y,t,c)=>t(e(c).materielId),gt=m('<div class="bg-base-200 rounded-lg p-2"><div class="flex items-center gap-2"><div class="bg-base-300 rounded p-1"><!></div> <div class="min-w-0 flex-1"><div class="truncate font-medium"> </div> <div class="text-xs opacity-70">Disponible : <span class="font-semibold"> </span></div></div> <div class="flex items-center gap-1"><span class="text-sm opacity-70"><!></span> <label class="select join"><select class="join-item select-sm select-bordered w-20"></select></label></div> <button class="btn btn-ghost btn-xs btn-circle" aria-label="Supprimer"><!></button></div></div>'),xt=m('<div class="space-y-2"><p class="text-sm font-semibold opacity-70">Matériels sélectionnés</p> <!></div>'),ht=m(`<div class="py-8 text-center opacity-50"><!> <p class="text-sm">Aucun matériel sélectionné</p> <p class="text-xs">Utilisez la recherche ou l'ajout rapide pour ajouter du matériel</p></div>`),yt=m('<span class="loading loading-spinner loading-sm"></span>'),wt=m(`<div><div class="modal-box fixed top-0 flex h-lvh w-lvw flex-col overflow-auto md:top-10 md:h-full md:max-h-11/12 md:w-full md:max-w-4xl"><div class="flex items-center justify-between border-b p-4 pt-0"><h3 class="flex items-center gap-2 text-lg font-bold"><!> </h3> <button class="btn btn-circle btn-ghost btn-sm absolute top-2 right-2" aria-label="Fermer"><!></button></div> <div class="flex-1 space-y-6 overflow-y-auto p-4"><div class="space-y-4"><div class="flex flex-wrap gap-4"><label class="input min-w-[200px] flex-1"><span class="label"><!> Date début *</span> <input type="date" class="grow"/></label> <label class="input min-w-[200px] flex-1"><span class="label"><!> Date fin *</span> <input type="date" class="grow"/></label></div> <label class="input w-full"><span class="label"><!> Responsable</span> <input type="text" class="grow" disabled/></label> <fieldset class="fieldset bg-base-100"><legend class="fieldset-legend">Notes (optionnel)</legend> <textarea class="textarea textarea-bordered w-full" rows="2" placeholder="Informations complémentaires sur l'emprunt..." maxlength="500"></textarea></fieldset> <fieldset class="fieldset bg-base-100"><legend class="fieldset-legend">Statut de la réservation</legend> <div class="flex flex-wrap gap-4"><label class="label justify-gap-3 cursor-pointer gap-3"><input type="radio" class="radio radio-primary"/> <span class="label-text"><strong class="block">Demande de réservation</strong> <span class="text-xs opacity-70">Si vous souhaitez attendre la validation du reste de l'équipe</span></span></label> <label class="label justify-gap-3 cursor-pointer gap-3"><input type="radio" class="radio radio-primary"/> <span class="label-text"><strong class="block">Réservation confirmée</strong> <span class="text-xs opacity-70">L'emprunt est automatiquement validé</span></span></label></div></fieldset></div> <div class="space-y-4"><h4 class="flex items-center gap-2 text-sm font-semibold uppercase opacity-70"><!> </h4> <!> <!></div></div> <div class="border-base-300 flex-none border-t px-4 py-3"><div class="flex flex-wrap items-center justify-end gap-2"><button class="btn btn-ghost"><!> Annuler</button> <button class="btn btn-primary"><!> Créer l'emprunt</button></div></div></div> <!></div>`);function kt(y,t){Te(t,!0);const c=[];let u=O(""),p=O(""),D=O(""),r=O(pa([])),x=O("asked"),R=O(!1),k=O(!1);const z=L(()=>!e(u)||!e(p)?J.getAvailableMaterielsByOwner(t.ownerId):J.getAvailableMaterielsForPeriod(t.ownerId,e(u),e(p))),H=L(()=>e(u)!==""&&e(p)!==""&&e(u)<e(p)&&e(r).length>0&&e(r).every(l=>l.quantity>=1)&&Se.userId!==null&&Se.userId!==void 0&&!e(k));function X(l){const C=l.availableForPeriod??l.availableQuantity,A=e(r).find(oe=>oe.materielId===l.$id);if(A){A.quantity<C&&A.quantity++;return}g(r,[...e(r),{materielId:l.$id,materielName:l.name,quantity:1,type:l.type||"",maxQuantity:C}],!0)}function B(l){g(r,e(r).filter(C=>C.materielId!==l),!0)}function N(l,C){g(r,e(r).map(A=>A.materielId===l?{...A,quantity:Math.max(1,Math.min(C,A.maxQuantity))}:A),!0)}function $(l){l.forEach(C=>{const A=e(z).find(oe=>oe.$id===C);A&&X(A)}),g(R,!1)}function ae(){g(u,""),g(p,""),g(D,""),g(r,[],!0),g(x,"asked")}var ee=wt(),G=a(ee),te=a(G),se=a(te),ne=a(se);ya(ne,{class:"h-5 w-5"});var q=s(ne),E=s(se,2);E.__click=[Na,ae,t];var U=a(E);me(U,{class:"h-4 w-4"});var ce=s(te,2),j=a(ce),re=a(j),V=a(re),ie=a(V),o=a(ie);He(o,{class:"h-4 w-4"});var f=s(ie,2),d=s(V,2),i=a(d),P=a(i);He(P,{class:"h-4 w-4"});var n=s(i,2),v=s(re,2),b=a(v),h=a(b);za(h,{class:"h-4 w-4"});var I=s(b,2),w=s(v,2),F=s(a(w),2),ve=s(w,2),he=s(a(ve),2),Y=a(he),M=a(Y);M.value=M.__value="asked";var Z=s(Y,2),K=a(Z);K.value=K.__value="accepted";var ue=s(j,2),ye=a(ue),be=a(ye);wa(be,{class:"h-4 w-4"});var we=s(be),Ie=s(ye,2);{var Ze=l=>{var C=vt(),A=a(C);ka(A,{class:"h-5 w-5"}),_(l,C)},Ke=l=>{var C=_t(),A=ke(C),oe=a(A),W=a(oe);st(W,{get items(){return e(z)},itemToString:de=>de.name,onSelect:de=>X(de),placeholder:"Rechercher du matériel...",get disabled(){return e(k)}});var Re=s(oe,2);Re.__click=[ut,R];var sa=a(Re);wa(sa,{class:"h-4 w-4"});var je=s(A,2);{var na=de=>{var Pe=bt(),Fe=a(Pe);ka(Fe,{class:"h-5 w-5"}),_(de,Pe)};S(je,de=>{e(z).length===0&&de(na)})}T(()=>Re.disabled=e(k)||e(z).length===0),_(l,C)};S(Ie,l=>{!e(u)||!e(p)?l(Ze):l(Ke,!1)})}var Je=s(Ie,2);{var $e=l=>{var C=xt(),A=s(a(C),2);xe(A,17,()=>e(r),oe=>oe.materielId,(oe,W,Re)=>{const sa=L(()=>e(W).type==="electronic"?_a:e(W).type==="manual"?We:e(W).type==="cooking"?ba:e(W).type==="dish"?ua:e(W).type==="gaz"?va:e(W).type==="hygiene"?ca:Ve);var je=gt(),na=a(je),de=a(na),Pe=a(de);Ye(Pe,()=>e(sa),(De,xa)=>{xa(De,{class:"h-4 w-4 opacity-70"})});var Fe=s(de,2),ma=a(Fe),Ea=a(ma),Ra=s(ma,2),ja=s(a(Ra)),Pa=a(ja),fa=s(Fe,2),ga=a(fa),Fa=a(ga);Ua(Fa,{class:"inline h-3 w-3"});var Oa=s(ga,2),Oe=a(Oa);Oe.__change=[pt,N,W],xe(Oe,21,()=>Array(e(W).maxQuantity),da,(De,xa,ha)=>{var Be=mt();Be.textContent=ha+1,Be.value=Be.__value=ha+1,_(De,Be)});var ra=s(fa,2);ra.__click=[ft,B,W];var Ba=a(ra);me(Ba,{class:"h-3 w-3"}),T(()=>{Q(Ea,e(W).materielName),Q(Pa,e(W).maxQuantity),Oe.disabled=e(k),ra.disabled=e(k)}),et(Oe,()=>e(W).quantity,De=>e(W).quantity=De),_(oe,je)}),_(l,C)},Ee=l=>{var C=ht(),A=a(C);ya(A,{class:"mx-auto mb-2 h-12 w-12"}),_(l,C)};S(Je,l=>{e(r).length>0?l($e):l(Ee,!1)})}var Ce=s(ce,2),ea=a(Ce),Qe=a(ea);Qe.__click=[Na,ae,t];var aa=a(Qe);me(aa,{class:"h-5 w-5"});var qe=s(Qe,2);qe.__click=[ct,H,k,r,u,p,t,D,x,ae];var ta=a(qe);{var le=l=>{var C=yt();_(l,C)},_e=l=>{Ne(l,{class:"h-5 w-5"})};S(ta,l=>{e(k)?l(le):l(_e,!1)})}var Ae=s(G,2);{var pe=l=>{{let C=L(()=>new Set(e(r).map(A=>A.materielId)));dt(l,{get isOpen(){return e(R)},onClose:()=>g(R,!1),onAdd:$,get selectedIds(){return e(C)},get materiels(){return e(z)}})}};S(Ae,l=>{e(R)&&l(pe)})}T(()=>{ge(ee,1,`modal ${(t.isOpen&&"modal-open")??""}`),Q(q,` Nouvel réservation - ${t.ownerName??""}`),f.disabled=e(k),n.disabled=e(k),Ge(n,"min",e(u)),$a(I,Se.userName||"Utilisateur actuel"),F.disabled=e(k),M.disabled=e(k),K.disabled=e(k),Q(we,` Matériel à emprunter (${e(r).length??""})`),Qe.disabled=e(k),qe.disabled=!e(H)}),Le(f,()=>e(u),l=>g(u,l)),Le(n,()=>e(p),l=>g(p,l)),Le(F,()=>e(D),l=>g(D,l)),La(c,[],M,()=>e(x),l=>g(x,l)),La(c,[],K,()=>e(x),l=>g(x,l)),_(y,ee),ze()}Me(["click","change"]);var It=m('<div class="text-base-content/60 text-xs italic"> </div>'),Ct=m('<span><span class="font-medium"> </span> </span>'),Qt=m('<div class="text-warning bg-warning/10 rounded p-2 text-xs"><strong>Retour :</strong> </div>'),St=(y,t,c)=>t(e(c).action),Lt=m("<button><!> <span> </span></button>"),qt=(y,t)=>t.onEdit(t.loan.$id),At=m('<button class="btn btn-ghost btn-sm" title="Modifier"><!></button>'),Dt=m('<div class="card bg-base-100 border-base-200 border text-left shadow-sm"><div class="card-body py-3"><div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between"><div class="flex min-w-0 flex-1 flex-col gap-4"><div class=" flex flex-wrap items-center gap-x-4 gap-y-1 text-base"><div class="flex items-center gap-1"><!> <span> </span></div> <div><!> <span> </span></div> <span> </span></div> <!> <div class="flex flex-wrap gap-2"></div> <!></div> <div class="flex flex-col gap-4 not-sm:mt-4"><!> <!></div></div></div></div>');function Nt(y,t){Te(t,!0);const c=L(()=>t.loan.materielItems),u=L(()=>{const n=new Date,v=new Date(t.loan.startDate),b=new Date(t.loan.endDate);return n<v?"future":n>=v&&n<=b?"current":"past"}),p=L(()=>{switch(e(u)){case"future":return{icon:Ca,class:"text-info",label:"À venir"};case"current":return{icon:Ia,class:"text-accent",label:"En cours"};case"past":default:return{icon:He,class:"",label:""}}});function D(n){if(t.loan.status!=="completed")return"";const v=n.lostQuantity||0,b=n.brokenQuantity||0,h=v+b;return n.quantity-h===0?"badge-error":h>0?"badge-warning":"badge-success"}const r=L(()=>!t.loan||!t.loan.status?{label:"Chargement...",badgeClass:"badge-neutral",icon:la}:{asked:{label:"En attente",badgeClass:"badge-warning",icon:la},accepted:{label:"confirmé",badgeClass:"badge-info",icon:Ne},refused:{label:"Refusé",badgeClass:"badge-error",icon:me},canceled:{label:"Annulé",badgeClass:"badge-neutral",icon:me},completed:{label:"Retour effectué",badgeClass:"badge-success",icon:Ne},archived:{label:"Archivé",badgeClass:"badge-neutral",icon:Wa},returned:{label:"Retourné",badgeClass:"badge-success",icon:Va}}[t.loan.status]||{label:"Statut inconnu",badgeClass:"badge-neutral",icon:la}),x=L(()=>()=>{switch(t.loan.status){case"asked":return[{label:"Confirmer",icon:Ne,action:t.onAccept,class:"btn-success"},{label:"Annuler",icon:Ga,action:t.onCancel,class:"btn-error btn-outline"}];case"accepted":return[{label:"Compléter Fiche retour",icon:Xa,action:t.onReturn,class:"btn-warning"}];case"completed":return[{label:"Fiche retour",icon:Ha,action:t.onReturn,class:""}];case"refused":case"canceled":return[{label:"Supprimer",icon:me,action:t.onDelete,class:"btn-error btn-sm"}];default:return[]}});function R(n){n?.(t.loan.$id)}var k=Dt(),z=a(k),H=a(z),X=a(H),B=a(X),N=a(B),$=a(N);za($,{class:"h-4 w-4"});var ae=s($,2),ee=a(ae),G=s(N,2),te=a(G);{var se=n=>{Ca(n,{class:"h-4 w-4"})},ne=n=>{var v=Ue(),b=ke(v);{var h=w=>{Ia(w,{class:"h-4 w-4"})},I=w=>{He(w,{class:"h-4 w-4"})};S(b,w=>{e(u)==="current"?w(h):w(I,!1)},!0)}_(n,v)};S(te,n=>{e(u)==="future"?n(se):n(ne,!1)})}var q=s(te,2),E=a(q),U=s(G,2),ce=a(U),j=s(B,2);{var re=n=>{var v=It(),b=a(v);T(()=>Q(b,`"${t.loan.notes??""}"`)),_(n,v)};S(j,n=>{t.loan.notes&&n(re)})}var V=s(j,2);xe(V,21,()=>e(c),da,(n,v)=>{var b=Ct(),h=a(b),I=a(h),w=s(h);T(F=>{ge(b,1,`badge badge-sm badge-soft ${F??""}`),Q(I,e(v).materielName),Q(w,` × ${e(v).quantity??""}`)},[()=>D(e(v))]),_(n,b)});var ie=s(V,2);{var o=n=>{var v=Qt(),b=s(a(v));T(()=>Q(b,` ${t.loan.returnNotes??""}`)),_(n,v)};S(ie,n=>{t.loan.returnNotes&&n(o)})}var f=s(X,2),d=a(f);xe(d,17,()=>e(x)(),da,(n,v)=>{var b=Lt();b.__click=[St,R,v];var h=a(b);Ye(h,()=>e(v).icon,(F,ve)=>{ve(F,{class:"h-4 w-4"})});var I=s(h,2),w=a(I);T(()=>{ge(b,1,`btn btn-sm ${e(v).class??""}`),Ge(b,"title",e(v).label),Q(w,e(v).label)}),_(n,b)});var i=s(d,2);{var P=n=>{var v=At();v.__click=[qt,t];var b=a(v);Ya(b,{class:"h-4 w-4"}),_(n,v)};S(i,n=>{t.onEdit&&t.loan.status==="asked"&&n(P)})}T((n,v)=>{Q(ee,t.loan.responsibleName),ge(G,1,`flex items-center gap-1 ${e(p).class??""} font-bold`),Q(E,`${n??""} - ${v??""}`),ge(U,1,`badge ${e(r).badgeClass??""} badge-sm gap-1`),Q(ce,e(r).label)},[()=>Aa(t.loan.startDate),()=>Aa(t.loan.endDate)]),_(y,k),ze()}Me(["click"]);async function Mt(y,t,c,u,p,D){if(e(t)){g(c,!0);try{const r=e(u).map(x=>({materielId:x.materielId,materielName:x.materielName,quantity:x.quantity,lostQuantity:x.lostQuantity>0?x.lostQuantity:void 0,brokenQuantity:x.brokenQuantity>0?x.brokenQuantity:void 0}));await J.updateLoan(p.loan.$id,{materiels:r,status:"returned",returnedAt:new Date().toISOString(),returnNotes:e(D).trim()||void 0}),p.onClose()}catch(r){console.error("Erreur retour emprunt:",r)}finally{g(c,!1)}}}function Ma(y,t,c){g(t,""),c.onClose()}var Tt=(y,t)=>{y.target.checked&&(e(t).lostQuantity=0,e(t).brokenQuantity=0)},zt=(y,t)=>{const c=y.target;e(t).lostQuantity=c.checked?1:0},Et=m('<div class="ml-8"><label class="input input-sm w-32"><span class="label text-xs">Qté perdue:</span> <input type="number" class="grow" min="0"/></label></div>'),Rt=(y,t)=>{const c=y.target;e(t).brokenQuantity=c.checked?1:0},jt=m('<div class="ml-8"><label class="input input-sm w-32"><span class="label text-xs">Qté cassée:</span> <input type="number" class="grow" min="0"/></label></div>'),Pt=m('<div class="border-base-300 bg-base-100 rounded-lg border p-4"><div class="mb-3 flex items-start gap-3"><div class="bg-primary/10 rounded-lg p-2"><!></div> <div class="flex-1"><div class="font-semibold"> </div> <div class="text-sm opacity-70"> </div></div></div> <div class="ml-10 space-y-3"><label class="flex cursor-pointer items-start gap-3"><input type="checkbox" class="checkbox checkbox-success checkbox-sm mt-1"/> <div class="text-sm"><div class="font-medium">Tout est OK</div> <div class="opacity-60">Aucune perte ni casse</div></div></label> <div class="space-y-2"><label class="flex cursor-pointer items-start gap-3"><input type="checkbox" class="checkbox checkbox-error checkbox-sm mt-1"/> <div class="flex-1 text-sm"><div class="flex items-center gap-2 font-medium"><!> Des pièces sont perdues</div></div></label> <!></div> <div class="space-y-2"><label class="flex cursor-pointer items-start gap-3"><input type="checkbox" class="checkbox checkbox-warning checkbox-sm mt-1"/> <div class="flex-1 text-sm"><div class="flex items-center gap-2 font-medium"><!> Des pièces sont cassées</div> <div class="text-xs opacity-60">À réparer (status: torepair)</div></div></label> <!></div></div></div>'),Ft=m('<div class="text-error"> </div>'),Ot=m('<div class="text-warning"> </div>'),Bt=m('<div class="alert alert-warning"><!> <div><h4 class="font-bold"> </h4> <div class="text-sm"><!> <!></div></div></div> )',1),Ut=m('<span class="loading loading-spinner loading-sm"></span>'),Vt=m(`<div><div class="modal-box fixed top-0 flex h-lvh w-lvw flex-col overflow-auto md:top-10 md:h-full md:max-h-11/12 md:w-full md:max-w-3xl"><div class="flex items-center justify-between border-b p-4 pt-0"><div><h3 class="text-lg font-bold">Retour d'emprunt</h3> <p class="text-sm opacity-70"> </p></div> <button class="btn btn-circle btn-ghost btn-sm absolute top-2 right-2" aria-label="Fermer"><!></button></div> <div class="flex-1 space-y-6 overflow-y-auto p-4"><div class="space-y-4"><h4 class="text-sm font-semibold uppercase opacity-70">Matériel à retourner</h4> <!></div> <!> <fieldset class="fieldset bg-base-100"><legend class="fieldset-legend">Notes de retour (optionnel)</legend> <textarea class="textarea textarea-bordered w-full" rows="3" placeholder="Précisez l'état du matériel, les raisons des pertes/casses, etc." maxlength="1000"></textarea></fieldset></div> <div class="border-base-300 flex-none border-t px-4 py-3"><div class="flex flex-wrap items-center justify-end gap-2"><button class="btn btn-ghost"><!> Annuler</button> <button class="btn btn-warning"><!> Valider le retour</button></div></div></div></div>`);function Wt(y,t){Te(t,!0);let c=O(pa([])),u=O(""),p=O(!1);Xe(()=>{if(!t.loan)return;const d=t.loan.materielItems;g(c,d.map(i=>({materielId:i.materielId,materielName:i.materielName,quantity:i.quantity,type:"",lostQuantity:0,brokenQuantity:0})),!0),d.forEach(i=>{const P=J.materiels.find(n=>n.$id===i.materielId);if(P){const n=e(c).find(v=>v.materielId===i.materielId);n&&(n.type=P.type||"")}})});const D=L(()=>e(c).every(d=>d.lostQuantity>=0&&d.brokenQuantity>=0&&d.lostQuantity+d.brokenQuantity<=d.quantity)&&!e(p)),r=L(()=>e(c).reduce((d,i)=>d+i.lostQuantity,0)),x=L(()=>e(c).reduce((d,i)=>d+i.brokenQuantity,0));function R(d){switch(d){case"electronic":return _a;case"manual":return We;case"cooking":return ba;case"dish":return ua;case"gaz":return va;case"hygiene":return ca;default:return Ve}}var k=Vt(),z=a(k),H=a(z),X=a(H),B=s(a(X),2),N=a(B),$=s(X,2);$.__click=[Ma,u,t];var ae=a($);me(ae,{class:"h-4 w-4"});var ee=s(H,2),G=a(ee),te=s(a(G),2);xe(te,17,()=>e(c),d=>d.materielId,(d,i,P)=>{const n=L(()=>R(e(i).type));var v=Pt(),b=a(v),h=a(b),I=a(h);Ye(I,()=>e(n),(le,_e)=>{_e(le,{class:"text-primary h-5 w-5"})});var w=s(h,2),F=a(w),ve=a(F),he=s(F,2),Y=a(he),M=s(b,2),Z=a(M),K=a(Z);K.__change=[Tt,i];var ue=s(Z,2),ye=a(ue),be=a(ye);be.__change=[zt,i];var we=s(be,2),Ie=a(we),Ze=a(Ie);Qa(Ze,{class:"h-3 w-3"});var Ke=s(ye,2);{var Je=le=>{var _e=Et(),Ae=a(_e),pe=s(a(Ae),2);T(()=>{Ge(pe,"max",e(i).quantity-e(i).brokenQuantity),pe.disabled=e(p)}),Le(pe,()=>e(i).lostQuantity,l=>e(i).lostQuantity=l),_(le,_e)};S(Ke,le=>{e(i).lostQuantity>0&&le(Je)})}var $e=s(ue,2),Ee=a($e),Ce=a(Ee);Ce.__change=[Rt,i];var ea=s(Ce,2),Qe=a(ea),aa=a(Qe);We(aa,{class:"h-3 w-3"});var qe=s(Ee,2);{var ta=le=>{var _e=jt(),Ae=a(_e),pe=s(a(Ae),2);T(()=>{Ge(pe,"max",e(i).quantity-e(i).lostQuantity),pe.disabled=e(p)}),Le(pe,()=>e(i).brokenQuantity,l=>e(i).brokenQuantity=l),_(le,_e)};S(qe,le=>{e(i).brokenQuantity>0&&le(ta)})}T(()=>{Q(ve,e(i).materielName),Q(Y,`Quantité empruntée : ${e(i).quantity??""}`),ia(K,e(i).lostQuantity===0&&e(i).brokenQuantity===0),K.disabled=e(p),ia(be,e(i).lostQuantity>0),be.disabled=e(p),ia(Ce,e(i).brokenQuantity>0),Ce.disabled=e(p)}),_(d,v)});var se=s(G,2);{var ne=d=>{var i=Bt(),P=ke(i),n=a(P);Qa(n,{class:"h-5 w-5"});var v=s(n,2),b=a(v),h=a(b),I=s(b,2),w=a(I);{var F=Y=>{var M=Ft(),Z=a(M);T(()=>Q(Z,`• ${e(r)??""} perdue${e(r)>1?"s":""} (déduit du stock)`)),_(Y,M)};S(w,Y=>{e(r)>0&&Y(F)})}var ve=s(w,2);{var he=Y=>{var M=Ot(),Z=a(M);T(()=>Q(Z,`• ${e(x)??""} cassée${e(x)>1?"s":""} (à réparer)`)),_(Y,M)};S(ve,Y=>{e(x)>0&&Y(he)})}T(()=>Q(h,`Attention : ${e(r)+e(x)} unité${e(r)+e(x)>1?"s":""} problématique${e(r)+e(x)>1?"s":""}`)),_(d,i)};S(se,d=>{(e(r)>0||e(x)>0)&&d(ne)})}var q=s(se,2),E=s(a(q),2),U=s(ee,2),ce=a(U),j=a(ce);j.__click=[Ma,u,t];var re=a(j);me(re,{class:"h-5 w-5"});var V=s(j,2);V.__click=[Mt,D,p,c,t,u];var ie=a(V);{var o=d=>{var i=Ut();_(d,i)},f=d=>{Ne(d,{class:"h-5 w-5"})};S(ie,d=>{e(p)?d(o):d(f,!1)})}T((d,i)=>{ge(k,1,`modal ${(t.isOpen&&"modal-open")??""}`),Q(N,`Du ${d??""} au ${i??""}`),E.disabled=e(p),j.disabled=e(p),V.disabled=!e(D)},[()=>new Date(t.loan.startDate).toLocaleDateString("fr-FR"),()=>new Date(t.loan.endDate).toLocaleDateString("fr-FR")]),Le(E,()=>e(u),d=>g(u,d)),_(y,k),ze()}Me(["click","change"]);function Ta(y,t,c,u){if(!e(t))return;if(!e(c).find(D=>D.$id===e(t))){fe.error("Équipe introuvable");return}g(u,!0)}var Ht=(y,t,c)=>t(e(c).$id),Xt=m('<button><!> <span class="badge badge-sm badge-neutral ml-2"> </span></button>'),Gt=m('<div class="tabs tabs-border bg-base-200 tabs-lg mb-6 font-medium"></div>'),Yt=m('<div class="alert alert-warning"><span>Vous devez être connecté pour voir les emprunts.</span></div>'),Zt=m('<div class="alert alert-error shadow-lg"><span> </span></div>'),Kt=m('<div class="alert alert-info"><span>Sélectionnez une équipe pour voir ses emprunts.</span></div>'),Jt=m(`<div class="bg-base-200 rounded-box border-base-200 border-2 border-dashed py-20 text-center"><!> <h3 class="mb-2 text-lg font-bold">Aucune réservation</h3> <p class="text-base-content/60 mb-6">Cette équipe n'a pas encore d'emprunt.</p> <button class="btn btn-primary btn-sm">Créer une réservation</button></div>`),$t=m('<div class="space-y-4"><div class="mb-6 flex justify-end"><button class="btn btn-primary btn-wide flex gap-2"><!> Ajouter une reservation</button></div> <!></div>'),es=m('<div class="container mx-auto p-4"><div class="mx-auto max-w-7xl px-4 py-8"><!> <!></div></div> <!> <!>',1);function ds(y,t){Te(t,!0);let c=O(!1),u=O(null),p=O(!1),D=O(null),r=O(!1);function x(){g(c,!1)}function R(){console.log("[LoansPage] Emprunt créé avec succès"),x()}function k(o){oa(`/dashboard/loans/return/${o}`)}function z(){g(p,!1),g(D,null)}async function H(o){try{await J.acceptLoan(o),fe.success("Emprunt accepté avec succès")}catch(f){console.error("[LoansPage] Erreur acceptation emprunt:",f),fe.error("Erreur lors de l'acceptation de l'emprunt")}}async function X(o){try{await J.cancelLoan(o),fe.success("Emprunt annulé avec succès")}catch(f){console.error("[LoansPage] Erreur annulation emprunt:",f),fe.error("Erreur lors de l'annulation de l'emprunt")}}async function B(o){try{await J.deleteLoan(o),fe.success("Emprunt supprimé avec succès")}catch(f){console.error("[LoansPage] Erreur suppression emprunt:",f),fe.error("Erreur lors de la suppression de l'emprunt")}}const N=L(()=>tt.myTeams),$=L(()=>e(u)?e(N).find(o=>o.$id===e(u)):null),ae=L(()=>{if(!e(u))return console.log("[LoansPage] teamLoans: pas d'activeTeamId"),[];const o=J.loans.filter(f=>f.ownerId===e(u));return console.log("[LoansPage] teamLoans filtrés:",{activeTeamId:e(u),totalLoans:J.loans.length,filteredCount:o.length,allLoans:J.loans.map(f=>({id:f.$id,ownerId:f.ownerId}))}),o});function ee(o){oa(`/dashboard/loans/${o}`)}Xe(()=>{const o=t.params?.teamId;if(o&&o!==e(u)){console.log("[LoansPage] teamIdFromParams:",o);const f=e(N).find(d=>d.$id===o);console.log("[LoansPage] équipe trouvée:",f),f&&(console.log("[LoansPage] Mise à jour activeTeamId:",o),g(u,o,!0))}else!o&&!e(u)&&!e(r)&&e(N).length>0&&(console.log("[LoansPage] Redirection vers première équipe:",e(N)[0].$id),g(r,!0),oa(`/dashboard/loans/${e(N)[0].$id}`))}),Xe(()=>{const f=(e(u)?e(N).find(d=>d.$id===e(u)):null)?.name||"Emprunts";qa.setConfig({title:f,materielContext:"loans",teamId:e(u)||void 0})}),at(()=>{qa.reset()});var G=es(),te=ke(G),se=a(te),ne=a(se);{var q=o=>{var f=Gt();xe(f,21,()=>e(N),d=>d.$id,(d,i)=>{const P=L(()=>J.loans.filter(w=>w.ownerId===e(i).$id).length);var n=Xt();n.__click=[Ht,ee,i];var v=a(n);Sa(v,{class:"mr-2 h-4 w-4"});var b=s(v),h=s(b),I=a(h);T(()=>{ge(n,1,`tab ${e(u)===e(i).$id?"tab-active":""}`),Q(b,` ${e(i).name??""} `),Q(I,e(P))}),_(d,n)}),_(o,f)};S(ne,o=>{e(N).length>1&&o(q)})}var E=s(ne,2);{var U=o=>{var f=Yt();_(o,f)},ce=o=>{var f=Ue(),d=ke(f);{var i=n=>{var v=Zt(),b=a(v),h=a(b);T(()=>Q(h,J.error)),_(n,v)},P=n=>{var v=Ue(),b=ke(v);{var h=w=>{var F=Kt();_(w,F)},I=w=>{var F=Ue(),ve=ke(F);{var he=M=>{var Z=Jt(),K=a(Z);Sa(K,{class:"mx-auto mb-4 h-12 w-12  text-center opacity-50"});var ue=s(K,6);ue.__click=[Ta,u,N,c],_(M,Z)},Y=M=>{var Z=$t(),K=a(Z),ue=a(K);ue.__click=[Ta,u,N,c];var ye=a(ue);Za(ye,{size:16});var be=s(K,2);xe(be,17,()=>e(ae),we=>we.$id,(we,Ie)=>{Nt(we,{get loan(){return e(Ie)},onReturn:k,onAccept:H,onCancel:X,onDelete:B})}),_(M,Z)};S(ve,M=>{e(ae).length===0?M(he):M(Y,!1)})}_(w,F)};S(b,w=>{e(u)?w(I,!1):w(h)},!0)}_(n,v)};S(d,n=>{J.error?n(i):n(P,!1)},!0)}_(o,f)};S(E,o=>{Se.isAuthenticated?o(ce,!1):o(U)})}var j=s(te,2);{var re=o=>{kt(o,{get isOpen(){return e(c)},onClose:x,onSuccess:R,get ownerId(){return e($).$id},get ownerName(){return e($).name}})};S(j,o=>{e($)&&o(re)})}var V=s(j,2);{var ie=o=>{Wt(o,{get loan(){return e(D)},get isOpen(){return e(p)},onClose:z})};S(V,o=>{e(p)&&e(D)&&o(ie)})}_(y,G),ze()}Me(["click"]);export{ds as default};
