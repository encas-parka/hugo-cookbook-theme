import{a2 as at,aw as Ta,aQ as tt,aR as et,n as rt,w as st,i as nt,aS as ot,aT as lt,H as Qa,X as ha,v as xa,O as it}from"./icons.js";import{q as O,Y as vt,ag as ut,V as i,k as J,g as e,a2 as _,b as o,c as dt,d as ct,C as ua,a0 as wa,v as x,h as r,Z as _t,m as a,u as da,W as f,X as q,e as bt,n as pt,ak as ft,_ as la,j as qa,i as yt,a4 as $,a9 as ca,aa as gt}from"./appwrite.js";import{m as ia,g as mt,h as kt}from"./index.js";import{g as Ia}from"./date-helpers.js";function Qt(aa,y,N,h,S,F,P){if(!a(y)||!a(N)||a(h))return;const ta=new Date,E=new Date(a(S)?.endDate||"");ta<E?x(F,!0):P()}var ht=i('<p class="text-sm opacity-70"> </p>'),xt=i('<div class="badge badge-info">Mode lecture seule</div>'),wt=i('<div class="alert alert-info max-md:alert-vertical mb-4"><!> <div><div class="font-bold">Retour enregistré</div> <div class="text-sm"> </div></div></div>'),qt=i("<div><!></div>"),It=i('<div class="badge badge-warning gap-2"><!> </div>'),Rt=i('<div class="badge badge-error gap-2"><!> </div>'),Dt=i('<div class="badge badge-success gap-2"><!> </div>'),Mt=i('<div class="flex items-center gap-6 p-2"><!> <!> <!></div>'),Nt=i('<div class="ms-auto flex flex-wrap items-center justify-end gap-6 p-2"><button type="button" aria-label="À réparer"><!> à réparer</button> <button type="button" aria-label="Perdu"><!> perdu</button> <button type="button" aria-label="Tout OK"><!></button></div>'),Bt=i('<div class="badge badge-warning gap-2"><!> </div>'),Lt=i('<div class="badge badge-error gap-2"><!> </div>'),Tt=i('<div class="badge badge-success gap-2"><!> </div>'),Ct=i('<div class="ms-auto flex flex-wrap justify-end gap-4"><!> <!> <!></div>'),St=(aa,y)=>{const N=a(y).lostQuantity,h=a(y).brokenQuantity;a(y).state="issues",a(y).okQuantity=Math.min(a(y).quantity-N-h,a(y).okQuantity)},At=i('<div class="min-w-[100px]"><label class="input w-full"><span class="label-text">ok</span> <input type="number"/></label></div>'),Pt=i('<button aria-label="Marquer comme ok">tout est ok</button>'),Et=i('<div class="flex flex-wrap gap-4"><div class="min-w-[140px]"><label class="input"><span class="label-text">À réparer</span> <input type="number" class="  input-sm w-full" aria-label="Marquer comme à réparer"/></label></div> <div class="min-w-[140px]"><label class="input w-full"><span class="label-text">Perdus</span> <input type="number"/></label></div> <!></div>'),Vt=i('<div class="bg-base-200 rounded-box flex flex-wrap items-center justify-between p-4"><div class="flex items-center gap-4"><!> <div class="text-lg font-semibold"> </div> <p class="font-semibold opacity-70"> </p></div> <!></div>'),jt=i('<div class="alert"><p class="whitespace-pre-wrap"> </p></div>'),zt=i('<p class="text-sm italic opacity-50">Aucune note</p>'),Ot=i(`<textarea class="textarea textarea-bordered w-full" rows="2" placeholder="Remarques sur l'état du matériel, problèmes constatés..." maxlength="500"></textarea>`),Ft=i('<div class="text-error label"><span> </span></div>'),Kt=i('<span class="loading loading-spinner loading-sm"></span>'),Wt=i('<button class="btn btn-ghost">"Annuler"</button> <button class="btn btn-primary gap-2"><!> Valider le retour</button>',1),Xt=i('<div class="card bg-base-100 mb-6 shadow-sm"><div class="card-body"><!> <h2 class="card-title mb-4"><!> Matériels empruntés</h2> <div class="space-y-4"></div> <fieldset class="fieldset bg-base-100 mt-6"><legend class="fieldset-legend">Notes de retour (optionnel)</legend> <!></fieldset></div> <!></div> <div class="flex justify-end gap-2"><!></div>',1),Zt=i(`<div class="alert alert-warning"><span>Chargement de l'emprunt...</span></div>`),Ht=(aa,y)=>x(y,!1),Ut=i('<span class="loading loading-spinner loading-sm"></span>'),Yt=(aa,y)=>x(y,!1),Gt=i(`<div class="modal modal-open"><div class="modal-box"><p class="py-4"> <strong> </strong>.
        Vous êtes en train d'effectuer le retour avant cette date.</p> <p class="pb-4">Vous confirmez ce retour anticipé ?</p> <div class="modal-action"><button class="btn btn-ghost">Annuler</button> <button class="btn btn-warning"><!></button></div></div> <div class="modal-backdrop"></div></div>`),Jt=i('<div class="container mx-auto p-4"><div class="mx-auto max-w-4xl"><div class="mb-6 flex items-center gap-4"><button class="btn btn-circle btn-ghost" aria-label="Retour"><!></button> <div class="flex-1"><h1 class="text-2xl font-bold">Fiche de retour</h1> <!></div> <!></div> <!></div></div> <!>',1);function re(aa,y){ct(y,!0);let N=O(null),h=O(!1),S=O(!1),F=O(!1),P=O(""),ta=O(null),E=O(vt([])),_a=O("");const K=da(()=>a(N)?ia.getLoanById(a(N)):null);function Ca(s){switch(s){case"electronic":return lt;case"manual":return ot;case"cooking":return nt;case"dish":return st;case"gaz":return rt;case"hygiene":return et;case"other":default:return tt}}ut(()=>{const s=y.params?.loanId;if(!s){ua.error("Emprunt non trouvé"),wa("/dashboard/loans");return}x(N,s,!0);const n=ia.getLoanById(s);if(!n||n.status!=="accepted"&&n.status!=="completed"){ua.error("Emprunt non valide"),wa("/dashboard/loans");return}n.status==="completed"?(x(S,!0),x(ta,n.returnedAt?new Date(n.returnedAt).toLocaleDateString("fr-FR"):null,!0),x(P,n.returnNotes||"",!0),x(E,n.materielItems.map(u=>{const g=u.lostQuantity||0,D=u.brokenQuantity||0,ea=u.quantity-g-D,U=ia.getMaterielById(u.materielId);return{materielId:u.materielId,materielName:u.materielName,materielType:U?.type||null,quantity:u.quantity,lostQuantity:g,brokenQuantity:D,okQuantity:ea,state:g>0||D>0?"issues":"ok"}}),!0)):x(E,n.materielItems.map(u=>{const g=ia.getMaterielById(u.materielId);return{materielId:u.materielId,materielName:u.materielName,materielType:g?.type||null,quantity:u.quantity,lostQuantity:0,brokenQuantity:0,okQuantity:u.quantity,state:"pending"}}),!0)});function H(s){const n=a(E)[s],u=n.lostQuantity,g=n.brokenQuantity;n.okQuantity=n.quantity-u-g,(n.lostQuantity>0||n.brokenQuantity>0)&&(n.state="issues")}const Ra=da(()=>{for(const s of a(E)){if(s.lostQuantity+s.brokenQuantity+s.okQuantity!==s.quantity)return x(_a,"erreur, veuillez vérifez le formulaire "),!1;if(s.state==="pending")return!1}return!0});function ba(){wa("/dashboard/loans")}async function Da(){if(a(N)){x(F,!1),x(h,!0);try{const s=a(E).map(n=>({materielId:n.materielId,materielName:n.materielName,quantity:n.quantity,lostQuantity:n.lostQuantity,brokenQuantity:n.brokenQuantity}));await ia.completeLoanWithReturn(a(N),{materiels:s,returnNotes:a(P).trim()||void 0}),ua.success("Retour enregistré avec succès"),ba()}catch(s){console.error("[LoanReturnPage] Erreur enregistrement retour:",s),ua.error("Erreur lors de l'enregistrement du retour")}finally{x(h,!1)}}}var Ma=Jt(),Na=J(Ma),Sa=e(Na),Ba=e(Sa),pa=e(Ba);pa.__click=ba;var Aa=e(pa);at(Aa,{class:"h-5 w-5"});var La=r(pa,2),Pa=r(e(La),2);{var Ea=s=>{var n=ht(),u=e(n);f((g,D)=>q(u,`Emprunt du ${g??""} au 
            ${D??""}`),[()=>Ia(a(K).startDate),()=>Ia(a(K).endDate)]),o(s,n)};_(Pa,s=>{a(K)&&s(Ea)})}var Va=r(La,2);{var ja=s=>{var n=xt();o(s,n)};_(Va,s=>{a(S)&&s(ja)})}var za=r(Ba,2);{var Oa=s=>{var n=Xt(),u=J(n),g=e(u),D=e(g);{var ea=b=>{var t=wt(),p=e(t);Ta(p,{class:"h-5 w-5"});var I=r(p,2),V=r(e(I),2),w=e(V);f(()=>q(w,`Le ${a(ta)??""}`)),o(b,t)};_(D,b=>{a(S)&&a(ta)&&b(ea)})}var U=r(D,2),fa=e(U);Ta(fa,{class:"h-5 w-5"});var Y=r(U,2);bt(Y,21,()=>a(E),yt,(b,t,p)=>{var I=Vt(),V=e(I);{const j=(W,X=pt)=>{const oa=da(()=>Ca(X()));var Z=qt(),m=e(Z);{let k=da(()=>kt(X()));ft(m,()=>a(oa),(Q,T)=>{T(Q,{get class(){return`${a(k)??""} h-5 w-5`}})})}f(k=>la(Z,1,`${k??""} rounded-lg p-2`),[()=>mt(X())]),o(W,Z)};var w=e(V);j(w,()=>a(t).materielType);var A=r(w,2),L=e(A),na=r(A,2),Ha=e(na);f(()=>{q(L,a(t).materielName),q(Ha,`(${a(t).quantity??""})`)})}var Ua=r(V,2);{var Ya=j=>{var W=qa(),X=J(W);{var oa=m=>{var k=Mt(),Q=e(k);{var T=l=>{var d=It(),c=e(d);Qa(c,{class:"h-4 w-4"});var v=r(c);f(()=>q(v,` À réparer : ${a(t).brokenQuantity??""}`)),o(l,d)};_(Q,l=>{a(t).brokenQuantity>0&&l(T)})}var R=r(Q,2);{var M=l=>{var d=Rt(),c=e(d);ha(c,{class:"h-4 w-4"});var v=r(c);f(()=>q(v,` Perdu : ${a(t).lostQuantity??""}`)),o(l,d)};_(R,l=>{a(t).lostQuantity>0&&l(M)})}var z=r(R,2);{var C=l=>{var d=Dt(),c=e(d);xa(c,{class:"h-4 w-4"});var v=r(c);f(()=>q(v,` OK : ${a(t).okQuantity??""}`)),o(l,d)};_(z,l=>{a(t).okQuantity>0&&l(C)})}o(m,k)},Z=m=>{var k=Nt(),Q=e(k);let T;Q.__click=()=>{a(t).state="issues",a(t).lostQuantity=0,a(t).brokenQuantity=1,H(p)};var R=e(Q);Qa(R,{class:"h-4 w-4"});var M=r(Q,2);let z;M.__click=()=>{a(t).state="issues",a(t).lostQuantity=1,a(t).brokenQuantity=0,H(p)};var C=e(M);ha(C,{class:"h-4 w-4"});var l=r(M,2);l.__click=()=>{a(t).state="ok",a(t).lostQuantity=0,a(t).brokenQuantity=0,H(p)};var d=e(l);xa(d,{class:""}),f((c,v)=>{T=la(Q,1,`btn btn-sm btn-warning ${a(t).brokenQuantity===0&&"btn-outline"}`,null,T,c),z=la(M,1,`btn btn-error btn-sm ${a(t).lostQuantity===0&&"btn-outline"}`,null,z,v),la(l,1,`btn btn-circle btn-sm btn-success ${a(t).state!=="ok"&&"btn-outline"}`)},[()=>({"ring-2":a(t).brokenQuantity>0,"ring-warning":a(t).brokenQuantity>0}),()=>({"ring-2":a(t).lostQuantity>0,"ring-error":a(t).lostQuantity>0})]),o(m,k)};_(X,m=>{a(S)?m(oa):m(Z,!1)})}o(j,W)},Ga=j=>{var W=qa(),X=J(W);{var oa=m=>{var k=Ct(),Q=e(k);{var T=l=>{var d=Bt(),c=e(d);Qa(c,{class:"h-4 w-4"});var v=r(c);f(()=>q(v,` À réparer : ${a(t).brokenQuantity??""}`)),o(l,d)};_(Q,l=>{a(t).brokenQuantity>0&&l(T)})}var R=r(Q,2);{var M=l=>{var d=Lt(),c=e(d);ha(c,{class:"h-4 w-4"});var v=r(c);f(()=>q(v,` Perdus : ${a(t).lostQuantity??""}`)),o(l,d)};_(R,l=>{a(t).lostQuantity>0&&l(M)})}var z=r(R,2);{var C=l=>{var d=Tt(),c=e(d);xa(c,{class:"h-4 w-4"});var v=r(c);f(()=>q(v,` OK : ${a(t).okQuantity??""}`)),o(l,d)};_(z,l=>{a(t).okQuantity>0&&l(C)})}o(m,k)},Z=m=>{var k=Et(),Q=e(k),T=e(Q),R=r(e(T),2);$(R,"min",0),R.__change=()=>H(p);var M=r(Q,2),z=e(M),C=r(e(z),2);$(C,"min",0),C.__change=()=>H(p);var l=r(M,2);{var d=v=>{var G=At(),Ja=e(G),va=r(e(Ja),2);$(va,"min",0),va.__change=[St,t],f(()=>$(va,"max",a(t).quantity)),ca(va,()=>a(t).okQuantity,$a=>a(t).okQuantity=$a),o(v,G)},c=v=>{var G=Pt();G.__click=()=>{a(t).state="ok",a(t).lostQuantity=0,a(t).brokenQuantity=0,H(p)},f(()=>la(G,1,`btn btn-success ${a(t).state!=="ok"&&"btn-outline"}`)),o(v,G)};_(l,v=>{a(t).lostQuantity>0||a(t).brokenQuantity>0?v(d):v(c,!1)})}f(()=>{$(R,"max",a(t).quantity),$(C,"max",a(t).quantity)}),ca(R,()=>a(t).brokenQuantity,v=>a(t).brokenQuantity=v),ca(C,()=>a(t).lostQuantity,v=>a(t).lostQuantity=v),o(m,k)};_(X,m=>{a(S)?m(oa):m(Z,!1)})}o(j,W)};_(Ua,j=>{a(t).quantity===1?j(Ya):j(Ga,!1)})}o(b,I)});var ra=r(Y,2),ya=r(e(ra),2);{var ga=b=>{var t=qa(),p=J(t);{var I=w=>{var A=jt(),L=e(A),na=e(L);f(()=>q(na,a(P))),o(w,A)},V=w=>{var A=zt();o(w,A)};_(p,w=>{a(P)?w(I):w(V,!1)})}o(b,t)},ma=b=>{var t=Ot();f(()=>t.disabled=a(h)),ca(t,()=>a(P),p=>x(P,p)),o(b,t)};_(ya,b=>{a(S)?b(ga):b(ma,!1)})}var ka=r(g,2);{var B=b=>{var t=Ft(),p=e(t),I=e(p);f(()=>q(I,a(_a))),o(b,t)};_(ka,b=>{a(_a)&&b(B)})}var sa=r(u,2),Xa=e(sa);{var Za=b=>{var t=Wt(),p=J(t);p.__click=ba;var I=r(p,2);I.__click=[Qt,N,Ra,h,K,F,Da];var V=e(I);{var w=L=>{var na=Kt();o(L,na)},A=L=>{it(L,{class:"h-4 w-4"})};_(V,L=>{a(h)?L(w):L(A,!1)})}f(()=>{p.disabled=a(h),I.disabled=!a(Ra)||a(h)}),o(b,t)};_(Xa,b=>{a(S)||b(Za)})}o(s,n)},Fa=s=>{var n=Zt();o(s,n)};_(za,s=>{a(K)?s(Oa):s(Fa,!1)})}var Ka=r(Na,2);{var Wa=s=>{var n=Gt(),u=e(n),g=e(u),D=e(g);D.nodeValue="Bizarre ! La date de fin de l'emprunt est prévue pour le  ";var ea=r(D),U=e(ea),fa=r(g,4),Y=e(fa);Y.__click=[Ht,F];var ra=r(Y,2);ra.__click=Da;var ya=e(ra);{var ga=B=>{var sa=Ut();o(B,sa)},ma=B=>{var sa=gt("Confirmer le retour");o(B,sa)};_(ya,B=>{a(h)?B(ga):B(ma,!1)})}var ka=r(u,2);ka.__click=[Yt,F],f(B=>{q(U,B),Y.disabled=a(h),ra.disabled=a(h)},[()=>a(K)?Ia(a(K).endDate):""]),o(s,n)};_(Ka,s=>{a(F)&&s(Wa)})}o(aa,Ma),dt()}_t(["click","change"]);export{re as default};
