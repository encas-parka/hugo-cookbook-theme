import{a7 as nt,ax as Ea,aQ as ot,aR as lt,r as it,D as vt,k as ut,aS as dt,aT as ct,Q as qa,X as Ia,z as Ra,_ as _t}from"./icons.js";import{y as P,z as bt,Z as pt,v,k as ta,g as r,I as _,b as l,c as ft,d as yt,M as da,E as Da,A as h,a2 as oa,h as o,B as gt,m as a,u as ca,w as g,x as R,e as mt,n as kt,a6 as xt,aY as Qt,C as la,j as Ma,i as ht,a$ as wt,L as ea,R as _a,S as qt,o as e,K as ia,U as Ba,aq as It}from"./appwrite.js";import{g as La}from"./date-helpers.js";var Rt=v('<p class="text-sm opacity-70"> </p>'),Dt=v('<div class="badge badge-info">Mode lecture seule</div>'),Mt=v('<div class="alert alert-info max-md:alert-vertical mb-4"><!> <div><div class="font-bold">Retour enregistré</div> <div class="text-sm"> </div></div></div>'),Bt=v("<div><!></div>"),Lt=v('<div class="badge badge-warning gap-2"><!> </div>'),Nt=v('<div class="badge badge-error gap-2"><!> </div>'),St=v('<div class="badge badge-success gap-2"><!> </div>'),Tt=v('<div class="flex items-center gap-6 p-2"><!> <!> <!></div>'),zt=v('<div class="ms-auto flex flex-wrap items-center justify-end gap-6 p-2"><button type="button" aria-label="À réparer"><!> à réparer</button> <button type="button" aria-label="Perdu"><!> perdu</button> <button type="button" aria-label="Tout OK"><!></button></div>'),At=v('<div class="badge badge-warning gap-2"><!> </div>'),Ct=v('<div class="badge badge-error gap-2"><!> </div>'),Et=v('<div class="badge badge-success gap-2"><!> </div>'),Pt=v('<div class="ms-auto flex flex-wrap justify-end gap-4"><!> <!> <!></div>'),jt=v('<div class="min-w-[100px]"><label class="input w-full"><span class="label-text">ok</span> <input type="number"/></label></div>'),Vt=v('<button aria-label="Marquer comme ok">tout est ok</button>'),Kt=v('<div class="flex flex-wrap gap-4"><div class="min-w-[140px]"><label class="input"><span class="label-text">À réparer</span> <input type="number" class="  input-sm w-full" aria-label="Marquer comme à réparer"/></label></div> <div class="min-w-[140px]"><label class="input w-full"><span class="label-text">Perdus</span> <input type="number"/></label></div> <!></div>'),Ot=v('<div class="bg-base-200 rounded-box flex flex-wrap items-center justify-between px-4 py-1"><div class="flex items-center gap-4"><!> <div class="text-base font-medium"> </div> <div class="font-semibold opacity-70"> </div></div> <!></div>'),Ft=v('<div class="alert"><p class="whitespace-pre-wrap"> </p></div>'),Ut=v('<p class="text-sm italic opacity-50">Aucune note</p>'),Wt=v(`<textarea class="textarea textarea-bordered w-full" rows="2" placeholder="Remarques sur l'état du matériel, problèmes constatés..." maxlength="500"></textarea>`),Zt=v('<div class="text-error label"><span> </span></div>'),Xt=v('<span class="loading loading-spinner loading-sm"></span>'),Yt=v('<button class="btn btn-ghost">"Annuler"</button> <button class="btn btn-primary gap-2"><!> Valider le retour</button>',1),Gt=v('<div class="card bg-base-100 mb-6 shadow-sm"><div class="card-body"><!> <h2 class="card-title mb-4"><!> Matériels empruntés</h2> <div class="space-y-4"></div> <fieldset class="fieldset bg-base-100 mt-6"><legend class="fieldset-legend">Notes de retour (optionnel)</legend> <!></fieldset></div> <!></div> <div class="flex justify-end gap-2"><!></div>',1),Ht=v(`<div class="alert alert-warning"><span>Chargement de l'emprunt...</span></div>`),Jt=v('<span class="loading loading-spinner loading-sm"></span>'),$t=v(`<div class="modal modal-open"><div class="modal-box"><p class="py-4"> <strong> </strong>.
        Vous êtes en train d'effectuer le retour avant cette date.</p> <p class="pb-4">Vous confirmez ce retour anticipé ?</p> <div class="modal-action"><button class="btn btn-ghost">Annuler</button> <button class="btn btn-warning"><!></button></div></div> <div class="modal-backdrop"></div></div>`),ae=v('<div class="container mx-auto p-4"><div class="mx-auto max-w-4xl"><div class="mb-6 flex items-center gap-4"><button class="btn btn-circle btn-ghost" aria-label="Retour"><!></button> <div class="flex-1"><h1 class="text-2xl font-bold">Fiche de retour</h1> <!></div> <!></div> <!></div></div> <!>',1);function se(Pa,Na){yt(Na,!0);let X=P(null),S=P(!1),j=P(!1),ra=P(!1),Y=P(""),ba=P(null),G=P(bt([])),pa=P("");const V=ca(()=>a(X)?oa.getLoanById(a(X)):null);function ja(n){switch(n){case"electronic":return ct;case"manual":return dt;case"cooking":return ut;case"dish":return vt;case"gaz":return it;case"hygiene":return lt;default:return ot}}pt(()=>{const n=Na.params?.loanId;if(!n){da.error("Emprunt non trouvé"),Da("/dashboard/loans");return}h(X,n,!0);const s=oa.getLoanById(n);if(!s||s.status!=="accepted"&&s.status!=="completed"){da.error("Emprunt non valide"),Da("/dashboard/loans");return}s.status==="completed"?(h(j,!0),h(ba,s.returnedAt?new Date(s.returnedAt).toLocaleDateString("fr-FR"):null,!0),h(Y,s.returnNotes||"",!0),h(G,s.materielItems.map(d=>{const m=d.lostQuantity||0,D=d.brokenQuantity||0,J=d.quantity-m-D,K=oa.getMaterielById(d.materielId);return{materielId:d.materielId,materielName:d.materielName,materielType:K?.type||null,quantity:d.quantity,lostQuantity:m,brokenQuantity:D,okQuantity:J,state:m>0||D>0?"issues":"ok"}}),!0)):h(G,s.materielItems.map(d=>{const m=oa.getMaterielById(d.materielId);return{materielId:d.materielId,materielName:d.materielName,materielType:m?.type||null,quantity:d.quantity,lostQuantity:0,brokenQuantity:0,okQuantity:d.quantity,state:"pending"}}),!0)});function H(n){const s=a(G)[n],d=s.lostQuantity,m=s.brokenQuantity;s.okQuantity=s.quantity-d-m,(s.lostQuantity>0||s.brokenQuantity>0)&&(s.state="issues")}const Sa=ca(()=>{for(const n of a(G)){if(n.lostQuantity+n.brokenQuantity+n.okQuantity!==n.quantity)return h(pa,"erreur, veuillez vérifez le formulaire "),!1;if(n.state==="pending")return!1}return!0});function fa(){Da("/dashboard/loans")}function Va(){if(!a(X)||!a(Sa)||a(S))return;const n=new Date,s=new Date(a(V)?.endDate||"");n<s?h(ra,!0):Ta()}async function Ta(){if(a(X)){h(ra,!1),h(S,!0);try{const n=a(G).map(s=>({materielId:s.materielId,materielName:s.materielName,quantity:s.quantity,lostQuantity:s.lostQuantity,brokenQuantity:s.brokenQuantity}));await oa.completeLoanWithReturn(a(X),{materiels:n,returnNotes:a(Y).trim()||void 0}),da.success("Retour enregistré avec succès"),fa()}catch(n){console.error("[LoanReturnPage] Erreur enregistrement retour:",n),da.error("Erreur lors de l'enregistrement du retour")}finally{h(S,!1)}}}var za=ae(),ya=ta(za),Aa=r(ya),ga=r(Aa),va=r(ga);va.__click=fa;var Ka=r(va);nt(Ka,{class:"h-5 w-5"}),e(va);var ma=o(va,2),Oa=o(r(ma),2);{var Fa=n=>{var s=Rt(),d=r(s);e(s),g((m,D)=>R(d,`Emprunt du ${m??""} au 
            ${D??""}`),[()=>La(a(V).startDate),()=>La(a(V).endDate)]),l(n,s)};_(Oa,n=>{a(V)&&n(Fa)})}e(ma);var Ua=o(ma,2);{var Wa=n=>{var s=Dt();l(n,s)};_(Ua,n=>{a(j)&&n(Wa)})}e(ga);var Za=o(ga,2);{var Xa=n=>{var s=Gt(),d=ta(s),m=r(d),D=r(m);{var J=b=>{var t=Mt(),p=r(t);Ea(p,{class:"h-5 w-5"});var x=o(p,2),z=o(r(x),2),w=r(z);e(z),e(x),e(t),g(()=>R(w,`Le ${a(ba)??""}`)),l(b,t)};_(D,b=>{a(j)&&a(ba)&&b(J)})}var K=o(D,2),ua=r(K);Ea(ua,{class:"h-5 w-5"}),ia(),e(K);var O=o(K,2);mt(O,21,()=>a(G),ht,(b,t,p)=>{var x=Ot(),z=r(x);{const C=(U,W=kt)=>{const sa=ca(()=>ja(W()));var E=Bt(),Q=r(E);{let f=ca(()=>wt(W()));xt(Q,()=>a(sa),(k,L)=>{L(k,{get class(){return`${a(f)??""} size-5`}})})}e(E),g(f=>la(E,1,`${f??""} rounded-lg p-2`),[()=>Qt(W())]),l(U,E)};var w=r(z);C(w,()=>a(t).materielType);var M=o(w,2),B=r(M,!0);e(M);var aa=o(M,2),at=r(aa);e(aa),e(z),g(()=>{R(B,a(t).materielName),R(at,`(${a(t).quantity??""})`)})}var tt=o(z,2);{var et=C=>{var U=Ma(),W=ta(U);{var sa=Q=>{var f=Tt(),k=r(f);{var L=i=>{var u=Lt(),y=r(u);qa(y,{class:"h-4 w-4"});var c=o(y);e(u),g(()=>R(c,` À réparer : ${a(t).brokenQuantity??""}`)),l(i,u)};_(k,i=>{a(t).brokenQuantity>0&&i(L)})}var q=o(k,2);{var I=i=>{var u=Nt(),y=r(u);Ia(y,{class:"h-4 w-4"});var c=o(y);e(u),g(()=>R(c,` Perdu : ${a(t).lostQuantity??""}`)),l(i,u)};_(q,i=>{a(t).lostQuantity>0&&i(I)})}var A=o(q,2);{var N=i=>{var u=St(),y=r(u);Ra(y,{class:"h-4 w-4"});var c=o(y);e(u),g(()=>R(c,` OK : ${a(t).okQuantity??""}`)),l(i,u)};_(A,i=>{a(t).okQuantity>0&&i(N)})}e(f),l(Q,f)},E=Q=>{var f=zt(),k=r(f);let L;k.__click=()=>{a(t).state="issues",a(t).lostQuantity=0,a(t).brokenQuantity=1,H(p)};var q=r(k);qa(q,{class:"h-4 w-4"}),ia(),e(k);var I=o(k,2);let A;I.__click=()=>{a(t).state="issues",a(t).lostQuantity=1,a(t).brokenQuantity=0,H(p)};var N=r(I);Ia(N,{class:"h-4 w-4"}),ia(),e(I);var i=o(I,2);i.__click=()=>{a(t).state="ok",a(t).lostQuantity=0,a(t).brokenQuantity=0,H(p)};var u=r(i);Ra(u,{class:""}),e(i),e(f),g(()=>{L=la(k,1,`btn btn-sm btn-warning ${a(t).brokenQuantity===0&&"btn-outline"}`,null,L,{"ring-2":a(t).brokenQuantity>0,"ring-warning":a(t).brokenQuantity>0}),A=la(I,1,`btn btn-error btn-sm ${a(t).lostQuantity===0&&"btn-outline"}`,null,A,{"ring-2":a(t).lostQuantity>0,"ring-error":a(t).lostQuantity>0}),la(i,1,`btn btn-circle btn-sm btn-success ${a(t).state!=="ok"&&"btn-outline"}`)}),l(Q,f)};_(W,Q=>{a(j)?Q(sa):Q(E,!1)})}l(C,U)},rt=C=>{var U=Ma(),W=ta(U);{var sa=Q=>{var f=Pt(),k=r(f);{var L=i=>{var u=At(),y=r(u);qa(y,{class:"h-4 w-4"});var c=o(y);e(u),g(()=>R(c,` À réparer : ${a(t).brokenQuantity??""}`)),l(i,u)};_(k,i=>{a(t).brokenQuantity>0&&i(L)})}var q=o(k,2);{var I=i=>{var u=Ct(),y=r(u);Ia(y,{class:"h-4 w-4"});var c=o(y);e(u),g(()=>R(c,` Perdus : ${a(t).lostQuantity??""}`)),l(i,u)};_(q,i=>{a(t).lostQuantity>0&&i(I)})}var A=o(q,2);{var N=i=>{var u=Et(),y=r(u);Ra(y,{class:"h-4 w-4"});var c=o(y);e(u),g(()=>R(c,` OK : ${a(t).okQuantity??""}`)),l(i,u)};_(A,i=>{a(t).okQuantity>0&&i(N)})}e(f),l(Q,f)},E=Q=>{var f=Kt(),k=r(f),L=r(k),q=o(r(L),2);Ba(q),ea(q,"min",0),q.__change=()=>H(p),e(L),e(k);var I=o(k,2),A=r(I),N=o(r(A),2);Ba(N),ea(N,"min",0),N.__change=()=>H(p),e(A),e(I);var i=o(I,2);{var u=c=>{var Z=jt(),Ca=r(Z),na=o(r(Ca),2);Ba(na),ea(na,"min",0),na.__change=()=>{const wa=a(t).lostQuantity,st=a(t).brokenQuantity;a(t).state="issues",a(t).okQuantity=Math.min(a(t).quantity-wa-st,a(t).okQuantity)},e(Ca),e(Z),g(()=>ea(na,"max",a(t).quantity)),_a(na,()=>a(t).okQuantity,wa=>a(t).okQuantity=wa),l(c,Z)},y=c=>{var Z=Vt();Z.__click=()=>{a(t).state="ok",a(t).lostQuantity=0,a(t).brokenQuantity=0,H(p)},g(()=>la(Z,1,`btn btn-success ${a(t).state!=="ok"&&"btn-outline"}`)),l(c,Z)};_(i,c=>{a(t).lostQuantity>0||a(t).brokenQuantity>0?c(u):c(y,!1)})}e(f),g(()=>{ea(q,"max",a(t).quantity),ea(N,"max",a(t).quantity)}),_a(q,()=>a(t).brokenQuantity,c=>a(t).brokenQuantity=c),_a(N,()=>a(t).lostQuantity,c=>a(t).lostQuantity=c),l(Q,f)};_(W,Q=>{a(j)?Q(sa):Q(E,!1)})}l(C,U)};_(tt,C=>{a(t).quantity===1?C(et):C(rt,!1)})}e(x),l(b,x)}),e(O);var F=o(O,2),ka=o(r(F),2);{var xa=b=>{var t=Ma(),p=ta(t);{var x=w=>{var M=Ft(),B=r(M),aa=r(B,!0);e(B),e(M),g(()=>R(aa,a(Y))),l(w,M)},z=w=>{var M=Ut();l(w,M)};_(p,w=>{a(Y)?w(x):w(z,!1)})}l(b,t)},Qa=b=>{var t=Wt();It(t),g(()=>t.disabled=a(S)),_a(t,()=>a(Y),p=>h(Y,p)),l(b,t)};_(ka,b=>{a(j)?b(xa):b(Qa,!1)})}e(F),e(m);var ha=o(m,2);{var T=b=>{var t=Zt(),p=r(t),x=r(p,!0);e(p),e(t),g(()=>R(x,a(pa))),l(b,t)};_(ha,b=>{a(pa)&&b(T)})}e(d);var $=o(d,2),Ja=r($);{var $a=b=>{var t=Yt(),p=ta(t);p.__click=fa;var x=o(p,2);x.__click=Va;var z=r(x);{var w=B=>{var aa=Xt();l(B,aa)},M=B=>{_t(B,{class:"h-4 w-4"})};_(z,B=>{a(S)?B(w):B(M,!1)})}ia(),e(x),g(()=>{p.disabled=a(S),x.disabled=!a(Sa)||a(S)}),l(b,t)};_(Ja,b=>{a(j)||b($a)})}e($),l(n,s)},Ya=n=>{var s=Ht();l(n,s)};_(Za,n=>{a(V)?n(Xa):n(Ya,!1)})}e(Aa),e(ya);var Ga=o(ya,2);{var Ha=n=>{var s=$t(),d=r(s),m=r(d),D=r(m);D.nodeValue="Bizarre ! La date de fin de l'emprunt est prévue pour le  ";var J=o(D),K=r(J,!0);e(J),ia(),e(m);var ua=o(m,4),O=r(ua);O.__click=()=>h(ra,!1);var F=o(O,2);F.__click=Ta;var ka=r(F);{var xa=T=>{var $=Jt();l(T,$)},Qa=T=>{var $=qt("Confirmer le retour");l(T,$)};_(ka,T=>{a(S)?T(xa):T(Qa,!1)})}e(F),e(ua),e(d);var ha=o(d,2);ha.__click=()=>h(ra,!1),e(s),g(T=>{R(K,T),O.disabled=a(S),F.disabled=a(S)},[()=>a(V)?La(a(V).endDate):""]),l(n,s)};_(Ga,n=>{a(ra)&&n(Ha)})}l(Pa,za),ft()}gt(["click","change"]);export{se as default};
