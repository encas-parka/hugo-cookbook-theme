import{Z as ne,g as e,u as m,p as Ae,b as w,aa as xe,W as A,E as ae,$ as k,v as g,w as Ee,x as Ie,s as b,a as s,B as c,A as p,X as ie,Y as se,D as Re}from"./vendor.js";import{t as v,y as S,C as ke,a as u,z as U,E as Se,F as Le,I as Be,H as De}from"./appwrite.js";import{r as j}from"./RecipeDataStore.svelte.js";import{n as oe}from"./index.js";import{t as $e,a as K,v as Ve,e as qe,n as Ce,p as ze,f as He,R as Te,b as Ue,d as We}from"./RecipeEditPage2.js";import"./AutocompleteInput.js";import{C as Me}from"./ConfirmModal.js";import{U as Fe}from"./UnsavedChangesGuard.js";import{R as Pe,a as Ge}from"./RecipeVariants.js";import{s as Oe,r as Ze,b as je,T as Ke}from"./icons.js";import"./editor.js";import"./markdown.js";import"./products-display.js";import"./Fieldset.js";import"./BtnGroupCheck.js";import"./CheckboxBadge.js";import"./keyboardNavigation.svelte.js";ne(["click"]);function Xe(W,x,M){e(x)&&S(`/recipe/${e(M)}/duplicate`)}function Ye(W,x){s(x,!0)}var Je=A('<div class="flex items-center gap-2"><button class="btn btn-secondary btn-soft"><!> Cr√©er une version alternative</button> <button class="btn btn-accent"><!> </button></div>'),Ne=A('<div class="flex items-center justify-center py-20"><div class="loading loading-spinner loading-lg"></div></div>'),Qe=A('<div class="mt-8 print:hidden"><!></div>'),er=A(`<div class="alert alert-error alert-soft border-error mt-8 border-1"><!> <div class="flex-1"><h4 class="font-bold">Zone de danger</h4> <p class="text-sm">La suppression d'une recette est irr√©versible. Si elle √©tait
              utilis√© dans des √©v√©nements, ceux-ci n'y auront plus acc√®s. Vous
              √™tes seul¬∑e autoris√© √† supprimer une recettes que vous avez cr√©e.
              Les versions alternatives cr√©es √† partir de celle-ci ne seront pas
              supprim√©e.</p></div> <button class="btn btn-error btn-sm"> </button></div>`),rr=A('<div class="space-y-6"><!> <!> <!> <!> <!> <!></div>'),tr=A(`<div class="bg-base-100 rounded-t-box fixed bottom-0 left-0"><div class=" bg-warning/40 rounded-t-box flex size-full items-center px-4 py-1"><!> V√©rouill√© : document en cours d'√©dition par un¬∑e autre utilisateur¬∑ice.</div></div>`),ar=A('<div class="max-w-9xl container mx-auto px-4 py-8"><!></div> <!> <!> <!>',1);function wr(W,x){Ie(x,!0);const M=t=>{var i=Je(),n=p(i);n.__click=[Xe,r,a];var f=p(n);Oe(f,{class:"h-4 w-4"});var d=c(n,2);d.__click=X;var l=p(d);Ze(l,{class:"h-4 w-4"});var R=c(l);ie(()=>{n.disabled=!e(I)||e(_),d.disabled=!e(I)||e(_)||!e(q),se(R,` ${e(_)?"Sauvegarde...":"Sauvegarder"}`)}),g(t,i)},a=m(()=>x.params?.uuid);if(!e(a))throw v.error("ID de recette manquant"),S("/recipe"),new Error("recipeId is required");let r=b(null),L=b(!1),E=b(!0),_=b(!1),y=b(null),D=null,B=b(null),$=b(!1),V=b(!1),F=Ae({value:{}});const q=m(()=>!e(r)||!e(B)?!1:K(e(r))!==e(B));w(()=>{e(r)&&e(r).check!==!0&&(e(r).draft=!0)});const P=m(()=>!!e(y)&&e(y)!==u.userId),C=m(()=>!!e(y)&&e(y)===u.userId),I=m(()=>!e(P)&&!e(E)),ce=m(()=>({materiel:j.materiel,categories:j.categories,regimes:j.regimes}));w(()=>{ke()}),w(()=>{if(!u.userId){v.error("Vous devez √™tre connect√©"),S("/");return}}),w(()=>{e(a)&&!e(L)&&!e(E)||e(a)&&e(L)||e(a)&&!e(L)&&e(E)&&U.getRecipeByUuid(e(a)).then(async t=>{t?(s(r,$e(t,{$createdAt:t.$createdAt,$updatedAt:t.$updatedAt,createdBy:t.createdBy}),!0),s(y,t.lockedBy||null,!0),s(L,!0),s(E,!1),await de()):(v.error("Recette introuvable"),S("/recipe"))}).catch(t=>{console.error("Erreur chargement:",t),v.error("Erreur lors du chargement"),S("/recipe")}).finally(()=>{s(E,!1)})}),w(()=>{e(r)&&e(L)&&!e(B)&&s(B,K(e(r)),!0)}),w(()=>{oe.setConfig({title:e(r)?.title||"√âdition de recette",actions:M})}),xe(async()=>{oe.reset(),O(),e(C)&&!e(_)&&await z(),window.removeEventListener("beforeunload",G)});function G(t){e(q)&&(t.preventDefault(),t.returnValue="")}w(()=>{e(q)?window.addEventListener("beforeunload",G):window.removeEventListener("beforeunload",G)});function ue(){O(),!(!e(a)||!e(C))&&(D=setInterval(async()=>{try{console.log("üíì Heartbeat: Refreshing lock..."),await U.updateRecipeLock(e(a),u.userId)}catch(t){console.error("‚ùå Heartbeat failed:",t)}},12e4))}function O(){D&&(clearInterval(D),D=null)}async function de(){if(!e(a)||!u.userId||!e(r))return!1;if((e(r).permissionWrite||[]).length<=1)return console.log("‚ÑπÔ∏è Verrou ignor√© (contributeur unique)"),!0;try{const i=e(r).lockedBy,n=e(r).$updatedAt?new Date(e(r).$updatedAt):null,f=n&&Date.now()-n.getTime()>3e5;if(i&&i!==u.userId)if(f)console.log("‚è≥ Verrou pr√©c√©dent expir√©, reprise de contr√¥le...");else return!1;return await U.updateRecipeLock(e(a),u.userId),s(y,u.userId,!0),console.log("üîí Verrou acquis"),ue(),!0}catch(i){return console.error("‚ùå Erreur acquisition verrou:",i),v.error("Impossible de verrouiller la recette"),!1}}async function z(){if(e(a)){O();try{await U.updateRecipeLock(e(a),null),s(y,null),console.log("üîì Verrou lib√©r√©")}catch(t){console.error("‚ùå Erreur lib√©ration verrou:",t)}}}async function X(){if(!e(r)||e(_)||!u.userId||!Ve(e(r),F))return;s(_,!0);const i=v.loading("Sauvegarde en cours...");try{const{regimes:n}=qe(e(r).ingredients),d={...Ce(e(r)),categories:e(r).categories,regime:n,saison:e(r).saison,ingredients:Le(e(r).ingredients),quantite_desc:e(r).quantite_desc,auteur:e(r).auteur,preparation24h:e(r).preparation24h,astuces:Se(e(r).astuces),prepAlt:e(r).prepAlt,$id:e(r).$id},l=await Be(e(a),d,u.userId);s(B,K(e(r)),!0);const R=ze(e(r),d,{id:l.$id,createdAt:l.$createdAt,updatedAt:l.$updatedAt,createdBy:l.createdBy});De("save_recipe",e(a),u.userId,R,!0).catch(H=>{console.error("Sync vers GitHub √©chou√©e:",H)}),v.update(i,{state:"success",message:"Recette sauvegard√©e !"}),await z()}catch(n){console.error("Erreur sauvegarde:",n),v.update(i,{state:"error",message:"Erreur lors de la sauvegarde"})}finally{s(_,!1),setTimeout(()=>v.dismiss(i),3e3)}}async function le(){if(e(a)){s(V,!0);try{await He(e(a),async()=>{e(C)&&await z()}),setTimeout(()=>{S("/recipe")},1500)}catch(t){console.error("Erreur lors de la suppression:",t)}finally{s(V,!1),s($,!1)}}}var Y=ar(),J=ae(Y),pe=p(J);{var ve=t=>{var i=Ne();g(t,i)},fe=t=>{var i=Re(),n=ae(i);{var f=d=>{var l=rr(),R=p(l);Te(R,{get recipeInfo(){return e(ce)},get validationErrors(){return F.value},get canEdit(){return e(I)},get recipe(){return e(r)},set recipe(o){s(r,o,!0)}});var H=c(R,2);Ue(H,{get validationErrors(){return F.value},get canEdit(){return e(I)},get recipe(){return e(r)},set recipe(o){s(r,o,!0)}});var ee=c(H,2);We(ee,{get createdBy(){return e(r).createdBy},get canEdit(){return e(I)},get permissionWrite(){return e(r).permissionWrite},set permissionWrite(o){e(r).permissionWrite=o}});var re=c(ee,2);{var be=o=>{{let h=m(()=>e(r).$id??"");Pe(o,{get auteur(){return e(r).auteur},get createdBy(){return e(r).createdBy},get id(){return e(h)},get createdAt(){return e(r).$createdAt},get updatedAt(){return e(r).$updatedAt}})}};k(re,o=>{e(r).$createdAt&&o(be)})}var te=c(re,2);{var _e=o=>{var h=Qe(),T=p(h);Ge(T,{get recipeId(){return e(a)}}),g(o,h)};k(te,o=>{e(a)&&o(_e)})}var ye=c(te,2);{var he=o=>{var h=er(),T=p(h);Ke(T,{class:"h-5 w-5 shrink-0"});var Z=c(T,4);Z.__click=[Ye,$];var we=p(Z);ie(()=>{Z.disabled=e(V),se(we,e(V)?"Suppression...":"Supprimer la recette")}),g(o,h)};k(ye,o=>{e(I)&&o(he)})}g(d,l)};k(n,d=>{e(r)&&d(f)},!0)}g(t,i)};k(pe,t=>{e(E)?t(ve):t(fe,!1)})}var N=c(J,2);{var me=t=>{var i=tr(),n=p(i),f=p(n);je(f,{class:"me-2 h-4 w-4"}),g(t,i)};k(N,t=>{e(P)&&t(me)})}var Q=c(N,2);{let t=m(()=>`/recipe/${e(a)}/edit`);Fe(Q,{get routeKey(){return e(t)},shouldProtect:()=>e(q)&&!e(P),onLeaveWithoutSave:async()=>{e(C)&&await z()},onSaveAndLeave:async()=>{await X()},message:"Vous avez des modifications non sauvegard√©es. Voulez-vous vraiment quitter ?"})}var ge=c(Q,2);Me(ge,{get isOpen(){return e($)},title:"Supprimer cette recette ?",message:"Cette action est irr√©versible, √™tes vous sur de vouloir supprimer cette recette ?",variant:"danger",confirmLabel:"Supprimer",cancelLabel:"Annuler",onConfirm:le,onCancel:()=>s($,!1)}),g(W,Y),Ee()}ne(["click"]);export{wr as default};
