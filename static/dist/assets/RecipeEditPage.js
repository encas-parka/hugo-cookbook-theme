import{u as Ae,t as ke,b as xe,T as Re}from"./icons.js";import{Z as ne,m as e,u as m,C as v,a0 as S,Y as Ie,a1 as w,ah as Ee,V as A,k as ae,a2 as E,b as g,c as Se,d as Le,q as b,aq as Be,y as c,a3 as U,v as s,h as u,g as p,W as ie,as as De,at as $e,aw as Ve,av as qe,X as se,j as Ce}from"./appwrite.js";import{r as Z}from"./RecipeDataStore.svelte.js";import{n as oe}from"./index.js";import{t as ze,a as K,v as Te,e as He,n as Ue,p as We,f as Me,R as Fe,b as Pe,d as je}from"./RecipeEditPage2.js";import"./AutocompleteInput.js";import{C as Ge}from"./ConfirmModal.js";import{U as Oe}from"./UnsavedChangesGuard.js";import{R as Ze,a as Ke}from"./RecipeVariants.js";import"./products-display.js";import"./tiptap-markdown.es.js";import"./Fieldset.js";import"./BtnGroupCheck.js";import"./CheckboxBadge.js";import"./keyboardNavigation.svelte.js";ne(["click"]);function Xe(W,k,M){e(k)&&S(`/recipe/${e(M)}/duplicate`)}function Ye(W,k){s(k,!0)}var Je=A('<div class="flex items-center gap-2"><button class="btn btn-secondary btn-soft"><!> Cr√©er une version alternative</button> <button class="btn btn-accent"><!> </button></div>'),Ne=A('<div class="flex items-center justify-center py-20"><div class="loading loading-spinner loading-lg"></div></div>'),Qe=A('<div class="mt-8 print:hidden"><!></div>'),er=A(`<div class="alert alert-error alert-soft border-error max-md:alert-vertical mt-8 border-1"><!> <div class="flex-1"><h4 class="font-bold">Zone de danger</h4> <p class="text-sm">La suppression d'une recette est irr√©versible. Si elle √©tait
              utilis√© dans des √©v√©nements, ceux-ci n'y auront plus acc√®s. Vous
              √™tes seul¬∑e autoris√© √† supprimer une recettes que vous avez cr√©e.
              Les versions alternatives cr√©es √† partir de celle-ci ne seront pas
              supprim√©e.</p></div> <button class="btn btn-error btn-sm"> </button></div>`),rr=A('<div class="space-y-6"><!> <!> <!> <!> <!> <!></div>'),tr=A(`<div class="bg-base-100 rounded-t-box fixed bottom-0 left-0"><div class=" bg-warning/40 rounded-t-box flex size-full items-center px-4 py-1"><!> V√©rouill√© : document en cours d'√©dition par un¬∑e autre utilisateur¬∑ice.</div></div>`),ar=A('<div class="max-w-9xl container mx-auto px-4 py-8"><!></div> <!> <!> <!>',1);function yr(W,k){Le(k,!0);const M=t=>{var i=Je(),n=p(i);n.__click=[Xe,r,a];var f=p(n);Ae(f,{class:"h-4 w-4"});var d=u(n,2);d.__click=X;var l=p(d);ke(l,{class:"h-4 w-4"});var I=u(l);ie(()=>{n.disabled=!e(R)||e(_),d.disabled=!e(R)||e(_)||!e(q),se(I,` ${e(_)?"Sauvegarde...":"Sauvegarder"}`)}),g(t,i)},a=m(()=>k.params?.uuid);if(!e(a))throw v.error("ID de recette manquant"),S("/recipe"),new Error("recipeId is required");let r=b(null),L=b(!1),x=b(!0),_=b(!1),y=b(null),D=null,B=b(null),$=b(!1),V=b(!1),F=Ie({value:{}});const q=m(()=>!e(r)||!e(B)?!1:K(e(r))!==e(B));w(()=>{e(r)&&e(r).check!==!0&&(e(r).draft=!0)});const P=m(()=>!!e(y)&&e(y)!==c.userId),C=m(()=>!!e(y)&&e(y)===c.userId),R=m(()=>!e(P)&&!e(x)),ce=m(()=>({materiel:Z.materiel,categories:Z.categories,regimes:Z.regimes}));w(()=>{Be()}),w(()=>{if(!c.userId){v.error("Vous devez √™tre connect√©"),S("/");return}}),w(()=>{e(a)&&!e(L)&&!e(x)||e(a)&&e(L)||e(a)&&!e(L)&&e(x)&&U.getRecipeByUuid(e(a)).then(async t=>{t?(s(r,ze(t,{$createdAt:t.$createdAt,$updatedAt:t.$updatedAt,createdBy:t.createdBy}),!0),s(y,t.lockedBy||null,!0),s(L,!0),s(x,!1),await de()):(v.error("Recette introuvable"),S("/recipe"))}).catch(t=>{console.error("Erreur chargement:",t),v.error("Erreur lors du chargement"),S("/recipe")}).finally(()=>{s(x,!1)})}),w(()=>{e(r)&&e(L)&&!e(B)&&s(B,K(e(r)),!0)}),w(()=>{oe.setConfig({title:e(r)?.title||"√âdition de recette",actions:M})}),Ee(async()=>{oe.reset(),G(),e(C)&&!e(_)&&await z(),window.removeEventListener("beforeunload",j)});function j(t){e(q)&&(t.preventDefault(),t.returnValue="")}w(()=>{e(q)?window.addEventListener("beforeunload",j):window.removeEventListener("beforeunload",j)});function ue(){G(),!(!e(a)||!e(C))&&(D=setInterval(async()=>{try{console.log("üíì Heartbeat: Refreshing lock..."),await U.updateRecipeLock(e(a),c.userId)}catch(t){console.error("‚ùå Heartbeat failed:",t)}},12e4))}function G(){D&&(clearInterval(D),D=null)}async function de(){if(!e(a)||!c.userId||!e(r))return!1;if((e(r).permissionWrite||[]).length<=1)return console.log("‚ÑπÔ∏è Verrou ignor√© (contributeur unique)"),!0;try{const i=e(r).lockedBy,n=e(r).$updatedAt?new Date(e(r).$updatedAt):null,f=n&&Date.now()-n.getTime()>3e5;if(i&&i!==c.userId)if(f)console.log("‚è≥ Verrou pr√©c√©dent expir√©, reprise de contr√¥le...");else return!1;return await U.updateRecipeLock(e(a),c.userId),s(y,c.userId,!0),console.log("üîí Verrou acquis"),ue(),!0}catch(i){return console.error("‚ùå Erreur acquisition verrou:",i),v.error("Impossible de verrouiller la recette"),!1}}async function z(){if(e(a)){G();try{await U.updateRecipeLock(e(a),null),s(y,null),console.log("üîì Verrou lib√©r√©")}catch(t){console.error("‚ùå Erreur lib√©ration verrou:",t)}}}async function X(){if(!e(r)||e(_)||!c.userId||!Te(e(r),F))return;s(_,!0);const i=v.loading("Sauvegarde en cours...");try{const{regimes:n}=He(e(r).ingredients),d={...Ue(e(r)),categories:e(r).categories,regime:n,saison:e(r).saison,ingredients:$e(e(r).ingredients),quantite_desc:e(r).quantite_desc,auteur:e(r).auteur,preparation24h:e(r).preparation24h,astuces:De(e(r).astuces),prepAlt:e(r).prepAlt,$id:e(r).$id},l=await Ve(e(a),d,c.userId);s(B,K(e(r)),!0);const I=We(e(r),d,{id:l.$id,createdAt:l.$createdAt,updatedAt:l.$updatedAt,createdBy:l.createdBy});qe("save_recipe",e(a),c.userId,I,!0).catch(T=>{console.error("Sync vers GitHub √©chou√©e:",T)}),v.update(i,{state:"success",message:"Recette sauvegard√©e !"}),await z()}catch(n){console.error("Erreur sauvegarde:",n),v.update(i,{state:"error",message:"Erreur lors de la sauvegarde"})}finally{s(_,!1),setTimeout(()=>v.dismiss(i),3e3)}}async function le(){if(e(a)){s(V,!0);try{await Me(e(a),async()=>{e(C)&&await z()}),setTimeout(()=>{S("/recipe")},1500)}catch(t){console.error("Erreur lors de la suppression:",t)}finally{s(V,!1),s($,!1)}}}var Y=ar(),J=ae(Y),pe=p(J);{var ve=t=>{var i=Ne();g(t,i)},fe=t=>{var i=Ce(),n=ae(i);{var f=d=>{var l=rr(),I=p(l);Fe(I,{get recipeInfo(){return e(ce)},get validationErrors(){return F.value},get canEdit(){return e(R)},get recipe(){return e(r)},set recipe(o){s(r,o,!0)}});var T=u(I,2);Pe(T,{get validationErrors(){return F.value},get canEdit(){return e(R)},get recipe(){return e(r)},set recipe(o){s(r,o,!0)}});var ee=u(T,2);je(ee,{get createdBy(){return e(r).createdBy},get canEdit(){return e(R)},get permissionWrite(){return e(r).permissionWrite},set permissionWrite(o){e(r).permissionWrite=o}});var re=u(ee,2);{var be=o=>{{let h=m(()=>e(r).$id??"");Ze(o,{get auteur(){return e(r).auteur},get createdBy(){return e(r).createdBy},get id(){return e(h)},get createdAt(){return e(r).$createdAt},get updatedAt(){return e(r).$updatedAt}})}};E(re,o=>{e(r).$createdAt&&o(be)})}var te=u(re,2);{var _e=o=>{var h=Qe(),H=p(h);Ke(H,{get recipeId(){return e(a)}}),g(o,h)};E(te,o=>{e(a)&&o(_e)})}var ye=u(te,2);{var he=o=>{var h=er(),H=p(h);Re(H,{class:"h-5 w-5 shrink-0"});var O=u(H,4);O.__click=[Ye,$];var we=p(O);ie(()=>{O.disabled=e(V),se(we,e(V)?"Suppression...":"Supprimer la recette")}),g(o,h)};E(ye,o=>{e(R)&&o(he)})}g(d,l)};E(n,d=>{e(r)&&d(f)},!0)}g(t,i)};E(pe,t=>{e(x)?t(ve):t(fe,!1)})}var N=u(J,2);{var me=t=>{var i=tr(),n=p(i),f=p(n);xe(f,{class:"me-2 h-4 w-4"}),g(t,i)};E(N,t=>{e(P)&&t(me)})}var Q=u(N,2);{let t=m(()=>`/recipe/${e(a)}/edit`);Oe(Q,{get routeKey(){return e(t)},shouldProtect:()=>e(q)&&!e(P),onLeaveWithoutSave:async()=>{e(C)&&await z()},onSaveAndLeave:async()=>{await X()},message:"Vous avez des modifications non sauvegard√©es. Voulez-vous vraiment quitter ?"})}var ge=u(Q,2);Ge(ge,{get isOpen(){return e($)},title:"Supprimer cette recette ?",message:"Cette action est irr√©versible, √™tes vous sur de vouloir supprimer cette recette ?",variant:"danger",confirmLabel:"Supprimer",cancelLabel:"Annuler",onConfirm:le,onCancel:()=>s($,!1)}),g(W,Y),Se()}ne(["click"]);export{yr as default};
