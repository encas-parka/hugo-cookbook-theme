import{y as ke,x as Ee,b as Se,T as Le}from"./icons.js";import{B as ne,m as e,u as b,M as m,E as k,z as Be,H as E,$ as $e,v as A,k as te,I as S,b as _,c as De,d as Ve,y,G as d,J as U,A as s,h as l,g as p,w as ae,ad as qe,ae as ze,ah as Ce,ag as He,x as ie,j as Te,K as se,o as v}from"./appwrite.js";import{r as K}from"./RecipeDataStore.svelte.js";import{n as oe}from"./index.js";import{t as Me,a as O,v as Ue,e as We,n as Fe,p as Pe,f as Ge,R as je,b as Ke,d as Oe}from"./RecipeEditPage2.js";import"./AutocompleteInput.js";import{C as Je}from"./ConfirmModal.js";import{U as Ze}from"./UnsavedChangesGuard.js";import{R as Ne,a as Qe}from"./RecipeVariants.js";import"./products-display.js";import"./tiptap-markdown.es.js";import"./Fieldset.js";import"./BtnGroupCheck.js";import"./CheckboxBadge.js";import"./keyboardNavigation.svelte.js";ne(["click"]);var Xe=A('<div class="flex items-center gap-2"><button class="btn btn-secondary btn-soft"><!> CrÃ©er une version alternative</button> <button class="btn btn-accent"><!> </button></div>'),Ye=A('<div class="flex items-center justify-center py-20"><div class="loading loading-spinner loading-lg"></div></div>'),er=A('<div class="mt-8 print:hidden"><!></div>'),rr=A(`<div class="alert alert-error alert-soft border-error max-md:alert-vertical mt-8 border-1"><!> <div class="flex-1"><h4 class="font-bold">Zone de danger</h4> <p class="text-sm">La suppression d'une recette est irrÃ©versible. Si elle Ã©tait
              utilisÃ© dans des Ã©vÃ©nements, ceux-ci n'y auront plus accÃ¨s. Vous
              Ãªtes seulÂ·e autorisÃ© Ã  supprimer une recettes que vous avez crÃ©e.
              Les versions alternatives crÃ©es Ã  partir de celle-ci ne seront pas
              supprimÃ©e.</p></div> <button class="btn btn-error btn-sm"> </button></div>`),tr=A('<div class="space-y-6"><!> <!> <!> <!> <!> <!></div>'),ar=A(`<div class="bg-base-100 rounded-t-box fixed bottom-0 left-0"><div class=" bg-warning/40 rounded-t-box flex size-full items-center px-4 py-1"><!> VÃ©rouillÃ© : document en cours d'Ã©dition par unÂ·e autre utilisateurÂ·ice.</div></div>`),ir=A('<div class="max-w-9xl container mx-auto px-4 py-8"><!></div> <!> <!> <!>',1);function hr(ce,J){Ve(J,!0);const ue=t=>{var a=Xe(),o=p(a);o.__click=ve;var g=p(o);ke(g,{class:"h-4 w-4"}),se(),v(o);var c=l(o,2);c.__click=Z;var u=p(c);Ee(u,{class:"h-4 w-4"});var R=l(u);v(c),v(a),ae(()=>{o.disabled=!e(I)||e(h),c.disabled=!e(I)||e(h)||!e(q),ie(R,` ${e(h)?"Sauvegarde...":"Sauvegarder"}`)}),_(t,a)},i=b(()=>J.params?.uuid);if(!e(i))throw m.error("ID de recette manquant"),k("/recipe"),new Error("recipeId is required");let r=y(null),L=y(!1),x=y(!0),h=y(!1),w=y(null),$=null,B=y(null),D=y(!1),V=y(!1),W=Be({value:{}});const q=b(()=>!e(r)||!e(B)?!1:O(e(r))!==e(B));E(()=>{e(r)&&e(r).check!==!0&&(e(r).draft=!0)});const F=b(()=>!!e(w)&&e(w)!==d.userId),z=b(()=>!!e(w)&&e(w)===d.userId),I=b(()=>!e(F)&&!e(x)),de=b(()=>({materiel:K.materiel,categories:K.categories,regimes:K.regimes}));E(()=>{if(!d.userId){m.error("Vous devez Ãªtre connectÃ©"),k("/");return}}),E(()=>{e(i)&&!e(L)&&!e(x)||e(i)&&e(L)||e(i)&&!e(L)&&e(x)&&U.getRecipeByUuid(e(i)).then(async t=>{t?(s(r,Me(t,{$createdAt:t.$createdAt,$updatedAt:t.$updatedAt,createdBy:t.createdBy}),!0),s(w,t.lockedBy||null,!0),s(L,!0),s(x,!1),await pe()):(m.error("Recette introuvable"),k("/recipe"))}).catch(t=>{console.error("Erreur chargement:",t),m.error("Erreur lors du chargement"),k("/recipe")}).finally(()=>{s(x,!1)})}),E(()=>{e(r)&&e(L)&&!e(B)&&s(B,O(e(r)),!0)}),E(()=>{oe.setConfig({title:e(r)?.title||"Ã‰dition de recette",actions:ue})}),$e(async()=>{oe.reset(),G(),e(z)&&!e(h)&&await C(),window.removeEventListener("beforeunload",P)});function P(t){e(q)&&(t.preventDefault(),t.returnValue="")}E(()=>{e(q)?window.addEventListener("beforeunload",P):window.removeEventListener("beforeunload",P)});function le(){G(),!(!e(i)||!e(z))&&($=setInterval(async()=>{try{console.log("ğŸ’“ Heartbeat: Refreshing lock..."),await U.updateRecipeLock(e(i),d.userId)}catch(t){console.error("âŒ Heartbeat failed:",t)}},12e4))}function G(){$&&(clearInterval($),$=null)}async function pe(){if(!e(i)||!d.userId||!e(r))return!1;if((e(r).permissionWrite||[]).length<=1)return console.log("â„¹ï¸ Verrou ignorÃ© (contributeur unique)"),!0;try{const a=e(r).lockedBy,o=e(r).$updatedAt?new Date(e(r).$updatedAt):null,g=o&&Date.now()-o.getTime()>3e5;if(a&&a!==d.userId)if(g)console.log("â³ Verrou prÃ©cÃ©dent expirÃ©, reprise de contrÃ´le...");else return!1;return await U.updateRecipeLock(e(i),d.userId),s(w,d.userId,!0),console.log("ğŸ”’ Verrou acquis"),le(),!0}catch(a){return console.error("âŒ Erreur acquisition verrou:",a),m.error("Impossible de verrouiller la recette"),!1}}async function C(){if(e(i)){G();try{await U.updateRecipeLock(e(i),null),s(w,null),console.log("ğŸ”“ Verrou libÃ©rÃ©")}catch(t){console.error("âŒ Erreur libÃ©ration verrou:",t)}}}async function Z(){if(!e(r)||e(h)||!d.userId||!Ue(e(r),W))return;s(h,!0);const a=m.loading("Sauvegarde en cours...");try{const{regimes:o}=We(e(r).ingredients),c={...Fe(e(r)),categories:e(r).categories,regime:o,saison:e(r).saison,ingredients:ze(e(r).ingredients),quantite_desc:e(r).quantite_desc,auteur:e(r).auteur,preparation24h:e(r).preparation24h,astuces:qe(e(r).astuces),prepAlt:e(r).prepAlt,$id:e(r).$id},u=await Ce(e(i),c,d.userId);s(B,O(e(r)),!0);const R=Pe(e(r),c,{id:u.$id,createdAt:u.$createdAt,updatedAt:u.$updatedAt,createdBy:u.createdBy});He("save_recipe",e(i),d.userId,R,!0).catch(H=>{console.error("Sync vers GitHub Ã©chouÃ©e:",H)}),m.update(a,{state:"success",message:"Recette sauvegardÃ©e !"}),await C()}catch(o){console.error("Erreur sauvegarde:",o),m.update(a,{state:"error",message:"Erreur lors de la sauvegarde"})}finally{s(h,!1),setTimeout(()=>m.dismiss(a),3e3)}}function ve(){e(r)&&k(`/recipe/${e(i)}/duplicate`)}function fe(){s(D,!0)}async function me(){if(e(i)){s(V,!0);try{await Ge(e(i),async()=>{e(z)&&await C()}),setTimeout(()=>{k("/recipe")},1500)}catch(t){console.error("Erreur lors de la suppression:",t)}finally{s(V,!1),s(D,!1)}}}var N=ir(),j=te(N),ge=p(j);{var be=t=>{var a=Ye();_(t,a)},_e=t=>{var a=Te(),o=te(a);{var g=c=>{var u=tr(),R=p(u);je(R,{get recipeInfo(){return e(de)},get validationErrors(){return W.value},get canEdit(){return e(I)},get recipe(){return e(r)},set recipe(n){s(r,n,!0)}});var H=l(R,2);Ke(H,{get validationErrors(){return W.value},get canEdit(){return e(I)},get recipe(){return e(r)},set recipe(n){s(r,n,!0)}});var Y=l(H,2);Oe(Y,{get createdBy(){return e(r).createdBy},get canEdit(){return e(I)},get permissionWrite(){return e(r).permissionWrite},set permissionWrite(n){e(r).permissionWrite=n}});var ee=l(Y,2);{var we=n=>{{let f=b(()=>e(r).$id??"");Ne(n,{get auteur(){return e(r).auteur},get createdBy(){return e(r).createdBy},get id(){return e(f)},get createdAt(){return e(r).$createdAt},get updatedAt(){return e(r).$updatedAt}})}};S(ee,n=>{e(r).$createdAt&&n(we)})}var re=l(ee,2);{var Ae=n=>{var f=er(),T=p(f);Qe(T,{get recipeId(){return e(i)}}),v(f),_(n,f)};S(re,n=>{e(i)&&n(Ae)})}var xe=l(re,2);{var Ie=n=>{var f=rr(),T=p(f);Le(T,{class:"h-5 w-5 shrink-0"});var M=l(T,4);M.__click=fe;var Re=p(M,!0);v(M),v(f),ae(()=>{M.disabled=e(V),ie(Re,e(V)?"Suppression...":"Supprimer la recette")}),_(n,f)};S(xe,n=>{e(I)&&n(Ie)})}v(u),_(c,u)};S(o,c=>{e(r)&&c(g)},!0)}_(t,a)};S(ge,t=>{e(x)?t(be):t(_e,!1)})}v(j);var Q=l(j,2);{var ye=t=>{var a=ar(),o=p(a),g=p(o);Se(g,{class:"me-2 h-4 w-4"}),se(),v(o),v(a),_(t,a)};S(Q,t=>{e(F)&&t(ye)})}var X=l(Q,2);{let t=b(()=>`/recipe/${e(i)}/edit`);Ze(X,{get routeKey(){return e(t)},shouldProtect:()=>e(q)&&!e(F),onLeaveWithoutSave:async()=>{e(z)&&await C()},onSaveAndLeave:async()=>{await Z()},message:"Vous avez des modifications non sauvegardÃ©es. Voulez-vous vraiment quitter ?"})}var he=l(X,2);Je(he,{get isOpen(){return e(D)},title:"Supprimer cette recette ?",message:"Cette action est irrÃ©versible, Ãªtes vous sur de vouloir supprimer cette recette ?",variant:"danger",confirmLabel:"Supprimer",cancelLabel:"Annuler",onConfirm:me,onCancel:()=>s(D,!1)}),_(ce,N),De()}ne(["click"]);export{hr as default};
