import{s as K,p as at,a9 as tt,W as i,E as J,A as e,$ as _,v as o,w as et,x as rt,a as h,B as r,Z as st,g as a,u as ua,X as f,Y as q,o as nt,C as ot,ac as lt,_ as la,D as Qa,z as it,a3 as $,a1 as da,a2 as vt}from"./vendor.B7h_mkEd.js";import{m as ia,g as ut,f as dt}from"./index.BUL8Pmq2.js";import{t as ca,y as xa}from"./appwrite.5W8SCupm.js";import{g as ha}from"./date-helpers.B6zph3v7.js";import{a0 as ct,aw as Ta,aQ as _t,aR as bt,l as pt,u as ft,g as yt,aS as gt,aT as mt,D as wa,X as qa,t as Ia,K as kt}from"./icons.DKN5kzXq.js";import"./editor.L4rklAfR.js";import"./markdown.BkFahWn2.js";function Qt(aa,y,B,x,C,O,E){if(!a(y)||!a(B)||a(x))return;const ta=new Date,P=new Date(a(C)?.endDate||"");ta<P?h(O,!0):E()}var xt=i('<p class="text-sm opacity-70"> </p>'),ht=i('<div class="badge badge-info">Mode lecture seule</div>'),wt=i('<div class="alert alert-info mb-4"><!> <div><div class="font-bold">Retour enregistré</div> <div class="text-sm"> </div></div></div>'),qt=i("<div><!></div>"),It=i('<div class="badge badge-warning gap-2"><!> </div>'),Dt=i('<div class="badge badge-error gap-2"><!> </div>'),Rt=i('<div class="badge badge-success gap-2"><!> </div>'),Mt=i('<div class="flex items-center gap-6 p-2"><!> <!> <!></div>'),Bt=i('<div class="ms-auto flex flex-wrap items-center justify-end gap-6 p-2"><button type="button" aria-label="À réparer"><!> à réparer</button> <button type="button" aria-label="Perdu"><!> perdu</button> <button type="button" aria-label="Tout OK"><!></button></div>'),Nt=i('<div class="badge badge-warning gap-2"><!> </div>'),Lt=i('<div class="badge badge-error gap-2"><!> </div>'),Tt=i('<div class="badge badge-success gap-2"><!> </div>'),At=i('<div class="ms-auto flex flex-wrap justify-end gap-4"><!> <!> <!></div>'),Ct=(aa,y)=>{const B=a(y).lostQuantity,x=a(y).brokenQuantity;a(y).state="issues",a(y).okQuantity=Math.min(a(y).quantity-B-x,a(y).okQuantity)},St=i('<div class="min-w-[100px]"><label class="input w-full"><span class="label-text">ok</span> <input type="number"/></label></div>'),Et=i('<button aria-label="Marquer comme ok">tout est ok</button>'),Pt=i('<div class="flex flex-wrap gap-4"><div class="min-w-[140px]"><label class="input"><span class="label-text">À réparer</span> <input type="number" class="  input-sm w-full" aria-label="Marquer comme à réparer"/></label></div> <div class="min-w-[140px]"><label class="input w-full"><span class="label-text">Perdus</span> <input type="number"/></label></div> <!></div>'),zt=i('<div class="bg-base-200 rounded-box flex flex-wrap items-center justify-between p-4"><div class="flex items-center gap-4"><!> <div class="text-lg font-semibold"> </div> <p class="font-semibold opacity-70"> </p></div> <!></div>'),Vt=i('<div class="alert"><p class="whitespace-pre-wrap"> </p></div>'),jt=i('<p class="text-sm italic opacity-50">Aucune note</p>'),Kt=i(`<textarea class="textarea textarea-bordered w-full" rows="2" placeholder="Remarques sur l'état du matériel, problèmes constatés..." maxlength="500"></textarea>`),Ot=i('<div class="text-error label"><span> </span></div>'),Ft=i('<span class="loading loading-spinner loading-sm"></span>'),Wt=i('<button class="btn btn-ghost">"Annuler"</button> <button class="btn btn-primary gap-2"><!> Valider le retour</button>',1),Xt=i('<div class="card bg-base-100 mb-6 shadow-sm"><div class="card-body"><!> <h2 class="card-title mb-4"><!> Matériels empruntés</h2> <div class="space-y-4"></div> <fieldset class="fieldset bg-base-100 mt-6"><legend class="fieldset-legend">Notes de retour (optionnel)</legend> <!></fieldset></div> <!></div> <div class="flex justify-end gap-2"><!></div>',1),Zt=i(`<div class="alert alert-warning"><span>Chargement de l'emprunt...</span></div>`),Ut=(aa,y)=>h(y,!1),Yt=i('<span class="loading loading-spinner loading-sm"></span>'),Gt=(aa,y)=>h(y,!1),Ht=i(`<div class="modal modal-open"><div class="modal-box"><p class="py-4"> <strong> </strong>.
        Vous êtes en train d'effectuer le retour avant cette date.</p> <p class="pb-4">Vous confirmez ce retour anticipé ?</p> <div class="modal-action"><button class="btn btn-ghost">Annuler</button> <button class="btn btn-warning"><!></button></div></div> <div class="modal-backdrop"></div></div>`),Jt=i('<div class="container mx-auto p-4"><div class="mx-auto max-w-4xl"><div class="mb-6 flex items-center gap-4"><button class="btn btn-circle btn-ghost" aria-label="Retour"><!></button> <div class="flex-1"><h1 class="text-2xl font-bold">Fiche de retour</h1> <!></div> <!></div> <!></div></div> <!>',1);function oe(aa,y){rt(y,!0);let B=K(null),x=K(!1),C=K(!1),O=K(!1),E=K(""),ta=K(null),P=K(at([])),_a=K("");const F=ua(()=>a(B)?ia.getLoanById(a(B)):null);function Aa(s){switch(s){case"electronic":return mt;case"manual":return gt;case"cooking":return yt;case"dish":return ft;case"gaz":return pt;case"hygiene":return bt;case"other":default:return _t}}tt(()=>{const s=y.params?.loanId;if(!s){ca.error("Emprunt non trouvé"),xa("/dashboard/loans");return}h(B,s,!0);const n=ia.getLoanById(s);if(!n||n.status!=="accepted"&&n.status!=="completed"){ca.error("Emprunt non valide"),xa("/dashboard/loans");return}n.status==="completed"?(h(C,!0),h(ta,n.returnedAt?new Date(n.returnedAt).toLocaleDateString("fr-FR"):null,!0),h(E,n.returnNotes||"",!0),h(P,n.materielItems.map(u=>{const g=u.lostQuantity||0,R=u.brokenQuantity||0,ea=u.quantity-g-R,Y=ia.getMaterielById(u.materielId);return{materielId:u.materielId,materielName:u.materielName,materielType:Y?.type||null,quantity:u.quantity,lostQuantity:g,brokenQuantity:R,okQuantity:ea,state:g>0||R>0?"issues":"ok"}}),!0)):h(P,n.materielItems.map(u=>{const g=ia.getMaterielById(u.materielId);return{materielId:u.materielId,materielName:u.materielName,materielType:g?.type||null,quantity:u.quantity,lostQuantity:0,brokenQuantity:0,okQuantity:u.quantity,state:"pending"}}),!0)});function U(s){const n=a(P)[s],u=n.lostQuantity,g=n.brokenQuantity;n.okQuantity=n.quantity-u-g,(n.lostQuantity>0||n.brokenQuantity>0)&&(n.state="issues")}const Da=ua(()=>{for(const s of a(P)){if(s.lostQuantity+s.brokenQuantity+s.okQuantity!==s.quantity)return h(_a,"erreur, veuillez vérifez le formulaire "),!1;if(s.state==="pending")return!1}return!0});function ba(){xa("/dashboard/loans")}async function Ra(){if(a(B)){h(O,!1),h(x,!0);try{const s=a(P).map(n=>({materielId:n.materielId,materielName:n.materielName,quantity:n.quantity,lostQuantity:n.lostQuantity,brokenQuantity:n.brokenQuantity}));await ia.completeLoanWithReturn(a(B),{materiels:s,returnNotes:a(E).trim()||void 0}),ca.success("Retour enregistré avec succès"),ba()}catch(s){console.error("[LoanReturnPage] Erreur enregistrement retour:",s),ca.error("Erreur lors de l'enregistrement du retour")}finally{h(x,!1)}}}var Ma=Jt(),Ba=J(Ma),Ca=e(Ba),Na=e(Ca),pa=e(Na);pa.__click=ba;var Sa=e(pa);ct(Sa,{class:"h-5 w-5"});var La=r(pa,2),Ea=r(e(La),2);{var Pa=s=>{var n=xt(),u=e(n);f((g,R)=>q(u,`Emprunt du ${g??""} au 
            ${R??""}`),[()=>ha(a(F).startDate),()=>ha(a(F).endDate)]),o(s,n)};_(Ea,s=>{a(F)&&s(Pa)})}var za=r(La,2);{var Va=s=>{var n=ht();o(s,n)};_(za,s=>{a(C)&&s(Va)})}var ja=r(Na,2);{var Ka=s=>{var n=Xt(),u=J(n),g=e(u),R=e(g);{var ea=b=>{var t=wt(),p=e(t);Ta(p,{class:"h-5 w-5"});var I=r(p,2),z=r(e(I),2),w=e(z);f(()=>q(w,`Le ${a(ta)??""}`)),o(b,t)};_(R,b=>{a(C)&&a(ta)&&b(ea)})}var Y=r(R,2),fa=e(Y);Ta(fa,{class:"h-5 w-5"});var G=r(Y,2);nt(G,21,()=>a(P),it,(b,t,p)=>{var I=zt(),z=e(I);{const V=(W,X=ot)=>{const oa=ua(()=>Aa(X()));var Z=qt(),m=e(Z);{let k=ua(()=>dt(X()));lt(m,()=>a(oa),(Q,T)=>{T(Q,{get class(){return`${a(k)??""} h-5 w-5`}})})}f(k=>la(Z,1,`${k??""} rounded-lg p-2`),[()=>ut(X())]),o(W,Z)};var w=e(z);V(w,()=>a(t).materielType);var S=r(w,2),L=e(S),na=r(S,2),Ua=e(na);f(()=>{q(L,a(t).materielName),q(Ua,`(${a(t).quantity??""})`)})}var Ya=r(z,2);{var Ga=V=>{var W=Qa(),X=J(W);{var oa=m=>{var k=Mt(),Q=e(k);{var T=l=>{var d=It(),c=e(d);wa(c,{class:"h-4 w-4"});var v=r(c);f(()=>q(v,` À réparer : ${a(t).brokenQuantity??""}`)),o(l,d)};_(Q,l=>{a(t).brokenQuantity>0&&l(T)})}var D=r(Q,2);{var M=l=>{var d=Dt(),c=e(d);qa(c,{class:"h-4 w-4"});var v=r(c);f(()=>q(v,` Perdu : ${a(t).lostQuantity??""}`)),o(l,d)};_(D,l=>{a(t).lostQuantity>0&&l(M)})}var j=r(D,2);{var A=l=>{var d=Rt(),c=e(d);Ia(c,{class:"h-4 w-4"});var v=r(c);f(()=>q(v,` OK : ${a(t).okQuantity??""}`)),o(l,d)};_(j,l=>{a(t).okQuantity>0&&l(A)})}o(m,k)},Z=m=>{var k=Bt(),Q=e(k);let T;Q.__click=()=>{a(t).state="issues",a(t).lostQuantity=0,a(t).brokenQuantity=1,U(p)};var D=e(Q);wa(D,{class:"h-4 w-4"});var M=r(Q,2);let j;M.__click=()=>{a(t).state="issues",a(t).lostQuantity=1,a(t).brokenQuantity=0,U(p)};var A=e(M);qa(A,{class:"h-4 w-4"});var l=r(M,2);l.__click=()=>{a(t).state="ok",a(t).lostQuantity=0,a(t).brokenQuantity=0,U(p)};var d=e(l);Ia(d,{class:""}),f((c,v)=>{T=la(Q,1,`btn btn-sm btn-warning ${a(t).brokenQuantity===0&&"btn-outline"}`,null,T,c),j=la(M,1,`btn btn-error btn-sm ${a(t).lostQuantity===0&&"btn-outline"}`,null,j,v),la(l,1,`btn btn-circle btn-sm btn-success ${a(t).state!=="ok"&&"btn-outline"}`)},[()=>({"ring-2":a(t).brokenQuantity>0,"ring-warning":a(t).brokenQuantity>0}),()=>({"ring-2":a(t).lostQuantity>0,"ring-error":a(t).lostQuantity>0})]),o(m,k)};_(X,m=>{a(C)?m(oa):m(Z,!1)})}o(V,W)},Ha=V=>{var W=Qa(),X=J(W);{var oa=m=>{var k=At(),Q=e(k);{var T=l=>{var d=Nt(),c=e(d);wa(c,{class:"h-4 w-4"});var v=r(c);f(()=>q(v,` À réparer : ${a(t).brokenQuantity??""}`)),o(l,d)};_(Q,l=>{a(t).brokenQuantity>0&&l(T)})}var D=r(Q,2);{var M=l=>{var d=Lt(),c=e(d);qa(c,{class:"h-4 w-4"});var v=r(c);f(()=>q(v,` Perdus : ${a(t).lostQuantity??""}`)),o(l,d)};_(D,l=>{a(t).lostQuantity>0&&l(M)})}var j=r(D,2);{var A=l=>{var d=Tt(),c=e(d);Ia(c,{class:"h-4 w-4"});var v=r(c);f(()=>q(v,` OK : ${a(t).okQuantity??""}`)),o(l,d)};_(j,l=>{a(t).okQuantity>0&&l(A)})}o(m,k)},Z=m=>{var k=Pt(),Q=e(k),T=e(Q),D=r(e(T),2);$(D,"min",0),D.__change=()=>U(p);var M=r(Q,2),j=e(M),A=r(e(j),2);$(A,"min",0),A.__change=()=>U(p);var l=r(M,2);{var d=v=>{var H=St(),Ja=e(H),va=r(e(Ja),2);$(va,"min",0),va.__change=[Ct,t],f(()=>$(va,"max",a(t).quantity)),da(va,()=>a(t).okQuantity,$a=>a(t).okQuantity=$a),o(v,H)},c=v=>{var H=Et();H.__click=()=>{a(t).state="ok",a(t).lostQuantity=0,a(t).brokenQuantity=0,U(p)},f(()=>la(H,1,`btn btn-success ${a(t).state!=="ok"&&"btn-outline"}`)),o(v,H)};_(l,v=>{a(t).lostQuantity>0||a(t).brokenQuantity>0?v(d):v(c,!1)})}f(()=>{$(D,"max",a(t).quantity),$(A,"max",a(t).quantity)}),da(D,()=>a(t).brokenQuantity,v=>a(t).brokenQuantity=v),da(A,()=>a(t).lostQuantity,v=>a(t).lostQuantity=v),o(m,k)};_(X,m=>{a(C)?m(oa):m(Z,!1)})}o(V,W)};_(Ya,V=>{a(t).quantity===1?V(Ga):V(Ha,!1)})}o(b,I)});var ra=r(G,2),ya=r(e(ra),2);{var ga=b=>{var t=Qa(),p=J(t);{var I=w=>{var S=Vt(),L=e(S),na=e(L);f(()=>q(na,a(E))),o(w,S)},z=w=>{var S=jt();o(w,S)};_(p,w=>{a(E)?w(I):w(z,!1)})}o(b,t)},ma=b=>{var t=Kt();f(()=>t.disabled=a(x)),da(t,()=>a(E),p=>h(E,p)),o(b,t)};_(ya,b=>{a(C)?b(ga):b(ma,!1)})}var ka=r(g,2);{var N=b=>{var t=Ot(),p=e(t),I=e(p);f(()=>q(I,a(_a))),o(b,t)};_(ka,b=>{a(_a)&&b(N)})}var sa=r(u,2),Xa=e(sa);{var Za=b=>{var t=Wt(),p=J(t);p.__click=ba;var I=r(p,2);I.__click=[Qt,B,Da,x,F,O,Ra];var z=e(I);{var w=L=>{var na=Ft();o(L,na)},S=L=>{kt(L,{class:"h-4 w-4"})};_(z,L=>{a(x)?L(w):L(S,!1)})}f(()=>{p.disabled=a(x),I.disabled=!a(Da)||a(x)}),o(b,t)};_(Xa,b=>{a(C)||b(Za)})}o(s,n)},Oa=s=>{var n=Zt();o(s,n)};_(ja,s=>{a(F)?s(Ka):s(Oa,!1)})}var Fa=r(Ba,2);{var Wa=s=>{var n=Ht(),u=e(n),g=e(u),R=e(g);R.nodeValue="Bizarre ! La date de fin de l'emprunt est prévue pour le  ";var ea=r(R),Y=e(ea),fa=r(g,4),G=e(fa);G.__click=[Ut,O];var ra=r(G,2);ra.__click=Ra;var ya=e(ra);{var ga=N=>{var sa=Yt();o(N,sa)},ma=N=>{var sa=vt("Confirmer le retour");o(N,sa)};_(ya,N=>{a(x)?N(ga):N(ma,!1)})}var ka=r(u,2);ka.__click=[Gt,O],f(N=>{q(Y,N),G.disabled=a(x),ra.disabled=a(x)},[()=>a(F)?ha(a(F).endDate):""]),o(s,n)};_(Fa,s=>{a(O)&&s(Wa)})}o(aa,Ma),et()}st(["click","change"]);export{oe as default};
