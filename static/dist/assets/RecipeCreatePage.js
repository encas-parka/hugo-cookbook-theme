import{t as Y}from"./icons.js";import{Y as Z,a1 as m,ah as J,V as w,k as z,a2 as C,b as y,c as O,d as Q,m as e,q as h,aq as ee,y as u,C as p,a0 as S,u as f,v as i,a3 as G,h as b,g as A,W as re,ar as te,as as ae,at as se,au as ie,av as oe,Z as ne,X as ce,j as ue}from"./appwrite.js";import{r as $}from"./RecipeDataStore.svelte.js";import{n as U}from"./index.js";import{t as de,c as le,a as F,v as pe,n as ve,p as me,R as fe,b as ge,d as ye}from"./RecipeEditPage2.js";import{U as he}from"./UnsavedChangesGuard.js";import"./products-display.js";import"./tiptap-markdown.es.js";import"./Fieldset.js";import"./BtnGroupCheck.js";import"./CheckboxBadge.js";var _e=w('<div class="flex items-center gap-2"><button class="btn btn-primary"><!> </button></div>'),Re=w('<div class="flex items-center justify-center py-20"><div class="loading loading-spinner loading-lg"></div></div>'),Se=w('<div class="space-y-6"><!> <!> <!></div>'),be=w('<div class="max-w-9xl container mx-auto px-4 py-8"><!></div> <!>',1);function We(L,E){Q(E,!0);const N=t=>{var a=_e(),o=A(a);o.__click=k;var c=A(o);Y(c,{class:"h-4 w-4"});var s=b(c);re(()=>{o.disabled=e(n)||!e(V),ce(s,` ${e(n)?"Sauvegarde...":"Créer la recette"}`)}),y(t,a)},d=f(()=>E.params?.uuid);let r=h(null),l=h(!1),n=h(!1),_=h(null),D=h(!1),x=Z({value:{}});const V=f(()=>!e(r)||!e(_)?!1:F(e(r))!==e(_));m(()=>{e(r)&&e(r).check!==!0&&(e(r).draft=!0)});const I=f(()=>!0),P=f(()=>({materiel:$.materiel,categories:$.categories,regimes:$.regimes}));m(()=>{ee()}),m(()=>{if(!u.userId){p.error("Vous devez être connecté"),S("/");return}}),m(()=>{if(!(e(l)||!u.userId)){if(e(d)&&!e(l)&&!e(n)){i(n,!0),G.getRecipeByUuid(e(d)).then(async t=>{if(t){const a=u.userName||"utilisateur",o=t.rootRecipeId||t.$id,v=`v${(await G.getVariantGroup(e(d))).variants.length+1} - ${a}`;i(r,de(t,{title:t.title,$id:"new-recipe",$createdAt:void 0,$updatedAt:void 0,lockedBy:null,createdBy:u.userId||"",permissionWrite:[u.userId||""],check:null,draft:!0,rootRecipeId:o,versionLabel:v}),!0),i(l,!0)}else p.error("Recette source introuvable"),S("/recipe")}).catch(t=>{console.error("Erreur chargement:",t),p.error("Erreur lors du chargement"),S("/recipe")}).finally(()=>{i(n,!1)});return}if(!e(d)&&!e(l)){i(r,{...le(),$id:"new-recipe"},!0),i(l,!0);return}}}),m(()=>{e(r)&&e(l)&&!e(_)&&i(_,F(e(r)),!0)});const q=f(()=>e(d)?"Nouvelle version de recette":"Nouvelle recette");m(()=>{U.setConfig({title:e(q),actions:N})}),J(()=>{U.reset()});async function k(){if(!e(r)||e(n)||!u.userId||!pe(e(r),x))return;i(n,!0);const a=p.loading("Sauvegarde en cours...");try{e(r).$id=te(e(r).title,e(r).versionLabel||void 0);const c={...ve(e(r)),ingredients:se(e(r).ingredients),astuces:ae(e(r).astuces),prepAlt:e(r).prepAlt},s=await ie(c,u.userId);p.update(a,{state:"success",message:"Recette créée avec succès !"});const v=me(e(r),c,{id:s.$id,createdAt:s.$createdAt,updatedAt:s.$updatedAt,createdBy:s.createdBy});oe("save_recipe",s.$id,u.userId,v,!0).catch(R=>{console.error("Sync vers GitHub échouée:",R)}),i(D,!0),setTimeout(()=>{S(`/recipe/${s.$id}`)},1500)}catch(o){console.error("Erreur sauvegarde:",o),p.update(a,{state:"error",message:"Erreur lors de la création"})}finally{i(n,!1),setTimeout(()=>p.dismiss(a),3e3)}}var B=be(),T=z(B),H=A(T);{var j=t=>{var a=Re();y(t,a)},M=t=>{var a=ue(),o=z(a);{var c=s=>{var v=Se(),R=A(v);fe(R,{get recipeInfo(){return e(P)},get validationErrors(){return x.value},canEdit:e(I),get recipe(){return e(r)},set recipe(g){i(r,g,!0)}});var W=b(R,2);ge(W,{get validationErrors(){return x.value},canEdit:e(I),get recipe(){return e(r)},set recipe(g){i(r,g,!0)}});var X=b(W,2);ye(X,{get createdBy(){return e(r).createdBy},canEdit:e(I),get permissionWrite(){return e(r).permissionWrite},set permissionWrite(g){e(r).permissionWrite=g}}),y(s,v)};C(o,s=>{e(r)&&s(c)},!0)}y(t,a)};C(H,t=>{e(l)?t(M,!1):t(j)})}var K=b(T,2);{let t=f(()=>e(d)?`/recipe/${e(d)}/duplicate`:"/recipe/new");he(K,{get routeKey(){return e(t)},shouldProtect:()=>e(V)&&!e(D),onLeaveWithoutSave:()=>{},onSaveAndLeave:async()=>{await k()},message:"Vous avez des modifications non sauvegardées. Voulez-vous vraiment quitter ?"})}y(L,B),O()}ne(["click"]);export{We as default};
