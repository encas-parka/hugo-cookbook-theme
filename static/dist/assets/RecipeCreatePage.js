import{x as Q}from"./icons.js";import{z as X,H as g,$ as Y,v as $,k as W,I as C,O as Z,b as y,c as ee,d as re,m as e,y as _,G as u,M as v,E as b,u as m,A as i,J as F,h as x,g as A,w as te,ac as ae,ad as se,ae as ie,af as oe,ag as ne,B as ce,x as ue,j as de,o as I}from"./appwrite.js";import{r as B}from"./RecipeDataStore.svelte.js";import{n as H,f as le}from"./index.js";import{t as pe,c as ve,a as L,v as me,n as fe,p as ge,R as ye,b as _e,d as he}from"./RecipeEditPage2.js";import{U as Re}from"./UnsavedChangesGuard.js";import"./products-display.js";import"./tiptap-markdown.es.js";import"./Fieldset.js";import"./BtnGroupCheck.js";import"./CheckboxBadge.js";var Se=$('<div class="flex items-center gap-2"><button class="btn btn-primary"><!> </button></div>'),be=$('<div class="flex items-center justify-center py-20"><div class="loading loading-spinner loading-lg"></div></div>'),xe=$('<div class="space-y-6"><!> <!> <!></div>'),Ae=$('<div class="max-w-9xl container mx-auto px-4 py-8"><!></div> <!>',1);function We(N,D){re(D,!0);const P=t=>{var a=Se(),o=A(a);o.__click=z;var c=A(o);Q(c,{class:"h-4 w-4"});var s=x(c);I(o),I(a),te(()=>{o.disabled=e(n)||!e(k),ue(s,` ${e(n)?"Sauvegarde...":"Créer la recette"}`)}),y(t,a)},d=m(()=>D.params?.uuid);let r=_(null),l=_(!1),n=_(!1),h=_(null),V=_(!1),w=X({value:{}});const k=m(()=>!e(r)||!e(h)?!1:L(e(r))!==e(h));g(()=>{e(r)&&e(r).check!==!0&&(e(r).draft=!0)});const E=m(()=>!0),U=m(()=>({materiel:B.materiel,categories:B.categories,regimes:B.regimes}));g(()=>{if(!u.userId){v.error("Vous devez être connecté"),b("/");return}}),g(()=>{if(!(e(l)||!u.userId)){if(e(d)&&!e(l)&&!e(n)){i(n,!0),F.getRecipeByUuid(e(d)).then(async t=>{if(t){const a=u.userName||"utilisateur",o=t.rootRecipeId||t.$id,p=`v${(await F.getVariantGroup(e(d))).variants.length+1} - ${a}`;i(r,pe(t,{title:t.title,$id:"new-recipe",$createdAt:void 0,$updatedAt:void 0,lockedBy:null,createdBy:u.userId||"",permissionWrite:[u.userId||""],check:null,draft:!0,rootRecipeId:o,versionLabel:p}),!0),i(l,!0)}else v.error("Recette source introuvable"),b("/recipe")}).catch(t=>{console.error("Erreur chargement:",t),v.error("Erreur lors du chargement"),b("/recipe")}).finally(()=>{i(n,!1)});return}if(!e(d)&&!e(l)){i(r,{...ve(),$id:"new-recipe"},!0),i(l,!0);return}}}),g(()=>{e(r)&&e(l)&&!e(h)&&i(h,L(e(r)),!0)});const M=m(()=>e(d)?"Nouvelle version de recette":"Nouvelle recette");g(()=>{H.setConfig({title:e(M),actions:P})}),Y(()=>{H.reset()});async function z(){if(!e(r)||e(n)||!u.userId||!me(e(r),w))return;i(n,!0);const a=v.loading("Sauvegarde en cours...");try{e(r).$id=ae(e(r).title,e(r).versionLabel||void 0);const c={...fe(e(r)),ingredients:ie(e(r).ingredients),astuces:se(e(r).astuces),prepAlt:e(r).prepAlt},s=await oe(c,u.userId);v.update(a,{state:"success",message:"Recette créée avec succès !"});const p=ge(e(r),c,{id:s.$id,createdAt:s.$createdAt,updatedAt:s.$updatedAt,createdBy:s.createdBy});ne("save_recipe",s.$id,u.userId,p,!0).catch(S=>{console.error("Sync vers GitHub échouée:",S)}),i(V,!0),setTimeout(()=>{b(`/recipe/${s.$id}`)},1500)}catch(o){console.error("Erreur sauvegarde:",o),v.update(a,{state:"error",message:"Erreur lors de la création"})}finally{i(n,!1),setTimeout(()=>v.dismiss(a),3e3)}}var T=Ae(),R=W(T),j=A(R);{var q=t=>{var a=be();y(t,a)},J=t=>{var a=de(),o=W(a);{var c=s=>{var p=xe(),S=A(p);ye(S,{get recipeInfo(){return e(U)},get validationErrors(){return w.value},canEdit:e(E),get recipe(){return e(r)},set recipe(f){i(r,f,!0)}});var G=x(S,2);_e(G,{get validationErrors(){return w.value},canEdit:e(E),get recipe(){return e(r)},set recipe(f){i(r,f,!0)}});var O=x(G,2);he(O,{get createdBy(){return e(r).createdBy},canEdit:e(E),get permissionWrite(){return e(r).permissionWrite},set permissionWrite(f){e(r).permissionWrite=f}}),I(p),y(s,p)};C(o,s=>{e(r)&&s(c)},!0)}y(t,a)};C(j,t=>{e(l)?t(J,!1):t(q)})}I(R);var K=x(R,2);{let t=m(()=>e(d)?`/recipe/${e(d)}/duplicate`:"/recipe/new");Re(K,{get routeKey(){return e(t)},shouldProtect:()=>e(k)&&!e(V),onLeaveWithoutSave:()=>{},onSaveAndLeave:async()=>{await z()},message:"Vous avez des modifications non sauvegardées. Voulez-vous vraiment quitter ?"})}Z(1,R,()=>le),y(N,T),ee()}ce(["click"]);export{We as default};
