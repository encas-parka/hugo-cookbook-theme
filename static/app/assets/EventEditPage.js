import{B as _t,d as bt,p as Ye,y as N,z as mt,J as st,A as s,m as e,v as d,k as ve,K as b,h as a,g as r,u as q,b as i,w as E,S as lt,T as at,x as J,j as Xe,e as Ke,i as dt,U as Pt,al as Rt,c as pt,ak as ht,O as se,o as t,G as Z,W as We,am as Nt,M as kt,C as tt,I as de,ab as Wt,_ as Je,ag as Kt,af as qt,ad as zt,ai as Tt,aG as Jt,aH as ot,aI as ut,Y as Qt,D as Yt,F as It,an as Xt}from"./appwrite.js";import{E as Zt,f as $t}from"./EventMealCard.js";import{M as At,b as Ot,c as jt,d as Lt,n as Dt}from"./index.js";import{F as ft}from"./Fieldset.js";import{aI as xt,a2 as ea,M as ta,c as gt,U as nt,G as yt,ax as wt,aJ as aa,af as sa,t as Et,aH as na,aK as Ct,as as St,a4 as Bt,aL as ra,i as ia,T as oa,_ as la,b as da}from"./icons.js";import{E as va}from"./EventInvitationAlert.js";import{c as ca}from"./event-stats-helpers.js";import{E as ua}from"./EventStats.js";import"./CheckboxBadge.js";import{B as fa}from"./BtnGroupCheck.js";import{U as ma}from"./UnsavedChangesGuard.js";import{C as Mt}from"./ConfirmModal.js";import"./keyboardNavigation.svelte.js";import"./products-display.js";import"./date-helpers.js";import"./index2.js";var ga=d('<label class="input w-56"><span class="label">Minimum</span> <input type="number" min="1" class="grow" id="min-contrib-input"/></label>'),_a=d('<button class="btn justify-start"><div class="flex items-center gap-4"><span class="label">minimum</span> <span class="text-lg"> </span> <!></div></button>'),ba=d('<div class="badge badge-primary badge-soft badge-lg gap-2 p-3"><!> <span class="font-medium"> </span></div>'),pa=d('<fieldset class="fieldset"><legend class="legend">√âquipes invit√©es</legend> <div class="flex flex-wrap gap-2"></div></fieldset>'),ha=d('<div class="badge badge-soft badge-success gap-2 p-3"><span class="font-medium"> </span></div>'),xa=d('<fieldset class="fieldset"><legend class="legend">Participant confirm√©</legend> <div class="flex flex-wrap gap-2"></div></fieldset>'),ya=d('<div class="badge badge-warning badge-soft gap-2 p-3"><span class="font-medium"> </span></div>'),wa=d('<fieldset class="fieldset"><legend class="text-base-content/70 text-sm font-medium">Invit√©¬∑es</legend> <div class="flex flex-wrap gap-2"></div></fieldset>'),ka=d('<div class="my-2"><button class="btn btn-primary btn-outline btn-block gap-1"><!> Inviter des participant¬∑es</button></div>'),Ea=d('<fieldset class="fieldset mb-4"><!> <div class="fieldset-label ms-1">Combien faudrait-il √™tre pour tout g√©rer ?</div></fieldset> <div class="mb-6"><div class="space-y-4"><!> <!> <!></div></div> <!>',1),Ta=d('<p class="text-error mt-1 text-xs"> </p>'),Ia=d("<p> </p>"),Da=d('<div class="badge badge-primary badge-soft badge-lg"><!> </div>'),Ca=d('<div class="mb-4"><p class="mb-2 text-sm font-medium opacity-70">√âquipes d√©j√† invit√©es :</p> <div class="flex flex-wrap gap-2"></div></div>'),Sa=d('<label class="hover:bg-secondary/20 bg-secondary/10 flex cursor-pointer items-center gap-3 rounded-lg px-4 py-2 transition-colors"><input type="checkbox" class="checkbox bg-base-100 checkbox-sm"/> <div class="flex flex-col"><span class="text-sm font-medium"> <span class="text-xs opacity-60"> </span></span> <div class="text-xs opacity-70"> </div></div></label>'),Ma=d(`<label class="mt-4 cursor-pointer justify-center gap-4"><input type="checkbox" class="checkbox checkbox-sm"/> <span class="font-base ms-1">Envoyer un email de notification</span></label> <p class="text-base-content/60 mt-1 text-xs">Si d√©sactiv√©, les membres auront acc√®s √† l'√©v√©nement mais ne
                recevront pas d'email. Les personnes invit√©es n'ayant pas de
                compte recevront toujours un email pour la cr√©ation de leur
                compte.</p>`,1),Pa=d('<div class="flex flex-wrap gap-4"></div> <!>',1),Na=d('<p class="text-sm italic opacity-60">Toutes vos √©quipes sont d√©j√† invit√©es.</p>'),qa=d(`<p class="text-sm italic opacity-60">Vous ne faites partie d'aucune √©quipe. Cr√©ez une √©quipe pour inviter
            plusieurs personnes.</p>`),za=d(`<div class="space-y-6"><fieldset class="fieldset"><legend class="legend">Par email</legend> <div class="flex gap-2"><label class="input flex items-center gap-2"><!> <input type="email" class="grow" placeholder="email@exemple.com"/></label> <button class="btn btn-primary"><!> Ajouter</button></div> <!> <div></div></fieldset> <div class="divider">OU</div> <fieldset class="fieldset"><legend class="fieldset-legend"><!> Inviter des √©quipes
          enti√®res</legend> <!> <!></fieldset></div>`),Aa=d('<button class="btn">Annuler</button> <button class="btn btn-primary"><!> Inviter <!></button>',1),Oa=d("<!> <!> <!>",1),ja=d("<!> <!>",1);function La(Ze,n){bt(n,!0);let Ue=Ye(n,"minContrib",15);Ye(n,"userId",3,"");let g=Ye(n,"eventId",3,""),y=Ye(n,"onStartEdit",3,()=>{}),V=N(mt([])),z=N(mt([])),w=N(!1),Y=N(!1),I=N(!1);st(()=>{if(g()){const v=n.eventsStore.getEventById(g());if(v&&v.teams){const f=v.teams||[],S=[];for(const H of f){const te=n.nativeTeamsStore.teams.find(A=>A.name===H);te&&S.push(te.$id)}s(V,S,!0)}}}),st(()=>{e(Y)||s(z,[],!0)});let G=N(""),T=N(null),ne=q(()=>n.contributors.filter(v=>v.status==="accepted")),$=q(()=>n.contributors.filter(v=>v.status==="invited"));function ge(v){e(V).includes(v)?s(V,e(V).filter(f=>f!==v),!0):s(V,[...e(V),v],!0)}function xe(){if(!e(G))return;const v=e(G).trim();if(n.contributors.some(S=>S.email===v)||e(z).some(S=>S.email===v)){s(T,"Cet email est d√©j√† invit√©.");return}s(T,null);const f={id:ht(),email:v,status:"invited",invitedAt:new Date().toISOString()};s(z,[...e(z),f],!0),s(G,"")}async function _e(){if(!g()){se.error("ID d'√©v√©nement manquant");return}const v=n.eventsStore.getEventById(g());if(!v)throw new Error("√âv√©nement introuvable");const f=e(V).filter(H=>{const te=n.nativeTeamsStore.teams.find(A=>A.$id===H);return te?!v.teams?.includes(te.name):!1}),S=e(z).map(H=>H.email).filter(Boolean);if(f.length===0&&S.length===0){se.warning("S√©lectionnez au moins une √©quipe ou entrez un email");return}try{await se.track(n.eventsStore.inviteParticipants(g(),{teamIds:f,emails:S,sendEmailToExistingMembers:e(w)}),{loading:"Envoi des invitations en cours...",success:"invitation envoy√© avec succ√®s",error:"Erreur lors de l'envoi des invitations"}),s(Y,!1),s(z,[],!0)}catch(H){console.error("Erreur lors de l'envoi des invitations:",H)}}function be(){s(Y,!1),s(G,""),s(T,null)}let ee=q(()=>()=>{if(!g())return[];const v=n.eventsStore.getEventById(g());return v?e(V).filter(f=>{const S=n.nativeTeamsStore.teams.find(H=>H.$id===f);return S?!v.teams?.includes(S.name):!1}):[]});var De=ja(),Ee=ve(De);ft(Ee,{legend:"Participants",children:(v,f)=>{var S=Ea(),H=ve(S),te=a(H);{var A=_=>{var m=ga(),p=r(a(m),2);p.defaultValue=1,t(m),E(()=>p.disabled=!n.canEdit),lt("focus",p,function(...j){y()?.apply(this,j)}),lt("blur",p,()=>s(I,!1)),at(p,Ue),i(_,m)},ae=_=>{var m=_a();m.__click=()=>{s(I,!0),setTimeout(()=>{document.getElementById("min-contrib-input")?.focus()},50)};var p=a(m),j=r(a(p),2),F=a(j,!0);t(j);var L=r(j,2);xt(L,{class:"h-4 w-4"}),t(p),t(m),E(()=>{m.disabled=!n.canEdit,J(F,Ue()||1)}),i(_,m)};b(te,_=>{e(I)?_(A):_(ae,!1)})}Z(2),t(H);var Ce=r(H,2),R=a(Ce),ce=a(R);{var ye=_=>{const m=q(()=>n.eventsStore.getEventById(g()));var p=Xe(),j=ve(p);{var F=L=>{var K=pa(),fe=r(a(K),2);Ke(fe,21,()=>e(m).teams,dt,(Se,Ie)=>{var D=ba(),l=a(D);nt(l,{class:"inline size-4"});var c=r(l,2),h=a(c,!0);t(c),t(D),E(()=>J(h,e(Ie))),i(Se,D)}),t(fe),t(K),i(L,K)};b(j,L=>{e(m)&&e(m).teams&&e(m).teams.length>0&&L(F)})}i(_,p)};b(ce,_=>{g()&&_(ye)})}var Te=r(ce,2);{var ue=_=>{var m=xa(),p=r(a(m),2);Ke(p,21,()=>e(ne),j=>j.id,(j,F)=>{var L=ha(),K=a(L),fe=a(K,!0);t(K),t(L),E(()=>J(fe,e(F).name||e(F).email)),i(j,L)}),t(p),t(m),i(_,m)};b(Te,_=>{e(ne).length>0&&_(ue)})}var oe=r(Te,2);{var O=_=>{var m=wa(),p=r(a(m),2);Ke(p,21,()=>e($),j=>j.id,(j,F)=>{var L=ya(),K=a(L),fe=a(K,!0);t(K),t(L),E(()=>J(fe,e(F).name||e(F).email)),i(j,L)}),t(p),t(m),i(_,m)};b(oe,_=>{e($).length>0&&_(O)})}t(R),t(Ce);var U=r(Ce,2);{var W=_=>{var m=ka(),p=a(m);p.__click=()=>s(Y,!0);var j=a(p);ea(j,{class:"mr-2 h-4 w-4"}),Z(),t(p),t(m),i(_,m)};b(U,_=>{g()&&_(W)})}i(v,S)},$$slots:{default:!0}});var Le=r(Ee,2);At(Le,{get isOpen(){return e(Y)},onClose:be,children:(v,f)=>{var S=Oa(),H=ve(S);Ot(H,{title:"Inviter des participants",onClose:be});var te=r(H,2);jt(te,{children:(ae,Ce)=>{var R=za(),ce=a(R),ye=r(a(ce),2),Te=a(ye),ue=a(Te);ta(ue,{class:"h-4 w-4 opacity-70"});var oe=r(ue,2);We(oe),oe.__keydown=D=>D.key==="Enter"&&xe(),t(Te);var O=r(Te,2);O.__click=xe;var U=a(O);gt(U,{class:"h-4 w-4 opacity-70"}),Z(),t(O),t(ye);var W=r(ye,2);{var _=D=>{var l=Ta(),c=a(l,!0);t(l),E(()=>J(c,e(T))),i(D,l)};b(W,D=>{e(T)&&D(_)})}var m=r(W,2);Ke(m,21,()=>e(z),dt,(D,l)=>{var c=Ia(),h=a(c,!0);t(c),E(()=>J(h,e(l).email)),i(D,c)}),t(m),t(ce);var p=r(ce,4),j=a(p),F=a(j);nt(F,{size:16,class:"inline shrink-0 opacity-60"}),Z(),t(j);var L=r(j,2);{var K=D=>{const l=q(()=>n.eventsStore.getEventById(g()));var c=Xe(),h=ve(c);{var B=M=>{var P=Ca(),re=r(a(P),2);Ke(re,21,()=>e(l).teams,dt,(qe,Be)=>{var Me=Da(),ze=a(Me);nt(ze,{class:"inline size-4"});var pe=r(ze,1,!0);t(Me),E(()=>J(pe,e(Be))),i(qe,Me)}),t(re),t(P),i(M,P)};b(h,M=>{e(l)&&e(l).teams&&e(l).teams.length>0&&M(B)})}i(D,c)};b(L,D=>{g()&&D(K)})}var fe=r(L,2);{var Se=D=>{const l=q(()=>n.nativeTeamsStore.myTeams.filter(P=>{if(!g())return!0;const re=n.eventsStore.getEventById(g());return!re||!re.teams?!0:!re.teams.includes(P.name)}));var c=Xe(),h=ve(c);{var B=P=>{var re=Pa(),qe=ve(re);Ke(qe,21,()=>e(l),dt,(ze,pe)=>{var Pe=Sa(),je=a(Pe);We(je),je.__change=()=>ge(e(pe).$id);var o=r(je,2),u=a(o),x=a(u),C=r(x),ie=a(C);t(C),t(u);var Ae=r(u,2),X=a(Ae,!0);t(Ae),t(o),t(Pe),E((Q,we)=>{Nt(je,Q),J(x,`${e(pe).name??""} `),J(ie,`${e(pe).total??""} membre${e(pe).total>1?"s":""}`),J(X,we)},[()=>e(V).includes(e(pe).$id),()=>n.nativeTeamsStore.getTeamMemberNames(e(pe).$id).join(", ")]),i(ze,Pe)}),t(qe);var Be=r(qe,2);{var Me=ze=>{var pe=Ma(),Pe=ve(pe),je=a(Pe);We(je),Z(2),t(Pe),Z(2),Rt(je,()=>e(w),o=>s(w,o)),i(ze,pe)};b(Be,ze=>{e(V).length>0&&ze(Me)})}i(P,re)},M=P=>{var re=Na();i(P,re)};b(h,P=>{e(l).length>0?P(B):P(M,!1)})}i(D,c)},Ie=D=>{var l=qa();i(D,l)};b(fe,D=>{n.nativeTeamsStore.myTeams.length>0?D(Se):D(Ie,!1)})}t(p),t(R),E(()=>O.disabled=!e(G)),at(oe,()=>e(G),D=>s(G,D)),i(ae,R)}});var A=r(te,2);Lt(A,{children:(ae,Ce)=>{var R=Aa(),ce=ve(R);ce.__click=be;var ye=r(ce,2);ye.__click=_e;var Te=a(ye);yt(Te,{class:"mr-2 h-4 w-4"});var ue=r(Te,2);{var oe=O=>{var U=Pt();E(W=>J(U,`(${W??""})`),[()=>e(ee)().length+e(z).length]),i(O,U)};b(ue,O=>{(e(ee)().length>0||e(z).length>0)&&O(oe)})}t(ye),E(O=>ye.disabled=O,[()=>e(z).length===0&&e(ee)().length===0]),i(ae,R)}}),i(v,S)},$$slots:{default:!0}}),i(Ze,De),pt()}_t(["click","keydown","change"]);var Ba=d('<div class="flex items-center gap-2"><!> <span> </span></div>'),Va=d('<div class="flex items-center gap-2"><!> <span>A r√©aliser avant le :</span> <span class="font-medium"> </span></div>'),Ua=d("<div><div><span> </span></div></div>"),Ga=d('<div><div class="bg-base-300 text-base-content w-7 rounded-full"><span class="text-base"> </span></div></div>'),Fa=d('<span class="text-warning mx-1 text-base italic">Non assign√©</span>'),Ha=d('<p class="text-base-content/60 mt-1 line-clamp-2 text-sm"> </p>'),Ra=d("<button><!> Fait <!></button>"),Wa=d(`<button class="btn btn-primary btn-outline btn-sm gap-1" title="Me porter volontaire pour cette t√¢che"><!> <span>M'inscrire</span></button>`),Ka=d('<button class="btn btn-error btn-sm btn-outline gap-1" title="Quitter cette t√¢che"><!> <span>me d√©sinscrire</span></button>'),Ja=d('<div><div class="flex flex-col gap-3"><div class="flex min-w-0 items-start gap-3"><div class="flex min-w-0 grow flex-col gap-4"><div class="flex flex-wrap items-start justify-between gap-x-4 gap-y-2"><div> </div> <div><!> <!> <!></div></div>  <div class="flex items-center gap-2"><!> <div class="flex min-w-0 items-center gap-1"><div class="flex flex-wrap gap-2"><!> <!> <!></div> <span> </span></div></div> <!></div></div></div> <div class="mt-4 flex items-center justify-between gap-2"><div class="flex gap-2"><!></div> <div class="ms-auto flex gap-2"><!> <button class="btn btn-sm btn-square" title="Modifier la t√¢che"><!></button></div></div></div>');function Qa(Ze,n){bt(n,!0);let Ue=Ye(n,"disabled",3,!1),g=Ye(n,"contributors",19,()=>[]),y=N(!1);const V=q(()=>Array.isArray(n.todo.assignedTo)?n.todo.assignedTo:[]),z=q(()=>de.userId&&e(V).includes(de.userId)),w=q(()=>n.todo.assignedTo?n.todo.assignedTo.map(l=>{const c=g().find(M=>M.id===l),h=l===de.userId,B=c?.name||(h?"Moi":l.substring(0,5));return{userId:l,name:B,isCurrentUser:h}}):[]),Y=q(()=>e(w).length>=(n.todo.requiredPeopleNb||1)),I=q(()=>{switch(n.todo.taskOn){case"beforeEvent":return{bg:"bg-accent/30",icon:sa,label:"Avant l'√©v√©nement"};case"afterEvent":return{bg:"bg-secondary/10",icon:aa,label:"Apr√®s l'√©v√©nement"};default:return{bg:"bg-secondary/20",icon:wt,label:"Pendant l'√©v√©nement"}}});async function G(){if(e(y)||Ue())return;const c=n.todo.status==="done"?"todo":"done";s(y,!0);try{await Je.updateTodo(n.eventId,n.todo.id,{status:c})}catch{se.error("Erreur m√†j statut")}finally{s(y,!1)}}async function T(){if(!de.userId||e(y))return;const l=e(z)?e(V).filter(c=>c!==de.userId):[...e(V),de.userId];s(y,!0);try{await Je.updateTodo(n.eventId,n.todo.id,{assignedTo:l.length>0?l:null}),se.success(e(z)?"Vous avez rejoint la t√¢che":"Vous avez quitt√© la t√¢che")}catch{se.error("Erreur assignation")}finally{s(y,!1)}}var ne=Ja();let $;var ge=a(ne),xe=a(ge),_e=a(xe),be=a(_e),ee=a(be),De=a(ee,!0);t(ee);var Ee=r(ee,2),Le=a(Ee);{var v=l=>{};b(Le,l=>{n.todo.priority&&n.todo.priority!=="low"&&l(v)})}var f=r(Le,2);{var S=l=>{var c=Ba(),h=a(c);Wt(h,()=>e(I).icon,(P,re)=>{re(P,{class:"size-4 shrink-0 opacity-70"})});var B=r(h,2),M=a(B,!0);t(B),t(c),E(()=>J(M,e(I).label)),i(l,c)};b(f,l=>{n.todo.taskOn&&l(S)})}var H=r(f,2);{var te=l=>{var c=Va(),h=a(c);Et(h,{class:"size-4 shrink-0 opacity-70"});var B=r(h,4),M=a(B,!0);t(B),t(c),E(P=>J(M,P),[()=>new Date(n.todo.dueDate).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})]),i(l,c)};b(H,l=>{n.todo.dueDate&&l(te)})}t(Ee),t(be);var A=r(be,2),ae=a(A);nt(ae,{class:"mt-1 mb-auto size-4 shrink-0 opacity-60"});var Ce=r(ae,2),R=a(Ce),ce=a(R);Ke(ce,19,()=>e(w).slice(0,3),l=>l.userId,(l,c)=>{var h=Ua(),B=a(h),M=a(B),P=a(M,!0);t(M),t(B),t(h),E(()=>{kt(h,"title",e(c).name+(e(c).isCurrentUser?" (vous)":"")),tt(B,1,`badge badge-soft badge-info ${(e(c).isCurrentUser&&"ring-info font-semibold ring-1")??""}`),J(P,e(c).name)}),i(l,h)});var ye=r(ce,2);{var Te=l=>{var c=Ga(),h=a(c),B=a(h),M=a(B);t(B),t(h),t(c),E(()=>{kt(c,"title",`+${e(w).length-3} autres`),J(M,`+${e(w).length-3}`)}),i(l,c)};b(ye,l=>{e(w).length>3&&l(Te)})}var ue=r(ye,2);{var oe=l=>{var c=Fa();i(l,c)};b(ue,l=>{e(w).length===0&&l(oe)})}t(R);var O=r(R,2),U=a(O);t(O),t(Ce),t(A);var W=r(A,2);{var _=l=>{var c=Ha(),h=a(c,!0);t(c),E(()=>J(h,n.todo.taskDescription)),i(l,c)};b(W,l=>{n.todo.taskDescription&&l(_)})}t(_e),t(xe),t(ge);var m=r(ge,2),p=a(m),j=a(p);{var F=l=>{var c=Ra();c.__click=G;var h=a(c);{let P=q(()=>n.todo.status!=="done"&&"opacity-60");yt(h,{get class(){return`size-4 ${e(P)??""}`}})}var B=r(h,2);{var M=P=>{var re=Pt("?");i(P,re)};b(B,P=>{n.todo.status!=="done"&&P(M)})}t(c),E(()=>{tt(c,1,`btn btn-sm ${n.todo.status!=="done"?"btn-dash":"btn-success"}`),kt(c,"title",n.todo.status==="done"?"Marquer √† faire":"Marquer fait"),c.disabled=Ue()}),i(l,c)};b(j,l=>{n.todo.taskOn==="beforeEvent"&&l(F)})}t(p);var L=r(p,2),K=a(L);{var fe=l=>{var c=Wa();c.__click=T;var h=a(c);yt(h,{class:"size-4"}),Z(2),t(c),i(l,c)},Se=l=>{var c=Xe(),h=ve(c);{var B=M=>{var P=Ka();P.__click=T;var re=a(P);na(re,{class:"size-4"}),Z(2),t(P),i(M,P)};b(h,M=>{e(z)&&M(B)},!0)}i(l,c)};b(K,l=>{e(z)?l(Se,!1):l(fe)})}var Ie=r(K,2);Ie.__click=()=>n.onEdit(n.todo);var D=a(Ie);xt(D,{class:"size-4"}),t(Ie),t(L),t(m),t(ne),E(()=>{$=tt(ne,1,`group bg-base-200/50 relative rounded-xl p-4 shadow transition-all ${e(Y)?"shadow-success/40 ":"shadow-warning/40 "}`,null,$,{"opacity-50":e(y)}),tt(ee,1,`text-base font-medium ${n.todo.status==="done"?"line-through opacity-50":""}`),J(De,n.todo.taskName),tt(Ee,1,`card card-sm ${e(I).bg??""} ms-auto flex flex-col justify-end px-4 py-1`),tt(O,1,`mx-1 ${e(w).length<(n.todo.requiredPeopleNb||1)?"text-warning":"text-success"} font-medium`),J(U,`${e(w).length??""}/${(n.todo.requiredPeopleNb||1)??""} pers. requise`)}),i(Ze,ne),pt()}_t(["click"]);var Ya=d('<div role="tablist" class="tabs tabs-border tabs-lg mb-4"><button role="tab"><!> T√¢che individuelle</button> <button role="tab"><!> T√¢ches pr√©d√©finies</button></div>'),Xa=d('<span class="badge badge-warning badge-sm"> </span>'),Za=d('<span class="badge badge-success badge-sm flex items-center gap-1"><!> ok</span>'),$a=d(`<div class="space-y-4"><fieldset class="fieldset"><legend class="fieldset-legend">Titre</legend> <label class="input w-full"><input type="text" placeholder="Ex: Acheter du pain, Pr√©parer la salle..." class="grow"/></label></fieldset> <fieldset class="fieldset"><legend class="fieldset-legend flex items-center gap-2"><!> Description</legend> <textarea class="textarea h-24 w-full" placeholder="D√©tails suppl√©mentaires..."></textarea></fieldset> <div class="flex flex-wrap gap-4"><fieldset class="fieldset w-80"><legend class="fieldset-legend flex items-center gap-2"><!> Moment</legend> <select class="select w-full"><option>Avant l'√©v√©nement</option><option>Pendant l'√©v√©nement</option><option>Apr√®s l'√©v√©nement</option></select></fieldset> <fieldset class="fieldset w-80"><legend class="fieldset-legend flex items-center gap-2"><!> √âch√©ance</legend> <label class="input w-full"><input type="date" class="grow"/></label></fieldset> <fieldset class="fieldset"><legend class="fieldset-legend flex items-center gap-2"><!> Personnes requises</legend> <label class="input w-full"><input type="number" min="1" class="grow"/></label></fieldset></div> <fieldset class="fieldset"><legend class="fieldset-legend flex items-center gap-2"><!> <!></legend> <!></fieldset></div>`),es=d('<div class="bg-base-100 flex items-center gap-4 rounded-lg p-3"><input type="checkbox" class="checkbox checkbox-primary"/> <input type="text" class="input flex-1"/> <div class="flex items-center gap-2"><!> <input type="number" class="input w-20" min="1"/></div></div>'),ts=d('<div class="collapse-arrow bg-base-200 collapse"><input type="checkbox" checked/> <div class="collapse-title flex items-center gap-2 text-base font-medium"><!> </div> <div class="collapse-content"><div class="mt-4 space-y-3"></div></div></div>'),as=d('<div class="space-y-6"></div>'),ss=d("<!> <!>",1),ns=d('<span class="loading loading-spinner loading-sm"></span>'),rs=d('<button type="button" class="btn btn-primary"><!> Cr√©er les t√¢ches s√©lectionn√©es</button>'),is=d('<button type="button" class="btn btn-ghost"><!> Sauvegarder & Cr√©er</button>'),os=d('<span class="loading loading-spinner loading-sm"></span>'),ls=d('<!> <button type="button" class="btn btn-primary"><!> </button>',1),ds=d("<!> <!> <!>",1);function vs(Ze,n){bt(n,!0);let Ue=Ye(n,"contributors",19,()=>[]);Ye(n,"currentTodos",19,()=>[]);let g=N(""),y=N(""),V=N("medium"),z=N("onEvent"),w=N(1),Y=N(""),I=N(mt([])),G=N(!1),T=N("individual");const ne={beforeEvent:["Gestion de l'approvisionnement / courses","Choix des recettes/menus","Coordination","Communication (mail, texto, affiches)","Gestion matos"],onEvent:["Pr√©parations des recettes","Service","Rangement","Vaisselle","Gestion des restes"],afterEvent:["Retour matos","D√©montage cuisine"]},$=q(()=>n.todoToEdit?{taskName:n.todoToEdit.taskName,taskDescription:n.todoToEdit.taskDescription||"",priority:n.todoToEdit.priority||"medium",taskOn:n.todoToEdit.taskOn||"onEvent",requiredPeopleNb:n.todoToEdit.requiredPeopleNb||1,dueDate:n.todoToEdit.dueDate?n.todoToEdit.dueDate.split("T")[0]:"",assignedTo:n.todoToEdit.assignedTo?[...n.todoToEdit.assignedTo]:[]}:{taskName:"",taskDescription:"",priority:"medium",taskOn:"onEvent",requiredPeopleNb:1,dueDate:"",assignedTo:[]});st(()=>{if(n.open){n.todoToEdit?s(T,"individual"):s(T,"individual");const v=e($);s(g,v.taskName,!0),s(y,v.taskDescription,!0),s(V,v.priority,!0),s(z,v.taskOn,!0),s(w,v.requiredPeopleNb,!0),s(Y,v.dueDate,!0),s(I,v.assignedTo,!0)}});function ge(){s(g,""),s(y,""),s(V,"medium"),s(z,"onEvent"),s(w,1),s(Y,""),s(I,[],!0)}async function xe(v=!1){if(!e(g).trim()){se.warning("Le titre de la t√¢che est requis");return}s(G,!0);try{const f=new Date().toISOString();if(n.todoToEdit){const S={taskName:e(g),taskDescription:e(y)||null,priority:e(V),taskOn:e(z),requiredPeopleNb:e(w),dueDate:e(Y)?new Date(e(Y)).toISOString():null,assignedTo:e(I).length>0?e(I):null};await Je.updateTodo(n.eventId,n.todoToEdit.id,S),se.success("T√¢che mise √† jour"),_e()}else{const S={id:ht(10),taskName:e(g),taskDescription:e(y)||null,priority:e(V),taskOn:e(z),requiredPeopleNb:e(w),dueDate:e(Y)?new Date(e(Y)).toISOString():null,assignedTo:e(I).length>0?e(I):null,status:"todo"};await Je.addTodo(n.eventId,S),se.success("T√¢che cr√©√©e"),v?ge():_e()}}catch(f){se.error("Erreur lors de la sauvegarde"),console.error(f)}finally{s(G,!1)}}function _e(){ge(),n.onClose()}function be(v){e(I).includes(v)?s(I,e(I).filter(f=>f!==v),!0):s(I,[...e(I),v],!0)}let ee=N(mt([]));st(()=>{n.open&&e(T)==="bulk"&&s(ee,[...ne.beforeEvent.map(v=>({taskName:v,taskOn:"beforeEvent",enabled:!0,requiredPeopleNb:1})),...ne.onEvent.map(v=>({taskName:v,taskOn:"onEvent",enabled:!0,requiredPeopleNb:1})),...ne.afterEvent.map(v=>({taskName:v,taskOn:"afterEvent",enabled:!1,requiredPeopleNb:1}))],!0)});async function De(){const v=e(ee).filter(f=>f.enabled);if(v.length===0){se.warning("S√©lectionnez au moins une t√¢che");return}s(G,!0);try{const f=new Date().toISOString(),S=v.map(H=>({id:ht(10),taskName:H.taskName,taskDescription:null,priority:"medium",taskOn:H.taskOn,requiredPeopleNb:H.requiredPeopleNb,dueDate:null,assignedTo:null,status:"todo"}));await Je.addTodos(n.eventId,S),se.success(`${S.length} t√¢che(s) cr√©√©e(s)`),_e()}catch(f){se.error("Erreur lors de la cr√©ation"),console.error(f)}finally{s(G,!1)}}function Ee(v){e(ee)[v].enabled=!e(ee)[v].enabled}const Le=q(()=>{const v=[{id:de.userId||"",label:"Moi",selected:e(I).includes(de.userId||"")}];return Ue().forEach(f=>{f.id!==de.userId&&v.push({id:f.id,label:f.name||f.email||f.id.substring(0,5),selected:e(I).includes(f.id)})}),v});At(Ze,{get isOpen(){return n.open},onClose:_e,maxWidth:"lg",maxHeight:"xl",children:(v,f)=>{var S=ds(),H=ve(S);{let ae=q(()=>n.todoToEdit?"Modifier la T√¢che":"Nouvelle T√¢che");Ot(H,{get title(){return e(ae)},onClose:_e})}var te=r(H,2);jt(te,{children:(ae,Ce)=>{var R=ss(),ce=ve(R);{var ye=O=>{var U=Ya(),W=a(U);W.__click=()=>s(T,"individual");var _=a(W);Ct(_,{class:"me-2 size-4"}),Z(),t(W);var m=r(W,2);m.__click=()=>s(T,"bulk");var p=a(m);St(p,{class:"me-2 size-4"}),Z(),t(m),t(U),E(()=>{tt(W,1,`tab ${e(T)==="individual"?"tab-active":""}`),tt(m,1,`tab ${e(T)==="bulk"?"tab-active":""}`)}),i(O,U)};b(ce,O=>{n.todoToEdit||O(ye)})}var Te=r(ce,2);{var ue=O=>{var U=$a(),W=a(U),_=r(a(W),2),m=a(_);We(m),t(_),t(W);var p=r(W,2),j=a(p),F=a(j);Ct(F,{class:"size-4 opacity-50"}),Z(),t(j);var L=r(j,2);qt(L),t(p);var K=r(p,2),fe=a(K),Se=a(fe),Ie=a(Se);wt(Ie,{class:"size-4 opacity-50"}),Z(),t(Se);var D=r(Se,2),l=a(D);l.value=l.__value="beforeEvent";var c=r(l);c.value=c.__value="onEvent";var h=r(c);h.value=h.__value="afterEvent",t(D),t(fe);var B=r(fe,2),M=a(B),P=a(M);Et(P,{class:"size-4 opacity-50"}),Z(),t(M);var re=r(M,2),qe=a(re);We(qe),t(re),t(B);var Be=r(B,2),Me=a(Be),ze=a(Me);nt(ze,{class:"size-4 opacity-50"}),Z(),t(Me);var pe=r(Me,2),Pe=a(pe);We(Pe),t(pe),t(Be),t(K);var je=r(K,2),o=a(je),u=a(o);nt(u,{class:"size-4 opacity-50"});var x=r(u),C=r(x);{var ie=Q=>{var we=Xa(),Ge=a(we);t(we),E(()=>J(Ge,`Manque ${e(w)-e(I).length} pers.`)),i(Q,we)},Ae=Q=>{var we=Za(),Ge=a(we);yt(Ge,{class:"size-3"}),Z(),t(we),i(Q,we)};b(C,Q=>{e(I).length<e(w)?Q(ie):Q(Ae,!1)})}t(o);var X=r(o,2);fa(X,{get items(){return e(Le)},size:"lg",color:"primary",onToggleItem:be}),t(je),t(U),E(()=>J(x,` Assignation (${e(I).length??""}/${e(w)??""}) `)),at(m,()=>e(g),Q=>s(g,Q)),at(L,()=>e(y),Q=>s(y,Q)),Kt(D,()=>e(z),Q=>s(z,Q)),at(qe,()=>e(Y),Q=>s(Y,Q)),at(Pe,()=>e(w),Q=>s(w,Q)),i(O,U)},oe=O=>{var U=as();Ke(U,20,()=>["beforeEvent","onEvent","afterEvent"],dt,(W,_)=>{const m=q(()=>_==="beforeEvent"?"Avant l'√©v√©nement":_==="onEvent"?"Pendant l'√©v√©nement":"Apr√®s l'√©v√©nement"),p=q(()=>e(ee).filter(K=>K.taskOn===_));var j=Xe(),F=ve(j);{var L=K=>{var fe=ts(),Se=a(fe);We(Se);var Ie=r(Se,2),D=a(Ie);wt(D,{class:"size-4 opacity-50"});var l=r(D);t(Ie);var c=r(Ie,2),h=a(c);Ke(h,21,()=>e(p),dt,(B,M,P)=>{const re=q(()=>e(ee).indexOf(e(M)));var qe=es(),Be=a(qe);We(Be),Be.__change=()=>Ee(e(re));var Me=r(Be,2);We(Me);var ze=r(Me,2),pe=a(ze);nt(pe,{class:"size-4 opacity-50"});var Pe=r(pe,2);We(Pe),t(ze),t(qe),E(()=>{Nt(Be,e(M).enabled),zt(Me,e(M).taskName),Me.disabled=!e(M).enabled,Pe.disabled=!e(M).enabled}),at(Pe,()=>e(M).requiredPeopleNb,je=>e(M).requiredPeopleNb=je),i(B,qe)}),t(h),t(c),t(fe),E(B=>J(l,` ${e(m)??""} (${B??""}/${e(p).length??""})`),[()=>e(p).filter(B=>B.enabled).length]),i(K,fe)};b(F,K=>{e(p).length>0&&K(L)})}i(W,j)}),t(U),i(O,U)};b(Te,O=>{n.todoToEdit||e(T)==="individual"?O(ue):O(oe,!1)})}i(ae,R)}});var A=r(te,2);Lt(A,{children:(ae,Ce)=>{var R=Xe(),ce=ve(R);{var ye=ue=>{var oe=rs();oe.__click=De;var O=a(oe);{var U=_=>{var m=ns();i(_,m)},W=_=>{St(_,{class:"size-4"})};b(O,_=>{e(G)?_(U):_(W,!1)})}Z(),t(oe),E(()=>oe.disabled=e(G)),i(ue,oe)},Te=ue=>{var oe=ls(),O=ve(oe);{var U=F=>{var L=is();L.__click=()=>xe(!0);var K=a(L);gt(K,{class:"size-4"}),Z(),t(L),E(()=>L.disabled=e(G)),i(F,L)};b(O,F=>{n.todoToEdit||F(U)})}var W=r(O,2);W.__click=()=>xe(!1);var _=a(W);{var m=F=>{var L=os();i(F,L)},p=F=>{Bt(F,{class:"size-4"})};b(_,F=>{e(G)?F(m):F(p,!1)})}var j=r(_);t(W),E(()=>{W.disabled=e(G),J(j,` ${n.todoToEdit?"Mettre √† jour":"Cr√©er la t√¢che"}`)}),i(ue,oe)};b(ce,ue=>{e(T)==="bulk"?ue(ye):ue(Te,!1)})}i(ae,R)}}),i(v,S)},$$slots:{default:!0}}),pt()}_t(["click","change"]);var cs=d('<div class="text-base-content/50 border-base-200 hover:border-primary/50 cursor-pointer rounded-lg border-2 border-dashed py-8 text-center text-sm italic transition-colors" role="button" tabindex="0">Aucune t√¢che pour le moment. <br/> <span class="text-primary mt-1 inline-block font-medium">Cr√©er la premi√®re t√¢che +</span></div>'),us=d('<div class="mb-4 flex items-center justify-between"><div class="flex items-center gap-2 text-sm opacity-60"><!> <span> </span></div> <button class="btn btn-sm btn-primary gap-2"><!> Nouvelle t√¢che</button></div> <div class=" space-y-4"><!></div> <!>',1);function fs(Ze,n){bt(n,!0);let Ue=Ye(n,"contributors",19,()=>[]),g=Ye(n,"disabled",3,!1);const y=q(()=>n.event.todos??[]);function V(ne){return{beforeEvent:1,onEvent:2,afterEvent:3}[ne]??0}const z=q(()=>[...e(y)].sort(($,ge)=>{const xe=V($.taskOn??""),_e=V(ge.taskOn??""),be=xe-_e;if(be!==0)return be;const ee=$.dueDate?new Date($.dueDate).getTime():1/0,De=ge.dueDate?new Date(ge.dueDate).getTime():1/0;return ee-De}));let w=N(!1),Y=N(null);function I(){s(Y,null),s(w,!0)}function G(ne){s(Y,ne,!0),s(w,!0)}function T(ne){n.onTodosChange?.(ne)}ft(Ze,{legend:"T√¢ches & Organisation",legendSize:"text-lg",children:(ne,$)=>{var ge=us(),xe=ve(ge),_e=a(xe),be=a(_e);ra(be,{class:"size-4"});var ee=r(be,2),De=a(ee);t(ee),t(_e);var Ee=r(_e,2);Ee.__click=I;var Le=a(Ee);gt(Le,{class:"size-4"}),Z(),t(Ee),t(xe);var v=r(xe,2),f=a(v);{var S=A=>{var ae=cs();ae.__click=I,ae.__keydown=Ce=>Ce.key==="Enter"&&I(),i(A,ae)},H=A=>{var ae=Xe(),Ce=ve(ae);Ke(Ce,17,()=>e(z),R=>R.id,(R,ce)=>{Qa(R,{get todo(){return e(ce)},get eventId(){return n.event.$id},onEdit:G,get disabled(){return g()},get contributors(){return Ue()}})}),i(A,ae)};b(f,A=>{e(z).length===0?A(S):A(H,!1)})}t(v);var te=r(v,2);vs(te,{get open(){return e(w)},get eventId(){return n.event.$id},get todoToEdit(){return e(Y)},get contributors(){return Ue()},get currentTodos(){return e(y)},onClose:()=>s(w,!1),onSave:T}),E(()=>J(De,`${e(y).length??""} t√¢ches`)),i(ne,ge)},$$slots:{default:!0}}),pt()}_t(["click","keydown"]);var ms=d('<span class="loading loading-spinner loading-xs text-primary"></span>'),gs=d('<div class="flex items-center gap-2"><button class="btn btn-accent btn-sm"><!> <span class="font-bold">Enregistrer</span></button></div>'),_s=d(`<input type="text" class="input input-lg min-w-full shadow-md" placeholder="Nom de l'√©v√©nement"/>`),bs=d('<button class="btn btn-ghost"><div class="flex items-baseline gap-4"><h1> </h1> <!></div></button>'),ps=d(`<textarea class="textarea w-full" placeholder="D√©crivez l'√©v√©nement..." maxlength="3000" rows="9"></textarea> <p class="label"> </p>`,1),hs=d('<p class="whitespace-pre-wrap"> </p>'),xs=d('<p class="text-base-content/40 italic">Ajoutez une description...</p>'),ys=d('<button class="btn btn-ghost bg-base-100 h-auto justify-start py-4 text-left font-normal"><div class="flex w-full items-start justify-between gap-4"><div class="flex-1"><!></div> <!></div></button>'),ws=d('<div class="badge badge-lg badge-success gap-1"><!> Confirm√©</div>'),ks=d('<div class="badge badge-lg badge-info gap-1"><!> Proposition</div>'),Es=d('<div class="badge badge-lg badge-warning gap-1"><!> </div>'),Ts=d(`<button class="btn btn-success btn-link btn-md">Confirmez l'√©v√©nement</button>`),Is=d(`<button class="btn btn-link btn-error btn-sm">Annuler l'√©v√©nement</button>`),Ds=d('<button class="btn btn-link btn-sm">R√©activer</button>'),Cs=d('<div class="flex flex-wrap items-center justify-between gap-2"><div class="flex items-center gap-2"><!></div> <!></div>'),Ss=d('<div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:col-span-2 lg:grid-cols-3"><div class="col-span-2"><!></div> <div class="flex flex-col justify-start gap-4"><!></div></div>'),Ms=d(`<div class="flex items-center justify-center py-20"><div class="flex flex-col items-center gap-4"><span class="loading loading-spinner loading-lg text-primary"></span> <p class="text-base-content/60">Chargement de l'√©v√©nement...</p></div></div>`),Ps=d(`<div class="alert alert-info"><!> <div><h4 class="font-bold">Mode D√©monstration</h4> <p class="text-sm">Dans un v√©ritable √©v√©nement, vous pourrez inviter des √©quipes
                  et des participants √† collaborer sur la planification.</p></div></div>`),Ns=d(`<div class="alert alert-warning max-md:alert-vertical"><!> <div><h3 class="font-bold">√âv√©nement en cours de modification</h3> <div class="text-xs">Un autre utilisateur est en train de modifier cet √©v√©nement. Les
                contr√¥les sont temporairement d√©sactiv√©s.</div></div></div>`),qs=d('<div class="text-base-content/60 bg-base-200 rounded-box border-base-200 flex flex-col items-center justify-center border-2 border-dashed py-12"><div class="bg-base-200 mb-4 rounded-full p-4"><!></div> <p class="font-medium">Aucun repas planifi√©</p> <p class="mt-1 text-sm">Commencez par ajouter un repas √† votre √©v√©nement</p></div>'),zs=d("<div><!></div>"),As=d('<div class="space-y-4"></div>'),Os=d('<div class="grid grid-cols-1 gap-6 pb-20 lg:grid-cols-3"><div class="space-y-6 lg:col-span-1"><!> <!></div> <div class="space-y-6 md:px-4 lg:col-span-2"><!> <div class="mb-6 flex items-center justify-between"><h3 class="card-title text-lg"> </h3> <button class="btn btn-primary"><!> Ajouter un repas</button></div> <!> <div class="flex"><button class="btn btn-outline btn-primary btn-block mt-4"><!> Ajouter un repas</button></div></div></div>'),js=d('<div class="bg-base-200 min-h-lvh space-y-6 px-2 pt-4 pb-20 md:px-20"><div class="flex flex-wrap items-center justify-between gap-x-6 gap-y-3"><div class="min-w-80 flex-1 gap-2"><!></div> <!></div> <!> <!> <!></div> <!> <!> <!>',1);function en(Ze,n){bt(n,!0);const Ue=o=>{var u=gs(),x=a(u);x.__click=O;var C=a(x);{var ie=X=>{var Q=ms();i(X,Q)},Ae=X=>{Bt(X,{size:18,class:"mr-1"})};b(C,X=>{e(T)?X(ie):X(Ae,!1)})}Z(2),t(x),t(u),E(()=>x.disabled=e(T)||!e(Le)||!e(A)),i(o,u)};let g=q(()=>Yt.params.id),y=N(mt([])),V=N(""),z=N(""),w=N("proposition"),Y=N(1);const I=q(()=>[...e(y)].sort((o,u)=>new Date(o.date).getTime()-new Date(u.date).getTime()));let G=N(!1),T=N(!1),ne=N(!1),$=N(!1),ge=N(null),xe=N(!1),_e=N(!1),be=N(!1),ee=N(!1),De=N(null),Ee=null;const Le=q(()=>{if(e(V)===""&&e(y).length===0||!e(G)||!e($)||!e(f))return!1;if(e(V)!==e(f).name||e(z)!==(e(f).description||"")||e(w)!==e(f).status||e(Y)!==(e(f).minContrib||1))return!0;const o=e(f).meals||[];if(e(y).length!==o.length)return!0;for(let u=0;u<e(y).length;u++){const x=o[u],C=e(y)[u];if(C.id!==x.id||C.date!==x.date||C.guests!==x.guests||(C.recipes?.length||0)!==(x.recipes?.length||0))return!0}return!1});async function v(){if(e($))return!0;if(e(te))return se.warning(`Cet √©v√©nement est verrouill√© par ${e(ae)}`),!1;if(e(f)&&ot(e(f).$id))return s($,!0),!0;const o=await Ce();return o&&s($,!0),o}const f=q(()=>Je.getEventById(e(g))),S=q(()=>ca(e(f))),H=q(()=>e(f)?.teamsId??[]),te=q(()=>e(De)?e(De).userId!==de.userId:!1),A=q(()=>e(f)&&ot(e(f).$id)||Je.canUserEditEvent(e(g),de.userId||"")&&!e(te)&&!e(T)),ae=q(()=>e(De)?.userName||"un autre utilisateur");st(()=>{if(!e(f)){console.log("[Sync] Guard 1 - Pas de currentEvent");return}if(!e(G)){console.log("[Sync] Guard 2 - Pas initialis√©");return}if(e($)&&e(V)!==""){console.log("[Sync] Guard 3 - Mode √©dition actif, pas de sync (shadow draft d√©j√† peupl√©)");return}Tt(()=>{const o=e(V),u=e(y).length;s(y,Jt(e(f).meals||[]),!0),s(V,e(f).name||"",!0),s(z,e(f).description||"",!0),s(w,e(f).status||"proposition",!0),s(Y,e(f).minContrib||1,!0)})}),st(()=>{Dt.setConfig({actions:Ue,isLockedByOthers:e(te),lockedByUserName:e(ae),hasUnsavedChanges:e(Le)&&!e(te)})}),st(()=>{if(e(G)||e(T)){console.log("[Init] Guard 1 - D√©j√† initialis√© ou occup√©",{isInitialised:e(G),isBusy:e(T)});return}if(!e(g)){console.log("[Init] Guard 2 - Pas d'eventId");return}console.log("[Init] D√©but initialisation pour eventId:",e(g)),Tt(async()=>{s(T,!0);try{const o=Je.getEventById(e(g));if(console.log("[Init] Event r√©cup√©r√©:",o?.$id,o?.name),o&&ot(o.$id)){console.log("[Init] Mode d√©mo: pr√™t, marquage isInitialised = true"),s(G,!0);return}s(De,await ut.getLock(e(g)),!0),Ee=ut.subscribeToLock(e(g),u=>{console.log("[EventEditPage] üîí Verrou mis √† jour:",{lockedBy:u?.userName,userId:u?.userId,expiresAt:u?.expiresAt}),s(De,u,!0)}),s(G,!0)}finally{s(T,!1),console.log("[Init] Fin initialisation, isBusy = false")}})}),Qt(()=>{U&&(clearTimeout(U),U=null),Ee&&(Ee(),Ee=null),e(g)&&e($)&&(console.log("üö™ D√©montage du composant, lib√©ration du lock..."),R()),Dt.reset()});async function Ce(){if(e(f)&&ot(e(f).$id))return console.log("[acquireLock] Mode d√©mo : pas de lock √† acqu√©rir"),!0;if(!e(g)||!de.userId||e(T)||e(ne))return!1;s(ne,!0);try{return await ut.acquireLock(e(g),de.userId,de.userName)?(W(),!0):(se.warning(`Cet √©v√©nement est en cours de modification par ${e(ae)}`),!1)}catch(o){return console.error("‚ùå Erreur acquisition verrou:",o),se.error("Impossible de verrouiller l'√©v√©nement"),!1}finally{s(ne,!1)}}async function R(){if(e(f)&&ot(e(f).$id)){console.log("[releaseLock] Mode d√©mo : d√©sactivation de isEditing"),s($,!1);return}if(!(!e(g)||!de.userId)){try{await ut.releaseLock(e(g),de.userId),console.log("üîì Verrou lib√©r√©")}catch(o){console.error("‚ùå Erreur lib√©ration verrou:",o)}s($,!1)}}async function ce(){e($)&&await R()}async function ye(){const o=await ue();return o&&await R(),o}function Te(){if(!e(V).trim())return{isValid:!1,errorMessage:"Veuillez renseigner le nom de l'√©v√©nement"};if(e(y).length===0)return{isValid:!1,errorMessage:"Veuillez ajouter au moins un repas"};const u=e(y).map(x=>x.date).filter((x,C,ie)=>ie.indexOf(x)!==C);return u.length>0?{isValid:!1,errorMessage:`Certaines dates sont en double: ${u.map(C=>{try{return new Date(C).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return C}}).join(", ")}`}:{isValid:!0}}async function ue(){const o=Te();if(!o.isValid)return se.error(o.errorMessage||"Erreur de validation"),!1;e(S);const u=Array.from(new Set(e(I).map(X=>X.date))).sort(),x=e(f)?.teams||[],C=e(f)?.teamsId||[],ie=new Map(C.map((X,Q)=>[X,x[Q]]));e(H).map(X=>It.getTeamById(X)?.name||ie.get(X)||X);const Ae={name:e(V),description:e(z),status:e(w),minContrib:e(Y),allDates:u,dateStart:u.length>0?u[0]:"",dateEnd:u.length>0?u[u.length-1]:"",meals:e(I)};try{return await Je.updateEvent(e(g),Ae),!0}catch(X){return console.error("Erreur sauvegarde:",X),se.error("Erreur lors de la sauvegarde"),!1}}async function oe(){if(!e(g)||e(T)||!e($))return;s(T,!0);const o=se.loading("Sauvegarde automatique...");if(await ue())await R(),se.update(o,{state:"success",message:"Modifications sauvegard√©es automatiquement"});else{if(e(g)&&de.userId)try{await ut.acquireLock(e(g),de.userId,de.userName)}catch(x){console.error("Erreur heartbeat lock:",x)}se.update(o,{state:"warning",message:"Impossible de sauvegarder : modifications invalides"})}s(T,!1),setTimeout(()=>se.dismiss(o),3e3)}async function O(){s(T,!0),await ue()&&(await R(),se.success("√âv√©nement mis √† jour")),s(T,!1)}let U=null;function W(){U&&clearTimeout(U),U=setTimeout(()=>{oe()},120*1e3),console.log("‚è∞ Auto-save programm√© dans 30 secondes")}st(()=>{const o=e($),u=e(Le),x=C=>{(o||u)&&(C.preventDefault(),C.returnValue="Vous avez des modifications non sauvegard√©es. Voulez-vous vraiment quitter ?")};return window.addEventListener("beforeunload",x),()=>{window.removeEventListener("beforeunload",x)}});async function _(o){await v()&&s(V,o.target.value,!0)}async function m(){if(!await v())return;const o=ht(6);let u;if(e(I).length===0){const C=new Date;C.setDate(C.getDate()+7),C.setHours(20,0,0,0),u=C.toISOString()}else{const C=e(I)[e(I).length-1],ie=new Date(C.date);ie.getHours()<14?ie.setHours(20,0,0,0):(ie.setDate(ie.getDate()+1),ie.setHours(12,0,0,0)),u=ie.toISOString()}const x={id:o,date:u,guests:100,recipes:[]};s(y,[...e(y),x],!0),s(ge,o,!0)}function p(o){s(y,e(y).filter(u=>u.id!==o),!0)}function j(o){s(ge,e(ge)===o?null:o,!0)}async function F(o){if(!(!e(g)||!de.userId))try{s(T,!0);const u=o?"accepted":"declined";await Je.updateContributorStatus(e(g),de.userId,u),se.success(o?"Invitation accept√©e":"Invitation d√©clin√©e")}catch(u){console.error("Erreur r√©ponse invitation:",u),se.error("Erreur lors de la r√©ponse")}finally{s(T,!1)}}async function L(){await v()&&(s(w,"confirmed"),s(be,!1))}async function K(){await v()&&(s(w,"canceled"),s(ee,!1))}var fe=js(),Se=ve(fe),Ie=a(Se),D=a(Ie),l=a(D);{var c=o=>{var u=_s();We(u),u.__input=_,E(()=>{zt(u,e(V)),u.disabled=!e(A)}),lt("focus",u,v),lt("blur",u,()=>s(xe,!1)),i(o,u)},h=o=>{var u=bs();u.__click=()=>s(xe,!e(xe));var x=a(u),C=a(x),ie=a(C,!0);t(C);var Ae=r(C,2);xt(Ae,{class:"h-4 w-4"}),t(x),t(u),E(()=>{u.disabled=!e(A),J(ie,e(V)||"Nom de l'√©v√©nement")}),i(o,u)};b(l,o=>{e(xe)?o(c):o(h,!1)})}t(D);var B=r(D,2);{var M=o=>{ua(o,{get currentEvent(){return e(f)}})};b(B,o=>{e(f)&&o(M)})}t(Ie);var P=r(Ie,2);{var re=o=>{var u=Ss(),x=a(u),C=a(x);ft(C,{legend:"Description",children:(X,Q)=>{var we=Xe(),Ge=ve(we);{var vt=Fe=>{var He=ps(),Ne=ve(He);qt(Ne);var Qe=r(Ne,2),he=a(Qe);t(Qe),E(()=>{Ne.disabled=!e(A),J(he,`${e(z).length??""}/3000 caract√®res`)}),lt("focus",Ne,v),lt("blur",Ne,()=>s(_e,!1)),at(Ne,()=>e(z),ke=>s(z,ke)),i(Fe,He)},rt=Fe=>{var He=ys();He.__click=()=>s(_e,!0);var Ne=a(He),Qe=a(Ne),he=a(Qe);{var ke=Oe=>{var me=hs(),k=a(me,!0);t(me),E(()=>J(k,e(z))),i(Oe,me)},$e=Oe=>{var me=xs();i(Oe,me)};b(he,Oe=>{e(z)?Oe(ke):Oe($e,!1)})}t(Qe);var et=r(Qe,2);xt(et,{class:"h-4 w-4 shrink-0"}),t(Ne),t(He),E(()=>He.disabled=!e(A)),i(Fe,He)};b(Ge,Fe=>{e(_e)?Fe(vt):Fe(rt,!1)})}i(X,we)},$$slots:{default:!0}}),t(x);var ie=r(x,2),Ae=a(ie);ft(Ae,{legend:"Statut de l'√©v√©nement",children:(X,Q)=>{var we=Cs(),Ge=a(we),vt=a(Ge);{var rt=he=>{var ke=ws(),$e=a(ke);ia($e,{class:"h-3 w-3"}),Z(),t(ke),i(he,ke)},Fe=he=>{var ke=Xe(),$e=ve(ke);{var et=me=>{var k=ks(),le=a(k);wt(le,{class:"h-3 w-3"}),Z(),t(k),i(me,k)},Oe=me=>{var k=Es(),le=a(k);oa(le,{class:"h-3 w-3"});var Ve=r(le);t(k),E(()=>J(Ve,` ${e(w)??""}`)),i(me,k)};b($e,me=>{e(w)==="proposition"?me(et):me(Oe,!1)},!0)}i(he,ke)};b(vt,he=>{e(w)==="confirmed"?he(rt):he(Fe,!1)})}t(Ge);var He=r(Ge,2);{var Ne=he=>{var ke=Ts();ke.__click=()=>s(be,!0),E(()=>ke.disabled=!e(A)),i(he,ke)},Qe=he=>{var ke=Xe(),$e=ve(ke);{var et=me=>{var k=Is();k.__click=()=>s(ee,!0),E(()=>k.disabled=!e(A)),i(me,k)},Oe=me=>{var k=Ds();k.__click=async()=>{await v()&&s(w,"proposition")},E(()=>k.disabled=!e(A)),i(me,k)};b($e,me=>{e(w)==="confirmed"?me(et):me(Oe,!1)},!0)}i(he,ke)};b(He,he=>{e(w)==="proposition"?he(Ne):he(Qe,!1)})}t(we),i(X,we)},$$slots:{default:!0}}),t(ie),t(u),i(o,u)};b(P,o=>{e(G)&&o(re)})}var qe=r(P,2);va(qe,{get currentEvent(){return e(f)},get isBusy(){return e(T)},onRespond:F});var Be=r(qe,2);{var Me=o=>{var u=Ms();i(o,u)},ze=o=>{var u=Os(),x=a(u),C=a(x);{var ie=k=>{ft(k,{legend:"Participants",get iconComponent(){return nt},children:(le,Ve)=>{var Re=Ps(),it=a(Re);la(it,{class:"h-5 w-5"}),Z(2),t(Re),i(le,Re)},$$slots:{default:!0}})},Ae=k=>{{let le=q(()=>de.userId||"");La(k,{get canEdit(){return e(A)},get contributors(){return e(S)},get nativeTeamsStore(){return It},get eventsStore(){return Je},get userId(){return e(le)},get eventId(){return e(g)},onStartEdit:v,get minContrib(){return e(Y)},set minContrib(Ve){s(Y,Ve,!0)}})}};b(C,k=>{e(f)&&ot(e(f).$id)?k(ie):k(Ae,!1)})}var X=r(C,2);{var Q=k=>{{let le=q(()=>!e(A)||e(te));fs(k,{get event(){return e(f)},get contributors(){return e(S)},get disabled(){return e(le)}})}};b(X,k=>{e(f)&&k(Q)})}t(x);var we=r(x,2),Ge=a(we);{var vt=k=>{var le=Ns(),Ve=a(le);da(Ve,{class:"h-6 w-6 shrink-0"}),Z(2),t(le),i(k,le)};b(Ge,k=>{e(te)&&k(vt)})}var rt=r(Ge,2),Fe=a(rt),He=a(Fe);t(Fe);var Ne=r(Fe,2);Ne.__click=m;var Qe=a(Ne);gt(Qe,{class:"mr-1 h-4 w-4"}),Z(),t(Ne),t(rt);var he=r(rt,2);{var ke=k=>{var le=qs(),Ve=a(le),Re=a(Ve);Et(Re,{class:"h-8 w-8 opacity-50"}),t(Ve),Z(4),t(le),i(k,le)},$e=k=>{var le=As();Ke(le,29,()=>e(I),Ve=>Ve.id+"-"+e(f)?.$updatedAt,(Ve,Re)=>{var it=zs(),Vt=a(it);{let Ut=q(()=>e(ge)===e(Re).id),Gt=q(()=>e(y).map(ct=>ct.date)),Ft=q(()=>!e(A)||e(te));Zt(Vt,{get isEditing(){return e(Ut)},onEditToggle:async()=>{await v()&&j(e(Re).id||"")},onDelete:()=>p(e(Re).id||""),get allDates(){return e(Gt)},get disabled(){return e(Ft)},get meal(){return e(y)[e(y).findIndex(ct=>ct.id===e(Re).id)]},set meal(ct){e(y)[e(y).findIndex(Ht=>Ht.id===e(Re).id)]=ct}})}t(it),Xt(it,()=>$t,()=>({delay:100,duration:400})),i(Ve,it)}),t(le),i(k,le)};b(he,k=>{e(I).length===0?k(ke):k($e,!1)})}var et=r(he,2),Oe=a(et);Oe.__click=m;var me=a(Oe);gt(me,{class:"mr-1 h-4 w-4"}),Z(),t(Oe),t(et),t(we),t(u),E(()=>{J(He,`Repas & Menus (${e(I).length??""})`),Ne.disabled=!e(A),Oe.disabled=!e(A)}),i(o,u)};b(Be,o=>{e(T)&&!e(G)?o(Me):o(ze,!1)})}t(Se);var pe=r(Se,2);Mt(pe,{get isOpen(){return e(be)},title:"Confirmer l'√©v√©nement",message:"√ätes-vous s√ªr de vouloir confirmer cet √©v√©nement ? ",variant:"info",confirmLabel:"Confirmer",cancelLabel:"Annuler",onConfirm:L,onCancel:()=>s(be,!1)});var Pe=r(pe,2);Mt(Pe,{get isOpen(){return e(ee)},title:"Annuler la confirmation",message:"√ätes-vous s√ªr de vouloir annuler cet √©v√©nement ?.",variant:"warning",confirmLabel:"Oui, annuler",cancelLabel:"Non, garder",onConfirm:K,onCancel:()=>s(ee,!1)});var je=r(Pe,2);{let o=q(()=>`/event/${e(g)}`);ma(je,{get routeKey(){return e(o)},shouldProtect:()=>e(Le),onLeaveWithoutSave:ce,onSaveAndLeave:ye,message:"Vous avez des modifications non sauvegard√©es. Voulez-vous vraiment quitter ?"})}i(Ze,fe),pt()}_t(["click","input"]);export{en as default};
