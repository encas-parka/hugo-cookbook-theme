import{B as _t,d as bt,p as Ye,y as N,z as mt,J as tt,A as n,m as e,v as u,k as de,K as b,h as a,g as r,u as q,b as i,w as k,S as lt,T as et,x as J,j as Ze,e as Ke,i as dt,U as Pt,al as Rt,c as pt,ak as ht,O as te,o as t,G as re,W as We,am as Nt,M as wt,C as $e,I as le,ab as Wt,$ as Je,ah as Kt,ag as qt,ad as zt,aj as Tt,aG as Jt,aH as ot,aI as ut,Y as Qt,D as Yt,F as It,an as Xt}from"./appwrite.js";import{E as Zt,f as $t}from"./EventMealCard.js";import{M as At,b as Ot,c as jt,d as Lt,n as Dt}from"./index.js";import{F as ft}from"./Fieldset.js";import{aI as xt,a2 as ea,M as ta,c as gt,U as at,G as yt,ax as kt,aJ as aa,af as na,t as Et,aH as sa,aK as St,as as Ct,a4 as Bt,aL as ra,a0 as ia,b as oa}from"./icons.js";import{E as la}from"./EventInvitationAlert.js";import{c as da}from"./event-stats-helpers.js";import{E as va}from"./EventStats.js";import"./CheckboxBadge.js";import{B as ca}from"./BtnGroupCheck.js";import{U as ua}from"./UnsavedChangesGuard.js";import{C as Mt}from"./ConfirmModal.js";import{B as fa}from"./BadgeEventStatus.js";import"./keyboardNavigation.svelte.js";import"./products-display.js";import"./date-helpers.js";import"./index2.js";var ma=u('<label class="input w-56"><span class="label">Minimum</span> <input type="number" min="1" class="grow" id="min-contrib-input"/></label>'),ga=u('<button class="btn justify-start"><div class="flex items-center gap-4"><span class="label">minimum</span> <span class="text-lg"> </span> <!></div></button>'),_a=u('<div class="badge badge-primary badge-soft badge-lg gap-2 p-3"><!> <span class="font-medium"> </span></div>'),ba=u('<fieldset class="fieldset"><legend class="legend">√âquipes invit√©es</legend> <div class="flex flex-wrap gap-2"></div></fieldset>'),pa=u('<div class="badge badge-soft badge-success gap-2 p-3"><span class="font-medium"> </span></div>'),ha=u('<fieldset class="fieldset"><legend class="legend">Participant confirm√©</legend> <div class="flex flex-wrap gap-2"></div></fieldset>'),xa=u('<div class="badge badge-warning badge-soft gap-2 p-3"><span class="font-medium"> </span></div>'),ya=u('<fieldset class="fieldset"><legend class="text-base-content/70 text-sm font-medium">Invit√©¬∑es</legend> <div class="flex flex-wrap gap-2"></div></fieldset>'),wa=u('<div class="my-2"><button class="btn btn-primary btn-outline btn-block gap-1"><!> Inviter des participant¬∑es</button></div>'),ka=u('<fieldset class="fieldset mb-4"><!> <div class="fieldset-label ms-1">Combien faudrait-il √™tre pour tout g√©rer ?</div></fieldset> <div class="mb-6"><div class="space-y-4"><!> <!> <!></div></div> <!>',1),Ea=u('<p class="text-error mt-1 text-xs"> </p>'),Ta=u("<p> </p>"),Ia=u('<div class="badge badge-primary badge-soft badge-lg"><!> </div>'),Da=u('<div class="mb-4"><p class="mb-2 text-sm font-medium opacity-70">√âquipes d√©j√† invit√©es :</p> <div class="flex flex-wrap gap-2"></div></div>'),Sa=u('<label class="hover:bg-secondary/20 bg-secondary/10 flex cursor-pointer items-center gap-3 rounded-lg px-4 py-2 transition-colors"><input type="checkbox" class="checkbox bg-base-100 checkbox-sm"/> <div class="flex flex-col"><span class="text-sm font-medium"> <span class="text-xs opacity-60"> </span></span> <div class="text-xs opacity-70"> </div></div></label>'),Ca=u(`<label class="mt-4 cursor-pointer justify-center gap-4"><input type="checkbox" class="checkbox checkbox-sm"/> <span class="font-base ms-1">Envoyer un email de notification</span></label> <p class="text-base-content/60 mt-1 text-xs">Si d√©sactiv√©, les membres auront acc√®s √† l'√©v√©nement mais ne
                recevront pas d'email. Les personnes invit√©es n'ayant pas de
                compte recevront toujours un email pour la cr√©ation de leur
                compte.</p>`,1),Ma=u('<div class="flex flex-wrap gap-4"></div> <!>',1),Pa=u('<p class="text-sm italic opacity-60">Toutes vos √©quipes sont d√©j√† invit√©es.</p>'),Na=u(`<p class="text-sm italic opacity-60">Vous ne faites partie d'aucune √©quipe. Cr√©ez une √©quipe pour inviter
            plusieurs personnes.</p>`),qa=u(`<div class="space-y-6"><fieldset class="fieldset"><legend class="legend">Par email</legend> <div class="flex gap-2"><label class="input flex items-center gap-2"><!> <input type="email" class="grow" placeholder="email@exemple.com"/></label> <button class="btn btn-primary"><!> Ajouter</button></div> <!> <div></div></fieldset> <div class="divider">OU</div> <fieldset class="fieldset"><legend class="fieldset-legend"><!> Inviter des √©quipes
          enti√®res</legend> <!> <!></fieldset></div>`),za=u('<button class="btn">Annuler</button> <button class="btn btn-primary"><!> Inviter <!></button>',1),Aa=u("<!> <!> <!>",1),Oa=u("<!> <!>",1);function ja(Xe,s){bt(s,!0);let Le=Ye(s,"minContrib",15);Ye(s,"userId",3,"");let g=Ye(s,"eventId",3,""),y=Ye(s,"onStartEdit",3,()=>{}),B=N(mt([])),z=N(mt([])),E=N(!1),Q=N(!1),T=N(!1);tt(()=>{if(g()){const d=s.eventsStore.getEventById(g());if(d&&d.teams){const f=d.teams||[],S=[];for(const F of f){const $=s.nativeTeamsStore.teams.find(M=>M.name===F);$&&S.push($.$id)}n(B,S,!0)}}}),tt(()=>{e(Q)||n(z,[],!0)});let U=N(""),w=N(null),ae=q(()=>s.contributors.filter(d=>d.status==="accepted")),Z=q(()=>s.contributors.filter(d=>d.status==="invited"));function fe(d){e(B).includes(d)?n(B,e(B).filter(f=>f!==d),!0):n(B,[...e(B),d],!0)}function pe(){if(!e(U))return;const d=e(U).trim();if(s.contributors.some(S=>S.email===d)||e(z).some(S=>S.email===d)){n(w,"Cet email est d√©j√† invit√©.");return}n(w,null);const f={id:ht(),email:d,status:"invited",invitedAt:new Date().toISOString()};n(z,[...e(z),f],!0),n(U,"")}async function me(){if(!g()){te.error("ID d'√©v√©nement manquant");return}const d=s.eventsStore.getEventById(g());if(!d)throw new Error("√âv√©nement introuvable");const f=e(B).filter(F=>{const $=s.nativeTeamsStore.teams.find(M=>M.$id===F);return $?!d.teams?.includes($.name):!1}),S=e(z).map(F=>F.email).filter(Boolean);if(f.length===0&&S.length===0){te.warning("S√©lectionnez au moins une √©quipe ou entrez un email");return}try{await te.track(s.eventsStore.inviteParticipants(g(),{teamIds:f,emails:S,sendEmailToExistingMembers:e(E)}),{loading:"Envoi des invitations en cours...",success:"invitation envoy√© avec succ√®s",error:"Erreur lors de l'envoi des invitations"}),n(Q,!1),n(z,[],!0)}catch(F){console.error("Erreur lors de l'envoi des invitations:",F)}}function ge(){n(Q,!1),n(U,""),n(w,null)}let Y=q(()=>()=>{if(!g())return[];const d=s.eventsStore.getEventById(g());return d?e(B).filter(f=>{const S=s.nativeTeamsStore.teams.find(F=>F.$id===f);return S?!d.teams?.includes(S.name):!1}):[]});var Ie=Oa(),ye=de(Ie);ft(ye,{legend:"Participants",children:(d,f)=>{var S=ka(),F=de(S),$=a(F);{var M=_=>{var m=ma(),p=r(a(m),2);p.defaultValue=1,t(m),k(()=>p.disabled=!s.canEdit),lt("focus",p,function(...O){y()?.apply(this,O)}),lt("blur",p,()=>n(T,!1)),et(p,Le),i(_,m)},ee=_=>{var m=ga();m.__click=()=>{n(T,!0),setTimeout(()=>{document.getElementById("min-contrib-input")?.focus()},50)};var p=a(m),O=r(a(p),2),G=a(O,!0);t(O);var j=r(O,2);xt(j,{class:"h-4 w-4"}),t(p),t(m),k(()=>{m.disabled=!s.canEdit,J(G,Le()||1)}),i(_,m)};b($,_=>{e(T)?_(M):_(ee,!1)})}re(2),t(F);var De=r(F,2),H=a(De),ve=a(H);{var he=_=>{const m=q(()=>s.eventsStore.getEventById(g()));var p=Ze(),O=de(p);{var G=j=>{var W=ba(),ue=r(a(W),2);Ke(ue,21,()=>e(m).teams,dt,(Se,ke)=>{var I=_a(),l=a(I);at(l,{class:"inline size-4"});var v=r(l,2),h=a(v,!0);t(v),t(I),k(()=>J(h,e(ke))),i(Se,I)}),t(ue),t(W),i(j,W)};b(O,j=>{e(m)&&e(m).teams&&e(m).teams.length>0&&j(G)})}i(_,p)};b(ve,_=>{g()&&_(he)})}var we=r(ve,2);{var ce=_=>{var m=ha(),p=r(a(m),2);Ke(p,21,()=>e(ae),O=>O.id,(O,G)=>{var j=pa(),W=a(j),ue=a(W,!0);t(W),t(j),k(()=>J(ue,e(G).name||e(G).email)),i(O,j)}),t(p),t(m),i(_,m)};b(we,_=>{e(ae).length>0&&_(ce)})}var oe=r(we,2);{var A=_=>{var m=ya(),p=r(a(m),2);Ke(p,21,()=>e(Z),O=>O.id,(O,G)=>{var j=xa(),W=a(j),ue=a(W,!0);t(W),t(j),k(()=>J(ue,e(G).name||e(G).email)),i(O,j)}),t(p),t(m),i(_,m)};b(oe,_=>{e(Z).length>0&&_(A)})}t(H),t(De);var V=r(De,2);{var R=_=>{var m=wa(),p=a(m);p.__click=()=>n(Q,!0);var O=a(p);ea(O,{class:"mr-2 h-4 w-4"}),re(),t(p),t(m),i(_,m)};b(V,_=>{g()&&_(R)})}i(d,S)},$$slots:{default:!0}});var Oe=r(ye,2);At(Oe,{get isOpen(){return e(Q)},onClose:ge,children:(d,f)=>{var S=Aa(),F=de(S);Ot(F,{title:"Inviter des participants",onClose:ge});var $=r(F,2);jt($,{children:(ee,De)=>{var H=qa(),ve=a(H),he=r(a(ve),2),we=a(he),ce=a(we);ta(ce,{class:"h-4 w-4 opacity-70"});var oe=r(ce,2);We(oe),oe.__keydown=I=>I.key==="Enter"&&pe(),t(we);var A=r(we,2);A.__click=pe;var V=a(A);gt(V,{class:"h-4 w-4 opacity-70"}),re(),t(A),t(he);var R=r(he,2);{var _=I=>{var l=Ea(),v=a(l,!0);t(l),k(()=>J(v,e(w))),i(I,l)};b(R,I=>{e(w)&&I(_)})}var m=r(R,2);Ke(m,21,()=>e(z),dt,(I,l)=>{var v=Ta(),h=a(v,!0);t(v),k(()=>J(h,e(l).email)),i(I,v)}),t(m),t(ve);var p=r(ve,4),O=a(p),G=a(O);at(G,{size:16,class:"inline shrink-0 opacity-60"}),re(),t(O);var j=r(O,2);{var W=I=>{const l=q(()=>s.eventsStore.getEventById(g()));var v=Ze(),h=de(v);{var L=C=>{var P=Da(),ne=r(a(P),2);Ke(ne,21,()=>e(l).teams,dt,(Pe,je)=>{var Ce=Ia(),Ne=a(Ce);at(Ne,{class:"inline size-4"});var _e=r(Ne,1,!0);t(Ce),k(()=>J(_e,e(je))),i(Pe,Ce)}),t(ne),t(P),i(C,P)};b(h,C=>{e(l)&&e(l).teams&&e(l).teams.length>0&&C(L)})}i(I,v)};b(j,I=>{g()&&I(W)})}var ue=r(j,2);{var Se=I=>{const l=q(()=>s.nativeTeamsStore.myTeams.filter(P=>{if(!g())return!0;const ne=s.eventsStore.getEventById(g());return!ne||!ne.teams?!0:!ne.teams.includes(P.name)}));var v=Ze(),h=de(v);{var L=P=>{var ne=Ma(),Pe=de(ne);Ke(Pe,21,()=>e(l),dt,(Ne,_e)=>{var Me=Sa(),ze=a(Me);We(ze),ze.__change=()=>fe(e(_e).$id);var o=r(ze,2),c=a(o),x=a(c),D=r(x),se=a(D);t(D),t(c);var qe=r(c,2),X=a(qe,!0);t(qe),t(o),t(Me),k((K,xe)=>{Nt(ze,K),J(x,`${e(_e).name??""} `),J(se,`${e(_e).total??""} membre${e(_e).total>1?"s":""}`),J(X,xe)},[()=>e(B).includes(e(_e).$id),()=>s.nativeTeamsStore.getTeamMemberNames(e(_e).$id).join(", ")]),i(Ne,Me)}),t(Pe);var je=r(Pe,2);{var Ce=Ne=>{var _e=Ca(),Me=de(_e),ze=a(Me);We(ze),re(2),t(Me),re(2),Rt(ze,()=>e(E),o=>n(E,o)),i(Ne,_e)};b(je,Ne=>{e(B).length>0&&Ne(Ce)})}i(P,ne)},C=P=>{var ne=Pa();i(P,ne)};b(h,P=>{e(l).length>0?P(L):P(C,!1)})}i(I,v)},ke=I=>{var l=Na();i(I,l)};b(ue,I=>{s.nativeTeamsStore.myTeams.length>0?I(Se):I(ke,!1)})}t(p),t(H),k(()=>A.disabled=!e(U)),et(oe,()=>e(U),I=>n(U,I)),i(ee,H)}});var M=r($,2);Lt(M,{children:(ee,De)=>{var H=za(),ve=de(H);ve.__click=ge;var he=r(ve,2);he.__click=me;var we=a(he);yt(we,{class:"mr-2 h-4 w-4"});var ce=r(we,2);{var oe=A=>{var V=Pt();k(R=>J(V,`(${R??""})`),[()=>e(Y)().length+e(z).length]),i(A,V)};b(ce,A=>{(e(Y)().length>0||e(z).length>0)&&A(oe)})}t(he),k(A=>he.disabled=A,[()=>e(z).length===0&&e(Y)().length===0]),i(ee,H)}}),i(d,S)},$$slots:{default:!0}}),i(Xe,Ie),pt()}_t(["click","keydown","change"]);var La=u('<div class="flex items-center gap-2"><!> <span> </span></div>'),Ba=u('<div class="flex items-center gap-2"><!> <span>A r√©aliser avant le :</span> <span class="font-medium"> </span></div>'),Va=u("<div><div><span> </span></div></div>"),Ua=u('<div><div class="bg-base-300 text-base-content w-7 rounded-full"><span class="text-base"> </span></div></div>'),Ga=u('<span class="text-warning mx-1 text-base italic">Non assign√©</span>'),Fa=u('<p class="text-base-content/60 mt-1 line-clamp-2 text-sm"> </p>'),Ha=u("<button><!> Fait <!></button>"),Ra=u(`<button class="btn btn-primary btn-outline btn-sm gap-1" title="Me porter volontaire pour cette t√¢che"><!> <span>M'inscrire</span></button>`),Wa=u('<button class="btn btn-error btn-sm btn-outline gap-1" title="Quitter cette t√¢che"><!> <span>me d√©sinscrire</span></button>'),Ka=u('<div><div class="flex flex-col gap-3"><div class="flex min-w-0 items-start gap-3"><div class="flex min-w-0 grow flex-col gap-4"><div class="flex flex-wrap items-start justify-between gap-x-4 gap-y-2"><div> </div> <div><!> <!> <!></div></div>  <div class="flex items-center gap-2"><!> <div class="flex min-w-0 items-center gap-1"><div class="flex flex-wrap gap-2"><!> <!> <!></div> <span> </span></div></div> <!></div></div></div> <div class="mt-4 flex items-center justify-between gap-2"><div class="flex gap-2"><!></div> <div class="ms-auto flex gap-2"><!> <button class="btn btn-sm btn-square" title="Modifier la t√¢che"><!></button></div></div></div>');function Ja(Xe,s){bt(s,!0);let Le=Ye(s,"disabled",3,!1),g=Ye(s,"contributors",19,()=>[]),y=N(!1);const B=q(()=>Array.isArray(s.todo.assignedTo)?s.todo.assignedTo:[]),z=q(()=>le.userId&&e(B).includes(le.userId)),E=q(()=>s.todo.assignedTo?s.todo.assignedTo.map(l=>{const v=g().find(C=>C.id===l),h=l===le.userId,L=v?.name||(h?"Moi":l.substring(0,5));return{userId:l,name:L,isCurrentUser:h}}):[]),Q=q(()=>e(E).length>=(s.todo.requiredPeopleNb||1)),T=q(()=>{switch(s.todo.taskOn){case"beforeEvent":return{bg:"bg-accent/30",icon:na,label:"Avant l'√©v√©nement"};case"afterEvent":return{bg:"bg-secondary/10",icon:aa,label:"Apr√®s l'√©v√©nement"};default:return{bg:"bg-secondary/20",icon:kt,label:"Pendant l'√©v√©nement"}}});async function U(){if(e(y)||Le())return;const v=s.todo.status==="done"?"todo":"done";n(y,!0);try{await Je.updateTodo(s.eventId,s.todo.id,{status:v})}catch{te.error("Erreur m√†j statut")}finally{n(y,!1)}}async function w(){if(!le.userId||e(y))return;const l=e(z)?e(B).filter(v=>v!==le.userId):[...e(B),le.userId];n(y,!0);try{await Je.updateTodo(s.eventId,s.todo.id,{assignedTo:l.length>0?l:null}),te.success(e(z)?"Vous avez rejoint la t√¢che":"Vous avez quitt√© la t√¢che")}catch{te.error("Erreur assignation")}finally{n(y,!1)}}var ae=Ka();let Z;var fe=a(ae),pe=a(fe),me=a(pe),ge=a(me),Y=a(ge),Ie=a(Y,!0);t(Y);var ye=r(Y,2),Oe=a(ye);{var d=l=>{};b(Oe,l=>{s.todo.priority&&s.todo.priority!=="low"&&l(d)})}var f=r(Oe,2);{var S=l=>{var v=La(),h=a(v);Wt(h,()=>e(T).icon,(P,ne)=>{ne(P,{class:"size-4 shrink-0 opacity-70"})});var L=r(h,2),C=a(L,!0);t(L),t(v),k(()=>J(C,e(T).label)),i(l,v)};b(f,l=>{s.todo.taskOn&&l(S)})}var F=r(f,2);{var $=l=>{var v=Ba(),h=a(v);Et(h,{class:"size-4 shrink-0 opacity-70"});var L=r(h,4),C=a(L,!0);t(L),t(v),k(P=>J(C,P),[()=>new Date(s.todo.dueDate).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})]),i(l,v)};b(F,l=>{s.todo.dueDate&&l($)})}t(ye),t(ge);var M=r(ge,2),ee=a(M);at(ee,{class:"mt-1 mb-auto size-4 shrink-0 opacity-60"});var De=r(ee,2),H=a(De),ve=a(H);Ke(ve,19,()=>e(E).slice(0,3),l=>l.userId,(l,v)=>{var h=Va(),L=a(h),C=a(L),P=a(C,!0);t(C),t(L),t(h),k(()=>{wt(h,"title",e(v).name+(e(v).isCurrentUser?" (vous)":"")),$e(L,1,`badge badge-soft badge-info ${(e(v).isCurrentUser&&"ring-info font-semibold ring-1")??""}`),J(P,e(v).name)}),i(l,h)});var he=r(ve,2);{var we=l=>{var v=Ua(),h=a(v),L=a(h),C=a(L);t(L),t(h),t(v),k(()=>{wt(v,"title",`+${e(E).length-3} autres`),J(C,`+${e(E).length-3}`)}),i(l,v)};b(he,l=>{e(E).length>3&&l(we)})}var ce=r(he,2);{var oe=l=>{var v=Ga();i(l,v)};b(ce,l=>{e(E).length===0&&l(oe)})}t(H);var A=r(H,2),V=a(A);t(A),t(De),t(M);var R=r(M,2);{var _=l=>{var v=Fa(),h=a(v,!0);t(v),k(()=>J(h,s.todo.taskDescription)),i(l,v)};b(R,l=>{s.todo.taskDescription&&l(_)})}t(me),t(pe),t(fe);var m=r(fe,2),p=a(m),O=a(p);{var G=l=>{var v=Ha();v.__click=U;var h=a(v);{let P=q(()=>s.todo.status!=="done"&&"opacity-60");yt(h,{get class(){return`size-4 ${e(P)??""}`}})}var L=r(h,2);{var C=P=>{var ne=Pt("?");i(P,ne)};b(L,P=>{s.todo.status!=="done"&&P(C)})}t(v),k(()=>{$e(v,1,`btn btn-sm ${s.todo.status!=="done"?"btn-dash":"btn-success"}`),wt(v,"title",s.todo.status==="done"?"Marquer √† faire":"Marquer fait"),v.disabled=Le()}),i(l,v)};b(O,l=>{s.todo.taskOn==="beforeEvent"&&l(G)})}t(p);var j=r(p,2),W=a(j);{var ue=l=>{var v=Ra();v.__click=w;var h=a(v);yt(h,{class:"size-4"}),re(2),t(v),i(l,v)},Se=l=>{var v=Ze(),h=de(v);{var L=C=>{var P=Wa();P.__click=w;var ne=a(P);sa(ne,{class:"size-4"}),re(2),t(P),i(C,P)};b(h,C=>{e(z)&&C(L)},!0)}i(l,v)};b(W,l=>{e(z)?l(Se,!1):l(ue)})}var ke=r(W,2);ke.__click=()=>s.onEdit(s.todo);var I=a(ke);xt(I,{class:"size-4"}),t(ke),t(j),t(m),t(ae),k(()=>{Z=$e(ae,1,`group bg-base-200/50 relative rounded-xl p-4 shadow transition-all ${e(Q)?"shadow-success/40 ":"shadow-warning/40 "}`,null,Z,{"opacity-50":e(y)}),$e(Y,1,`text-base font-medium ${s.todo.status==="done"?"line-through opacity-50":""}`),J(Ie,s.todo.taskName),$e(ye,1,`card card-sm ${e(T).bg??""} ms-auto flex flex-col justify-end px-4 py-1`),$e(A,1,`mx-1 ${e(E).length<(s.todo.requiredPeopleNb||1)?"text-warning":"text-success"} font-medium`),J(V,`${e(E).length??""}/${(s.todo.requiredPeopleNb||1)??""} pers. requise`)}),i(Xe,ae),pt()}_t(["click"]);var Qa=u('<div role="tablist" class="tabs tabs-border tabs-lg mb-4"><button role="tab"><!> T√¢che individuelle</button> <button role="tab"><!> T√¢ches pr√©d√©finies</button></div>'),Ya=u('<span class="badge badge-warning badge-sm"> </span>'),Xa=u('<span class="badge badge-success badge-sm flex items-center gap-1"><!> ok</span>'),Za=u(`<div class="space-y-4"><fieldset class="fieldset"><legend class="fieldset-legend">Titre</legend> <label class="input w-full"><input type="text" placeholder="Ex: Acheter du pain, Pr√©parer la salle..." class="grow"/></label></fieldset> <fieldset class="fieldset"><legend class="fieldset-legend flex items-center gap-2"><!> Description</legend> <textarea class="textarea h-24 w-full" placeholder="D√©tails suppl√©mentaires..."></textarea></fieldset> <div class="flex flex-wrap gap-4"><fieldset class="fieldset w-80"><legend class="fieldset-legend flex items-center gap-2"><!> Moment</legend> <select class="select w-full"><option>Avant l'√©v√©nement</option><option>Pendant l'√©v√©nement</option><option>Apr√®s l'√©v√©nement</option></select></fieldset> <fieldset class="fieldset w-80"><legend class="fieldset-legend flex items-center gap-2"><!> √âch√©ance</legend> <label class="input w-full"><input type="date" class="grow"/></label></fieldset> <fieldset class="fieldset"><legend class="fieldset-legend flex items-center gap-2"><!> Personnes requises</legend> <label class="input w-full"><input type="number" min="1" class="grow"/></label></fieldset></div> <fieldset class="fieldset"><legend class="fieldset-legend flex items-center gap-2"><!> <!></legend> <!></fieldset></div>`),$a=u('<div class="bg-base-100 flex items-center gap-4 rounded-lg p-3"><input type="checkbox" class="checkbox checkbox-primary"/> <input type="text" class="input flex-1"/> <div class="flex items-center gap-2"><!> <input type="number" class="input w-20" min="1"/></div></div>'),en=u('<div class="collapse-arrow bg-base-200 collapse"><input type="checkbox" checked/> <div class="collapse-title flex items-center gap-2 text-base font-medium"><!> </div> <div class="collapse-content"><div class="mt-4 space-y-3"></div></div></div>'),tn=u('<div class="space-y-6"></div>'),an=u("<!> <!>",1),nn=u('<span class="loading loading-spinner loading-sm"></span>'),sn=u('<button type="button" class="btn btn-primary"><!> Cr√©er les t√¢ches s√©lectionn√©es</button>'),rn=u('<button type="button" class="btn btn-ghost"><!> Sauvegarder & Cr√©er</button>'),on=u('<span class="loading loading-spinner loading-sm"></span>'),ln=u('<!> <button type="button" class="btn btn-primary"><!> </button>',1),dn=u("<!> <!> <!>",1);function vn(Xe,s){bt(s,!0);let Le=Ye(s,"contributors",19,()=>[]);Ye(s,"currentTodos",19,()=>[]);let g=N(""),y=N(""),B=N("medium"),z=N("onEvent"),E=N(1),Q=N(""),T=N(mt([])),U=N(!1),w=N("individual");const ae={beforeEvent:["Gestion de l'approvisionnement / courses","Choix des recettes/menus","Coordination","Communication (mail, texto, affiches)","Gestion matos"],onEvent:["Pr√©parations des recettes","Service","Rangement","Vaisselle","Gestion des restes"],afterEvent:["Retour matos","D√©montage cuisine"]},Z=q(()=>s.todoToEdit?{taskName:s.todoToEdit.taskName,taskDescription:s.todoToEdit.taskDescription||"",priority:s.todoToEdit.priority||"medium",taskOn:s.todoToEdit.taskOn||"onEvent",requiredPeopleNb:s.todoToEdit.requiredPeopleNb||1,dueDate:s.todoToEdit.dueDate?s.todoToEdit.dueDate.split("T")[0]:"",assignedTo:s.todoToEdit.assignedTo?[...s.todoToEdit.assignedTo]:[]}:{taskName:"",taskDescription:"",priority:"medium",taskOn:"onEvent",requiredPeopleNb:1,dueDate:"",assignedTo:[]});tt(()=>{if(s.open){s.todoToEdit?n(w,"individual"):n(w,"individual");const d=e(Z);n(g,d.taskName,!0),n(y,d.taskDescription,!0),n(B,d.priority,!0),n(z,d.taskOn,!0),n(E,d.requiredPeopleNb,!0),n(Q,d.dueDate,!0),n(T,d.assignedTo,!0)}});function fe(){n(g,""),n(y,""),n(B,"medium"),n(z,"onEvent"),n(E,1),n(Q,""),n(T,[],!0)}async function pe(d=!1){if(!e(g).trim()){te.warning("Le titre de la t√¢che est requis");return}n(U,!0);try{const f=new Date().toISOString();if(s.todoToEdit){const S={taskName:e(g),taskDescription:e(y)||null,priority:e(B),taskOn:e(z),requiredPeopleNb:e(E),dueDate:e(Q)?new Date(e(Q)).toISOString():null,assignedTo:e(T).length>0?e(T):null};await Je.updateTodo(s.eventId,s.todoToEdit.id,S),te.success("T√¢che mise √† jour"),me()}else{const S={id:ht(10),taskName:e(g),taskDescription:e(y)||null,priority:e(B),taskOn:e(z),requiredPeopleNb:e(E),dueDate:e(Q)?new Date(e(Q)).toISOString():null,assignedTo:e(T).length>0?e(T):null,status:"todo"};await Je.addTodo(s.eventId,S),te.success("T√¢che cr√©√©e"),d?fe():me()}}catch(f){te.error("Erreur lors de la sauvegarde"),console.error(f)}finally{n(U,!1)}}function me(){fe(),s.onClose()}function ge(d){e(T).includes(d)?n(T,e(T).filter(f=>f!==d),!0):n(T,[...e(T),d],!0)}let Y=N(mt([]));tt(()=>{s.open&&e(w)==="bulk"&&n(Y,[...ae.beforeEvent.map(d=>({taskName:d,taskOn:"beforeEvent",enabled:!0,requiredPeopleNb:1})),...ae.onEvent.map(d=>({taskName:d,taskOn:"onEvent",enabled:!0,requiredPeopleNb:1})),...ae.afterEvent.map(d=>({taskName:d,taskOn:"afterEvent",enabled:!1,requiredPeopleNb:1}))],!0)});async function Ie(){const d=e(Y).filter(f=>f.enabled);if(d.length===0){te.warning("S√©lectionnez au moins une t√¢che");return}n(U,!0);try{const f=new Date().toISOString(),S=d.map(F=>({id:ht(10),taskName:F.taskName,taskDescription:null,priority:"medium",taskOn:F.taskOn,requiredPeopleNb:F.requiredPeopleNb,dueDate:null,assignedTo:null,status:"todo"}));await Je.addTodos(s.eventId,S),te.success(`${S.length} t√¢che(s) cr√©√©e(s)`),me()}catch(f){te.error("Erreur lors de la cr√©ation"),console.error(f)}finally{n(U,!1)}}function ye(d){e(Y)[d].enabled=!e(Y)[d].enabled}const Oe=q(()=>{const d=[{id:le.userId||"",label:"Moi",selected:e(T).includes(le.userId||"")}];return Le().forEach(f=>{f.id!==le.userId&&d.push({id:f.id,label:f.name||f.email||f.id.substring(0,5),selected:e(T).includes(f.id)})}),d});At(Xe,{get isOpen(){return s.open},onClose:me,maxWidth:"lg",maxHeight:"xl",children:(d,f)=>{var S=dn(),F=de(S);{let ee=q(()=>s.todoToEdit?"Modifier la T√¢che":"Nouvelle T√¢che");Ot(F,{get title(){return e(ee)},onClose:me})}var $=r(F,2);jt($,{children:(ee,De)=>{var H=an(),ve=de(H);{var he=A=>{var V=Qa(),R=a(V);R.__click=()=>n(w,"individual");var _=a(R);St(_,{class:"me-2 size-4"}),re(),t(R);var m=r(R,2);m.__click=()=>n(w,"bulk");var p=a(m);Ct(p,{class:"me-2 size-4"}),re(),t(m),t(V),k(()=>{$e(R,1,`tab ${e(w)==="individual"?"tab-active":""}`),$e(m,1,`tab ${e(w)==="bulk"?"tab-active":""}`)}),i(A,V)};b(ve,A=>{s.todoToEdit||A(he)})}var we=r(ve,2);{var ce=A=>{var V=Za(),R=a(V),_=r(a(R),2),m=a(_);We(m),t(_),t(R);var p=r(R,2),O=a(p),G=a(O);St(G,{class:"size-4 opacity-50"}),re(),t(O);var j=r(O,2);qt(j),t(p);var W=r(p,2),ue=a(W),Se=a(ue),ke=a(Se);kt(ke,{class:"size-4 opacity-50"}),re(),t(Se);var I=r(Se,2),l=a(I);l.value=l.__value="beforeEvent";var v=r(l);v.value=v.__value="onEvent";var h=r(v);h.value=h.__value="afterEvent",t(I),t(ue);var L=r(ue,2),C=a(L),P=a(C);Et(P,{class:"size-4 opacity-50"}),re(),t(C);var ne=r(C,2),Pe=a(ne);We(Pe),t(ne),t(L);var je=r(L,2),Ce=a(je),Ne=a(Ce);at(Ne,{class:"size-4 opacity-50"}),re(),t(Ce);var _e=r(Ce,2),Me=a(_e);We(Me),t(_e),t(je),t(W);var ze=r(W,2),o=a(ze),c=a(o);at(c,{class:"size-4 opacity-50"});var x=r(c),D=r(x);{var se=K=>{var xe=Ya(),Ue=a(xe);t(xe),k(()=>J(Ue,`Manque ${e(E)-e(T).length} pers.`)),i(K,xe)},qe=K=>{var xe=Xa(),Ue=a(xe);yt(Ue,{class:"size-3"}),re(),t(xe),i(K,xe)};b(D,K=>{e(T).length<e(E)?K(se):K(qe,!1)})}t(o);var X=r(o,2);ca(X,{get items(){return e(Oe)},size:"lg",color:"primary",onToggleItem:ge}),t(ze),t(V),k(()=>J(x,` Assignation (${e(T).length??""}/${e(E)??""}) `)),et(m,()=>e(g),K=>n(g,K)),et(j,()=>e(y),K=>n(y,K)),Kt(I,()=>e(z),K=>n(z,K)),et(Pe,()=>e(Q),K=>n(Q,K)),et(Me,()=>e(E),K=>n(E,K)),i(A,V)},oe=A=>{var V=tn();Ke(V,20,()=>["beforeEvent","onEvent","afterEvent"],dt,(R,_)=>{const m=q(()=>_==="beforeEvent"?"Avant l'√©v√©nement":_==="onEvent"?"Pendant l'√©v√©nement":"Apr√®s l'√©v√©nement"),p=q(()=>e(Y).filter(W=>W.taskOn===_));var O=Ze(),G=de(O);{var j=W=>{var ue=en(),Se=a(ue);We(Se);var ke=r(Se,2),I=a(ke);kt(I,{class:"size-4 opacity-50"});var l=r(I);t(ke);var v=r(ke,2),h=a(v);Ke(h,21,()=>e(p),dt,(L,C,P)=>{const ne=q(()=>e(Y).indexOf(e(C)));var Pe=$a(),je=a(Pe);We(je),je.__change=()=>ye(e(ne));var Ce=r(je,2);We(Ce);var Ne=r(Ce,2),_e=a(Ne);at(_e,{class:"size-4 opacity-50"});var Me=r(_e,2);We(Me),t(Ne),t(Pe),k(()=>{Nt(je,e(C).enabled),zt(Ce,e(C).taskName),Ce.disabled=!e(C).enabled,Me.disabled=!e(C).enabled}),et(Me,()=>e(C).requiredPeopleNb,ze=>e(C).requiredPeopleNb=ze),i(L,Pe)}),t(h),t(v),t(ue),k(L=>J(l,` ${e(m)??""} (${L??""}/${e(p).length??""})`),[()=>e(p).filter(L=>L.enabled).length]),i(W,ue)};b(G,W=>{e(p).length>0&&W(j)})}i(R,O)}),t(V),i(A,V)};b(we,A=>{s.todoToEdit||e(w)==="individual"?A(ce):A(oe,!1)})}i(ee,H)}});var M=r($,2);Lt(M,{children:(ee,De)=>{var H=Ze(),ve=de(H);{var he=ce=>{var oe=sn();oe.__click=Ie;var A=a(oe);{var V=_=>{var m=nn();i(_,m)},R=_=>{Ct(_,{class:"size-4"})};b(A,_=>{e(U)?_(V):_(R,!1)})}re(),t(oe),k(()=>oe.disabled=e(U)),i(ce,oe)},we=ce=>{var oe=ln(),A=de(oe);{var V=G=>{var j=rn();j.__click=()=>pe(!0);var W=a(j);gt(W,{class:"size-4"}),re(),t(j),k(()=>j.disabled=e(U)),i(G,j)};b(A,G=>{s.todoToEdit||G(V)})}var R=r(A,2);R.__click=()=>pe(!1);var _=a(R);{var m=G=>{var j=on();i(G,j)},p=G=>{Bt(G,{class:"size-4"})};b(_,G=>{e(U)?G(m):G(p,!1)})}var O=r(_);t(R),k(()=>{R.disabled=e(U),J(O,` ${s.todoToEdit?"Mettre √† jour":"Cr√©er la t√¢che"}`)}),i(ce,oe)};b(ve,ce=>{e(w)==="bulk"?ce(he):ce(we,!1)})}i(ee,H)}}),i(d,S)},$$slots:{default:!0}}),pt()}_t(["click","change"]);var cn=u('<div class="text-base-content/50 border-base-200 hover:border-primary/50 cursor-pointer rounded-lg border-2 border-dashed py-8 text-center text-sm italic transition-colors" role="button" tabindex="0">Aucune t√¢che pour le moment. <br/> <span class="text-primary mt-1 inline-block font-medium">Cr√©er la premi√®re t√¢che +</span></div>'),un=u('<div class="mb-4 flex items-center justify-between"><div class="flex items-center gap-2 text-sm opacity-60"><!> <span> </span></div> <button class="btn btn-sm btn-primary gap-2"><!> Nouvelle t√¢che</button></div> <div class=" space-y-4"><!></div> <!>',1);function fn(Xe,s){bt(s,!0);let Le=Ye(s,"contributors",19,()=>[]),g=Ye(s,"disabled",3,!1);const y=q(()=>s.event.todos??[]);function B(ae){return{beforeEvent:1,onEvent:2,afterEvent:3}[ae]??0}const z=q(()=>[...e(y)].sort((Z,fe)=>{const pe=B(Z.taskOn??""),me=B(fe.taskOn??""),ge=pe-me;if(ge!==0)return ge;const Y=Z.dueDate?new Date(Z.dueDate).getTime():1/0,Ie=fe.dueDate?new Date(fe.dueDate).getTime():1/0;return Y-Ie}));let E=N(!1),Q=N(null);function T(){n(Q,null),n(E,!0)}function U(ae){n(Q,ae,!0),n(E,!0)}function w(ae){s.onTodosChange?.(ae)}ft(Xe,{legend:"T√¢ches & Organisation",legendSize:"text-lg",children:(ae,Z)=>{var fe=un(),pe=de(fe),me=a(pe),ge=a(me);ra(ge,{class:"size-4"});var Y=r(ge,2),Ie=a(Y);t(Y),t(me);var ye=r(me,2);ye.__click=T;var Oe=a(ye);gt(Oe,{class:"size-4"}),re(),t(ye),t(pe);var d=r(pe,2),f=a(d);{var S=M=>{var ee=cn();ee.__click=T,ee.__keydown=De=>De.key==="Enter"&&T(),i(M,ee)},F=M=>{var ee=Ze(),De=de(ee);Ke(De,17,()=>e(z),H=>H.id,(H,ve)=>{Ja(H,{get todo(){return e(ve)},get eventId(){return s.event.$id},onEdit:U,get disabled(){return g()},get contributors(){return Le()}})}),i(M,ee)};b(f,M=>{e(z).length===0?M(S):M(F,!1)})}t(d);var $=r(d,2);vn($,{get open(){return e(E)},get eventId(){return s.event.$id},get todoToEdit(){return e(Q)},get contributors(){return Le()},get currentTodos(){return e(y)},onClose:()=>n(E,!1),onSave:w}),k(()=>J(Ie,`${e(y).length??""} t√¢ches`)),i(ae,fe)},$$slots:{default:!0}}),pt()}_t(["click","keydown"]);var mn=u('<span class="loading loading-spinner loading-xs text-primary"></span>'),gn=u('<div class="flex items-center gap-2"><button class="btn btn-accent btn-sm"><!> <span class="font-bold">Enregistrer</span></button></div>'),_n=u(`<input type="text" class="input input-lg min-w-full shadow-md" placeholder="Nom de l'√©v√©nement"/>`),bn=u('<button class="btn btn-ghost"><div class="flex items-baseline gap-4"><h1> </h1> <!></div></button>'),pn=u(`<textarea class="textarea w-full" placeholder="D√©crivez l'√©v√©nement..." maxlength="3000" rows="9"></textarea> <p class="label"> </p>`,1),hn=u('<p class="whitespace-pre-wrap"> </p>'),xn=u('<p class="text-base-content/40 italic">Ajoutez une description...</p>'),yn=u('<button class="btn btn-ghost bg-base-100 h-auto justify-start py-4 text-left font-normal"><div class="flex w-full items-start justify-between gap-4"><div class="flex-1"><!></div> <!></div></button>'),wn=u(`<button class="btn btn-success btn-link btn-md">Confirmez l'√©v√©nement</button> <button class="btn btn-link btn-error btn-sm">Annuler l'√©v√©nement</button>`,1),kn=u(`<button class="btn btn-link btn-error btn-sm">Annuler l'√©v√©nement</button>`),En=u('<button class="btn btn-link btn-sm">R√©activer</button>'),Tn=u('<div class="flex flex-wrap items-center justify-between gap-2"><!> <!></div>'),In=u('<div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:col-span-2 lg:grid-cols-3"><div class="col-span-2"><!></div> <div class="flex flex-col justify-start gap-4"><!></div></div>'),Dn=u(`<div class="flex items-center justify-center py-20"><div class="flex flex-col items-center gap-4"><span class="loading loading-spinner loading-lg text-primary"></span> <p class="text-base-content/60">Chargement de l'√©v√©nement...</p></div></div>`),Sn=u(`<div class="alert alert-info"><!> <div><h4 class="font-bold">Mode D√©monstration</h4> <p class="text-sm">Dans un v√©ritable √©v√©nement, vous pourrez inviter des √©quipes
                  et des participants √† collaborer sur la planification.</p></div></div>`),Cn=u(`<div class="alert alert-warning max-md:alert-vertical"><!> <div><h3 class="font-bold">√âv√©nement en cours de modification</h3> <div class="text-xs">Un autre utilisateur est en train de modifier cet √©v√©nement. Les
                contr√¥les sont temporairement d√©sactiv√©s.</div></div></div>`),Mn=u('<div class="text-base-content/60 bg-base-200 rounded-box border-base-200 flex flex-col items-center justify-center border-2 border-dashed py-12"><div class="bg-base-200 mb-4 rounded-full p-4"><!></div> <p class="font-medium">Aucun repas planifi√©</p> <p class="mt-1 text-sm">Commencez par ajouter un repas √† votre √©v√©nement</p></div>'),Pn=u("<div><!></div>"),Nn=u('<div class="space-y-4"></div>'),qn=u('<div class="grid grid-cols-1 gap-6 pb-20 lg:grid-cols-3"><div class="space-y-6 lg:col-span-1"><!> <!></div> <div class="space-y-6 md:px-4 lg:col-span-2"><!> <div class="mb-6 flex items-center justify-between"><h3 class="card-title text-lg"> </h3> <button class="btn btn-primary"><!> Ajouter un repas</button></div> <!> <div class="flex"><button class="btn btn-outline btn-primary btn-block mt-4"><!> Ajouter un repas</button></div></div></div>'),zn=u('<div class="bg-base-200 min-h-lvh space-y-6 px-2 pt-4 pb-20 md:px-20"><div class="flex flex-wrap items-center justify-between gap-x-6 gap-y-3"><div class="min-w-80 flex-1 gap-2"><!></div> <!></div> <!> <!> <!></div> <!> <!> <!>',1);function Zn(Xe,s){bt(s,!0);const Le=o=>{var c=gn(),x=a(c);x.__click=A;var D=a(x);{var se=X=>{var K=mn();i(X,K)},qe=X=>{Bt(X,{size:18,class:"mr-1"})};b(D,X=>{e(w)?X(se):X(qe,!1)})}re(2),t(x),t(c),k(()=>x.disabled=e(w)||!e(Oe)||!e(M)),i(o,c)};let g=q(()=>Yt.params.id),y=N(mt([])),B=N(""),z=N(""),E=N("proposition"),Q=N(1);const T=q(()=>[...e(y)].sort((o,c)=>new Date(o.date).getTime()-new Date(c.date).getTime()));let U=N(!1),w=N(!1),ae=N(!1),Z=N(!1),fe=N(null),pe=N(!1),me=N(!1),ge=N(!1),Y=N(!1),Ie=N(null),ye=null;const Oe=q(()=>{if(e(B)===""&&e(y).length===0||!e(U)||!e(Z)||!e(f))return!1;if(e(B)!==e(f).name||e(z)!==(e(f).description||"")||e(E)!==e(f).status||e(Q)!==(e(f).minContrib||1))return!0;const o=e(f).meals||[];if(e(y).length!==o.length)return!0;for(let c=0;c<e(y).length;c++){const x=o[c],D=e(y)[c];if(D.id!==x.id||D.date!==x.date||D.guests!==x.guests||(D.recipes?.length||0)!==(x.recipes?.length||0))return!0}return!1});async function d(){if(e(Z))return!0;if(e($))return te.warning(`Cet √©v√©nement est verrouill√© par ${e(ee)}`),!1;if(e(f)&&ot(e(f).$id))return n(Z,!0),!0;const o=await De();return o&&n(Z,!0),o}const f=q(()=>Je.getEventById(e(g))),S=q(()=>da(e(f))),F=q(()=>e(f)?.teamsId??[]),$=q(()=>e(Ie)?e(Ie).userId!==le.userId:!1),M=q(()=>e(f)&&ot(e(f).$id)||Je.canUserEditEvent(e(g),le.userId||"")&&!e($)&&!e(w)),ee=q(()=>e(Ie)?.userName||"un autre utilisateur");tt(()=>{if(!e(f)){console.log("[Sync] Guard 1 - Pas de currentEvent");return}if(!e(U)){console.log("[Sync] Guard 2 - Pas initialis√©");return}if(e(Z)&&e(B)!==""){console.log("[Sync] Guard 3 - Mode √©dition actif, pas de sync (shadow draft d√©j√† peupl√©)");return}Tt(()=>{const o=e(B),c=e(y).length;n(y,Jt(e(f).meals||[]),!0),n(B,e(f).name||"",!0),n(z,e(f).description||"",!0),n(E,e(f).status||"proposition",!0),n(Q,e(f).minContrib||1,!0)})}),tt(()=>{Dt.setConfig({actions:Le,isLockedByOthers:e($),lockedByUserName:e(ee),hasUnsavedChanges:e(Oe)&&!e($)})}),tt(()=>{if(e(U)||e(w)){console.log("[Init] Guard 1 - D√©j√† initialis√© ou occup√©",{isInitialised:e(U),isBusy:e(w)});return}if(!e(g)){console.log("[Init] Guard 2 - Pas d'eventId");return}console.log("[Init] D√©but initialisation pour eventId:",e(g)),Tt(async()=>{n(w,!0);try{const o=Je.getEventById(e(g));if(console.log("[Init] Event r√©cup√©r√©:",o?.$id,o?.name),o&&ot(o.$id)){console.log("[Init] Mode d√©mo: pr√™t, marquage isInitialised = true"),n(U,!0);return}n(Ie,await ut.getLock(e(g)),!0),ye=ut.subscribeToLock(e(g),c=>{console.log("[EventEditPage] üîí Verrou mis √† jour:",{lockedBy:c?.userName,userId:c?.userId,expiresAt:c?.expiresAt}),n(Ie,c,!0)}),n(U,!0)}finally{n(w,!1),console.log("[Init] Fin initialisation, isBusy = false")}})}),Qt(()=>{V&&(clearTimeout(V),V=null),ye&&(ye(),ye=null),e(g)&&e(Z)&&(console.log("üö™ D√©montage du composant, lib√©ration du lock..."),H()),Dt.reset()});async function De(){if(e(f)&&ot(e(f).$id))return console.log("[acquireLock] Mode d√©mo : pas de lock √† acqu√©rir"),!0;if(!e(g)||!le.userId||e(w)||e(ae))return!1;n(ae,!0);try{return await ut.acquireLock(e(g),le.userId,le.userName)?(R(),!0):(te.warning(`Cet √©v√©nement est en cours de modification par ${e(ee)}`),!1)}catch(o){return console.error("‚ùå Erreur acquisition verrou:",o),te.error("Impossible de verrouiller l'√©v√©nement"),!1}finally{n(ae,!1)}}async function H(){if(e(f)&&ot(e(f).$id)){console.log("[releaseLock] Mode d√©mo : d√©sactivation de isEditing"),n(Z,!1);return}if(!(!e(g)||!le.userId)){try{await ut.releaseLock(e(g),le.userId),console.log("üîì Verrou lib√©r√©")}catch(o){console.error("‚ùå Erreur lib√©ration verrou:",o)}n(Z,!1)}}async function ve(){e(Z)&&await H()}async function he(){const o=await ce();return o&&await H(),o}function we(){if(!e(B).trim())return{isValid:!1,errorMessage:"Veuillez renseigner le nom de l'√©v√©nement"};if(e(y).length===0)return{isValid:!1,errorMessage:"Veuillez ajouter au moins un repas"};const c=e(y).map(x=>x.date).filter((x,D,se)=>se.indexOf(x)!==D);return c.length>0?{isValid:!1,errorMessage:`Certaines dates sont en double: ${c.map(D=>{try{return new Date(D).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return D}}).join(", ")}`}:{isValid:!0}}async function ce(){const o=we();if(!o.isValid)return te.error(o.errorMessage||"Erreur de validation"),!1;e(S);const c=Array.from(new Set(e(T).map(X=>X.date))).sort(),x=e(f)?.teams||[],D=e(f)?.teamsId||[],se=new Map(D.map((X,K)=>[X,x[K]]));e(F).map(X=>It.getTeamById(X)?.name||se.get(X)||X);const qe={name:e(B),description:e(z),status:e(E),minContrib:e(Q),allDates:c,dateStart:c.length>0?c[0]:"",dateEnd:c.length>0?c[c.length-1]:"",meals:e(T)};try{return await Je.updateEvent(e(g),qe),!0}catch(X){return console.error("Erreur sauvegarde:",X),te.error("Erreur lors de la sauvegarde"),!1}}async function oe(){if(!e(g)||e(w)||!e(Z))return;n(w,!0);const o=te.loading("Sauvegarde automatique...");if(await ce())await H(),te.update(o,{state:"success",message:"Modifications sauvegard√©es automatiquement"});else{if(e(g)&&le.userId)try{await ut.acquireLock(e(g),le.userId,le.userName)}catch(x){console.error("Erreur heartbeat lock:",x)}te.update(o,{state:"warning",message:"Impossible de sauvegarder : modifications invalides"})}n(w,!1),setTimeout(()=>te.dismiss(o),3e3)}async function A(){n(w,!0),await ce()&&(await H(),te.success("√âv√©nement mis √† jour")),n(w,!1)}let V=null;function R(){V&&clearTimeout(V),V=setTimeout(()=>{oe()},120*1e3),console.log("‚è∞ Auto-save programm√© dans 30 secondes")}tt(()=>{const o=e(Z),c=e(Oe),x=D=>{(o||c)&&(D.preventDefault(),D.returnValue="Vous avez des modifications non sauvegard√©es. Voulez-vous vraiment quitter ?")};return window.addEventListener("beforeunload",x),()=>{window.removeEventListener("beforeunload",x)}});async function _(o){await d()&&n(B,o.target.value,!0)}async function m(){if(!await d())return;const o=ht(6);let c;if(e(T).length===0){const D=new Date;D.setDate(D.getDate()+7),D.setHours(20,0,0,0),c=D.toISOString()}else{const D=e(T)[e(T).length-1],se=new Date(D.date);se.getHours()<14?se.setHours(20,0,0,0):(se.setDate(se.getDate()+1),se.setHours(12,0,0,0)),c=se.toISOString()}const x={id:o,date:c,guests:100,recipes:[]};n(y,[...e(y),x],!0),n(fe,o,!0)}function p(o){n(y,e(y).filter(c=>c.id!==o),!0)}function O(o){n(fe,e(fe)===o?null:o,!0)}async function G(o){if(!(!e(g)||!le.userId))try{n(w,!0);const c=o?"accepted":"declined";await Je.updateContributorStatus(e(g),le.userId,c),te.success(o?"Invitation accept√©e":"Invitation d√©clin√©e")}catch(c){console.error("Erreur r√©ponse invitation:",c),te.error("Erreur lors de la r√©ponse")}finally{n(w,!1)}}async function j(){await d()&&(n(E,"confirmed"),n(ge,!1))}async function W(){await d()&&(n(E,"canceled"),n(Y,!1))}var ue=zn(),Se=de(ue),ke=a(Se),I=a(ke),l=a(I);{var v=o=>{var c=_n();We(c),c.__input=_,k(()=>{zt(c,e(B)),c.disabled=!e(M)}),lt("focus",c,d),lt("blur",c,()=>n(pe,!1)),i(o,c)},h=o=>{var c=bn();c.__click=()=>n(pe,!e(pe));var x=a(c),D=a(x),se=a(D,!0);t(D);var qe=r(D,2);xt(qe,{class:"h-4 w-4"}),t(x),t(c),k(()=>{c.disabled=!e(M),J(se,e(B)||"Nom de l'√©v√©nement")}),i(o,c)};b(l,o=>{e(pe)?o(v):o(h,!1)})}t(I);var L=r(I,2);{var C=o=>{va(o,{get currentEvent(){return e(f)}})};b(L,o=>{e(f)&&o(C)})}t(ke);var P=r(ke,2);{var ne=o=>{var c=In(),x=a(c),D=a(x);ft(D,{legend:"Description",children:(X,K)=>{var xe=Ze(),Ue=de(xe);{var vt=Be=>{var Ee=pn(),be=de(Ee);qt(be);var Ae=r(be,2),Ge=a(Ae);t(Ae),k(()=>{be.disabled=!e(M),J(Ge,`${e(z).length??""}/3000 caract√®res`)}),lt("focus",be,d),lt("blur",be,()=>n(me,!1)),et(be,()=>e(z),st=>n(z,st)),i(Be,Ee)},nt=Be=>{var Ee=yn();Ee.__click=()=>n(me,!0);var be=a(Ee),Ae=a(be),Ge=a(Ae);{var st=Fe=>{var rt=hn(),ie=a(rt,!0);t(rt),k(()=>J(ie,e(z))),i(Fe,rt)},Qe=Fe=>{var rt=xn();i(Fe,rt)};b(Ge,Fe=>{e(z)?Fe(st):Fe(Qe,!1)})}t(Ae);var Ve=r(Ae,2);xt(Ve,{class:"h-4 w-4 shrink-0"}),t(be),t(Ee),k(()=>Ee.disabled=!e(M)),i(Be,Ee)};b(Ue,Be=>{e(me)?Be(vt):Be(nt,!1)})}i(X,xe)},$$slots:{default:!0}}),t(x);var se=r(x,2),qe=a(se);ft(qe,{legend:"Statut de l'√©v√©nement",children:(X,K)=>{var xe=Tn(),Ue=a(xe);fa(Ue,{get status(){return e(E)}});var vt=r(Ue,2);{var nt=Ee=>{var be=wn(),Ae=de(be);Ae.__click=()=>n(ge,!0);var Ge=r(Ae,2);Ge.__click=()=>n(Y,!0),k(()=>{Ae.disabled=!e(M),Ge.disabled=!e(M)}),i(Ee,be)},Be=Ee=>{var be=Ze(),Ae=de(be);{var Ge=Qe=>{var Ve=kn();Ve.__click=()=>n(Y,!0),k(()=>Ve.disabled=!e(M)),i(Qe,Ve)},st=Qe=>{var Ve=En();Ve.__click=async()=>{await d()&&n(E,"proposition")},k(()=>Ve.disabled=!e(M)),i(Qe,Ve)};b(Ae,Qe=>{e(E)==="confirmed"?Qe(Ge):Qe(st,!1)},!0)}i(Ee,be)};b(vt,Ee=>{e(E)==="proposition"?Ee(nt):Ee(Be,!1)})}t(xe),i(X,xe)},$$slots:{default:!0}}),t(se),t(c),i(o,c)};b(P,o=>{e(U)&&o(ne)})}var Pe=r(P,2);la(Pe,{get currentEvent(){return e(f)},get isBusy(){return e(w)},onRespond:G});var je=r(Pe,2);{var Ce=o=>{var c=Dn();i(o,c)},Ne=o=>{var c=qn(),x=a(c),D=a(x);{var se=ie=>{ft(ie,{legend:"Participants",get iconComponent(){return at},children:(Te,He)=>{var Re=Sn(),it=a(Re);ia(it,{class:"h-5 w-5"}),re(2),t(Re),i(Te,Re)},$$slots:{default:!0}})},qe=ie=>{{let Te=q(()=>le.userId||"");ja(ie,{get canEdit(){return e(M)},get contributors(){return e(S)},get nativeTeamsStore(){return It},get eventsStore(){return Je},get userId(){return e(Te)},get eventId(){return e(g)},onStartEdit:d,get minContrib(){return e(Q)},set minContrib(He){n(Q,He,!0)}})}};b(D,ie=>{e(f)&&ot(e(f).$id)?ie(se):ie(qe,!1)})}var X=r(D,2);{var K=ie=>{{let Te=q(()=>!e(M)||e($));fn(ie,{get event(){return e(f)},get contributors(){return e(S)},get disabled(){return e(Te)}})}};b(X,ie=>{e(f)&&ie(K)})}t(x);var xe=r(x,2),Ue=a(xe);{var vt=ie=>{var Te=Cn(),He=a(Te);oa(He,{class:"h-6 w-6 shrink-0"}),re(2),t(Te),i(ie,Te)};b(Ue,ie=>{e($)&&ie(vt)})}var nt=r(Ue,2),Be=a(nt),Ee=a(Be);t(Be);var be=r(Be,2);be.__click=m;var Ae=a(be);gt(Ae,{class:"mr-1 h-4 w-4"}),re(),t(be),t(nt);var Ge=r(nt,2);{var st=ie=>{var Te=Mn(),He=a(Te),Re=a(He);Et(Re,{class:"h-8 w-8 opacity-50"}),t(He),re(4),t(Te),i(ie,Te)},Qe=ie=>{var Te=Nn();Ke(Te,29,()=>e(T),He=>He.id+"-"+e(f)?.$updatedAt,(He,Re)=>{var it=Pn(),Vt=a(it);{let Ut=q(()=>e(fe)===e(Re).id),Gt=q(()=>e(y).map(ct=>ct.date)),Ft=q(()=>!e(M)||e($));Zt(Vt,{get isEditing(){return e(Ut)},onEditToggle:async()=>{await d()&&O(e(Re).id||"")},onDelete:()=>p(e(Re).id||""),get allDates(){return e(Gt)},get disabled(){return e(Ft)},get meal(){return e(y)[e(y).findIndex(ct=>ct.id===e(Re).id)]},set meal(ct){e(y)[e(y).findIndex(Ht=>Ht.id===e(Re).id)]=ct}})}t(it),Xt(it,()=>$t,()=>({delay:100,duration:400})),i(He,it)}),t(Te),i(ie,Te)};b(Ge,ie=>{e(T).length===0?ie(st):ie(Qe,!1)})}var Ve=r(Ge,2),Fe=a(Ve);Fe.__click=m;var rt=a(Fe);gt(rt,{class:"mr-1 h-4 w-4"}),re(),t(Fe),t(Ve),t(xe),t(c),k(()=>{J(Ee,`Repas & Menus (${e(T).length??""})`),be.disabled=!e(M),Fe.disabled=!e(M)}),i(o,c)};b(je,o=>{e(w)&&!e(U)?o(Ce):o(Ne,!1)})}t(Se);var _e=r(Se,2);Mt(_e,{get isOpen(){return e(ge)},title:"Confirmer l'√©v√©nement",message:"√ätes-vous s√ªr de vouloir confirmer cet √©v√©nement ? ",variant:"info",confirmLabel:"Confirmer",cancelLabel:"Annuler",onConfirm:j,onCancel:()=>n(ge,!1)});var Me=r(_e,2);Mt(Me,{get isOpen(){return e(Y)},title:"Annuler la confirmation",message:"√ätes-vous s√ªr de vouloir annuler cet √©v√©nement ?.",variant:"warning",confirmLabel:"Oui, annuler",cancelLabel:"Non, garder",onConfirm:W,onCancel:()=>n(Y,!1)});var ze=r(Me,2);{let o=q(()=>`/event/${e(g)}`);ua(ze,{get routeKey(){return e(o)},shouldProtect:()=>e(Oe),onLeaveWithoutSave:ve,onSaveAndLeave:he,message:"Vous avez des modifications non sauvegard√©es. Voulez-vous vraiment quitter ?"})}i(Xe,ue),pt()}_t(["click","input"]);export{Zn as default};
