import{B as gt,d as _t,p as Ye,y as B,z as ft,J as et,A as s,m as e,v as d,k as de,K as _,h as a,g as i,u as D,b as o,w as E,S as ot,T as st,x as Q,j as Xe,e as Je,i as lt,U as Pt,ak as Gt,c as bt,aj as pt,O as ae,o as t,G as $,W as We,al as Nt,M as wt,C as at,I as ie,aa as Wt,_ as Ke,af as Jt,ae as zt,ac as qt,ah as kt,as as Tt,at as Kt,au as Qt,av as ct,Y as Yt,D as Xt,F as It,am as Zt}from"./appwrite.js";import{E as $t,f as ea}from"./EventMealCard.js";import{M as Ot,b as At,c as Lt,d as jt,n as Ct}from"./index.js";import{F as ut}from"./Fieldset.js";import{am as ht,a2 as ta,M as aa,c as mt,U as nt,G as xt,an as yt,ao as sa,af as na,t as Et,ap as ra,aq as St,ar as Dt,a4 as Bt,as as ia,i as oa,T as la,_ as da,b as va}from"./icons.js";import{E as ca}from"./EventInvitationAlert.js";import{g as ua}from"./event-stats-helpers.js";import{E as fa}from"./EventStats.js";import"./CheckboxBadge.js";import{B as ma}from"./BtnGroupCheck.js";import{U as ga}from"./UnsavedChangesGuard.js";import{C as Mt}from"./ConfirmModal.js";import"./keyboardNavigation.svelte.js";import"./products-display.js";import"./date-helpers.js";import"./index2.js";var _a=d('<label class="input w-56"><span class="label">Minimum</span> <input type="number" min="1" class="grow" id="min-contrib-input"/></label>'),ba=d('<button class="btn justify-start"><div class="flex items-center gap-4"><span class="label">minimum</span> <span class="text-lg"> </span> <!></div></button>'),pa=d('<div class="badge badge-primary badge-soft badge-lg gap-2 p-3"><!> <span class="font-medium"> </span></div>'),ha=d('<fieldset class="fieldset"><legend class="legend">√âquipes invit√©es</legend> <div class="flex flex-wrap gap-2"></div></fieldset>'),xa=d('<div class="badge badge-soft badge-success gap-2 p-3"><span class="font-medium"> </span></div>'),ya=d('<fieldset class="fieldset"><legend class="legend">Participant confirm√©</legend> <div class="flex flex-wrap gap-2"></div></fieldset>'),wa=d('<div class="badge badge-warning badge-soft gap-2 p-3"><span class="font-medium"> </span></div>'),ka=d('<fieldset class="fieldset"><legend class="text-base-content/70 text-sm font-medium">Invit√©¬∑es</legend> <div class="flex flex-wrap gap-2"></div></fieldset>'),Ea=d('<div class="my-2"><button class="btn btn-primary btn-outline btn-block gap-1"><!> Inviter des participant¬∑es</button></div>'),Ta=d('<fieldset class="fieldset mb-4"><!> <div class="fieldset-label ms-1">Combien faudrait-il √™tre pour tout g√©rer ?</div></fieldset> <div class="mb-6"><div class="space-y-4"><!> <!> <!></div></div> <!>',1),Ia=d('<p class="text-error mt-1 text-xs"> </p>'),Ca=d("<p> </p>"),Sa=d('<div class="badge badge-primary badge-soft badge-lg"><!> </div>'),Da=d('<div class="mb-4"><p class="mb-2 text-sm font-medium opacity-70">√âquipes d√©j√† invit√©es :</p> <div class="flex flex-wrap gap-2"></div></div>'),Ma=d('<label class="hover:bg-secondary/20 bg-secondary/10 flex cursor-pointer items-center gap-3 rounded-lg px-4 py-2 transition-colors"><input type="checkbox" class="checkbox bg-base-100 checkbox-sm"/> <div class="flex flex-col"><span class="text-sm font-medium"> <span class="text-xs opacity-60"> </span></span> <div class="text-xs opacity-70"> </div></div></label>'),Pa=d(`<label class="mt-4 cursor-pointer justify-center gap-4"><input type="checkbox" class="checkbox checkbox-sm"/> <span class="font-base ms-1">Envoyer un email de notification</span></label> <p class="text-base-content/60 mt-1 text-xs">Si d√©sactiv√©, les membres auront acc√®s √† l'√©v√©nement mais ne
                recevront pas d'email. Les personnes invit√©es n'ayant pas de
                compte recevront toujours un email pour la cr√©ation de leur
                compte.</p>`,1),Na=d('<div class="flex flex-wrap gap-4"></div> <!>',1),za=d('<p class="text-sm italic opacity-60">Toutes vos √©quipes sont d√©j√† invit√©es.</p>'),qa=d(`<p class="text-sm italic opacity-60">Vous ne faites partie d'aucune √©quipe. Cr√©ez une √©quipe pour inviter
            plusieurs personnes.</p>`),Oa=d(`<div class="space-y-6"><fieldset class="fieldset"><legend class="legend">Par email</legend> <div class="flex gap-2"><label class="input flex items-center gap-2"><!> <input type="email" class="grow" placeholder="email@exemple.com"/></label> <button class="btn btn-primary"><!> Ajouter</button></div> <!> <div></div></fieldset> <div class="divider">OU</div> <fieldset class="fieldset"><legend class="fieldset-legend"><!> Inviter des √©quipes
          enti√®res</legend> <!> <!></fieldset></div>`),Aa=d('<button class="btn">Annuler</button> <button class="btn btn-primary"><!> Inviter <!></button>',1),La=d("<!> <!> <!>",1),ja=d("<!> <!>",1);function Ba(Ze,r){_t(r,!0);let Ue=Ye(r,"minContrib",15);Ye(r,"userId",3,"");let m=Ye(r,"eventId",3,""),C=Ye(r,"onStartEdit",3,()=>{}),V=B(ft([])),M=B(ft([])),h=B(!1),Y=B(!1),T=B(!1);et(()=>{if(m()){const n=r.eventsStore.getEventById(m());if(n&&n.teams){const w=n.teams||[],z=[];for(const P of w){const ee=r.nativeTeamsStore.teams.find(q=>q.name===P);ee&&z.push(ee.$id)}s(V,z,!0)}}}),et(()=>{e(Y)||s(M,[],!0)});let H=B(""),y=B(null),se=D(()=>r.contributors.filter(n=>n.status==="accepted")),we=D(()=>r.contributors.filter(n=>n.status==="invited"));function ge(n){e(V).includes(n)?s(V,e(V).filter(w=>w!==n),!0):s(V,[...e(V),n],!0)}function ke(){if(!e(H))return;const n=e(H).trim();if(r.contributors.some(z=>z.email===n)||e(M).some(z=>z.email===n)){s(y,"Cet email est d√©j√† invit√©.");return}s(y,null);const w={id:pt(),email:n,status:"invited",invitedAt:new Date().toISOString()};s(M,[...e(M),w],!0),s(H,"")}async function ve(){if(!m()){ae.error("ID d'√©v√©nement manquant");return}const n=r.eventsStore.getEventById(m());if(!n)throw new Error("√âv√©nement introuvable");const w=e(V).filter(P=>{const ee=r.nativeTeamsStore.teams.find(q=>q.$id===P);return ee?!n.teams?.includes(ee.name):!1}),z=e(M).map(P=>P.email).filter(Boolean);if(w.length===0&&z.length===0){ae.warning("S√©lectionnez au moins une √©quipe ou entrez un email");return}try{await ae.track(r.eventsStore.inviteParticipants(m(),{teamIds:w,emails:z,sendEmailToExistingMembers:e(h)}),{loading:"Envoi des invitations en cours...",success:"invitation envoy√© avec succ√®s",error:"Erreur lors de l'envoi des invitations"}),s(Y,!1),s(M,[],!0)}catch(P){console.error("Erreur lors de l'envoi des invitations:",P)}}function _e(){s(Y,!1),s(H,""),s(y,null)}let J=D(()=>()=>{if(!m())return[];const n=r.eventsStore.getEventById(m());return n?e(V).filter(w=>{const z=r.nativeTeamsStore.teams.find(P=>P.$id===w);return z?!n.teams?.includes(z.name):!1}):[]});var ze=ja(),Te=de(ze);ut(Te,{legend:"Participants",children:(n,w)=>{var z=Ta(),P=de(z),ee=a(P);{var q=g=>{var f=_a(),b=i(a(f),2);b.defaultValue=1,t(f),E(()=>b.disabled=!r.canEdit),ot("focus",b,function(...A){C()?.apply(this,A)}),ot("blur",b,()=>s(T,!1)),st(b,Ue),o(g,f)},te=g=>{var f=ba();f.__click=()=>{s(T,!0),setTimeout(()=>{document.getElementById("min-contrib-input")?.focus()},50)};var b=a(f),A=i(a(b),2),R=a(A,!0);t(A);var L=i(A,2);ht(L,{class:"h-4 w-4"}),t(b),t(f),E(()=>{f.disabled=!r.canEdit,Q(R,Ue()||1)}),o(g,f)};_(ee,g=>{e(T)?g(q):g(te,!1)})}$(2),t(P);var Se=i(P,2),G=a(Se),ce=a(G);{var he=g=>{const f=D(()=>r.eventsStore.getEventById(m()));var b=Xe(),A=de(b);{var R=L=>{var K=ha(),fe=i(a(K),2);Je(fe,21,()=>e(f).teams,lt,(De,Ce)=>{var I=pa(),l=a(I);nt(l,{class:"inline size-4"});var c=i(l,2),p=a(c,!0);t(c),t(I),E(()=>Q(p,e(Ce))),o(De,I)}),t(fe),t(K),o(L,K)};_(A,L=>{e(f)&&e(f).teams&&e(f).teams.length>0&&L(R)})}o(g,b)};_(ce,g=>{m()&&g(he)})}var Ie=i(ce,2);{var ue=g=>{var f=ya(),b=i(a(f),2);Je(b,21,()=>e(se),A=>A.id,(A,R)=>{var L=xa(),K=a(L),fe=a(K,!0);t(K),t(L),E(()=>Q(fe,e(R).name||e(R).email)),o(A,L)}),t(b),t(f),o(g,f)};_(Ie,g=>{e(se).length>0&&g(ue)})}var oe=i(Ie,2);{var O=g=>{var f=ka(),b=i(a(f),2);Je(b,21,()=>e(we),A=>A.id,(A,R)=>{var L=wa(),K=a(L),fe=a(K,!0);t(K),t(L),E(()=>Q(fe,e(R).name||e(R).email)),o(A,L)}),t(b),t(f),o(g,f)};_(oe,g=>{e(we).length>0&&g(O)})}t(G),t(Se);var F=i(Se,2);{var W=g=>{var f=Ea(),b=a(f);b.__click=()=>s(Y,!0);var A=a(b);ta(A,{class:"mr-2 h-4 w-4"}),$(),t(b),t(f),o(g,f)};_(F,g=>{m()&&g(W)})}o(n,z)},$$slots:{default:!0}});var Ee=i(Te,2);Ot(Ee,{get isOpen(){return e(Y)},onClose:_e,children:(n,w)=>{var z=La(),P=de(z);At(P,{title:"Inviter des participants",onClose:_e});var ee=i(P,2);Lt(ee,{children:(te,Se)=>{var G=Oa(),ce=a(G),he=i(a(ce),2),Ie=a(he),ue=a(Ie);aa(ue,{class:"h-4 w-4 opacity-70"});var oe=i(ue,2);We(oe),oe.__keydown=I=>I.key==="Enter"&&ke(),t(Ie);var O=i(Ie,2);O.__click=ke;var F=a(O);mt(F,{class:"h-4 w-4 opacity-70"}),$(),t(O),t(he);var W=i(he,2);{var g=I=>{var l=Ia(),c=a(l,!0);t(l),E(()=>Q(c,e(y))),o(I,l)};_(W,I=>{e(y)&&I(g)})}var f=i(W,2);Je(f,21,()=>e(M),lt,(I,l)=>{var c=Ca(),p=a(c,!0);t(c),E(()=>Q(p,e(l).email)),o(I,c)}),t(f),t(ce);var b=i(ce,4),A=a(b),R=a(A);nt(R,{size:16,class:"inline shrink-0 opacity-60"}),$(),t(A);var L=i(A,2);{var K=I=>{const l=D(()=>r.eventsStore.getEventById(m()));var c=Xe(),p=de(c);{var j=S=>{var N=Da(),ne=i(a(N),2);Je(ne,21,()=>e(l).teams,lt,(qe,Be)=>{var Me=Sa(),Oe=a(Me);nt(Oe,{class:"inline size-4"});var be=i(Oe,1,!0);t(Me),E(()=>Q(be,e(Be))),o(qe,Me)}),t(ne),t(N),o(S,N)};_(p,S=>{e(l)&&e(l).teams&&e(l).teams.length>0&&S(j)})}o(I,c)};_(L,I=>{m()&&I(K)})}var fe=i(L,2);{var De=I=>{const l=D(()=>r.nativeTeamsStore.myTeams.filter(N=>{if(!m())return!0;const ne=r.eventsStore.getEventById(m());return!ne||!ne.teams?!0:!ne.teams.includes(N.name)}));var c=Xe(),p=de(c);{var j=N=>{var ne=Na(),qe=de(ne);Je(qe,21,()=>e(l),lt,(Oe,be)=>{var Pe=Ma(),je=a(Pe);We(je),je.__change=()=>ge(e(be).$id);var v=i(je,2),u=a(v),x=a(u),U=i(x),re=a(U);t(U),t(u);var Ae=i(u,2),Z=a(Ae,!0);t(Ae),t(v),t(Pe),E((X,xe)=>{Nt(je,X),Q(x,`${e(be).name??""} `),Q(re,`${e(be).total??""} membre${e(be).total>1?"s":""}`),Q(Z,xe)},[()=>e(V).includes(e(be).$id),()=>r.nativeTeamsStore.getTeamMemberNames(e(be).$id).join(", ")]),o(Oe,Pe)}),t(qe);var Be=i(qe,2);{var Me=Oe=>{var be=Pa(),Pe=de(be),je=a(Pe);We(je),$(2),t(Pe),$(2),Gt(je,()=>e(h),v=>s(h,v)),o(Oe,be)};_(Be,Oe=>{e(V).length>0&&Oe(Me)})}o(N,ne)},S=N=>{var ne=za();o(N,ne)};_(p,N=>{e(l).length>0?N(j):N(S,!1)})}o(I,c)},Ce=I=>{var l=qa();o(I,l)};_(fe,I=>{r.nativeTeamsStore.myTeams.length>0?I(De):I(Ce,!1)})}t(b),t(G),E(()=>O.disabled=!e(H)),st(oe,()=>e(H),I=>s(H,I)),o(te,G)}});var q=i(ee,2);jt(q,{children:(te,Se)=>{var G=Aa(),ce=de(G);ce.__click=_e;var he=i(ce,2);he.__click=ve;var Ie=a(he);xt(Ie,{class:"mr-2 h-4 w-4"});var ue=i(Ie,2);{var oe=O=>{var F=Pt();E(W=>Q(F,`(${W??""})`),[()=>e(J)().length+e(M).length]),o(O,F)};_(ue,O=>{(e(J)().length>0||e(M).length>0)&&O(oe)})}t(he),E(O=>he.disabled=O,[()=>e(M).length===0&&e(J)().length===0]),o(te,G)}}),o(n,z)},$$slots:{default:!0}}),o(Ze,ze),bt()}gt(["click","keydown","change"]);var Va=d('<div class="flex items-center gap-2"><!> <span> </span></div>'),Ua=d('<div class="flex items-center gap-2"><!> <span>A r√©aliser avant le :</span> <span class="font-medium"> </span></div>'),Fa=d("<div><div><span> </span></div></div>"),Ra=d('<div><div class="bg-base-300 text-base-content w-7 rounded-full"><span class="text-base"> </span></div></div>'),Ha=d('<span class="text-warning mx-1 text-base italic">Non assign√©</span>'),Ga=d('<p class="text-base-content/60 mt-1 line-clamp-2 text-sm"> </p>'),Wa=d("<button><!> Fait <!></button>"),Ja=d(`<button class="btn btn-primary btn-outline btn-sm gap-1" title="Me porter volontaire pour cette t√¢che"><!> <span>M'inscrire</span></button>`),Ka=d('<button class="btn btn-error btn-sm btn-outline gap-1" title="Quitter cette t√¢che"><!> <span>me d√©sinscrire</span></button>'),Qa=d('<div><div class="flex flex-col gap-3"><div class="flex min-w-0 items-start gap-3"><div class="flex min-w-0 grow flex-col gap-4"><div class="flex flex-wrap items-start justify-between gap-x-4 gap-y-2"><div> </div> <div><!> <!> <!></div></div>  <div class="flex items-center gap-2"><!> <div class="flex min-w-0 items-center gap-1"><div class="flex flex-wrap gap-2"><!> <!> <!></div> <span> </span></div></div> <!></div></div></div> <div class="mt-4 flex items-center justify-between gap-2"><div class="flex gap-2"><!></div> <div class="ms-auto flex gap-2"><!> <button class="btn btn-sm btn-square" title="Modifier la t√¢che"><!></button></div></div></div>');function Ya(Ze,r){_t(r,!0);let Ue=Ye(r,"disabled",3,!1),m=Ye(r,"contributors",19,()=>[]),C=B(!1);const V=D(()=>Array.isArray(r.todo.assignedTo)?r.todo.assignedTo:[]),M=D(()=>ie.userId&&e(V).includes(ie.userId)),h=D(()=>r.todo.assignedTo?r.todo.assignedTo.map(l=>{const c=m().find(S=>S.id===l),p=l===ie.userId,j=c?.name||(p?"Moi":l.substring(0,5));return{userId:l,name:j,isCurrentUser:p}}):[]),Y=D(()=>e(h).length>=(r.todo.requiredPeopleNb||1)),T=D(()=>{switch(r.todo.taskOn){case"beforeEvent":return{bg:"bg-accent/30",icon:na,label:"Avant l'√©v√©nement"};case"afterEvent":return{bg:"bg-secondary/10",icon:sa,label:"Apr√®s l'√©v√©nement"};default:return{bg:"bg-secondary/20",icon:yt,label:"Pendant l'√©v√©nement"}}});async function H(){if(e(C)||Ue())return;const c=r.todo.status==="done"?"todo":"done";s(C,!0);try{await Ke.updateTodo(r.eventId,r.todo.id,{status:c})}catch{ae.error("Erreur m√†j statut")}finally{s(C,!1)}}async function y(){if(!ie.userId||e(C))return;const l=e(M)?e(V).filter(c=>c!==ie.userId):[...e(V),ie.userId];s(C,!0);try{await Ke.updateTodo(r.eventId,r.todo.id,{assignedTo:l.length>0?l:null}),ae.success(e(M)?"Vous avez rejoint la t√¢che":"Vous avez quitt√© la t√¢che")}catch{ae.error("Erreur assignation")}finally{s(C,!1)}}var se=Qa();let we;var ge=a(se),ke=a(ge),ve=a(ke),_e=a(ve),J=a(_e),ze=a(J,!0);t(J);var Te=i(J,2),Ee=a(Te);{var n=l=>{};_(Ee,l=>{r.todo.priority&&r.todo.priority!=="low"&&l(n)})}var w=i(Ee,2);{var z=l=>{var c=Va(),p=a(c);Wt(p,()=>e(T).icon,(N,ne)=>{ne(N,{class:"size-4 shrink-0 opacity-70"})});var j=i(p,2),S=a(j,!0);t(j),t(c),E(()=>Q(S,e(T).label)),o(l,c)};_(w,l=>{r.todo.taskOn&&l(z)})}var P=i(w,2);{var ee=l=>{var c=Ua(),p=a(c);Et(p,{class:"size-4 shrink-0 opacity-70"});var j=i(p,4),S=a(j,!0);t(j),t(c),E(N=>Q(S,N),[()=>new Date(r.todo.dueDate).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})]),o(l,c)};_(P,l=>{r.todo.dueDate&&l(ee)})}t(Te),t(_e);var q=i(_e,2),te=a(q);nt(te,{class:"mt-1 mb-auto size-4 shrink-0 opacity-60"});var Se=i(te,2),G=a(Se),ce=a(G);Je(ce,19,()=>e(h).slice(0,3),l=>l.userId,(l,c)=>{var p=Fa(),j=a(p),S=a(j),N=a(S,!0);t(S),t(j),t(p),E(()=>{wt(p,"title",e(c).name+(e(c).isCurrentUser?" (vous)":"")),at(j,1,`badge badge-soft badge-info ${(e(c).isCurrentUser&&"ring-info font-semibold ring-1")??""}`),Q(N,e(c).name)}),o(l,p)});var he=i(ce,2);{var Ie=l=>{var c=Ra(),p=a(c),j=a(p),S=a(j);t(j),t(p),t(c),E(()=>{wt(c,"title",`+${e(h).length-3} autres`),Q(S,`+${e(h).length-3}`)}),o(l,c)};_(he,l=>{e(h).length>3&&l(Ie)})}var ue=i(he,2);{var oe=l=>{var c=Ha();o(l,c)};_(ue,l=>{e(h).length===0&&l(oe)})}t(G);var O=i(G,2),F=a(O);t(O),t(Se),t(q);var W=i(q,2);{var g=l=>{var c=Ga(),p=a(c,!0);t(c),E(()=>Q(p,r.todo.taskDescription)),o(l,c)};_(W,l=>{r.todo.taskDescription&&l(g)})}t(ve),t(ke),t(ge);var f=i(ge,2),b=a(f),A=a(b);{var R=l=>{var c=Wa();c.__click=H;var p=a(c);{let N=D(()=>r.todo.status!=="done"&&"opacity-60");xt(p,{get class(){return`size-4 ${e(N)??""}`}})}var j=i(p,2);{var S=N=>{var ne=Pt("?");o(N,ne)};_(j,N=>{r.todo.status!=="done"&&N(S)})}t(c),E(()=>{at(c,1,`btn btn-sm ${r.todo.status!=="done"?"btn-dash":"btn-success"}`),wt(c,"title",r.todo.status==="done"?"Marquer √† faire":"Marquer fait"),c.disabled=Ue()}),o(l,c)};_(A,l=>{r.todo.taskOn==="beforeEvent"&&l(R)})}t(b);var L=i(b,2),K=a(L);{var fe=l=>{var c=Ja();c.__click=y;var p=a(c);xt(p,{class:"size-4"}),$(2),t(c),o(l,c)},De=l=>{var c=Xe(),p=de(c);{var j=S=>{var N=Ka();N.__click=y;var ne=a(N);ra(ne,{class:"size-4"}),$(2),t(N),o(S,N)};_(p,S=>{e(M)&&S(j)},!0)}o(l,c)};_(K,l=>{e(M)?l(De,!1):l(fe)})}var Ce=i(K,2);Ce.__click=()=>r.onEdit(r.todo);var I=a(Ce);ht(I,{class:"size-4"}),t(Ce),t(L),t(f),t(se),E(()=>{we=at(se,1,`group bg-base-200/50 relative rounded-xl p-4 shadow transition-all ${e(Y)?"shadow-success/40 ":"shadow-warning/40 "}`,null,we,{"opacity-50":e(C)}),at(J,1,`text-base font-medium ${r.todo.status==="done"?"line-through opacity-50":""}`),Q(ze,r.todo.taskName),at(Te,1,`card card-sm ${e(T).bg??""} ms-auto flex flex-col justify-end px-4 py-1`),at(O,1,`mx-1 ${e(h).length<(r.todo.requiredPeopleNb||1)?"text-warning":"text-success"} font-medium`),Q(F,`${e(h).length??""}/${(r.todo.requiredPeopleNb||1)??""} pers. requise`)}),o(Ze,se),bt()}gt(["click"]);var Xa=d('<div role="tablist" class="tabs tabs-border tabs-lg mb-4"><button role="tab"><!> T√¢che individuelle</button> <button role="tab"><!> T√¢ches pr√©d√©finies</button></div>'),Za=d('<span class="badge badge-warning badge-sm"> </span>'),$a=d('<span class="badge badge-success badge-sm flex items-center gap-1"><!> ok</span>'),es=d(`<div class="space-y-4"><fieldset class="fieldset"><legend class="fieldset-legend">Titre</legend> <label class="input w-full"><input type="text" placeholder="Ex: Acheter du pain, Pr√©parer la salle..." class="grow"/></label></fieldset> <fieldset class="fieldset"><legend class="fieldset-legend flex items-center gap-2"><!> Description</legend> <textarea class="textarea h-24 w-full" placeholder="D√©tails suppl√©mentaires..."></textarea></fieldset> <div class="flex flex-wrap gap-4"><fieldset class="fieldset w-80"><legend class="fieldset-legend flex items-center gap-2"><!> Moment</legend> <select class="select w-full"><option>Avant l'√©v√©nement</option><option>Pendant l'√©v√©nement</option><option>Apr√®s l'√©v√©nement</option></select></fieldset> <fieldset class="fieldset w-80"><legend class="fieldset-legend flex items-center gap-2"><!> √âch√©ance</legend> <label class="input w-full"><input type="date" class="grow"/></label></fieldset> <fieldset class="fieldset"><legend class="fieldset-legend flex items-center gap-2"><!> Personnes requises</legend> <label class="input w-full"><input type="number" min="1" class="grow"/></label></fieldset></div> <fieldset class="fieldset"><legend class="fieldset-legend flex items-center gap-2"><!> <!></legend> <!></fieldset></div>`),ts=d('<div class="bg-base-100 flex items-center gap-4 rounded-lg p-3"><input type="checkbox" class="checkbox checkbox-primary"/> <input type="text" class="input flex-1"/> <div class="flex items-center gap-2"><!> <input type="number" class="input w-20" min="1"/></div></div>'),as=d('<div class="collapse-arrow bg-base-200 collapse"><input type="checkbox" checked/> <div class="collapse-title flex items-center gap-2 text-base font-medium"><!> </div> <div class="collapse-content"><div class="mt-4 space-y-3"></div></div></div>'),ss=d('<div class="space-y-6"></div>'),ns=d("<!> <!>",1),rs=d('<span class="loading loading-spinner loading-sm"></span>'),is=d('<button type="button" class="btn btn-primary"><!> Cr√©er les t√¢ches s√©lectionn√©es</button>'),os=d('<button type="button" class="btn btn-ghost"><!> Sauvegarder & Cr√©er</button>'),ls=d('<span class="loading loading-spinner loading-sm"></span>'),ds=d('<!> <button type="button" class="btn btn-primary"><!> </button>',1),vs=d("<!> <!> <!>",1);function cs(Ze,r){_t(r,!0);let Ue=Ye(r,"contributors",19,()=>[]);Ye(r,"currentTodos",19,()=>[]);let m=B(""),C=B(""),V=B("medium"),M=B("onEvent"),h=B(1),Y=B(""),T=B(ft([])),H=B(!1),y=B("individual");const se={beforeEvent:["Gestion de l'approvisionnement / courses","Choix des recettes/menus","Coordination","Communication (mail, texto, affiches)","Gestion matos"],onEvent:["Pr√©parations des recettes","Service","Rangement","Vaisselle","Gestion des restes"],afterEvent:["Retour matos","D√©montage cuisine"]},we=D(()=>r.todoToEdit?{taskName:r.todoToEdit.taskName,taskDescription:r.todoToEdit.taskDescription||"",priority:r.todoToEdit.priority||"medium",taskOn:r.todoToEdit.taskOn||"onEvent",requiredPeopleNb:r.todoToEdit.requiredPeopleNb||1,dueDate:r.todoToEdit.dueDate?r.todoToEdit.dueDate.split("T")[0]:"",assignedTo:r.todoToEdit.assignedTo?[...r.todoToEdit.assignedTo]:[]}:{taskName:"",taskDescription:"",priority:"medium",taskOn:"onEvent",requiredPeopleNb:1,dueDate:"",assignedTo:[]});et(()=>{if(r.open){r.todoToEdit?s(y,"individual"):s(y,"individual");const n=e(we);s(m,n.taskName,!0),s(C,n.taskDescription,!0),s(V,n.priority,!0),s(M,n.taskOn,!0),s(h,n.requiredPeopleNb,!0),s(Y,n.dueDate,!0),s(T,n.assignedTo,!0)}});function ge(){s(m,""),s(C,""),s(V,"medium"),s(M,"onEvent"),s(h,1),s(Y,""),s(T,[],!0)}async function ke(n=!1){if(!e(m).trim()){ae.warning("Le titre de la t√¢che est requis");return}s(H,!0);try{const w=new Date().toISOString();if(r.todoToEdit){const z={taskName:e(m),taskDescription:e(C)||null,priority:e(V),taskOn:e(M),requiredPeopleNb:e(h),dueDate:e(Y)?new Date(e(Y)).toISOString():null,assignedTo:e(T).length>0?e(T):null};await Ke.updateTodo(r.eventId,r.todoToEdit.id,z),ae.success("T√¢che mise √† jour"),ve()}else{const z={id:pt(10),taskName:e(m),taskDescription:e(C)||null,priority:e(V),taskOn:e(M),requiredPeopleNb:e(h),dueDate:e(Y)?new Date(e(Y)).toISOString():null,assignedTo:e(T).length>0?e(T):null,status:"todo"};await Ke.addTodo(r.eventId,z),ae.success("T√¢che cr√©√©e"),n?ge():ve()}}catch(w){ae.error("Erreur lors de la sauvegarde"),console.error(w)}finally{s(H,!1)}}function ve(){ge(),r.onClose()}function _e(n){e(T).includes(n)?s(T,e(T).filter(w=>w!==n),!0):s(T,[...e(T),n],!0)}let J=B(ft([]));et(()=>{r.open&&e(y)==="bulk"&&s(J,[...se.beforeEvent.map(n=>({taskName:n,taskOn:"beforeEvent",enabled:!0,requiredPeopleNb:1})),...se.onEvent.map(n=>({taskName:n,taskOn:"onEvent",enabled:!0,requiredPeopleNb:1})),...se.afterEvent.map(n=>({taskName:n,taskOn:"afterEvent",enabled:!1,requiredPeopleNb:1}))],!0)});async function ze(){const n=e(J).filter(w=>w.enabled);if(n.length===0){ae.warning("S√©lectionnez au moins une t√¢che");return}s(H,!0);try{const w=new Date().toISOString(),z=n.map(P=>({id:pt(10),taskName:P.taskName,taskDescription:null,priority:"medium",taskOn:P.taskOn,requiredPeopleNb:P.requiredPeopleNb,dueDate:null,assignedTo:null,status:"todo"}));await Ke.addTodos(r.eventId,z),ae.success(`${z.length} t√¢che(s) cr√©√©e(s)`),ve()}catch(w){ae.error("Erreur lors de la cr√©ation"),console.error(w)}finally{s(H,!1)}}function Te(n){e(J)[n].enabled=!e(J)[n].enabled}const Ee=D(()=>{const n=[{id:ie.userId||"",label:"Moi",selected:e(T).includes(ie.userId||"")}];return Ue().forEach(w=>{w.id!==ie.userId&&n.push({id:w.id,label:w.name||w.email||w.id.substring(0,5),selected:e(T).includes(w.id)})}),n});Ot(Ze,{get isOpen(){return r.open},onClose:ve,maxWidth:"lg",maxHeight:"xl",children:(n,w)=>{var z=vs(),P=de(z);{let te=D(()=>r.todoToEdit?"Modifier la T√¢che":"Nouvelle T√¢che");At(P,{get title(){return e(te)},onClose:ve})}var ee=i(P,2);Lt(ee,{children:(te,Se)=>{var G=ns(),ce=de(G);{var he=O=>{var F=Xa(),W=a(F);W.__click=()=>s(y,"individual");var g=a(W);St(g,{class:"me-2 size-4"}),$(),t(W);var f=i(W,2);f.__click=()=>s(y,"bulk");var b=a(f);Dt(b,{class:"me-2 size-4"}),$(),t(f),t(F),E(()=>{at(W,1,`tab ${e(y)==="individual"?"tab-active":""}`),at(f,1,`tab ${e(y)==="bulk"?"tab-active":""}`)}),o(O,F)};_(ce,O=>{r.todoToEdit||O(he)})}var Ie=i(ce,2);{var ue=O=>{var F=es(),W=a(F),g=i(a(W),2),f=a(g);We(f),t(g),t(W);var b=i(W,2),A=a(b),R=a(A);St(R,{class:"size-4 opacity-50"}),$(),t(A);var L=i(A,2);zt(L),t(b);var K=i(b,2),fe=a(K),De=a(fe),Ce=a(De);yt(Ce,{class:"size-4 opacity-50"}),$(),t(De);var I=i(De,2),l=a(I);l.value=l.__value="beforeEvent";var c=i(l);c.value=c.__value="onEvent";var p=i(c);p.value=p.__value="afterEvent",t(I),t(fe);var j=i(fe,2),S=a(j),N=a(S);Et(N,{class:"size-4 opacity-50"}),$(),t(S);var ne=i(S,2),qe=a(ne);We(qe),t(ne),t(j);var Be=i(j,2),Me=a(Be),Oe=a(Me);nt(Oe,{class:"size-4 opacity-50"}),$(),t(Me);var be=i(Me,2),Pe=a(be);We(Pe),t(be),t(Be),t(K);var je=i(K,2),v=a(je),u=a(v);nt(u,{class:"size-4 opacity-50"});var x=i(u),U=i(x);{var re=X=>{var xe=Za(),Fe=a(xe);t(xe),E(()=>Q(Fe,`Manque ${e(h)-e(T).length} pers.`)),o(X,xe)},Ae=X=>{var xe=$a(),Fe=a(xe);xt(Fe,{class:"size-3"}),$(),t(xe),o(X,xe)};_(U,X=>{e(T).length<e(h)?X(re):X(Ae,!1)})}t(v);var Z=i(v,2);ma(Z,{get items(){return e(Ee)},size:"lg",color:"primary",onToggleItem:_e}),t(je),t(F),E(()=>Q(x,` Assignation (${e(T).length??""}/${e(h)??""}) `)),st(f,()=>e(m),X=>s(m,X)),st(L,()=>e(C),X=>s(C,X)),Jt(I,()=>e(M),X=>s(M,X)),st(qe,()=>e(Y),X=>s(Y,X)),st(Pe,()=>e(h),X=>s(h,X)),o(O,F)},oe=O=>{var F=ss();Je(F,20,()=>["beforeEvent","onEvent","afterEvent"],lt,(W,g)=>{const f=D(()=>g==="beforeEvent"?"Avant l'√©v√©nement":g==="onEvent"?"Pendant l'√©v√©nement":"Apr√®s l'√©v√©nement"),b=D(()=>e(J).filter(K=>K.taskOn===g));var A=Xe(),R=de(A);{var L=K=>{var fe=as(),De=a(fe);We(De);var Ce=i(De,2),I=a(Ce);yt(I,{class:"size-4 opacity-50"});var l=i(I);t(Ce);var c=i(Ce,2),p=a(c);Je(p,21,()=>e(b),lt,(j,S,N)=>{const ne=D(()=>e(J).indexOf(e(S)));var qe=ts(),Be=a(qe);We(Be),Be.__change=()=>Te(e(ne));var Me=i(Be,2);We(Me);var Oe=i(Me,2),be=a(Oe);nt(be,{class:"size-4 opacity-50"});var Pe=i(be,2);We(Pe),t(Oe),t(qe),E(()=>{Nt(Be,e(S).enabled),qt(Me,e(S).taskName),Me.disabled=!e(S).enabled,Pe.disabled=!e(S).enabled}),st(Pe,()=>e(S).requiredPeopleNb,je=>e(S).requiredPeopleNb=je),o(j,qe)}),t(p),t(c),t(fe),E(j=>Q(l,` ${e(f)??""} (${j??""}/${e(b).length??""})`),[()=>e(b).filter(j=>j.enabled).length]),o(K,fe)};_(R,K=>{e(b).length>0&&K(L)})}o(W,A)}),t(F),o(O,F)};_(Ie,O=>{r.todoToEdit||e(y)==="individual"?O(ue):O(oe,!1)})}o(te,G)}});var q=i(ee,2);jt(q,{children:(te,Se)=>{var G=Xe(),ce=de(G);{var he=ue=>{var oe=is();oe.__click=ze;var O=a(oe);{var F=g=>{var f=rs();o(g,f)},W=g=>{Dt(g,{class:"size-4"})};_(O,g=>{e(H)?g(F):g(W,!1)})}$(),t(oe),E(()=>oe.disabled=e(H)),o(ue,oe)},Ie=ue=>{var oe=ds(),O=de(oe);{var F=R=>{var L=os();L.__click=()=>ke(!0);var K=a(L);mt(K,{class:"size-4"}),$(),t(L),E(()=>L.disabled=e(H)),o(R,L)};_(O,R=>{r.todoToEdit||R(F)})}var W=i(O,2);W.__click=()=>ke(!1);var g=a(W);{var f=R=>{var L=ls();o(R,L)},b=R=>{Bt(R,{class:"size-4"})};_(g,R=>{e(H)?R(f):R(b,!1)})}var A=i(g);t(W),E(()=>{W.disabled=e(H),Q(A,` ${r.todoToEdit?"Mettre √† jour":"Cr√©er la t√¢che"}`)}),o(ue,oe)};_(ce,ue=>{e(y)==="bulk"?ue(he):ue(Ie,!1)})}o(te,G)}}),o(n,z)},$$slots:{default:!0}}),bt()}gt(["click","change"]);var us=d('<div class="text-base-content/50 border-base-200 hover:border-primary/50 cursor-pointer rounded-lg border-2 border-dashed py-8 text-center text-sm italic transition-colors" role="button" tabindex="0">Aucune t√¢che pour le moment. <br/> <span class="text-primary mt-1 inline-block font-medium">Cr√©er la premi√®re t√¢che +</span></div>'),fs=d('<div class="mb-4 flex items-center justify-between"><div class="flex items-center gap-2 text-sm opacity-60"><!> <span> </span></div> <button class="btn btn-sm btn-primary gap-2"><!> Nouvelle t√¢che</button></div> <div class=" space-y-4"><!></div> <!>',1);function ms(Ze,r){_t(r,!0);let Ue=Ye(r,"contributors",19,()=>[]),m=Ye(r,"disabled",3,!1);const C=D(()=>r.event.todos??[]);function V(se){return{beforeEvent:1,onEvent:2,afterEvent:3}[se]??0}const M=D(()=>[...e(C)].sort((we,ge)=>{const ke=V(we.taskOn??""),ve=V(ge.taskOn??""),_e=ke-ve;if(_e!==0)return _e;const J=we.dueDate?new Date(we.dueDate).getTime():1/0,ze=ge.dueDate?new Date(ge.dueDate).getTime():1/0;return J-ze}));let h=B(!1),Y=B(null);function T(){s(Y,null),s(h,!0)}function H(se){s(Y,se,!0),s(h,!0)}function y(se){r.onTodosChange?.(se)}ut(Ze,{legend:"T√¢ches & Organisation",legendSize:"text-lg",children:(se,we)=>{var ge=fs(),ke=de(ge),ve=a(ke),_e=a(ve);ia(_e,{class:"size-4"});var J=i(_e,2),ze=a(J);t(J),t(ve);var Te=i(ve,2);Te.__click=T;var Ee=a(Te);mt(Ee,{class:"size-4"}),$(),t(Te),t(ke);var n=i(ke,2),w=a(n);{var z=q=>{var te=us();te.__click=T,te.__keydown=Se=>Se.key==="Enter"&&T(),o(q,te)},P=q=>{var te=Xe(),Se=de(te);Je(Se,17,()=>e(M),G=>G.id,(G,ce)=>{Ya(G,{get todo(){return e(ce)},get eventId(){return r.event.$id},onEdit:H,get disabled(){return m()},get contributors(){return Ue()}})}),o(q,te)};_(w,q=>{e(M).length===0?q(z):q(P,!1)})}t(n);var ee=i(n,2);cs(ee,{get open(){return e(h)},get eventId(){return r.event.$id},get todoToEdit(){return e(Y)},get contributors(){return Ue()},get currentTodos(){return e(C)},onClose:()=>s(h,!1),onSave:y}),E(()=>Q(ze,`${e(C).length??""} t√¢ches`)),o(se,ge)},$$slots:{default:!0}}),bt()}gt(["click","keydown"]);var gs=d('<span class="loading loading-spinner loading-xs text-primary"></span>'),_s=d('<div class="flex items-center gap-2"><button class="btn btn-accent btn-sm"><!> <span class="font-bold">Enregistrer</span></button></div>'),bs=d(`<input type="text" class="input input-lg min-w-full shadow-md" placeholder="Nom de l'√©v√©nement"/>`),ps=d('<button class="btn btn-ghost"><div class="flex items-baseline gap-4"><h1> </h1> <!></div></button>'),hs=d(`<textarea class="textarea w-full" placeholder="D√©crivez l'√©v√©nement..." maxlength="3000" rows="9"></textarea> <p class="label"> </p>`,1),xs=d('<p class="whitespace-pre-wrap"> </p>'),ys=d('<p class="text-base-content/40 italic">Ajoutez une description...</p>'),ws=d('<button class="btn btn-ghost bg-base-100 h-auto justify-start py-4 text-left font-normal"><div class="flex w-full items-start justify-between gap-4"><div class="flex-1"><!></div> <!></div></button>'),ks=d('<div class="badge badge-lg badge-success gap-1"><!> Confirm√©</div>'),Es=d('<div class="badge badge-lg badge-info gap-1"><!> Proposition</div>'),Ts=d('<div class="badge badge-lg badge-warning gap-1"><!> </div>'),Is=d(`<button class="btn btn-success btn-link btn-md">Confirmez l'√©v√©nement</button>`),Cs=d(`<button class="btn btn-link btn-error btn-sm">Annuler l'√©v√©nement</button>`),Ss=d('<button class="btn btn-link btn-sm">R√©activer</button>'),Ds=d('<div class="flex flex-wrap items-center justify-between gap-2"><div class="flex items-center gap-2"><!></div> <!></div>'),Ms=d('<div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:col-span-2 lg:grid-cols-3"><div class="col-span-2"><!></div> <div class="flex flex-col justify-start gap-4"><!></div></div>'),Ps=d(`<div class="flex items-center justify-center py-20"><div class="flex flex-col items-center gap-4"><span class="loading loading-spinner loading-lg text-primary"></span> <p class="text-base-content/60">Chargement de l'√©v√©nement...</p></div></div>`),Ns=d(`<div class="alert alert-info"><!> <div><h4 class="font-bold">Mode D√©monstration</h4> <p class="text-sm">Dans un v√©ritable √©v√©nement, vous pourrez inviter des √©quipes
                  et des participants √† collaborer sur la planification.</p></div></div>`),zs=d(`<div class="alert alert-warning max-md:alert-vertical"><!> <div><h3 class="font-bold">√âv√©nement en cours de modification</h3> <div class="text-xs">Un autre utilisateur est en train de modifier cet √©v√©nement. Les
                contr√¥les sont temporairement d√©sactiv√©s.</div></div></div>`),qs=d('<div class="text-base-content/60 bg-base-200 rounded-box border-base-200 flex flex-col items-center justify-center border-2 border-dashed py-12"><div class="bg-base-200 mb-4 rounded-full p-4"><!></div> <p class="font-medium">Aucun repas planifi√©</p> <p class="mt-1 text-sm">Commencez par ajouter un repas √† votre √©v√©nement</p></div>'),Os=d("<div><!></div>"),As=d('<div class="space-y-4"></div>'),Ls=d('<div class="grid grid-cols-1 gap-6 pb-20 lg:grid-cols-3"><div class="space-y-6 lg:col-span-1"><!> <!></div> <div class="space-y-6 md:px-4 lg:col-span-2"><!> <div class="mb-6 flex items-center justify-between"><h3 class="card-title text-lg"> </h3> <button class="btn btn-primary"><!> Ajouter un repas</button></div> <!> <div class="flex"><button class="btn btn-outline btn-primary btn-block mt-4"><!> Ajouter un repas</button></div></div></div>'),js=d('<div class="bg-base-200 min-h-lvh space-y-6 px-2 pt-4 pb-20 md:px-20"><div class="flex flex-wrap items-center justify-between gap-x-6 gap-y-3"><div class="min-w-80 flex-1 gap-2"><!></div> <!></div> <!> <!> <!></div> <!> <!> <!>',1);function tn(Ze,r){_t(r,!0);const Ue=v=>{var u=_s(),x=a(u);x.__click=O;var U=a(x);{var re=Z=>{var X=gs();o(Z,X)},Ae=Z=>{Bt(Z,{size:18,class:"mr-1"})};_(U,Z=>{e(y)?Z(re):Z(Ae,!1)})}$(2),t(x),t(u),E(()=>x.disabled=e(y)||!e(Te)||!e(q)),o(v,u)};let m=D(()=>Xt.params.id),C=B(ft([])),V=B(""),M=B(""),h=B("proposition"),Y=B(1);const T=D(()=>[...e(C)].sort((v,u)=>new Date(v.date).getTime()-new Date(u.date).getTime()));let H=B(!1),y=B(!1),se=B(!1),we=B(null),ge=B(!1),ke=B(!1),ve=B(!1),_e=B(!1),J=B(null),ze=null;const Te=D(()=>{if(!e(ee)||!e(n))return!1;const v=JSON.stringify({name:e(n).name,meals:e(n).meals||[],description:e(n).description||"",status:e(n).status||"proposition",minContrib:e(n).minContrib||1}),u=JSON.stringify({name:e(V),meals:e(C),description:e(M),status:e(h),minContrib:e(Y)});return v!==u});async function Ee(){return console.log("startEditing"),e(ee)?!0:e(P)?(ae.warning(`Cet √©v√©nement est verrouill√© par ${e(te)}`),!1):await Se()}const n=D(()=>Ke.getEventById(e(m))),w=D(()=>ua(e(n))),z=D(()=>e(n)?.teamsId??[]),P=D(()=>e(J)?e(J).userId!==ie.userId:!1),ee=D(()=>e(n)?.status==="local"?!0:e(J)?e(J).userId===ie.userId:!1),q=D(()=>Ke.canUserEditEvent(e(m),ie.userId||"")&&!e(P)&&!e(y)),te=D(()=>e(J)?.userName||"un autre utilisateur");et(()=>{e(n)&&e(H)&&!e(ee)&&kt(()=>{s(C,Tt(e(n).meals||[]),!0),s(V,e(n).name||"",!0),s(M,e(n).description||"",!0),s(h,e(n).status||"proposition",!0),s(Y,e(n).minContrib||1,!0),console.log("üîÑ Shadow draft synchronis√© depuis currentEvent (Preview)")})}),et(()=>{e(n)&&e(H)&&e(n).status==="local"&&e(V)===""&&e(n).name&&kt(()=>{s(C,Tt(e(n).meals||[]),!0),s(V,e(n).name||"",!0),s(M,e(n).description||"",!0),s(h,e(n).status||"local",!0),s(Y,e(n).minContrib||1,!0),console.log("[EventEditPage] Shadow draft synchronis√© (mode local)")})}),et(()=>{Ct.setConfig({actions:Ue,isLockedByOthers:e(P),lockedByUserName:e(te),hasUnsavedChanges:e(Te)&&!e(P)})}),et(()=>{!e(H)&&!e(y)&&kt(async()=>{s(y,!0);try{if(await Kt(),!e(m)){console.error("[EventEditPage] Event ID manquant"),s(y,!1);return}if(!await Qt(e(m))){console.error("[EventEditPage] Event non trouv√© apr√®s attente"),s(y,!1);return}if(Ke.getEventById(e(m))?.status==="local"){console.log("[EventEditPage] Mode local: skip lock initialization"),s(H,!0);return}s(J,await ct.getLock(e(m)),!0),ze=ct.subscribeToLock(e(m),x=>{console.log("[EventEditPage] üîí Verrou mis √† jour (Realtime):",{lockedBy:x?.userName,userId:x?.userId,expiresAt:x?.expiresAt}),s(J,x,!0)}),s(H,!0)}finally{s(y,!1)}})}),Yt(()=>{F&&(clearTimeout(F),F=null),ze&&(ze(),ze=null),e(m)&&e(ee)&&(console.log("üö™ D√©montage du composant, lib√©ration du lock..."),G()),Ct.reset()});async function Se(){if(e(n)?.status==="local")return console.log("[EventEditPage] Mode local: skip lock acquisition"),!0;if(!e(m)||!ie.userId||e(y)||e(se))return!1;s(se,!0);try{return await ct.acquireLock(e(m),ie.userId,ie.userName)?(W(),!0):(ae.warning(`Cet √©v√©nement est en cours de modification par ${e(te)}`),!1)}catch(v){return console.error("‚ùå Erreur acquisition verrou:",v),ae.error("Impossible de verrouiller l'√©v√©nement"),!1}finally{s(se,!1)}}async function G(){if(e(n)?.status==="local"){console.log("[EventEditPage] Mode local: skip lock release");return}if(!(!e(m)||!ie.userId))try{await ct.releaseLock(e(m),ie.userId),console.log("üîì Verrou lib√©r√©")}catch(v){console.error("‚ùå Erreur lib√©ration verrou:",v)}}async function ce(){e(ee)&&await G()}async function he(){const v=await ue();return v&&await G(),v}function Ie(){if(!e(V).trim())return{isValid:!1,errorMessage:"Veuillez renseigner le nom de l'√©v√©nement"};if(e(C).length===0)return{isValid:!1,errorMessage:"Veuillez ajouter au moins un repas"};const u=e(C).map(x=>x.date).filter((x,U,re)=>re.indexOf(x)!==U);return u.length>0?{isValid:!1,errorMessage:`Certaines dates sont en double: ${u.map(U=>{try{return new Date(U).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return U}}).join(", ")}`}:{isValid:!0}}async function ue(){const v=Ie();if(!v.isValid)return ae.error(v.errorMessage||"Erreur de validation"),!1;e(w);const u=Array.from(new Set(e(T).map(Z=>Z.date))).sort(),x=e(n)?.teams||[],U=e(n)?.teamsId||[],re=new Map(U.map((Z,X)=>[Z,x[X]]));e(z).map(Z=>It.getTeamById(Z)?.name||re.get(Z)||Z);const Ae={name:e(V),description:e(M),status:e(h),minContrib:e(Y),allDates:u,dateStart:u.length>0?u[0]:"",dateEnd:u.length>0?u[u.length-1]:"",meals:e(T)};try{return await Ke.updateEvent(e(m),Ae),!0}catch(Z){return console.error("Erreur sauvegarde:",Z),ae.error("Erreur lors de la sauvegarde"),!1}}async function oe(){if(!e(m)||e(y)||!e(ee))return;s(y,!0);const v=ae.loading("Sauvegarde automatique...");if(await ue())await G(),ae.update(v,{state:"success",message:"Modifications sauvegard√©es automatiquement"});else{if(e(m)&&ie.userId)try{await ct.acquireLock(e(m),ie.userId,ie.userName)}catch(x){console.error("Erreur heartbeat lock:",x)}ae.update(v,{state:"warning",message:"Impossible de sauvegarder : modifications invalides"})}s(y,!1),setTimeout(()=>ae.dismiss(v),3e3)}async function O(){s(y,!0),await ue()&&(await G(),ae.success("√âv√©nement mis √† jour")),s(y,!1)}let F=null;function W(){F&&clearTimeout(F),F=setTimeout(()=>{oe()},120*1e3),console.log("‚è∞ Auto-save programm√© dans 30 secondes")}et(()=>{const v=e(ee),u=e(Te),x=U=>{(v||u)&&(U.preventDefault(),U.returnValue="Vous avez des modifications non sauvegard√©es. Voulez-vous vraiment quitter ?")};return window.addEventListener("beforeunload",x),()=>{window.removeEventListener("beforeunload",x)}});async function g(v){await Ee()&&s(V,v.target.value,!0)}async function f(){if(!await Ee())return;const v=pt(6);let u;if(e(T).length===0){const U=new Date;U.setDate(U.getDate()+7),U.setHours(20,0,0,0),u=U.toISOString()}else{const U=e(T)[e(T).length-1],re=new Date(U.date);re.getHours()<14?re.setHours(20,0,0,0):(re.setDate(re.getDate()+1),re.setHours(12,0,0,0)),u=re.toISOString()}const x={id:v,date:u,guests:100,recipes:[]};s(C,[...e(C),x],!0),s(we,v,!0)}function b(v){s(C,e(C).filter(u=>u.id!==v),!0)}function A(v){s(we,e(we)===v?null:v,!0)}async function R(v){if(!(!e(m)||!ie.userId))try{s(y,!0);const u=v?"accepted":"declined";await Ke.updateContributorStatus(e(m),ie.userId,u),ae.success(v?"Invitation accept√©e":"Invitation d√©clin√©e")}catch(u){console.error("Erreur r√©ponse invitation:",u),ae.error("Erreur lors de la r√©ponse")}finally{s(y,!1)}}async function L(){await Ee()&&(s(h,"confirmed"),s(ve,!1))}async function K(){await Ee()&&(s(h,"canceled"),s(_e,!1))}var fe=js(),De=de(fe),Ce=a(De),I=a(Ce),l=a(I);{var c=v=>{var u=bs();We(u),u.__input=g,E(()=>{qt(u,e(V)),u.disabled=!e(q)}),ot("focus",u,Ee),ot("blur",u,()=>s(ge,!1)),o(v,u)},p=v=>{var u=ps();u.__click=()=>s(ge,!e(ge));var x=a(u),U=a(x),re=a(U,!0);t(U);var Ae=i(U,2);ht(Ae,{class:"h-4 w-4"}),t(x),t(u),E(()=>{u.disabled=!e(q),Q(re,e(V)||"Nom de l'√©v√©nement")}),o(v,u)};_(l,v=>{e(ge)?v(c):v(p,!1)})}t(I);var j=i(I,2);{var S=v=>{fa(v,{get currentEvent(){return e(n)}})};_(j,v=>{e(n)&&v(S)})}t(Ce);var N=i(Ce,2);{var ne=v=>{var u=Ms(),x=a(u),U=a(x);ut(U,{legend:"Description",children:(Z,X)=>{var xe=Xe(),Fe=de(xe);{var dt=Re=>{var He=hs(),Ne=de(He);zt(Ne);var Qe=i(Ne,2),pe=a(Qe);t(Qe),E(()=>{Ne.disabled=!e(q),Q(pe,`${e(M).length??""}/3000 caract√®res`)}),ot("focus",Ne,Ee),ot("blur",Ne,()=>s(ke,!1)),st(Ne,()=>e(M),ye=>s(M,ye)),o(Re,He)},rt=Re=>{var He=ws();He.__click=()=>s(ke,!0);var Ne=a(He),Qe=a(Ne),pe=a(Qe);{var ye=Le=>{var me=xs(),k=a(me,!0);t(me),E(()=>Q(k,e(M))),o(Le,me)},$e=Le=>{var me=ys();o(Le,me)};_(pe,Le=>{e(M)?Le(ye):Le($e,!1)})}t(Qe);var tt=i(Qe,2);ht(tt,{class:"h-4 w-4 shrink-0"}),t(Ne),t(He),E(()=>He.disabled=!e(q)),o(Re,He)};_(Fe,Re=>{e(ke)?Re(dt):Re(rt,!1)})}o(Z,xe)},$$slots:{default:!0}}),t(x);var re=i(x,2),Ae=a(re);ut(Ae,{legend:"Statut de l'√©v√©nement",children:(Z,X)=>{var xe=Ds(),Fe=a(xe),dt=a(Fe);{var rt=pe=>{var ye=ks(),$e=a(ye);oa($e,{class:"h-3 w-3"}),$(),t(ye),o(pe,ye)},Re=pe=>{var ye=Xe(),$e=de(ye);{var tt=me=>{var k=Es(),le=a(k);yt(le,{class:"h-3 w-3"}),$(),t(k),o(me,k)},Le=me=>{var k=Ts(),le=a(k);la(le,{class:"h-3 w-3"});var Ve=i(le);t(k),E(()=>Q(Ve,` ${e(h)??""}`)),o(me,k)};_($e,me=>{e(h)==="proposition"?me(tt):me(Le,!1)},!0)}o(pe,ye)};_(dt,pe=>{e(h)==="confirmed"?pe(rt):pe(Re,!1)})}t(Fe);var He=i(Fe,2);{var Ne=pe=>{var ye=Is();ye.__click=()=>s(ve,!0),E(()=>ye.disabled=!e(q)),o(pe,ye)},Qe=pe=>{var ye=Xe(),$e=de(ye);{var tt=me=>{var k=Cs();k.__click=()=>s(_e,!0),E(()=>k.disabled=!e(q)),o(me,k)},Le=me=>{var k=Ss();k.__click=async()=>{await Ee()&&s(h,"proposition")},E(()=>k.disabled=!e(q)),o(me,k)};_($e,me=>{e(h)==="confirmed"?me(tt):me(Le,!1)},!0)}o(pe,ye)};_(He,pe=>{e(h)==="proposition"?pe(Ne):pe(Qe,!1)})}t(xe),o(Z,xe)},$$slots:{default:!0}}),t(re),t(u),o(v,u)};_(N,v=>{e(H)&&v(ne)})}var qe=i(N,2);ca(qe,{get currentEvent(){return e(n)},get isBusy(){return e(y)},onRespond:R});var Be=i(qe,2);{var Me=v=>{var u=Ps();o(v,u)},Oe=v=>{var u=Ls(),x=a(u),U=a(x);{var re=k=>{ut(k,{legend:"Participants",get iconComponent(){return nt},children:(le,Ve)=>{var Ge=Ns(),it=a(Ge);da(it,{class:"h-5 w-5"}),$(2),t(Ge),o(le,Ge)},$$slots:{default:!0}})},Ae=k=>{{let le=D(()=>ie.userId||"");Ba(k,{get canEdit(){return e(q)},get contributors(){return e(w)},get nativeTeamsStore(){return It},get eventsStore(){return Ke},get userId(){return e(le)},get eventId(){return e(m)},onStartEdit:Ee,get minContrib(){return e(Y)},set minContrib(Ve){s(Y,Ve,!0)}})}};_(U,k=>{e(n)?.status==="local"?k(re):k(Ae,!1)})}var Z=i(U,2);{var X=k=>{{let le=D(()=>!e(q)||e(P));ms(k,{get event(){return e(n)},get contributors(){return e(w)},get disabled(){return e(le)}})}};_(Z,k=>{e(n)&&k(X)})}t(x);var xe=i(x,2),Fe=a(xe);{var dt=k=>{var le=zs(),Ve=a(le);va(Ve,{class:"h-6 w-6 shrink-0"}),$(2),t(le),o(k,le)};_(Fe,k=>{e(P)&&k(dt)})}var rt=i(Fe,2),Re=a(rt),He=a(Re);t(Re);var Ne=i(Re,2);Ne.__click=f;var Qe=a(Ne);mt(Qe,{class:"mr-1 h-4 w-4"}),$(),t(Ne),t(rt);var pe=i(rt,2);{var ye=k=>{var le=qs(),Ve=a(le),Ge=a(Ve);Et(Ge,{class:"h-8 w-8 opacity-50"}),t(Ve),$(4),t(le),o(k,le)},$e=k=>{var le=As();Je(le,29,()=>e(T),Ve=>Ve.id+"-"+e(n)?.$updatedAt,(Ve,Ge)=>{var it=Os(),Vt=a(it);{let Ut=D(()=>e(we)===e(Ge).id),Ft=D(()=>e(C).map(vt=>vt.date)),Rt=D(()=>!e(q)||e(P));$t(Vt,{get isEditing(){return e(Ut)},onEditToggle:async()=>{await Ee()&&A(e(Ge).id||"")},onDelete:()=>b(e(Ge).id||""),get allDates(){return e(Ft)},get disabled(){return e(Rt)},get meal(){return e(C)[e(C).findIndex(vt=>vt.id===e(Ge).id)]},set meal(vt){e(C)[e(C).findIndex(Ht=>Ht.id===e(Ge).id)]=vt}})}t(it),Zt(it,()=>ea,()=>({delay:100,duration:400})),o(Ve,it)}),t(le),o(k,le)};_(pe,k=>{e(T).length===0?k(ye):k($e,!1)})}var tt=i(pe,2),Le=a(tt);Le.__click=f;var me=a(Le);mt(me,{class:"mr-1 h-4 w-4"}),$(),t(Le),t(tt),t(xe),t(u),E(()=>{Q(He,`Repas & Menus (${e(T).length??""})`),Ne.disabled=!e(q),Le.disabled=!e(q)}),o(v,u)};_(Be,v=>{e(y)&&!e(H)?v(Me):v(Oe,!1)})}t(De);var be=i(De,2);Mt(be,{get isOpen(){return e(ve)},title:"Confirmer l'√©v√©nement",message:"√ätes-vous s√ªr de vouloir confirmer cet √©v√©nement ? ",variant:"info",confirmLabel:"Confirmer",cancelLabel:"Annuler",onConfirm:L,onCancel:()=>s(ve,!1)});var Pe=i(be,2);Mt(Pe,{get isOpen(){return e(_e)},title:"Annuler la confirmation",message:"√ätes-vous s√ªr de vouloir annuler cet √©v√©nement ?.",variant:"warning",confirmLabel:"Oui, annuler",cancelLabel:"Non, garder",onConfirm:K,onCancel:()=>s(_e,!1)});var je=i(Pe,2);{let v=D(()=>`/dashboard/eventEdit/${e(m)}`);ga(je,{get routeKey(){return e(v)},shouldProtect:()=>e(Te),onLeaveWithoutSave:ce,onSaveAndLeave:he,message:"Vous avez des modifications non sauvegard√©es. Voulez-vous vraiment quitter ?"})}o(Ze,fe),bt()}gt(["click","input"]);export{tn as default};
