import{B as _t,d as bt,p as Xe,y as q,z as mt,J as at,A as s,m as e,v as d,k as le,K as x,h as a,g as r,u as N,b as i,w as C,S as dt,T as tt,x as W,j as Ze,e as Ge,i as vt,U as zt,al as Rt,c as pt,ak as ht,O as Q,o as t,G as ie,W as Ke,am as Pt,M as wt,C as et,I as ve,ab as Wt,$ as Je,ah as Kt,ag as Nt,ad as qt,aj as Tt,aG as Jt,aH as lt,aI as ut,Y as Qt,D as Yt,F as It,an as Xt}from"./appwrite.js";import{E as Zt,f as $t}from"./EventMealCard.js";import{M as At,b as Ot,c as jt,d as Lt,n as St}from"./index.js";import{F as ft}from"./Fieldset.js";import{aH as xt,a2 as ea,M as ta,c as gt,U as nt,G as yt,aw as kt,aI as aa,af as na,t as Et,aG as sa,aJ as Dt,ar as Ct,a4 as Bt,aK as ra,a0 as ia,b as oa}from"./icons.js";import{E as la}from"./EventInvitationAlert.js";import{c as da}from"./event-stats-helpers.js";import{E as va}from"./EventStats.js";import"./CheckboxBadge.js";import{B as ca}from"./BtnGroupCheck.js";import{U as ua}from"./UnsavedChangesGuard.js";import{C as Mt}from"./ConfirmModal.js";import{B as fa}from"./BadgeEventStatus.js";import"./keyboardNavigation.svelte.js";import"./products-display.js";import"./date-helpers.js";import"./index2.js";var ma=d('<label class="input w-56"><span class="label">Minimum</span> <input type="number" min="1" class="grow" id="min-contrib-input"/></label>'),ga=d('<button class="btn justify-start"><div class="flex items-center gap-4"><span class="label">minimum</span> <span class="text-lg"> </span> <!></div></button>'),_a=d('<div class="badge badge-primary badge-soft badge-lg gap-2 p-3"><!> <span class="font-medium"> </span></div>'),ba=d('<fieldset class="fieldset"><legend class="legend">√âquipes invit√©es</legend> <div class="flex flex-wrap gap-2"></div></fieldset>'),pa=d('<div class="badge badge-soft badge-success gap-2 p-3"><span class="font-medium"> </span></div>'),ha=d('<button class="link link-error" title="Se d√©sinscrire">Se d√©sinscrire</button>'),xa=d('<fieldset class="fieldset"><legend class="legend">Participant confirm√©</legend> <div class="flex flex-wrap gap-2"><!> <!></div></fieldset>'),ya=d('<div class="badge badge-warning badge-soft gap-2 p-3"><span class="font-medium"> </span></div>'),wa=d('<fieldset class="fieldset"><legend class="text-base-content/70 text-sm font-medium">Invit√©¬∑es</legend> <div class="flex flex-wrap gap-2"></div></fieldset>'),ka=d('<div class="badge badge-error badge-soft gap-2 p-3"><span class="font-medium"> </span></div>'),Ea=d('<button class="link">je participe</button>'),Ta=d('<fieldset class="fieldset"><legend class="text-base-content/70 text-sm font-medium">ne participent pas</legend> <div class="flex flex-wrap items-center gap-2"><!> <!></div></fieldset>'),Ia=d('<div class="my-2"><button class="btn btn-primary btn-outline btn-block gap-1"><!> Inviter des participant¬∑es</button></div>'),Sa=d('<fieldset class="fieldset mb-4"><!> <div class="fieldset-label ms-1">Combien faudrait-il √™tre pour tout g√©rer ?</div></fieldset> <div class="mb-6"><div class="space-y-4"><!> <!> <!> <!></div></div> <!>',1),Da=d('<p class="text-error mt-1 text-xs"> </p>'),Ca=d("<p> </p>"),Ma=d('<div class="badge badge-primary badge-soft badge-lg"><!> </div>'),za=d('<div class="mb-4"><p class="mb-2 text-sm font-medium opacity-70">√âquipes d√©j√† invit√©es :</p> <div class="flex flex-wrap gap-2"></div></div>'),Pa=d('<label class="hover:bg-secondary/20 bg-secondary/10 flex cursor-pointer items-center gap-3 rounded-lg px-4 py-2 transition-colors"><input type="checkbox" class="checkbox bg-base-100 checkbox-sm"/> <div class="flex flex-col"><span class="text-sm font-medium"> <span class="text-xs opacity-60"> </span></span> <div class="text-xs opacity-70"> </div></div></label>'),Na=d(`<label class="mt-4 cursor-pointer justify-center gap-4"><input type="checkbox" class="checkbox checkbox-sm"/> <span class="font-base ms-1">Envoyer un email de notification</span></label> <p class="text-base-content/60 mt-1 text-xs">Si d√©sactiv√©, les membres auront acc√®s √† l'√©v√©nement mais ne
                recevront pas d'email. Les personnes invit√©es n'ayant pas de
                compte recevront toujours un email pour la cr√©ation de leur
                compte.</p>`,1),qa=d('<div class="flex flex-wrap gap-4"></div> <!>',1),Aa=d('<p class="text-sm italic opacity-60">Toutes vos √©quipes sont d√©j√† invit√©es.</p>'),Oa=d(`<p class="text-sm italic opacity-60">Vous ne faites partie d'aucune √©quipe. Cr√©ez une √©quipe pour inviter
            plusieurs personnes.</p>`),ja=d(`<div class="space-y-6"><fieldset class="fieldset"><legend class="legend">Par email</legend> <div class="flex gap-2"><label class="input flex items-center gap-2"><!> <input type="email" class="grow" placeholder="email@exemple.com"/></label> <button class="btn btn-primary"><!> Ajouter</button></div> <!> <div></div></fieldset> <div class="divider">OU</div> <fieldset class="fieldset"><legend class="fieldset-legend"><!> Inviter des √©quipes
          enti√®res</legend> <!> <!></fieldset></div>`),La=d('<button class="btn">Annuler</button> <button class="btn btn-primary"><!> Inviter <!></button>',1),Ba=d("<!> <!> <!>",1),Va=d("<!> <!>",1);function Ua($e,n){bt(n,!0);let Be=Xe(n,"minContrib",15),M=Xe(n,"userId",3,""),m=Xe(n,"eventId",3,""),ae=Xe(n,"onStartEdit",3,()=>{}),A=q(mt([])),E=q(mt([])),ne=q(!1),S=q(!1),Y=q(!1);at(()=>{if(m()){const f=n.eventsStore.getEventById(m());if(f&&f.teams){const $=f.teams||[],z=[];for(const R of $){const ke=n.nativeTeamsStore.teams.find(qe=>qe.name===R);ke&&z.push(ke.$id)}s(A,z,!0)}}}),at(()=>{e(S)||s(E,[],!0)});let I=q(""),K=q(null),Z=N(()=>n.contributors.filter(f=>f.status==="accepted")),ce=N(()=>n.contributors.filter(f=>f.status==="invited")),ye=N(()=>n.contributors.filter(f=>f.status==="declined")),ge=N(()=>n.contributors.some(f=>f.id===M()&&f.status==="accepted")),Te=N(()=>n.contributors.some(f=>f.id===M()&&f.status==="declined"));function se(f){e(A).includes(f)?s(A,e(A).filter($=>$!==f),!0):s(A,[...e(A),f],!0)}function Me(){if(!e(I))return;const f=e(I).trim();if(n.contributors.some(z=>z.email===f)||e(E).some(z=>z.email===f)){s(K,"Cet email est d√©j√† invit√©.");return}s(K,null);const $={id:ht(),email:f,status:"invited",invitedAt:new Date().toISOString()};s(E,[...e(E),$],!0),s(I,"")}async function ze(){if(!m()){Q.error("ID d'√©v√©nement manquant");return}const f=n.eventsStore.getEventById(m());if(!f)throw new Error("√âv√©nement introuvable");const $=e(A).filter(R=>{const ke=n.nativeTeamsStore.teams.find(qe=>qe.$id===R);return ke?!f.teams?.includes(ke.name):!1}),z=e(E).map(R=>R.email).filter(Boolean);if($.length===0&&z.length===0){Q.warning("S√©lectionnez au moins une √©quipe ou entrez un email");return}try{await Q.track(n.eventsStore.inviteParticipants(m(),{teamIds:$,emails:z,sendEmailToExistingMembers:e(ne)}),{loading:"Envoi des invitations en cours...",success:"invitation envoy√© avec succ√®s",error:"Erreur lors de l'envoi des invitations"}),s(S,!1),s(E,[],!0)}catch(R){console.error("Erreur lors de l'envoi des invitations:",R)}}function Pe(){s(S,!1),s(I,""),s(K,null)}let b=N(()=>()=>{if(!m())return[];const f=n.eventsStore.getEventById(m());return f?e(A).filter($=>{const z=n.nativeTeamsStore.teams.find(R=>R.$id===$);return z?!f.teams?.includes(z.name):!1}):[]});async function u(){if(!(!m()||!M()||!confirm("√ätes-vous s√ªr de vouloir vous d√©sinscrire de cet √©v√©nement ?")))try{await Q.track(n.eventsStore.updateContributorStatus(m(),M(),"declined"),{loading:"D√©sinscription en cours...",success:"Vous avez √©t√© d√©sinscrit de l'√©v√©nement",error:"Erreur lors de la d√©sinscription"})}catch($){console.error("Erreur lors de la d√©sinscription:",$)}}async function we(){try{await Q.track(n.eventsStore.updateContributorStatus(m(),M(),"accepted"),{loading:"D√©sinscription en cours...",success:"Vous avez √©t√© d√©sinscrit de l'√©v√©nement",error:"Erreur lors de la d√©sinscription"})}catch(f){console.error("Erreur lors de la d√©sinscription:",f)}}var Ne=Va(),Ie=le(Ne);ft(Ie,{legend:"Participants",children:(f,$)=>{var z=Sa(),R=le(z),ke=a(R);{var qe=T=>{var y=ma(),D=r(a(y),2);D.defaultValue=1,t(y),C(()=>D.disabled=!n.canEdit),dt("focus",D,function(...l){ae()?.apply(this,l)}),dt("blur",D,()=>s(Y,!1)),tt(D,Be),i(T,y)},_e=T=>{var y=ga();y.__click=()=>{s(Y,!0),setTimeout(()=>{document.getElementById("min-contrib-input")?.focus()},50)};var D=a(y),l=r(a(D),2),c=a(l,!0);t(l);var p=r(l,2);xt(p,{class:"h-4 w-4"}),t(D),t(y),C(()=>{y.disabled=!n.canEdit,W(c,Be()||1)}),i(T,y)};x(ke,T=>{e(Y)?T(qe):T(_e,!1)})}ie(2),t(R);var be=r(R,2),V=a(be),O=a(V);{var j=T=>{const y=N(()=>n.eventsStore.getEventById(m()));var D=Ze(),l=le(D);{var c=p=>{var g=ba(),h=r(a(g),2);Ge(h,21,()=>e(y).teams,vt,(_,P)=>{var L=_a(),ue=a(L);nt(ue,{class:"inline size-4"});var De=r(ue,2),Ae=a(De,!0);t(De),t(L),C(()=>W(Ae,e(P))),i(_,L)}),t(h),t(g),i(p,g)};x(l,p=>{e(y)&&e(y).teams&&e(y).teams.length>0&&p(c)})}i(T,D)};x(O,T=>{m()&&T(j)})}var B=r(O,2);{var X=T=>{var y=xa(),D=r(a(y),2),l=a(D);Ge(l,17,()=>e(Z),g=>g.id,(g,h)=>{var _=pa(),P=a(_),L=a(P,!0);t(P),t(_),C(()=>W(L,e(h).name||e(h).email)),i(g,_)});var c=r(l,2);{var p=g=>{var h=Ze(),_=le(h);{var P=L=>{var ue=ha();ue.__click=u,i(L,ue)};x(_,L=>{n.canEdit&&L(P)})}i(g,h)};x(c,g=>{e(ge)&&g(p)})}t(D),t(y),i(T,y)};x(B,T=>{e(Z).length>0&&T(X)})}var J=r(B,2);{var ee=T=>{var y=wa(),D=r(a(y),2);Ge(D,21,()=>e(ce),l=>l.id,(l,c)=>{var p=ya(),g=a(p),h=a(g,!0);t(g),t(p),C(()=>W(h,e(c).name||e(c).email)),i(l,p)}),t(D),t(y),i(T,y)};x(J,T=>{e(ce).length>0&&T(ee)})}var te=r(J,2);{var re=T=>{var y=Ta(),D=r(a(y),2),l=a(D);Ge(l,17,()=>e(ye),g=>g.id,(g,h)=>{var _=ka(),P=a(_),L=a(P,!0);t(P),t(_),C(()=>W(L,e(h).name||e(h).email)),i(g,_)});var c=r(l,2);{var p=g=>{var h=Ea();h.__click=()=>we(),i(g,h)};x(c,g=>{e(Te)&&g(p)})}t(D),t(y),i(T,y)};x(te,T=>{e(ye).length>0&&T(re)})}t(V),t(be);var pe=r(be,2);{var Se=T=>{var y=Ia(),D=a(y);D.__click=()=>s(S,!0);var l=a(D);ea(l,{class:"mr-2 h-4 w-4"}),ie(),t(D),t(y),i(T,y)};x(pe,T=>{m()&&T(Se)})}i(f,z)},$$slots:{default:!0}});var U=r(Ie,2);At(U,{get isOpen(){return e(S)},onClose:Pe,children:(f,$)=>{var z=Ba(),R=le(z);Ot(R,{title:"Inviter des participants",onClose:Pe});var ke=r(R,2);jt(ke,{children:(_e,be)=>{var V=ja(),O=a(V),j=r(a(O),2),B=a(j),X=a(B);ta(X,{class:"h-4 w-4 opacity-70"});var J=r(X,2);Ke(J),J.__keydown=_=>_.key==="Enter"&&Me(),t(B);var ee=r(B,2);ee.__click=Me;var te=a(ee);gt(te,{class:"h-4 w-4 opacity-70"}),ie(),t(ee),t(j);var re=r(j,2);{var pe=_=>{var P=Da(),L=a(P,!0);t(P),C(()=>W(L,e(K))),i(_,P)};x(re,_=>{e(K)&&_(pe)})}var Se=r(re,2);Ge(Se,21,()=>e(E),vt,(_,P)=>{var L=Ca(),ue=a(L,!0);t(L),C(()=>W(ue,e(P).email)),i(_,L)}),t(Se),t(O);var T=r(O,4),y=a(T),D=a(y);nt(D,{size:16,class:"inline shrink-0 opacity-60"}),ie(),t(y);var l=r(y,2);{var c=_=>{const P=N(()=>n.eventsStore.getEventById(m()));var L=Ze(),ue=le(L);{var De=Ae=>{var fe=za(),me=r(a(fe),2);Ge(me,21,()=>e(P).teams,vt,(Ve,o)=>{var v=Ma(),w=a(v);nt(w,{class:"inline size-4"});var k=r(w,1,!0);t(v),C(()=>W(k,e(o))),i(Ve,v)}),t(me),t(fe),i(Ae,fe)};x(ue,Ae=>{e(P)&&e(P).teams&&e(P).teams.length>0&&Ae(De)})}i(_,L)};x(l,_=>{m()&&_(c)})}var p=r(l,2);{var g=_=>{const P=N(()=>n.nativeTeamsStore.myTeams.filter(fe=>{if(!m())return!0;const me=n.eventsStore.getEventById(m());return!me||!me.teams?!0:!me.teams.includes(fe.name)}));var L=Ze(),ue=le(L);{var De=fe=>{var me=qa(),Ve=le(me);Ge(Ve,21,()=>e(P),vt,(w,k)=>{var G=Pa(),he=a(G);Ke(he),he.__change=()=>se(e(k).$id);var F=r(he,2),H=a(F),xe=a(H),Oe=r(xe),st=a(Oe);t(Oe),t(H);var Qe=r(H,2),je=a(Qe,!0);t(Qe),t(F),t(G),C((Ee,de)=>{Pt(he,Ee),W(xe,`${e(k).name??""} `),W(st,`${e(k).total??""} membre${e(k).total>1?"s":""}`),W(je,de)},[()=>e(A).includes(e(k).$id),()=>n.nativeTeamsStore.getTeamMemberNames(e(k).$id).join(", ")]),i(w,G)}),t(Ve);var o=r(Ve,2);{var v=w=>{var k=Na(),G=le(k),he=a(G);Ke(he),ie(2),t(G),ie(2),Rt(he,()=>e(ne),F=>s(ne,F)),i(w,k)};x(o,w=>{e(A).length>0&&w(v)})}i(fe,me)},Ae=fe=>{var me=Aa();i(fe,me)};x(ue,fe=>{e(P).length>0?fe(De):fe(Ae,!1)})}i(_,L)},h=_=>{var P=Oa();i(_,P)};x(p,_=>{n.nativeTeamsStore.myTeams.length>0?_(g):_(h,!1)})}t(T),t(V),C(()=>ee.disabled=!e(I)),tt(J,()=>e(I),_=>s(I,_)),i(_e,V)}});var qe=r(ke,2);Lt(qe,{children:(_e,be)=>{var V=La(),O=le(V);O.__click=Pe;var j=r(O,2);j.__click=ze;var B=a(j);yt(B,{class:"mr-2 h-4 w-4"});var X=r(B,2);{var J=ee=>{var te=zt();C(re=>W(te,`(${re??""})`),[()=>e(b)().length+e(E).length]),i(ee,te)};x(X,ee=>{(e(b)().length>0||e(E).length>0)&&ee(J)})}t(j),C(ee=>j.disabled=ee,[()=>e(E).length===0&&e(b)().length===0]),i(_e,V)}}),i(f,z)},$$slots:{default:!0}}),i($e,Ne),pt()}_t(["click","keydown","change"]);var Ga=d('<div class="flex items-center gap-2"><!> <span> </span></div>'),Fa=d('<div class="flex items-center gap-2"><!> <span>A r√©aliser avant le :</span> <span class="font-medium"> </span></div>'),Ha=d("<div><div><span> </span></div></div>"),Ra=d('<div><div class="bg-base-300 text-base-content w-7 rounded-full"><span class="text-base"> </span></div></div>'),Wa=d('<span class="text-warning mx-1 text-base italic">Non assign√©</span>'),Ka=d('<p class="text-base-content/60 mt-1 line-clamp-2 text-sm"> </p>'),Ja=d("<button><!> Fait <!></button>"),Qa=d(`<button class="btn btn-primary btn-outline btn-sm gap-1" title="Me porter volontaire pour cette t√¢che"><!> <span>M'inscrire</span></button>`),Ya=d('<button class="btn btn-error btn-sm btn-outline gap-1" title="Quitter cette t√¢che"><!> <span>me d√©sinscrire</span></button>'),Xa=d('<div><div class="flex flex-col gap-3"><div class="flex min-w-0 items-start gap-3"><div class="flex min-w-0 grow flex-col gap-4"><div class="flex flex-wrap items-start justify-between gap-x-4 gap-y-2"><div> </div> <div><!> <!> <!></div></div>  <div class="flex items-center gap-2"><!> <div class="flex min-w-0 items-center gap-1"><div class="flex flex-wrap gap-2"><!> <!> <!></div> <span> </span></div></div> <!></div></div></div> <div class="mt-4 flex items-center justify-between gap-2"><div class="flex gap-2"><!></div> <div class="ms-auto flex gap-2"><!> <button class="btn btn-sm btn-square" title="Modifier la t√¢che"><!></button></div></div></div>');function Za($e,n){bt(n,!0);let Be=Xe(n,"disabled",3,!1),M=Xe(n,"contributors",19,()=>[]),m=q(!1);const ae=N(()=>Array.isArray(n.todo.assignedTo)?n.todo.assignedTo:[]),A=N(()=>ve.userId&&e(ae).includes(ve.userId)),E=N(()=>n.todo.assignedTo?n.todo.assignedTo.map(l=>{const c=M().find(h=>h.id===l),p=l===ve.userId,g=c?.name||(p?"Moi":l.substring(0,5));return{userId:l,name:g,isCurrentUser:p}}):[]),ne=N(()=>e(E).length>=(n.todo.requiredPeopleNb||1)),S=N(()=>{switch(n.todo.taskOn){case"beforeEvent":return{bg:"bg-accent/30",icon:na,label:"Avant l'√©v√©nement"};case"afterEvent":return{bg:"bg-secondary/10",icon:aa,label:"Apr√®s l'√©v√©nement"};default:return{bg:"bg-secondary/20",icon:kt,label:"Pendant l'√©v√©nement"}}});async function Y(){if(e(m)||Be())return;const c=n.todo.status==="done"?"todo":"done";s(m,!0);try{await Je.updateTodo(n.eventId,n.todo.id,{status:c})}catch{Q.error("Erreur m√†j statut")}finally{s(m,!1)}}async function I(){if(!ve.userId||e(m))return;const l=e(A)?e(ae).filter(c=>c!==ve.userId):[...e(ae),ve.userId];s(m,!0);try{await Je.updateTodo(n.eventId,n.todo.id,{assignedTo:l.length>0?l:null}),Q.success(e(A)?"Vous avez rejoint la t√¢che":"Vous avez quitt√© la t√¢che")}catch{Q.error("Erreur assignation")}finally{s(m,!1)}}var K=Xa();let Z;var ce=a(K),ye=a(ce),ge=a(ye),Te=a(ge),se=a(Te),Me=a(se,!0);t(se);var ze=r(se,2),Pe=a(ze);{var b=l=>{};x(Pe,l=>{n.todo.priority&&n.todo.priority!=="low"&&l(b)})}var u=r(Pe,2);{var we=l=>{var c=Ga(),p=a(c);Wt(p,()=>e(S).icon,(_,P)=>{P(_,{class:"size-4 shrink-0 opacity-70"})});var g=r(p,2),h=a(g,!0);t(g),t(c),C(()=>W(h,e(S).label)),i(l,c)};x(u,l=>{n.todo.taskOn&&l(we)})}var Ne=r(u,2);{var Ie=l=>{var c=Fa(),p=a(c);Et(p,{class:"size-4 shrink-0 opacity-70"});var g=r(p,4),h=a(g,!0);t(g),t(c),C(_=>W(h,_),[()=>new Date(n.todo.dueDate).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})]),i(l,c)};x(Ne,l=>{n.todo.dueDate&&l(Ie)})}t(ze),t(Te);var U=r(Te,2),f=a(U);nt(f,{class:"mt-1 mb-auto size-4 shrink-0 opacity-60"});var $=r(f,2),z=a($),R=a(z);Ge(R,19,()=>e(E).slice(0,3),l=>l.userId,(l,c)=>{var p=Ha(),g=a(p),h=a(g),_=a(h,!0);t(h),t(g),t(p),C(()=>{wt(p,"title",e(c).name+(e(c).isCurrentUser?" (vous)":"")),et(g,1,`badge badge-soft badge-info ${(e(c).isCurrentUser&&"ring-info font-semibold ring-1")??""}`),W(_,e(c).name)}),i(l,p)});var ke=r(R,2);{var qe=l=>{var c=Ra(),p=a(c),g=a(p),h=a(g);t(g),t(p),t(c),C(()=>{wt(c,"title",`+${e(E).length-3} autres`),W(h,`+${e(E).length-3}`)}),i(l,c)};x(ke,l=>{e(E).length>3&&l(qe)})}var _e=r(ke,2);{var be=l=>{var c=Wa();i(l,c)};x(_e,l=>{e(E).length===0&&l(be)})}t(z);var V=r(z,2),O=a(V);t(V),t($),t(U);var j=r(U,2);{var B=l=>{var c=Ka(),p=a(c,!0);t(c),C(()=>W(p,n.todo.taskDescription)),i(l,c)};x(j,l=>{n.todo.taskDescription&&l(B)})}t(ge),t(ye),t(ce);var X=r(ce,2),J=a(X),ee=a(J);{var te=l=>{var c=Ja();c.__click=Y;var p=a(c);{let _=N(()=>n.todo.status!=="done"&&"opacity-60");yt(p,{get class(){return`size-4 ${e(_)??""}`}})}var g=r(p,2);{var h=_=>{var P=zt("?");i(_,P)};x(g,_=>{n.todo.status!=="done"&&_(h)})}t(c),C(()=>{et(c,1,`btn btn-sm ${n.todo.status!=="done"?"btn-dash":"btn-success"}`),wt(c,"title",n.todo.status==="done"?"Marquer √† faire":"Marquer fait"),c.disabled=Be()}),i(l,c)};x(ee,l=>{n.todo.taskOn==="beforeEvent"&&l(te)})}t(J);var re=r(J,2),pe=a(re);{var Se=l=>{var c=Qa();c.__click=I;var p=a(c);yt(p,{class:"size-4"}),ie(2),t(c),i(l,c)},T=l=>{var c=Ze(),p=le(c);{var g=h=>{var _=Ya();_.__click=I;var P=a(_);sa(P,{class:"size-4"}),ie(2),t(_),i(h,_)};x(p,h=>{e(A)&&h(g)},!0)}i(l,c)};x(pe,l=>{e(A)?l(T,!1):l(Se)})}var y=r(pe,2);y.__click=()=>n.onEdit(n.todo);var D=a(y);xt(D,{class:"size-4"}),t(y),t(re),t(X),t(K),C(()=>{Z=et(K,1,`group bg-base-200/50 relative rounded-xl p-4 shadow transition-all ${e(ne)?"shadow-success/40 ":"shadow-warning/40 "}`,null,Z,{"opacity-50":e(m)}),et(se,1,`text-base font-medium ${n.todo.status==="done"?"line-through opacity-50":""}`),W(Me,n.todo.taskName),et(ze,1,`card card-sm ${e(S).bg??""} ms-auto flex flex-col justify-end px-4 py-1`),et(V,1,`mx-1 ${e(E).length<(n.todo.requiredPeopleNb||1)?"text-warning":"text-success"} font-medium`),W(O,`${e(E).length??""}/${(n.todo.requiredPeopleNb||1)??""} pers. requise`)}),i($e,K),pt()}_t(["click"]);var $a=d('<div role="tablist" class="tabs tabs-border tabs-lg mb-4"><button role="tab"><!> T√¢che individuelle</button> <button role="tab"><!> T√¢ches pr√©d√©finies</button></div>'),en=d('<span class="badge badge-warning badge-sm"> </span>'),tn=d('<span class="badge badge-success badge-sm flex items-center gap-1"><!> ok</span>'),an=d(`<div class="space-y-4"><fieldset class="fieldset"><legend class="fieldset-legend">Titre</legend> <label class="input w-full"><input type="text" placeholder="Ex: Acheter du pain, Pr√©parer la salle..." class="grow"/></label></fieldset> <fieldset class="fieldset"><legend class="fieldset-legend flex items-center gap-2"><!> Description</legend> <textarea class="textarea h-24 w-full" placeholder="D√©tails suppl√©mentaires..."></textarea></fieldset> <div class="flex flex-wrap gap-4"><fieldset class="fieldset w-80"><legend class="fieldset-legend flex items-center gap-2"><!> Moment</legend> <select class="select w-full"><option>Avant l'√©v√©nement</option><option>Pendant l'√©v√©nement</option><option>Apr√®s l'√©v√©nement</option></select></fieldset> <fieldset class="fieldset w-80"><legend class="fieldset-legend flex items-center gap-2"><!> √âch√©ance</legend> <label class="input w-full"><input type="date" class="grow"/></label></fieldset> <fieldset class="fieldset"><legend class="fieldset-legend flex items-center gap-2"><!> Personnes requises</legend> <label class="input w-full"><input type="number" min="1" class="grow"/></label></fieldset></div> <fieldset class="fieldset"><legend class="fieldset-legend flex items-center gap-2"><!> <!></legend> <!></fieldset></div>`),nn=d('<div class="bg-base-100 flex items-center gap-4 rounded-lg p-3"><input type="checkbox" class="checkbox checkbox-primary"/> <input type="text" class="input flex-1"/> <div class="flex items-center gap-2"><!> <input type="number" class="input w-20" min="1"/></div></div>'),sn=d('<div class="collapse-arrow bg-base-200 collapse"><input type="checkbox" checked/> <div class="collapse-title flex items-center gap-2 text-base font-medium"><!> </div> <div class="collapse-content"><div class="mt-4 space-y-3"></div></div></div>'),rn=d('<div class="space-y-6"></div>'),on=d("<!> <!>",1),ln=d('<span class="loading loading-spinner loading-sm"></span>'),dn=d('<button type="button" class="btn btn-primary"><!> Cr√©er les t√¢ches s√©lectionn√©es</button>'),vn=d('<button type="button" class="btn btn-ghost"><!> Sauvegarder & Cr√©er</button>'),cn=d('<span class="loading loading-spinner loading-sm"></span>'),un=d('<!> <button type="button" class="btn btn-primary"><!> </button>',1),fn=d("<!> <!> <!>",1);function mn($e,n){bt(n,!0);let Be=Xe(n,"contributors",19,()=>[]);Xe(n,"currentTodos",19,()=>[]);let M=q(""),m=q(""),ae=q("medium"),A=q("onEvent"),E=q(1),ne=q(""),S=q(mt([])),Y=q(!1),I=q("individual");const K={beforeEvent:["Gestion de l'approvisionnement / courses","Choix des recettes/menus","Coordination","Communication (mail, texto, affiches)","Gestion matos"],onEvent:["Pr√©parations des recettes","Service","Rangement","Vaisselle","Gestion des restes"],afterEvent:["Retour matos","D√©montage cuisine"]},Z=N(()=>n.todoToEdit?{taskName:n.todoToEdit.taskName,taskDescription:n.todoToEdit.taskDescription||"",priority:n.todoToEdit.priority||"medium",taskOn:n.todoToEdit.taskOn||"onEvent",requiredPeopleNb:n.todoToEdit.requiredPeopleNb||1,dueDate:n.todoToEdit.dueDate?n.todoToEdit.dueDate.split("T")[0]:"",assignedTo:n.todoToEdit.assignedTo?[...n.todoToEdit.assignedTo]:[]}:{taskName:"",taskDescription:"",priority:"medium",taskOn:"onEvent",requiredPeopleNb:1,dueDate:"",assignedTo:[]});at(()=>{if(n.open){n.todoToEdit?s(I,"individual"):s(I,"individual");const b=e(Z);s(M,b.taskName,!0),s(m,b.taskDescription,!0),s(ae,b.priority,!0),s(A,b.taskOn,!0),s(E,b.requiredPeopleNb,!0),s(ne,b.dueDate,!0),s(S,b.assignedTo,!0)}});function ce(){s(M,""),s(m,""),s(ae,"medium"),s(A,"onEvent"),s(E,1),s(ne,""),s(S,[],!0)}async function ye(b=!1){if(!e(M).trim()){Q.warning("Le titre de la t√¢che est requis");return}s(Y,!0);try{const u=new Date().toISOString();if(n.todoToEdit){const we={taskName:e(M),taskDescription:e(m)||null,priority:e(ae),taskOn:e(A),requiredPeopleNb:e(E),dueDate:e(ne)?new Date(e(ne)).toISOString():null,assignedTo:e(S).length>0?e(S):null};await Je.updateTodo(n.eventId,n.todoToEdit.id,we),Q.success("T√¢che mise √† jour"),ge()}else{const we={id:ht(10),taskName:e(M),taskDescription:e(m)||null,priority:e(ae),taskOn:e(A),requiredPeopleNb:e(E),dueDate:e(ne)?new Date(e(ne)).toISOString():null,assignedTo:e(S).length>0?e(S):null,status:"todo"};await Je.addTodo(n.eventId,we),Q.success("T√¢che cr√©√©e"),b?ce():ge()}}catch(u){Q.error("Erreur lors de la sauvegarde"),console.error(u)}finally{s(Y,!1)}}function ge(){ce(),n.onClose()}function Te(b){e(S).includes(b)?s(S,e(S).filter(u=>u!==b),!0):s(S,[...e(S),b],!0)}let se=q(mt([]));at(()=>{n.open&&e(I)==="bulk"&&s(se,[...K.beforeEvent.map(b=>({taskName:b,taskOn:"beforeEvent",enabled:!0,requiredPeopleNb:1})),...K.onEvent.map(b=>({taskName:b,taskOn:"onEvent",enabled:!0,requiredPeopleNb:1})),...K.afterEvent.map(b=>({taskName:b,taskOn:"afterEvent",enabled:!1,requiredPeopleNb:1}))],!0)});async function Me(){const b=e(se).filter(u=>u.enabled);if(b.length===0){Q.warning("S√©lectionnez au moins une t√¢che");return}s(Y,!0);try{const u=new Date().toISOString(),we=b.map(Ne=>({id:ht(10),taskName:Ne.taskName,taskDescription:null,priority:"medium",taskOn:Ne.taskOn,requiredPeopleNb:Ne.requiredPeopleNb,dueDate:null,assignedTo:null,status:"todo"}));await Je.addTodos(n.eventId,we),Q.success(`${we.length} t√¢che(s) cr√©√©e(s)`),ge()}catch(u){Q.error("Erreur lors de la cr√©ation"),console.error(u)}finally{s(Y,!1)}}function ze(b){e(se)[b].enabled=!e(se)[b].enabled}const Pe=N(()=>{const b=[{id:ve.userId||"",label:"Moi",selected:e(S).includes(ve.userId||"")}];return Be().forEach(u=>{u.id!==ve.userId&&b.push({id:u.id,label:u.name||u.email||u.id.substring(0,5),selected:e(S).includes(u.id)})}),b});At($e,{get isOpen(){return n.open},onClose:ge,maxWidth:"lg",maxHeight:"xl",children:(b,u)=>{var we=fn(),Ne=le(we);{let f=N(()=>n.todoToEdit?"Modifier la T√¢che":"Nouvelle T√¢che");Ot(Ne,{get title(){return e(f)},onClose:ge})}var Ie=r(Ne,2);jt(Ie,{children:(f,$)=>{var z=on(),R=le(z);{var ke=V=>{var O=$a(),j=a(O);j.__click=()=>s(I,"individual");var B=a(j);Dt(B,{class:"me-2 size-4"}),ie(),t(j);var X=r(j,2);X.__click=()=>s(I,"bulk");var J=a(X);Ct(J,{class:"me-2 size-4"}),ie(),t(X),t(O),C(()=>{et(j,1,`tab ${e(I)==="individual"?"tab-active":""}`),et(X,1,`tab ${e(I)==="bulk"?"tab-active":""}`)}),i(V,O)};x(R,V=>{n.todoToEdit||V(ke)})}var qe=r(R,2);{var _e=V=>{var O=an(),j=a(O),B=r(a(j),2),X=a(B);Ke(X),t(B),t(j);var J=r(j,2),ee=a(J),te=a(ee);Dt(te,{class:"size-4 opacity-50"}),ie(),t(ee);var re=r(ee,2);Nt(re),t(J);var pe=r(J,2),Se=a(pe),T=a(Se),y=a(T);kt(y,{class:"size-4 opacity-50"}),ie(),t(T);var D=r(T,2),l=a(D);l.value=l.__value="beforeEvent";var c=r(l);c.value=c.__value="onEvent";var p=r(c);p.value=p.__value="afterEvent",t(D),t(Se);var g=r(Se,2),h=a(g),_=a(h);Et(_,{class:"size-4 opacity-50"}),ie(),t(h);var P=r(h,2),L=a(P);Ke(L),t(P),t(g);var ue=r(g,2),De=a(ue),Ae=a(De);nt(Ae,{class:"size-4 opacity-50"}),ie(),t(De);var fe=r(De,2),me=a(fe);Ke(me),t(fe),t(ue),t(pe);var Ve=r(pe,2),o=a(Ve),v=a(o);nt(v,{class:"size-4 opacity-50"});var w=r(v),k=r(w);{var G=H=>{var xe=en(),Oe=a(xe);t(xe),C(()=>W(Oe,`Manque ${e(E)-e(S).length} pers.`)),i(H,xe)},he=H=>{var xe=tn(),Oe=a(xe);yt(Oe,{class:"size-3"}),ie(),t(xe),i(H,xe)};x(k,H=>{e(S).length<e(E)?H(G):H(he,!1)})}t(o);var F=r(o,2);ca(F,{get items(){return e(Pe)},size:"lg",color:"primary",onToggleItem:Te}),t(Ve),t(O),C(()=>W(w,` Assignation (${e(S).length??""}/${e(E)??""}) `)),tt(X,()=>e(M),H=>s(M,H)),tt(re,()=>e(m),H=>s(m,H)),Kt(D,()=>e(A),H=>s(A,H)),tt(L,()=>e(ne),H=>s(ne,H)),tt(me,()=>e(E),H=>s(E,H)),i(V,O)},be=V=>{var O=rn();Ge(O,20,()=>["beforeEvent","onEvent","afterEvent"],vt,(j,B)=>{const X=N(()=>B==="beforeEvent"?"Avant l'√©v√©nement":B==="onEvent"?"Pendant l'√©v√©nement":"Apr√®s l'√©v√©nement"),J=N(()=>e(se).filter(pe=>pe.taskOn===B));var ee=Ze(),te=le(ee);{var re=pe=>{var Se=sn(),T=a(Se);Ke(T);var y=r(T,2),D=a(y);kt(D,{class:"size-4 opacity-50"});var l=r(D);t(y);var c=r(y,2),p=a(c);Ge(p,21,()=>e(J),vt,(g,h,_)=>{const P=N(()=>e(se).indexOf(e(h)));var L=nn(),ue=a(L);Ke(ue),ue.__change=()=>ze(e(P));var De=r(ue,2);Ke(De);var Ae=r(De,2),fe=a(Ae);nt(fe,{class:"size-4 opacity-50"});var me=r(fe,2);Ke(me),t(Ae),t(L),C(()=>{Pt(ue,e(h).enabled),qt(De,e(h).taskName),De.disabled=!e(h).enabled,me.disabled=!e(h).enabled}),tt(me,()=>e(h).requiredPeopleNb,Ve=>e(h).requiredPeopleNb=Ve),i(g,L)}),t(p),t(c),t(Se),C(g=>W(l,` ${e(X)??""} (${g??""}/${e(J).length??""})`),[()=>e(J).filter(g=>g.enabled).length]),i(pe,Se)};x(te,pe=>{e(J).length>0&&pe(re)})}i(j,ee)}),t(O),i(V,O)};x(qe,V=>{n.todoToEdit||e(I)==="individual"?V(_e):V(be,!1)})}i(f,z)}});var U=r(Ie,2);Lt(U,{children:(f,$)=>{var z=Ze(),R=le(z);{var ke=_e=>{var be=dn();be.__click=Me;var V=a(be);{var O=B=>{var X=ln();i(B,X)},j=B=>{Ct(B,{class:"size-4"})};x(V,B=>{e(Y)?B(O):B(j,!1)})}ie(),t(be),C(()=>be.disabled=e(Y)),i(_e,be)},qe=_e=>{var be=un(),V=le(be);{var O=te=>{var re=vn();re.__click=()=>ye(!0);var pe=a(re);gt(pe,{class:"size-4"}),ie(),t(re),C(()=>re.disabled=e(Y)),i(te,re)};x(V,te=>{n.todoToEdit||te(O)})}var j=r(V,2);j.__click=()=>ye(!1);var B=a(j);{var X=te=>{var re=cn();i(te,re)},J=te=>{Bt(te,{class:"size-4"})};x(B,te=>{e(Y)?te(X):te(J,!1)})}var ee=r(B);t(j),C(()=>{j.disabled=e(Y),W(ee,` ${n.todoToEdit?"Mettre √† jour":"Cr√©er la t√¢che"}`)}),i(_e,be)};x(R,_e=>{e(I)==="bulk"?_e(ke):_e(qe,!1)})}i(f,z)}}),i(b,we)},$$slots:{default:!0}}),pt()}_t(["click","change"]);var gn=d('<div class="text-base-content/50 border-base-200 hover:border-primary/50 cursor-pointer rounded-lg border-2 border-dashed py-8 text-center text-sm italic transition-colors" role="button" tabindex="0">Aucune t√¢che pour le moment. <br/> <span class="text-primary mt-1 inline-block font-medium">Cr√©er la premi√®re t√¢che +</span></div>'),_n=d('<div class="mb-4 flex items-center justify-between"><div class="flex items-center gap-2 text-sm opacity-60"><!> <span> </span></div> <button class="btn btn-sm btn-primary gap-2"><!> Nouvelle t√¢che</button></div> <div class=" space-y-4"><!></div> <!>',1);function bn($e,n){bt(n,!0);let Be=Xe(n,"contributors",19,()=>[]),M=Xe(n,"disabled",3,!1);const m=N(()=>n.event.todos??[]);function ae(K){return{beforeEvent:1,onEvent:2,afterEvent:3}[K]??0}const A=N(()=>[...e(m)].sort((Z,ce)=>{const ye=ae(Z.taskOn??""),ge=ae(ce.taskOn??""),Te=ye-ge;if(Te!==0)return Te;const se=Z.dueDate?new Date(Z.dueDate).getTime():1/0,Me=ce.dueDate?new Date(ce.dueDate).getTime():1/0;return se-Me}));let E=q(!1),ne=q(null);function S(){s(ne,null),s(E,!0)}function Y(K){s(ne,K,!0),s(E,!0)}function I(K){n.onTodosChange?.(K)}ft($e,{legend:"T√¢ches & Organisation",legendSize:"text-lg",children:(K,Z)=>{var ce=_n(),ye=le(ce),ge=a(ye),Te=a(ge);ra(Te,{class:"size-4"});var se=r(Te,2),Me=a(se);t(se),t(ge);var ze=r(ge,2);ze.__click=S;var Pe=a(ze);gt(Pe,{class:"size-4"}),ie(),t(ze),t(ye);var b=r(ye,2),u=a(b);{var we=U=>{var f=gn();f.__click=S,f.__keydown=$=>$.key==="Enter"&&S(),i(U,f)},Ne=U=>{var f=Ze(),$=le(f);Ge($,17,()=>e(A),z=>z.id,(z,R)=>{Za(z,{get todo(){return e(R)},get eventId(){return n.event.$id},onEdit:Y,get disabled(){return M()},get contributors(){return Be()}})}),i(U,f)};x(u,U=>{e(A).length===0?U(we):U(Ne,!1)})}t(b);var Ie=r(b,2);mn(Ie,{get open(){return e(E)},get eventId(){return n.event.$id},get todoToEdit(){return e(ne)},get contributors(){return Be()},get currentTodos(){return e(m)},onClose:()=>s(E,!1),onSave:I}),C(()=>W(Me,`${e(m).length??""} t√¢ches`)),i(K,ce)},$$slots:{default:!0}}),pt()}_t(["click","keydown"]);var pn=d('<span class="loading loading-spinner loading-xs text-primary"></span>'),hn=d('<div class="flex items-center gap-2"><button class="btn btn-accent btn-sm"><!> <span class="font-bold">Enregistrer</span></button></div>'),xn=d(`<input type="text" class="input input-lg min-w-full shadow-md" placeholder="Nom de l'√©v√©nement"/>`),yn=d('<button class="btn btn-ghost"><div class="flex items-baseline gap-4"><h1> </h1> <!></div></button>'),wn=d(`<textarea class="textarea w-full" placeholder="D√©crivez l'√©v√©nement..." maxlength="3000" rows="9"></textarea> <p class="label"> </p>`,1),kn=d('<p class="whitespace-pre-wrap"> </p>'),En=d('<p class="text-base-content/40 italic">Ajoutez une description...</p>'),Tn=d('<button class="btn btn-ghost bg-base-100 h-auto justify-start py-4 text-left font-normal"><div class="flex w-full items-start justify-between gap-4"><div class="flex-1"><!></div> <!></div></button>'),In=d(`<button class="btn btn-success btn-link btn-md">Confirmez l'√©v√©nement</button> <button class="btn btn-link btn-error btn-sm">Annuler l'√©v√©nement</button>`,1),Sn=d(`<button class="btn btn-link btn-error btn-sm">Annuler l'√©v√©nement</button>`),Dn=d('<button class="btn btn-link btn-sm">R√©activer</button>'),Cn=d('<div class="flex flex-wrap items-center justify-between gap-2"><!> <!></div>'),Mn=d('<div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:col-span-2 lg:grid-cols-3"><div class="col-span-2"><!></div> <div class="flex flex-col justify-start gap-4"><!></div></div>'),zn=d(`<div class="flex items-center justify-center py-20"><div class="flex flex-col items-center gap-4"><span class="loading loading-spinner loading-lg text-primary"></span> <p class="text-base-content/60">Chargement de l'√©v√©nement...</p></div></div>`),Pn=d(`<div class="alert alert-info"><!> <div><h4 class="font-bold">Mode D√©monstration</h4> <p class="text-sm">Dans un v√©ritable √©v√©nement, vous pourrez inviter des √©quipes
                  et des participants √† collaborer sur la planification.</p></div></div>`),Nn=d(`<div class="alert alert-warning max-md:alert-vertical"><!> <div><h3 class="font-bold">√âv√©nement en cours de modification</h3> <div class="text-xs">Un autre utilisateur est en train de modifier cet √©v√©nement. Les
                contr√¥les sont temporairement d√©sactiv√©s.</div></div></div>`),qn=d('<div class="text-base-content/60 bg-base-200 rounded-box border-base-200 flex flex-col items-center justify-center border-2 border-dashed py-12"><div class="bg-base-200 mb-4 rounded-full p-4"><!></div> <p class="font-medium">Aucun repas planifi√©</p> <p class="mt-1 text-sm">Commencez par ajouter un repas √† votre √©v√©nement</p></div>'),An=d("<div><!></div>"),On=d('<div class="space-y-4"></div>'),jn=d('<div class="grid grid-cols-1 gap-6 pb-20 lg:grid-cols-3"><div class="space-y-6 lg:col-span-1"><!> <!></div> <div class="space-y-6 md:px-4 lg:col-span-2"><!> <div class="mb-6 flex items-center justify-between"><h3 class="card-title text-lg"> </h3> <button class="btn btn-primary"><!> Ajouter un repas</button></div> <!> <div class="flex"><button class="btn btn-outline btn-primary btn-block mt-4"><!> Ajouter un repas</button></div></div></div>'),Ln=d('<div class="bg-base-200 min-h-lvh space-y-6 px-2 pt-4 pb-20 md:px-20"><div class="flex flex-wrap items-center justify-between gap-x-6 gap-y-3"><div class="min-w-80 flex-1 gap-2"><!></div> <!></div> <!> <!> <!></div> <!> <!> <!>',1);function as($e,n){bt(n,!0);const Be=o=>{var v=hn(),w=a(v);w.__click=V;var k=a(w);{var G=F=>{var H=pn();i(F,H)},he=F=>{Bt(F,{size:18,class:"mr-1"})};x(k,F=>{e(I)?F(G):F(he,!1)})}ie(2),t(w),t(v),C(()=>w.disabled=e(I)||!e(Pe)||!e(U)),i(o,v)};let M=N(()=>Yt.params.id),m=q(mt([])),ae=q(""),A=q(""),E=q("proposition"),ne=q(1);const S=N(()=>[...e(m)].sort((o,v)=>new Date(o.date).getTime()-new Date(v.date).getTime()));let Y=q(!1),I=q(!1),K=q(!1),Z=q(!1),ce=q(null),ye=q(!1),ge=q(!1),Te=q(!1),se=q(!1),Me=q(null),ze=null;const Pe=N(()=>{if(e(ae)===""&&e(m).length===0||!e(Y)||!e(Z)||!e(u))return!1;if(e(ae)!==e(u).name||e(A)!==(e(u).description||"")||e(E)!==e(u).status||e(ne)!==(e(u).minContrib||1))return!0;const o=e(u).meals||[];if(e(m).length!==o.length)return!0;for(let v=0;v<e(m).length;v++){const w=o[v],k=e(m)[v];if(k.id!==w.id||k.date!==w.date||k.guests!==w.guests||(k.recipes?.length||0)!==(w.recipes?.length||0))return!0}return!1});async function b(){if(e(Z))return!0;if(e(Ie))return Q.warning(`Cet √©v√©nement est verrouill√© par ${e(f)}`),!1;if(e(u)&&lt(e(u).$id))return s(Z,!0),!0;const o=await $();return o&&s(Z,!0),o}const u=N(()=>Je.getEventById(e(M))),we=N(()=>da(e(u))),Ne=N(()=>e(u)?.teamsId??[]),Ie=N(()=>e(Me)?e(Me).userId!==ve.userId:!1),U=N(()=>e(u)&&lt(e(u).$id)||Je.canUserEditEvent(e(M),ve.userId||"")&&!e(Ie)&&!e(I)),f=N(()=>e(Me)?.userName||"un autre utilisateur");at(()=>{if(!e(u)){console.log("[Sync] Guard 1 - Pas de currentEvent");return}if(!e(Y)){console.log("[Sync] Guard 2 - Pas initialis√©");return}if(e(Z)&&e(ae)!==""){console.log("[Sync] Guard 3 - Mode √©dition actif, pas de sync (shadow draft d√©j√† peupl√©)");return}Tt(()=>{const o=e(ae),v=e(m).length;s(m,Jt(e(u).meals||[]),!0),s(ae,e(u).name||"",!0),s(A,e(u).description||"",!0),s(E,e(u).status||"proposition",!0),s(ne,e(u).minContrib||1,!0)})}),at(()=>{St.setConfig({actions:Be,isLockedByOthers:e(Ie),lockedByUserName:e(f),hasUnsavedChanges:e(Pe)&&!e(Ie)})}),at(()=>{if(e(Y)||e(I)){console.log("[Init] Guard 1 - D√©j√† initialis√© ou occup√©",{isInitialised:e(Y),isBusy:e(I)});return}if(!e(M)){console.log("[Init] Guard 2 - Pas d'eventId");return}console.log("[Init] D√©but initialisation pour eventId:",e(M)),Tt(async()=>{s(I,!0);try{const o=Je.getEventById(e(M));if(console.log("[Init] Event r√©cup√©r√©:",o?.$id,o?.name),o&&lt(o.$id)){console.log("[Init] Mode d√©mo: pr√™t, marquage isInitialised = true"),s(Y,!0);return}s(Me,await ut.getLock(e(M)),!0),ze=ut.subscribeToLock(e(M),v=>{console.log("[EventEditPage] üîí Verrou mis √† jour:",{lockedBy:v?.userName,userId:v?.userId,expiresAt:v?.expiresAt}),s(Me,v,!0)}),s(Y,!0)}finally{s(I,!1),console.log("[Init] Fin initialisation, isBusy = false")}})}),Qt(()=>{O&&(clearTimeout(O),O=null),ze&&(ze(),ze=null),e(M)&&e(Z)&&(console.log("üö™ D√©montage du composant, lib√©ration du lock..."),z()),St.reset()});async function $(){if(e(u)&&lt(e(u).$id))return console.log("[acquireLock] Mode d√©mo : pas de lock √† acqu√©rir"),!0;if(!e(M)||!ve.userId||e(I)||e(K))return!1;s(K,!0);try{return await ut.acquireLock(e(M),ve.userId,ve.userName)?(j(),!0):(Q.warning(`Cet √©v√©nement est en cours de modification par ${e(f)}`),!1)}catch(o){return console.error("‚ùå Erreur acquisition verrou:",o),Q.error("Impossible de verrouiller l'√©v√©nement"),!1}finally{s(K,!1)}}async function z(){if(e(u)&&lt(e(u).$id)){console.log("[releaseLock] Mode d√©mo : d√©sactivation de isEditing"),s(Z,!1);return}if(!(!e(M)||!ve.userId)){try{await ut.releaseLock(e(M),ve.userId),console.log("üîì Verrou lib√©r√©")}catch(o){console.error("‚ùå Erreur lib√©ration verrou:",o)}s(Z,!1)}}async function R(){e(Z)&&await z()}async function ke(){const o=await _e();return o&&await z(),o}function qe(){if(!e(ae).trim())return{isValid:!1,errorMessage:"Veuillez renseigner le nom de l'√©v√©nement"};if(e(m).length===0)return{isValid:!1,errorMessage:"Veuillez ajouter au moins un repas"};const v=e(m).map(w=>w.date).filter((w,k,G)=>G.indexOf(w)!==k);return v.length>0?{isValid:!1,errorMessage:`Certaines dates sont en double: ${v.map(k=>{try{return new Date(k).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return k}}).join(", ")}`}:{isValid:!0}}async function _e(){const o=qe();if(!o.isValid)return Q.error(o.errorMessage||"Erreur de validation"),!1;e(we);const v=Array.from(new Set(e(S).map(F=>F.date))).sort(),w=e(u)?.teams||[],k=e(u)?.teamsId||[],G=new Map(k.map((F,H)=>[F,w[H]]));e(Ne).map(F=>It.getTeamById(F)?.name||G.get(F)||F);const he={name:e(ae),description:e(A),status:e(E),minContrib:e(ne),allDates:v,dateStart:v.length>0?v[0]:"",dateEnd:v.length>0?v[v.length-1]:"",meals:e(S)};try{return await Je.updateEvent(e(M),he),!0}catch(F){return console.error("Erreur sauvegarde:",F),Q.error("Erreur lors de la sauvegarde"),!1}}async function be(){if(!e(M)||e(I)||!e(Z))return;s(I,!0);const o=Q.loading("Sauvegarde automatique...");if(await _e())await z(),Q.update(o,{state:"success",message:"Modifications sauvegard√©es automatiquement"});else{if(e(M)&&ve.userId)try{await ut.acquireLock(e(M),ve.userId,ve.userName)}catch(w){console.error("Erreur heartbeat lock:",w)}Q.update(o,{state:"warning",message:"Impossible de sauvegarder : modifications invalides"})}s(I,!1),setTimeout(()=>Q.dismiss(o),3e3)}async function V(){s(I,!0),await _e()&&(await z(),Q.success("√âv√©nement mis √† jour")),s(I,!1)}let O=null;function j(){O&&clearTimeout(O),O=setTimeout(()=>{be()},300*1e3),console.log("‚è∞ Auto-save programm√© dans 30 secondes")}at(()=>{const o=e(Z),v=e(Pe),w=k=>{(o||v)&&(k.preventDefault(),k.returnValue="Vous avez des modifications non sauvegard√©es. Voulez-vous vraiment quitter ?")};return window.addEventListener("beforeunload",w),()=>{window.removeEventListener("beforeunload",w)}});async function B(o){await b()&&s(ae,o.target.value,!0)}async function X(){if(!await b())return;const o=ht(6);let v;if(e(S).length===0){const k=new Date;k.setDate(k.getDate()+7),k.setHours(20,0,0,0),v=k.toISOString()}else{const k=e(S)[e(S).length-1],G=new Date(k.date);G.getHours()<14?G.setHours(20,0,0,0):(G.setDate(G.getDate()+1),G.setHours(12,0,0,0)),v=G.toISOString()}const w={id:o,date:v,guests:100,recipes:[]};s(m,[...e(m),w],!0),s(ce,o,!0)}function J(o){s(m,e(m).filter(v=>v.id!==o),!0)}function ee(o){s(ce,e(ce)===o?null:o,!0)}async function te(o){if(!(!e(M)||!ve.userId))try{s(I,!0);const v=o?"accepted":"declined";await Je.updateContributorStatus(e(M),ve.userId,v),Q.success(o?"Invitation accept√©e":"Invitation d√©clin√©e")}catch(v){console.error("Erreur r√©ponse invitation:",v),Q.error("Erreur lors de la r√©ponse")}finally{s(I,!1)}}async function re(){await b()&&(s(E,"confirmed"),s(Te,!1))}async function pe(){await b()&&(s(E,"canceled"),s(se,!1))}var Se=Ln(),T=le(Se),y=a(T),D=a(y),l=a(D);{var c=o=>{var v=xn();Ke(v),v.__input=B,C(()=>{qt(v,e(ae)),v.disabled=!e(U)}),dt("focus",v,b),dt("blur",v,()=>s(ye,!1)),i(o,v)},p=o=>{var v=yn();v.__click=()=>s(ye,!e(ye));var w=a(v),k=a(w),G=a(k,!0);t(k);var he=r(k,2);xt(he,{class:"h-4 w-4"}),t(w),t(v),C(()=>{v.disabled=!e(U),W(G,e(ae)||"Nom de l'√©v√©nement")}),i(o,v)};x(l,o=>{e(ye)?o(c):o(p,!1)})}t(D);var g=r(D,2);{var h=o=>{va(o,{get currentEvent(){return e(u)}})};x(g,o=>{e(u)&&o(h)})}t(y);var _=r(y,2);{var P=o=>{var v=Mn(),w=a(v),k=a(w);ft(k,{legend:"Description",children:(F,H)=>{var xe=Ze(),Oe=le(xe);{var st=je=>{var Ee=wn(),de=le(Ee);Nt(de);var Le=r(de,2),Fe=a(Le);t(Le),C(()=>{de.disabled=!e(U),W(Fe,`${e(A).length??""}/3000 caract√®res`)}),dt("focus",de,b),dt("blur",de,()=>s(ge,!1)),tt(de,()=>e(A),rt=>s(A,rt)),i(je,Ee)},Qe=je=>{var Ee=Tn();Ee.__click=()=>s(ge,!0);var de=a(Ee),Le=a(de),Fe=a(Le);{var rt=He=>{var it=kn(),oe=a(it,!0);t(it),C(()=>W(oe,e(A))),i(He,it)},Ye=He=>{var it=En();i(He,it)};x(Fe,He=>{e(A)?He(rt):He(Ye,!1)})}t(Le);var Ue=r(Le,2);xt(Ue,{class:"h-4 w-4 shrink-0"}),t(de),t(Ee),C(()=>Ee.disabled=!e(U)),i(je,Ee)};x(Oe,je=>{e(ge)?je(st):je(Qe,!1)})}i(F,xe)},$$slots:{default:!0}}),t(w);var G=r(w,2),he=a(G);ft(he,{legend:"Statut de l'√©v√©nement",children:(F,H)=>{var xe=Cn(),Oe=a(xe);fa(Oe,{get status(){return e(E)}});var st=r(Oe,2);{var Qe=Ee=>{var de=In(),Le=le(de);Le.__click=()=>s(Te,!0);var Fe=r(Le,2);Fe.__click=()=>s(se,!0),C(()=>{Le.disabled=!e(U),Fe.disabled=!e(U)}),i(Ee,de)},je=Ee=>{var de=Ze(),Le=le(de);{var Fe=Ye=>{var Ue=Sn();Ue.__click=()=>s(se,!0),C(()=>Ue.disabled=!e(U)),i(Ye,Ue)},rt=Ye=>{var Ue=Dn();Ue.__click=async()=>{await b()&&s(E,"proposition")},C(()=>Ue.disabled=!e(U)),i(Ye,Ue)};x(Le,Ye=>{e(E)==="confirmed"?Ye(Fe):Ye(rt,!1)},!0)}i(Ee,de)};x(st,Ee=>{e(E)==="proposition"?Ee(Qe):Ee(je,!1)})}t(xe),i(F,xe)},$$slots:{default:!0}}),t(G),t(v),i(o,v)};x(_,o=>{e(Y)&&o(P)})}var L=r(_,2);la(L,{get currentEvent(){return e(u)},get isBusy(){return e(I)},onRespond:te});var ue=r(L,2);{var De=o=>{var v=zn();i(o,v)},Ae=o=>{var v=jn(),w=a(v),k=a(w);{var G=oe=>{ft(oe,{legend:"Participants",get iconComponent(){return nt},children:(Ce,Re)=>{var We=Pn(),ot=a(We);ia(ot,{class:"h-5 w-5"}),ie(2),t(We),i(Ce,We)},$$slots:{default:!0}})},he=oe=>{{let Ce=N(()=>ve.userId||"");Ua(oe,{get canEdit(){return e(U)},get contributors(){return e(we)},get nativeTeamsStore(){return It},get eventsStore(){return Je},get userId(){return e(Ce)},get eventId(){return e(M)},onStartEdit:b,get minContrib(){return e(ne)},set minContrib(Re){s(ne,Re,!0)}})}};x(k,oe=>{e(u)&&lt(e(u).$id)?oe(G):oe(he,!1)})}var F=r(k,2);{var H=oe=>{{let Ce=N(()=>!e(U)||e(Ie));bn(oe,{get event(){return e(u)},get contributors(){return e(we)},get disabled(){return e(Ce)}})}};x(F,oe=>{e(u)&&oe(H)})}t(w);var xe=r(w,2),Oe=a(xe);{var st=oe=>{var Ce=Nn(),Re=a(Ce);oa(Re,{class:"h-6 w-6 shrink-0"}),ie(2),t(Ce),i(oe,Ce)};x(Oe,oe=>{e(Ie)&&oe(st)})}var Qe=r(Oe,2),je=a(Qe),Ee=a(je);t(je);var de=r(je,2);de.__click=X;var Le=a(de);gt(Le,{class:"mr-1 h-4 w-4"}),ie(),t(de),t(Qe);var Fe=r(Qe,2);{var rt=oe=>{var Ce=qn(),Re=a(Ce),We=a(Re);Et(We,{class:"h-8 w-8 opacity-50"}),t(Re),ie(4),t(Ce),i(oe,Ce)},Ye=oe=>{var Ce=On();Ge(Ce,29,()=>e(S),Re=>Re.id+"-"+e(u)?.$updatedAt,(Re,We)=>{var ot=An(),Vt=a(ot);{let Ut=N(()=>e(ce)===e(We).id),Gt=N(()=>e(m).map(ct=>ct.date)),Ft=N(()=>!e(U)||e(Ie));Zt(Vt,{get isEditing(){return e(Ut)},onEditToggle:async()=>{await b()&&ee(e(We).id||"")},onDelete:()=>J(e(We).id||""),get allDates(){return e(Gt)},get disabled(){return e(Ft)},get meal(){return e(m)[e(m).findIndex(ct=>ct.id===e(We).id)]},set meal(ct){e(m)[e(m).findIndex(Ht=>Ht.id===e(We).id)]=ct}})}t(ot),Xt(ot,()=>$t,()=>({delay:100,duration:400})),i(Re,ot)}),t(Ce),i(oe,Ce)};x(Fe,oe=>{e(S).length===0?oe(rt):oe(Ye,!1)})}var Ue=r(Fe,2),He=a(Ue);He.__click=X;var it=a(He);gt(it,{class:"mr-1 h-4 w-4"}),ie(),t(He),t(Ue),t(xe),t(v),C(()=>{W(Ee,`Repas & Menus (${e(S).length??""})`),de.disabled=!e(U),He.disabled=!e(U)}),i(o,v)};x(ue,o=>{e(I)&&!e(Y)?o(De):o(Ae,!1)})}t(T);var fe=r(T,2);Mt(fe,{get isOpen(){return e(Te)},title:"Confirmer l'√©v√©nement",message:"√ätes-vous s√ªr de vouloir confirmer cet √©v√©nement ? ",variant:"info",confirmLabel:"Confirmer",cancelLabel:"Annuler",onConfirm:re,onCancel:()=>s(Te,!1)});var me=r(fe,2);Mt(me,{get isOpen(){return e(se)},title:"Annuler la confirmation",message:"√ätes-vous s√ªr de vouloir annuler cet √©v√©nement ?.",variant:"warning",confirmLabel:"Oui, annuler",cancelLabel:"Non, garder",onConfirm:pe,onCancel:()=>s(se,!1)});var Ve=r(me,2);{let o=N(()=>`/event/${e(M)}`);ua(Ve,{get routeKey(){return e(o)},shouldProtect:()=>e(Pe),onLeaveWithoutSave:R,onSaveAndLeave:ke,message:"Vous avez des modifications non sauvegard√©es. Voulez-vous vraiment quitter ?"})}i($e,Se),pt()}_t(["click","input"]);export{as as default};
