import{B as _t,d as bt,p as Ye,y as q,z as mt,J as et,A as n,m as e,v as c,k as ve,K as b,h as a,g as r,u as z,b as i,w as T,S as lt,T as nt,x as J,j as Xe,e as Je,i as dt,U as Nt,al as Ht,c as pt,ak as ht,O as ne,o as t,G as ee,W as Ke,am as Pt,M as wt,C as at,I as oe,ab as Wt,_ as He,ag as Kt,af as At,ad as qt,ai as Tt,aF as Jt,aG as it,aH as ut,Y as Qt,D as Yt,F as It,an as Xt}from"./appwrite.js";import{E as Zt,f as $t}from"./EventMealCard.js";import{M as zt,b as Ot,c as Lt,d as jt,n as Dt}from"./index.js";import{F as ft}from"./Fieldset.js";import{aI as yt,a2 as ea,M as ta,c as gt,U as st,G as xt,ax as Et,aJ as aa,af as na,t as kt,aH as sa,aK as Ct,as as St,a4 as Bt,aL as ra,i as ia,T as oa,_ as la,b as da}from"./icons.js";import{E as va}from"./EventInvitationAlert.js";import{c as ca}from"./event-stats-helpers.js";import{E as ua}from"./EventStats.js";import"./CheckboxBadge.js";import{B as fa}from"./BtnGroupCheck.js";import{U as ma}from"./UnsavedChangesGuard.js";import{C as Mt}from"./ConfirmModal.js";import"./keyboardNavigation.svelte.js";import"./products-display.js";import"./date-helpers.js";import"./index2.js";var ga=c('<label class="input w-56"><span class="label">Minimum</span> <input type="number" min="1" class="grow" id="min-contrib-input"/></label>'),_a=c('<button class="btn justify-start"><div class="flex items-center gap-4"><span class="label">minimum</span> <span class="text-lg"> </span> <!></div></button>'),ba=c('<div class="badge badge-primary badge-soft badge-lg gap-2 p-3"><!> <span class="font-medium"> </span></div>'),pa=c('<fieldset class="fieldset"><legend class="legend">√âquipes invit√©es</legend> <div class="flex flex-wrap gap-2"></div></fieldset>'),ha=c('<div class="badge badge-soft badge-success gap-2 p-3"><span class="font-medium"> </span></div>'),ya=c('<fieldset class="fieldset"><legend class="legend">Participant confirm√©</legend> <div class="flex flex-wrap gap-2"></div></fieldset>'),xa=c('<div class="badge badge-warning badge-soft gap-2 p-3"><span class="font-medium"> </span></div>'),Ea=c('<fieldset class="fieldset"><legend class="text-base-content/70 text-sm font-medium">Invit√©¬∑es</legend> <div class="flex flex-wrap gap-2"></div></fieldset>'),wa=c('<div class="my-2"><button class="btn btn-primary btn-outline btn-block gap-1"><!> Inviter des participant¬∑es</button></div>'),ka=c('<fieldset class="fieldset mb-4"><!> <div class="fieldset-label ms-1">Combien faudrait-il √™tre pour tout g√©rer ?</div></fieldset> <div class="mb-6"><div class="space-y-4"><!> <!> <!></div></div> <!>',1),Ta=c('<p class="text-error mt-1 text-xs"> </p>'),Ia=c("<p> </p>"),Da=c('<div class="badge badge-primary badge-soft badge-lg"><!> </div>'),Ca=c('<div class="mb-4"><p class="mb-2 text-sm font-medium opacity-70">√âquipes d√©j√† invit√©es :</p> <div class="flex flex-wrap gap-2"></div></div>'),Sa=c('<label class="hover:bg-secondary/20 bg-secondary/10 flex cursor-pointer items-center gap-3 rounded-lg px-4 py-2 transition-colors"><input type="checkbox" class="checkbox bg-base-100 checkbox-sm"/> <div class="flex flex-col"><span class="text-sm font-medium"> <span class="text-xs opacity-60"> </span></span> <div class="text-xs opacity-70"> </div></div></label>'),Ma=c(`<label class="mt-4 cursor-pointer justify-center gap-4"><input type="checkbox" class="checkbox checkbox-sm"/> <span class="font-base ms-1">Envoyer un email de notification</span></label> <p class="text-base-content/60 mt-1 text-xs">Si d√©sactiv√©, les membres auront acc√®s √† l'√©v√©nement mais ne
                recevront pas d'email. Les personnes invit√©es n'ayant pas de
                compte recevront toujours un email pour la cr√©ation de leur
                compte.</p>`,1),Na=c('<div class="flex flex-wrap gap-4"></div> <!>',1),Pa=c('<p class="text-sm italic opacity-60">Toutes vos √©quipes sont d√©j√† invit√©es.</p>'),Aa=c(`<p class="text-sm italic opacity-60">Vous ne faites partie d'aucune √©quipe. Cr√©ez une √©quipe pour inviter
            plusieurs personnes.</p>`),qa=c(`<div class="space-y-6"><fieldset class="fieldset"><legend class="legend">Par email</legend> <div class="flex gap-2"><label class="input flex items-center gap-2"><!> <input type="email" class="grow" placeholder="email@exemple.com"/></label> <button class="btn btn-primary"><!> Ajouter</button></div> <!> <div></div></fieldset> <div class="divider">OU</div> <fieldset class="fieldset"><legend class="fieldset-legend"><!> Inviter des √©quipes
          enti√®res</legend> <!> <!></fieldset></div>`),za=c('<button class="btn">Annuler</button> <button class="btn btn-primary"><!> Inviter <!></button>',1),Oa=c("<!> <!> <!>",1),La=c("<!> <!>",1);function ja(Ze,s){bt(s,!0);let Ve=Ye(s,"minContrib",15);Ye(s,"userId",3,"");let m=Ye(s,"eventId",3,""),h=Ye(s,"onStartEdit",3,()=>{}),N=q(mt([])),O=q(mt([])),x=q(!1),Q=q(!1),I=q(!1);et(()=>{if(m()){const u=s.eventsStore.getEventById(m());if(u&&u.teams){const v=u.teams||[],S=[];for(const G of v){const Z=s.nativeTeamsStore.teams.find(P=>P.name===G);Z&&S.push(Z.$id)}n(N,S,!0)}}}),et(()=>{e(Q)||n(O,[],!0)});let V=q(""),w=q(null),se=z(()=>s.contributors.filter(u=>u.status==="accepted")),X=z(()=>s.contributors.filter(u=>u.status==="invited"));function ge(u){e(N).includes(u)?n(N,e(N).filter(v=>v!==u),!0):n(N,[...e(N),u],!0)}function ye(){if(!e(V))return;const u=e(V).trim();if(s.contributors.some(S=>S.email===u)||e(O).some(S=>S.email===u)){n(w,"Cet email est d√©j√† invit√©.");return}n(w,null);const v={id:ht(),email:u,status:"invited",invitedAt:new Date().toISOString()};n(O,[...e(O),v],!0),n(V,"")}async function _e(){if(!m()){ne.error("ID d'√©v√©nement manquant");return}const u=s.eventsStore.getEventById(m());if(!u)throw new Error("√âv√©nement introuvable");const v=e(N).filter(G=>{const Z=s.nativeTeamsStore.teams.find(P=>P.$id===G);return Z?!u.teams?.includes(Z.name):!1}),S=e(O).map(G=>G.email).filter(Boolean);if(v.length===0&&S.length===0){ne.warning("S√©lectionnez au moins une √©quipe ou entrez un email");return}try{await ne.track(s.eventsStore.inviteParticipants(m(),{teamIds:v,emails:S,sendEmailToExistingMembers:e(x)}),{loading:"Envoi des invitations en cours...",success:"invitation envoy√© avec succ√®s",error:"Erreur lors de l'envoi des invitations"}),n(Q,!1),n(O,[],!0)}catch(G){console.error("Erreur lors de l'envoi des invitations:",G)}}function be(){n(Q,!1),n(V,""),n(w,null)}let te=z(()=>()=>{if(!m())return[];const u=s.eventsStore.getEventById(m());return u?e(N).filter(v=>{const S=s.nativeTeamsStore.teams.find(G=>G.$id===v);return S?!u.teams?.includes(S.name):!1}):[]});var De=La(),ke=ve(De);ft(ke,{legend:"Participants",children:(u,v)=>{var S=ka(),G=ve(S),Z=a(G);{var P=_=>{var g=ga(),p=r(a(g),2);p.defaultValue=1,t(g),T(()=>p.disabled=!s.canEdit),lt("focus",p,function(...j){h()?.apply(this,j)}),lt("blur",p,()=>n(I,!1)),nt(p,Ve),i(_,g)},ae=_=>{var g=_a();g.__click=()=>{n(I,!0),setTimeout(()=>{document.getElementById("min-contrib-input")?.focus()},50)};var p=a(g),j=r(a(p),2),F=a(j,!0);t(j);var B=r(j,2);yt(B,{class:"h-4 w-4"}),t(p),t(g),T(()=>{g.disabled=!s.canEdit,J(F,Ve()||1)}),i(_,g)};b(Z,_=>{e(I)?_(P):_(ae,!1)})}ee(2),t(G);var Ce=r(G,2),H=a(Ce),ce=a(H);{var xe=_=>{const g=z(()=>s.eventsStore.getEventById(m()));var p=Xe(),j=ve(p);{var F=B=>{var K=pa(),fe=r(a(K),2);Je(fe,21,()=>e(g).teams,dt,(Se,Ie)=>{var D=ba(),d=a(D);st(d,{class:"inline size-4"});var f=r(d,2),y=a(f,!0);t(f),t(D),T(()=>J(y,e(Ie))),i(Se,D)}),t(fe),t(K),i(B,K)};b(j,B=>{e(g)&&e(g).teams&&e(g).teams.length>0&&B(F)})}i(_,p)};b(ce,_=>{m()&&_(xe)})}var Te=r(ce,2);{var ue=_=>{var g=ya(),p=r(a(g),2);Je(p,21,()=>e(se),j=>j.id,(j,F)=>{var B=ha(),K=a(B),fe=a(K,!0);t(K),t(B),T(()=>J(fe,e(F).name||e(F).email)),i(j,B)}),t(p),t(g),i(_,g)};b(Te,_=>{e(se).length>0&&_(ue)})}var le=r(Te,2);{var L=_=>{var g=Ea(),p=r(a(g),2);Je(p,21,()=>e(X),j=>j.id,(j,F)=>{var B=xa(),K=a(B),fe=a(K,!0);t(K),t(B),T(()=>J(fe,e(F).name||e(F).email)),i(j,B)}),t(p),t(g),i(_,g)};b(le,_=>{e(X).length>0&&_(L)})}t(H),t(Ce);var R=r(Ce,2);{var W=_=>{var g=wa(),p=a(g);p.__click=()=>n(Q,!0);var j=a(p);ea(j,{class:"mr-2 h-4 w-4"}),ee(),t(p),t(g),i(_,g)};b(R,_=>{m()&&_(W)})}i(u,S)},$$slots:{default:!0}});var je=r(ke,2);zt(je,{get isOpen(){return e(Q)},onClose:be,children:(u,v)=>{var S=Oa(),G=ve(S);Ot(G,{title:"Inviter des participants",onClose:be});var Z=r(G,2);Lt(Z,{children:(ae,Ce)=>{var H=qa(),ce=a(H),xe=r(a(ce),2),Te=a(xe),ue=a(Te);ta(ue,{class:"h-4 w-4 opacity-70"});var le=r(ue,2);Ke(le),le.__keydown=D=>D.key==="Enter"&&ye(),t(Te);var L=r(Te,2);L.__click=ye;var R=a(L);gt(R,{class:"h-4 w-4 opacity-70"}),ee(),t(L),t(xe);var W=r(xe,2);{var _=D=>{var d=Ta(),f=a(d,!0);t(d),T(()=>J(f,e(w))),i(D,d)};b(W,D=>{e(w)&&D(_)})}var g=r(W,2);Je(g,21,()=>e(O),dt,(D,d)=>{var f=Ia(),y=a(f,!0);t(f),T(()=>J(y,e(d).email)),i(D,f)}),t(g),t(ce);var p=r(ce,4),j=a(p),F=a(j);st(F,{size:16,class:"inline shrink-0 opacity-60"}),ee(),t(j);var B=r(j,2);{var K=D=>{const d=z(()=>s.eventsStore.getEventById(m()));var f=Xe(),y=ve(f);{var U=M=>{var A=Ca(),re=r(a(A),2);Je(re,21,()=>e(d).teams,dt,(Ae,Be)=>{var Me=Da(),qe=a(Me);st(qe,{class:"inline size-4"});var pe=r(qe,1,!0);t(Me),T(()=>J(pe,e(Be))),i(Ae,Me)}),t(re),t(A),i(M,A)};b(y,M=>{e(d)&&e(d).teams&&e(d).teams.length>0&&M(U)})}i(D,f)};b(B,D=>{m()&&D(K)})}var fe=r(B,2);{var Se=D=>{const d=z(()=>s.nativeTeamsStore.myTeams.filter(A=>{if(!m())return!0;const re=s.eventsStore.getEventById(m());return!re||!re.teams?!0:!re.teams.includes(A.name)}));var f=Xe(),y=ve(f);{var U=A=>{var re=Na(),Ae=ve(re);Je(Ae,21,()=>e(d),dt,(qe,pe)=>{var Ne=Sa(),Le=a(Ne);Ke(Le),Le.__change=()=>ge(e(pe).$id);var o=r(Le,2),l=a(o),E=a(l),C=r(E),ie=a(C);t(C),t(l);var ze=r(l,2),$=a(ze,!0);t(ze),t(o),t(Ne),T((Y,Ee)=>{Pt(Le,Y),J(E,`${e(pe).name??""} `),J(ie,`${e(pe).total??""} membre${e(pe).total>1?"s":""}`),J($,Ee)},[()=>e(N).includes(e(pe).$id),()=>s.nativeTeamsStore.getTeamMemberNames(e(pe).$id).join(", ")]),i(qe,Ne)}),t(Ae);var Be=r(Ae,2);{var Me=qe=>{var pe=Ma(),Ne=ve(pe),Le=a(Ne);Ke(Le),ee(2),t(Ne),ee(2),Ht(Le,()=>e(x),o=>n(x,o)),i(qe,pe)};b(Be,qe=>{e(N).length>0&&qe(Me)})}i(A,re)},M=A=>{var re=Pa();i(A,re)};b(y,A=>{e(d).length>0?A(U):A(M,!1)})}i(D,f)},Ie=D=>{var d=Aa();i(D,d)};b(fe,D=>{s.nativeTeamsStore.myTeams.length>0?D(Se):D(Ie,!1)})}t(p),t(H),T(()=>L.disabled=!e(V)),nt(le,()=>e(V),D=>n(V,D)),i(ae,H)}});var P=r(Z,2);jt(P,{children:(ae,Ce)=>{var H=za(),ce=ve(H);ce.__click=be;var xe=r(ce,2);xe.__click=_e;var Te=a(xe);xt(Te,{class:"mr-2 h-4 w-4"});var ue=r(Te,2);{var le=L=>{var R=Nt();T(W=>J(R,`(${W??""})`),[()=>e(te)().length+e(O).length]),i(L,R)};b(ue,L=>{(e(te)().length>0||e(O).length>0)&&L(le)})}t(xe),T(L=>xe.disabled=L,[()=>e(O).length===0&&e(te)().length===0]),i(ae,H)}}),i(u,S)},$$slots:{default:!0}}),i(Ze,De),pt()}_t(["click","keydown","change"]);var Ba=c('<div class="flex items-center gap-2"><!> <span> </span></div>'),Ua=c('<div class="flex items-center gap-2"><!> <span>A r√©aliser avant le :</span> <span class="font-medium"> </span></div>'),Va=c("<div><div><span> </span></div></div>"),Ra=c('<div><div class="bg-base-300 text-base-content w-7 rounded-full"><span class="text-base"> </span></div></div>'),Fa=c('<span class="text-warning mx-1 text-base italic">Non assign√©</span>'),Ga=c('<p class="text-base-content/60 mt-1 line-clamp-2 text-sm"> </p>'),Ha=c("<button><!> Fait <!></button>"),Wa=c(`<button class="btn btn-primary btn-outline btn-sm gap-1" title="Me porter volontaire pour cette t√¢che"><!> <span>M'inscrire</span></button>`),Ka=c('<button class="btn btn-error btn-sm btn-outline gap-1" title="Quitter cette t√¢che"><!> <span>me d√©sinscrire</span></button>'),Ja=c('<div><div class="flex flex-col gap-3"><div class="flex min-w-0 items-start gap-3"><div class="flex min-w-0 grow flex-col gap-4"><div class="flex flex-wrap items-start justify-between gap-x-4 gap-y-2"><div> </div> <div><!> <!> <!></div></div>  <div class="flex items-center gap-2"><!> <div class="flex min-w-0 items-center gap-1"><div class="flex flex-wrap gap-2"><!> <!> <!></div> <span> </span></div></div> <!></div></div></div> <div class="mt-4 flex items-center justify-between gap-2"><div class="flex gap-2"><!></div> <div class="ms-auto flex gap-2"><!> <button class="btn btn-sm btn-square" title="Modifier la t√¢che"><!></button></div></div></div>');function Qa(Ze,s){bt(s,!0);let Ve=Ye(s,"disabled",3,!1),m=Ye(s,"contributors",19,()=>[]),h=q(!1);const N=z(()=>Array.isArray(s.todo.assignedTo)?s.todo.assignedTo:[]),O=z(()=>oe.userId&&e(N).includes(oe.userId)),x=z(()=>s.todo.assignedTo?s.todo.assignedTo.map(d=>{const f=m().find(M=>M.id===d),y=d===oe.userId,U=f?.name||(y?"Moi":d.substring(0,5));return{userId:d,name:U,isCurrentUser:y}}):[]),Q=z(()=>e(x).length>=(s.todo.requiredPeopleNb||1)),I=z(()=>{switch(s.todo.taskOn){case"beforeEvent":return{bg:"bg-accent/30",icon:na,label:"Avant l'√©v√©nement"};case"afterEvent":return{bg:"bg-secondary/10",icon:aa,label:"Apr√®s l'√©v√©nement"};default:return{bg:"bg-secondary/20",icon:Et,label:"Pendant l'√©v√©nement"}}});async function V(){if(e(h)||Ve())return;const f=s.todo.status==="done"?"todo":"done";n(h,!0);try{await He.updateTodo(s.eventId,s.todo.id,{status:f})}catch{ne.error("Erreur m√†j statut")}finally{n(h,!1)}}async function w(){if(!oe.userId||e(h))return;const d=e(O)?e(N).filter(f=>f!==oe.userId):[...e(N),oe.userId];n(h,!0);try{await He.updateTodo(s.eventId,s.todo.id,{assignedTo:d.length>0?d:null}),ne.success(e(O)?"Vous avez rejoint la t√¢che":"Vous avez quitt√© la t√¢che")}catch{ne.error("Erreur assignation")}finally{n(h,!1)}}var se=Ja();let X;var ge=a(se),ye=a(ge),_e=a(ye),be=a(_e),te=a(be),De=a(te,!0);t(te);var ke=r(te,2),je=a(ke);{var u=d=>{};b(je,d=>{s.todo.priority&&s.todo.priority!=="low"&&d(u)})}var v=r(je,2);{var S=d=>{var f=Ba(),y=a(f);Wt(y,()=>e(I).icon,(A,re)=>{re(A,{class:"size-4 shrink-0 opacity-70"})});var U=r(y,2),M=a(U,!0);t(U),t(f),T(()=>J(M,e(I).label)),i(d,f)};b(v,d=>{s.todo.taskOn&&d(S)})}var G=r(v,2);{var Z=d=>{var f=Ua(),y=a(f);kt(y,{class:"size-4 shrink-0 opacity-70"});var U=r(y,4),M=a(U,!0);t(U),t(f),T(A=>J(M,A),[()=>new Date(s.todo.dueDate).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})]),i(d,f)};b(G,d=>{s.todo.dueDate&&d(Z)})}t(ke),t(be);var P=r(be,2),ae=a(P);st(ae,{class:"mt-1 mb-auto size-4 shrink-0 opacity-60"});var Ce=r(ae,2),H=a(Ce),ce=a(H);Je(ce,19,()=>e(x).slice(0,3),d=>d.userId,(d,f)=>{var y=Va(),U=a(y),M=a(U),A=a(M,!0);t(M),t(U),t(y),T(()=>{wt(y,"title",e(f).name+(e(f).isCurrentUser?" (vous)":"")),at(U,1,`badge badge-soft badge-info ${(e(f).isCurrentUser&&"ring-info font-semibold ring-1")??""}`),J(A,e(f).name)}),i(d,y)});var xe=r(ce,2);{var Te=d=>{var f=Ra(),y=a(f),U=a(y),M=a(U);t(U),t(y),t(f),T(()=>{wt(f,"title",`+${e(x).length-3} autres`),J(M,`+${e(x).length-3}`)}),i(d,f)};b(xe,d=>{e(x).length>3&&d(Te)})}var ue=r(xe,2);{var le=d=>{var f=Fa();i(d,f)};b(ue,d=>{e(x).length===0&&d(le)})}t(H);var L=r(H,2),R=a(L);t(L),t(Ce),t(P);var W=r(P,2);{var _=d=>{var f=Ga(),y=a(f,!0);t(f),T(()=>J(y,s.todo.taskDescription)),i(d,f)};b(W,d=>{s.todo.taskDescription&&d(_)})}t(_e),t(ye),t(ge);var g=r(ge,2),p=a(g),j=a(p);{var F=d=>{var f=Ha();f.__click=V;var y=a(f);{let A=z(()=>s.todo.status!=="done"&&"opacity-60");xt(y,{get class(){return`size-4 ${e(A)??""}`}})}var U=r(y,2);{var M=A=>{var re=Nt("?");i(A,re)};b(U,A=>{s.todo.status!=="done"&&A(M)})}t(f),T(()=>{at(f,1,`btn btn-sm ${s.todo.status!=="done"?"btn-dash":"btn-success"}`),wt(f,"title",s.todo.status==="done"?"Marquer √† faire":"Marquer fait"),f.disabled=Ve()}),i(d,f)};b(j,d=>{s.todo.taskOn==="beforeEvent"&&d(F)})}t(p);var B=r(p,2),K=a(B);{var fe=d=>{var f=Wa();f.__click=w;var y=a(f);xt(y,{class:"size-4"}),ee(2),t(f),i(d,f)},Se=d=>{var f=Xe(),y=ve(f);{var U=M=>{var A=Ka();A.__click=w;var re=a(A);sa(re,{class:"size-4"}),ee(2),t(A),i(M,A)};b(y,M=>{e(O)&&M(U)},!0)}i(d,f)};b(K,d=>{e(O)?d(Se,!1):d(fe)})}var Ie=r(K,2);Ie.__click=()=>s.onEdit(s.todo);var D=a(Ie);yt(D,{class:"size-4"}),t(Ie),t(B),t(g),t(se),T(()=>{X=at(se,1,`group bg-base-200/50 relative rounded-xl p-4 shadow transition-all ${e(Q)?"shadow-success/40 ":"shadow-warning/40 "}`,null,X,{"opacity-50":e(h)}),at(te,1,`text-base font-medium ${s.todo.status==="done"?"line-through opacity-50":""}`),J(De,s.todo.taskName),at(ke,1,`card card-sm ${e(I).bg??""} ms-auto flex flex-col justify-end px-4 py-1`),at(L,1,`mx-1 ${e(x).length<(s.todo.requiredPeopleNb||1)?"text-warning":"text-success"} font-medium`),J(R,`${e(x).length??""}/${(s.todo.requiredPeopleNb||1)??""} pers. requise`)}),i(Ze,se),pt()}_t(["click"]);var Ya=c('<div role="tablist" class="tabs tabs-border tabs-lg mb-4"><button role="tab"><!> T√¢che individuelle</button> <button role="tab"><!> T√¢ches pr√©d√©finies</button></div>'),Xa=c('<span class="badge badge-warning badge-sm"> </span>'),Za=c('<span class="badge badge-success badge-sm flex items-center gap-1"><!> ok</span>'),$a=c(`<div class="space-y-4"><fieldset class="fieldset"><legend class="fieldset-legend">Titre</legend> <label class="input w-full"><input type="text" placeholder="Ex: Acheter du pain, Pr√©parer la salle..." class="grow"/></label></fieldset> <fieldset class="fieldset"><legend class="fieldset-legend flex items-center gap-2"><!> Description</legend> <textarea class="textarea h-24 w-full" placeholder="D√©tails suppl√©mentaires..."></textarea></fieldset> <div class="flex flex-wrap gap-4"><fieldset class="fieldset w-80"><legend class="fieldset-legend flex items-center gap-2"><!> Moment</legend> <select class="select w-full"><option>Avant l'√©v√©nement</option><option>Pendant l'√©v√©nement</option><option>Apr√®s l'√©v√©nement</option></select></fieldset> <fieldset class="fieldset w-80"><legend class="fieldset-legend flex items-center gap-2"><!> √âch√©ance</legend> <label class="input w-full"><input type="date" class="grow"/></label></fieldset> <fieldset class="fieldset"><legend class="fieldset-legend flex items-center gap-2"><!> Personnes requises</legend> <label class="input w-full"><input type="number" min="1" class="grow"/></label></fieldset></div> <fieldset class="fieldset"><legend class="fieldset-legend flex items-center gap-2"><!> <!></legend> <!></fieldset></div>`),en=c('<div class="bg-base-100 flex items-center gap-4 rounded-lg p-3"><input type="checkbox" class="checkbox checkbox-primary"/> <input type="text" class="input flex-1"/> <div class="flex items-center gap-2"><!> <input type="number" class="input w-20" min="1"/></div></div>'),tn=c('<div class="collapse-arrow bg-base-200 collapse"><input type="checkbox" checked/> <div class="collapse-title flex items-center gap-2 text-base font-medium"><!> </div> <div class="collapse-content"><div class="mt-4 space-y-3"></div></div></div>'),an=c('<div class="space-y-6"></div>'),nn=c("<!> <!>",1),sn=c('<span class="loading loading-spinner loading-sm"></span>'),rn=c('<button type="button" class="btn btn-primary"><!> Cr√©er les t√¢ches s√©lectionn√©es</button>'),on=c('<button type="button" class="btn btn-ghost"><!> Sauvegarder & Cr√©er</button>'),ln=c('<span class="loading loading-spinner loading-sm"></span>'),dn=c('<!> <button type="button" class="btn btn-primary"><!> </button>',1),vn=c("<!> <!> <!>",1);function cn(Ze,s){bt(s,!0);let Ve=Ye(s,"contributors",19,()=>[]);Ye(s,"currentTodos",19,()=>[]);let m=q(""),h=q(""),N=q("medium"),O=q("onEvent"),x=q(1),Q=q(""),I=q(mt([])),V=q(!1),w=q("individual");const se={beforeEvent:["Gestion de l'approvisionnement / courses","Choix des recettes/menus","Coordination","Communication (mail, texto, affiches)","Gestion matos"],onEvent:["Pr√©parations des recettes","Service","Rangement","Vaisselle","Gestion des restes"],afterEvent:["Retour matos","D√©montage cuisine"]},X=z(()=>s.todoToEdit?{taskName:s.todoToEdit.taskName,taskDescription:s.todoToEdit.taskDescription||"",priority:s.todoToEdit.priority||"medium",taskOn:s.todoToEdit.taskOn||"onEvent",requiredPeopleNb:s.todoToEdit.requiredPeopleNb||1,dueDate:s.todoToEdit.dueDate?s.todoToEdit.dueDate.split("T")[0]:"",assignedTo:s.todoToEdit.assignedTo?[...s.todoToEdit.assignedTo]:[]}:{taskName:"",taskDescription:"",priority:"medium",taskOn:"onEvent",requiredPeopleNb:1,dueDate:"",assignedTo:[]});et(()=>{if(s.open){s.todoToEdit?n(w,"individual"):n(w,"individual");const u=e(X);n(m,u.taskName,!0),n(h,u.taskDescription,!0),n(N,u.priority,!0),n(O,u.taskOn,!0),n(x,u.requiredPeopleNb,!0),n(Q,u.dueDate,!0),n(I,u.assignedTo,!0)}});function ge(){n(m,""),n(h,""),n(N,"medium"),n(O,"onEvent"),n(x,1),n(Q,""),n(I,[],!0)}async function ye(u=!1){if(!e(m).trim()){ne.warning("Le titre de la t√¢che est requis");return}n(V,!0);try{const v=new Date().toISOString();if(s.todoToEdit){const S={taskName:e(m),taskDescription:e(h)||null,priority:e(N),taskOn:e(O),requiredPeopleNb:e(x),dueDate:e(Q)?new Date(e(Q)).toISOString():null,assignedTo:e(I).length>0?e(I):null};await He.updateTodo(s.eventId,s.todoToEdit.id,S),ne.success("T√¢che mise √† jour"),_e()}else{const S={id:ht(10),taskName:e(m),taskDescription:e(h)||null,priority:e(N),taskOn:e(O),requiredPeopleNb:e(x),dueDate:e(Q)?new Date(e(Q)).toISOString():null,assignedTo:e(I).length>0?e(I):null,status:"todo"};await He.addTodo(s.eventId,S),ne.success("T√¢che cr√©√©e"),u?ge():_e()}}catch(v){ne.error("Erreur lors de la sauvegarde"),console.error(v)}finally{n(V,!1)}}function _e(){ge(),s.onClose()}function be(u){e(I).includes(u)?n(I,e(I).filter(v=>v!==u),!0):n(I,[...e(I),u],!0)}let te=q(mt([]));et(()=>{s.open&&e(w)==="bulk"&&n(te,[...se.beforeEvent.map(u=>({taskName:u,taskOn:"beforeEvent",enabled:!0,requiredPeopleNb:1})),...se.onEvent.map(u=>({taskName:u,taskOn:"onEvent",enabled:!0,requiredPeopleNb:1})),...se.afterEvent.map(u=>({taskName:u,taskOn:"afterEvent",enabled:!1,requiredPeopleNb:1}))],!0)});async function De(){const u=e(te).filter(v=>v.enabled);if(u.length===0){ne.warning("S√©lectionnez au moins une t√¢che");return}n(V,!0);try{const v=new Date().toISOString(),S=u.map(G=>({id:ht(10),taskName:G.taskName,taskDescription:null,priority:"medium",taskOn:G.taskOn,requiredPeopleNb:G.requiredPeopleNb,dueDate:null,assignedTo:null,status:"todo"}));await He.addTodos(s.eventId,S),ne.success(`${S.length} t√¢che(s) cr√©√©e(s)`),_e()}catch(v){ne.error("Erreur lors de la cr√©ation"),console.error(v)}finally{n(V,!1)}}function ke(u){e(te)[u].enabled=!e(te)[u].enabled}const je=z(()=>{const u=[{id:oe.userId||"",label:"Moi",selected:e(I).includes(oe.userId||"")}];return Ve().forEach(v=>{v.id!==oe.userId&&u.push({id:v.id,label:v.name||v.email||v.id.substring(0,5),selected:e(I).includes(v.id)})}),u});zt(Ze,{get isOpen(){return s.open},onClose:_e,maxWidth:"lg",maxHeight:"xl",children:(u,v)=>{var S=vn(),G=ve(S);{let ae=z(()=>s.todoToEdit?"Modifier la T√¢che":"Nouvelle T√¢che");Ot(G,{get title(){return e(ae)},onClose:_e})}var Z=r(G,2);Lt(Z,{children:(ae,Ce)=>{var H=nn(),ce=ve(H);{var xe=L=>{var R=Ya(),W=a(R);W.__click=()=>n(w,"individual");var _=a(W);Ct(_,{class:"me-2 size-4"}),ee(),t(W);var g=r(W,2);g.__click=()=>n(w,"bulk");var p=a(g);St(p,{class:"me-2 size-4"}),ee(),t(g),t(R),T(()=>{at(W,1,`tab ${e(w)==="individual"?"tab-active":""}`),at(g,1,`tab ${e(w)==="bulk"?"tab-active":""}`)}),i(L,R)};b(ce,L=>{s.todoToEdit||L(xe)})}var Te=r(ce,2);{var ue=L=>{var R=$a(),W=a(R),_=r(a(W),2),g=a(_);Ke(g),t(_),t(W);var p=r(W,2),j=a(p),F=a(j);Ct(F,{class:"size-4 opacity-50"}),ee(),t(j);var B=r(j,2);At(B),t(p);var K=r(p,2),fe=a(K),Se=a(fe),Ie=a(Se);Et(Ie,{class:"size-4 opacity-50"}),ee(),t(Se);var D=r(Se,2),d=a(D);d.value=d.__value="beforeEvent";var f=r(d);f.value=f.__value="onEvent";var y=r(f);y.value=y.__value="afterEvent",t(D),t(fe);var U=r(fe,2),M=a(U),A=a(M);kt(A,{class:"size-4 opacity-50"}),ee(),t(M);var re=r(M,2),Ae=a(re);Ke(Ae),t(re),t(U);var Be=r(U,2),Me=a(Be),qe=a(Me);st(qe,{class:"size-4 opacity-50"}),ee(),t(Me);var pe=r(Me,2),Ne=a(pe);Ke(Ne),t(pe),t(Be),t(K);var Le=r(K,2),o=a(Le),l=a(o);st(l,{class:"size-4 opacity-50"});var E=r(l),C=r(E);{var ie=Y=>{var Ee=Xa(),Re=a(Ee);t(Ee),T(()=>J(Re,`Manque ${e(x)-e(I).length} pers.`)),i(Y,Ee)},ze=Y=>{var Ee=Za(),Re=a(Ee);xt(Re,{class:"size-3"}),ee(),t(Ee),i(Y,Ee)};b(C,Y=>{e(I).length<e(x)?Y(ie):Y(ze,!1)})}t(o);var $=r(o,2);fa($,{get items(){return e(je)},size:"lg",color:"primary",onToggleItem:be}),t(Le),t(R),T(()=>J(E,` Assignation (${e(I).length??""}/${e(x)??""}) `)),nt(g,()=>e(m),Y=>n(m,Y)),nt(B,()=>e(h),Y=>n(h,Y)),Kt(D,()=>e(O),Y=>n(O,Y)),nt(Ae,()=>e(Q),Y=>n(Q,Y)),nt(Ne,()=>e(x),Y=>n(x,Y)),i(L,R)},le=L=>{var R=an();Je(R,20,()=>["beforeEvent","onEvent","afterEvent"],dt,(W,_)=>{const g=z(()=>_==="beforeEvent"?"Avant l'√©v√©nement":_==="onEvent"?"Pendant l'√©v√©nement":"Apr√®s l'√©v√©nement"),p=z(()=>e(te).filter(K=>K.taskOn===_));var j=Xe(),F=ve(j);{var B=K=>{var fe=tn(),Se=a(fe);Ke(Se);var Ie=r(Se,2),D=a(Ie);Et(D,{class:"size-4 opacity-50"});var d=r(D);t(Ie);var f=r(Ie,2),y=a(f);Je(y,21,()=>e(p),dt,(U,M,A)=>{const re=z(()=>e(te).indexOf(e(M)));var Ae=en(),Be=a(Ae);Ke(Be),Be.__change=()=>ke(e(re));var Me=r(Be,2);Ke(Me);var qe=r(Me,2),pe=a(qe);st(pe,{class:"size-4 opacity-50"});var Ne=r(pe,2);Ke(Ne),t(qe),t(Ae),T(()=>{Pt(Be,e(M).enabled),qt(Me,e(M).taskName),Me.disabled=!e(M).enabled,Ne.disabled=!e(M).enabled}),nt(Ne,()=>e(M).requiredPeopleNb,Le=>e(M).requiredPeopleNb=Le),i(U,Ae)}),t(y),t(f),t(fe),T(U=>J(d,` ${e(g)??""} (${U??""}/${e(p).length??""})`),[()=>e(p).filter(U=>U.enabled).length]),i(K,fe)};b(F,K=>{e(p).length>0&&K(B)})}i(W,j)}),t(R),i(L,R)};b(Te,L=>{s.todoToEdit||e(w)==="individual"?L(ue):L(le,!1)})}i(ae,H)}});var P=r(Z,2);jt(P,{children:(ae,Ce)=>{var H=Xe(),ce=ve(H);{var xe=ue=>{var le=rn();le.__click=De;var L=a(le);{var R=_=>{var g=sn();i(_,g)},W=_=>{St(_,{class:"size-4"})};b(L,_=>{e(V)?_(R):_(W,!1)})}ee(),t(le),T(()=>le.disabled=e(V)),i(ue,le)},Te=ue=>{var le=dn(),L=ve(le);{var R=F=>{var B=on();B.__click=()=>ye(!0);var K=a(B);gt(K,{class:"size-4"}),ee(),t(B),T(()=>B.disabled=e(V)),i(F,B)};b(L,F=>{s.todoToEdit||F(R)})}var W=r(L,2);W.__click=()=>ye(!1);var _=a(W);{var g=F=>{var B=ln();i(F,B)},p=F=>{Bt(F,{class:"size-4"})};b(_,F=>{e(V)?F(g):F(p,!1)})}var j=r(_);t(W),T(()=>{W.disabled=e(V),J(j,` ${s.todoToEdit?"Mettre √† jour":"Cr√©er la t√¢che"}`)}),i(ue,le)};b(ce,ue=>{e(w)==="bulk"?ue(xe):ue(Te,!1)})}i(ae,H)}}),i(u,S)},$$slots:{default:!0}}),pt()}_t(["click","change"]);var un=c('<div class="text-base-content/50 border-base-200 hover:border-primary/50 cursor-pointer rounded-lg border-2 border-dashed py-8 text-center text-sm italic transition-colors" role="button" tabindex="0">Aucune t√¢che pour le moment. <br/> <span class="text-primary mt-1 inline-block font-medium">Cr√©er la premi√®re t√¢che +</span></div>'),fn=c('<div class="mb-4 flex items-center justify-between"><div class="flex items-center gap-2 text-sm opacity-60"><!> <span> </span></div> <button class="btn btn-sm btn-primary gap-2"><!> Nouvelle t√¢che</button></div> <div class=" space-y-4"><!></div> <!>',1);function mn(Ze,s){bt(s,!0);let Ve=Ye(s,"contributors",19,()=>[]),m=Ye(s,"disabled",3,!1);const h=z(()=>s.event.todos??[]);function N(se){return{beforeEvent:1,onEvent:2,afterEvent:3}[se]??0}const O=z(()=>[...e(h)].sort((X,ge)=>{const ye=N(X.taskOn??""),_e=N(ge.taskOn??""),be=ye-_e;if(be!==0)return be;const te=X.dueDate?new Date(X.dueDate).getTime():1/0,De=ge.dueDate?new Date(ge.dueDate).getTime():1/0;return te-De}));let x=q(!1),Q=q(null);function I(){n(Q,null),n(x,!0)}function V(se){n(Q,se,!0),n(x,!0)}function w(se){s.onTodosChange?.(se)}ft(Ze,{legend:"T√¢ches & Organisation",legendSize:"text-lg",children:(se,X)=>{var ge=fn(),ye=ve(ge),_e=a(ye),be=a(_e);ra(be,{class:"size-4"});var te=r(be,2),De=a(te);t(te),t(_e);var ke=r(_e,2);ke.__click=I;var je=a(ke);gt(je,{class:"size-4"}),ee(),t(ke),t(ye);var u=r(ye,2),v=a(u);{var S=P=>{var ae=un();ae.__click=I,ae.__keydown=Ce=>Ce.key==="Enter"&&I(),i(P,ae)},G=P=>{var ae=Xe(),Ce=ve(ae);Je(Ce,17,()=>e(O),H=>H.id,(H,ce)=>{Qa(H,{get todo(){return e(ce)},get eventId(){return s.event.$id},onEdit:V,get disabled(){return m()},get contributors(){return Ve()}})}),i(P,ae)};b(v,P=>{e(O).length===0?P(S):P(G,!1)})}t(u);var Z=r(u,2);cn(Z,{get open(){return e(x)},get eventId(){return s.event.$id},get todoToEdit(){return e(Q)},get contributors(){return Ve()},get currentTodos(){return e(h)},onClose:()=>n(x,!1),onSave:w}),T(()=>J(De,`${e(h).length??""} t√¢ches`)),i(se,ge)},$$slots:{default:!0}}),pt()}_t(["click","keydown"]);var gn=c('<span class="loading loading-spinner loading-xs text-primary"></span>'),_n=c('<div class="flex items-center gap-2"><button class="btn btn-accent btn-sm"><!> <span class="font-bold">Enregistrer</span></button></div>'),bn=c(`<input type="text" class="input input-lg min-w-full shadow-md" placeholder="Nom de l'√©v√©nement"/>`),pn=c('<button class="btn btn-ghost"><div class="flex items-baseline gap-4"><h1> </h1> <!></div></button>'),hn=c(`<textarea class="textarea w-full" placeholder="D√©crivez l'√©v√©nement..." maxlength="3000" rows="9"></textarea> <p class="label"> </p>`,1),yn=c('<p class="whitespace-pre-wrap"> </p>'),xn=c('<p class="text-base-content/40 italic">Ajoutez une description...</p>'),En=c('<button class="btn btn-ghost bg-base-100 h-auto justify-start py-4 text-left font-normal"><div class="flex w-full items-start justify-between gap-4"><div class="flex-1"><!></div> <!></div></button>'),wn=c('<div class="badge badge-lg badge-success gap-1"><!> Confirm√©</div>'),kn=c('<div class="badge badge-lg badge-info gap-1"><!> Proposition</div>'),Tn=c('<div class="badge badge-lg badge-warning gap-1"><!> </div>'),In=c(`<button class="btn btn-success btn-link btn-md">Confirmez l'√©v√©nement</button>`),Dn=c(`<button class="btn btn-link btn-error btn-sm">Annuler l'√©v√©nement</button>`),Cn=c('<button class="btn btn-link btn-sm">R√©activer</button>'),Sn=c('<div class="flex flex-wrap items-center justify-between gap-2"><div class="flex items-center gap-2"><!></div> <!></div>'),Mn=c('<div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:col-span-2 lg:grid-cols-3"><div class="col-span-2"><!></div> <div class="flex flex-col justify-start gap-4"><!></div></div>'),Nn=c(`<div class="flex items-center justify-center py-20"><div class="flex flex-col items-center gap-4"><span class="loading loading-spinner loading-lg text-primary"></span> <p class="text-base-content/60">Chargement de l'√©v√©nement...</p></div></div>`),Pn=c(`<div class="alert alert-info"><!> <div><h4 class="font-bold">Mode D√©monstration</h4> <p class="text-sm">Dans un v√©ritable √©v√©nement, vous pourrez inviter des √©quipes
                  et des participants √† collaborer sur la planification.</p></div></div>`),An=c(`<div class="alert alert-warning max-md:alert-vertical"><!> <div><h3 class="font-bold">√âv√©nement en cours de modification</h3> <div class="text-xs">Un autre utilisateur est en train de modifier cet √©v√©nement. Les
                contr√¥les sont temporairement d√©sactiv√©s.</div></div></div>`),qn=c('<div class="text-base-content/60 bg-base-200 rounded-box border-base-200 flex flex-col items-center justify-center border-2 border-dashed py-12"><div class="bg-base-200 mb-4 rounded-full p-4"><!></div> <p class="font-medium">Aucun repas planifi√©</p> <p class="mt-1 text-sm">Commencez par ajouter un repas √† votre √©v√©nement</p></div>'),zn=c("<div><!></div>"),On=c('<div class="space-y-4"></div>'),Ln=c('<div class="grid grid-cols-1 gap-6 pb-20 lg:grid-cols-3"><div class="space-y-6 lg:col-span-1"><!> <!></div> <div class="space-y-6 md:px-4 lg:col-span-2"><!> <div class="mb-6 flex items-center justify-between"><h3 class="card-title text-lg"> </h3> <button class="btn btn-primary"><!> Ajouter un repas</button></div> <!> <div class="flex"><button class="btn btn-outline btn-primary btn-block mt-4"><!> Ajouter un repas</button></div></div></div>'),jn=c('<div class="bg-base-200 min-h-lvh space-y-6 px-2 pt-4 pb-20 md:px-20"><div class="flex flex-wrap items-center justify-between gap-x-6 gap-y-3"><div class="min-w-80 flex-1 gap-2"><!></div> <!></div> <!> <!> <!></div> <!> <!> <!>',1);function ts(Ze,s){bt(s,!0);const Ve=o=>{var l=_n(),E=a(l);E.__click=L;var C=a(E);{var ie=$=>{var Y=gn();i($,Y)},ze=$=>{Bt($,{size:18,class:"mr-1"})};b(C,$=>{e(w)?$(ie):$(ze,!1)})}ee(2),t(E),t(l),T(()=>E.disabled=e(w)||!e(je)||!e(P)),i(o,l)};let m=z(()=>Yt.params.id),h=q(mt([])),N=q(""),O=q(""),x=q("proposition"),Q=q(1);const I=z(()=>[...e(h)].sort((o,l)=>new Date(o.date).getTime()-new Date(l.date).getTime()));let V=q(!1),w=q(!1),se=q(!1),X=q(!1),ge=q(null),ye=q(!1),_e=q(!1),be=q(!1),te=q(!1),De=q(null),ke=null;const je=z(()=>{if(e(N)===""&&e(h).length===0)return console.log("[isDirty] FALSE - Shadow draft vide"),!1;if(!e(V)||!e(X)||!e(v))return console.log("[isDirty] FALSE - Guards:",{isInitialised:e(V),isEditing:e(X),hasCurrentEvent:!!e(v)}),!1;if(e(N)!==e(v).name)return console.log("[isDirty] TRUE - Nom diff√©rent",{eventName:e(N),currentName:e(v).name}),!0;if(e(O)!==(e(v).description||""))return console.log("[isDirty] TRUE - Description diff√©rente"),!0;if(e(x)!==e(v).status)return console.log("[isDirty] TRUE - Statut diff√©rent",{status:e(x),currentStatus:e(v).status}),!0;if(e(Q)!==(e(v).minContrib||1))return console.log("[isDirty] TRUE - minContrib diff√©rent",{minContrib:e(Q),currentMinContrib:e(v).minContrib}),!0;const o=e(v).meals||[];if(e(h).length!==o.length)return console.log("[isDirty] TRUE - Nombre de meals diff√©rent",{mealsCount:e(h).length,currentCount:o.length}),!0;for(let l=0;l<e(h).length;l++){const E=o[l],C=e(h)[l];if(C.id!==E.id)return console.log(`[isDirty] TRUE - meal[${l}].id diff√©rent`),!0;if(C.date!==E.date)return console.log(`[isDirty] TRUE - meal[${l}].date diff√©rent`),!0;if(C.guests!==E.guests)return console.log(`[isDirty] TRUE - meal[${l}].guests diff√©rent`),!0;if((C.recipes?.length||0)!==(E.recipes?.length||0))return console.log(`[isDirty] TRUE - meal[${l}].recipes.length diff√©rent`),!0}return console.log("[isDirty] FALSE - Aucune diff√©rence d√©tect√©e"),!1});async function u(){if(console.log("startEditing"),e(X))return!0;if(e(Z))return ne.warning(`Cet √©v√©nement est verrouill√© par ${e(ae)}`),!1;if(e(v)&&it(e(v).$id))return console.log("[startEditing] Mode d√©mo : activation de isEditing"),n(X,!0),!0;const o=await Ce();return o&&n(X,!0),o}const v=z(()=>He.getEventById(e(m))),S=z(()=>ca(e(v))),G=z(()=>e(v)?.teamsId??[]),Z=z(()=>e(De)?e(De).userId!==oe.userId:!1),P=z(()=>e(v)&&it(e(v).$id)||He.canUserEditEvent(e(m),oe.userId||"")&&!e(Z)&&!e(w));et(()=>{console.log("[canEdit] Debug:",{canEdit:e(P),canUserEditEvent:He.canUserEditEvent(e(m),oe.userId||""),isLockedByOthers:e(Z),isBusy:e(w),eventId:e(m),userId:oe.userId})});const ae=z(()=>e(De)?.userName||"un autre utilisateur");et(()=>{if(!e(v)){console.log("[Sync] Guard 1 - Pas de currentEvent");return}if(!e(V)){console.log("[Sync] Guard 2 - Pas initialis√©");return}if(e(X)&&e(N)!==""){console.log("[Sync] Guard 3 - Mode √©dition actif, pas de sync (shadow draft d√©j√† peupl√©)");return}Tt(()=>{const o=e(N),l=e(h).length;n(h,Jt(e(v).meals||[]),!0),n(N,e(v).name||"",!0),n(O,e(v).description||"",!0),n(x,e(v).status||"proposition",!0),n(Q,e(v).minContrib||1,!0),console.log("üîÑ Shadow draft synchronis√© depuis currentEvent",{oldEventName:o,newEventName:e(N),oldMealsCount:l,newMealsCount:e(h).length,isDemo:it(e(v).$id)})})}),et(()=>{Dt.setConfig({actions:Ve,isLockedByOthers:e(Z),lockedByUserName:e(ae),hasUnsavedChanges:e(je)&&!e(Z)})}),et(()=>{if(e(V)||e(w)){console.log("[Init] Guard 1 - D√©j√† initialis√© ou occup√©",{isInitialised:e(V),isBusy:e(w)});return}if(!e(m)){console.log("[Init] Guard 2 - Pas d'eventId");return}console.log("[Init] D√©but initialisation pour eventId:",e(m)),Tt(async()=>{n(w,!0);try{const o=He.getEventById(e(m));if(console.log("[Init] Event r√©cup√©r√©:",o?.$id,o?.name),o&&it(o.$id)){console.log("[Init] Mode d√©mo: pr√™t, marquage isInitialised = true"),n(V,!0);return}n(De,await ut.getLock(e(m)),!0),ke=ut.subscribeToLock(e(m),l=>{console.log("[EventEditPage] üîí Verrou mis √† jour:",{lockedBy:l?.userName,userId:l?.userId,expiresAt:l?.expiresAt}),n(De,l,!0)}),n(V,!0)}finally{n(w,!1),console.log("[Init] Fin initialisation, isBusy = false")}})}),Qt(()=>{R&&(clearTimeout(R),R=null),ke&&(ke(),ke=null),e(m)&&e(X)&&(console.log("üö™ D√©montage du composant, lib√©ration du lock..."),H()),Dt.reset()});async function Ce(){if(e(v)&&it(e(v).$id))return console.log("[acquireLock] Mode d√©mo : pas de lock √† acqu√©rir"),!0;if(!e(m)||!oe.userId||e(w)||e(se))return!1;n(se,!0);try{return await ut.acquireLock(e(m),oe.userId,oe.userName)?(W(),!0):(ne.warning(`Cet √©v√©nement est en cours de modification par ${e(ae)}`),!1)}catch(o){return console.error("‚ùå Erreur acquisition verrou:",o),ne.error("Impossible de verrouiller l'√©v√©nement"),!1}finally{n(se,!1)}}async function H(){if(e(v)&&it(e(v).$id)){console.log("[releaseLock] Mode d√©mo : d√©sactivation de isEditing"),n(X,!1);return}if(!(!e(m)||!oe.userId)){try{await ut.releaseLock(e(m),oe.userId),console.log("üîì Verrou lib√©r√©")}catch(o){console.error("‚ùå Erreur lib√©ration verrou:",o)}n(X,!1)}}async function ce(){e(X)&&await H()}async function xe(){const o=await ue();return o&&await H(),o}function Te(){if(!e(N).trim())return{isValid:!1,errorMessage:"Veuillez renseigner le nom de l'√©v√©nement"};if(e(h).length===0)return{isValid:!1,errorMessage:"Veuillez ajouter au moins un repas"};const l=e(h).map(E=>E.date).filter((E,C,ie)=>ie.indexOf(E)!==C);return l.length>0?{isValid:!1,errorMessage:`Certaines dates sont en double: ${l.map(C=>{try{return new Date(C).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return C}}).join(", ")}`}:{isValid:!0}}async function ue(){const o=Te();if(!o.isValid)return ne.error(o.errorMessage||"Erreur de validation"),!1;e(S);const l=Array.from(new Set(e(I).map($=>$.date))).sort(),E=e(v)?.teams||[],C=e(v)?.teamsId||[],ie=new Map(C.map(($,Y)=>[$,E[Y]]));e(G).map($=>It.getTeamById($)?.name||ie.get($)||$);const ze={name:e(N),description:e(O),status:e(x),minContrib:e(Q),allDates:l,dateStart:l.length>0?l[0]:"",dateEnd:l.length>0?l[l.length-1]:"",meals:e(I)};try{return await He.updateEvent(e(m),ze),!0}catch($){return console.error("Erreur sauvegarde:",$),ne.error("Erreur lors de la sauvegarde"),!1}}async function le(){if(!e(m)||e(w)||!e(X))return;n(w,!0);const o=ne.loading("Sauvegarde automatique...");if(await ue())await H(),ne.update(o,{state:"success",message:"Modifications sauvegard√©es automatiquement"});else{if(e(m)&&oe.userId)try{await ut.acquireLock(e(m),oe.userId,oe.userName)}catch(E){console.error("Erreur heartbeat lock:",E)}ne.update(o,{state:"warning",message:"Impossible de sauvegarder : modifications invalides"})}n(w,!1),setTimeout(()=>ne.dismiss(o),3e3)}async function L(){n(w,!0),await ue()&&(await H(),ne.success("√âv√©nement mis √† jour")),n(w,!1)}let R=null;function W(){R&&clearTimeout(R),R=setTimeout(()=>{le()},120*1e3),console.log("‚è∞ Auto-save programm√© dans 30 secondes")}et(()=>{const o=e(X),l=e(je),E=C=>{(o||l)&&(C.preventDefault(),C.returnValue="Vous avez des modifications non sauvegard√©es. Voulez-vous vraiment quitter ?")};return window.addEventListener("beforeunload",E),()=>{window.removeEventListener("beforeunload",E)}});async function _(o){await u()&&n(N,o.target.value,!0)}async function g(){if(!await u())return;const o=ht(6);let l;if(e(I).length===0){const C=new Date;C.setDate(C.getDate()+7),C.setHours(20,0,0,0),l=C.toISOString()}else{const C=e(I)[e(I).length-1],ie=new Date(C.date);ie.getHours()<14?ie.setHours(20,0,0,0):(ie.setDate(ie.getDate()+1),ie.setHours(12,0,0,0)),l=ie.toISOString()}const E={id:o,date:l,guests:100,recipes:[]};n(h,[...e(h),E],!0),n(ge,o,!0)}function p(o){n(h,e(h).filter(l=>l.id!==o),!0)}function j(o){n(ge,e(ge)===o?null:o,!0)}async function F(o){if(!(!e(m)||!oe.userId))try{n(w,!0);const l=o?"accepted":"declined";await He.updateContributorStatus(e(m),oe.userId,l),ne.success(o?"Invitation accept√©e":"Invitation d√©clin√©e")}catch(l){console.error("Erreur r√©ponse invitation:",l),ne.error("Erreur lors de la r√©ponse")}finally{n(w,!1)}}async function B(){await u()&&(n(x,"confirmed"),n(be,!1))}async function K(){await u()&&(n(x,"canceled"),n(te,!1))}var fe=jn(),Se=ve(fe),Ie=a(Se),D=a(Ie),d=a(D);{var f=o=>{var l=bn();Ke(l),l.__input=_,T(()=>{qt(l,e(N)),l.disabled=!e(P)}),lt("focus",l,u),lt("blur",l,()=>n(ye,!1)),i(o,l)},y=o=>{var l=pn();l.__click=()=>n(ye,!e(ye));var E=a(l),C=a(E),ie=a(C,!0);t(C);var ze=r(C,2);yt(ze,{class:"h-4 w-4"}),t(E),t(l),T(()=>{l.disabled=!e(P),J(ie,e(N)||"Nom de l'√©v√©nement")}),i(o,l)};b(d,o=>{e(ye)?o(f):o(y,!1)})}t(D);var U=r(D,2);{var M=o=>{ua(o,{get currentEvent(){return e(v)}})};b(U,o=>{e(v)&&o(M)})}t(Ie);var A=r(Ie,2);{var re=o=>{var l=Mn(),E=a(l),C=a(E);ft(C,{legend:"Description",children:($,Y)=>{var Ee=Xe(),Re=ve(Ee);{var vt=Fe=>{var Ge=hn(),Pe=ve(Ge);At(Pe);var Qe=r(Pe,2),he=a(Qe);t(Qe),T(()=>{Pe.disabled=!e(P),J(he,`${e(O).length??""}/3000 caract√®res`)}),lt("focus",Pe,u),lt("blur",Pe,()=>n(_e,!1)),nt(Pe,()=>e(O),we=>n(O,we)),i(Fe,Ge)},rt=Fe=>{var Ge=En();Ge.__click=()=>n(_e,!0);var Pe=a(Ge),Qe=a(Pe),he=a(Qe);{var we=Oe=>{var me=yn(),k=a(me,!0);t(me),T(()=>J(k,e(O))),i(Oe,me)},$e=Oe=>{var me=xn();i(Oe,me)};b(he,Oe=>{e(O)?Oe(we):Oe($e,!1)})}t(Qe);var tt=r(Qe,2);yt(tt,{class:"h-4 w-4 shrink-0"}),t(Pe),t(Ge),T(()=>Ge.disabled=!e(P)),i(Fe,Ge)};b(Re,Fe=>{e(_e)?Fe(vt):Fe(rt,!1)})}i($,Ee)},$$slots:{default:!0}}),t(E);var ie=r(E,2),ze=a(ie);ft(ze,{legend:"Statut de l'√©v√©nement",children:($,Y)=>{var Ee=Sn(),Re=a(Ee),vt=a(Re);{var rt=he=>{var we=wn(),$e=a(we);ia($e,{class:"h-3 w-3"}),ee(),t(we),i(he,we)},Fe=he=>{var we=Xe(),$e=ve(we);{var tt=me=>{var k=kn(),de=a(k);Et(de,{class:"h-3 w-3"}),ee(),t(k),i(me,k)},Oe=me=>{var k=Tn(),de=a(k);oa(de,{class:"h-3 w-3"});var Ue=r(de);t(k),T(()=>J(Ue,` ${e(x)??""}`)),i(me,k)};b($e,me=>{e(x)==="proposition"?me(tt):me(Oe,!1)},!0)}i(he,we)};b(vt,he=>{e(x)==="confirmed"?he(rt):he(Fe,!1)})}t(Re);var Ge=r(Re,2);{var Pe=he=>{var we=In();we.__click=()=>n(be,!0),T(()=>we.disabled=!e(P)),i(he,we)},Qe=he=>{var we=Xe(),$e=ve(we);{var tt=me=>{var k=Dn();k.__click=()=>n(te,!0),T(()=>k.disabled=!e(P)),i(me,k)},Oe=me=>{var k=Cn();k.__click=async()=>{await u()&&n(x,"proposition")},T(()=>k.disabled=!e(P)),i(me,k)};b($e,me=>{e(x)==="confirmed"?me(tt):me(Oe,!1)},!0)}i(he,we)};b(Ge,he=>{e(x)==="proposition"?he(Pe):he(Qe,!1)})}t(Ee),i($,Ee)},$$slots:{default:!0}}),t(ie),t(l),i(o,l)};b(A,o=>{e(V)&&o(re)})}var Ae=r(A,2);va(Ae,{get currentEvent(){return e(v)},get isBusy(){return e(w)},onRespond:F});var Be=r(Ae,2);{var Me=o=>{var l=Nn();i(o,l)},qe=o=>{var l=Ln(),E=a(l),C=a(E);{var ie=k=>{ft(k,{legend:"Participants",get iconComponent(){return st},children:(de,Ue)=>{var We=Pn(),ot=a(We);la(ot,{class:"h-5 w-5"}),ee(2),t(We),i(de,We)},$$slots:{default:!0}})},ze=k=>{{let de=z(()=>oe.userId||"");ja(k,{get canEdit(){return e(P)},get contributors(){return e(S)},get nativeTeamsStore(){return It},get eventsStore(){return He},get userId(){return e(de)},get eventId(){return e(m)},onStartEdit:u,get minContrib(){return e(Q)},set minContrib(Ue){n(Q,Ue,!0)}})}};b(C,k=>{e(v)&&it(e(v).$id)?k(ie):k(ze,!1)})}var $=r(C,2);{var Y=k=>{{let de=z(()=>!e(P)||e(Z));mn(k,{get event(){return e(v)},get contributors(){return e(S)},get disabled(){return e(de)}})}};b($,k=>{e(v)&&k(Y)})}t(E);var Ee=r(E,2),Re=a(Ee);{var vt=k=>{var de=An(),Ue=a(de);da(Ue,{class:"h-6 w-6 shrink-0"}),ee(2),t(de),i(k,de)};b(Re,k=>{e(Z)&&k(vt)})}var rt=r(Re,2),Fe=a(rt),Ge=a(Fe);t(Fe);var Pe=r(Fe,2);Pe.__click=g;var Qe=a(Pe);gt(Qe,{class:"mr-1 h-4 w-4"}),ee(),t(Pe),t(rt);var he=r(rt,2);{var we=k=>{var de=qn(),Ue=a(de),We=a(Ue);kt(We,{class:"h-8 w-8 opacity-50"}),t(Ue),ee(4),t(de),i(k,de)},$e=k=>{var de=On();Je(de,29,()=>e(I),Ue=>Ue.id+"-"+e(v)?.$updatedAt,(Ue,We)=>{var ot=zn(),Ut=a(ot);{let Vt=z(()=>e(ge)===e(We).id),Rt=z(()=>e(h).map(ct=>ct.date)),Ft=z(()=>!e(P)||e(Z));Zt(Ut,{get isEditing(){return e(Vt)},onEditToggle:async()=>{await u()&&j(e(We).id||"")},onDelete:()=>p(e(We).id||""),get allDates(){return e(Rt)},get disabled(){return e(Ft)},get meal(){return e(h)[e(h).findIndex(ct=>ct.id===e(We).id)]},set meal(ct){e(h)[e(h).findIndex(Gt=>Gt.id===e(We).id)]=ct}})}t(ot),Xt(ot,()=>$t,()=>({delay:100,duration:400})),i(Ue,ot)}),t(de),i(k,de)};b(he,k=>{e(I).length===0?k(we):k($e,!1)})}var tt=r(he,2),Oe=a(tt);Oe.__click=g;var me=a(Oe);gt(me,{class:"mr-1 h-4 w-4"}),ee(),t(Oe),t(tt),t(Ee),t(l),T(()=>{J(Ge,`Repas & Menus (${e(I).length??""})`),Pe.disabled=!e(P),Oe.disabled=!e(P)}),i(o,l)};b(Be,o=>{e(w)&&!e(V)?o(Me):o(qe,!1)})}t(Se);var pe=r(Se,2);Mt(pe,{get isOpen(){return e(be)},title:"Confirmer l'√©v√©nement",message:"√ätes-vous s√ªr de vouloir confirmer cet √©v√©nement ? ",variant:"info",confirmLabel:"Confirmer",cancelLabel:"Annuler",onConfirm:B,onCancel:()=>n(be,!1)});var Ne=r(pe,2);Mt(Ne,{get isOpen(){return e(te)},title:"Annuler la confirmation",message:"√ätes-vous s√ªr de vouloir annuler cet √©v√©nement ?.",variant:"warning",confirmLabel:"Oui, annuler",cancelLabel:"Non, garder",onConfirm:K,onCancel:()=>n(te,!1)});var Le=r(Ne,2);{let o=z(()=>`/event/${e(m)}`);ma(Le,{get routeKey(){return e(o)},shouldProtect:()=>e(je),onLeaveWithoutSave:ce,onSaveAndLeave:xe,message:"Vous avez des modifications non sauvegard√©es. Voulez-vous vraiment quitter ?"})}i(Ze,fe),pt()}_t(["click","input"]);export{ts as default};
