import{d as ke,y as f,z as S,X as Te,m as t,u as V,A as a,_ as w,D as p,J as Z,N as ee,j as $,k as C,K as L,b as g,c as ze,v as B,b1 as te,h as v,g as O,w as re,x as $e,B as Le,G as ae,o as m,C as Ue,I as o,P as je,aF as se,aE as q}from"./appwrite.js";import{n as ne}from"./index.js";import{y as He}from"./icons.js";var Me=B('<button class="btn btn-primary btn-sm gap-2"><!> Imprimer tout</button>'),Ne=B('<div class="flex min-h-[60vh] items-center justify-center"><div class="loading loading-spinner loading-lg text-primary"></div></div>'),Ge=B('<div class="container mx-auto p-4"><div class="alert alert-error max-md:alert-vertical"><!> <span> </span></div></div>'),Fe=B('<div class="flex min-h-[60vh] items-center justify-center"><div class="alert alert-info alert-vertical"><!> <p class="text-lg">Aucune recette pour le moment</p></div></div>'),Ke=B('<!> <div class="bg-base-200 min-h-screen print:h-auto print:min-h-0"><div class="mx-auto px-4 py-4 print:hidden"><!></div> <div><!></div></div>',1);function Qe(ie,oe){ke(oe,!0);const le=e=>{var r=Me();r.__click=ye;var n=v(r);He(n,{class:"h-5 w-5"}),ae(),m(r),g(e,r)};let J=V(()=>p.params.id),s=V(()=>t(J)&&w.getEventById(t(J))),x=f(!1),U=f(null),E=f(S([])),D=f(!1),u=f(S({showDate:!0,showHoraire:!0,showDescription:!1,showCategories:!0,showRecipes:!0,showRegimes:!1,showAllergens:!1,showIngredients:!1,catPageBreak:!1,dateByPageBreak:!1,messageTop:"",fontTop:"montserrat-font",fontSizeTop:1,boldTop:!1,italicTop:!1,messageBottom:"",fontBottom:"montserrat-font",fontSizeBottom:1,boldBottom:!1,italicBottom:!1,fontDate:"montserrat-font",fontSizeDate:1,boldDate:!1,italicDate:!1,fontHoraire:"montserrat-font",fontSizeHoraire:1,boldHoraire:!1,italicHoraire:!1,fontCat:"montserrat-font",fontSizeCat:1,boldCat:!1,italicCat:!1,fontRecettes:"pacifico-regular",fontSizeRecettes:2,boldRecettes:!1,italicRecettes:!1,fontDesc:"montserrat-font",fontSizeDesc:1,boldDesc:!1,italicDesc:!1,fontRegimes:"montserrat-font",fontSizeRegimes:1,boldRegimes:!1,italicRegimes:!1,fontAlert:"montserrat-font",fontSizeAlert:1,boldAlert:!1,italicAlert:!1,fontIng:"montserrat-font",fontSizeIng:1,boldIng:!1,italicIng:!1,centerVertical:!0})),R=f(S([])),I=f(null),A=f(null),j=f(!1);const ce=V(()=>{if(!t(s))return!1;const e=o.userId||"";return t(s).createdBy===e?!0:t(s).contributors?.find(n=>n.id===e)?.status==="accepted"});let P=S({}),k=S({}),H=f(null),ue=V(()=>{if(!t(s)?.meals)return new q;const e=new q;return t(s).meals.forEach(r=>{const n=new Date(r.date),l=n.toISOString().split("T")[0],y=n.getHours(),c=y<12?"Petit-déjeuner":y<14?"Déjeuner":y<18?"Goûter":"Dîner";e.has(l)||e.set(l,new q);const i=e.get(l);i.has(c)||i.set(c,[]),i.get(c).push(r)}),e});Te(()=>{(async()=>{if(!t(s)){a(x,!0);try{await w.fetchEvent(p.params.id)}catch(e){a(U,e instanceof Error?e.message:"Erreur de chargement",!0)}finally{a(x,!1)}}await X()})()});async function X(){try{const e=await w.loadPosterConfig(p.params.id);e&&(console.log("[EventPoster] Configuration chargée depuis le cache"),e.current?(a(u,{...t(u),...e.current},!0),a(R,e.versions||[],!0)):(a(u,{...t(u),...e},!0),a(R,[],!0)))}catch(e){console.error("[EventPoster] Erreur chargement config cache:",e)}}async function fe(){try{await w.savePosterConfig(p.params.id,se(t(u))),o.toast.success("Configuration sauvegardée",{details:"Les réglages courants sont enregistrés localement."})}catch(e){console.error("[EventPoster] Erreur sauvegarde config cache:",e),o.toast.error("Erreur de sauvegarde",{details:"Impossible d'enregistrer la configuration localement."})}}async function de(){try{const e=new Date,n=`Version du ${new Intl.DateTimeFormat("fr-FR",{dateStyle:"short",timeStyle:"short"}).format(e)}`,l=await w.createPosterVersion(p.params.id,se(t(u)),n);await X(),l&&a(I,l.id,!0),o.toast.success("Version créée",{details:"Une nouvelle version de la configuration a été archivée."})}catch(e){console.error("[EventPoster] Erreur création version:",e),o.toast.error("Erreur de création",{details:e.message||"Impossible de créer une nouvelle version."})}}async function pe(e){try{await w.deletePosterVersion(p.params.id,e),a(R,t(R).filter(r=>r.id!==e),!0),t(I)===e&&a(I,null),o.toast.success("Version supprimée",{details:"La version archivée a été supprimée."})}catch(r){console.error("[EventPoster] Erreur suppression version:",r),o.toast.error("Erreur de suppression",{details:"Impossible de supprimer la version."})}}function ge(e){a(u,{...t(u),...e.config},!0),a(I,e.id,!0),o.toast.info("Version chargée",{details:`La configuration "${e.name}" a été appliquée.`})}Z(()=>{if(!t(s)||t(x))return;if(!(t(s).meals&&t(s).meals.some(r=>r.recipes&&r.recipes.length>0))){a(D,!1);return}t(E).length===0&&!t(D)&&ve().then(()=>{me()})});async function ve(){if(!t(s)?.meals)return;const e=t(s).meals.flatMap(r=>r.recipes.map(n=>n.recipeUuid));if(e.length===0){a(D,!1);return}a(D,!0);try{console.log(`[EventPoster] Loading ${e.length} recipes (bulk mode)...`);const r=await ee.getRecipesByUuidsBulk(e);a(E,Array.from(r.values()).filter(n=>n!==null),!0),console.log(`[EventPoster] Loaded ${t(E).length}/${e.length} recipes in bulk`),console.log("[EventPoster] Recipe IDs:",t(E).map(n=>n.$id))}catch(r){console.error("Erreur lors du chargement des recettes:",r)}finally{a(D,!1)}}function me(){t(s)?.meals&&t(s).meals.forEach(e=>{const r=new Date(e.date),n=r.toISOString().split("T")[0],l=r.getHours(),y=l<12?"Petit-déjeuner":l<14?"Déjeuner":l<18?"Goûter":"Dîner",c=`${n}${y}`;e.recipes.forEach(i=>{const b=`${c}_${i.recipeUuid}`;P[b]=!0;const _=ee.getRecipeIndexByUuid(i.recipeUuid);k[b]=_?.title||i.recipeUuid})})}async function he(e){a(A,e,!0),await te(),setTimeout(()=>{window.print(),a(A,null)},400)}async function ye(){a(A,null),await te(),setTimeout(()=>{window.print()},400)}function be(e){P[e]=!P[e],P[e]||console.log("to-implement")}function we(e){a(H,e,!0)}function _e(){a(H,null)}function Ee(e,r){k[e]=r}function De(e,r){return k[e]||r}async function Re(e){if(!(!p.params.id||!o.userId))try{a(j,!0);const r=e?"accepted":"declined";await w.updateContributorStatus(p.params.id,o.userId,r),o.toast.success(e?"Invitation acceptée":"Invitation déclinée")}catch(r){console.error("Erreur réponse invitation:",r),o.toast.error("Erreur lors de la réponse")}finally{a(j,!1)}}Z(()=>{t(s)&&ne.setConfig({title:`Affiches : ${t(s).name}`,backAction:()=>navigate(`/event/${p.params.id}`),actions:le})}),onDestroy(()=>{ne.reset()});var Q=$(),Ie=C(Q);{var Pe=e=>{var r=Ne();g(e,r)},Se=e=>{var r=$(),n=C(r);{var l=c=>{var i=Ge(),b=v(i),_=v(b);AlertCircle(_,{class:"h-6 w-6 shrink-0"});var T=O(_,2),h=v(T,!0);m(T),m(b),m(i),re(()=>$e(h,t(U))),g(c,i)},y=c=>{var i=$(),b=C(i);{var _=h=>{var d=Fe(),z=v(d),M=v(z);Info(M,{}),ae(2),m(z),m(d),g(h,d)},T=h=>{var d=$(),z=C(d);{var M=N=>{var W=Ke(),Y=C(W);LeftPanel(Y,{bgClass:"bg-base-200",width:"120",children:(Be,Oe)=>{{let xe=V(()=>!t(ce));PosterConfiguration(Be,{get versions(){return t(R)},get activeVersionId(){return t(I)},onSave:fe,onCreateVersion:de,onDeleteVersion:pe,onLoadVersion:ge,get disabled(){return t(xe)},get config(){return t(u)},set config(Ae){a(u,Ae,!0)}})}},$$slots:{default:!0}});var G=O(Y,2),F=v(G),Ve=v(F);EventInvitationAlert(Ve,{get currentEvent(){return t(s)},get isBusy(){return t(j)},onRespond:Re}),m(F);var K=O(F,2),Ce=v(K);PosterDisplay(Ce,{get event(){return t(s)},get groupedMeals(){return t(ue)},get config(){return t(u)},get currentPrintTarget(){return t(A)},get recipesDetails(){return t(E)},get recipeVisibility(){return P},get recipeNames(){return k},get editingRecipe(){return t(H)},printThis:he,toggleRecipeVisibility:be,startEditingRecipe:we,finishEditingRecipe:_e,updateRecipeName:Ee,getRecipeName:De}),m(K),m(G),re(()=>Ue(K,1,`print:m-0 print:p-0 ${o.isDesktop?"ml-80":""}`)),je(3,G,()=>fade),g(N,W)};L(z,N=>{t(s)&&N(M)},!0)}g(h,d)};L(b,h=>{!t(s)||t(s).meals&&t(s).meals.length>0&&t(s).meals.every(d=>!d.recipes||d.recipes.length===0)?h(_):h(T,!1)},!0)}g(c,i)};L(n,c=>{t(U)?c(l):c(y,!1)},!0)}g(e,r)};L(Ie,e=>{t(x)?e(Pe):e(Se,!1)})}g(ie,Q),ze()}Le(["click"]);export{Qe as default};
