import{d as Qe,y as b,z as Re,X as Ze,I as w,O as T,E as fe,m as e,u as _,a1 as P,A as s,Y as Ee,J as pe,v,k as N,K as x,h as r,g as c,P as et,b as l,c as tt,D as Le,F as at,w as W,x as Z,j as Pe,B as rt,H as st,G as ee,o as a,W as Se,T as Ie,e as nt,i as ot}from"./appwrite.js";import{n as Te,a as it}from"./index.js";import{M as lt}from"./MarkdownEditorAdvanced.js";import{B as dt}from"./BtnGroupCheck.js";import{U as ct}from"./UnsavedChangesGuard.js";import{S as ut}from"./SvelteMarkdown.js";import{b as vt,a4 as mt,c as ft,f as pt}from"./icons.js";import"./tiptap-markdown.es.js";import"./CheckboxBadge.js";import"./legacy.js";var gt=v('<span class="loading loading-spinner loading-sm"></span>'),_t=v('<button class="btn btn-primary btn-sm"><!> Enregistrer</button>'),bt=v('<div class="flex items-center gap-2"><!></div>'),yt=v('<div class="alert alert-warning max-md:alert-vertical mb-4"><!> <div><h4 class="font-bold">Document verrouillé</h4> <p class="text-sm">Ce document est actuellement édité par <span class="font-bold"> </span> . Vous ne pouvez pas le modifier pour le moment.</p></div></div>'),ht=v('<div class="flex justify-center py-20"><div class="loading loading-spinner loading-lg"></div></div>'),wt=v("<div><!></div>"),xt=v('<fieldset class="fieldset flex"><label class="input input-lg w-full"><span class="label">Nom</span> <input type="text" placeholder="Titre du document" maxlength="50" required/></label></fieldset> <fieldset class="fieldset"><!></fieldset> <fieldset class="fieldset"><legend class="fieldset-legend">Tags</legend> <div class="flex flex-wrap items-center gap-x-6 gap-y-2"><!> <label class="input w-80"><input type="text" placeholder="Nouveau tag..." maxlength="30"/> <button class="btn btn-primary btn-sm"><!> Ajouter</button></label></div></fieldset>',1),kt=v('<div class="flex items-center gap-2"><!> <span>Chargement...</span></div>'),Dt=v('<span class="badge badge-secondary badge-soft"> </span>'),Et=v('<div class="flex flex-wrap items-center justify-between gap-x-4 gap-y-2"><h1 class="text-2xl font-bold"> </h1> <p class="text-sm opacity-70">Équipe : <span class="font-medium"> </span></p></div> <div class="flex flex-wrap gap-2"></div>',1),Lt=v('<p class="text-sm opacity-70">Aucun contenu</p>'),Pt=v('<div class="mb-6 flex items-center justify-between"><div class="flex-1"><!></div></div> <div class="prose bg-base-100 max-w-none rounded-lg p-6 shadow-lg"><!></div>',1),St=v('<div class="space-y-4"><!></div>'),It=v('<div class="mx-auto max-w-5xl p-4" role="region" tabindex="-1"><!> <!></div> <!>',1);function Mt(Be,ze){Qe(ze,!0);const Ae=t=>{var n=bt(),p=r(n);{var z=h=>{var g=_t();g.__click=oe;var K=r(g);{var le=m=>{var S=gt();l(m,S)},de=m=>{mt(m,{class:"h-4 w-4"})};x(K,m=>{e(B)?m(le):m(de,!1)})}ee(),a(g),W(()=>g.disabled=!e(Y)||!e(_e)||e(B)),l(h,g)};x(p,h=>{e(re)&&h(z)})}a(n),l(t,n)};let $=_(()=>Le.params.teamId),f=_(()=>Le.params.docId),y=b(null),k=b(""),D=b(""),o=b(Re([])),q=b(""),C=b(!1),V=b(!0),B=b(!1),E=b(null),F=b(""),X=null,te=b("");const Ne=_(()=>st.get("mode")||"preview");let ae=_(()=>at.myTeams.find(t=>t.$id===e($))),ge=_(()=>{const t=P.getTeamTags(e($)),n=new Set([...t,...e(o)]);return Array.from(n).map(p=>({id:p,label:p,selected:e(o).includes(p)}))});const re=_(()=>JSON.stringify({title:e(k),content:e(D),tags:e(o),isPublic:e(C)})!==e(te)),se=_(()=>!!e(E)&&e(E)!==w.userId),ne=_(()=>!!e(E)&&e(E)===w.userId),Y=_(()=>!e(se)&&!e(V)&&!e(B)),_e=_(()=>e(k).trim().length>0&&e(ae)!==void 0);async function qe(){if(!e(f)||!w.userId||!e(y))return!1;try{const t=e(y).lockedBy,n=e(y).$updatedAt?new Date(e(y).$updatedAt):null,p=n&&Date.now()-n.getTime()>3e5;if(t&&t!==w.userId)if(p)console.log("[EditDocumentPage] Verrou précédent expiré, reprise de contrôle...");else return s(E,t,!0),console.warn("[EditDocumentPage] Document déjà verrouillé"),!1;return await P.updateDocumentLock(e(f),w.userId),s(E,w.userId,!0),s(F,w.userName||"",!0),Ce(),console.log(`[EditDocumentPage] Lock acquis pour ${e(f)}`),!0}catch(t){return console.error("[EditDocumentPage] Erreur acquisition lock:",t),T.error("Impossible de verrouiller le document"),!1}}function Ce(){be(),X=setInterval(async()=>{if(e(E)===w.userId&&e(f))try{await P.updateDocumentLock(e(f),w.userId),console.log(`[EditDocumentPage] Heartbeat envoyé pour ${e(f)}`)}catch(t){console.error("[EditDocumentPage] Erreur heartbeat:",t)}},12e4)}function be(){X&&(clearInterval(X),X=null)}async function Ve(){if(e(f)&&(be(),e(ne)))try{await P.updateDocumentLock(e(f),null),s(E,null),s(F,""),console.log(`[EditDocumentPage] Lock libéré pour ${e(f)}`)}catch(t){console.error("[EditDocumentPage] Erreur libération lock:",t)}}Ze(async()=>{if(!w.userId){T.error("Vous devez être connecté"),fe("/");return}if(!e(ae)){T.error("Équipe introuvable"),fe("/");return}P.isInitialized||await P.initialize(),s(V,!0);try{const t=P.getDocumentById(e(f));if(!t){T.error("Document introuvable"),fe(`/teams/${e($)}`);return}s(y,t,!0),s(k,t.title||"",!0),s(D,t.content||"",!0),s(o,t.tags||[],!0),s(C,t.isPublic||!1,!0),s(te,JSON.stringify({title:e(k),content:e(D),tags:e(o),isPublic:e(C)}),!0),await qe()}catch(t){console.error("[EditDocumentPage] Erreur chargement document:",t),T.error("Erreur lors du chargement du document")}finally{s(V,!1)}}),Ee(async()=>{await Ve()}),pe(()=>{const t=n=>{e(re)&&e(ne)&&(n.preventDefault(),n.returnValue="")};return window.addEventListener("beforeunload",t),()=>window.removeEventListener("beforeunload",t)});function ye(){const t=e(q).trim().toLowerCase();t&&!e(o).includes(t)&&(s(o,[...e(o),t],!0),s(q,""))}function je(t){t.key==="Enter"&&(t.preventDefault(),ye())}function Ke(t){e(o).includes(t)?s(o,e(o).filter(n=>n!==t),!0):s(o,[...e(o),t],!0)}async function oe(){if(!(!e(_e)||e(B)||!e(y))){s(B,!0);try{await P.updateDocument(e(f),{title:e(k).trim(),content:e(D),tags:e(o).length>0?e(o):null,isPublic:e(C)}),s(te,JSON.stringify({title:e(k),content:e(D),tags:e(o),isPublic:e(C)}),!0),T.success("Document enregistré avec succès")}catch(t){console.error("[EditDocumentPage] Erreur sauvegarde:",t),T.error("Erreur lors de la sauvegarde du document")}finally{s(B,!1)}}}function ie(t){(t.ctrlKey||t.metaKey)&&t.key==="s"&&(t.preventDefault(),oe())}const Me=_(()=>e(y)?`Document: ${e(y).title}`:"Modifier le document");pe(()=>{Te.setConfig({title:e(Me),actions:Ae,isLockedByOthers:e(se),lockedByUserName:e(F)})}),Ee(()=>{Te.reset()}),pe(()=>(window.addEventListener("keydown",ie),()=>window.removeEventListener("keydown",ie)));var he=It(),j=N(he);j.__keydown=ie;var we=r(j);{var Oe=t=>{var n=yt(),p=r(n);vt(p,{class:"h-5 w-5"});var z=c(p,2),h=c(r(z),2),g=c(r(h)),K=r(g,!0);a(g),ee(),a(h),a(z),a(n),W(()=>Z(K,e(F)||"un autre utilisateur")),l(t,n)};x(we,t=>{e(se)&&t(Oe)})}var Ue=c(we,2);{var He=t=>{var n=ht();l(t,n)},Je=t=>{var n=Pe(),p=N(n);{var z=h=>{var g=St(),K=r(g);{var le=m=>{var S=xt(),I=N(S),M=r(I),O=c(r(M),2);Se(O),a(M),a(I);var U=c(I,2),ce=r(U);lt(ce,{placeholder:"Commencez à rédiger votre document...",get value(){return e(D)},set value(d){s(D,d,!0)}}),a(U);var H=c(U,2),Q=c(r(H),2),R=r(Q);{var ue=d=>{var A=wt(),J=r(A);dt(J,{get items(){return e(ge)},onToggleItem:G=>Ke(G),size:"md",showStats:!1}),a(A),l(d,A)};x(R,d=>{e(ge).length>0&&d(ue)})}var i=c(R,2),u=r(i);Se(u),u.__keydown=je;var L=c(u,2);L.__click=ye;var ve=r(L);ft(ve,{class:"h-4 w-4"}),ee(),a(L),a(i),a(Q),a(H),W(d=>{O.disabled=!e(Y),u.disabled=!e(Y),L.disabled=d},[()=>!e(Y)||!e(q).trim()]),Ie(O,()=>e(k),d=>s(k,d)),Ie(u,()=>e(q),d=>s(q,d)),l(m,S)},de=m=>{var S=Pt(),I=N(S),M=r(I),O=r(M);{var U=i=>{var u=kt(),L=r(u);pt(L,{class:"h-5 w-5 animate-spin"}),ee(2),a(u),l(i,u)},ce=i=>{var u=Pe(),L=N(u);{var ve=d=>{var A=Et(),J=N(A),G=r(J),We=r(G,!0);a(G);var xe=c(G,2),ke=c(r(xe)),$e=r(ke,!0);a(ke),a(xe),a(J);var De=c(J,2);nt(De,21,()=>e(o),ot,(Fe,Xe)=>{var me=Dt(),Ye=r(me);a(me),W(()=>Z(Ye,`#${e(Xe)??""}`)),l(Fe,me)}),a(De),W(()=>{Z(We,e(k)),Z($e,e(ae)?.name)}),l(d,A)};x(L,d=>{e(y)&&d(ve)},!0)}l(i,u)};x(O,i=>{e(V)?i(U):i(ce,!1)})}a(M),a(I);var H=c(I,2),Q=r(H);{var R=i=>{ut(i,{get source(){return e(D)}})},ue=i=>{var u=Lt();l(i,u)};x(Q,i=>{e(D)?i(R):i(ue,!1)})}a(H),l(m,S)};x(K,m=>{e(Ne)==="edit"?m(le):m(de,!1)})}a(g),l(h,g)};x(p,h=>{e(y)&&h(z)},!0)}l(t,n)};x(Ue,t=>{e(V)?t(He):t(Je,!1)})}a(j);var Ge=c(j,2);{let t=_(()=>`editdocument/${e($)}/${e(f)}`);ct(Ge,{get routeKey(){return e(t)},shouldProtect:()=>e(re)&&e(ne),onLeaveWithoutSave:()=>{},onSaveAndLeave:async()=>(await oe(),!0),message:"Vous avez des modifications non sauvegardées. Voulez-vous quitter sans enregistrer ?"})}et(3,j,()=>it),l(Be,he),tt()}rt(["click","keydown"]);export{Mt as default};
