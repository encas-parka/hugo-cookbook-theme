import{aL as at,E as rt,b as st,x as nt,P as ot,e as it}from"./icons.js";import{d as Ne,p as lt,v as m,g as r,h as u,w as K,b as l,c as je,B as qe,C as Se,K as U,o as a,y,z as dt,Z as ct,$ as Be,H as be,k as V,I as k,G as D,M as z,E as ye,m as e,u as h,a3 as S,A as n,F as ut,x as ne,j as Ce,U as Ae,R as Me,e as vt,i as mt}from"./appwrite.js";import{M as ft}from"./MarkdownEditorAdvanced.js";import{B as gt}from"./BtnGroupCheck.js";import{U as pt}from"./UnsavedChangesGuard.js";import{S as _t}from"./SvelteMarkdown.js";import{n as ze}from"./index.js";import"./tiptap-markdown.es.js";import"./CheckboxBadge.js";var bt=m('<div class="rounded-box bg-secondary/10 px-4 py-1"><div class="tabs tabs-border justify-center"><button><!> Édition</button> <button><!> Aperçu</button></div></div>');function yt(oe,E){Ne(E,!0);let Q=lt(E,"disabled",3,!1);function X(C){Q()||E.onModeChange(C)}var L=bt(),d=r(L),i=r(d);let p;i.__click=()=>X("edit");var w=r(i);at(w,{class:"h-4 w-4"}),U(),a(i);var o=u(i,2);let P;o.__click=()=>X("preview");var B=r(o);rt(B,{class:"h-4 w-4"}),U(),a(o),a(d),a(L),K(()=>{p=Se(i,1,"tab gap-2 font-semibold",null,p,{"tab-active":E.mode==="edit"}),i.disabled=Q(),P=Se(o,1,"tab gap-2 font-semibold",null,P,{"tab-active":E.mode==="preview"})}),l(oe,L),je()}qe(["click"]);var ht=m('<span class="loading loading-spinner loading-sm"></span>'),wt=m('<button class="btn btn-primary"><!> Enregistrer</button>'),xt=m('<div class="flex items-center gap-2"><!></div>'),kt=m('<div class="alert alert-warning max-md:alert-vertical mb-4"><!> <div><h4 class="font-bold">Document verrouillé</h4> <p class="text-sm">Ce document est actuellement édité par <span class="font-bold"> </span> . Vous ne pouvez pas le modifier pour le moment.</p></div></div>'),Dt=m('<div class="flex justify-center py-20"><div class="loading loading-spinner loading-lg"></div></div>'),Et=m("<div><!></div>"),Lt=m('<fieldset class="fieldset flex"><label class="input input-lg w-full"><span class="label">Nom</span> <input type="text" placeholder="Titre du document" maxlength="50" required/></label></fieldset> <fieldset class="fieldset"><!></fieldset> <fieldset class="fieldset"><legend class="fieldset-legend">Tags</legend> <div class="flex flex-wrap items-center gap-x-6 gap-y-2"><!> <label class="input w-80"><input type="text" placeholder="Nouveau tag..." maxlength="30"/> <button class="btn btn-primary btn-sm"><!> Ajouter</button></label></div></fieldset>',1),Pt=m('<div class="flex items-center gap-2"><!> <span>Chargement...</span></div>'),Tt=m('<span class="badge badge-secondary badge-soft"> </span>'),It=m('<div class="flex flex-wrap items-center justify-between gap-x-4 gap-y-2"><h1 class="text-2xl font-bold"> </h1> <p class="text-sm opacity-70">Équipe : <span class="font-medium"> </span></p></div> <div class="flex flex-wrap gap-2"></div>',1),St=m('<p class="text-sm opacity-70">Aucun contenu</p>'),Bt=m('<div class="mb-6 flex items-center justify-between"><div class="flex-1"><!></div></div> <div class="prose bg-base-100 max-w-none rounded-lg p-6 shadow-lg"><!></div>',1),Ct=m('<div class="space-y-4"><!></div>'),At=m('<div class="mx-auto max-w-5xl p-4" role="region" tabindex="-1"><!> <!></div> <!>',1);function Ht(oe,E){Ne(E,!0);const Q=t=>{var s=xt(),_=r(s);{var j=x=>{var b=wt();b.__click=ce;var H=r(b);{var ve=g=>{var A=ht();l(g,A)},me=g=>{nt(g,{class:"h-4 w-4"})};k(H,g=>{e(N)?g(ve):g(me,!1)})}U(),a(b),K(()=>b.disabled=!e(te)||!e(xe)||e(N)),l(x,b)};k(_,x=>{e(O)==="edit"&&x(j)})}a(s),l(t,s)},X=t=>{yt(t,{get mode(){return e(O)},get disabled(){return e(ee)},onModeChange:s=>n(O,s,!0)})};let L=h(()=>E.params.teamId),d=h(()=>E.params.docId),i=y(null),p=y(""),w=y(""),o=y(dt([])),P=y(""),B=y(!1),C=y(!0),N=y(!1),T=y(null),Y=y(""),$=null,ie=y(""),O=y("preview"),le=h(()=>ut.myTeams.find(t=>t.$id===e(L))),he=h(()=>{const t=S.getTeamTags(e(L)),s=new Set([...t,...e(o)]);return Array.from(s).map(_=>({id:_,label:_,selected:e(o).includes(_)}))});const we=h(()=>JSON.stringify({title:e(p),content:e(w),tags:e(o),isPublic:e(B)})!==e(ie)),ee=h(()=>!!e(T)&&e(T)!==D.userId),de=h(()=>!!e(T)&&e(T)===D.userId),te=h(()=>!e(ee)&&!e(C)&&!e(N)),xe=h(()=>e(p).trim().length>0&&e(le)!==void 0);async function Ve(){if(!e(d)||!D.userId||!e(i))return!1;try{const t=e(i).lockedBy,s=e(i).$updatedAt?new Date(e(i).$updatedAt):null,_=s&&Date.now()-s.getTime()>3e5;if(t&&t!==D.userId)if(_)console.log("[EditDocumentPage] Verrou précédent expiré, reprise de contrôle...");else return n(T,t,!0),console.warn("[EditDocumentPage] Document déjà verrouillé"),!1;return await S.updateDocumentLock(e(d),D.userId),n(T,D.userId,!0),n(Y,D.userName||"",!0),Ke(),console.log(`[EditDocumentPage] Lock acquis pour ${e(d)}`),!0}catch(t){return console.error("[EditDocumentPage] Erreur acquisition lock:",t),z.error("Impossible de verrouiller le document"),!1}}function Ke(){ke(),$=setInterval(async()=>{if(e(T)===D.userId&&e(d))try{await S.updateDocumentLock(e(d),D.userId),console.log(`[EditDocumentPage] Heartbeat envoyé pour ${e(d)}`)}catch(t){console.error("[EditDocumentPage] Erreur heartbeat:",t)}},12e4)}function ke(){$&&(clearInterval($),$=null)}async function Ue(){if(e(d)&&(ke(),e(de)))try{await S.updateDocumentLock(e(d),null),n(T,null),n(Y,""),console.log(`[EditDocumentPage] Lock libéré pour ${e(d)}`)}catch(t){console.error("[EditDocumentPage] Erreur libération lock:",t)}}ct(async()=>{if(!D.userId){z.error("Vous devez être connecté"),ye("/");return}if(!e(le)){z.error("Équipe introuvable"),ye("/");return}S.isInitialized||await S.initialize(),n(C,!0);try{const t=S.getDocumentById(e(d));if(!t){z.error("Document introuvable"),ye(`/teams/${e(L)}`);return}n(i,t,!0),n(p,t.title||"",!0),n(w,t.content||"",!0),n(o,t.tags||[],!0),n(B,t.isPublic||!1,!0),n(ie,JSON.stringify({title:e(p),content:e(w),tags:e(o),isPublic:e(B)}),!0),await Ve()}catch(t){console.error("[EditDocumentPage] Erreur chargement document:",t),z.error("Erreur lors du chargement du document")}finally{n(C,!1)}}),Be(async()=>{await Ue()}),be(()=>{const t=s=>{e(we)&&e(de)&&(s.preventDefault(),s.returnValue="")};return window.addEventListener("beforeunload",t),()=>window.removeEventListener("beforeunload",t)});function De(){const t=e(P).trim().toLowerCase();t&&!e(o).includes(t)&&(n(o,[...e(o),t],!0),n(P,""))}function Oe(t){t.key==="Enter"&&(t.preventDefault(),De())}function He(t){e(o).includes(t)?n(o,e(o).filter(s=>s!==t),!0):n(o,[...e(o),t],!0)}async function ce(){if(!(!e(xe)||e(N)||!e(i))){n(N,!0);try{await S.updateDocument(e(d),{title:e(p).trim(),content:e(w),tags:e(o).length>0?e(o):null,isPublic:e(B)}),n(ie,JSON.stringify({title:e(p),content:e(w),tags:e(o),isPublic:e(B)}),!0),z.success("Document enregistré avec succès")}catch(t){console.error("[EditDocumentPage] Erreur sauvegarde:",t),z.error("Erreur lors de la sauvegarde du document")}finally{n(N,!1)}}}function ue(t){(t.ctrlKey||t.metaKey)&&t.key==="s"&&(t.preventDefault(),ce())}const Ge=h(()=>e(i)?`Document: ${e(i).title}`:"Modifier le document"),Je=h(()=>e(O)==="edit"?0:1);be(()=>{ze.setConfig({title:e(Ge),actions:Q,tabs:X,eventId:e(d),activeTab:e(Je),isLockedByOthers:e(ee),lockedByUserName:e(Y)})}),Be(()=>{ze.reset()}),be(()=>(window.addEventListener("keydown",ue),()=>window.removeEventListener("keydown",ue)));var Ee=At(),ae=V(Ee);ae.__keydown=ue;var Le=r(ae);{var Fe=t=>{var s=kt(),_=r(s);st(_,{class:"h-5 w-5"});var j=u(_,2),x=u(r(j),2),b=u(r(x)),H=r(b,!0);a(b),U(),a(x),a(j),a(s),K(()=>ne(H,e(Y)||"un autre utilisateur")),l(t,s)};k(Le,t=>{e(ee)&&t(Fe)})}var Re=u(Le,2);{var We=t=>{var s=Dt();l(t,s)},Ze=t=>{var s=Ce(),_=V(s);{var j=x=>{var b=Ct(),H=r(b);{var ve=g=>{var A=Lt(),M=V(A),G=r(M),J=u(r(G),2);Ae(J),a(G),a(M);var F=u(M,2),fe=r(F);ft(fe,{placeholder:"Commencez à rédiger votre document...",get value(){return e(w)},set value(v){n(w,v,!0)}}),a(F);var R=u(F,2),re=u(r(R),2),se=r(re);{var ge=v=>{var q=Et(),W=r(q);gt(W,{get items(){return e(he)},onToggleItem:Z=>He(Z),size:"md",showStats:!1}),a(q),l(v,q)};k(se,v=>{e(he).length>0&&v(ge)})}var c=u(se,2),f=r(c);Ae(f),f.__keydown=Oe;var I=u(f,2);I.__click=De;var pe=r(I);ot(pe,{class:"h-4 w-4"}),U(),a(I),a(c),a(re),a(R),K(v=>{J.disabled=!e(te),f.disabled=!e(te),I.disabled=v},[()=>!e(te)||!e(P).trim()]),Me(J,()=>e(p),v=>n(p,v)),Me(f,()=>e(P),v=>n(P,v)),l(g,A)},me=g=>{var A=Bt(),M=V(A),G=r(M),J=r(G);{var F=c=>{var f=Pt(),I=r(f);it(I,{class:"h-5 w-5 animate-spin"}),U(2),a(f),l(c,f)},fe=c=>{var f=Ce(),I=V(f);{var pe=v=>{var q=It(),W=V(q),Z=r(W),Xe=r(Z,!0);a(Z);var Pe=u(Z,2),Te=u(r(Pe)),Ye=r(Te,!0);a(Te),a(Pe),a(W);var Ie=u(W,2);vt(Ie,21,()=>e(o),mt,($e,et)=>{var _e=Tt(),tt=r(_e);a(_e),K(()=>ne(tt,`#${e(et)??""}`)),l($e,_e)}),a(Ie),K(()=>{ne(Xe,e(p)),ne(Ye,e(le)?.name)}),l(v,q)};k(I,v=>{e(i)&&v(pe)},!0)}l(c,f)};k(J,c=>{e(C)?c(F):c(fe,!1)})}a(G),a(M);var R=u(M,2),re=r(R);{var se=c=>{_t(c,{get source(){return e(w)}})},ge=c=>{var f=St();l(c,f)};k(re,c=>{e(w)?c(se):c(ge,!1)})}a(R),l(g,A)};k(H,g=>{e(O)==="edit"?g(ve):g(me,!1)})}a(b),l(x,b)};k(_,x=>{e(i)&&x(j)},!0)}l(t,s)};k(Re,t=>{e(C)?t(We):t(Ze,!1)})}a(ae);var Qe=u(ae,2);{let t=h(()=>`editdocument/${e(L)}/${e(d)}`);pt(Qe,{get routeKey(){return e(t)},shouldProtect:()=>e(we)&&e(de),onLeaveWithoutSave:()=>{},onSaveAndLeave:async()=>(await ce(),!0),message:"Vous avez des modifications non sauvegardées. Voulez-vous quitter sans enregistrer ?"})}l(oe,Ee),je()}qe(["click","keydown"]);export{Ht as default};
