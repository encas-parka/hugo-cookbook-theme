import{d as Y,z as Q,J as g,m as e,y,I as u,O as v,E as b,u as m,A as i,N as W,Y as X,v as w,k as C,K as G,h as x,g as A,P as Z,b as _,c as ee,w as re,x as te,D as ae,at as se,au as ie,av as oe,aw as ne,ax as ce,j as ue,B as de,o as $}from"./appwrite.js";import{r as B}from"./RecipeDataStore.svelte.js";import{n as N,a as le}from"./index.js";import{t as pe,c as ve,a as P,v as me,n as fe,p as ge,R as ye,b as _e,d as he}from"./RecipeEditPage2.js";import{U as Re}from"./UnsavedChangesGuard.js";import{a4 as Se}from"./icons.js";import"./products-display.js";import"./tiptap-markdown.es.js";import"./Fieldset.js";import"./BtnGroupCheck.js";import"./CheckboxBadge.js";var be=w('<div class="flex items-center gap-2"><button class="btn btn-primary btn-sm"><!> </button></div>'),xe=w('<div class="flex items-center justify-center py-20"><div class="loading loading-spinner loading-lg"></div></div>'),Ae=w('<div class="space-y-6"><!> <!> <!></div>'),$e=w('<div class="max-w-9xl container mx-auto px-4 py-8"><!></div> <!>',1);function Ge(F,L){Y(L,!0);const U=t=>{var a=be(),o=x(a);o.__click=k;var c=x(o);Se(c,{class:"h-4 w-4"});var s=A(c);$(o),$(a),re(()=>{o.disabled=e(n)||!e(V),te(s,` ${e(n)?"Sauvegarde...":"Créer la recette"}`)}),_(t,a)},d=m(()=>ae.params.uuid);let r=y(null),l=y(!1),n=y(!1),h=y(null),D=y(!1),I=Q({value:{}});const V=m(()=>!e(r)||!e(h)?!1:P(e(r))!==e(h));g(()=>{e(r)&&e(r).check!==!0&&(e(r).draft=!0)});const E=m(()=>!0),H=m(()=>({materiel:B.materiel,categories:B.categories,regimes:B.regimes}));g(()=>{if(!u.userId){v.error("Vous devez être connecté"),b("/");return}}),g(()=>{if(!(e(l)||!u.userId)){if(e(d)&&!e(l)&&!e(n)){i(n,!0),W.getRecipeByUuid(e(d)).then(async t=>{if(t){const a=u.userName||"utilisateur",o=t.rootRecipeId||t.$id,p=`v${(await W.getVariantGroup(e(d))).variants.length+1} - ${a}`;i(r,pe(t,{title:t.title,$id:"new-recipe",$createdAt:void 0,$updatedAt:void 0,lockedBy:null,createdBy:u.userId||"",permissionWrite:[u.userId||""],check:null,draft:!0,rootRecipeId:o,versionLabel:p}),!0),i(l,!0)}else v.error("Recette source introuvable"),b("/recipe")}).catch(t=>{console.error("Erreur chargement:",t),v.error("Erreur lors du chargement"),b("/recipe")}).finally(()=>{i(n,!1)});return}if(!e(d)&&!e(l)){i(r,{...ve(),$id:"new-recipe"},!0),i(l,!0);return}}}),g(()=>{e(r)&&e(l)&&!e(h)&&i(h,P(e(r)),!0)});const j=m(()=>e(d)?"Nouvelle version de recette":"Nouvelle recette");g(()=>{N.setConfig({title:e(j),actions:U})}),X(()=>{N.reset()});async function k(){if(!e(r)||e(n)||!u.userId||!me(e(r),I))return;i(n,!0);const a=v.loading("Sauvegarde en cours...");try{e(r).$id=se(e(r).title,e(r).versionLabel||void 0);const c={...fe(e(r)),ingredients:oe(e(r).ingredients),astuces:ie(e(r).astuces),prepAlt:e(r).prepAlt},s=await ne(c,u.userId);v.update(a,{state:"success",message:"Recette créée avec succès !"});const p=ge(e(r),c,{id:s.$id,createdAt:s.$createdAt,updatedAt:s.$updatedAt,createdBy:s.createdBy});ce("save_recipe",s.$id,u.userId,p,!0).catch(S=>{console.error("Sync vers GitHub échouée:",S)}),i(D,!0),setTimeout(()=>{b(`/recipe/${s.$id}`)},1500)}catch(o){console.error("Erreur sauvegarde:",o),v.update(a,{state:"error",message:"Erreur lors de la création"})}finally{i(n,!1),setTimeout(()=>v.dismiss(a),3e3)}}var z=$e(),R=C(z),K=x(R);{var M=t=>{var a=xe();_(t,a)},q=t=>{var a=ue(),o=C(a);{var c=s=>{var p=Ae(),S=x(p);ye(S,{get recipeInfo(){return e(H)},get validationErrors(){return I.value},canEdit:e(E),get recipe(){return e(r)},set recipe(f){i(r,f,!0)}});var T=A(S,2);_e(T,{get validationErrors(){return I.value},canEdit:e(E),get recipe(){return e(r)},set recipe(f){i(r,f,!0)}});var O=A(T,2);he(O,{get createdBy(){return e(r).createdBy},canEdit:e(E),get permissionWrite(){return e(r).permissionWrite},set permissionWrite(f){e(r).permissionWrite=f}}),$(p),_(s,p)};G(o,s=>{e(r)&&s(c)},!0)}_(t,a)};G(K,t=>{e(l)?t(q,!1):t(M)})}$(R);var J=A(R,2);{let t=m(()=>e(d)?`/recipe/${e(d)}/duplicate`:"/recipe/new");Re(J,{get routeKey(){return e(t)},shouldProtect:()=>e(V)&&!e(D),onLeaveWithoutSave:()=>{},onSaveAndLeave:async()=>{await k()},message:"Vous avez des modifications non sauvegardées. Voulez-vous vraiment quitter ?"})}Z(1,R,()=>le),_(F,z),ee()}de(["click"]);export{Ge as default};
