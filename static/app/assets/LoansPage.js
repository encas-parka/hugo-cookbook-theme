import{d as Ge,p as Ga,y as J,z as xa,J as ea,A as _,v as f,g as r,h as t,e as Se,b as u,aa as na,m as e,u as q,w as z,x as L,C as Le,c as He,t as Ha,B as Ke,o as a,G as j,K as S,M as aa,ac as Ka,I as Te,T as je,ai as qa,$ as le,O as Qe,k as De,W as _e,ae as Ra,i as ga,af as Wa,j as $e,al as ma,D as Ja,E as fa,Y as Xa,P as Ya,F as Za}from"./appwrite.js";import{n as Aa,f as $a}from"./index.js";import{A as et}from"./AutocompleteInput.js";import{B as at}from"./BtnGroupCheck.js";import{X as ye,a5 as ta,a6 as ha,r as ya,a7 as wa,k as ka,a8 as sa,a9 as Ia,ab as Da,t as ra,j as Fa,ad as Ma,_ as Na,G as Ve,ac as tt,ae as Ta,af as ja,x as _a,ag as st,ah as rt,ai as nt,aj as lt,ak as it,D as ot,T as Ea,U as za,c as dt}from"./icons.js";import{a as Pa}from"./date-helpers.js";import"./keyboardNavigation.svelte.js";import"./CheckboxBadge.js";var ct=f('<div class="mb-6"><h4 class="mb-3 flex items-center gap-2 text-base font-semibold"><div class="bg-primary/10 rounded-lg p-1.5"><!></div> <span class="badge badge-ghost badge-sm ml-auto"> </span></h4> <!></div>'),vt=f('<div class="text-center py-12 opacity-50"><!> <p class="text-lg font-medium">Aucun matériel disponible</p> <p class="text-sm mt-2">Tous les matériels sont actuellement empruntés ou non disponibles</p></div>'),ut=f(`<div><div class="modal-box fixed top-0 flex h-lvh w-lvw flex-col overflow-auto md:top-10 md:h-full md:max-h-11/12 md:w-full md:max-w-4xl"><div class="flex items-center justify-between border-b p-4 pt-0"><h3 class="text-lg font-bold">Sélection rapide du matériel</h3> <button class="btn btn-circle btn-ghost btn-sm absolute top-2 right-2" aria-label="Fermer"><!></button></div> <div class="flex-1 space-y-6 overflow-y-auto p-4"><div class="alert alert-info alert-soft text-base">Les nombres indiquent les quantités disponibles de chaque matériel, vous
        indiquerez après la quantité que vous souhaitez réserver.</div> <!></div> <div class="border-base-300 flex-none border-t px-4 py-3"><div class="flex flex-wrap items-center justify-between gap-2"><div class="text-sm opacity-70"> </div> <div class="flex gap-2"><button class="btn btn-ghost">Annuler</button> <button class="btn btn-primary">Ajouter la sélection</button></div></div></div></div></div>`);function bt(ge,n){Ge(n,!0);let E=Ga(n,"selectedIds",19,()=>new Set);const p=q(()=>({electronic:"Électronique",manual:"Ustensiles",cooking:"Matériel de cuisine",dish:"Vaisselle",gaz:"Gaz",hygiene:"Hygiène",other:"Autre"})),x=q(()=>({electronic:Ia,manual:sa,cooking:ka,dish:wa,gaz:ya,hygiene:ha,other:ta})),X=q(()=>{const I={};return n.materiels.forEach(M=>{const V=M.type||"other";I[V]||(I[V]=[]),I[V].push(M)}),I});let v=J(xa(new Set));ea(()=>{_(v,new Set(E()),!0)});function A(I){e(v).has(I)?e(v).delete(I):e(v).add(I),_(v,new Set(e(v)),!0)}function se(){n.onAdd(Array.from(e(v))),n.onClose()}function k(){_(v,new Set(E()),!0),n.onClose()}var F=ut(),Y=t(F),Z=t(Y),$=r(t(Z),2);$.__click=k;var ie=t($);ye(ie,{class:"h-4 w-4"}),a($),a(Z);var D=r(Z,2),de=r(t(D),2);Se(de,17,()=>Object.entries(e(X)),([I,M])=>I,(I,M,V,ce)=>{var R=q(()=>Ha(e(M),2));let ve=()=>e(R)[0],G=()=>e(R)[1];const o=q(()=>e(x)[ve()]);var b=ct(),N=t(b),d=t(N),s=t(d);na(s,()=>e(o),(g,h)=>{h(g,{class:"text-primary h-4 w-4"})}),a(d);var l=r(d),c=r(l),m=t(c);a(c),a(N);var w=r(N,2);{let g=q(()=>G().map(h=>({id:h.$id,label:h.name,badge:String(h.availableQuantity),selected:e(v).has(h.$id),title:`${h.availableQuantity}/${h.quantity} disponibles`})));at(w,{get items(){return e(g)},onToggleItem:A,size:"md",color:"primary"})}a(b),z(g=>{L(l,` ${e(p)[ve()]??""} `),L(m,`${g??""}/${G().length??""}`)},[()=>G().filter(g=>e(v).has(g.$id)).length]),u(I,b)},I=>{var M=vt(),V=t(M);ta(V,{class:"h-16 w-16 mx-auto mb-4"}),j(4),a(M),u(I,M)}),a(D);var re=r(D,2),ne=t(re),P=t(ne),U=t(P);a(P);var oe=r(P,2),ee=t(oe);ee.__click=k;var be=r(ee,2);be.__click=se,a(oe),a(ne),a(re),a(Y),a(F),z(()=>{Le(F,1,`modal ${(n.isOpen&&"modal-open")??""}`),L(U,`${e(v).size??""} matériel${e(v).size>1?"s":""}
          sélectionné${e(v).size>1?"s":""}`),be.disabled=e(v).size===0}),u(ge,F),He()}Ke(["click"]);var pt=f(`<div class="alert alert-info max-md:alert-vertical"><!> <span>Veuillez sélectionner une <strong>date de début</strong> et une <strong>date de fin</strong> pour voir le matériel disponible sur cette
              période.</span></div>`),mt=f('<div class="alert alert-warning"><!> <span>Aucun matériel disponible pour la période sélectionnée.</span></div>'),ft=f('<div class="flex flex-wrap gap-6"><div class="flex-1"><!></div> <button class="btn btn-secondary btn-md flex-1 gap-2"><!> Ajout rapide</button></div> <!>',1),_t=f("<option></option>"),gt=f('<div class="bg-base-200 rounded-lg p-2"><div class="flex items-center gap-2"><div class="bg-base-300 rounded p-1"><!></div> <div class="min-w-0 flex-1"><div class="truncate font-medium"> </div> <div class="text-xs opacity-70">Disponible : <span class="font-semibold"> </span></div></div> <div class="flex items-center gap-1"><span class="text-sm opacity-70"><!></span> <label class="select join"><select class="join-item select-sm select-bordered w-20"></select></label></div> <button class="btn btn-ghost btn-xs btn-circle" aria-label="Supprimer"><!></button></div></div>'),xt=f('<div class="space-y-2"><p class="text-sm font-semibold opacity-70">Matériels sélectionnés</p> <!></div>'),ht=f(`<div class="py-8 text-center opacity-50"><!> <p class="text-sm">Aucun matériel sélectionné</p> <p class="text-xs">Utilisez la recherche ou l'ajout rapide pour ajouter du matériel</p></div>`),yt=f('<span class="loading loading-spinner loading-sm"></span>'),wt=f(`<div><div class="modal-box fixed top-0 flex h-lvh w-lvw flex-col overflow-auto md:top-10 md:h-full md:max-h-11/12 md:w-full md:max-w-4xl"><div class="flex items-center justify-between border-b p-4 pt-0"><h3 class="flex items-center gap-2 text-lg font-bold"><!> </h3> <button class="btn btn-circle btn-ghost btn-sm absolute top-2 right-2" aria-label="Fermer"><!></button></div> <div class="flex-1 space-y-6 overflow-y-auto p-4"><div class="space-y-4"><div class="flex flex-wrap gap-4"><label class="input min-w-[200px] flex-1"><span class="label"><!> Date début *</span> <input type="date" class="grow"/></label> <label class="input min-w-[200px] flex-1"><span class="label"><!> Date fin *</span> <input type="date" class="grow"/></label></div> <label class="input w-full"><span class="label"><!> Responsable</span> <input type="text" class="grow" disabled/></label> <fieldset class="fieldset bg-base-100"><legend class="fieldset-legend">Notes (optionnel)</legend> <textarea class="textarea textarea-bordered w-full" rows="2" placeholder="Informations complémentaires sur l'emprunt..." maxlength="500"></textarea></fieldset> <fieldset class="fieldset bg-base-100"><legend class="fieldset-legend">Statut de la réservation</legend> <div class="flex flex-wrap gap-4"><label class="label justify-gap-3 cursor-pointer gap-3"><input type="radio" class="radio radio-primary"/> <span class="label-text"><strong class="block">Demande de réservation</strong> <span class="text-xs opacity-70">Si vous souhaitez attendre la validation du reste de l'équipe</span></span></label> <label class="label justify-gap-3 cursor-pointer gap-3"><input type="radio" class="radio radio-primary"/> <span class="label-text"><strong class="block">Réservation confirmée</strong> <span class="text-xs opacity-70">L'emprunt est automatiquement validé</span></span></label></div></fieldset></div> <div class="space-y-4"><h4 class="flex items-center gap-2 text-sm font-semibold uppercase opacity-70"><!> </h4> <!> <!></div></div> <div class="border-base-300 flex-none border-t px-4 py-3"><div class="flex flex-wrap items-center justify-end gap-2"><button class="btn btn-ghost"><!> Annuler</button> <button class="btn btn-primary"><!> Créer l'emprunt</button></div></div></div> <!></div>`);function kt(ge,n){Ge(n,!0);const E=[];let p=J(""),x=J(""),X=J(""),v=J(xa([])),A=J("asked"),se=J(!1),k=J(!1);const F=q(()=>!e(p)||!e(x)?le.getAvailableMaterielsByOwner(n.ownerId):le.getAvailableMaterielsForPeriod(n.ownerId,e(p),e(x))),Y=q(()=>e(p)!==""&&e(x)!==""&&e(p)<e(x)&&e(v).length>0&&e(v).every(i=>i.quantity>=1)&&Te.userId!==null&&Te.userId!==void 0&&!e(k));function Z(i){const y=i.availableForPeriod??i.availableQuantity,C=e(v).find(ae=>ae.materielId===i.$id);if(C){C.quantity<y&&C.quantity++;return}_(v,[...e(v),{materielId:i.$id,materielName:i.name,quantity:1,type:i.type||"",maxQuantity:y}],!0)}function $(i){_(v,e(v).filter(y=>y.materielId!==i),!0)}function ie(i,y){_(v,e(v).map(C=>C.materielId===i?{...C,quantity:Math.max(1,Math.min(y,C.maxQuantity))}:C),!0)}function D(i){i.forEach(y=>{const C=e(F).find(ae=>ae.$id===y);C&&Z(C)}),_(se,!1)}async function de(){if(e(Y)){_(k,!0);try{const i=e(v).map(ae=>({materielId:ae.materielId,materielName:ae.materielName,quantity:ae.quantity})),y=Te.userId||"",C=Te.userName||"Inconnu";await le.createLoan({startDate:e(p),endDate:e(x),responsibleId:y,responsibleName:C,ownerId:n.ownerId,ownerName:n.ownerName,materiels:i,notes:e(X).trim()||void 0,status:e(A)}),re(),n.onClose(),n.onSuccess?.()}catch(i){console.error("Erreur création emprunt:",i),Qe.error("Erreur lors de la création de l'emprunt")}finally{_(k,!1)}}}function re(){_(p,""),_(x,""),_(X,""),_(v,[],!0),_(A,"asked")}function ne(){re(),n.onClose()}var P=wt(),U=t(P),oe=t(U),ee=t(oe),be=t(ee);Da(be,{class:"h-5 w-5"});var I=r(be);a(ee);var M=r(ee,2);M.__click=ne;var V=t(M);ye(V,{class:"h-4 w-4"}),a(M),a(oe);var ce=r(oe,2),R=t(ce),ve=t(R),G=t(ve),o=t(G),b=t(o);ra(b,{class:"h-4 w-4"}),j(),a(o);var N=r(o,2);_e(N),a(G);var d=r(G,2),s=t(d),l=t(s);ra(l,{class:"h-4 w-4"}),j(),a(s);var c=r(s,2);_e(c),a(d),a(ve);var m=r(ve,2),w=t(m),g=t(w);Fa(g,{class:"h-4 w-4"}),j(),a(w);var h=r(w,2);_e(h),a(m);var H=r(m,2),pe=r(t(H),2);Ra(pe),a(H);var we=r(H,2),xe=r(t(we),2),T=t(xe),Q=t(T);_e(Q),Q.value=Q.__value="asked",j(2),a(T);var O=r(T,2),K=t(O);_e(K),K.value=K.__value="accepted",j(2),a(O),a(xe),a(we),a(R);var ke=r(R,2),he=t(ke),ue=t(he);Ma(ue,{class:"h-4 w-4"});var Me=r(ue);a(he);var Ee=r(he,2);{var la=i=>{var y=pt(),C=t(y);Na(C,{class:"h-5 w-5"}),j(2),a(y),u(i,y)},ia=i=>{var y=ft(),C=De(y),ae=t(C),te=t(ae);et(te,{get items(){return e(F)},itemToString:fe=>fe.name,onSelect:fe=>Z(fe),placeholder:"Rechercher du matériel...",get disabled(){return e(k)}}),a(ae);var Re=r(ae,2);Re.__click=()=>_(se,!0);var va=t(Re);Ma(va,{class:"h-4 w-4"}),j(),a(Re),a(C);var Fe=r(C,2);{var Je=fe=>{var Oe=mt(),Be=t(Oe);Na(Be,{class:"h-5 w-5"}),j(2),a(Oe),u(fe,Oe)};S(Fe,fe=>{e(F).length===0&&fe(Je)})}z(()=>Re.disabled=e(k)||e(F).length===0),u(i,y)};S(Ee,i=>{!e(p)||!e(x)?i(la):i(ia,!1)})}var oa=r(Ee,2);{var We=i=>{var y=xt(),C=r(t(y),2);Se(C,17,()=>e(v),ae=>ae.materielId,(ae,te,Re)=>{const va=q(()=>e(te).type==="electronic"?Ia:e(te).type==="manual"?sa:e(te).type==="cooking"?ka:e(te).type==="dish"?wa:e(te).type==="gaz"?ya:e(te).type==="hygiene"?ha:ta);var Fe=gt(),Je=t(Fe),fe=t(Je),Oe=t(fe);na(Oe,()=>e(va),(Ae,Ye)=>{Ye(Ae,{class:"h-4 w-4 opacity-70"})}),a(fe);var Be=r(fe,2),ua=t(Be),Oa=t(ua,!0);a(ua);var Ca=r(ua,2),Qa=r(t(Ca)),Ba=t(Qa,!0);a(Qa),a(Ca),a(Be);var ba=r(Be,2),pa=t(ba),Ua=t(pa);tt(Ua,{class:"inline h-3 w-3"}),a(pa);var La=r(pa,2),Ue=t(La);Ue.__change=Ae=>{const Ye=Ae.target;ie(e(te).materielId,parseInt(Ye.value))},Se(Ue,21,()=>Array(e(te).maxQuantity),ga,(Ae,Ye,Sa)=>{var Ze=_t();Ze.textContent=Sa+1,Ze.value=Ze.__value=Sa+1,u(Ae,Ze)}),a(Ue),a(La),a(ba);var Xe=r(ba,2);Xe.__click=()=>$(e(te).materielId);var Va=t(Xe);ye(Va,{class:"h-3 w-3"}),a(Xe),a(Je),a(Fe),z(()=>{L(Oa,e(te).materielName),L(Ba,e(te).maxQuantity),Ue.disabled=e(k),Xe.disabled=e(k)}),Wa(Ue,()=>e(te).quantity,Ae=>e(te).quantity=Ae),u(ae,Fe)}),a(y),u(i,y)},ze=i=>{var y=ht(),C=t(y);Da(C,{class:"mx-auto mb-2 h-12 w-12"}),j(4),a(y),u(i,y)};S(oa,i=>{e(v).length>0?i(We):i(ze,!1)})}a(ke),a(ce);var Ie=r(ce,2),Pe=t(Ie),Ce=t(Pe);Ce.__click=ne;var da=t(Ce);ye(da,{class:"h-5 w-5"}),j(),a(Ce);var Ne=r(Ce,2);Ne.__click=de;var ca=t(Ne);{var B=i=>{var y=yt();u(i,y)},W=i=>{Ve(i,{class:"h-5 w-5"})};S(ca,i=>{e(k)?i(B):i(W,!1)})}j(),a(Ne),a(Pe),a(Ie),a(U);var qe=r(U,2);{var me=i=>{{let y=q(()=>new Set(e(v).map(C=>C.materielId)));bt(i,{get isOpen(){return e(se)},onClose:()=>_(se,!1),onAdd:D,get selectedIds(){return e(y)},get materiels(){return e(F)}})}};S(qe,i=>{e(se)&&i(me)})}a(P),z(()=>{Le(P,1,`modal ${(n.isOpen&&"modal-open")??""}`),L(I,` Nouvel réservation - ${n.ownerName??""}`),N.disabled=e(k),c.disabled=e(k),aa(c,"min",e(p)),Ka(h,Te.userName||"Utilisateur actuel"),pe.disabled=e(k),Q.disabled=e(k),K.disabled=e(k),L(Me,` Matériel à emprunter (${e(v).length??""})`),Ce.disabled=e(k),Ne.disabled=!e(Y)}),je(N,()=>e(p),i=>_(p,i)),je(c,()=>e(x),i=>_(x,i)),je(pe,()=>e(X),i=>_(X,i)),qa(E,[],Q,()=>e(A),i=>_(A,i)),qa(E,[],K,()=>e(A),i=>_(A,i)),u(ge,P),He()}Ke(["click","change"]);var It=f('<div class="text-base-content/60 text-xs italic"> </div>'),Ct=f('<span><span class="font-medium"> </span> </span>'),Qt=f('<div class="text-warning bg-warning/10 rounded p-2 text-xs"><strong>Retour :</strong> </div>'),Lt=f("<button><!> <span> </span></button>"),St=f('<button class="btn btn-ghost btn-sm" title="Modifier"><!></button>'),qt=f('<div class="card bg-base-100 border-base-200 border text-left shadow-sm"><div class="card-body py-3"><div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between"><div class="flex min-w-0 flex-1 flex-col gap-4"><div class=" flex flex-wrap items-center gap-x-4 gap-y-1 text-base"><div class="flex items-center gap-1"><!> <span> </span></div> <div><!> <span> </span></div> <span> </span></div> <!> <div class="flex flex-wrap gap-2"></div> <!></div> <div class="flex flex-col gap-4 not-sm:mt-4"><!> <!></div></div></div></div>');function At(ge,n){Ge(n,!0);const E=q(()=>n.loan.materielItems),p=q(()=>{const s=new Date,l=new Date(n.loan.startDate),c=new Date(n.loan.endDate);return s<l?"future":s>=l&&s<=c?"current":"past"}),x=q(()=>{switch(e(p)){case"future":return{icon:ja,class:"text-info",label:"À venir"};case"current":return{icon:Ta,class:"text-accent",label:"En cours"};default:return{icon:ra,class:"",label:""}}});function X(s){if(n.loan.status!=="completed")return"";const l=s.lostQuantity||0,c=s.brokenQuantity||0,m=l+c;return s.quantity-m===0?"badge-error":m>0?"badge-warning":"badge-success"}const v=q(()=>!n.loan||!n.loan.status?{label:"Chargement...",badgeClass:"badge-neutral",icon:_a}:{asked:{label:"En attente",badgeClass:"badge-warning",icon:_a},accepted:{label:"confirmé",badgeClass:"badge-info",icon:Ve},refused:{label:"Refusé",badgeClass:"badge-error",icon:ye},canceled:{label:"Annulé",badgeClass:"badge-neutral",icon:ye},completed:{label:"Retour effectué",badgeClass:"badge-success",icon:Ve},archived:{label:"Archivé",badgeClass:"badge-neutral",icon:rt},returned:{label:"Retourné",badgeClass:"badge-success",icon:st}}[n.loan.status]||{label:"Statut inconnu",badgeClass:"badge-neutral",icon:_a}),A=q(()=>()=>{switch(n.loan.status){case"asked":return[{label:"Confirmer",icon:Ve,action:n.onAccept,class:"btn-success"},{label:"Annuler",icon:it,action:n.onCancel,class:"btn-error btn-outline"}];case"accepted":return[{label:"Compléter Fiche retour",icon:lt,action:n.onReturn,class:"btn-warning"}];case"completed":return[{label:"Fiche retour",icon:nt,action:n.onReturn,class:""}];case"refused":case"canceled":return[{label:"Supprimer",icon:ye,action:n.onDelete,class:"btn-error btn-sm"}];default:return[]}});function se(s){s?.(n.loan.$id)}var k=qt(),F=t(k),Y=t(F),Z=t(Y),$=t(Z),ie=t($),D=t(ie);Fa(D,{class:"h-4 w-4"});var de=r(D,2),re=t(de,!0);a(de),a(ie);var ne=r(ie,2),P=t(ne);{var U=s=>{ja(s,{class:"h-4 w-4"})},oe=s=>{var l=$e(),c=De(l);{var m=g=>{Ta(g,{class:"h-4 w-4"})},w=g=>{ra(g,{class:"h-4 w-4"})};S(c,g=>{e(p)==="current"?g(m):g(w,!1)},!0)}u(s,l)};S(P,s=>{e(p)==="future"?s(U):s(oe,!1)})}var ee=r(P,2),be=t(ee);a(ee),a(ne);var I=r(ne,2),M=t(I,!0);a(I),a($);var V=r($,2);{var ce=s=>{var l=It(),c=t(l);a(l),z(()=>L(c,`"${n.loan.notes??""}"`)),u(s,l)};S(V,s=>{n.loan.notes&&s(ce)})}var R=r(V,2);Se(R,21,()=>e(E),ga,(s,l)=>{var c=Ct(),m=t(c),w=t(m,!0);a(m);var g=r(m);a(c),z(h=>{Le(c,1,`badge badge-sm badge-soft ${h??""}`),L(w,e(l).materielName),L(g,` × ${e(l).quantity??""}`)},[()=>X(e(l))]),u(s,c)}),a(R);var ve=r(R,2);{var G=s=>{var l=Qt(),c=r(t(l));a(l),z(()=>L(c,` ${n.loan.returnNotes??""}`)),u(s,l)};S(ve,s=>{n.loan.returnNotes&&s(G)})}a(Z);var o=r(Z,2),b=t(o);Se(b,17,()=>e(A)(),ga,(s,l)=>{var c=Lt();c.__click=()=>se(e(l).action);var m=t(c);na(m,()=>e(l).icon,(h,H)=>{H(h,{class:"h-4 w-4"})});var w=r(m,2),g=t(w,!0);a(w),a(c),z(()=>{Le(c,1,`btn btn-sm ${e(l).class??""}`),aa(c,"title",e(l).label),L(g,e(l).label)}),u(s,c)});var N=r(b,2);{var d=s=>{var l=St();l.__click=()=>n.onEdit(n.loan.$id);var c=t(l);ot(c,{class:"h-4 w-4"}),a(l),u(s,l)};S(N,s=>{n.onEdit&&n.loan.status==="asked"&&s(d)})}a(o),a(Y),a(F),a(k),z((s,l)=>{L(re,n.loan.responsibleName),Le(ne,1,`flex items-center gap-1 ${e(x).class??""} font-bold`),L(be,`${s??""} - ${l??""}`),Le(I,1,`badge ${e(v).badgeClass??""} badge-sm gap-1`),L(M,e(v).label)},[()=>Pa(n.loan.startDate),()=>Pa(n.loan.endDate)]),u(ge,k),He()}Ke(["click"]);var Dt=f('<div class="ml-8"><label class="input input-sm w-32"><span class="label text-xs">Qté perdue:</span> <input type="number" class="grow" min="0"/></label></div>'),Mt=f('<div class="ml-8"><label class="input input-sm w-32"><span class="label text-xs">Qté cassée:</span> <input type="number" class="grow" min="0"/></label></div>'),Nt=f('<div class="border-base-300 bg-base-100 rounded-lg border p-4"><div class="mb-3 flex items-start gap-3"><div class="bg-primary/10 rounded-lg p-2"><!></div> <div class="flex-1"><div class="font-semibold"> </div> <div class="text-sm opacity-70"> </div></div></div> <div class="ml-10 space-y-3"><label class="flex cursor-pointer items-start gap-3"><input type="checkbox" class="checkbox checkbox-success checkbox-sm mt-1"/> <div class="text-sm"><div class="font-medium">Tout est OK</div> <div class="opacity-60">Aucune perte ni casse</div></div></label> <div class="space-y-2"><label class="flex cursor-pointer items-start gap-3"><input type="checkbox" class="checkbox checkbox-error checkbox-sm mt-1"/> <div class="flex-1 text-sm"><div class="flex items-center gap-2 font-medium"><!> Des pièces sont perdues</div></div></label> <!></div> <div class="space-y-2"><label class="flex cursor-pointer items-start gap-3"><input type="checkbox" class="checkbox checkbox-warning checkbox-sm mt-1"/> <div class="flex-1 text-sm"><div class="flex items-center gap-2 font-medium"><!> Des pièces sont cassées</div> <div class="text-xs opacity-60">À réparer (status: torepair)</div></div></label> <!></div></div></div>'),Tt=f('<div class="text-error"> </div>'),jt=f('<div class="text-warning"> </div>'),Et=f('<div class="alert alert-warning"><!> <div><h4 class="font-bold"> </h4> <div class="text-sm"><!> <!></div></div></div> )',1),zt=f('<span class="loading loading-spinner loading-sm"></span>'),Pt=f(`<div><div class="modal-box fixed top-0 flex h-lvh w-lvw flex-col overflow-auto md:top-10 md:h-full md:max-h-11/12 md:w-full md:max-w-3xl"><div class="flex items-center justify-between border-b p-4 pt-0"><div><h3 class="text-lg font-bold">Retour d'emprunt</h3> <p class="text-sm opacity-70"> </p></div> <button class="btn btn-circle btn-ghost btn-sm absolute top-2 right-2" aria-label="Fermer"><!></button></div> <div class="flex-1 space-y-6 overflow-y-auto p-4"><div class="space-y-4"><h4 class="text-sm font-semibold uppercase opacity-70">Matériel à retourner</h4> <!></div> <!> <fieldset class="fieldset bg-base-100"><legend class="fieldset-legend">Notes de retour (optionnel)</legend> <textarea class="textarea textarea-bordered w-full" rows="3" placeholder="Précisez l'état du matériel, les raisons des pertes/casses, etc." maxlength="1000"></textarea></fieldset></div> <div class="border-base-300 flex-none border-t px-4 py-3"><div class="flex flex-wrap items-center justify-end gap-2"><button class="btn btn-ghost"><!> Annuler</button> <button class="btn btn-warning"><!> Valider le retour</button></div></div></div></div>`);function Rt(ge,n){Ge(n,!0);let E=J(xa([])),p=J(""),x=J(!1);ea(()=>{if(!n.loan)return;const d=n.loan.materielItems;_(E,d.map(s=>({materielId:s.materielId,materielName:s.materielName,quantity:s.quantity,type:"",lostQuantity:0,brokenQuantity:0})),!0),d.forEach(s=>{const l=le.materiels.find(c=>c.$id===s.materielId);if(l){const c=e(E).find(m=>m.materielId===s.materielId);c&&(c.type=l.type||"")}})});const X=q(()=>e(E).every(d=>d.lostQuantity>=0&&d.brokenQuantity>=0&&d.lostQuantity+d.brokenQuantity<=d.quantity)&&!e(x)),v=q(()=>e(E).reduce((d,s)=>d+s.lostQuantity,0)),A=q(()=>e(E).reduce((d,s)=>d+s.brokenQuantity,0));async function se(){if(e(X)){_(x,!0);try{const d=e(E).map(s=>({materielId:s.materielId,materielName:s.materielName,quantity:s.quantity,lostQuantity:s.lostQuantity>0?s.lostQuantity:void 0,brokenQuantity:s.brokenQuantity>0?s.brokenQuantity:void 0}));await le.updateLoan(n.loan.$id,{materiels:d,status:"returned",returnedAt:new Date().toISOString(),returnNotes:e(p).trim()||void 0}),n.onClose()}catch(d){console.error("Erreur retour emprunt:",d)}finally{_(x,!1)}}}function k(){_(p,""),n.onClose()}function F(d){switch(d){case"electronic":return Ia;case"manual":return sa;case"cooking":return ka;case"dish":return wa;case"gaz":return ya;case"hygiene":return ha;default:return ta}}var Y=Pt(),Z=t(Y),$=t(Z),ie=t($),D=r(t(ie),2),de=t(D);a(D),a(ie);var re=r(ie,2);re.__click=k;var ne=t(re);ye(ne,{class:"h-4 w-4"}),a(re),a($);var P=r($,2),U=t(P),oe=r(t(U),2);Se(oe,17,()=>e(E),d=>d.materielId,(d,s,l)=>{const c=q(()=>F(e(s).type));var m=Nt(),w=t(m),g=t(w),h=t(g);na(h,()=>e(c),(B,W)=>{W(B,{class:"text-primary h-5 w-5"})}),a(g);var H=r(g,2),pe=t(H),we=t(pe,!0);a(pe);var xe=r(pe,2),T=t(xe);a(xe),a(H),a(w);var Q=r(w,2),O=t(Q),K=t(O);_e(K),K.__change=B=>{B.target.checked&&(e(s).lostQuantity=0,e(s).brokenQuantity=0)},j(2),a(O);var ke=r(O,2),he=t(ke),ue=t(he);_e(ue),ue.__change=B=>{const W=B.target;e(s).lostQuantity=W.checked?1:0};var Me=r(ue,2),Ee=t(Me),la=t(Ee);Ea(la,{class:"h-3 w-3"}),j(),a(Ee),a(Me),a(he);var ia=r(he,2);{var oa=B=>{var W=Dt(),qe=t(W),me=r(t(qe),2);_e(me),a(qe),a(W),z(()=>{aa(me,"max",e(s).quantity-e(s).brokenQuantity),me.disabled=e(x)}),je(me,()=>e(s).lostQuantity,i=>e(s).lostQuantity=i),u(B,W)};S(ia,B=>{e(s).lostQuantity>0&&B(oa)})}a(ke);var We=r(ke,2),ze=t(We),Ie=t(ze);_e(Ie),Ie.__change=B=>{const W=B.target;e(s).brokenQuantity=W.checked?1:0};var Pe=r(Ie,2),Ce=t(Pe),da=t(Ce);sa(da,{class:"h-3 w-3"}),j(),a(Ce),j(2),a(Pe),a(ze);var Ne=r(ze,2);{var ca=B=>{var W=Mt(),qe=t(W),me=r(t(qe),2);_e(me),a(qe),a(W),z(()=>{aa(me,"max",e(s).quantity-e(s).lostQuantity),me.disabled=e(x)}),je(me,()=>e(s).brokenQuantity,i=>e(s).brokenQuantity=i),u(B,W)};S(Ne,B=>{e(s).brokenQuantity>0&&B(ca)})}a(We),a(Q),a(m),z(()=>{L(we,e(s).materielName),L(T,`Quantité empruntée : ${e(s).quantity??""}`),ma(K,e(s).lostQuantity===0&&e(s).brokenQuantity===0),K.disabled=e(x),ma(ue,e(s).lostQuantity>0),ue.disabled=e(x),ma(Ie,e(s).brokenQuantity>0),Ie.disabled=e(x)}),u(d,m)}),a(U);var ee=r(U,2);{var be=d=>{var s=Et(),l=De(s),c=t(l);Ea(c,{class:"h-5 w-5"});var m=r(c,2),w=t(m),g=t(w);a(w);var h=r(w,2),H=t(h);{var pe=T=>{var Q=Tt(),O=t(Q);a(Q),z(()=>L(O,`• ${e(v)??""} perdue${e(v)>1?"s":""} (déduit du stock)`)),u(T,Q)};S(H,T=>{e(v)>0&&T(pe)})}var we=r(H,2);{var xe=T=>{var Q=jt(),O=t(Q);a(Q),z(()=>L(O,`• ${e(A)??""} cassée${e(A)>1?"s":""} (à réparer)`)),u(T,Q)};S(we,T=>{e(A)>0&&T(xe)})}a(h),a(m),a(l),j(),z(()=>L(g,`Attention : ${e(v)+e(A)} unité${e(v)+e(A)>1?"s":""} problématique${e(v)+e(A)>1?"s":""}`)),u(d,s)};S(ee,d=>{(e(v)>0||e(A)>0)&&d(be)})}var I=r(ee,2),M=r(t(I),2);Ra(M),a(I),a(P);var V=r(P,2),ce=t(V),R=t(ce);R.__click=k;var ve=t(R);ye(ve,{class:"h-5 w-5"}),j(),a(R);var G=r(R,2);G.__click=se;var o=t(G);{var b=d=>{var s=zt();u(d,s)},N=d=>{Ve(d,{class:"h-5 w-5"})};S(o,d=>{e(x)?d(b):d(N,!1)})}j(),a(G),a(ce),a(V),a(Z),a(Y),z((d,s)=>{Le(Y,1,`modal ${(n.isOpen&&"modal-open")??""}`),L(de,`Du ${d??""} au ${s??""}`),M.disabled=e(x),R.disabled=e(x),G.disabled=!e(X)},[()=>new Date(n.loan.startDate).toLocaleDateString("fr-FR"),()=>new Date(n.loan.endDate).toLocaleDateString("fr-FR")]),je(M,()=>e(p),d=>_(p,d)),u(ge,Y),He()}Ke(["click","change"]);var Ft=f('<button><!> <span class="badge badge-sm badge-neutral ml-2"> </span></button>'),Ot=f('<div class="tabs tabs-border bg-base-200 tabs-lg mb-6 font-medium"></div>'),Bt=f('<div class="alert alert-warning"><span>Vous devez être connecté pour voir les emprunts.</span></div>'),Ut=f('<div class="alert alert-error shadow-lg"><span> </span></div>'),Vt=f('<div class="alert alert-info"><span>Sélectionnez une équipe pour voir ses emprunts.</span></div>'),Gt=f(`<div class="bg-base-200 rounded-box border-base-200 border-2 border-dashed py-20 text-center"><!> <h3 class="mb-2 text-lg font-bold">Aucune réservation</h3> <p class="text-base-content/60 mb-6">Cette équipe n'a pas encore d'emprunt.</p> <button class="btn btn-primary btn-sm">Créer une réservation</button></div>`),Ht=f('<div class="space-y-4"><div class="mb-6 flex justify-end"><button class="btn btn-primary btn-wide flex gap-2"><!> Ajouter une reservation</button></div> <!></div>'),Kt=f('<div class="container mx-auto p-4"><div class="mx-auto max-w-7xl px-4 py-8"><!> <!></div></div> <!> <!>',1);function ts(ge,n){Ge(n,!0);let E=J(!1),p=J(null),x=J(!1),X=J(null),v=J(!1);function A(){if(!e(p))return;if(!e(D).find(b=>b.$id===e(p))){Qe.error("Équipe introuvable");return}_(E,!0)}function se(){_(E,!1)}function k(){console.log("[LoansPage] Emprunt créé avec succès"),se()}function F(o){fa(`/dashboard/loans/return/${o}`)}function Y(){_(x,!1),_(X,null)}async function Z(o){try{await le.acceptLoan(o),Qe.success("Emprunt accepté avec succès")}catch(b){console.error("[LoansPage] Erreur acceptation emprunt:",b),Qe.error("Erreur lors de l'acceptation de l'emprunt")}}async function $(o){try{await le.cancelLoan(o),Qe.success("Emprunt annulé avec succès")}catch(b){console.error("[LoansPage] Erreur annulation emprunt:",b),Qe.error("Erreur lors de l'annulation de l'emprunt")}}async function ie(o){try{await le.deleteLoan(o),Qe.success("Emprunt supprimé avec succès")}catch(b){console.error("[LoansPage] Erreur suppression emprunt:",b),Qe.error("Erreur lors de la suppression de l'emprunt")}}const D=q(()=>Za.myTeams),de=q(()=>e(p)?e(D).find(o=>o.$id===e(p)):null),re=q(()=>{if(!e(p))return console.log("[LoansPage] teamLoans: pas d'activeTeamId"),[];const o=le.loans.filter(b=>b.ownerId===e(p));return console.log("[LoansPage] teamLoans filtrés:",{activeTeamId:e(p),totalLoans:le.loans.length,filteredCount:o.length,allLoans:le.loans.map(b=>({id:b.$id,ownerId:b.ownerId}))}),o});function ne(o){fa(`/dashboard/loans/${o}`)}ea(()=>{const o=Ja.params.teamId;if(o&&o!==e(p)){console.log("[LoansPage] teamIdFromParams:",o);const b=e(D).find(N=>N.$id===o);console.log("[LoansPage] équipe trouvée:",b),b&&(console.log("[LoansPage] Mise à jour activeTeamId:",o),_(p,o,!0))}else!o&&!e(p)&&!e(v)&&e(D).length>0&&(console.log("[LoansPage] Redirection vers première équipe:",e(D)[0].$id),_(v,!0),fa(`/dashboard/loans/${e(D)[0].$id}`))}),ea(()=>{const b=(e(p)?e(D).find(N=>N.$id===e(p)):null)?.name||"Emprunts";Aa.setConfig({title:b})}),Xa(()=>{Aa.reset()});var P=Kt(),U=De(P),oe=t(U),ee=t(oe);{var be=o=>{var b=Ot();Se(b,21,()=>e(D),N=>N.$id,(N,d)=>{const s=q(()=>le.loans.filter(h=>h.ownerId===e(d).$id).length);var l=Ft();l.__click=()=>ne(e(d).$id);var c=t(l);za(c,{class:"mr-2 h-4 w-4"});var m=r(c),w=r(m),g=t(w,!0);a(w),a(l),z(()=>{Le(l,1,`tab ${e(p)===e(d).$id?"tab-active":""}`),L(m,` ${e(d).name??""} `),L(g,e(s))}),u(N,l)}),a(b),u(o,b)};S(ee,o=>{e(D).length>1&&o(be)})}var I=r(ee,2);{var M=o=>{var b=Bt();u(o,b)},V=o=>{var b=$e(),N=De(b);{var d=l=>{var c=Ut(),m=t(c),w=t(m,!0);a(m),a(c),z(()=>L(w,le.error)),u(l,c)},s=l=>{var c=$e(),m=De(c);{var w=h=>{var H=Vt();u(h,H)},g=h=>{var H=$e(),pe=De(H);{var we=T=>{var Q=Gt(),O=t(Q);za(O,{class:"mx-auto mb-4 h-12 w-12  text-center opacity-50"});var K=r(O,6);K.__click=A,a(Q),u(T,Q)},xe=T=>{var Q=Ht(),O=t(Q),K=t(O);K.__click=A;var ke=t(K);dt(ke,{size:16}),j(),a(K),a(O);var he=r(O,2);Se(he,17,()=>e(re),ue=>ue.$id,(ue,Me)=>{At(ue,{get loan(){return e(Me)},onReturn:F,onAccept:Z,onCancel:$,onDelete:ie})}),a(Q),u(T,Q)};S(pe,T=>{e(re).length===0?T(we):T(xe,!1)})}u(h,H)};S(m,h=>{e(p)?h(g,!1):h(w)},!0)}u(l,c)};S(N,l=>{le.error?l(d):l(s,!1)},!0)}u(o,b)};S(I,o=>{Te.isAuthenticated?o(V,!1):o(M)})}a(oe),a(U);var ce=r(U,2);{var R=o=>{kt(o,{get isOpen(){return e(E)},onClose:se,onSuccess:k,get ownerId(){return e(de).$id},get ownerName(){return e(de).name}})};S(ce,o=>{e(de)&&o(R)})}var ve=r(ce,2);{var G=o=>{Rt(o,{get loan(){return e(X)},get isOpen(){return e(x)},onClose:Y})};S(ve,o=>{e(x)&&e(X)&&o(G)})}Ya(3,U,()=>$a),u(ge,P),He()}Ke(["click"]);export{ts as default};
