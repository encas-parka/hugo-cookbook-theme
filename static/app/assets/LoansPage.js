import{X as ye,aQ as ea,aR as xa,r as ha,D as ya,k as wa,aS as aa,aT as ka,ax as qa,t as ta,i as Pa,aV as Aa,a1 as Da,aU as Ga,z as Ve,aW as Ma,am as Na,n as ma,aJ as Ha,aC as Ka,aX as Wa,aY as Xa,T as Ja,a5 as Ya,Q as Ta,U as Ea,P as Za}from"./icons.js";import{B as Ge,d as He,p as $a,y as W,z as Ia,H as sa,A as _,v as f,h as r,g as t,e as Se,b as u,a6 as na,m as e,u as q,w as z,x as L,C as Le,c as Ke,t as et,o as a,K as E,I as S,L as ra,an as at,G as Te,R as Ee,ai as Ra,a2 as le,M as Qe,k as De,i as ga,al as tt,U as _e,aq as Fa,j as $e,ak as fa,$ as st,E as _a,F as rt}from"./appwrite.js";import{n as za}from"./index.js";import{A as nt}from"./AutocompleteInput.js";import{B as lt}from"./BtnGroupCheck.js";import{g as ja}from"./date-helpers.js";import"./keyboardNavigation.svelte.js";import"./CheckboxBadge.js";var it=f('<div class="mb-6"><h4 class="mb-3 flex items-center gap-2 text-base font-semibold"><div class="bg-primary/10 rounded-lg p-1.5"><!></div> <span class="badge badge-ghost badge-sm ml-auto"> </span></h4> <!></div>'),ot=f('<div class="text-center py-12 opacity-50"><!> <p class="text-lg font-medium">Aucun matériel disponible</p> <p class="text-sm mt-2">Tous les matériels sont actuellement empruntés ou non disponibles</p></div>'),dt=f(`<div><div class="modal-box fixed top-0 flex h-lvh w-lvw flex-col overflow-auto md:top-10 md:h-full md:max-h-11/12 md:w-full md:max-w-4xl"><div class="flex items-center justify-between border-b p-4 pt-0"><h3 class="text-lg font-bold">Sélection rapide du matériel</h3> <button class="btn btn-circle btn-ghost btn-sm absolute top-2 right-2" aria-label="Fermer"><!></button></div> <div class="flex-1 space-y-6 overflow-y-auto p-4"><div class="alert alert-info alert-soft text-base">Les nombres indiquent les quantités disponibles de chaque matériel, vous
        indiquerez après la quantité que vous souhaitez réserver.</div> <!></div> <div class="border-base-300 flex-none border-t px-4 py-3"><div class="flex flex-wrap items-center justify-between gap-2"><div class="text-sm opacity-70"> </div> <div class="flex gap-2"><button class="btn btn-ghost">Annuler</button> <button class="btn btn-primary">Ajouter la sélection</button></div></div></div></div></div>`);function ct(ge,n){He(n,!0);let R=$a(n,"selectedIds",19,()=>new Set);const b=q(()=>({electronic:"Électronique",manual:"Ustensiles",cooking:"Matériel de cuisine",dish:"Vaisselle",gaz:"Gaz",hygiene:"Hygiène",other:"Autre"})),x=q(()=>({electronic:ka,manual:aa,cooking:wa,dish:ya,gaz:ha,hygiene:xa,other:ea})),X=q(()=>{const I={};return n.materiels.forEach(M=>{const U=M.type||"other";I[U]||(I[U]=[]),I[U].push(M)}),I});let v=W(Ia(new Set));sa(()=>{_(v,new Set(R()),!0)});function A(I){e(v).has(I)?e(v).delete(I):e(v).add(I),_(v,new Set(e(v)),!0)}function se(){n.onAdd(Array.from(e(v))),n.onClose()}function k(){_(v,new Set(R()),!0),n.onClose()}var F=dt(),J=t(F),Y=t(J),Z=r(t(Y),2);Z.__click=k;var ie=t(Z);ye(ie,{class:"h-4 w-4"}),a(Z),a(Y);var D=r(Y,2),de=r(t(D),2);Se(de,17,()=>Object.entries(e(X)),([I,M])=>I,(I,M,U,ce)=>{var P=q(()=>et(e(M),2));let ve=()=>e(P)[0],V=()=>e(P)[1];const o=q(()=>e(x)[ve()]);var p=it(),N=t(p),d=t(N),s=t(d);na(s,()=>e(o),(g,h)=>{h(g,{class:"text-primary h-4 w-4"})}),a(d);var l=r(d),c=r(l),m=t(c);a(c),a(N);var w=r(N,2);{let g=q(()=>V().map(h=>({id:h.$id,label:h.name,badge:String(h.availableQuantity),selected:e(v).has(h.$id),title:`${h.availableQuantity}/${h.quantity} disponibles`})));lt(w,{get items(){return e(g)},onToggleItem:A,size:"md",color:"primary"})}a(p),z(g=>{L(l,` ${e(b)[ve()]??""} `),L(m,`${g??""}/${V().length??""}`)},[()=>V().filter(g=>e(v).has(g.$id)).length]),u(I,p)},I=>{var M=ot(),U=t(M);ea(U,{class:"h-16 w-16 mx-auto mb-4"}),E(4),a(M),u(I,M)}),a(D);var re=r(D,2),ne=t(re),j=t(ne),$=t(j);a(j);var oe=r(j,2),ee=t(oe);ee.__click=k;var be=r(ee,2);be.__click=se,a(oe),a(ne),a(re),a(J),a(F),z(()=>{Le(F,1,`modal ${(n.isOpen&&"modal-open")??""}`),L($,`${e(v).size??""} matériel${e(v).size>1?"s":""}
          sélectionné${e(v).size>1?"s":""}`),be.disabled=e(v).size===0}),u(ge,F),Ke()}Ge(["click"]);var vt=f(`<div class="alert alert-info max-md:alert-vertical"><!> <span>Veuillez sélectionner une <strong>date de début</strong> et une <strong>date de fin</strong> pour voir le matériel disponible sur cette
              période.</span></div>`),ut=f('<div class="alert alert-warning"><!> <span>Aucun matériel disponible pour la période sélectionnée.</span></div>'),bt=f('<div class="flex flex-wrap gap-6"><div class="flex-1"><!></div> <button class="btn btn-secondary btn-md flex-1 gap-2"><!> Ajout rapide</button></div> <!>',1),pt=f("<option></option>"),mt=f('<div class="bg-base-200 rounded-lg p-2"><div class="flex items-center gap-2"><div class="bg-base-300 rounded p-1"><!></div> <div class="min-w-0 flex-1"><div class="truncate font-medium"> </div> <div class="text-xs opacity-70">Disponible : <span class="font-semibold"> </span></div></div> <div class="flex items-center gap-1"><span class="text-sm opacity-70"><!></span> <label class="select join"><select class="join-item select-sm select-bordered w-20"></select></label></div> <button class="btn btn-ghost btn-xs btn-circle" aria-label="Supprimer"><!></button></div></div>'),ft=f('<div class="space-y-2"><p class="text-sm font-semibold opacity-70">Matériels sélectionnés</p> <!></div>'),_t=f(`<div class="py-8 text-center opacity-50"><!> <p class="text-sm">Aucun matériel sélectionné</p> <p class="text-xs">Utilisez la recherche ou l'ajout rapide pour ajouter du matériel</p></div>`),gt=f('<span class="loading loading-spinner loading-sm"></span>'),xt=f(`<div><div class="modal-box fixed top-0 flex h-lvh w-lvw flex-col overflow-auto md:top-10 md:h-full md:max-h-11/12 md:w-full md:max-w-4xl"><div class="flex items-center justify-between border-b p-4 pt-0"><h3 class="flex items-center gap-2 text-lg font-bold"><!> </h3> <button class="btn btn-circle btn-ghost btn-sm absolute top-2 right-2" aria-label="Fermer"><!></button></div> <div class="flex-1 space-y-6 overflow-y-auto p-4"><div class="space-y-4"><div class="flex flex-wrap gap-4"><label class="input min-w-[200px] flex-1"><span class="label"><!> Date début *</span> <input type="date" class="grow"/></label> <label class="input min-w-[200px] flex-1"><span class="label"><!> Date fin *</span> <input type="date" class="grow"/></label></div> <label class="input w-full"><span class="label"><!> Responsable</span> <input type="text" class="grow" disabled/></label> <fieldset class="fieldset bg-base-100"><legend class="fieldset-legend">Notes (optionnel)</legend> <textarea class="textarea textarea-bordered w-full" rows="2" placeholder="Informations complémentaires sur l'emprunt..." maxlength="500"></textarea></fieldset> <fieldset class="fieldset bg-base-100"><legend class="fieldset-legend">Statut de la réservation</legend> <div class="flex flex-wrap gap-4"><label class="label justify-gap-3 cursor-pointer gap-3"><input type="radio" class="radio radio-primary"/> <span class="label-text"><strong class="block">Demande de réservation</strong> <span class="text-xs opacity-70">Si vous souhaitez attendre la validation du reste de l'équipe</span></span></label> <label class="label justify-gap-3 cursor-pointer gap-3"><input type="radio" class="radio radio-primary"/> <span class="label-text"><strong class="block">Réservation confirmée</strong> <span class="text-xs opacity-70">L'emprunt est automatiquement validé</span></span></label></div></fieldset></div> <div class="space-y-4"><h4 class="flex items-center gap-2 text-sm font-semibold uppercase opacity-70"><!> </h4> <!> <!></div></div> <div class="border-base-300 flex-none border-t px-4 py-3"><div class="flex flex-wrap items-center justify-end gap-2"><button class="btn btn-ghost"><!> Annuler</button> <button class="btn btn-primary"><!> Créer l'emprunt</button></div></div></div> <!></div>`);function ht(ge,n){He(n,!0);const R=[];let b=W(""),x=W(""),X=W(""),v=W(Ia([])),A=W("asked"),se=W(!1),k=W(!1);const F=q(()=>!e(b)||!e(x)?le.getAvailableMaterielsByOwner(n.ownerId):le.getAvailableMaterielsForPeriod(n.ownerId,e(b),e(x))),J=q(()=>e(b)!==""&&e(x)!==""&&e(b)<e(x)&&e(v).length>0&&e(v).every(i=>i.quantity>=1)&&Te.userId!==null&&Te.userId!==void 0&&!e(k));function Y(i){const y=i.availableForPeriod??i.availableQuantity,C=e(v).find(ae=>ae.materielId===i.$id);if(C){C.quantity<y&&C.quantity++;return}_(v,[...e(v),{materielId:i.$id,materielName:i.name,quantity:1,type:i.type||"",maxQuantity:y}],!0)}function Z(i){_(v,e(v).filter(y=>y.materielId!==i),!0)}function ie(i,y){_(v,e(v).map(C=>C.materielId===i?{...C,quantity:Math.max(1,Math.min(y,C.maxQuantity))}:C),!0)}function D(i){i.forEach(y=>{const C=e(F).find(ae=>ae.$id===y);C&&Y(C)}),_(se,!1)}async function de(){if(e(J)){_(k,!0);try{const i=e(v).map(ae=>({materielId:ae.materielId,materielName:ae.materielName,quantity:ae.quantity})),y=Te.userId||"",C=Te.userName||"Inconnu";await le.createLoan({startDate:e(b),endDate:e(x),responsibleId:y,responsibleName:C,ownerId:n.ownerId,ownerName:n.ownerName,materiels:i,notes:e(X).trim()||void 0,status:e(A)}),re(),n.onClose(),n.onSuccess?.()}catch(i){console.error("Erreur création emprunt:",i),Qe.error("Erreur lors de la création de l'emprunt")}finally{_(k,!1)}}}function re(){_(b,""),_(x,""),_(X,""),_(v,[],!0),_(A,"asked")}function ne(){re(),n.onClose()}var j=xt(),$=t(j),oe=t($),ee=t(oe),be=t(ee);qa(be,{class:"h-5 w-5"});var I=r(be);a(ee);var M=r(ee,2);M.__click=ne;var U=t(M);ye(U,{class:"h-4 w-4"}),a(M),a(oe);var ce=r(oe,2),P=t(ce),ve=t(P),V=t(ve),o=t(V),p=t(o);ta(p,{class:"h-4 w-4"}),E(),a(o);var N=r(o,2);_e(N),a(V);var d=r(V,2),s=t(d),l=t(s);ta(l,{class:"h-4 w-4"}),E(),a(s);var c=r(s,2);_e(c),a(d),a(ve);var m=r(ve,2),w=t(m),g=t(w);Pa(g,{class:"h-4 w-4"}),E(),a(w);var h=r(w,2);_e(h),a(m);var G=r(m,2),pe=r(t(G),2);Fa(pe),a(G);var we=r(G,2),xe=r(t(we),2),T=t(xe),Q=t(T);_e(Q),Q.value=Q.__value="asked",E(2),a(T);var O=r(T,2),H=t(O);_e(H),H.value=H.__value="accepted",E(2),a(O),a(xe),a(we),a(P);var ke=r(P,2),he=t(ke),ue=t(he);Aa(ue,{class:"h-4 w-4"});var Me=r(ue);a(he);var Re=r(he,2);{var la=i=>{var y=vt(),C=t(y);Da(C,{class:"h-5 w-5"}),E(2),a(y),u(i,y)},ia=i=>{var y=bt(),C=De(y),ae=t(C),te=t(ae);nt(te,{get items(){return e(F)},itemToString:fe=>fe.name,onSelect:fe=>Y(fe),placeholder:"Rechercher du matériel...",get disabled(){return e(k)}}),a(ae);var Pe=r(ae,2);Pe.__click=()=>_(se,!0);var va=t(Pe);Aa(va,{class:"h-4 w-4"}),E(),a(Pe),a(C);var Fe=r(C,2);{var Xe=fe=>{var Oe=ut(),Be=t(Oe);Da(Be,{class:"h-5 w-5"}),E(2),a(Oe),u(fe,Oe)};S(Fe,fe=>{e(F).length===0&&fe(Xe)})}z(()=>Pe.disabled=e(k)||e(F).length===0),u(i,y)};S(Re,i=>{!e(b)||!e(x)?i(la):i(ia,!1)})}var oa=r(Re,2);{var We=i=>{var y=ft(),C=r(t(y),2);Se(C,17,()=>e(v),ae=>ae.materielId,(ae,te,Pe)=>{const va=q(()=>e(te).type==="electronic"?ka:e(te).type==="manual"?aa:e(te).type==="cooking"?wa:e(te).type==="dish"?ya:e(te).type==="gaz"?ha:e(te).type==="hygiene"?xa:ea);var Fe=mt(),Xe=t(Fe),fe=t(Xe),Oe=t(fe);na(Oe,()=>e(va),(Ae,Ye)=>{Ye(Ae,{class:"h-4 w-4 opacity-70"})}),a(fe);var Be=r(fe,2),ua=t(Be),Oa=t(ua,!0);a(ua);var Ca=r(ua,2),Qa=r(t(Ca)),Ba=t(Qa,!0);a(Qa),a(Ca),a(Be);var ba=r(Be,2),pa=t(ba),Ua=t(pa);Ga(Ua,{class:"inline h-3 w-3"}),a(pa);var La=r(pa,2),Ue=t(La);Ue.__change=Ae=>{const Ye=Ae.target;ie(e(te).materielId,parseInt(Ye.value))},Se(Ue,21,()=>Array(e(te).maxQuantity),ga,(Ae,Ye,Sa)=>{var Ze=pt();Ze.textContent=Sa+1,Ze.value=Ze.__value=Sa+1,u(Ae,Ze)}),a(Ue),a(La),a(ba);var Je=r(ba,2);Je.__click=()=>Z(e(te).materielId);var Va=t(Je);ye(Va,{class:"h-3 w-3"}),a(Je),a(Xe),a(Fe),z(()=>{L(Oa,e(te).materielName),L(Ba,e(te).maxQuantity),Ue.disabled=e(k),Je.disabled=e(k)}),tt(Ue,()=>e(te).quantity,Ae=>e(te).quantity=Ae),u(ae,Fe)}),a(y),u(i,y)},ze=i=>{var y=_t(),C=t(y);qa(C,{class:"mx-auto mb-2 h-12 w-12"}),E(4),a(y),u(i,y)};S(oa,i=>{e(v).length>0?i(We):i(ze,!1)})}a(ke),a(ce);var Ie=r(ce,2),je=t(Ie),Ce=t(je);Ce.__click=ne;var da=t(Ce);ye(da,{class:"h-5 w-5"}),E(),a(Ce);var Ne=r(Ce,2);Ne.__click=de;var ca=t(Ne);{var B=i=>{var y=gt();u(i,y)},K=i=>{Ve(i,{class:"h-5 w-5"})};S(ca,i=>{e(k)?i(B):i(K,!1)})}E(),a(Ne),a(je),a(Ie),a($);var qe=r($,2);{var me=i=>{{let y=q(()=>new Set(e(v).map(C=>C.materielId)));ct(i,{get isOpen(){return e(se)},onClose:()=>_(se,!1),onAdd:D,get selectedIds(){return e(y)},get materiels(){return e(F)}})}};S(qe,i=>{e(se)&&i(me)})}a(j),z(()=>{Le(j,1,`modal ${(n.isOpen&&"modal-open")??""}`),L(I,` Nouvel réservation - ${n.ownerName??""}`),N.disabled=e(k),c.disabled=e(k),ra(c,"min",e(b)),at(h,Te.userName||"Utilisateur actuel"),pe.disabled=e(k),Q.disabled=e(k),H.disabled=e(k),L(Me,` Matériel à emprunter (${e(v).length??""})`),Ce.disabled=e(k),Ne.disabled=!e(J)}),Ee(N,()=>e(b),i=>_(b,i)),Ee(c,()=>e(x),i=>_(x,i)),Ee(pe,()=>e(X),i=>_(X,i)),Ra(R,[],Q,()=>e(A),i=>_(A,i)),Ra(R,[],H,()=>e(A),i=>_(A,i)),u(ge,j),Ke()}Ge(["click","change"]);var yt=f('<div class="text-base-content/60 text-xs italic"> </div>'),wt=f('<span><span class="font-medium"> </span> </span>'),kt=f('<div class="text-warning bg-warning/10 rounded p-2 text-xs"><strong>Retour :</strong> </div>'),It=f("<button><!> <span> </span></button>"),Ct=f('<button class="btn btn-ghost btn-sm" title="Modifier"><!></button>'),Qt=f('<div class="card bg-base-100 border-base-200 border text-left shadow-sm"><div class="card-body py-3"><div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between"><div class="flex min-w-0 flex-1 flex-col gap-4"><div class=" flex flex-wrap items-center gap-x-4 gap-y-1 text-base"><div class="flex items-center gap-1"><!> <span> </span></div> <div><!> <span> </span></div> <span> </span></div> <!> <div class="flex flex-wrap gap-2"></div> <!></div> <div class="flex flex-col gap-4 not-sm:mt-4"><!> <!></div></div></div></div>');function Lt(ge,n){He(n,!0);const R=q(()=>n.loan.materielItems),b=q(()=>{const s=new Date,l=new Date(n.loan.startDate),c=new Date(n.loan.endDate);return s<l?"future":s>=l&&s<=c?"current":"past"}),x=q(()=>{switch(e(b)){case"future":return{icon:Na,class:"text-info",label:"À venir"};case"current":return{icon:Ma,class:"text-accent",label:"En cours"};default:return{icon:ta,class:"",label:""}}});function X(s){if(n.loan.status!=="completed")return"";const l=s.lostQuantity||0,c=s.brokenQuantity||0,m=l+c;return s.quantity-m===0?"badge-error":m>0?"badge-warning":"badge-success"}const v=q(()=>!n.loan||!n.loan.status?{label:"Chargement...",badgeClass:"badge-neutral",icon:ma}:{asked:{label:"En attente",badgeClass:"badge-warning",icon:ma},accepted:{label:"confirmé",badgeClass:"badge-info",icon:Ve},refused:{label:"Refusé",badgeClass:"badge-error",icon:ye},canceled:{label:"Annulé",badgeClass:"badge-neutral",icon:ye},completed:{label:"Retour effectué",badgeClass:"badge-success",icon:Ve},archived:{label:"Archivé",badgeClass:"badge-neutral",icon:Ka},returned:{label:"Retourné",badgeClass:"badge-success",icon:Ha}}[n.loan.status]||{label:"Statut inconnu",badgeClass:"badge-neutral",icon:ma}),A=q(()=>()=>{switch(n.loan.status){case"asked":return[{label:"Confirmer",icon:Ve,action:n.onAccept,class:"btn-success"},{label:"Annuler",icon:Ja,action:n.onCancel,class:"btn-error btn-outline"}];case"accepted":return[{label:"Compléter Fiche retour",icon:Xa,action:n.onReturn,class:"btn-warning"}];case"completed":return[{label:"Fiche retour",icon:Wa,action:n.onReturn,class:""}];case"refused":case"canceled":return[{label:"Supprimer",icon:ye,action:n.onDelete,class:"btn-error btn-sm"}];default:return[]}});function se(s){s?.(n.loan.$id)}var k=Qt(),F=t(k),J=t(F),Y=t(J),Z=t(Y),ie=t(Z),D=t(ie);Pa(D,{class:"h-4 w-4"});var de=r(D,2),re=t(de,!0);a(de),a(ie);var ne=r(ie,2),j=t(ne);{var $=s=>{Na(s,{class:"h-4 w-4"})},oe=s=>{var l=$e(),c=De(l);{var m=g=>{Ma(g,{class:"h-4 w-4"})},w=g=>{ta(g,{class:"h-4 w-4"})};S(c,g=>{e(b)==="current"?g(m):g(w,!1)},!0)}u(s,l)};S(j,s=>{e(b)==="future"?s($):s(oe,!1)})}var ee=r(j,2),be=t(ee);a(ee),a(ne);var I=r(ne,2),M=t(I,!0);a(I),a(Z);var U=r(Z,2);{var ce=s=>{var l=yt(),c=t(l);a(l),z(()=>L(c,`"${n.loan.notes??""}"`)),u(s,l)};S(U,s=>{n.loan.notes&&s(ce)})}var P=r(U,2);Se(P,21,()=>e(R),ga,(s,l)=>{var c=wt(),m=t(c),w=t(m,!0);a(m);var g=r(m);a(c),z(h=>{Le(c,1,`badge badge-sm badge-soft ${h??""}`),L(w,e(l).materielName),L(g,` × ${e(l).quantity??""}`)},[()=>X(e(l))]),u(s,c)}),a(P);var ve=r(P,2);{var V=s=>{var l=kt(),c=r(t(l));a(l),z(()=>L(c,` ${n.loan.returnNotes??""}`)),u(s,l)};S(ve,s=>{n.loan.returnNotes&&s(V)})}a(Y);var o=r(Y,2),p=t(o);Se(p,17,()=>e(A)(),ga,(s,l)=>{var c=It();c.__click=()=>se(e(l).action);var m=t(c);na(m,()=>e(l).icon,(h,G)=>{G(h,{class:"h-4 w-4"})});var w=r(m,2),g=t(w,!0);a(w),a(c),z(()=>{Le(c,1,`btn btn-sm ${e(l).class??""}`),ra(c,"title",e(l).label),L(g,e(l).label)}),u(s,c)});var N=r(p,2);{var d=s=>{var l=Ct();l.__click=()=>n.onEdit(n.loan.$id);var c=t(l);Ya(c,{class:"h-4 w-4"}),a(l),u(s,l)};S(N,s=>{n.onEdit&&n.loan.status==="asked"&&s(d)})}a(o),a(J),a(F),a(k),z((s,l)=>{L(re,n.loan.responsibleName),Le(ne,1,`flex items-center gap-1 ${e(x).class??""} font-bold`),L(be,`${s??""} - ${l??""}`),Le(I,1,`badge ${e(v).badgeClass??""} badge-sm gap-1`),L(M,e(v).label)},[()=>ja(n.loan.startDate),()=>ja(n.loan.endDate)]),u(ge,k),Ke()}Ge(["click"]);var St=f('<div class="ml-8"><label class="input input-sm w-32"><span class="label text-xs">Qté perdue:</span> <input type="number" class="grow" min="0"/></label></div>'),qt=f('<div class="ml-8"><label class="input input-sm w-32"><span class="label text-xs">Qté cassée:</span> <input type="number" class="grow" min="0"/></label></div>'),At=f('<div class="border-base-300 bg-base-100 rounded-lg border p-4"><div class="mb-3 flex items-start gap-3"><div class="bg-primary/10 rounded-lg p-2"><!></div> <div class="flex-1"><div class="font-semibold"> </div> <div class="text-sm opacity-70"> </div></div></div> <div class="ml-10 space-y-3"><label class="flex cursor-pointer items-start gap-3"><input type="checkbox" class="checkbox checkbox-success checkbox-sm mt-1"/> <div class="text-sm"><div class="font-medium">Tout est OK</div> <div class="opacity-60">Aucune perte ni casse</div></div></label> <div class="space-y-2"><label class="flex cursor-pointer items-start gap-3"><input type="checkbox" class="checkbox checkbox-error checkbox-sm mt-1"/> <div class="flex-1 text-sm"><div class="flex items-center gap-2 font-medium"><!> Des pièces sont perdues</div></div></label> <!></div> <div class="space-y-2"><label class="flex cursor-pointer items-start gap-3"><input type="checkbox" class="checkbox checkbox-warning checkbox-sm mt-1"/> <div class="flex-1 text-sm"><div class="flex items-center gap-2 font-medium"><!> Des pièces sont cassées</div> <div class="text-xs opacity-60">À réparer (status: torepair)</div></div></label> <!></div></div></div>'),Dt=f('<div class="text-error"> </div>'),Mt=f('<div class="text-warning"> </div>'),Nt=f('<div class="alert alert-warning"><!> <div><h4 class="font-bold"> </h4> <div class="text-sm"><!> <!></div></div></div> )',1),Tt=f('<span class="loading loading-spinner loading-sm"></span>'),Et=f(`<div><div class="modal-box fixed top-0 flex h-lvh w-lvw flex-col overflow-auto md:top-10 md:h-full md:max-h-11/12 md:w-full md:max-w-3xl"><div class="flex items-center justify-between border-b p-4 pt-0"><div><h3 class="text-lg font-bold">Retour d'emprunt</h3> <p class="text-sm opacity-70"> </p></div> <button class="btn btn-circle btn-ghost btn-sm absolute top-2 right-2" aria-label="Fermer"><!></button></div> <div class="flex-1 space-y-6 overflow-y-auto p-4"><div class="space-y-4"><h4 class="text-sm font-semibold uppercase opacity-70">Matériel à retourner</h4> <!></div> <!> <fieldset class="fieldset bg-base-100"><legend class="fieldset-legend">Notes de retour (optionnel)</legend> <textarea class="textarea textarea-bordered w-full" rows="3" placeholder="Précisez l'état du matériel, les raisons des pertes/casses, etc." maxlength="1000"></textarea></fieldset></div> <div class="border-base-300 flex-none border-t px-4 py-3"><div class="flex flex-wrap items-center justify-end gap-2"><button class="btn btn-ghost"><!> Annuler</button> <button class="btn btn-warning"><!> Valider le retour</button></div></div></div></div>`);function Rt(ge,n){He(n,!0);let R=W(Ia([])),b=W(""),x=W(!1);sa(()=>{if(!n.loan)return;const d=n.loan.materielItems;_(R,d.map(s=>({materielId:s.materielId,materielName:s.materielName,quantity:s.quantity,type:"",lostQuantity:0,brokenQuantity:0})),!0),d.forEach(s=>{const l=le.materiels.find(c=>c.$id===s.materielId);if(l){const c=e(R).find(m=>m.materielId===s.materielId);c&&(c.type=l.type||"")}})});const X=q(()=>e(R).every(d=>d.lostQuantity>=0&&d.brokenQuantity>=0&&d.lostQuantity+d.brokenQuantity<=d.quantity)&&!e(x)),v=q(()=>e(R).reduce((d,s)=>d+s.lostQuantity,0)),A=q(()=>e(R).reduce((d,s)=>d+s.brokenQuantity,0));async function se(){if(e(X)){_(x,!0);try{const d=e(R).map(s=>({materielId:s.materielId,materielName:s.materielName,quantity:s.quantity,lostQuantity:s.lostQuantity>0?s.lostQuantity:void 0,brokenQuantity:s.brokenQuantity>0?s.brokenQuantity:void 0}));await le.updateLoan(n.loan.$id,{materiels:d,status:"returned",returnedAt:new Date().toISOString(),returnNotes:e(b).trim()||void 0}),n.onClose()}catch(d){console.error("Erreur retour emprunt:",d)}finally{_(x,!1)}}}function k(){_(b,""),n.onClose()}function F(d){switch(d){case"electronic":return ka;case"manual":return aa;case"cooking":return wa;case"dish":return ya;case"gaz":return ha;case"hygiene":return xa;default:return ea}}var J=Et(),Y=t(J),Z=t(Y),ie=t(Z),D=r(t(ie),2),de=t(D);a(D),a(ie);var re=r(ie,2);re.__click=k;var ne=t(re);ye(ne,{class:"h-4 w-4"}),a(re),a(Z);var j=r(Z,2),$=t(j),oe=r(t($),2);Se(oe,17,()=>e(R),d=>d.materielId,(d,s,l)=>{const c=q(()=>F(e(s).type));var m=At(),w=t(m),g=t(w),h=t(g);na(h,()=>e(c),(B,K)=>{K(B,{class:"text-primary h-5 w-5"})}),a(g);var G=r(g,2),pe=t(G),we=t(pe,!0);a(pe);var xe=r(pe,2),T=t(xe);a(xe),a(G),a(w);var Q=r(w,2),O=t(Q),H=t(O);_e(H),H.__change=B=>{B.target.checked&&(e(s).lostQuantity=0,e(s).brokenQuantity=0)},E(2),a(O);var ke=r(O,2),he=t(ke),ue=t(he);_e(ue),ue.__change=B=>{const K=B.target;e(s).lostQuantity=K.checked?1:0};var Me=r(ue,2),Re=t(Me),la=t(Re);Ta(la,{class:"h-3 w-3"}),E(),a(Re),a(Me),a(he);var ia=r(he,2);{var oa=B=>{var K=St(),qe=t(K),me=r(t(qe),2);_e(me),a(qe),a(K),z(()=>{ra(me,"max",e(s).quantity-e(s).brokenQuantity),me.disabled=e(x)}),Ee(me,()=>e(s).lostQuantity,i=>e(s).lostQuantity=i),u(B,K)};S(ia,B=>{e(s).lostQuantity>0&&B(oa)})}a(ke);var We=r(ke,2),ze=t(We),Ie=t(ze);_e(Ie),Ie.__change=B=>{const K=B.target;e(s).brokenQuantity=K.checked?1:0};var je=r(Ie,2),Ce=t(je),da=t(Ce);aa(da,{class:"h-3 w-3"}),E(),a(Ce),E(2),a(je),a(ze);var Ne=r(ze,2);{var ca=B=>{var K=qt(),qe=t(K),me=r(t(qe),2);_e(me),a(qe),a(K),z(()=>{ra(me,"max",e(s).quantity-e(s).lostQuantity),me.disabled=e(x)}),Ee(me,()=>e(s).brokenQuantity,i=>e(s).brokenQuantity=i),u(B,K)};S(Ne,B=>{e(s).brokenQuantity>0&&B(ca)})}a(We),a(Q),a(m),z(()=>{L(we,e(s).materielName),L(T,`Quantité empruntée : ${e(s).quantity??""}`),fa(H,e(s).lostQuantity===0&&e(s).brokenQuantity===0),H.disabled=e(x),fa(ue,e(s).lostQuantity>0),ue.disabled=e(x),fa(Ie,e(s).brokenQuantity>0),Ie.disabled=e(x)}),u(d,m)}),a($);var ee=r($,2);{var be=d=>{var s=Nt(),l=De(s),c=t(l);Ta(c,{class:"h-5 w-5"});var m=r(c,2),w=t(m),g=t(w);a(w);var h=r(w,2),G=t(h);{var pe=T=>{var Q=Dt(),O=t(Q);a(Q),z(()=>L(O,`• ${e(v)??""} perdue${e(v)>1?"s":""} (déduit du stock)`)),u(T,Q)};S(G,T=>{e(v)>0&&T(pe)})}var we=r(G,2);{var xe=T=>{var Q=Mt(),O=t(Q);a(Q),z(()=>L(O,`• ${e(A)??""} cassée${e(A)>1?"s":""} (à réparer)`)),u(T,Q)};S(we,T=>{e(A)>0&&T(xe)})}a(h),a(m),a(l),E(),z(()=>L(g,`Attention : ${e(v)+e(A)} unité${e(v)+e(A)>1?"s":""} problématique${e(v)+e(A)>1?"s":""}`)),u(d,s)};S(ee,d=>{(e(v)>0||e(A)>0)&&d(be)})}var I=r(ee,2),M=r(t(I),2);Fa(M),a(I),a(j);var U=r(j,2),ce=t(U),P=t(ce);P.__click=k;var ve=t(P);ye(ve,{class:"h-5 w-5"}),E(),a(P);var V=r(P,2);V.__click=se;var o=t(V);{var p=d=>{var s=Tt();u(d,s)},N=d=>{Ve(d,{class:"h-5 w-5"})};S(o,d=>{e(x)?d(p):d(N,!1)})}E(),a(V),a(ce),a(U),a(Y),a(J),z((d,s)=>{Le(J,1,`modal ${(n.isOpen&&"modal-open")??""}`),L(de,`Du ${d??""} au ${s??""}`),M.disabled=e(x),P.disabled=e(x),V.disabled=!e(X)},[()=>new Date(n.loan.startDate).toLocaleDateString("fr-FR"),()=>new Date(n.loan.endDate).toLocaleDateString("fr-FR")]),Ee(M,()=>e(b),d=>_(b,d)),u(ge,J),Ke()}Ge(["click","change"]);var zt=f('<button><!> <span class="badge badge-sm badge-neutral ml-2"> </span></button>'),jt=f('<div class="tabs tabs-border bg-base-200 tabs-lg mb-6 font-medium"></div>'),Pt=f('<div class="alert alert-warning"><span>Vous devez être connecté pour voir les emprunts.</span></div>'),Ft=f('<div class="alert alert-error shadow-lg"><span> </span></div>'),Ot=f('<div class="alert alert-info"><span>Sélectionnez une équipe pour voir ses emprunts.</span></div>'),Bt=f(`<div class="bg-base-200 rounded-box border-base-200 border-2 border-dashed py-20 text-center"><!> <h3 class="mb-2 text-lg font-bold">Aucune réservation</h3> <p class="text-base-content/60 mb-6">Cette équipe n'a pas encore d'emprunt.</p> <button class="btn btn-primary btn-sm">Créer une réservation</button></div>`),Ut=f('<div class="space-y-4"><div class="mb-6 flex justify-end"><button class="btn btn-primary btn-wide flex gap-2"><!> Ajouter une reservation</button></div> <!></div>'),Vt=f('<div class="container mx-auto p-4"><div class="mx-auto max-w-7xl px-4 py-8"><!> <!></div></div> <!> <!>',1);function $t(ge,n){He(n,!0);let R=W(!1),b=W(null),x=W(!1),X=W(null),v=W(!1);function A(){if(!e(b))return;if(!e(D).find(p=>p.$id===e(b))){Qe.error("Équipe introuvable");return}_(R,!0)}function se(){_(R,!1)}function k(){console.log("[LoansPage] Emprunt créé avec succès"),se()}function F(o){_a(`/dashboard/loans/return/${o}`)}function J(){_(x,!1),_(X,null)}async function Y(o){try{await le.acceptLoan(o),Qe.success("Emprunt accepté avec succès")}catch(p){console.error("[LoansPage] Erreur acceptation emprunt:",p),Qe.error("Erreur lors de l'acceptation de l'emprunt")}}async function Z(o){try{await le.cancelLoan(o),Qe.success("Emprunt annulé avec succès")}catch(p){console.error("[LoansPage] Erreur annulation emprunt:",p),Qe.error("Erreur lors de l'annulation de l'emprunt")}}async function ie(o){try{await le.deleteLoan(o),Qe.success("Emprunt supprimé avec succès")}catch(p){console.error("[LoansPage] Erreur suppression emprunt:",p),Qe.error("Erreur lors de la suppression de l'emprunt")}}const D=q(()=>rt.myTeams),de=q(()=>e(b)?e(D).find(o=>o.$id===e(b)):null),re=q(()=>{if(!e(b))return console.log("[LoansPage] teamLoans: pas d'activeTeamId"),[];const o=le.loans.filter(p=>p.ownerId===e(b));return console.log("[LoansPage] teamLoans filtrés:",{activeTeamId:e(b),totalLoans:le.loans.length,filteredCount:o.length,allLoans:le.loans.map(p=>({id:p.$id,ownerId:p.ownerId}))}),o});function ne(o){_a(`/dashboard/loans/${o}`)}sa(()=>{const o=n.params?.teamId;if(o&&o!==e(b)){console.log("[LoansPage] teamIdFromParams:",o);const p=e(D).find(N=>N.$id===o);console.log("[LoansPage] équipe trouvée:",p),p&&(console.log("[LoansPage] Mise à jour activeTeamId:",o),_(b,o,!0))}else!o&&!e(b)&&!e(v)&&e(D).length>0&&(console.log("[LoansPage] Redirection vers première équipe:",e(D)[0].$id),_(v,!0),_a(`/dashboard/loans/${e(D)[0].$id}`))}),sa(()=>{const p=(e(b)?e(D).find(N=>N.$id===e(b)):null)?.name||"Emprunts";za.setConfig({title:p,materielContext:"loans",teamId:e(b)||void 0})}),st(()=>{za.reset()});var j=Vt(),$=De(j),oe=t($),ee=t(oe);{var be=o=>{var p=jt();Se(p,21,()=>e(D),N=>N.$id,(N,d)=>{const s=q(()=>le.loans.filter(h=>h.ownerId===e(d).$id).length);var l=zt();l.__click=()=>ne(e(d).$id);var c=t(l);Ea(c,{class:"mr-2 h-4 w-4"});var m=r(c),w=r(m),g=t(w,!0);a(w),a(l),z(()=>{Le(l,1,`tab ${e(b)===e(d).$id?"tab-active":""}`),L(m,` ${e(d).name??""} `),L(g,e(s))}),u(N,l)}),a(p),u(o,p)};S(ee,o=>{e(D).length>1&&o(be)})}var I=r(ee,2);{var M=o=>{var p=Pt();u(o,p)},U=o=>{var p=$e(),N=De(p);{var d=l=>{var c=Ft(),m=t(c),w=t(m,!0);a(m),a(c),z(()=>L(w,le.error)),u(l,c)},s=l=>{var c=$e(),m=De(c);{var w=h=>{var G=Ot();u(h,G)},g=h=>{var G=$e(),pe=De(G);{var we=T=>{var Q=Bt(),O=t(Q);Ea(O,{class:"mx-auto mb-4 h-12 w-12  text-center opacity-50"});var H=r(O,6);H.__click=A,a(Q),u(T,Q)},xe=T=>{var Q=Ut(),O=t(Q),H=t(O);H.__click=A;var ke=t(H);Za(ke,{size:16}),E(),a(H),a(O);var he=r(O,2);Se(he,17,()=>e(re),ue=>ue.$id,(ue,Me)=>{Lt(ue,{get loan(){return e(Me)},onReturn:F,onAccept:Y,onCancel:Z,onDelete:ie})}),a(Q),u(T,Q)};S(pe,T=>{e(re).length===0?T(we):T(xe,!1)})}u(h,G)};S(m,h=>{e(b)?h(g,!1):h(w)},!0)}u(l,c)};S(N,l=>{le.error?l(d):l(s,!1)},!0)}u(o,p)};S(I,o=>{Te.isAuthenticated?o(U,!1):o(M)})}a(oe),a($);var ce=r($,2);{var P=o=>{ht(o,{get isOpen(){return e(R)},onClose:se,onSuccess:k,get ownerId(){return e(de).$id},get ownerName(){return e(de).name}})};S(ce,o=>{e(de)&&o(P)})}var ve=r(ce,2);{var V=o=>{Rt(o,{get loan(){return e(X)},get isOpen(){return e(x)},onClose:J})};S(ve,o=>{e(x)&&e(X)&&o(V)})}u(ge,j),Ke()}Ge(["click"]);export{$t as default};
