import{d as la,p as Xa,y as T,z as fa,J as Xe,A as u,v as f,g as s,h as t,K as I,m as e,u as q,e as Ee,b as m,ab as ha,w as A,x as w,C as ze,c as ia,t as Ya,B as oa,o as a,G as B,a0 as R,O as ne,I as He,k as Ce,M as pa,ad as Za,T as Ke,W as Fe,ag as Ua,i as Ca,ah as $a,j as ma,am as Da,D as et,E as Qa,Y as at,P as tt,F as rt}from"./appwrite.js";import{n as Ea,a as nt}from"./index.js";import{A as st}from"./AutocompleteInput.js";import{B as lt}from"./BtnGroupCheck.js";import{X as Re,a0 as sa,a5 as _a,T as La,a6 as qa,r as Sa,a7 as Pa,k as Ma,a8 as ga,a9 as Aa,ab as Ta,f as it,t as xa,j as Va,ad as ja,G as Na,ac as ot,ae as za,af as Ra,ag as dt,ah as ct,ai as vt,D as ut,U as Oa,c as bt}from"./icons.js";import{a as Ba}from"./date-helpers.js";import"./keyboardNavigation.svelte.js";import"./CheckboxBadge.js";var mt=f('<div class="alert alert-warning alert-soft text-base"><!> <span> </span></div>'),ft=f('<div class="mb-6"><h4 class="mb-3 flex items-center gap-2 text-base font-semibold"><div class="bg-primary/10 rounded-lg p-1.5"><!></div> <span class="badge badge-ghost badge-sm ml-auto"> </span></h4> <!></div>'),pt=f(`<div class="text-center py-12 opacity-50"><!> <p class="text-lg font-medium">Aucun matériel disponible</p> <p class="text-sm mt-2">Vérifiez que l'équipe possède du matériel ou sélectionnez une
            période différente</p></div>`),_t=f(`<div><div class="modal-box fixed top-0 flex h-lvh w-lvw flex-col overflow-auto md:top-10 md:h-full md:max-h-11/12 md:w-full md:max-w-4xl"><div class="flex items-center justify-between border-b p-4 pt-0"><h3 class="text-lg font-bold">Sélection rapide du matériel</h3> <button class="btn btn-circle btn-ghost btn-sm absolute top-2 right-2" aria-label="Fermer"><!></button></div> <div class="flex-1 space-y-6 overflow-y-auto p-4"><div class="alert alert-info alert-soft text-base"><!> <span>Les nombres indiquent les quantités disponibles de chaque matériel,
          vous indiquerez après la quantité que vous souhaitez réserver.</span></div> <!> <!></div> <div class="border-base-300 flex-none border-t px-4 py-3"><div class="flex flex-wrap items-center justify-between gap-2"><div class="text-sm opacity-70"> </div> <div class="flex gap-2"><button class="btn btn-ghost">Annuler</button> <button class="btn btn-primary">Ajouter la sélection</button></div></div></div></div></div>`);function gt(Le,o){la(o,!0);let k=Xa(o,"selectedIds",19,()=>new Set);const b=q(()=>o.materiels.filter(y=>y.availableForPeriod===void 0||y.availableForPeriod===0)),g=q(()=>({electronic:"Électronique",manual:"Ustensiles",cooking:"Matériel de cuisine",dish:"Vaisselle",gaz:"Gaz",hygiene:"Hygiène",other:"Autre"})),W=q(()=>({electronic:Aa,manual:ga,cooking:Ma,dish:Pa,gaz:Sa,hygiene:qa,other:_a})),_=q(()=>{const y={};return o.materiels.forEach(Q=>{const K=Q.type||"other";y[K]||(y[K]=[]);const v={...Q,isUnavailable:!Q.availableForPeriod||Q.availableForPeriod===0};y[K].push(v)}),y});let x=T(fa(new Set));Xe(()=>{u(x,new Set(k()),!0)});function Z(y){e(x).has(y)?e(x).delete(y):e(x).add(y),u(x,new Set(e(x)),!0)}function F(){o.onAdd(Array.from(e(x))),o.onClose()}function $(){u(x,new Set(k()),!0),o.onClose()}var E=_t(),D=t(E),H=t(D),j=s(t(H),2);j.__click=$;var ge=t(j);Re(ge,{class:"h-4 w-4"}),a(j),a(H);var be=s(H,2),S=t(be),me=t(S);sa(me,{class:"h-5 w-5"}),B(2),a(S);var oe=s(S,2);{var xe=y=>{var Q=mt(),K=t(Q);La(K,{class:"h-5 w-5"});var v=s(K,2),n=t(v);a(v),a(Q),A(()=>w(n,`${e(b).length??""} matériel${e(b).length>1?"s":""}
            indisponible${e(b).length>1?"s":""} sur la période
            sélectionnée. Ils sont affichés en grisé dans la liste.`)),m(y,Q)};I(oe,y=>{e(b).length>0&&y(xe)})}var he=s(oe,2);Ee(he,17,()=>Object.entries(e(_)),([y,Q])=>y,(y,Q,K,v)=>{var n=q(()=>Ya(e(Q),2));let r=()=>e(n)[0],l=()=>e(n)[1];const C=q(()=>e(W)[r()]);var h=ft(),p=t(h),P=t(p),z=t(P);ha(z,()=>e(C),(re,M)=>{M(re,{class:"text-primary h-4 w-4"})}),a(P);var X=s(P),ie=s(X),U=t(ie);a(ie),a(p);var fe=s(p,2);{let re=q(()=>l().map(M=>({id:M.$id,label:M.name,badge:M.availableForPeriod!==void 0?String(M.availableForPeriod):"0",selected:e(x).has(M.$id),title:M.availableForPeriod!==void 0?`${M.availableForPeriod}/${M.quantity} disponibles`:"Indisponible sur cette période",disabled:M.isUnavailable})));lt(fe,{get items(){return e(re)},onToggleItem:Z,size:"md",color:"primary"})}a(h),A(re=>{w(X,` ${e(g)[r()]??""} `),w(U,`${re??""}/${l().length??""}`)},[()=>l().filter(re=>e(x).has(re.$id)).length]),m(y,h)},y=>{var Q=pt(),K=t(Q);_a(K,{class:"h-16 w-16 mx-auto mb-4"}),B(4),a(Q),m(y,Q)}),a(be);var ee=s(be,2),de=t(ee),ae=t(de),se=t(ae);a(ae);var ce=s(ae,2),ve=t(ce);ve.__click=$;var te=s(ve,2);te.__click=F,a(ce),a(de),a(ee),a(D),a(E),A(()=>{ze(E,1,`modal ${(o.isOpen&&"modal-open")??""}`),w(se,`${e(x).size??""} matériel${e(x).size>1?"s":""}
          sélectionné${e(x).size>1?"s":""}`),te.disabled=e(x).size===0}),m(Le,E),ia()}oa(["click"]);var xt=f('<div class="flex items-center justify-center py-12"><div class="text-center"><!> <p class="text-lg font-medium">Chargement de la réservation...</p></div></div>'),ht=f('<span> </span> <span class="font-medium"> </span>',1),yt=f(`<div class="alert alert-warning alert-soft"><!> <div><p class="font-semibold">Certaines choses étaient déjà réservées sur ces dates et ont été
                retirées de la liste.</p> <p class="mt-1 text-sm opacity-80"><!></p></div></div>`),wt=f(`<div class="alert alert-info max-md:alert-vertical"><!> <span>Veuillez sélectionner une <strong>date de début</strong> et une <strong>date de fin</strong> pour voir le matériel disponible sur
                cette période.</span></div>`),It=f('<div class="alert alert-warning"><!> <span>Aucun matériel disponible pour la période sélectionnée.</span></div>'),kt=f('<span> </span> <span class="font-medium"> </span>',1),Dt=f('<div class="alert alert-warning alert-soft"><!> <div><p class="font-semibold"> </p> <p class="mt-1 text-sm opacity-80"><!></p></div></div>'),Qt=f('<div class="flex flex-wrap gap-6"><div class="flex-1"><!></div> <button class="btn btn-secondary btn-md flex-1 gap-2"><!> Ajout rapide</button></div> <!> <!>',1),Ct=f("<option></option>"),Lt=f('<div class="bg-base-200 rounded-lg p-2"><div class="flex items-center gap-2"><div class="bg-base-300 rounded p-1"><!></div> <div class="min-w-0 flex-1"><div class="truncate font-medium"> </div> <div class="text-xs opacity-70">Disponible : <span class="font-semibold"> </span></div></div> <div class="flex items-center gap-1"><span class="text-sm opacity-70"><!></span> <label class="select join"><select class="join-item select-sm select-bordered w-20"></select></label></div> <button class="btn btn-ghost btn-xs btn-circle" aria-label="Supprimer"><!></button></div></div>'),qt=f('<div class="space-y-2"><p class="text-sm font-semibold opacity-70">Matériels sélectionnés</p> <!></div>'),St=f(`<div class="py-8 text-center opacity-50"><!> <p class="text-sm">Aucun matériel sélectionné</p> <p class="text-xs">Utilisez la recherche ou l'ajout rapide pour ajouter du matériel</p></div>`),Pt=f(`<!> <div class="space-y-4"><div class="flex flex-wrap gap-4"><label class="input min-w-[200px] flex-1"><span class="label"><!> Date début *</span> <input type="date" class="grow"/></label> <label class="input min-w-[200px] flex-1"><span class="label"><!> Date fin *</span> <input type="date" class="grow"/></label></div> <label class="input w-full"><span class="label"><!> Responsable</span> <input type="text" class="grow" disabled/></label> <fieldset class="fieldset bg-base-100"><legend class="fieldset-legend">Notes (optionnel)</legend> <textarea class="textarea textarea-bordered w-full" rows="2" placeholder="Informations complémentaires sur l'emprunt..." maxlength="500"></textarea></fieldset></div> <div class="space-y-4"><h4 class="flex items-center gap-2 text-sm font-semibold uppercase opacity-70"><!> </h4> <!> <!></div>`,1),Mt=f('<span class="loading loading-spinner loading-sm"></span>'),At=f('<div><div class="modal-box fixed top-0 flex h-lvh w-lvw flex-col overflow-auto md:top-10 md:h-full md:max-h-11/12 md:w-full md:max-w-4xl"><div class="flex items-center justify-between border-b p-4 pt-0"><h3 class="flex items-center gap-2 text-lg font-bold"><!> </h3> <button class="btn btn-circle btn-ghost btn-sm absolute top-2 right-2" aria-label="Fermer"><!></button></div> <div class="flex-1 space-y-6 overflow-y-auto p-4"><!></div> <div class="border-base-300 flex-none border-t px-4 py-3"><div class="flex flex-wrap items-center justify-end gap-2"><button class="btn btn-ghost"><!> Annuler</button> <button class="btn btn-primary"><!> </button></div></div></div> <!></div>');function Nt(Le,o){la(o,!0);let k=q(()=>o.loanId?"edit":"create"),b=T(""),g=T(""),W=T(""),_=T(fa([])),x=T("accepted"),Z=T(!1),F=T(!1),$=T(!1),E=T(null),D=T(fa({count:0,removed:[]})),H=T(!1);const j=q(()=>!e(b)||!e(g)?R.getAvailableMaterielsByOwner(o.ownerId):R.getAvailableMaterielsForPeriod(o.ownerId,e(b),e(g),e(k)==="edit"?o.loanId:void 0)),ge=q(()=>{if(!e(b)||!e(g))return R.getMaterielsByOwner(o.ownerId).map(d=>({...d,availableForPeriod:d.availableQuantity}));const i=R.getMaterielsByOwner(o.ownerId);return new Set(e(j).map(d=>d.$id)),i.map(d=>{const c=e(j).find(L=>L.$id===d.$id);return{...d,availableForPeriod:c?.availableForPeriod||0}})}),be=q(()=>e(b)!==""&&e(g)!==""&&e(b)<e(g)&&e(_).length>0&&e(_).every(i=>i.quantity>=1)&&He.userId!==null&&He.userId!==void 0&&!e(F)&&!e($));Xe(()=>{if(!e(b)||!e(g)){u(D,{count:0,removed:[]},!0),u(H,!1);return}if(e(H))return;const i=[],d=e(_).map(c=>{const L=e(j).find(le=>le.$id===c.materielId);return!L||L.availableForPeriod===void 0||L.availableForPeriod===0?(i.push(c.materielName),null):(c.quantity>L.availableForPeriod&&(c.quantity=L.availableForPeriod,c.maxQuantity=L.availableForPeriod),c)}).filter(c=>c!==null);i.length>0?u(D,{count:i.length,removed:i},!0):u(D,{count:0,removed:[]},!0),JSON.stringify(d)!==JSON.stringify(e(_))&&(u(H,!0),u(_,d,!0))}),Xe(()=>{if(o.isOpen)if(e(k)==="edit"&&o.loanId){u($,!0);const i=R.getLoanById(o.loanId);i?(u(E,i,!0),u(b,i.startDate.split("T")[0],!0),u(g,i.endDate.split("T")[0],!0),u(W,i.notes||"",!0),u(x,i.status,!0),u(_,i.materielItems.map(d=>{const c=R.getMaterielById(d.materielId);return{materielId:d.materielId,materielName:d.materielName,quantity:d.quantity,type:c?.type||"",maxQuantity:d.quantity}}),!0)):(ne.error("Emprunt introuvable"),o.onClose()),u($,!1)}else e(k)==="create"&&ee()});function S(i){const d=i.availableForPeriod??i.availableQuantity,c=e(_).find(L=>L.materielId===i.$id);if(c){c.quantity<d&&c.quantity++;return}u(_,[...e(_),{materielId:i.$id,materielName:i.name,quantity:1,type:i.type||"",maxQuantity:d}],!0)}function me(i){u(_,e(_).filter(d=>d.materielId!==i),!0)}function oe(i,d){u(_,e(_).map(c=>c.materielId===i?{...c,quantity:Math.max(1,Math.min(d,c.maxQuantity))}:c),!0)}function xe(i){i.forEach(d=>{const c=e(j).find(L=>L.$id===d);c&&S(c)}),u(Z,!1)}async function he(){if(e(be)){if(e(k)==="edit"&&e(E)){const i=new Date,d=new Date(e(E).endDate);if(i>d){ne.error("Impossible de modifier un emprunt dont la date est passée");return}const c=new Date(e(E).startDate);if(i>=c&&e(b)!==e(E).startDate){ne.error("Impossible de modifier la date de début d'un emprunt en cours");return}}u(F,!0);try{const i=e(_).map(d=>({materielId:d.materielId,materielName:d.materielName,quantity:d.quantity}));if(e(k)==="create"){const d=He.userId||"",c=He.userName||"Inconnu";await R.createLoan({startDate:e(b),endDate:e(g),responsibleId:d,responsibleName:c,ownerId:o.ownerId,ownerName:o.ownerName,materiels:i,notes:e(W).trim()||void 0,status:e(x)}),ne.success("Réservation créée avec succès")}else{if(!o.loanId)throw new Error("loanId manquant en mode édition");await R.updateLoan(o.loanId,{startDate:e(b),endDate:e(g),materiels:i,notes:e(W).trim()||void 0}),ne.success("Réservation modifiée avec succès")}ee(),o.onClose(),o.onSuccess?.()}catch(i){console.error(e(k)==="create"?"Erreur création emprunt:":"Erreur mise à jour emprunt:",i),ne.error(e(k)==="create"?"Erreur lors de la création de la réservation":"Erreur lors de la modification de la réservation")}finally{u(F,!1)}}}function ee(){u(b,""),u(g,""),u(W,""),u(_,[],!0),u(x,"accepted")}function de(){ee(),o.onClose()}var ae=At(),se=t(ae),ce=t(se),ve=t(ce),te=t(ve);Ta(te,{class:"h-5 w-5"});var y=s(te);a(ve);var Q=s(ve,2);Q.__click=de;var K=t(Q);Re(K,{class:"h-4 w-4"}),a(Q),a(ce);var v=s(ce,2),n=t(v);{var r=i=>{var d=xt(),c=t(d),L=t(c);it(L,{class:"text-primary mx-auto mb-4 h-12 w-12 animate-spin"}),B(2),a(c),a(d),m(i,d)},l=i=>{var d=Pt(),c=Ce(d);{var L=N=>{var V=yt(),_e=t(V);sa(_e,{class:"h-5 w-5"});var ke=s(_e,2),G=s(t(ke),2),Te=t(G);{var aa=De=>{var je=ht(),Se=Ce(je),ta=t(Se);a(Se);var J=s(Se,2),ue=t(J,!0);a(J),A(Me=>{w(ta,`Retiré${e(D).removed.length>1?"s":""} :`),w(ue,Me)},[()=>e(D).removed.join(", ")]),m(De,je)};I(Te,De=>{e(D).removed.length>0&&De(aa)})}a(G),a(ke),a(V),m(N,V)};I(c,N=>{e(D).count>0&&N(L)})}var le=s(c,2),ye=t(le),Pe=t(ye),we=t(Pe),Ye=t(we);xa(Ye,{class:"h-4 w-4"}),B(),a(we);var Ze=s(we,2);Fe(Ze),a(Pe);var da=s(Pe,2),Oe=t(da),$e=t(Oe);xa($e,{class:"h-4 w-4"}),B(),a(Oe);var Ie=s(Oe,2);Fe(Ie),a(da),a(ye);var Be=s(ye,2),Ue=t(Be),ya=t(Ue);Va(ya,{class:"h-4 w-4"}),B(),a(Ue);var ca=s(Ue,2);Fe(ca),a(Be);var va=s(Be,2),O=s(t(va),2);Ua(O),a(va),a(le);var Y=s(le,2),qe=t(Y),pe=t(qe);ja(pe,{class:"h-4 w-4"});var ea=s(pe);a(qe);var Fa=s(qe,2);{var Ga=N=>{var V=wt(),_e=t(V);sa(_e,{class:"h-5 w-5"}),B(2),a(V),m(N,V)},Ja=N=>{var V=Qt(),_e=Ce(V),ke=t(_e),G=t(ke);st(G,{get items(){return e(j)},itemToString:J=>J.name,onSelect:J=>S(J),placeholder:"Rechercher du matériel...",get disabled(){return e(F)}}),a(ke);var Te=s(ke,2);Te.__click=()=>u(Z,!0);var aa=t(Te);ja(aa,{class:"h-4 w-4"}),B(),a(Te),a(_e);var De=s(_e,2);{var je=J=>{var ue=It(),Me=t(ue);sa(Me,{class:"h-5 w-5"}),B(2),a(ue),m(J,ue)};I(De,J=>{e(j).length===0&&J(je)})}var Se=s(De,2);{var ta=J=>{var ue=Dt(),Me=t(ue);sa(Me,{class:"h-5 w-5"});var ra=s(Me,2),Ve=t(ra),wa=t(Ve);a(Ve);var Ge=s(Ve,2),na=t(Ge);{var Ia=Je=>{var Ae=kt(),Ne=Ce(Ae),ka=t(Ne);a(Ne);var Qe=s(Ne,2),We=t(Qe,!0);a(Qe),A(ua=>{w(ka,`Retiré${e(D).removed.length>1?"s":""} :`),w(We,ua)},[()=>e(D).removed.join(", ")]),m(Je,Ae)};I(na,Je=>{e(D).removed.length>0&&Je(Ia)})}a(Ge),a(ra),a(ue),A(()=>w(wa,`${e(D).count??""} matériel${e(D).count>1?"s":""}
                    sélectionné${e(D).count>1?"s":""} devenu${e(D).count>1?"s":""}
                    indisponible${e(D).count>1?"s":""} avec les nouvelles
                    dates`)),m(J,ue)};I(Se,J=>{e(D).count>0&&J(ta)})}A(()=>Te.disabled=e(F)||e(j).length===0),m(N,V)};I(Fa,N=>{!e(b)||!e(g)?N(Ga):N(Ja,!1)})}var Wa=s(Fa,2);{var Ha=N=>{var V=qt(),_e=s(t(V),2);Ee(_e,17,()=>e(_),ke=>ke.materielId,(ke,G,Te)=>{const aa=q(()=>e(G).type==="electronic"?Aa:e(G).type==="manual"?ga:e(G).type==="cooking"?Ma:e(G).type==="dish"?Pa:e(G).type==="gaz"?Sa:e(G).type==="hygiene"?qa:_a);var De=Lt(),je=t(De),Se=t(je),ta=t(Se);ha(ta,()=>e(aa),(Qe,We)=>{We(Qe,{class:"h-4 w-4 opacity-70"})}),a(Se);var J=s(Se,2),ue=t(J),Me=t(ue,!0);a(ue);var ra=s(ue,2),Ve=s(t(ra)),wa=t(Ve,!0);a(Ve),a(ra),a(J);var Ge=s(J,2),na=t(Ge),Ia=t(na);ot(Ia,{class:"inline h-3 w-3"}),a(na);var Je=s(na,2),Ae=t(Je);Ae.__change=Qe=>{const We=Qe.target;oe(e(G).materielId,parseInt(We.value))},Ee(Ae,21,()=>Array(e(G).maxQuantity),Ca,(Qe,We,ua)=>{var ba=Ct();ba.textContent=ua+1,ba.value=ba.__value=ua+1,m(Qe,ba)}),a(Ae),a(Je),a(Ge);var Ne=s(Ge,2);Ne.__click=()=>me(e(G).materielId);var ka=t(Ne);Re(ka,{class:"h-3 w-3"}),a(Ne),a(je),a(De),A(()=>{w(Me,e(G).materielName),w(wa,e(G).maxQuantity),Ae.disabled=e(F),Ne.disabled=e(F)}),$a(Ae,()=>e(G).quantity,Qe=>e(G).quantity=Qe),m(ke,De)}),a(V),m(N,V)},Ka=N=>{var V=St(),_e=t(V);Ta(_e,{class:"mx-auto mb-2 h-12 w-12"}),B(4),a(V),m(N,V)};I(Wa,N=>{e(_).length>0?N(Ha):N(Ka,!1)})}a(Y),A(()=>{Ze.disabled=e(F),Ie.disabled=e(F),pa(Ie,"min",e(b)),Za(ca,He.userName||"Utilisateur actuel"),O.disabled=e(F),w(ea,` Matériel à emprunter (${e(_).length??""})`)}),Ke(Ze,()=>e(b),N=>u(b,N)),Ke(Ie,()=>e(g),N=>u(g,N)),Ke(O,()=>e(W),N=>u(W,N)),m(i,d)};I(n,i=>{e(k)==="edit"&&e($)?i(r):i(l,!1)})}a(v);var C=s(v,2),h=t(C),p=t(h);p.__click=de;var P=t(p);Re(P,{class:"h-5 w-5"}),B(),a(p);var z=s(p,2);z.__click=he;var X=t(z);{var ie=i=>{var d=Mt();m(i,d)},U=i=>{Na(i,{class:"h-5 w-5"})};I(X,i=>{e(F)?i(ie):i(U,!1)})}var fe=s(X);a(z),a(h),a(C),a(se);var re=s(se,2);{var M=i=>{{let d=q(()=>new Set(e(_).map(c=>c.materielId)));gt(i,{get isOpen(){return e(Z)},onClose:()=>u(Z,!1),onAdd:xe,get selectedIds(){return e(d)},get materiels(){return e(ge)}})}};I(re,i=>{e(Z)&&i(M)})}a(ae),A(()=>{ze(ae,1,`modal ${(o.isOpen&&"modal-open")??""}`),w(y,` ${e(k)==="create"?`Nouvelle réservation - ${o.ownerName}`:`Modifier la réservation - ${o.ownerName}`}`),p.disabled=e(F)||e($),z.disabled=!e(be),w(fe,` ${e(k)==="create"?"Créer l'emprunt":"Sauvegarder"}`)}),m(Le,ae),ia()}oa(["click","change"]);var Ft=f('<div class="text-base-content/60 text-xs italic"> </div>'),Et=f('<span><span class="font-medium"> </span> </span>'),Tt=f('<div class="text-warning bg-warning/10 rounded p-2 text-xs"><strong>Retour :</strong> </div>'),jt=f("<button><!> <span> </span></button>"),zt=f('<button class="btn btn-primary btn-soft btn-sm" title="Modifier"><!></button>'),Rt=f('<div class="card bg-base-100 border-base-200 border text-left shadow-sm"><div class="card-body py-3"><div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between"><div class="flex min-w-0 flex-1 flex-col gap-4"><div class=" flex flex-wrap items-center gap-x-4 gap-y-1 text-base"><div class="flex items-center gap-1"><!> <span> </span></div> <div><!> <span> </span></div></div> <!> <div class="flex flex-wrap gap-2"></div> <!></div> <div class="flex flex-col gap-4 not-sm:mt-4"><!> <!></div></div></div></div>');function Ot(Le,o){la(o,!0);const k=q(()=>o.loan.materielItems),b=q(()=>{const v=new Date,n=new Date(o.loan.startDate),r=new Date(o.loan.endDate);return v<n?"future":v>=n&&v<=r?"current":"past"}),g=q(()=>{switch(e(b)){case"future":return{icon:Ra,class:"text-info",label:"À venir"};case"current":return{icon:za,class:"text-accent",label:"En cours"};default:return{icon:xa,class:"",label:""}}});function W(v){if(o.loan.status!=="completed")return"";const n=v.lostQuantity||0,r=v.brokenQuantity||0,l=n+r;return v.quantity-l===0?"badge-error":l>0?"badge-warning":"badge-success"}const _=q(()=>()=>{switch(o.loan.status){case"asked":return[{label:"Confirmer",icon:Na,action:o.onAccept,class:"btn-success"},{label:"Annuler",icon:vt,action:o.onCancel,class:"btn-error btn-outline"}];case"accepted":return[{label:"Compléter Fiche retour",icon:ct,action:o.onReturn,class:"btn-warning"}];case"completed":return[{label:"Fiche retour",icon:dt,action:o.onReturn,class:""}];case"refused":case"canceled":return[{label:"Supprimer",icon:Re,action:o.onDelete,class:"btn-error btn-sm"}];default:return[]}});function x(v){v?.(o.loan.$id)}var Z=Rt(),F=t(Z),$=t(F),E=t($),D=t(E),H=t(D),j=t(H);Va(j,{class:"h-4 w-4"});var ge=s(j,2),be=t(ge,!0);a(ge),a(H);var S=s(H,2),me=t(S);{var oe=v=>{Ra(v,{class:"h-4 w-4"})},xe=v=>{var n=ma(),r=Ce(n);{var l=h=>{za(h,{class:"h-4 w-4"})},C=h=>{xa(h,{class:"h-4 w-4"})};I(r,h=>{e(b)==="current"?h(l):h(C,!1)},!0)}m(v,n)};I(me,v=>{e(b)==="future"?v(oe):v(xe,!1)})}var he=s(me,2),ee=t(he);a(he),a(S),a(D);var de=s(D,2);{var ae=v=>{var n=Ft(),r=t(n);a(n),A(()=>w(r,`"${o.loan.notes??""}"`)),m(v,n)};I(de,v=>{o.loan.notes&&v(ae)})}var se=s(de,2);Ee(se,21,()=>e(k),Ca,(v,n)=>{var r=Et(),l=t(r),C=t(l,!0);a(l);var h=s(l);a(r),A(p=>{ze(r,1,`badge badge-sm badge-soft ${p??""}`),w(C,e(n).materielName),w(h,` × ${e(n).quantity??""}`)},[()=>W(e(n))]),m(v,r)}),a(se);var ce=s(se,2);{var ve=v=>{var n=Tt(),r=s(t(n));a(n),A(()=>w(r,` ${o.loan.returnNotes??""}`)),m(v,n)};I(ce,v=>{o.loan.returnNotes&&v(ve)})}a(E);var te=s(E,2),y=t(te);Ee(y,17,()=>e(_)(),Ca,(v,n)=>{var r=jt();r.__click=()=>x(e(n).action);var l=t(r);ha(l,()=>e(n).icon,(p,P)=>{P(p,{class:"h-4 w-4"})});var C=s(l,2),h=t(C,!0);a(C),a(r),A(()=>{ze(r,1,`btn btn-sm ${e(n).class??""}`),pa(r,"title",e(n).label),w(h,e(n).label)}),m(v,r)});var Q=s(y,2);{var K=v=>{var n=zt();n.__click=()=>o.onEdit(o.loan.$id);var r=t(n);ut(r,{class:"h-4 w-4"}),a(n),m(v,n)};I(Q,v=>{o.onEdit&&o.loan.status==="asked"&&v(K)})}a(te),a($),a(F),a(Z),A((v,n)=>{w(be,o.loan.responsibleName),ze(S,1,`flex items-center gap-1 ${e(g).class??""} font-bold`),w(ee,`${v??""} - ${n??""}`)},[()=>Ba(o.loan.startDate),()=>Ba(o.loan.endDate)]),m(Le,Z),ia()}oa(["click"]);var Bt=f('<div class="ml-8"><label class="input input-sm w-32"><span class="label text-xs">Qté perdue:</span> <input type="number" class="grow" min="0"/></label></div>'),Ut=f('<div class="ml-8"><label class="input input-sm w-32"><span class="label text-xs">Qté cassée:</span> <input type="number" class="grow" min="0"/></label></div>'),Vt=f('<div class="border-base-300 bg-base-100 rounded-lg border p-4"><div class="mb-3 flex items-start gap-3"><div class="bg-primary/10 rounded-lg p-2"><!></div> <div class="flex-1"><div class="font-semibold"> </div> <div class="text-sm opacity-70"> </div></div></div> <div class="ml-10 space-y-3"><label class="flex cursor-pointer items-start gap-3"><input type="checkbox" class="checkbox checkbox-success checkbox-sm mt-1"/> <div class="text-sm"><div class="font-medium">Tout est OK</div> <div class="opacity-60">Aucune perte ni casse</div></div></label> <div class="space-y-2"><label class="flex cursor-pointer items-start gap-3"><input type="checkbox" class="checkbox checkbox-error checkbox-sm mt-1"/> <div class="flex-1 text-sm"><div class="flex items-center gap-2 font-medium"><!> Des pièces sont perdues</div></div></label> <!></div> <div class="space-y-2"><label class="flex cursor-pointer items-start gap-3"><input type="checkbox" class="checkbox checkbox-warning checkbox-sm mt-1"/> <div class="flex-1 text-sm"><div class="flex items-center gap-2 font-medium"><!> Des pièces sont cassées</div> <div class="text-xs opacity-60">À réparer (status: torepair)</div></div></label> <!></div></div></div>'),Gt=f('<div class="text-error"> </div>'),Jt=f('<div class="text-warning"> </div>'),Wt=f('<div class="alert alert-warning"><!> <div><h4 class="font-bold"> </h4> <div class="text-sm"><!> <!></div></div></div> )',1),Ht=f('<span class="loading loading-spinner loading-sm"></span>'),Kt=f(`<div><div class="modal-box fixed top-0 flex h-lvh w-lvw flex-col overflow-auto md:top-10 md:h-full md:max-h-11/12 md:w-full md:max-w-3xl"><div class="flex items-center justify-between border-b p-4 pt-0"><div><h3 class="text-lg font-bold">Retour d'emprunt</h3> <p class="text-sm opacity-70"> </p></div> <button class="btn btn-circle btn-ghost btn-sm absolute top-2 right-2" aria-label="Fermer"><!></button></div> <div class="flex-1 space-y-6 overflow-y-auto p-4"><div class="space-y-4"><h4 class="text-sm font-semibold uppercase opacity-70">Matériel à retourner</h4> <!></div> <!> <fieldset class="fieldset bg-base-100"><legend class="fieldset-legend">Notes de retour (optionnel)</legend> <textarea class="textarea textarea-bordered w-full" rows="3" placeholder="Précisez l'état du matériel, les raisons des pertes/casses, etc." maxlength="1000"></textarea></fieldset></div> <div class="border-base-300 flex-none border-t px-4 py-3"><div class="flex flex-wrap items-center justify-end gap-2"><button class="btn btn-ghost"><!> Annuler</button> <button class="btn btn-warning"><!> Valider le retour</button></div></div></div></div>`);function Xt(Le,o){la(o,!0);let k=T(fa([])),b=T(""),g=T(!1);Xe(()=>{if(!o.loan)return;const r=o.loan.materielItems;u(k,r.map(l=>({materielId:l.materielId,materielName:l.materielName,quantity:l.quantity,type:"",lostQuantity:0,brokenQuantity:0})),!0),r.forEach(l=>{const C=R.materiels.find(h=>h.$id===l.materielId);if(C){const h=e(k).find(p=>p.materielId===l.materielId);h&&(h.type=C.type||"")}})});const W=q(()=>e(k).every(r=>r.lostQuantity>=0&&r.brokenQuantity>=0&&r.lostQuantity+r.brokenQuantity<=r.quantity)&&!e(g)),_=q(()=>e(k).reduce((r,l)=>r+l.lostQuantity,0)),x=q(()=>e(k).reduce((r,l)=>r+l.brokenQuantity,0));async function Z(){if(e(W)){u(g,!0);try{const r=e(k).map(l=>({materielId:l.materielId,materielName:l.materielName,quantity:l.quantity,lostQuantity:l.lostQuantity>0?l.lostQuantity:void 0,brokenQuantity:l.brokenQuantity>0?l.brokenQuantity:void 0}));await R.updateLoan(o.loan.$id,{materiels:r,status:"returned",returnedAt:new Date().toISOString(),returnNotes:e(b).trim()||void 0}),o.onClose()}catch(r){console.error("Erreur retour emprunt:",r)}finally{u(g,!1)}}}function F(){u(b,""),o.onClose()}function $(r){switch(r){case"electronic":return Aa;case"manual":return ga;case"cooking":return Ma;case"dish":return Pa;case"gaz":return Sa;case"hygiene":return qa;default:return _a}}var E=Kt(),D=t(E),H=t(D),j=t(H),ge=s(t(j),2),be=t(ge);a(ge),a(j);var S=s(j,2);S.__click=F;var me=t(S);Re(me,{class:"h-4 w-4"}),a(S),a(H);var oe=s(H,2),xe=t(oe),he=s(t(xe),2);Ee(he,17,()=>e(k),r=>r.materielId,(r,l,C)=>{const h=q(()=>$(e(l).type));var p=Vt(),P=t(p),z=t(P),X=t(z);ha(X,()=>e(h),(O,Y)=>{Y(O,{class:"text-primary h-5 w-5"})}),a(z);var ie=s(z,2),U=t(ie),fe=t(U,!0);a(U);var re=s(U,2),M=t(re);a(re),a(ie),a(P);var i=s(P,2),d=t(i),c=t(d);Fe(c),c.__change=O=>{O.target.checked&&(e(l).lostQuantity=0,e(l).brokenQuantity=0)},B(2),a(d);var L=s(d,2),le=t(L),ye=t(le);Fe(ye),ye.__change=O=>{const Y=O.target;e(l).lostQuantity=Y.checked?1:0};var Pe=s(ye,2),we=t(Pe),Ye=t(we);La(Ye,{class:"h-3 w-3"}),B(),a(we),a(Pe),a(le);var Ze=s(le,2);{var da=O=>{var Y=Bt(),qe=t(Y),pe=s(t(qe),2);Fe(pe),a(qe),a(Y),A(()=>{pa(pe,"max",e(l).quantity-e(l).brokenQuantity),pe.disabled=e(g)}),Ke(pe,()=>e(l).lostQuantity,ea=>e(l).lostQuantity=ea),m(O,Y)};I(Ze,O=>{e(l).lostQuantity>0&&O(da)})}a(L);var Oe=s(L,2),$e=t(Oe),Ie=t($e);Fe(Ie),Ie.__change=O=>{const Y=O.target;e(l).brokenQuantity=Y.checked?1:0};var Be=s(Ie,2),Ue=t(Be),ya=t(Ue);ga(ya,{class:"h-3 w-3"}),B(),a(Ue),B(2),a(Be),a($e);var ca=s($e,2);{var va=O=>{var Y=Ut(),qe=t(Y),pe=s(t(qe),2);Fe(pe),a(qe),a(Y),A(()=>{pa(pe,"max",e(l).quantity-e(l).lostQuantity),pe.disabled=e(g)}),Ke(pe,()=>e(l).brokenQuantity,ea=>e(l).brokenQuantity=ea),m(O,Y)};I(ca,O=>{e(l).brokenQuantity>0&&O(va)})}a(Oe),a(i),a(p),A(()=>{w(fe,e(l).materielName),w(M,`Quantité empruntée : ${e(l).quantity??""}`),Da(c,e(l).lostQuantity===0&&e(l).brokenQuantity===0),c.disabled=e(g),Da(ye,e(l).lostQuantity>0),ye.disabled=e(g),Da(Ie,e(l).brokenQuantity>0),Ie.disabled=e(g)}),m(r,p)}),a(xe);var ee=s(xe,2);{var de=r=>{var l=Wt(),C=Ce(l),h=t(C);La(h,{class:"h-5 w-5"});var p=s(h,2),P=t(p),z=t(P);a(P);var X=s(P,2),ie=t(X);{var U=M=>{var i=Gt(),d=t(i);a(i),A(()=>w(d,`• ${e(_)??""} perdue${e(_)>1?"s":""} (déduit du stock)`)),m(M,i)};I(ie,M=>{e(_)>0&&M(U)})}var fe=s(ie,2);{var re=M=>{var i=Jt(),d=t(i);a(i),A(()=>w(d,`• ${e(x)??""} cassée${e(x)>1?"s":""} (à réparer)`)),m(M,i)};I(fe,M=>{e(x)>0&&M(re)})}a(X),a(p),a(C),B(),A(()=>w(z,`Attention : ${e(_)+e(x)} unité${e(_)+e(x)>1?"s":""} problématique${e(_)+e(x)>1?"s":""}`)),m(r,l)};I(ee,r=>{(e(_)>0||e(x)>0)&&r(de)})}var ae=s(ee,2),se=s(t(ae),2);Ua(se),a(ae),a(oe);var ce=s(oe,2),ve=t(ce),te=t(ve);te.__click=F;var y=t(te);Re(y,{class:"h-5 w-5"}),B(),a(te);var Q=s(te,2);Q.__click=Z;var K=t(Q);{var v=r=>{var l=Ht();m(r,l)},n=r=>{Na(r,{class:"h-5 w-5"})};I(K,r=>{e(g)?r(v):r(n,!1)})}B(),a(Q),a(ve),a(ce),a(D),a(E),A((r,l)=>{ze(E,1,`modal ${(o.isOpen&&"modal-open")??""}`),w(be,`Du ${r??""} au ${l??""}`),se.disabled=e(g),te.disabled=e(g),Q.disabled=!e(W)},[()=>new Date(o.loan.startDate).toLocaleDateString("fr-FR"),()=>new Date(o.loan.endDate).toLocaleDateString("fr-FR")]),Ke(se,()=>e(b),r=>u(b,r)),m(Le,E),ia()}oa(["click","change"]);var Yt=f('<button><!> <span class="badge badge-sm badge-neutral ml-2"> </span></button>'),Zt=f('<div class="tabs tabs-border bg-base-200 tabs-lg mb-6 font-medium"></div>'),$t=f('<div class="alert alert-warning"><span>Vous devez être connecté pour voir les emprunts.</span></div>'),er=f('<div class="alert alert-error shadow-lg"><span> </span></div>'),ar=f('<div class="alert alert-info"><span>Sélectionnez une équipe pour voir ses emprunts.</span></div>'),tr=f(`<div class="bg-base-200 rounded-box border-base-200 border-2 border-dashed py-20 text-center"><!> <h3 class="mb-2 text-lg font-bold">Aucune réservation</h3> <p class="text-base-content/60 mb-6">Cette équipe n'a pas encore d'emprunt.</p> <button class="btn btn-primary btn-sm">Créer une réservation</button></div>`),rr=f('<div class="space-y-4"><div class="mb-6 flex justify-end"><button class="btn btn-primary btn-wide flex gap-2"><!> Ajouter une reservation</button></div> <!></div>'),nr=f('<div class="container mx-auto p-4"><div class="mx-auto max-w-7xl px-4 py-8"><!> <!></div></div> <!> <!>',1);function br(Le,o){la(o,!0);let k=T(!1),b=T(null),g=T(!1),W=T(null),_=T(!1),x=T(null);function Z(){if(!e(b))return;if(!e(S).find(r=>r.$id===e(b))){ne.error("Équipe introuvable");return}u(x,null),u(k,!0)}function F(n){if(!e(b))return;if(!e(S).find(p=>p.$id===e(b))){ne.error("Équipe introuvable");return}const l=R.getLoanById(n);if(!l){ne.error("Emprunt introuvable");return}const C=new Date,h=new Date(l.endDate);if(C>h){ne.error("Impossible de modifier un emprunt dont la date est passée");return}u(x,n,!0),u(k,!0)}function $(){u(k,!1),u(x,null)}function E(){console.log("[LoansPage] Emprunt créé avec succès"),$()}function D(n){Qa(`/dashboard/loans/return/${n}`)}function H(){u(g,!1),u(W,null)}async function j(n){try{await R.acceptLoan(n),ne.success("Emprunt accepté avec succès")}catch(r){console.error("[LoansPage] Erreur acceptation emprunt:",r),ne.error("Erreur lors de l'acceptation de l'emprunt")}}async function ge(n){try{await R.cancelLoan(n),ne.success("Emprunt annulé avec succès")}catch(r){console.error("[LoansPage] Erreur annulation emprunt:",r),ne.error("Erreur lors de l'annulation de l'emprunt")}}async function be(n){try{await R.deleteLoan(n),ne.success("Emprunt supprimé avec succès")}catch(r){console.error("[LoansPage] Erreur suppression emprunt:",r),ne.error("Erreur lors de la suppression de l'emprunt")}}const S=q(()=>rt.myTeams),me=q(()=>e(b)?e(S).find(n=>n.$id===e(b)):null),oe=q(()=>{if(!e(b))return console.log("[LoansPage] teamLoans: pas d'activeTeamId"),[];const n=R.loans.filter(r=>r.ownerId===e(b));return console.log("[LoansPage] teamLoans filtrés:",{activeTeamId:e(b),totalLoans:R.loans.length,filteredCount:n.length,allLoans:R.loans.map(r=>({id:r.$id,ownerId:r.ownerId}))}),n});function xe(n){Qa(`/dashboard/loans/${n}`)}Xe(()=>{const n=et.params.teamId;if(n&&n!==e(b)){console.log("[LoansPage] teamIdFromParams:",n);const r=e(S).find(l=>l.$id===n);console.log("[LoansPage] équipe trouvée:",r),r&&(console.log("[LoansPage] Mise à jour activeTeamId:",n),u(b,n,!0))}else!n&&!e(b)&&!e(_)&&e(S).length>0&&(console.log("[LoansPage] Redirection vers première équipe:",e(S)[0].$id),u(_,!0),Qa(`/dashboard/loans/${e(S)[0].$id}`))}),Xe(()=>{const r=(e(b)?e(S).find(l=>l.$id===e(b)):null)?.name||"Emprunts";Ea.setConfig({title:r})}),at(()=>{Ea.reset()});var he=nr(),ee=Ce(he),de=t(ee),ae=t(de);{var se=n=>{var r=Zt();Ee(r,21,()=>e(S),l=>l.$id,(l,C)=>{const h=q(()=>R.loans.filter(U=>U.ownerId===e(C).$id).length);var p=Yt();p.__click=()=>xe(e(C).$id);var P=t(p);Oa(P,{class:"mr-2 h-4 w-4"});var z=s(P),X=s(z),ie=t(X,!0);a(X),a(p),A(()=>{ze(p,1,`tab ${e(b)===e(C).$id?"tab-active":""}`),w(z,` ${e(C).name??""} `),w(ie,e(h))}),m(l,p)}),a(r),m(n,r)};I(ae,n=>{e(S).length>1&&n(se)})}var ce=s(ae,2);{var ve=n=>{var r=$t();m(n,r)},te=n=>{var r=ma(),l=Ce(r);{var C=p=>{var P=er(),z=t(P),X=t(z,!0);a(z),a(P),A(()=>w(X,R.error)),m(p,P)},h=p=>{var P=ma(),z=Ce(P);{var X=U=>{var fe=ar();m(U,fe)},ie=U=>{var fe=ma(),re=Ce(fe);{var M=d=>{var c=tr(),L=t(c);Oa(L,{class:"mx-auto mb-4 h-12 w-12  text-center opacity-50"});var le=s(L,6);le.__click=Z,a(c),m(d,c)},i=d=>{var c=rr(),L=t(c),le=t(L);le.__click=Z;var ye=t(le);bt(ye,{size:16}),B(),a(le),a(L);var Pe=s(L,2);Ee(Pe,17,()=>e(oe),we=>we.$id,(we,Ye)=>{Ot(we,{get loan(){return e(Ye)},onReturn:D,onAccept:j,onCancel:ge,onDelete:be,onEdit:F})}),a(c),m(d,c)};I(re,d=>{e(oe).length===0?d(M):d(i,!1)})}m(U,fe)};I(z,U=>{e(b)?U(ie,!1):U(X)},!0)}m(p,P)};I(l,p=>{R.error?p(C):p(h,!1)},!0)}m(n,r)};I(ce,n=>{He.isAuthenticated?n(te,!1):n(ve)})}a(de),a(ee);var y=s(ee,2);{var Q=n=>{{let r=q(()=>e(x)??void 0);Nt(n,{get isOpen(){return e(k)},onClose:$,onSuccess:E,get ownerId(){return e(me).$id},get ownerName(){return e(me).name},get loanId(){return e(r)}})}};I(y,n=>{e(me)&&n(Q)})}var K=s(y,2);{var v=n=>{Xt(n,{get loan(){return e(W)},get isOpen(){return e(g)},onClose:H})};I(K,n=>{e(g)&&e(W)&&n(v)})}tt(3,ee,()=>nt),m(Le,he),ia()}oa(["click"]);export{br as default};
