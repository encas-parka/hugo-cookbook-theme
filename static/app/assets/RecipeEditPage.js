import{B as oe,d as ke,m as e,u as b,O as m,E as k,z as Ee,J as E,y as _,I as d,N as W,A as i,Y as Se,v as A,k as re,K as S,h as p,g as l,P as Le,b as y,c as Be,w as te,x as ae,D as $e,au as De,av as Ve,ay as qe,ax as ze,j as Ce,G as se,o as v}from"./appwrite.js";import{r as j}from"./RecipeDataStore.svelte.js";import{n as ie,a as He}from"./index.js";import{t as Te,a as K,v as Me,e as Ue,n as We,p as Pe,f as Fe,R as Ge,b as Oe,d as je}from"./RecipeEditPage2.js";import"./AutocompleteInput.js";import{C as Ke}from"./ConfirmModal.js";import{U as Je}from"./UnsavedChangesGuard.js";import{R as Ne,a as Ye}from"./RecipeMetadata.js";import{z as Ze,a4 as Qe,b as Xe,ai as er}from"./icons.js";import"./products-display.js";import"./tiptap-markdown.es.js";import"./Fieldset.js";import"./BtnGroupCheck.js";import"./CheckboxBadge.js";import"./keyboardNavigation.svelte.js";oe(["click"]);var rr=A('<div class="flex items-center gap-2"><button class="btn btn-secondary btn-soft btn-sm"><!> CrÃ©er une version alternative</button> <button class="btn btn-accent btn-sm"><!> </button></div>'),tr=A('<div class="flex items-center justify-center py-20"><div class="loading loading-spinner loading-lg"></div></div>'),ar=A('<div class="mt-8 print:hidden"><!></div>'),sr=A(`<div class="alert alert-error alert-soft border-error max-md:alert-vertical mt-8 border"><!> <div class="flex-1"><h4 class="font-bold">Zone de danger</h4> <p class="text-sm">La suppression d'une recette est irrÃ©versible. Si elle Ã©tait
              utilisÃ© dans des Ã©vÃ©nements, ceux-ci n'y auront plus accÃ¨s. Vous
              Ãªtes seulÂ·e autorisÃ© Ã  supprimer une recettes que vous avez crÃ©e.
              Les versions alternatives crÃ©es Ã  partir de celle-ci ne seront pas
              supprimÃ©e.</p></div> <button class="btn btn-error btn-sm"> </button></div>`),ir=A('<div class="space-y-6"><!> <!> <!> <!> <!> <!></div>'),or=A(`<div class="bg-base-100 rounded-t-box fixed bottom-0 left-0"><div class=" bg-warning/40 rounded-t-box flex size-full items-center px-4 py-1"><!> VÃ©rouillÃ© : document en cours d'Ã©dition par unÂ·e autre utilisateurÂ·ice.</div></div>`),nr=A('<div class="max-w-9xl container mx-auto px-4 py-8"><!></div> <!> <!> <!>',1);function xr(ne,ce){ke(ce,!0);const ue=t=>{var a=rr(),o=p(a);o.__click=ve;var g=p(o);Ze(g,{class:"h-4 w-4"}),se(),v(o);var c=l(o,2);c.__click=J;var u=p(c);Qe(u,{class:"h-4 w-4"});var R=l(u);v(c),v(a),te(()=>{o.disabled=!e(I)||e(h),c.disabled=!e(I)||e(h)||!e(q),ae(R,` ${e(h)?"Sauvegarde...":"Sauvegarder"}`)}),y(t,a)},s=b(()=>$e.params.uuid);if(!e(s))throw m.error("ID de recette manquant"),k("/recipe"),new Error("recipeId is required");let r=_(null),L=_(!1),x=_(!0),h=_(!1),w=_(null),$=null,B=_(null),D=_(!1),V=_(!1),P=Ee({value:{}});const q=b(()=>!e(r)||!e(B)?!1:K(e(r))!==e(B));E(()=>{e(r)&&e(r).check!==!0&&(e(r).draft=!0)});const F=b(()=>!!e(w)&&e(w)!==d.userId),z=b(()=>!!e(w)&&e(w)===d.userId),I=b(()=>!e(F)&&!e(x)),de=b(()=>({materiel:j.materiel,categories:j.categories,regimes:j.regimes}));E(()=>{if(!d.userId){m.error("Vous devez Ãªtre connectÃ©"),k("/");return}}),E(()=>{e(s)&&!e(L)&&!e(x)||e(s)&&e(L)||e(s)&&!e(L)&&e(x)&&W.getRecipeByUuid(e(s)).then(async t=>{t?(i(r,Te(t,{$createdAt:t.$createdAt,$updatedAt:t.$updatedAt,createdBy:t.createdBy}),!0),i(w,t.lockedBy||null,!0),i(L,!0),i(x,!1),await pe()):(m.error("Recette introuvable"),k("/recipe"))}).catch(t=>{console.error("Erreur chargement:",t),m.error("Erreur lors du chargement"),k("/recipe")}).finally(()=>{i(x,!1)})}),E(()=>{e(r)&&e(L)&&!e(B)&&i(B,K(e(r)),!0)}),E(()=>{ie.setConfig({title:e(r)?.title||"Ã‰dition de recette",actions:ue})}),Se(async()=>{ie.reset(),O(),e(z)&&!e(h)&&await C(),window.removeEventListener("beforeunload",G)});function G(t){e(q)&&(t.preventDefault(),t.returnValue="")}E(()=>{e(q)?window.addEventListener("beforeunload",G):window.removeEventListener("beforeunload",G)});function le(){O(),!(!e(s)||!e(z))&&($=setInterval(async()=>{try{console.log("ğŸ’“ Heartbeat: Refreshing lock..."),await W.updateRecipeLock(e(s),d.userId)}catch(t){console.error("âŒ Heartbeat failed:",t)}},12e4))}function O(){$&&(clearInterval($),$=null)}async function pe(){if(!e(s)||!d.userId||!e(r))return!1;if((e(r).permissionWrite||[]).length<=1)return console.log("â„¹ï¸ Verrou ignorÃ© (contributeur unique)"),!0;try{const a=e(r).lockedBy,o=e(r).$updatedAt?new Date(e(r).$updatedAt):null,g=o&&Date.now()-o.getTime()>3e5;if(a&&a!==d.userId)if(g)console.log("â³ Verrou prÃ©cÃ©dent expirÃ©, reprise de contrÃ´le...");else return!1;return await W.updateRecipeLock(e(s),d.userId),i(w,d.userId,!0),console.log("ğŸ”’ Verrou acquis"),le(),!0}catch(a){return console.error("âŒ Erreur acquisition verrou:",a),m.error("Impossible de verrouiller la recette"),!1}}async function C(){if(e(s)){O();try{await W.updateRecipeLock(e(s),null),i(w,null),console.log("ğŸ”“ Verrou libÃ©rÃ©")}catch(t){console.error("âŒ Erreur libÃ©ration verrou:",t)}}}async function J(){if(!e(r)||e(h)||!d.userId||!Me(e(r),P))return;i(h,!0);const a=m.loading("Sauvegarde en cours...");try{const{regimes:o}=Ue(e(r).ingredients),c={...We(e(r)),categories:e(r).categories,regime:o,saison:e(r).saison,ingredients:Ve(e(r).ingredients),quantite_desc:e(r).quantite_desc,auteur:e(r).auteur,preparation24h:e(r).preparation24h,astuces:De(e(r).astuces),prepAlt:e(r).prepAlt,$id:e(r).$id},u=await qe(e(s),c,d.userId);i(B,K(e(r)),!0);const R=Pe(e(r),c,{id:u.$id,createdAt:u.$createdAt,updatedAt:u.$updatedAt,createdBy:u.createdBy});ze("save_recipe",e(s),d.userId,R,!0).catch(T=>{console.error("Sync vers GitHub Ã©chouÃ©e:",T)}),m.update(a,{state:"success",message:"Recette sauvegardÃ©e !"}),await C()}catch(o){console.error("Erreur sauvegarde:",o),m.update(a,{state:"error",message:"Erreur lors de la sauvegarde"})}finally{i(h,!1),setTimeout(()=>m.dismiss(a),3e3)}}function ve(){e(r)&&k(`/recipe/${e(s)}/duplicate`)}function fe(){i(D,!0)}async function me(){if(e(s)){i(V,!0);try{await Fe(e(s),async()=>{e(z)&&await C()}),setTimeout(()=>{k("/recipe")},1500)}catch(t){console.error("Erreur lors de la suppression:",t)}finally{i(V,!1),i(D,!1)}}}var N=nr(),H=re(N),ge=p(H);{var be=t=>{var a=tr();y(t,a)},_e=t=>{var a=Ce(),o=re(a);{var g=c=>{var u=ir(),R=p(u);Ge(R,{get recipeInfo(){return e(de)},get validationErrors(){return P.value},get canEdit(){return e(I)},get recipe(){return e(r)},set recipe(n){i(r,n,!0)}});var T=l(R,2);Oe(T,{get validationErrors(){return P.value},get canEdit(){return e(I)},get recipe(){return e(r)},set recipe(n){i(r,n,!0)}});var Q=l(T,2);je(Q,{get createdBy(){return e(r).createdBy},get canEdit(){return e(I)},get permissionWrite(){return e(r).permissionWrite},set permissionWrite(n){e(r).permissionWrite=n}});var X=l(Q,2);{var we=n=>{{let f=b(()=>e(r).$id??"");Ne(n,{get auteur(){return e(r).auteur},get createdBy(){return e(r).createdBy},get id(){return e(f)},get createdAt(){return e(r).$createdAt},get updatedAt(){return e(r).$updatedAt}})}};S(X,n=>{e(r).$createdAt&&n(we)})}var ee=l(X,2);{var Ae=n=>{var f=ar(),M=p(f);Ye(M,{get recipeId(){return e(s)}}),v(f),y(n,f)};S(ee,n=>{e(s)&&n(Ae)})}var xe=l(ee,2);{var Ie=n=>{var f=sr(),M=p(f);er(M,{class:"h-5 w-5 shrink-0"});var U=l(M,4);U.__click=fe;var Re=p(U,!0);v(U),v(f),te(()=>{U.disabled=e(V),ae(Re,e(V)?"Suppression...":"Supprimer la recette")}),y(n,f)};S(xe,n=>{e(I)&&n(Ie)})}v(u),y(c,u)};S(o,c=>{e(r)&&c(g)},!0)}y(t,a)};S(ge,t=>{e(x)?t(be):t(_e,!1)})}v(H);var Y=l(H,2);{var ye=t=>{var a=or(),o=p(a),g=p(o);Xe(g,{class:"me-2 h-4 w-4"}),se(),v(o),v(a),y(t,a)};S(Y,t=>{e(F)&&t(ye)})}var Z=l(Y,2);{let t=b(()=>`/recipe/${e(s)}/edit`);Je(Z,{get routeKey(){return e(t)},shouldProtect:()=>e(q)&&!e(F),onLeaveWithoutSave:async()=>{e(z)&&await C()},onSaveAndLeave:async()=>{await J()},message:"Vous avez des modifications non sauvegardÃ©es. Voulez-vous vraiment quitter ?"})}var he=l(Z,2);Ke(he,{get isOpen(){return e(D)},title:"Supprimer cette recette ?",message:"Cette action est irrÃ©versible, Ãªtes vous sur de vouloir supprimer cette recette ?",variant:"danger",confirmLabel:"Supprimer",cancelLabel:"Annuler",onConfirm:me,onCancel:()=>i(D,!1)}),Le(3,H,()=>He),y(ne,N),Be()}oe(["click"]);export{xr as default};
