import{d as nt,y as U,z as ot,J as lt,m as a,u as oa,O as ba,E as qa,a0 as la,A as h,v,k as ta,h as r,g as o,K as c,P as it,b as l,c as vt,D as ut,w as y,x as M,e as dt,i as ct,j as Ia,T as pa,U as _t,B as bt,o as e,G as ia,n as pt,ab as ft,ao as yt,C as va,ag as gt,ar as mt,W as Da,M as ea}from"./appwrite.js";import{a as kt}from"./index.js";import{a as Ma}from"./date-helpers.js";import{H as xt,ab as Pa,aj as Qt,a5 as ht,a6 as wt,r as qt,a7 as It,k as Dt,a8 as Mt,a9 as Rt,T as Ra,X as Ba,G as Na}from"./icons.js";var Bt=v('<p class="text-sm opacity-70"> </p>'),Nt=v('<div class="badge badge-info">Mode lecture seule</div>'),Lt=v('<div class="alert alert-info max-md:alert-vertical mb-4"><!> <div><div class="font-bold">Retour enregistré</div> <div class="text-sm"> </div></div></div>'),Tt=v("<div><!></div>"),Et=v('<div class="badge badge-warning gap-2"><!> </div>'),At=v('<div class="badge badge-error gap-2"><!> </div>'),Ct=v('<div class="badge badge-success gap-2"><!> </div>'),Pt=v('<div class="flex items-center gap-6 p-2"><!> <!> <!></div>'),St=v('<div class="ms-auto flex flex-wrap items-center justify-end gap-6 p-2"><button type="button" aria-label="À réparer"><!> à réparer</button> <button type="button" aria-label="Perdu"><!> perdu</button> <button type="button" aria-label="Tout OK"><!></button></div>'),zt=v('<div class="badge badge-warning gap-2"><!> </div>'),jt=v('<div class="badge badge-error gap-2"><!> </div>'),Ot=v('<div class="badge badge-success gap-2"><!> </div>'),Vt=v('<div class="ms-auto flex flex-wrap justify-end gap-4"><!> <!> <!></div>'),Ft=v('<div class="min-w-[100px]"><label class="input w-full"><span class="label-text">ok</span> <input type="number"/></label></div>'),Kt=v('<button aria-label="Marquer comme ok">tout est ok</button>'),Wt=v('<div class="flex flex-wrap gap-4"><div class="min-w-[140px]"><label class="input"><span class="label-text">À réparer</span> <input type="number" class="  input-sm w-full" aria-label="Marquer comme à réparer"/></label></div> <div class="min-w-[140px]"><label class="input w-full"><span class="label-text">Perdus</span> <input type="number"/></label></div> <!></div>'),Gt=v('<div class="bg-base-200 rounded-box flex flex-wrap items-center justify-between px-4 py-1"><div class="flex items-center gap-4"><!> <div class="text-base font-medium"> </div> <div class="font-semibold opacity-70"> </div></div> <!></div>'),Ut=v('<div class="alert"><p class="whitespace-pre-wrap"> </p></div>'),Ht=v('<p class="text-sm italic opacity-50">Aucune note</p>'),Jt=v(`<textarea class="textarea textarea-bordered w-full" rows="2" placeholder="Remarques sur l'état du matériel, problèmes constatés..." maxlength="500"></textarea>`),Xt=v('<div class="text-error label"><span> </span></div>'),Zt=v('<span class="loading loading-spinner loading-sm"></span>'),Yt=v('<button class="btn btn-ghost">"Annuler"</button> <button class="btn btn-primary gap-2"><!> Valider le retour</button>',1),$t=v('<div class="card bg-base-100 mb-6 shadow-sm"><div class="card-body"><!> <h2 class="card-title mb-4"><!> Matériels empruntés</h2> <div class="space-y-4"></div> <fieldset class="fieldset bg-base-100 mt-6"><legend class="fieldset-legend">Notes de retour (optionnel)</legend> <!></fieldset></div> <!></div> <div class="flex justify-end gap-2"><!></div>',1),ae=v(`<div class="alert alert-warning"><span>Chargement de l'emprunt...</span></div>`),te=v('<span class="loading loading-spinner loading-sm"></span>'),ee=v(`<div class="modal modal-open"><div class="modal-box"><p class="py-4"> <strong> </strong>.
        Vous êtes en train d'effectuer le retour avant cette date.</p> <p class="pb-4">Vous confirmez ce retour anticipé ?</p> <div class="modal-action"><button class="btn btn-ghost">Annuler</button> <button class="btn btn-warning"><!></button></div></div> <div class="modal-backdrop" role="button" tabindex="0" aria-label="Fermer le modal"></div></div>`),re=v('<div class="container mx-auto p-4"><div class="mx-auto max-w-4xl"><div class="mb-6 flex items-center gap-4"><button class="btn btn-circle btn-ghost" aria-label="Retour"><!></button> <div class="flex-1"><h1 class="text-2xl font-bold">Fiche de retour</h1> <!></div> <!></div> <!></div></div> <!>',1);function ie(Sa,za){nt(za,!0);const z=oa(()=>ut.params.loanId);let T=U(!1),j=U(!1),H=U(!1),J=U(""),fa=U(null),X=U(ot([])),ya=U("");const O=oa(()=>a(z)?la.getLoanById(a(z)):null);function ja(s){switch(s){case"electronic":return Rt;case"manual":return Mt;case"cooking":return Dt;case"dish":return It;case"gaz":return qt;case"hygiene":return wt;default:return ht}}lt(()=>{if(!a(z)){ba.error("Emprunt non trouvé"),qa("/dashboard/loans");return}const s=la.getLoanById(a(z));if(!s||s.status!=="accepted"&&s.status!=="completed"){ba.error("Emprunt non valide"),qa("/dashboard/loans");return}s.status==="completed"?(h(j,!0),h(fa,s.returnedAt?new Date(s.returnedAt).toLocaleDateString("fr-FR"):null,!0),h(J,s.returnNotes||"",!0),h(X,s.materielItems.map(n=>{const g=n.lostQuantity||0,k=n.brokenQuantity||0,A=n.quantity-g-k,Y=la.getMaterielById(n.materielId);return{materielId:n.materielId,materielName:n.materielName,materielType:Y?.type||null,quantity:n.quantity,lostQuantity:g,brokenQuantity:k,okQuantity:A,state:g>0||k>0?"issues":"ok"}}),!0)):h(X,s.materielItems.map(n=>{const g=la.getMaterielById(n.materielId);return{materielId:n.materielId,materielName:n.materielName,materielType:g?.type||null,quantity:n.quantity,lostQuantity:0,brokenQuantity:0,okQuantity:n.quantity,state:"pending"}}),!0)});function Z(s){const n=a(X)[s],g=n.lostQuantity,k=n.brokenQuantity;n.okQuantity=n.quantity-g-k,(n.lostQuantity>0||n.brokenQuantity>0)&&(n.state="issues")}const La=oa(()=>{for(const s of a(X)){if(s.lostQuantity+s.brokenQuantity+s.okQuantity!==s.quantity)return h(ya,"erreur, veuillez vérifez le formulaire "),!1;if(s.state==="pending")return!1}return!0});function ga(){qa("/dashboard/loans")}function Oa(){if(!a(z)||!a(La)||a(T))return;const s=new Date,n=new Date(a(O)?.endDate||"");s<n?h(H,!0):Ta()}async function Ta(){if(a(z)){h(H,!1),h(T,!0);try{const s=a(X).map(n=>({materielId:n.materielId,materielName:n.materielName,quantity:n.quantity,lostQuantity:n.lostQuantity,brokenQuantity:n.brokenQuantity}));await la.completeLoanWithReturn(String(a(z)),{materiels:s,returnNotes:a(J).trim()||void 0}),ba.success("Retour enregistré avec succès"),ga()}catch(s){console.error("[LoanReturnPage] Erreur enregistrement retour:",s),ba.error("Erreur lors de l'enregistrement du retour")}finally{h(T,!1)}}}var Ea=re(),ua=ta(Ea),Aa=r(ua),ma=r(Aa),da=r(ma);da.__click=ga;var Va=r(da);xt(Va,{class:"h-5 w-5"}),e(da);var ka=o(da,2),Fa=o(r(ka),2);{var Ka=s=>{var n=Bt(),g=r(n);e(n),y((k,A)=>M(g,`Emprunt du ${k??""} au 
            ${A??""}`),[()=>Ma(a(O).startDate),()=>Ma(a(O).endDate)]),l(s,n)};c(Fa,s=>{a(O)&&s(Ka)})}e(ka);var Wa=o(ka,2);{var Ga=s=>{var n=Nt();l(s,n)};c(Wa,s=>{a(j)&&s(Ga)})}e(ma);var Ua=o(ma,2);{var Ha=s=>{var n=$t(),g=ta(n),k=r(g),A=r(k);{var Y=_=>{var t=Lt(),b=r(t);Pa(b,{class:"h-5 w-5"});var x=o(b,2),E=o(r(x),2),q=r(E);e(E),e(x),e(t),y(()=>M(q,`Le ${a(fa)??""}`)),l(_,t)};c(A,_=>{a(j)&&a(fa)&&_(Y)})}var ra=o(A,2),ca=r(ra);Pa(ca,{class:"h-5 w-5"}),ia(),e(ra);var V=o(ra,2);dt(V,21,()=>a(X),ct,(_,t,b)=>{var x=Gt(),E=r(x);{const P=(K,W=pt)=>{const sa=oa(()=>ja(W()));var S=Tt(),Q=r(S);{let p=oa(()=>mt(W()));ft(Q,()=>a(sa),(m,N)=>{N(m,{get class(){return`${a(p)??""} size-5`}})})}e(S),y(p=>va(S,1,`${p??""} rounded-lg p-2`),[()=>yt(W())]),l(K,S)};var q=r(E);P(q,()=>a(t).materielType);var R=o(q,2),B=r(R,!0);e(R);var aa=o(R,2),at=r(aa);e(aa),e(E),y(()=>{M(B,a(t).materielName),M(at,`(${a(t).quantity??""})`)})}var tt=o(E,2);{var et=P=>{var K=Ia(),W=ta(K);{var sa=Q=>{var p=Pt(),m=r(p);{var N=i=>{var u=Et(),f=r(u);Ra(f,{class:"h-4 w-4"});var d=o(f);e(u),y(()=>M(d,` À réparer : ${a(t).brokenQuantity??""}`)),l(i,u)};c(m,i=>{a(t).brokenQuantity>0&&i(N)})}var I=o(m,2);{var D=i=>{var u=At(),f=r(u);Ba(f,{class:"h-4 w-4"});var d=o(f);e(u),y(()=>M(d,` Perdu : ${a(t).lostQuantity??""}`)),l(i,u)};c(I,i=>{a(t).lostQuantity>0&&i(D)})}var C=o(I,2);{var L=i=>{var u=Ct(),f=r(u);Na(f,{class:"h-4 w-4"});var d=o(f);e(u),y(()=>M(d,` OK : ${a(t).okQuantity??""}`)),l(i,u)};c(C,i=>{a(t).okQuantity>0&&i(L)})}e(p),l(Q,p)},S=Q=>{var p=St(),m=r(p);let N;m.__click=()=>{a(t).state="issues",a(t).lostQuantity=0,a(t).brokenQuantity=1,Z(b)};var I=r(m);Ra(I,{class:"h-4 w-4"}),ia(),e(m);var D=o(m,2);let C;D.__click=()=>{a(t).state="issues",a(t).lostQuantity=1,a(t).brokenQuantity=0,Z(b)};var L=r(D);Ba(L,{class:"h-4 w-4"}),ia(),e(D);var i=o(D,2);i.__click=()=>{a(t).state="ok",a(t).lostQuantity=0,a(t).brokenQuantity=0,Z(b)};var u=r(i);Na(u,{class:""}),e(i),e(p),y(()=>{N=va(m,1,`btn btn-sm btn-warning ${a(t).brokenQuantity===0&&"btn-outline"}`,null,N,{"ring-2":a(t).brokenQuantity>0,"ring-warning":a(t).brokenQuantity>0}),C=va(D,1,`btn btn-error btn-sm ${a(t).lostQuantity===0&&"btn-outline"}`,null,C,{"ring-2":a(t).lostQuantity>0,"ring-error":a(t).lostQuantity>0}),va(i,1,`btn btn-circle btn-sm btn-success ${a(t).state!=="ok"&&"btn-outline"}`)}),l(Q,p)};c(W,Q=>{a(j)?Q(sa):Q(S,!1)})}l(P,K)},rt=P=>{var K=Ia(),W=ta(K);{var sa=Q=>{var p=Vt(),m=r(p);{var N=i=>{var u=zt(),f=r(u);Ra(f,{class:"h-4 w-4"});var d=o(f);e(u),y(()=>M(d,` À réparer : ${a(t).brokenQuantity??""}`)),l(i,u)};c(m,i=>{a(t).brokenQuantity>0&&i(N)})}var I=o(m,2);{var D=i=>{var u=jt(),f=r(u);Ba(f,{class:"h-4 w-4"});var d=o(f);e(u),y(()=>M(d,` Perdus : ${a(t).lostQuantity??""}`)),l(i,u)};c(I,i=>{a(t).lostQuantity>0&&i(D)})}var C=o(I,2);{var L=i=>{var u=Ot(),f=r(u);Na(f,{class:"h-4 w-4"});var d=o(f);e(u),y(()=>M(d,` OK : ${a(t).okQuantity??""}`)),l(i,u)};c(C,i=>{a(t).okQuantity>0&&i(L)})}e(p),l(Q,p)},S=Q=>{var p=Wt(),m=r(p),N=r(m),I=o(r(N),2);Da(I),ea(I,"min",0),I.__change=()=>Z(b),e(N),e(m);var D=o(m,2),C=r(D),L=o(r(C),2);Da(L),ea(L,"min",0),L.__change=()=>Z(b),e(C),e(D);var i=o(D,2);{var u=d=>{var G=Ft(),Ca=r(G),na=o(r(Ca),2);Da(na),ea(na,"min",0),na.__change=()=>{const wa=a(t).lostQuantity,st=a(t).brokenQuantity;a(t).state="issues",a(t).okQuantity=Math.min(a(t).quantity-wa-st,a(t).okQuantity)},e(Ca),e(G),y(()=>ea(na,"max",a(t).quantity)),pa(na,()=>a(t).okQuantity,wa=>a(t).okQuantity=wa),l(d,G)},f=d=>{var G=Kt();G.__click=()=>{a(t).state="ok",a(t).lostQuantity=0,a(t).brokenQuantity=0,Z(b)},y(()=>va(G,1,`btn btn-success ${a(t).state!=="ok"&&"btn-outline"}`)),l(d,G)};c(i,d=>{a(t).lostQuantity>0||a(t).brokenQuantity>0?d(u):d(f,!1)})}e(p),y(()=>{ea(I,"max",a(t).quantity),ea(L,"max",a(t).quantity)}),pa(I,()=>a(t).brokenQuantity,d=>a(t).brokenQuantity=d),pa(L,()=>a(t).lostQuantity,d=>a(t).lostQuantity=d),l(Q,p)};c(W,Q=>{a(j)?Q(sa):Q(S,!1)})}l(P,K)};c(tt,P=>{a(t).quantity===1?P(et):P(rt,!1)})}e(x),l(_,x)}),e(V);var F=o(V,2),xa=o(r(F),2);{var Qa=_=>{var t=Ia(),b=ta(t);{var x=q=>{var R=Ut(),B=r(R),aa=r(B,!0);e(B),e(R),y(()=>M(aa,a(J))),l(q,R)},E=q=>{var R=Ht();l(q,R)};c(b,q=>{a(J)?q(x):q(E,!1)})}l(_,t)},ha=_=>{var t=Jt();gt(t),y(()=>t.disabled=a(T)),pa(t,()=>a(J),b=>h(J,b)),l(_,t)};c(xa,_=>{a(j)?_(Qa):_(ha,!1)})}e(F),e(k);var _a=o(k,2);{var w=_=>{var t=Xt(),b=r(t),x=r(b,!0);e(b),e(t),y(()=>M(x,a(ya))),l(_,t)};c(_a,_=>{a(ya)&&_(w)})}e(g);var $=o(g,2),Ya=r($);{var $a=_=>{var t=Yt(),b=ta(t);b.__click=ga;var x=o(b,2);x.__click=Oa;var E=r(x);{var q=B=>{var aa=Zt();l(B,aa)},R=B=>{Qt(B,{class:"h-4 w-4"})};c(E,B=>{a(T)?B(q):B(R,!1)})}ia(),e(x),y(()=>{b.disabled=a(T),x.disabled=!a(La)||a(T)}),l(_,t)};c(Ya,_=>{a(j)||_($a)})}e($),l(s,n)},Ja=s=>{var n=ae();l(s,n)};c(Ua,s=>{a(O)?s(Ha):s(Ja,!1)})}e(Aa),e(ua);var Xa=o(ua,2);{var Za=s=>{var n=ee(),g=r(n),k=r(g),A=r(k);A.nodeValue="Bizarre ! La date de fin de l'emprunt est prévue pour le  ";var Y=o(A),ra=r(Y,!0);e(Y),ia(),e(k);var ca=o(k,4),V=r(ca);V.__click=()=>h(H,!1);var F=o(V,2);F.__click=Ta;var xa=r(F);{var Qa=w=>{var $=te();l(w,$)},ha=w=>{var $=_t("Confirmer le retour");l(w,$)};c(xa,w=>{a(T)?w(Qa):w(ha,!1)})}e(F),e(ca),e(g);var _a=o(g,2);_a.__click=()=>h(H,!1),_a.__keydown=w=>{(w.key==="Enter"||w.key==="Escape")&&h(H,!1)},e(n),y(w=>{M(ra,w),V.disabled=a(T),F.disabled=a(T)},[()=>a(O)?Ma(a(O).endDate):""]),l(s,n)};c(Xa,s=>{a(H)&&s(Za)})}it(3,ua,()=>kt),l(Sa,Ea),vt()}bt(["click","change","keydown"]);export{ie as default};
