import{d as nt,y as U,z as ot,J as lt,m as a,u as oa,O as _a,E as qa,$ as la,A as I,v,k as aa,h as r,g as o,K as c,P as it,b as l,c as vt,D as ut,w as y,x as D,e as dt,i as ct,j as Ia,T as ba,U as _t,B as bt,o as e,G as ia,n as pt,aa as ft,an as yt,C as va,ae as gt,aq as mt,W as Da,M as ta}from"./appwrite.js";import{f as kt}from"./index.js";import{a as Ma}from"./date-helpers.js";import{H as xt,ab as Sa,al as Qt,a5 as ht,a6 as wt,r as qt,a7 as It,k as Dt,a8 as Mt,a9 as Rt,T as Ra,X as Ba,G as Na}from"./icons.js";var Bt=v('<p class="text-sm opacity-70"> </p>'),Nt=v('<div class="badge badge-info">Mode lecture seule</div>'),Lt=v('<div class="alert alert-info max-md:alert-vertical mb-4"><!> <div><div class="font-bold">Retour enregistré</div> <div class="text-sm"> </div></div></div>'),Tt=v("<div><!></div>"),At=v('<div class="badge badge-warning gap-2"><!> </div>'),Ct=v('<div class="badge badge-error gap-2"><!> </div>'),Pt=v('<div class="badge badge-success gap-2"><!> </div>'),St=v('<div class="flex items-center gap-6 p-2"><!> <!> <!></div>'),zt=v('<div class="ms-auto flex flex-wrap items-center justify-end gap-6 p-2"><button type="button" aria-label="À réparer"><!> à réparer</button> <button type="button" aria-label="Perdu"><!> perdu</button> <button type="button" aria-label="Tout OK"><!></button></div>'),Et=v('<div class="badge badge-warning gap-2"><!> </div>'),jt=v('<div class="badge badge-error gap-2"><!> </div>'),Ot=v('<div class="badge badge-success gap-2"><!> </div>'),Vt=v('<div class="ms-auto flex flex-wrap justify-end gap-4"><!> <!> <!></div>'),Kt=v('<div class="min-w-[100px]"><label class="input w-full"><span class="label-text">ok</span> <input type="number"/></label></div>'),Ft=v('<button aria-label="Marquer comme ok">tout est ok</button>'),Wt=v('<div class="flex flex-wrap gap-4"><div class="min-w-[140px]"><label class="input"><span class="label-text">À réparer</span> <input type="number" class="  input-sm w-full" aria-label="Marquer comme à réparer"/></label></div> <div class="min-w-[140px]"><label class="input w-full"><span class="label-text">Perdus</span> <input type="number"/></label></div> <!></div>'),Gt=v('<div class="bg-base-200 rounded-box flex flex-wrap items-center justify-between px-4 py-1"><div class="flex items-center gap-4"><!> <div class="text-base font-medium"> </div> <div class="font-semibold opacity-70"> </div></div> <!></div>'),Ut=v('<div class="alert"><p class="whitespace-pre-wrap"> </p></div>'),Ht=v('<p class="text-sm italic opacity-50">Aucune note</p>'),Jt=v(`<textarea class="textarea textarea-bordered w-full" rows="2" placeholder="Remarques sur l'état du matériel, problèmes constatés..." maxlength="500"></textarea>`),Xt=v('<div class="text-error label"><span> </span></div>'),Zt=v('<span class="loading loading-spinner loading-sm"></span>'),Yt=v('<button class="btn btn-ghost">"Annuler"</button> <button class="btn btn-primary gap-2"><!> Valider le retour</button>',1),$t=v('<div class="card bg-base-100 mb-6 shadow-sm"><div class="card-body"><!> <h2 class="card-title mb-4"><!> Matériels empruntés</h2> <div class="space-y-4"></div> <fieldset class="fieldset bg-base-100 mt-6"><legend class="fieldset-legend">Notes de retour (optionnel)</legend> <!></fieldset></div> <!></div> <div class="flex justify-end gap-2"><!></div>',1),ae=v(`<div class="alert alert-warning"><span>Chargement de l'emprunt...</span></div>`),te=v('<span class="loading loading-spinner loading-sm"></span>'),ee=v(`<div class="modal modal-open"><div class="modal-box"><p class="py-4"> <strong> </strong>.
        Vous êtes en train d'effectuer le retour avant cette date.</p> <p class="pb-4">Vous confirmez ce retour anticipé ?</p> <div class="modal-action"><button class="btn btn-ghost">Annuler</button> <button class="btn btn-warning"><!></button></div></div> <div class="modal-backdrop"></div></div>`),re=v('<div class="container mx-auto p-4"><div class="mx-auto max-w-4xl"><div class="mb-6 flex items-center gap-4"><button class="btn btn-circle btn-ghost" aria-label="Retour"><!></button> <div class="flex-1"><h1 class="text-2xl font-bold">Fiche de retour</h1> <!></div> <!></div> <!></div></div> <!>',1);function ie(za,Ea){nt(Ea,!0);const E=oa(()=>ut.params.loanId);let L=U(!1),j=U(!1),ea=U(!1),H=U(""),pa=U(null),J=U(ot([])),fa=U("");const O=oa(()=>a(E)?la.getLoanById(a(E)):null);function ja(s){switch(s){case"electronic":return Rt;case"manual":return Mt;case"cooking":return Dt;case"dish":return It;case"gaz":return qt;case"hygiene":return wt;default:return ht}}lt(()=>{if(!a(E)){_a.error("Emprunt non trouvé"),qa("/dashboard/loans");return}const s=la.getLoanById(a(E));if(!s||s.status!=="accepted"&&s.status!=="completed"){_a.error("Emprunt non valide"),qa("/dashboard/loans");return}s.status==="completed"?(I(j,!0),I(pa,s.returnedAt?new Date(s.returnedAt).toLocaleDateString("fr-FR"):null,!0),I(H,s.returnNotes||"",!0),I(J,s.materielItems.map(n=>{const g=n.lostQuantity||0,k=n.brokenQuantity||0,C=n.quantity-g-k,Z=la.getMaterielById(n.materielId);return{materielId:n.materielId,materielName:n.materielName,materielType:Z?.type||null,quantity:n.quantity,lostQuantity:g,brokenQuantity:k,okQuantity:C,state:g>0||k>0?"issues":"ok"}}),!0)):I(J,s.materielItems.map(n=>{const g=la.getMaterielById(n.materielId);return{materielId:n.materielId,materielName:n.materielName,materielType:g?.type||null,quantity:n.quantity,lostQuantity:0,brokenQuantity:0,okQuantity:n.quantity,state:"pending"}}),!0)});function X(s){const n=a(J)[s],g=n.lostQuantity,k=n.brokenQuantity;n.okQuantity=n.quantity-g-k,(n.lostQuantity>0||n.brokenQuantity>0)&&(n.state="issues")}const La=oa(()=>{for(const s of a(J)){if(s.lostQuantity+s.brokenQuantity+s.okQuantity!==s.quantity)return I(fa,"erreur, veuillez vérifez le formulaire "),!1;if(s.state==="pending")return!1}return!0});function ya(){qa("/dashboard/loans")}function Oa(){if(!a(E)||!a(La)||a(L))return;const s=new Date,n=new Date(a(O)?.endDate||"");s<n?I(ea,!0):Ta()}async function Ta(){if(a(E)){I(ea,!1),I(L,!0);try{const s=a(J).map(n=>({materielId:n.materielId,materielName:n.materielName,quantity:n.quantity,lostQuantity:n.lostQuantity,brokenQuantity:n.brokenQuantity}));await la.completeLoanWithReturn(String(a(E)),{materiels:s,returnNotes:a(H).trim()||void 0}),_a.success("Retour enregistré avec succès"),ya()}catch(s){console.error("[LoanReturnPage] Erreur enregistrement retour:",s),_a.error("Erreur lors de l'enregistrement du retour")}finally{I(L,!1)}}}var Aa=re(),ua=aa(Aa),Ca=r(ua),ga=r(Ca),da=r(ga);da.__click=ya;var Va=r(da);xt(Va,{class:"h-5 w-5"}),e(da);var ma=o(da,2),Ka=o(r(ma),2);{var Fa=s=>{var n=Bt(),g=r(n);e(n),y((k,C)=>D(g,`Emprunt du ${k??""} au 
            ${C??""}`),[()=>Ma(a(O).startDate),()=>Ma(a(O).endDate)]),l(s,n)};c(Ka,s=>{a(O)&&s(Fa)})}e(ma);var Wa=o(ma,2);{var Ga=s=>{var n=Nt();l(s,n)};c(Wa,s=>{a(j)&&s(Ga)})}e(ga);var Ua=o(ga,2);{var Ha=s=>{var n=$t(),g=aa(n),k=r(g),C=r(k);{var Z=_=>{var t=Lt(),b=r(t);Sa(b,{class:"h-5 w-5"});var x=o(b,2),A=o(r(x),2),h=r(A);e(A),e(x),e(t),y(()=>D(h,`Le ${a(pa)??""}`)),l(_,t)};c(C,_=>{a(j)&&a(pa)&&_(Z)})}var ra=o(C,2),ca=r(ra);Sa(ca,{class:"h-5 w-5"}),ia(),e(ra);var V=o(ra,2);dt(V,21,()=>a(J),ct,(_,t,b)=>{var x=Gt(),A=r(x);{const S=(F,W=pt)=>{const sa=oa(()=>ja(W()));var z=Tt(),Q=r(z);{let p=oa(()=>mt(W()));ft(Q,()=>a(sa),(m,B)=>{B(m,{get class(){return`${a(p)??""} size-5`}})})}e(z),y(p=>va(z,1,`${p??""} rounded-lg p-2`),[()=>yt(W())]),l(F,z)};var h=r(A);S(h,()=>a(t).materielType);var M=o(h,2),R=r(M,!0);e(M);var $=o(M,2),at=r($);e($),e(A),y(()=>{D(R,a(t).materielName),D(at,`(${a(t).quantity??""})`)})}var tt=o(A,2);{var et=S=>{var F=Ia(),W=aa(F);{var sa=Q=>{var p=St(),m=r(p);{var B=i=>{var u=At(),f=r(u);Ra(f,{class:"h-4 w-4"});var d=o(f);e(u),y(()=>D(d,` À réparer : ${a(t).brokenQuantity??""}`)),l(i,u)};c(m,i=>{a(t).brokenQuantity>0&&i(B)})}var w=o(m,2);{var q=i=>{var u=Ct(),f=r(u);Ba(f,{class:"h-4 w-4"});var d=o(f);e(u),y(()=>D(d,` Perdu : ${a(t).lostQuantity??""}`)),l(i,u)};c(w,i=>{a(t).lostQuantity>0&&i(q)})}var P=o(w,2);{var N=i=>{var u=Pt(),f=r(u);Na(f,{class:"h-4 w-4"});var d=o(f);e(u),y(()=>D(d,` OK : ${a(t).okQuantity??""}`)),l(i,u)};c(P,i=>{a(t).okQuantity>0&&i(N)})}e(p),l(Q,p)},z=Q=>{var p=zt(),m=r(p);let B;m.__click=()=>{a(t).state="issues",a(t).lostQuantity=0,a(t).brokenQuantity=1,X(b)};var w=r(m);Ra(w,{class:"h-4 w-4"}),ia(),e(m);var q=o(m,2);let P;q.__click=()=>{a(t).state="issues",a(t).lostQuantity=1,a(t).brokenQuantity=0,X(b)};var N=r(q);Ba(N,{class:"h-4 w-4"}),ia(),e(q);var i=o(q,2);i.__click=()=>{a(t).state="ok",a(t).lostQuantity=0,a(t).brokenQuantity=0,X(b)};var u=r(i);Na(u,{class:""}),e(i),e(p),y(()=>{B=va(m,1,`btn btn-sm btn-warning ${a(t).brokenQuantity===0&&"btn-outline"}`,null,B,{"ring-2":a(t).brokenQuantity>0,"ring-warning":a(t).brokenQuantity>0}),P=va(q,1,`btn btn-error btn-sm ${a(t).lostQuantity===0&&"btn-outline"}`,null,P,{"ring-2":a(t).lostQuantity>0,"ring-error":a(t).lostQuantity>0}),va(i,1,`btn btn-circle btn-sm btn-success ${a(t).state!=="ok"&&"btn-outline"}`)}),l(Q,p)};c(W,Q=>{a(j)?Q(sa):Q(z,!1)})}l(S,F)},rt=S=>{var F=Ia(),W=aa(F);{var sa=Q=>{var p=Vt(),m=r(p);{var B=i=>{var u=Et(),f=r(u);Ra(f,{class:"h-4 w-4"});var d=o(f);e(u),y(()=>D(d,` À réparer : ${a(t).brokenQuantity??""}`)),l(i,u)};c(m,i=>{a(t).brokenQuantity>0&&i(B)})}var w=o(m,2);{var q=i=>{var u=jt(),f=r(u);Ba(f,{class:"h-4 w-4"});var d=o(f);e(u),y(()=>D(d,` Perdus : ${a(t).lostQuantity??""}`)),l(i,u)};c(w,i=>{a(t).lostQuantity>0&&i(q)})}var P=o(w,2);{var N=i=>{var u=Ot(),f=r(u);Na(f,{class:"h-4 w-4"});var d=o(f);e(u),y(()=>D(d,` OK : ${a(t).okQuantity??""}`)),l(i,u)};c(P,i=>{a(t).okQuantity>0&&i(N)})}e(p),l(Q,p)},z=Q=>{var p=Wt(),m=r(p),B=r(m),w=o(r(B),2);Da(w),ta(w,"min",0),w.__change=()=>X(b),e(B),e(m);var q=o(m,2),P=r(q),N=o(r(P),2);Da(N),ta(N,"min",0),N.__change=()=>X(b),e(P),e(q);var i=o(q,2);{var u=d=>{var G=Kt(),Pa=r(G),na=o(r(Pa),2);Da(na),ta(na,"min",0),na.__change=()=>{const wa=a(t).lostQuantity,st=a(t).brokenQuantity;a(t).state="issues",a(t).okQuantity=Math.min(a(t).quantity-wa-st,a(t).okQuantity)},e(Pa),e(G),y(()=>ta(na,"max",a(t).quantity)),ba(na,()=>a(t).okQuantity,wa=>a(t).okQuantity=wa),l(d,G)},f=d=>{var G=Ft();G.__click=()=>{a(t).state="ok",a(t).lostQuantity=0,a(t).brokenQuantity=0,X(b)},y(()=>va(G,1,`btn btn-success ${a(t).state!=="ok"&&"btn-outline"}`)),l(d,G)};c(i,d=>{a(t).lostQuantity>0||a(t).brokenQuantity>0?d(u):d(f,!1)})}e(p),y(()=>{ta(w,"max",a(t).quantity),ta(N,"max",a(t).quantity)}),ba(w,()=>a(t).brokenQuantity,d=>a(t).brokenQuantity=d),ba(N,()=>a(t).lostQuantity,d=>a(t).lostQuantity=d),l(Q,p)};c(W,Q=>{a(j)?Q(sa):Q(z,!1)})}l(S,F)};c(tt,S=>{a(t).quantity===1?S(et):S(rt,!1)})}e(x),l(_,x)}),e(V);var K=o(V,2),ka=o(r(K),2);{var xa=_=>{var t=Ia(),b=aa(t);{var x=h=>{var M=Ut(),R=r(M),$=r(R,!0);e(R),e(M),y(()=>D($,a(H))),l(h,M)},A=h=>{var M=Ht();l(h,M)};c(b,h=>{a(H)?h(x):h(A,!1)})}l(_,t)},Qa=_=>{var t=Jt();gt(t),y(()=>t.disabled=a(L)),ba(t,()=>a(H),b=>I(H,b)),l(_,t)};c(ka,_=>{a(j)?_(xa):_(Qa,!1)})}e(K),e(k);var ha=o(k,2);{var T=_=>{var t=Xt(),b=r(t),x=r(b,!0);e(b),e(t),y(()=>D(x,a(fa))),l(_,t)};c(ha,_=>{a(fa)&&_(T)})}e(g);var Y=o(g,2),Ya=r(Y);{var $a=_=>{var t=Yt(),b=aa(t);b.__click=ya;var x=o(b,2);x.__click=Oa;var A=r(x);{var h=R=>{var $=Zt();l(R,$)},M=R=>{Qt(R,{class:"h-4 w-4"})};c(A,R=>{a(L)?R(h):R(M,!1)})}ia(),e(x),y(()=>{b.disabled=a(L),x.disabled=!a(La)||a(L)}),l(_,t)};c(Ya,_=>{a(j)||_($a)})}e(Y),l(s,n)},Ja=s=>{var n=ae();l(s,n)};c(Ua,s=>{a(O)?s(Ha):s(Ja,!1)})}e(Ca),e(ua);var Xa=o(ua,2);{var Za=s=>{var n=ee(),g=r(n),k=r(g),C=r(k);C.nodeValue="Bizarre ! La date de fin de l'emprunt est prévue pour le  ";var Z=o(C),ra=r(Z,!0);e(Z),ia(),e(k);var ca=o(k,4),V=r(ca);V.__click=()=>I(ea,!1);var K=o(V,2);K.__click=Ta;var ka=r(K);{var xa=T=>{var Y=te();l(T,Y)},Qa=T=>{var Y=_t("Confirmer le retour");l(T,Y)};c(ka,T=>{a(L)?T(xa):T(Qa,!1)})}e(K),e(ca),e(g);var ha=o(g,2);ha.__click=()=>I(ea,!1),e(n),y(T=>{D(ra,T),V.disabled=a(L),K.disabled=a(L)},[()=>a(O)?Ma(a(O).endDate):""]),l(s,n)};c(Xa,s=>{a(ea)&&s(Za)})}it(3,ua,()=>kt),l(za,Aa),vt()}bt(["click","change"]);export{ie as default};
