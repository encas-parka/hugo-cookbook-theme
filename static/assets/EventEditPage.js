import{aj as ht,a2 as Gt,M as Qt,P as mt,U as rt,z as xt,ak as yt,al as Jt,am as Kt,t as Tt,an as Yt,ao as It,Y as Ct,x as zt,ap as Xt,h as Zt,Q as $t,a1 as ea,b as ta}from"./icons.js";import{B as _t,d as bt,p as Ye,y as V,z as gt,H as et,A as s,m as e,v as l,k as de,I as b,g as a,h as r,u as S,b as i,w as E,Q as lt,R as nt,x as J,j as Xe,e as Ge,i as dt,S as Nt,ak as qt,am as aa,c as pt,ao as wt,M as ne,o as t,K as X,U as We,L as kt,C as st,G as oe,a6 as sa,W as Qe,al as na,an as At,aq as Ot,$ as ra,ay as Et,F as St,aA as ut,aB as Dt,aC as ia,aD as oa,az as la}from"./appwrite.js";import{E as da,f as va}from"./EventMealCard.js";import{M as Lt,a as jt,b as Bt,c as Vt,n as Pt}from"./index.js";import{F as ft}from"./Fieldset.js";import{E as ca}from"./EventInvitationAlert.js";import{g as ua}from"./event-stats-helpers.js";import{E as fa}from"./EventStats.js";import"./CheckboxBadge.js";import{B as ma}from"./BtnGroupCheck.js";import{U as ga}from"./UnsavedChangesGuard.js";import{C as Mt}from"./ConfirmModal.js";import"./keyboardNavigation.svelte.js";import"./products-display.js";import"./date-helpers.js";var _a=l('<label class="input w-56"><span class="label">Minimum</span> <input type="number" min="1" class="grow" id="min-contrib-input"/></label>'),ba=l('<button class="btn justify-start"><div class="flex items-center gap-4"><span class="label">minimum</span> <span class="text-lg"> </span> <!></div></button>'),pa=l('<div class="badge badge-primary badge-soft badge-lg gap-2 p-3"><!> <span class="font-medium"> </span></div>'),ha=l('<fieldset class="fieldset"><legend class="legend">√âquipes invit√©es</legend> <div class="flex flex-wrap gap-2"></div></fieldset>'),xa=l('<div class="badge badge-soft badge-success gap-2 p-3"><span class="font-medium"> </span></div>'),ya=l('<fieldset class="fieldset"><legend class="legend">Participant confirm√©</legend> <div class="flex flex-wrap gap-2"></div></fieldset>'),wa=l('<div class="badge badge-warning badge-soft gap-2 p-3"><span class="font-medium"> </span></div>'),ka=l('<fieldset class="fieldset"><legend class="text-base-content/70 text-sm font-medium">Invit√©¬∑es</legend> <div class="flex flex-wrap gap-2"></div></fieldset>'),Ea=l('<div class="my-2"><button class="btn btn-primary btn-outline btn-block gap-1"><!> Inviter des participant¬∑es</button></div>'),Ta=l('<fieldset class="fieldset mb-4"><!> <div class="fieldset-label ms-1">Combien faudrait-il √™tre pour tout g√©rer ?</div></fieldset> <div class="mb-6"><div class="space-y-4"><!> <!> <!></div></div> <!>',1),Ia=l('<p class="text-error mt-1 text-xs"> </p>'),Ca=l("<p> </p>"),Sa=l('<div class="badge badge-primary badge-soft badge-lg"><!> </div>'),Da=l('<div class="mb-4"><p class="mb-2 text-sm font-medium opacity-70">√âquipes d√©j√† invit√©es :</p> <div class="flex flex-wrap gap-2"></div></div>'),Pa=l('<label class="hover:bg-secondary/20 bg-secondary/10 flex cursor-pointer items-center gap-3 rounded-lg px-4 py-2 transition-colors"><input type="checkbox" class="checkbox bg-base-100 checkbox-sm"/> <div class="flex flex-col"><span class="text-sm font-medium"> <span class="text-xs opacity-60"> </span></span> <div class="text-xs opacity-70"> </div></div></label>'),Ma=l(`<label class="mt-4 cursor-pointer justify-center gap-4"><input type="checkbox" class="checkbox checkbox-sm"/> <span class="font-base ms-1">Envoyer un email de notification</span></label> <p class="text-base-content/60 mt-1 text-xs">Si d√©sactiv√©, les membres auront acc√®s √† l'√©v√©nement mais ne
                recevront pas d'email. Les personnes invit√©es n'ayant pas de
                compte recevront toujours un email pour la cr√©ation de leur
                compte.</p>`,1),za=l('<div class="flex flex-wrap gap-4"></div> <!>',1),Na=l('<p class="text-sm italic opacity-60">Toutes vos √©quipes sont d√©j√† invit√©es.</p>'),qa=l(`<p class="text-sm italic opacity-60">Vous ne faites partie d'aucune √©quipe. Cr√©ez une √©quipe pour inviter
            plusieurs personnes.</p>`),Aa=l(`<div class="space-y-6"><fieldset class="fieldset"><legend class="legend">Par email</legend> <div class="flex gap-2"><label class="input flex items-center gap-2"><!> <input type="email" class="grow" placeholder="email@exemple.com"/></label> <button class="btn btn-primary"><!> Ajouter</button></div> <!> <div></div></fieldset> <div class="divider">OU</div> <fieldset class="fieldset"><legend class="fieldset-legend"><!> Inviter des √©quipes
          enti√®res</legend> <!> <!></fieldset></div>`),Oa=l('<button class="btn">Annuler</button> <button class="btn btn-primary"><!> Inviter <!></button>',1),La=l("<!> <!> <!>",1),ja=l("<!> <!>",1);function Ba(Ze,n){bt(n,!0);let Ue=Ye(n,"minContrib",15);Ye(n,"userId",3,"");let g=Ye(n,"eventId",3,""),D=Ye(n,"onStartEdit",3,()=>{}),U=V(gt([])),z=V(gt([])),y=V(!1),K=V(!1),I=V(!1);et(()=>{if(g()){const d=n.eventsStore.getEventById(g());if(d&&d.teams){const v=d.teams||[],P=[];for(const W of v){const $=n.nativeTeamsStore.teams.find(G=>G.name===W);$&&P.push($.$id)}s(U,P,!0)}}}),et(()=>{e(K)||s(z,[],!0)});let H=V(""),T=V(null),re=S(()=>n.contributors.filter(d=>d.status==="accepted")),he=S(()=>n.contributors.filter(d=>d.status==="invited"));function ce(d){e(U).includes(d)?s(U,e(U).filter(v=>v!==d),!0):s(U,[...e(U),d],!0)}function xe(){if(!e(H))return;const d=e(H).trim();if(n.contributors.some(P=>P.email===d)||e(z).some(P=>P.email===d)){s(T,"Cet email est d√©j√† invit√©.");return}s(T,null);const v={id:wt(),email:d,status:"invited",invitedAt:new Date().toISOString()};s(z,[...e(z),v],!0),s(H,"")}async function ye(){if(!g()){ne.error("ID d'√©v√©nement manquant");return}const d=n.eventsStore.getEventById(g());if(!d)throw new Error("√âv√©nement introuvable");const v=e(U).filter(W=>{const $=n.nativeTeamsStore.teams.find(G=>G.$id===W);return $?!d.teams?.includes($.name):!1}),P=e(z).map(W=>W.email).filter(Boolean);if(v.length===0&&P.length===0){ne.warning("S√©lectionnez au moins une √©quipe ou entrez un email");return}try{await ne.track(n.eventsStore.inviteParticipants(g(),{teamIds:v,emails:P,sendEmailToExistingMembers:e(y)}),{loading:"Envoi des invitations en cours...",success:"invitation envoy√© avec succ√®s",error:"Erreur lors de l'envoi des invitations"}),s(K,!1),s(z,[],!0)}catch(W){console.error("Erreur lors de l'envoi des invitations:",W)}}function ue(){s(K,!1),s(H,""),s(T,null)}let Z=S(()=>()=>{if(!g())return[];const d=n.eventsStore.getEventById(g());return d?e(U).filter(v=>{const P=n.nativeTeamsStore.teams.find(W=>W.$id===v);return P?!d.teams?.includes(P.name):!1}):[]});var we=ja(),Te=de(we);ft(Te,{legend:"Participants",children:(d,v)=>{var P=Ta(),W=de(P),$=a(W);{var G=_=>{var m=_a(),p=r(a(m),2);p.defaultValue=1,t(m),E(()=>p.disabled=!n.canEdit),lt("focus",p,function(...O){D()?.apply(this,O)}),lt("blur",p,()=>s(I,!1)),nt(p,Ue),i(_,m)},N=_=>{var m=ba();m.__click=()=>{s(I,!0),setTimeout(()=>{document.getElementById("min-contrib-input")?.focus()},50)};var p=a(m),O=r(a(p),2),R=a(O,!0);t(O);var L=r(O,2);ht(L,{class:"h-4 w-4"}),t(p),t(m),E(()=>{m.disabled=!n.canEdit,J(R,Ue()||1)}),i(_,m)};b($,_=>{e(I)?_(G):_(N,!1)})}X(2),t(W);var ke=r(W,2),ee=a(ke),te=a(ee);{var ge=_=>{const m=S(()=>n.eventsStore.getEventById(g()));var p=Xe(),O=de(p);{var R=L=>{var Q=ha(),fe=r(a(Q),2);Ge(fe,21,()=>e(m).teams,dt,(Me,Ce)=>{var C=pa(),o=a(C);rt(o,{class:"inline size-4"});var c=r(o,2),h=a(c,!0);t(c),t(C),E(()=>J(h,e(Ce))),i(Me,C)}),t(fe),t(Q),i(L,Q)};b(O,L=>{e(m)&&e(m).teams&&e(m).teams.length>0&&L(R)})}i(_,p)};b(te,_=>{g()&&_(ge)})}var Ie=r(te,2);{var _e=_=>{var m=ya(),p=r(a(m),2);Ge(p,21,()=>e(re),O=>O.id,(O,R)=>{var L=xa(),Q=a(L),fe=a(Q,!0);t(Q),t(L),E(()=>J(fe,e(R).name||e(R).email)),i(O,L)}),t(p),t(m),i(_,m)};b(Ie,_=>{e(re).length>0&&_(_e)})}var ie=r(Ie,2);{var q=_=>{var m=ka(),p=r(a(m),2);Ge(p,21,()=>e(he),O=>O.id,(O,R)=>{var L=wa(),Q=a(L),fe=a(Q,!0);t(Q),t(L),E(()=>J(fe,e(R).name||e(R).email)),i(O,L)}),t(p),t(m),i(_,m)};b(ie,_=>{e(he).length>0&&_(q)})}t(ee),t(ke);var Y=r(ke,2);{var A=_=>{var m=Ea(),p=a(m);p.__click=()=>s(K,!0);var O=a(p);Gt(O,{class:"mr-2 h-4 w-4"}),X(),t(p),t(m),i(_,m)};b(Y,_=>{g()&&_(A)})}i(d,P)},$$slots:{default:!0}});var je=r(Te,2);Lt(je,{get isOpen(){return e(K)},onClose:ue,children:(d,v)=>{var P=La(),W=de(P);jt(W,{title:"Inviter des participants",onClose:ue});var $=r(W,2);Bt($,{children:(N,ke)=>{var ee=Aa(),te=a(ee),ge=r(a(te),2),Ie=a(ge),_e=a(Ie);Qt(_e,{class:"h-4 w-4 opacity-70"});var ie=r(_e,2);We(ie),ie.__keydown=C=>C.key==="Enter"&&xe(),t(Ie);var q=r(Ie,2);q.__click=xe;var Y=a(q);mt(Y,{class:"h-4 w-4 opacity-70"}),X(),t(q),t(ge);var A=r(ge,2);{var _=C=>{var o=Ia(),c=a(o,!0);t(o),E(()=>J(c,e(T))),i(C,o)};b(A,C=>{e(T)&&C(_)})}var m=r(A,2);Ge(m,21,()=>e(z),dt,(C,o)=>{var c=Ca(),h=a(c,!0);t(c),E(()=>J(h,e(o).email)),i(C,c)}),t(m),t(te);var p=r(te,4),O=a(p),R=a(O);rt(R,{size:16,class:"inline shrink-0 opacity-60"}),X(),t(O);var L=r(O,2);{var Q=C=>{const o=S(()=>n.eventsStore.getEventById(g()));var c=Xe(),h=de(c);{var j=M=>{var B=Da(),ae=r(a(B),2);Ge(ae,21,()=>e(o).teams,dt,(Ae,Oe)=>{var Se=Sa(),ze=a(Se);rt(ze,{class:"inline size-4"});var be=r(ze,1,!0);t(Se),E(()=>J(be,e(Oe))),i(Ae,Se)}),t(ae),t(B),i(M,B)};b(h,M=>{e(o)&&e(o).teams&&e(o).teams.length>0&&M(j)})}i(C,c)};b(L,C=>{g()&&C(Q)})}var fe=r(L,2);{var Me=C=>{const o=S(()=>n.nativeTeamsStore.myTeams.filter(B=>{if(!g())return!0;const ae=n.eventsStore.getEventById(g());return!ae||!ae.teams?!0:!ae.teams.includes(B.name)}));var c=Xe(),h=de(c);{var j=B=>{var ae=za(),Ae=de(ae);Ge(Ae,21,()=>e(o),dt,(ze,be)=>{var De=Pa(),Ne=a(De);We(Ne),Ne.__change=()=>ce(e(be).$id);var Je=r(Ne,2),u=a(Je),f=a(u),w=r(f),F=a(w);t(w),t(u);var se=r(u,2),Le=a(se,!0);t(se),t(Je),t(De),E((x,Ee)=>{qt(Ne,x),J(f,`${e(be).name??""} `),J(F,`${e(be).total??""} membre${e(be).total>1?"s":""}`),J(Le,Ee)},[()=>e(U).includes(e(be).$id),()=>n.nativeTeamsStore.getTeamMemberNames(e(be).$id).join(", ")]),i(ze,De)}),t(Ae);var Oe=r(Ae,2);{var Se=ze=>{var be=Ma(),De=de(be),Ne=a(De);We(Ne),X(2),t(De),X(2),aa(Ne,()=>e(y),Je=>s(y,Je)),i(ze,be)};b(Oe,ze=>{e(U).length>0&&ze(Se)})}i(B,ae)},M=B=>{var ae=Na();i(B,ae)};b(h,B=>{e(o).length>0?B(j):B(M,!1)})}i(C,c)},Ce=C=>{var o=qa();i(C,o)};b(fe,C=>{n.nativeTeamsStore.myTeams.length>0?C(Me):C(Ce,!1)})}t(p),t(ee),E(()=>q.disabled=!e(H)),nt(ie,()=>e(H),C=>s(H,C)),i(N,ee)}});var G=r($,2);Vt(G,{children:(N,ke)=>{var ee=Oa(),te=de(ee);te.__click=ue;var ge=r(te,2);ge.__click=ye;var Ie=a(ge);xt(Ie,{class:"mr-2 h-4 w-4"});var _e=r(Ie,2);{var ie=q=>{var Y=Nt();E(A=>J(Y,`(${A??""})`),[()=>e(Z)().length+e(z).length]),i(q,Y)};b(_e,q=>{(e(Z)().length>0||e(z).length>0)&&q(ie)})}t(ge),E(q=>ge.disabled=q,[()=>e(z).length===0&&e(Z)().length===0]),i(N,ee)}}),i(d,P)},$$slots:{default:!0}}),i(Ze,we),pt()}_t(["click","keydown","change"]);var Va=l('<div class="flex items-center gap-2"><!> <span> </span></div>'),Ua=l('<div class="flex items-center gap-2"><!> <span>A r√©aliser avant le :</span> <span class="font-medium"> </span></div>'),Fa=l("<div><div><span> </span></div></div>"),Ra=l('<div><div class="bg-base-300 text-base-content w-7 rounded-full"><span class="text-base"> </span></div></div>'),Ha=l('<span class="text-warning mx-1 text-base italic">Non assign√©</span>'),Wa=l('<p class="text-base-content/60 mt-1 line-clamp-2 text-sm"> </p>'),Ga=l("<button><!> Fait <!></button>"),Qa=l(`<button class="btn btn-primary btn-outline btn-sm gap-1" title="Me porter volontaire pour cette t√¢che"><!> <span>M'inscrire</span></button>`),Ja=l('<button class="btn btn-error btn-sm btn-outline gap-1" title="Quitter cette t√¢che"><!> <span>me d√©sinscrire</span></button>'),Ka=l('<div><div class="flex flex-col gap-3"><div class="flex min-w-0 items-start gap-3"><div class="flex min-w-0 grow flex-col gap-4"><div class="flex flex-wrap items-start justify-between gap-x-4 gap-y-2"><div> </div> <div><!> <!> <!></div></div>  <div class="flex items-center gap-2"><!> <div class="flex min-w-0 items-center gap-1"><div class="flex flex-wrap gap-2"><!> <!> <!></div> <span> </span></div></div> <!></div></div></div> <div class="mt-4 flex items-center justify-between gap-2"><div class="flex gap-2"><!></div> <div class="ms-auto flex gap-2"><!> <button class="btn btn-sm btn-square" title="Modifier la t√¢che"><!></button></div></div></div>');function Ya(Ze,n){bt(n,!0);let Ue=Ye(n,"disabled",3,!1),g=Ye(n,"contributors",19,()=>[]),D=V(!1);const U=S(()=>Array.isArray(n.todo.assignedTo)?n.todo.assignedTo:[]),z=S(()=>oe.userId&&e(U).includes(oe.userId)),y=S(()=>n.todo.assignedTo?n.todo.assignedTo.map(o=>{const c=g().find(M=>M.id===o),h=o===oe.userId,j=c?.name||(h?"Moi":o.substring(0,5));return{userId:o,name:j,isCurrentUser:h}}):[]),K=S(()=>e(y).length>=(n.todo.requiredPeopleNb||1)),I=S(()=>{switch(n.todo.taskOn){case"beforeEvent":return{bg:"bg-accent/30",icon:Kt,label:"Avant l'√©v√©nement"};case"afterEvent":return{bg:"bg-secondary/10",icon:Jt,label:"Apr√®s l'√©v√©nement"};default:return{bg:"bg-secondary/20",icon:yt,label:"Pendant l'√©v√©nement"}}});async function H(){if(e(D)||Ue())return;const c=n.todo.status==="done"?"todo":"done";s(D,!0);try{await Qe.updateTodo(n.eventId,n.todo.id,{status:c})}catch{ne.error("Erreur m√†j statut")}finally{s(D,!1)}}async function T(){if(!oe.userId||e(D))return;const o=e(z)?e(U).filter(c=>c!==oe.userId):[...e(U),oe.userId];s(D,!0);try{await Qe.updateTodo(n.eventId,n.todo.id,{assignedTo:o.length>0?o:null}),ne.success(e(z)?"Vous avez rejoint la t√¢che":"Vous avez quitt√© la t√¢che")}catch{ne.error("Erreur assignation")}finally{s(D,!1)}}var re=Ka();let he;var ce=a(re),xe=a(ce),ye=a(xe),ue=a(ye),Z=a(ue),we=a(Z,!0);t(Z);var Te=r(Z,2),je=a(Te);{var d=o=>{};b(je,o=>{n.todo.priority&&n.todo.priority!=="low"&&o(d)})}var v=r(je,2);{var P=o=>{var c=Va(),h=a(c);sa(h,()=>e(I).icon,(B,ae)=>{ae(B,{class:"size-4 shrink-0 opacity-70"})});var j=r(h,2),M=a(j,!0);t(j),t(c),E(()=>J(M,e(I).label)),i(o,c)};b(v,o=>{n.todo.taskOn&&o(P)})}var W=r(v,2);{var $=o=>{var c=Ua(),h=a(c);Tt(h,{class:"size-4 shrink-0 opacity-70"});var j=r(h,4),M=a(j,!0);t(j),t(c),E(B=>J(M,B),[()=>new Date(n.todo.dueDate).toLocaleDateString("fr-FR",{day:"numeric",month:"short",year:"numeric"})]),i(o,c)};b(W,o=>{n.todo.dueDate&&o($)})}t(Te),t(ue);var G=r(ue,2),N=a(G);rt(N,{class:"mt-1 mb-auto size-4 shrink-0 opacity-60"});var ke=r(N,2),ee=a(ke),te=a(ee);Ge(te,19,()=>e(y).slice(0,3),o=>o.userId,(o,c)=>{var h=Fa(),j=a(h),M=a(j),B=a(M,!0);t(M),t(j),t(h),E(()=>{kt(h,"title",e(c).name+(e(c).isCurrentUser?" (vous)":"")),st(j,1,`badge badge-soft badge-info ${(e(c).isCurrentUser&&"ring-info font-semibold ring-1")??""}`),J(B,e(c).name)}),i(o,h)});var ge=r(te,2);{var Ie=o=>{var c=Ra(),h=a(c),j=a(h),M=a(j);t(j),t(h),t(c),E(()=>{kt(c,"title",`+${e(y).length-3} autres`),J(M,`+${e(y).length-3}`)}),i(o,c)};b(ge,o=>{e(y).length>3&&o(Ie)})}var _e=r(ge,2);{var ie=o=>{var c=Ha();i(o,c)};b(_e,o=>{e(y).length===0&&o(ie)})}t(ee);var q=r(ee,2),Y=a(q);t(q),t(ke),t(G);var A=r(G,2);{var _=o=>{var c=Wa(),h=a(c,!0);t(c),E(()=>J(h,n.todo.taskDescription)),i(o,c)};b(A,o=>{n.todo.taskDescription&&o(_)})}t(ye),t(xe),t(ce);var m=r(ce,2),p=a(m),O=a(p);{var R=o=>{var c=Ga();c.__click=H;var h=a(c);{let B=S(()=>n.todo.status!=="done"&&"opacity-60");xt(h,{get class(){return`size-4 ${e(B)??""}`}})}var j=r(h,2);{var M=B=>{var ae=Nt("?");i(B,ae)};b(j,B=>{n.todo.status!=="done"&&B(M)})}t(c),E(()=>{st(c,1,`btn btn-sm ${n.todo.status!=="done"?"btn-dash":"btn-success"}`),kt(c,"title",n.todo.status==="done"?"Marquer √† faire":"Marquer fait"),c.disabled=Ue()}),i(o,c)};b(O,o=>{n.todo.taskOn==="beforeEvent"&&o(R)})}t(p);var L=r(p,2),Q=a(L);{var fe=o=>{var c=Qa();c.__click=T;var h=a(c);xt(h,{class:"size-4"}),X(2),t(c),i(o,c)},Me=o=>{var c=Xe(),h=de(c);{var j=M=>{var B=Ja();B.__click=T;var ae=a(B);Yt(ae,{class:"size-4"}),X(2),t(B),i(M,B)};b(h,M=>{e(z)&&M(j)},!0)}i(o,c)};b(Q,o=>{e(z)?o(Me,!1):o(fe)})}var Ce=r(Q,2);Ce.__click=()=>n.onEdit(n.todo);var C=a(Ce);ht(C,{class:"size-4"}),t(Ce),t(L),t(m),t(re),E(()=>{he=st(re,1,`group bg-base-200/50 relative rounded-xl p-4 shadow transition-all ${e(K)?"shadow-success/40 ":"shadow-warning/40 "}`,null,he,{"opacity-50":e(D)}),st(Z,1,`text-base font-medium ${n.todo.status==="done"?"line-through opacity-50":""}`),J(we,n.todo.taskName),st(Te,1,`card card-sm ${e(I).bg??""} ms-auto flex flex-col justify-end px-4 py-1`),st(q,1,`mx-1 ${e(y).length<(n.todo.requiredPeopleNb||1)?"text-warning":"text-success"} font-medium`),J(Y,`${e(y).length??""}/${(n.todo.requiredPeopleNb||1)??""} pers. requise`)}),i(Ze,re),pt()}_t(["click"]);var Xa=l('<div role="tablist" class="tabs tabs-border tabs-lg mb-4"><button role="tab"><!> T√¢che individuelle</button> <button role="tab"><!> T√¢ches pr√©d√©finies</button></div>'),Za=l('<span class="badge badge-warning badge-sm"> </span>'),$a=l('<span class="badge badge-success badge-sm flex items-center gap-1"><!> ok</span>'),es=l(`<div class="space-y-4"><fieldset class="fieldset"><legend class="fieldset-legend">Titre</legend> <label class="input w-full"><input type="text" placeholder="Ex: Acheter du pain, Pr√©parer la salle..." class="grow"/></label></fieldset> <fieldset class="fieldset"><legend class="fieldset-legend flex items-center gap-2"><!> Description</legend> <textarea class="textarea h-24 w-full" placeholder="D√©tails suppl√©mentaires..."></textarea></fieldset> <div class="flex flex-wrap gap-4"><fieldset class="fieldset w-80"><legend class="fieldset-legend flex items-center gap-2"><!> Moment</legend> <select class="select w-full"><option>Avant l'√©v√©nement</option><option>Pendant l'√©v√©nement</option><option>Apr√®s l'√©v√©nement</option></select></fieldset> <fieldset class="fieldset w-80"><legend class="fieldset-legend flex items-center gap-2"><!> √âch√©ance</legend> <label class="input w-full"><input type="date" class="grow"/></label></fieldset> <fieldset class="fieldset"><legend class="fieldset-legend flex items-center gap-2"><!> Personnes requises</legend> <label class="input w-full"><input type="number" min="1" class="grow"/></label></fieldset></div> <fieldset class="fieldset"><legend class="fieldset-legend flex items-center gap-2"><!> <!></legend> <!></fieldset></div>`),ts=l('<div class="bg-base-100 flex items-center gap-4 rounded-lg p-3"><input type="checkbox" class="checkbox checkbox-primary"/> <input type="text" class="input flex-1"/> <div class="flex items-center gap-2"><!> <input type="number" class="input w-20" min="1"/></div></div>'),as=l('<div class="collapse-arrow bg-base-200 collapse"><input type="checkbox" checked/> <div class="collapse-title flex items-center gap-2 text-base font-medium"><!> </div> <div class="collapse-content"><div class="mt-4 space-y-3"></div></div></div>'),ss=l('<div class="space-y-6"></div>'),ns=l("<!> <!>",1),rs=l('<span class="loading loading-spinner loading-sm"></span>'),is=l('<button type="button" class="btn btn-primary"><!> Cr√©er les t√¢ches s√©lectionn√©es</button>'),os=l('<button type="button" class="btn btn-ghost"><!> Sauvegarder & Cr√©er</button>'),ls=l('<span class="loading loading-spinner loading-sm"></span>'),ds=l('<!> <button type="button" class="btn btn-primary"><!> </button>',1),vs=l("<!> <!> <!>",1);function cs(Ze,n){bt(n,!0);let Ue=Ye(n,"contributors",19,()=>[]);Ye(n,"currentTodos",19,()=>[]);let g=V(""),D=V(""),U=V("medium"),z=V("onEvent"),y=V(1),K=V(""),I=V(gt([])),H=V(!1),T=V("individual");const re={beforeEvent:["Gestion de l'approvisionnement / courses","Choix des recettes/menus","Coordination","Communication (mail, texto, affiches)","Gestion matos"],onEvent:["Pr√©parations des recettes","Service","Rangement","Vaisselle","Gestion des restes"],afterEvent:["Retour matos","D√©montage cuisine"]},he=S(()=>n.todoToEdit?{taskName:n.todoToEdit.taskName,taskDescription:n.todoToEdit.taskDescription||"",priority:n.todoToEdit.priority||"medium",taskOn:n.todoToEdit.taskOn||"onEvent",requiredPeopleNb:n.todoToEdit.requiredPeopleNb||1,dueDate:n.todoToEdit.dueDate?n.todoToEdit.dueDate.split("T")[0]:"",assignedTo:n.todoToEdit.assignedTo?[...n.todoToEdit.assignedTo]:[]}:{taskName:"",taskDescription:"",priority:"medium",taskOn:"onEvent",requiredPeopleNb:1,dueDate:"",assignedTo:[]});et(()=>{if(n.open){n.todoToEdit?s(T,"individual"):s(T,"individual");const d=e(he);s(g,d.taskName,!0),s(D,d.taskDescription,!0),s(U,d.priority,!0),s(z,d.taskOn,!0),s(y,d.requiredPeopleNb,!0),s(K,d.dueDate,!0),s(I,d.assignedTo,!0)}});function ce(){s(g,""),s(D,""),s(U,"medium"),s(z,"onEvent"),s(y,1),s(K,""),s(I,[],!0)}async function xe(d=!1){if(!e(g).trim()){ne.warning("Le titre de la t√¢che est requis");return}s(H,!0);try{const v=new Date().toISOString();if(n.todoToEdit){const P={taskName:e(g),taskDescription:e(D)||null,priority:e(U),taskOn:e(z),requiredPeopleNb:e(y),dueDate:e(K)?new Date(e(K)).toISOString():null,assignedTo:e(I).length>0?e(I):null};await Qe.updateTodo(n.eventId,n.todoToEdit.id,P),ne.success("T√¢che mise √† jour"),ye()}else{const P={id:wt(10),taskName:e(g),taskDescription:e(D)||null,priority:e(U),taskOn:e(z),requiredPeopleNb:e(y),dueDate:e(K)?new Date(e(K)).toISOString():null,assignedTo:e(I).length>0?e(I):null,status:"todo"};await Qe.addTodo(n.eventId,P),ne.success("T√¢che cr√©√©e"),d?ce():ye()}}catch(v){ne.error("Erreur lors de la sauvegarde"),console.error(v)}finally{s(H,!1)}}function ye(){ce(),n.onClose()}function ue(d){e(I).includes(d)?s(I,e(I).filter(v=>v!==d),!0):s(I,[...e(I),d],!0)}let Z=V(gt([]));et(()=>{n.open&&e(T)==="bulk"&&s(Z,[...re.beforeEvent.map(d=>({taskName:d,taskOn:"beforeEvent",enabled:!0,requiredPeopleNb:1})),...re.onEvent.map(d=>({taskName:d,taskOn:"onEvent",enabled:!0,requiredPeopleNb:1})),...re.afterEvent.map(d=>({taskName:d,taskOn:"afterEvent",enabled:!1,requiredPeopleNb:1}))],!0)});async function we(){const d=e(Z).filter(v=>v.enabled);if(d.length===0){ne.warning("S√©lectionnez au moins une t√¢che");return}s(H,!0);try{const v=new Date().toISOString(),P=d.map(W=>({id:wt(10),taskName:W.taskName,taskDescription:null,priority:"medium",taskOn:W.taskOn,requiredPeopleNb:W.requiredPeopleNb,dueDate:null,assignedTo:null,status:"todo"}));await Qe.addTodos(n.eventId,P),ne.success(`${P.length} t√¢che(s) cr√©√©e(s)`),ye()}catch(v){ne.error("Erreur lors de la cr√©ation"),console.error(v)}finally{s(H,!1)}}function Te(d){e(Z)[d].enabled=!e(Z)[d].enabled}const je=S(()=>{const d=[{id:oe.userId||"",label:"Moi",selected:e(I).includes(oe.userId||"")}];return Ue().forEach(v=>{v.id!==oe.userId&&d.push({id:v.id,label:v.name||v.email||v.id.substring(0,5),selected:e(I).includes(v.id)})}),d});Lt(Ze,{get isOpen(){return n.open},onClose:ye,maxWidth:"lg",maxHeight:"xl",children:(d,v)=>{var P=vs(),W=de(P);{let N=S(()=>n.todoToEdit?"Modifier la T√¢che":"Nouvelle T√¢che");jt(W,{get title(){return e(N)},onClose:ye})}var $=r(W,2);Bt($,{children:(N,ke)=>{var ee=ns(),te=de(ee);{var ge=q=>{var Y=Xa(),A=a(Y);A.__click=()=>s(T,"individual");var _=a(A);It(_,{class:"me-2 size-4"}),X(),t(A);var m=r(A,2);m.__click=()=>s(T,"bulk");var p=a(m);Ct(p,{class:"me-2 size-4"}),X(),t(m),t(Y),E(()=>{st(A,1,`tab ${e(T)==="individual"?"tab-active":""}`),st(m,1,`tab ${e(T)==="bulk"?"tab-active":""}`)}),i(q,Y)};b(te,q=>{n.todoToEdit||q(ge)})}var Ie=r(te,2);{var _e=q=>{var Y=es(),A=a(Y),_=r(a(A),2),m=a(_);We(m),t(_),t(A);var p=r(A,2),O=a(p),R=a(O);It(R,{class:"size-4 opacity-50"}),X(),t(O);var L=r(O,2);Ot(L),t(p);var Q=r(p,2),fe=a(Q),Me=a(fe),Ce=a(Me);yt(Ce,{class:"size-4 opacity-50"}),X(),t(Me);var C=r(Me,2),o=a(C);o.value=o.__value="beforeEvent";var c=r(o);c.value=c.__value="onEvent";var h=r(c);h.value=h.__value="afterEvent",t(C),t(fe);var j=r(fe,2),M=a(j),B=a(M);Tt(B,{class:"size-4 opacity-50"}),X(),t(M);var ae=r(M,2),Ae=a(ae);We(Ae),t(ae),t(j);var Oe=r(j,2),Se=a(Oe),ze=a(Se);rt(ze,{class:"size-4 opacity-50"}),X(),t(Se);var be=r(Se,2),De=a(be);We(De),t(be),t(Oe),t(Q);var Ne=r(Q,2),Je=a(Ne),u=a(Je);rt(u,{class:"size-4 opacity-50"});var f=r(u),w=r(f);{var F=x=>{var Ee=Za(),Be=a(Ee);t(Ee),E(()=>J(Be,`Manque ${e(y)-e(I).length} pers.`)),i(x,Ee)},se=x=>{var Ee=$a(),Be=a(Ee);xt(Be,{class:"size-3"}),X(),t(Ee),i(x,Ee)};b(w,x=>{e(I).length<e(y)?x(F):x(se,!1)})}t(Je);var Le=r(Je,2);ma(Le,{get items(){return e(je)},size:"lg",color:"primary",onToggleItem:ue}),t(Ne),t(Y),E(()=>J(f,` Assignation (${e(I).length??""}/${e(y)??""}) `)),nt(m,()=>e(g),x=>s(g,x)),nt(L,()=>e(D),x=>s(D,x)),na(C,()=>e(z),x=>s(z,x)),nt(Ae,()=>e(K),x=>s(K,x)),nt(De,()=>e(y),x=>s(y,x)),i(q,Y)},ie=q=>{var Y=ss();Ge(Y,20,()=>["beforeEvent","onEvent","afterEvent"],dt,(A,_)=>{const m=S(()=>_==="beforeEvent"?"Avant l'√©v√©nement":_==="onEvent"?"Pendant l'√©v√©nement":"Apr√®s l'√©v√©nement"),p=S(()=>e(Z).filter(Q=>Q.taskOn===_));var O=Xe(),R=de(O);{var L=Q=>{var fe=as(),Me=a(fe);We(Me);var Ce=r(Me,2),C=a(Ce);yt(C,{class:"size-4 opacity-50"});var o=r(C);t(Ce);var c=r(Ce,2),h=a(c);Ge(h,21,()=>e(p),dt,(j,M,B)=>{const ae=S(()=>e(Z).indexOf(e(M)));var Ae=ts(),Oe=a(Ae);We(Oe),Oe.__change=()=>Te(e(ae));var Se=r(Oe,2);We(Se);var ze=r(Se,2),be=a(ze);rt(be,{class:"size-4 opacity-50"});var De=r(be,2);We(De),t(ze),t(Ae),E(()=>{qt(Oe,e(M).enabled),At(Se,e(M).taskName),Se.disabled=!e(M).enabled,De.disabled=!e(M).enabled}),nt(De,()=>e(M).requiredPeopleNb,Ne=>e(M).requiredPeopleNb=Ne),i(j,Ae)}),t(h),t(c),t(fe),E(j=>J(o,` ${e(m)??""} (${j??""}/${e(p).length??""})`),[()=>e(p).filter(j=>j.enabled).length]),i(Q,fe)};b(R,Q=>{e(p).length>0&&Q(L)})}i(A,O)}),t(Y),i(q,Y)};b(Ie,q=>{n.todoToEdit||e(T)==="individual"?q(_e):q(ie,!1)})}i(N,ee)}});var G=r($,2);Vt(G,{children:(N,ke)=>{var ee=Xe(),te=de(ee);{var ge=_e=>{var ie=is();ie.__click=we;var q=a(ie);{var Y=_=>{var m=rs();i(_,m)},A=_=>{Ct(_,{class:"size-4"})};b(q,_=>{e(H)?_(Y):_(A,!1)})}X(),t(ie),E(()=>ie.disabled=e(H)),i(_e,ie)},Ie=_e=>{var ie=ds(),q=de(ie);{var Y=R=>{var L=os();L.__click=()=>xe(!0);var Q=a(L);mt(Q,{class:"size-4"}),X(),t(L),E(()=>L.disabled=e(H)),i(R,L)};b(q,R=>{n.todoToEdit||R(Y)})}var A=r(q,2);A.__click=()=>xe(!1);var _=a(A);{var m=R=>{var L=ls();i(R,L)},p=R=>{zt(R,{class:"size-4"})};b(_,R=>{e(H)?R(m):R(p,!1)})}var O=r(_);t(A),E(()=>{A.disabled=e(H),J(O,` ${n.todoToEdit?"Mettre √† jour":"Cr√©er la t√¢che"}`)}),i(_e,ie)};b(te,_e=>{e(T)==="bulk"?_e(ge):_e(Ie,!1)})}i(N,ee)}}),i(d,P)},$$slots:{default:!0}}),pt()}_t(["click","change"]);var us=l('<div class="text-base-content/50 border-base-200 hover:border-primary/50 cursor-pointer rounded-lg border-2 border-dashed py-8 text-center text-sm italic transition-colors" role="button" tabindex="0">Aucune t√¢che pour le moment. <br/> <span class="text-primary mt-1 inline-block font-medium">Cr√©er la premi√®re t√¢che +</span></div>'),fs=l('<div class="mb-4 flex items-center justify-between"><div class="flex items-center gap-2 text-sm opacity-60"><!> <span> </span></div> <button class="btn btn-sm btn-primary gap-2"><!> Nouvelle t√¢che</button></div> <div class=" space-y-4"><!></div> <!>',1);function ms(Ze,n){bt(n,!0);let Ue=Ye(n,"contributors",19,()=>[]),g=Ye(n,"disabled",3,!1);const D=S(()=>n.event.todos??[]);function U(re){return{beforeEvent:1,onEvent:2,afterEvent:3}[re]??0}const z=S(()=>[...e(D)].sort((he,ce)=>{const xe=U(he.taskOn??""),ye=U(ce.taskOn??""),ue=xe-ye;if(ue!==0)return ue;const Z=he.dueDate?new Date(he.dueDate).getTime():1/0,we=ce.dueDate?new Date(ce.dueDate).getTime():1/0;return Z-we}));let y=V(!1),K=V(null);function I(){s(K,null),s(y,!0)}function H(re){s(K,re,!0),s(y,!0)}function T(re){n.onTodosChange?.(re)}ft(Ze,{legend:"T√¢ches & Organisation",legendSize:"text-lg",children:(re,he)=>{var ce=fs(),xe=de(ce),ye=a(xe),ue=a(ye);Xt(ue,{class:"size-4"});var Z=r(ue,2),we=a(Z);t(Z),t(ye);var Te=r(ye,2);Te.__click=I;var je=a(Te);mt(je,{class:"size-4"}),X(),t(Te),t(xe);var d=r(xe,2),v=a(d);{var P=G=>{var N=us();N.__click=I,N.__keydown=ke=>ke.key==="Enter"&&I(),i(G,N)},W=G=>{var N=Xe(),ke=de(N);Ge(ke,17,()=>e(z),ee=>ee.id,(ee,te)=>{Ya(ee,{get todo(){return e(te)},get eventId(){return n.event.$id},onEdit:H,get disabled(){return g()},get contributors(){return Ue()}})}),i(G,N)};b(v,G=>{e(z).length===0?G(P):G(W,!1)})}t(d);var $=r(d,2);cs($,{get open(){return e(y)},get eventId(){return n.event.$id},get todoToEdit(){return e(K)},get contributors(){return Ue()},get currentTodos(){return e(D)},onClose:()=>s(y,!1),onSave:T}),E(()=>J(we,`${e(D).length??""} t√¢ches`)),i(re,ce)},$$slots:{default:!0}}),pt()}_t(["click","keydown"]);var gs=l('<span class="loading loading-spinner loading-xs text-primary"></span>'),_s=l('<div class="flex items-center gap-2"><button class="btn btn-accent"><!> <span class="font-bold">Enregistrer</span></button></div>'),bs=l(`<input type="text" class="input input-lg min-w-full shadow-md" placeholder="Nom de l'√©v√©nement"/>`),ps=l('<button class="btn btn-ghost"><div class="flex items-baseline gap-4"><h1> </h1> <!></div></button>'),hs=l(`<textarea class="textarea w-full" placeholder="D√©crivez l'√©v√©nement..." maxlength="3000" rows="9"></textarea> <p class="label"> </p>`,1),xs=l('<p class="whitespace-pre-wrap"> </p>'),ys=l('<p class="text-base-content/40 italic">Ajoutez une description...</p>'),ws=l('<button class="btn btn-ghost bg-base-100 h-auto justify-start py-4 text-left font-normal"><div class="flex w-full items-start justify-between gap-4"><div class="flex-1"><!></div> <!></div></button>'),ks=l('<div class="badge badge-lg badge-success gap-1"><!> Confirm√©</div>'),Es=l('<div class="badge badge-lg badge-info gap-1"><!> Proposition</div>'),Ts=l('<div class="badge badge-lg badge-warning gap-1"><!> </div>'),Is=l(`<button class="btn btn-success btn-link btn-md">Confirmez l'√©v√©nement</button>`),Cs=l(`<button class="btn btn-link btn-error btn-sm">Annuler l'√©v√©nement</button>`),Ss=l('<button class="btn btn-link btn-sm">R√©activer</button>'),Ds=l('<div class="flex flex-wrap items-center justify-between gap-2"><div class="flex items-center gap-2"><!></div> <!></div>'),Ps=l('<div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:col-span-2 lg:grid-cols-3"><div class="col-span-2"><!></div> <div class="flex flex-col justify-start gap-4"><!></div></div>'),Ms=l(`<div class="flex items-center justify-center py-20"><div class="flex flex-col items-center gap-4"><span class="loading loading-spinner loading-lg text-primary"></span> <p class="text-base-content/60">Chargement de l'√©v√©nement...</p></div></div>`),zs=l(`<div class="alert alert-info"><!> <div><h4 class="font-bold">Mode D√©monstration</h4> <p class="text-sm">Dans un v√©ritable √©v√©nement, vous pourrez inviter des √©quipes
                  et des participants √† collaborer sur la planification.</p></div></div>`),Ns=l(`<div class="alert alert-warning max-md:alert-vertical"><!> <div><h3 class="font-bold">√âv√©nement en cours de modification</h3> <div class="text-xs">Un autre utilisateur est en train de modifier cet √©v√©nement. Les
                contr√¥les sont temporairement d√©sactiv√©s.</div></div></div>`),qs=l('<div class="text-base-content/60 bg-base-200 rounded-box border-base-200 flex flex-col items-center justify-center border-2 border-dashed py-12"><div class="bg-base-200 mb-4 rounded-full p-4"><!></div> <p class="font-medium">Aucun repas planifi√©</p> <p class="mt-1 text-sm">Commencez par ajouter un repas √† votre √©v√©nement</p></div>'),As=l("<div><!></div>"),Os=l('<div class="space-y-4"></div>'),Ls=l('<div class="grid grid-cols-1 gap-6 pb-20 lg:grid-cols-3"><div class="space-y-6 lg:col-span-1"><!> <!></div> <div class="space-y-6 md:px-4 lg:col-span-2"><!> <div class="mb-6 flex items-center justify-between"><h3 class="card-title text-lg"> </h3> <button class="btn btn-primary"><!> Ajouter un repas</button></div> <!> <div class="flex"><button class="btn btn-outline btn-primary btn-block mt-4"><!> Ajouter un repas</button></div></div></div>'),js=l('<div class="bg-base-200 min-h-lvh space-y-6 px-2 pt-4 pb-20 md:px-20"><div class="flex flex-wrap items-center justify-between gap-x-6 gap-y-3"><div class="min-w-80 flex-1 gap-2"><!></div> <!></div> <!> <!> <!></div> <!> <!> <!>',1);function en(Ze,n){bt(n,!0);const Ue=u=>{var f=_s(),w=a(f);w.__click=Y;var F=a(w);{var se=x=>{var Ee=gs();i(x,Ee)},Le=x=>{zt(x,{size:18,class:"mr-1"})};b(F,x=>{e(T)?x(se):x(Le,!1)})}X(2),t(w),t(f),E(()=>w.disabled=e(T)||!e(je)||!e(N)),i(u,f)};let g=S(()=>n.params.id),D=V(gt([])),U=V(""),z=V(""),y=V("proposition"),K=V(1);const I=S(()=>[...e(D)].sort((u,f)=>new Date(u.date).getTime()-new Date(f.date).getTime()));let H=V(!1),T=V(!1),re=V(!1),he=V(null),ce=V(!1),xe=V(!1);const ye=S(()=>e(v)?.status==="local"?"/demo/event":"/dashboard/eventEdit");let ue=V(!1),Z=V(!1),we=V(null),Te=null;const je=S(()=>{if(!e(G)||!e(v))return!1;const u=JSON.stringify({name:e(v).name,meals:e(v).meals||[],description:e(v).description||"",status:e(v).status||"proposition",minContrib:e(v).minContrib||1}),f=JSON.stringify({name:e(U),meals:e(D),description:e(z),status:e(y),minContrib:e(K)});return u!==f});async function d(){return console.log("startEditing"),e(G)?!0:e($)?(ne.warning(`Cet √©v√©nement est verrouill√© par ${e(ke)}`),!1):await ee()}const v=S(()=>Qe.getEventById(e(g))),P=S(()=>ua(e(v))),W=S(()=>e(v)?.teamsId??[]),$=S(()=>e(we)?e(we).userId!==oe.userId:!1),G=S(()=>e(v)?.status==="local"?!0:e(we)?e(we).userId===oe.userId:!1),N=S(()=>Qe.canUserEditEvent(e(g),oe.userId||"")&&!e($)&&!e(T)),ke=S(()=>e(we)?.userName||"un autre utilisateur");et(()=>{e(v)&&e(H)&&!e(G)&&Et(()=>{s(D,Dt(e(v).meals||[]),!0),s(U,e(v).name||"",!0),s(z,e(v).description||"",!0),s(y,e(v).status||"proposition",!0),s(K,e(v).minContrib||1,!0),console.log("üîÑ Shadow draft synchronis√© depuis currentEvent (Preview)")})}),et(()=>{e(v)&&e(H)&&e(v).status==="local"&&e(U)===""&&e(v).name&&Et(()=>{s(D,Dt(e(v).meals||[]),!0),s(U,e(v).name||"",!0),s(z,e(v).description||"",!0),s(y,e(v).status||"local",!0),s(K,e(v).minContrib||1,!0),console.log("[EventEditPage] Shadow draft synchronis√© (mode local)")})}),et(()=>{Pt.setConfig({eventId:e(g),basePath:e(ye),actions:Ue,isLockedByOthers:e($),lockedByUserName:e(ke),hasUnsavedChanges:e(je)&&!e($)})}),et(()=>{!e(H)&&!e(T)&&Et(async()=>{s(T,!0);try{if(await ia(),!await oa(e(g))){console.error("[EventEditPage] Event non trouv√© apr√®s attente"),s(T,!1);return}if(Qe.getEventById(e(g))?.status==="local"){console.log("[EventEditPage] Mode local: skip lock initialization"),s(H,!0);return}s(we,await ut.getLock(e(g)),!0),Te=ut.subscribeToLock(e(g),w=>{console.log("[EventEditPage] üîí Verrou mis √† jour (Realtime):",{lockedBy:w?.userName,userId:w?.userId,expiresAt:w?.expiresAt}),s(we,w,!0)}),s(H,!0)}finally{s(T,!1)}})}),ra(()=>{A&&(clearTimeout(A),A=null),Te&&(Te(),Te=null),e(g)&&e(G)&&(console.log("üö™ D√©montage du composant, lib√©ration du lock..."),te()),Pt.reset()});async function ee(){if(e(v)?.status==="local")return console.log("[EventEditPage] Mode local: skip lock acquisition"),!0;if(!e(g)||!oe.userId||e(T)||e(re))return!1;s(re,!0);try{return await ut.acquireLock(e(g),oe.userId,oe.userName)?(_(),!0):(ne.warning(`Cet √©v√©nement est en cours de modification par ${e(ke)}`),!1)}catch(u){return console.error("‚ùå Erreur acquisition verrou:",u),ne.error("Impossible de verrouiller l'√©v√©nement"),!1}finally{s(re,!1)}}async function te(){if(e(v)?.status==="local"){console.log("[EventEditPage] Mode local: skip lock release");return}if(!(!e(g)||!oe.userId))try{await ut.releaseLock(e(g),oe.userId),console.log("üîì Verrou lib√©r√©")}catch(u){console.error("‚ùå Erreur lib√©ration verrou:",u)}}async function ge(){e(G)&&await te()}async function Ie(){const u=await ie();return u&&await te(),u}function _e(){if(!e(U).trim())return{isValid:!1,errorMessage:"Veuillez renseigner le nom de l'√©v√©nement"};if(e(D).length===0)return{isValid:!1,errorMessage:"Veuillez ajouter au moins un repas"};const f=e(D).map(w=>w.date).filter((w,F,se)=>se.indexOf(w)!==F);return f.length>0?{isValid:!1,errorMessage:`Certaines dates sont en double: ${f.map(F=>{try{return new Date(F).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return F}}).join(", ")}`}:{isValid:!0}}async function ie(){const u=_e();if(!u.isValid)return ne.error(u.errorMessage||"Erreur de validation"),!1;e(P);const f=Array.from(new Set(e(I).map(x=>x.date))).sort(),w=e(v)?.teams||[],F=e(v)?.teamsId||[],se=new Map(F.map((x,Ee)=>[x,w[Ee]]));e(W).map(x=>St.getTeamById(x)?.name||se.get(x)||x);const Le={name:e(U),description:e(z),status:e(y),minContrib:e(K),allDates:f,dateStart:f.length>0?f[0]:"",dateEnd:f.length>0?f[f.length-1]:"",meals:e(I)};try{return await Qe.updateEvent(e(g),Le),!0}catch(x){return console.error("Erreur sauvegarde:",x),ne.error("Erreur lors de la sauvegarde"),!1}}async function q(){if(!e(g)||e(T)||!e(G))return;s(T,!0);const u=ne.loading("Sauvegarde automatique...");if(await ie())await te(),ne.update(u,{state:"success",message:"Modifications sauvegard√©es automatiquement"});else{if(e(g)&&oe.userId)try{await ut.acquireLock(e(g),oe.userId,oe.userName)}catch(w){console.error("Erreur heartbeat lock:",w)}ne.update(u,{state:"warning",message:"Impossible de sauvegarder : modifications invalides"})}s(T,!1),setTimeout(()=>ne.dismiss(u),3e3)}async function Y(){s(T,!0),await ie()&&(await te(),ne.success("√âv√©nement mis √† jour")),s(T,!1)}let A=null;function _(){A&&clearTimeout(A),A=setTimeout(()=>{q()},120*1e3),console.log("‚è∞ Auto-save programm√© dans 30 secondes")}et(()=>{const u=e(G),f=e(je),w=F=>{(u||f)&&(F.preventDefault(),F.returnValue="Vous avez des modifications non sauvegard√©es. Voulez-vous vraiment quitter ?")};return window.addEventListener("beforeunload",w),()=>{window.removeEventListener("beforeunload",w)}});async function m(u){await d()&&s(U,u.target.value,!0)}async function p(){if(!await d())return;const u=wt(6);let f;if(e(I).length===0){const F=new Date;F.setDate(F.getDate()+7),F.setHours(20,0,0,0),f=F.toISOString()}else{const F=e(I)[e(I).length-1],se=new Date(F.date);se.getHours()<14?se.setHours(20,0,0,0):(se.setDate(se.getDate()+1),se.setHours(12,0,0,0)),f=se.toISOString()}const w={id:u,date:f,guests:100,recipes:[]};s(D,[...e(D),w],!0),s(he,u,!0)}function O(u){s(D,e(D).filter(f=>f.id!==u),!0)}function R(u){s(he,e(he)===u?null:u,!0)}async function L(u){if(!(!e(g)||!oe.userId))try{s(T,!0);const f=u?"accepted":"declined";await Qe.updateContributorStatus(e(g),oe.userId,f),ne.success(u?"Invitation accept√©e":"Invitation d√©clin√©e")}catch(f){console.error("Erreur r√©ponse invitation:",f),ne.error("Erreur lors de la r√©ponse")}finally{s(T,!1)}}async function Q(){await d()&&(s(y,"confirmed"),s(ue,!1))}async function fe(){await d()&&(s(y,"canceled"),s(Z,!1))}var Me=js(),Ce=de(Me),C=a(Ce),o=a(C),c=a(o);{var h=u=>{var f=bs();We(f),f.__input=m,E(()=>{At(f,e(U)),f.disabled=!e(N)}),lt("focus",f,d),lt("blur",f,()=>s(ce,!1)),i(u,f)},j=u=>{var f=ps();f.__click=()=>s(ce,!e(ce));var w=a(f),F=a(w),se=a(F,!0);t(F);var Le=r(F,2);ht(Le,{class:"h-4 w-4"}),t(w),t(f),E(()=>{f.disabled=!e(N),J(se,e(U)||"Nom de l'√©v√©nement")}),i(u,f)};b(c,u=>{e(ce)?u(h):u(j,!1)})}t(o);var M=r(o,2);{var B=u=>{fa(u,{get currentEvent(){return e(v)}})};b(M,u=>{e(v)&&u(B)})}t(C);var ae=r(C,2);{var Ae=u=>{var f=Ps(),w=a(f),F=a(w);ft(F,{legend:"Description",children:(x,Ee)=>{var Be=Xe(),tt=de(Be);{var vt=Fe=>{var Re=hs(),Pe=de(Re);Ot(Pe);var Ke=r(Pe,2),me=a(Ke);t(Ke),E(()=>{Pe.disabled=!e(N),J(me,`${e(z).length??""}/3000 caract√®res`)}),lt("focus",Pe,d),lt("blur",Pe,()=>s(xe,!1)),nt(Pe,()=>e(z),pe=>s(z,pe)),i(Fe,Re)},it=Fe=>{var Re=ws();Re.__click=()=>s(xe,!0);var Pe=a(Re),Ke=a(Pe),me=a(Ke);{var pe=qe=>{var ve=xs(),k=a(ve,!0);t(ve),E(()=>J(k,e(z))),i(qe,ve)},$e=qe=>{var ve=ys();i(qe,ve)};b(me,qe=>{e(z)?qe(pe):qe($e,!1)})}t(Ke);var at=r(Ke,2);ht(at,{class:"h-4 w-4 shrink-0"}),t(Pe),t(Re),E(()=>Re.disabled=!e(N)),i(Fe,Re)};b(tt,Fe=>{e(xe)?Fe(vt):Fe(it,!1)})}i(x,Be)},$$slots:{default:!0}}),t(w);var se=r(w,2),Le=a(se);ft(Le,{legend:"Statut de l'√©v√©nement",children:(x,Ee)=>{var Be=Ds(),tt=a(Be),vt=a(tt);{var it=me=>{var pe=ks(),$e=a(pe);Zt($e,{class:"h-3 w-3"}),X(),t(pe),i(me,pe)},Fe=me=>{var pe=Xe(),$e=de(pe);{var at=ve=>{var k=Es(),le=a(k);yt(le,{class:"h-3 w-3"}),X(),t(k),i(ve,k)},qe=ve=>{var k=Ts(),le=a(k);$t(le,{class:"h-3 w-3"});var Ve=r(le);t(k),E(()=>J(Ve,` ${e(y)??""}`)),i(ve,k)};b($e,ve=>{e(y)==="proposition"?ve(at):ve(qe,!1)},!0)}i(me,pe)};b(vt,me=>{e(y)==="confirmed"?me(it):me(Fe,!1)})}t(tt);var Re=r(tt,2);{var Pe=me=>{var pe=Is();pe.__click=()=>s(ue,!0),E(()=>pe.disabled=!e(N)),i(me,pe)},Ke=me=>{var pe=Xe(),$e=de(pe);{var at=ve=>{var k=Cs();k.__click=()=>s(Z,!0),E(()=>k.disabled=!e(N)),i(ve,k)},qe=ve=>{var k=Ss();k.__click=async()=>{await d()&&s(y,"proposition")},E(()=>k.disabled=!e(N)),i(ve,k)};b($e,ve=>{e(y)==="confirmed"?ve(at):ve(qe,!1)},!0)}i(me,pe)};b(Re,me=>{e(y)==="proposition"?me(Pe):me(Ke,!1)})}t(Be),i(x,Be)},$$slots:{default:!0}}),t(se),t(f),i(u,f)};b(ae,u=>{e(H)&&u(Ae)})}var Oe=r(ae,2);ca(Oe,{get currentEvent(){return e(v)},get isBusy(){return e(T)},onRespond:L});var Se=r(Oe,2);{var ze=u=>{var f=Ms();i(u,f)},be=u=>{var f=Ls(),w=a(f),F=a(w);{var se=k=>{ft(k,{legend:"Participants",get iconComponent(){return rt},children:(le,Ve)=>{var He=zs(),ot=a(He);ea(ot,{class:"h-5 w-5"}),X(2),t(He),i(le,He)},$$slots:{default:!0}})},Le=k=>{{let le=S(()=>oe.userId||"");Ba(k,{get canEdit(){return e(N)},get contributors(){return e(P)},get nativeTeamsStore(){return St},get eventsStore(){return Qe},get userId(){return e(le)},get eventId(){return e(g)},onStartEdit:d,get minContrib(){return e(K)},set minContrib(Ve){s(K,Ve,!0)}})}};b(F,k=>{e(v)?.status==="local"?k(se):k(Le,!1)})}var x=r(F,2);{var Ee=k=>{{let le=S(()=>!e(N)||e($));ms(k,{get event(){return e(v)},get contributors(){return e(P)},get disabled(){return e(le)}})}};b(x,k=>{e(v)&&k(Ee)})}t(w);var Be=r(w,2),tt=a(Be);{var vt=k=>{var le=Ns(),Ve=a(le);ta(Ve,{class:"h-6 w-6 shrink-0"}),X(2),t(le),i(k,le)};b(tt,k=>{e($)&&k(vt)})}var it=r(tt,2),Fe=a(it),Re=a(Fe);t(Fe);var Pe=r(Fe,2);Pe.__click=p;var Ke=a(Pe);mt(Ke,{class:"mr-1 h-4 w-4"}),X(),t(Pe),t(it);var me=r(it,2);{var pe=k=>{var le=qs(),Ve=a(le),He=a(Ve);Tt(He,{class:"h-8 w-8 opacity-50"}),t(Ve),X(4),t(le),i(k,le)},$e=k=>{var le=Os();Ge(le,29,()=>e(I),Ve=>Ve.id+"-"+e(v)?.$updatedAt,(Ve,He)=>{var ot=As(),Ut=a(ot);{let Ft=S(()=>e(he)===e(He).id),Rt=S(()=>e(D).map(ct=>ct.date)),Ht=S(()=>!e(N)||e($));da(Ut,{get isEditing(){return e(Ft)},onEditToggle:async()=>{await d()&&R(e(He).id||"")},onDelete:()=>O(e(He).id||""),get allDates(){return e(Rt)},get disabled(){return e(Ht)},get meal(){return e(D)[e(D).findIndex(ct=>ct.id===e(He).id)]},set meal(ct){e(D)[e(D).findIndex(Wt=>Wt.id===e(He).id)]=ct}})}t(ot),la(ot,()=>va,()=>({delay:100,duration:400})),i(Ve,ot)}),t(le),i(k,le)};b(me,k=>{e(I).length===0?k(pe):k($e,!1)})}var at=r(me,2),qe=a(at);qe.__click=p;var ve=a(qe);mt(ve,{class:"mr-1 h-4 w-4"}),X(),t(qe),t(at),t(Be),t(f),E(()=>{J(Re,`Repas & Menus (${e(I).length??""})`),Pe.disabled=!e(N),qe.disabled=!e(N)}),i(u,f)};b(Se,u=>{e(T)&&!e(H)?u(ze):u(be,!1)})}t(Ce);var De=r(Ce,2);Mt(De,{get isOpen(){return e(ue)},title:"Confirmer l'√©v√©nement",message:"√ätes-vous s√ªr de vouloir confirmer cet √©v√©nement ? ",variant:"info",confirmLabel:"Confirmer",cancelLabel:"Annuler",onConfirm:Q,onCancel:()=>s(ue,!1)});var Ne=r(De,2);Mt(Ne,{get isOpen(){return e(Z)},title:"Annuler la confirmation",message:"√ätes-vous s√ªr de vouloir annuler cet √©v√©nement ?.",variant:"warning",confirmLabel:"Oui, annuler",cancelLabel:"Non, garder",onConfirm:fe,onCancel:()=>s(Z,!1)});var Je=r(Ne,2);{let u=S(()=>`/dashboard/eventEdit/${e(g)}`);ga(Je,{get routeKey(){return e(u)},shouldProtect:()=>e(je),onLeaveWithoutSave:ge,onSaveAndLeave:Ie,message:"Vous avez des modifications non sauvegard√©es. Voulez-vous vraiment quitter ?"})}i(Ze,Me),pt()}_t(["click","input"]);export{en as default};
